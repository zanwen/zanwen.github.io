<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="定时器的本质就是数数（基于STM32F103深入理解定时器）, 安文的博客">
    <meta name="description" content="参考手册

STM32F103参考手册：rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx
STM32103ZE数据手册：STM32F103xC, S">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>定时器的本质就是数数（基于STM32F103深入理解定时器） | 安文的博客</title>
    <link rel="icon" type="image/png" href="/medias/logo.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="安文的博客" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">安文的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">安文的博客</div>
        <div class="logo-desc">
            
            安文的博客 | 嵌入式 | 算法 | AI | 人工智能
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/pexels-248509299-12441849.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">定时器的本质就是数数（基于STM32F103深入理解定时器）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/TIMER/">
                                <span class="chip bg-color">TIMER</span>
                            </a>
                        
                            <a href="/tags/%E5%AE%9A%E6%97%B6%E5%99%A8/">
                                <span class="chip bg-color">定时器</span>
                            </a>
                        
                            <a href="/tags/TIM/">
                                <span class="chip bg-color">TIM</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/STM32/" class="post-category">
                                STM32
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-12-04
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-12-06
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    33 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="can-kao-shou-ce">参考手册</h1>
<ul>
<li>STM32F103参考手册：<a target="_blank" rel="noopener" href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></li>
<li>STM32103ZE数据手册：<a target="_blank" rel="noopener" href="https://www.st.com/resource/en/datasheet/stm32f103rc.pdf">STM32F103xC, STM32F103xD, STM32F103xE </a></li>
<li>STM32F103 Cortext-M3 编程手册<a target="_blank" rel="noopener" href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xxx/20xxx/21xxx/L1xxxx Cortex®-M3 programming manual</a></li>
</ul>
<h1 id="xi-tong-di-ta-ding-shi-qi-sys-tick-timer">系统嘀嗒定时器SysTick Timer</h1>
<p>该定时器和嵌套向量中断控制器NVIC一样，是Cortext-M3内核中内置的外设，在<a target="_blank" rel="noopener" href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xxx/20xxx/21xxx/L1xxxx Cortex®-M3 programming manual</a>的如下章节中可以查阅相关的说明。</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205082312825.png" alt="image-20241205082312825" style="zoom:33%;">
<blockquote>
<p>The processor has a 24-bit system timer, SysTick, that counts down from the reload value to zero, reloads (wraps to) the value in the LOAD register on the next clock edge, then counts down on subsequent clocks.</p>
<p>When the processor is halted for debugging the counter does not decrement.</p>
</blockquote>
<p>Cortex-M3处理器有一个24bit的系统级定时器SysTick，该定时器会从装载值向下计数到零，然后在下个时钟周期装载LOAD寄存器中指定的重新装载值，并在随后的时钟继续向下计数。</p>
<p>需要注意的时，当处理器因调试而中断执行时，该计数器不会递减。</p>
<h2 id="zhong-zhuang-zai-zhi-ji-cun-qi-load">重装载值寄存器LOAD</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205083512747.png" alt="image-20241205083512747"></p>
<p>LOAD寄存器用于指定定时器计数的重装载值RELOAD，当定时器被启用或递减到零时，LOAD寄存器指定的值会被加载到VAL寄存器中（该寄存器为定时器当前的计数值）。</p>
<p>RELOAD值需要根据使用场景来计算：</p>
<ul>
<li>如果想要<mark>每N个处理器时钟周期</mark>就产生触发事件，需要将RELOAD设置为N-1。例如每100个时钟脉冲需要触发一次SysTick中断，需要将RELOAD设置为99。（当RELOAD设置为99后，开启定时器，在第一个时钟脉冲RELOAD会被加载到VAL寄存器中，并在随后的每个时钟脉冲将99递减1，因此在开启定时器后的第100个时钟脉冲，VAL会变成0，并产生中断事件）。</li>
<li>如果需要在<mark>N个处理器时钟周期的延时后</mark>触发一个单次的SysTick中断，需要将RELOAD设置为N。例如如果需要在400个时钟脉冲之后触发一次SysTick中断，需要将RELOAD设置为400。（开启定时器后，在第一个脉冲将RELOAD装载到VAL，在第401个脉冲VAL递减为0，并产生中断事件）</li>
</ul>
<p>前者常用于周期性地产生中断（每N个时钟周期的最后一个周期触发次），而后者常用于单次不定长度的延时（等到K个时钟周期完整结束，第K+1个脉冲开始时触发一次事件）。</p>
<h2 id="dang-qian-ji-shu-zhi-ji-cun-qi-val">当前计数值寄存器VAL</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205091342807.png" alt="image-20241205091342807"></p>
<p>该寄存器存储的是SysTick计数器当前的计数值。读操作会返回当前计数值，任何写操作会将当前计数值清零，并清除CTRL寄存器中的COUNTFALG位。</p>
<p>该寄存器是SysTick内部的一个状态寄存器，我们通常不会直接操作该寄存器。</p>
<h2 id="sys-tick-kong-zhi-he-zhuang-tai-ji-cun-qi-ctrl">SysTick控制和状态寄存器CTRL</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205083016981.png" alt="image-20241205083016981"></p>
<h3 id="ding-shi-qi-shi-neng-enable">定时器使能ENABLE</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205083115544.png" alt="image-20241205083115544"></p>
<p>将ENABLE置位后，定时器会将LOAD寄存器中RELOAD值加载到VAL寄存器中，然后开始向下计数。到达0后，会将COUNTFLAG置位，并根据TICKINT是否被置位来判断是否需要产生SysTick中断。然后继续重新装载RELOAD值并开始计数。</p>
<blockquote>
<p>[!NOTE]</p>
<p>注意：如本章节开头所提到的，并不是将ENABLE置位后，定时器并不会马上加载RELOAD，而是要等一个时钟脉冲。同样的，当递减到0时，会置位COUNTFLAG并根据TICKINT产生中断，并在下个脉冲重新装载RELOAD值。</p>
</blockquote>
<h3 id="sys-tick-yi-chang-qing-qiu-shi-neng-tickint">SysTick异常请求使能TICKINT</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094011349.png" alt="image-20241205094011349"></p>
<p>将TICKINT置位后，当计数器递减到0时会发出SysTick异常请求，该请求会被递交NVIC，随后处理器会通过异常向量表找到相应的异常处理程序来执行。</p>
<blockquote>
<p>[!NOTE]</p>
<p>软件可以通过轮询COUNTFLAG来判断SysTick是否计数到了0.</p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094354149.png" alt="image-20241205094354149" style="zoom:50%;">
<blockquote>
<p>[!NOTE]</p>
<p>关于ARM核异常处理机制，可参考本站文章《ARM核学习（五）异常处理》</p>
</blockquote>
<h3 id="sys-tick-shi-zhong-yuan-xuan-ze-clksource">SysTick时钟源选择CLKSOURCE</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094708579.png" alt="image-20241205094708579" style="zoom: 50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094832430.png" alt="参考手册-时钟树"></p>
<p>这里我们可以配置为处理器时钟AHB，或其8分频。</p>
<h3 id="ji-shu-biao-zhi-wei-countflag">计数标志位COUNTFLAG</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094958147.png" alt="image-20241205094958147"></p>
<p>当定时器计数到0时，该标志位会被置位。这里还有个细节，读取到COUNTFLAG为1后会清除该位。</p>
<h2 id="an-li-sys-tick-shi-xian-led-mei-miao-fan-zhuan-yi-ci">案例-SysTick实现LED每秒翻转一次</h2>
<h3 id="systick-h">systick.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SYSTICK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SYSTICK_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SYSTICK_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="systick-c">systick.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>

<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_CLKSOURCE <span class="token operator">|</span> SysTick_CTRL_TICKINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>

<span class="token class-name">uint16_t</span> tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick_ms<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tick_ms <span class="token operator">&gt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LED_Toggle</span><span class="token punctuation">(</span>LED1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="nvic-zhong-duan-pei-zhi">NVIC中断配置</h2>
<p>由于SysTick为CM3内置的外设，NVIC默认注册了SysTick。</p>
<h3 id="zhong-duan-shi-neng-amp-mo-ren-you-xian-ji">中断使能&amp;默认优先级</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205105610255.png" alt="image-20241205105610255"></p>
<p>如上图，可以看出SysTick中断使能默认是置位的，并且优先级为0。</p>
<h3 id="zi-ding-yi-sys-tick-you-xian-ji">自定义SysTick优先级</h3>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">void SysTick_Init(void) {
    SysTick-&gt;LOAD = SystemCoreClock / 1000 - 1;
    SysTick-&gt;CTRL |= (SysTick_CTRL_CLKSOURCE | SysTick_CTRL_TICKINT);

    NVIC_SetPriorityGrouping(3); // 4个bit都为抢占优先级
    NVIC_SetPriority(SysTick_IRQn, 10); // 将SysTick中断优先级设置为10
    // NVIC_EnableIRQ(SysTick_IRQn); // SysTick属于内核异常，不需要手动开启

    SysTick-&gt;CTRL |= SysTick_CTRL_ENABLE;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205110044145.png" alt="image-20241205110044145"></p>
<h2 id="hal-ku-shi-xian">HAL库实现</h2>
<h3 id="cube-pei-zhi">Cube配置</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205110622283.png" alt="image-20241205110622283"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205110642343.png" alt="image-20241205110642343"></p>
<h3 id="main-c-1">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE END WHILE */</span>
  <span class="token function">HAL_GPIO_TogglePin</span><span class="token punctuation">(</span>LED1_GPIO_Port<span class="token punctuation">,</span> LED1_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-ku-yan-shi-han-shu-fen-xi">HAL库延时函数分析</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>HAL_Init</code>做了SysTick的初始化：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set Interrupt Group Priority */</span>
<span class="token function">HAL_NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span>NVIC_PRIORITYGROUP_4<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Use systick as time base source and configure 1ms tick (default clock after Reset is HSI) */</span>
<span class="token function">HAL_InitTick</span><span class="token punctuation">(</span>TICK_INT_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如上，将优先级分组设置为 <code>#define NVIC_PRIORITYGROUP_4     0x00000003U</code>，即优先级配置用的4个bit全部用于抢占优先级，不设置响应优先级（Subpriority）</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NVIC_PRIORITYGROUP_4</span>         <span class="token expression"><span class="token number">0x00000003U</span> </span><span class="token comment">/*!&lt; 4 bits for pre-emption priority
                                                      0 bits for subpriority */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后通过 <code>HAL_InitTick</code>初始化SysTick：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__weak HAL_StatusTypeDef <span class="token function">HAL_InitTick</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> TickPriority<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* Configure the SysTick to have interrupt in 1ms time basis*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_SYSTICK_Config</span><span class="token punctuation">(</span>SystemCoreClock <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000U</span> <span class="token operator">/</span> uwTickFreq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0U</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> HAL_ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Configure the SysTick IRQ priority */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TickPriority <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> __NVIC_PRIO_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> TickPriority<span class="token punctuation">,</span> <span class="token number">0U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uwTickPrio <span class="token operator">=</span> TickPriority<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> HAL_ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Return function status */</span>
  <span class="token keyword">return</span> HAL_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 <code>HAL_SYSTICK_Config</code>配置了SysTick相关的寄存器（每1ms触发一次中断），然后通过 <code>HAL_NVIC_SetPriority</code>设置了SysTick中断的优先级。</p>
<p>在中断回调函数中，将计数器 <code>uwTick</code>自增：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE BEGIN SysTick_IRQn 0 */</span>

  <span class="token comment">/* USER CODE END SysTick_IRQn 0 */</span>
  <span class="token function">HAL_IncTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN SysTick_IRQn 1 */</span>
    
  <span class="token comment">/* USER CODE END SysTick_IRQn 1 */</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">HAL_IncTick</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  uwTick <span class="token operator">+=</span> uwTickFreq<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在调用 <code>HAL_Delay</code>时，首先会获取 <code>uwTick</code>的当前值 <code>tickstart</code>，通过 <code>while</code>延时直到自增的<code>uwTick</code>和 <code>tickstart</code>之间的差值达到我们传入的 <code>Delay</code>毫秒数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__weak <span class="token keyword">void</span> <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> Delay<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span> tickstart <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> wait <span class="token operator">=</span> Delay<span class="token punctuation">;</span>

  <span class="token comment">/* Add a freq to guarantee minimum wait */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>wait <span class="token operator">&lt;</span> HAL_MAX_DELAY<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    wait <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uwTickFreq<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tickstart<span class="token punctuation">)</span> <span class="token operator">&lt;</span> wait<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ji-ben-ding-shi-qi">基本定时器</h1>
<h2 id="gai-shu">概述</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103009989.png" alt="image-20241204103009989"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103508116.png" alt="image-20241204103508116"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103554574.png" alt="image-20241204103554574"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103719970.png" alt="image-20241204103719970"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204104016311.png" alt="image-20241204104016311"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204104848858.png" alt="image-20241204104848858"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204104746716.png" alt="image-20241204104746716"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204105125520.png" alt="image-20241204105125520"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204110522459.png" alt="image-20241204110522459"></p>
<h2 id="ji-cun-qi-gong-neng-fen-xi">寄存器功能分析</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205113657990.png" alt="image-20241205113657990"></p>
<p>我们不妨从RCC时钟接入定时器开始分析，以每秒触发一次定时溢出事件为例，看看我们需要配置哪些寄存器。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205114035094.png" alt="image-20241205114035094"></p>
<p>基本定时TIM6挂载在APB1低速外设总线上，其最大时钟频率为36MHz。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205114222915.png" alt="image-20241205114222915"></p>
<p>但是APB1不是直接接入TM6的。如上图，如果APB1的预分配系数如果不是为1，那么会将其2倍频后再给到后面的TIM6。因此TIM6的输入时钟实际上为72MHz。</p>
<h3 id="zi-dong-zhuang-zai-zhi-ji-cun-qi-arr-amp-yu-fen-pin-ji-cun-qi-psc">自动装载值寄存器ARR &amp; 预分频寄存器PSC</h3>
<p>为了得到周期为1s的定时器溢出率（即1Hz），我们可以将定时器的重装载值和预分频器看做输入时钟的两个分频系数，经过预分频器和定时器计数周期后，能够将72MHz输入时钟频率变为1Hz的定时器溢出率。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205133045398.png" alt="image-20241205133045398"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205133101610.png" alt="image-20241205133101610"></p>
<p>如上，由于定时器自动装载值和分频器为16bit，因此最大值为65535，为了将72MHz变为1Hz，我们可以通过预分频器（7200分频）先将72000000Hz先变为10000Hz，然后再通过10000个计数周期将其变为1Hz。</p>
<ul>
<li>PSC配置为7200-1，PSC为0时代表不分频，因此PSC配置的值对应的实际分频系数为PSC+1</li>
<li>ARR配置为10000-1，因为计数到9999时，还需要一个脉冲才能计数器的值变为0，而随后计数到9999则需要9999个脉冲，加上变为0的，一共10000个脉冲</li>
</ul>
<h3 id="dang-qian-ji-shu-zhi-ji-cun-qi-cnt">当前计数值寄存器CNT</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205115451556.png" alt="image-20241205115451556"></p>
<p>ARR中配置的值会被加载到该寄存器，该寄存器实时反映当前的计数值。通常，我们不会直接操作该寄存器。</p>
<h3 id="zhong-duan-shi-neng-ji-cun-qi-dier-amp-zhuang-tai-ji-cun-qi-sr">中断使能寄存器DIER &amp; 状态寄存器SR</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205115848928.png" alt="image-20241205115848928"></p>
<p>通过UIE我们可以开启定时器更新（计数值到达装载值）中断。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205115843854.png" alt="image-20241205115843854"></p>
<p>在处理中断后，我们需要清除UIF中断标志位，避免重复触发中断。</p>
<h3 id="shou-dong-chan-sheng-geng-xin-shi-jian-egr">手动产生更新事件EGR</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205120551269.png" alt="image-20241205120551269"></p>
<h3 id="kong-zhi-ji-cun-qi-cr-1">控制寄存器CR1</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205120745275.png" alt="image-20241205120745275"></p>
<h2 id="an-li-led-zhuang-tai-fan-zhuan">案例-LED状态翻转</h2>
<h3 id="systick">systick</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SYSTICK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SYSTICK_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SYSTICK_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>

<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_CLKSOURCE <span class="token operator">|</span> SysTick_CTRL_TICKINT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4个bit都为抢占优先级</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将SysTick中断优先级设置为10</span>
    <span class="token comment">// NVIC_EnableIRQ(SysTick_IRQn); // SysTick属于内核异常，不需要手动开启</span>

    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="tim-6">TIM6</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM6_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM6_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM6_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim6.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开启TIM6输入时钟</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM6EN<span class="token punctuation">;</span>
    <span class="token comment">// 配置中断频率</span>
    <span class="token comment">// 72MHz / 7200 / 1000 = 1Hz = 1s(interrupt frequence)</span>
    TIM6<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM6<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">10000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 开启定时器更新中断</span>
    TIM6<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_UIE<span class="token punctuation">;</span>
    <span class="token comment">// 注册到NVIC，优先级为2</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM6<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
    <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main">main</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim6.h"</span></span>

<span class="token class-name">uint16_t</span> tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick_ms<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tick_ms <span class="token operator">&gt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LED_Toggle</span><span class="token punctuation">(</span>LED1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LED_Toggle</span><span class="token punctuation">(</span>LED2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">TIM6_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="psc-he-arr-yu-zhuang-zai-zhi-wen-ti">PSC和ARR预装载值问题</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205145640935.png" alt="image-20241205145640935"></p>
<p>如上图所示，两个寄存器底下都有阴影，这表示ARR和PSC是<mark>预装载寄存器</mark>，ARR和PSC中配置的值会在每次更新事件发生时被加载底层工作的寄存器中（<mark>active register</mark>）。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205131723712.png" alt="image-20241205131723712"></p>
<p>如果ARPE配置为1，那么写入ARR值不会立即被加载到Auto-reload Register，而是要等到更新事件发生。配置为0，则写入ARR的值会立即被加载到Auto-reload Register。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205132208017.png" alt="image-20241205132208017"></p>
<blockquote>
<p>[!NOTE]</p>
<p>但是，写入PSC的值只有在每次更新事件发生时才会被加载到运转中的PSC Prescaler（active prescaler register）中。</p>
</blockquote>
<p>因此上述案例中，在TIM6启动后，Auto-reload Register中的值为9999，而PSC Prescale为0，等待9999*(1/72MHz)即大约(10000/72)us后，PSC Prescaler才会被加载为7199。</p>
<p>所以会导致LED1和LED2交替闪烁的现象，而不是我们预期的每隔1秒LED1和LED2同时翻转状态。</p>
<p>要想初始化TIM6时强制将PSC预装载值刷新到工作寄存器中，我们可以通过EGR手动产生一个更新事件：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开启TIM6输入时钟</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM6EN<span class="token punctuation">;</span>
    <span class="token comment">// 配置中断频率</span>
    <span class="token comment">// 72MHz / 7200 / 1000 = 1Hz = 1s(interrupt frequence)</span>
    TIM6<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM6<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">10000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过EGR手动产生一次更新事件，将PSC预装载值刷新到Prescaler寄存器中</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token comment">// 启用定时器</span>
    TIM6<span class="token operator">-&gt;</span>EGR <span class="token operator">|=</span> TIM_EGR_UG<span class="token punctuation">;</span> <span class="token comment">// 产生更新事件</span>
    TIM6<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span> <span class="token comment">// 清除更新事件中断标志</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token comment">// 关闭定时器</span>

    <span class="token comment">// 开启定时器更新中断</span>
    TIM6<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_UIE<span class="token punctuation">;</span>
    <span class="token comment">// 注册到NVIC，优先级为2</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-ku-shi-xian-1">HAL库实现</h2>
<h3 id="cube-pei-zhi-1">Cube配置</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144127438.png" alt="image-20241205144127438"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144135329.png" alt="image-20241205144135329"></p>
<h3 id="yuan-ma-fen-xi">源码分析</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">TIM_HandleTypeDef htim6<span class="token punctuation">;</span>

<span class="token comment">/* TIM6 init function */</span>
<span class="token keyword">void</span> <span class="token function">MX_TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TIM_MasterConfigTypeDef sMasterConfig <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Instance <span class="token operator">=</span> TIM6<span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Prescaler <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>CounterMode <span class="token operator">=</span> TIM_COUNTERMODE_UP<span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Period <span class="token operator">=</span> <span class="token number">10000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoReloadPreload <span class="token operator">=</span> TIM_AUTORELOAD_PRELOAD_ENABLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_TIM_Base_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim6<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sMasterConfig<span class="token punctuation">.</span>MasterOutputTrigger <span class="token operator">=</span> TIM_TRGO_RESET<span class="token punctuation">;</span>
    sMasterConfig<span class="token punctuation">.</span>MasterSlaveMode <span class="token operator">=</span> TIM_MASTERSLAVEMODE_DISABLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_TIMEx_MasterConfigSynchronization</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sMasterConfig<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">HAL_TIM_Base_MspInit</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>tim_baseHandle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tim_baseHandle<span class="token operator">-&gt;</span>Instance <span class="token operator">==</span> TIM6<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">__HAL_RCC_TIM6_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* TIM6 interrupt Init */</span>
        <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="tian-jia-ding-shi-qi-6-de-zhong-duan-hui-diao-han-shu">添加定时器6的中断回调函数</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144214052.png" alt="image-20241205144214052"></p>
<p>在<code>tim.c</code>中添加HAL库的定时器<strong>溢出中断</strong>回调函数。（定时器的回调函数比较多，这次我们只使用到了溢出中断回调函数）。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 定时器6产生中断。任何一个定时器产生中断都会进入到这个方法中，所以需要判断下定时器实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>htim<span class="token operator">-&gt;</span>Instance <span class="token operator">==</span> TIM6<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 翻转LEDB</span>
        <span class="token function">HAL_GPIO_TogglePin</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="yi-zhong-duan-fang-shi-kai-qi-ding-shi-qi">以中断方式开启定时器</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MX_TIM6_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动定时器6</span>
    <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="tong-yong-ding-shi-qi">通用定时器</h1>
<h2 id="gai-shu-1">概述</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144420381.png" alt="image-20241205144420381" style="zoom:50%;">
<h2 id="yong-you-ji-ben-ding-shi-qi-de-suo-you-gong-neng">拥有基本定时器的所有功能</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205145016647.png" alt="image-20241205145016647"></p>
<h2 id="san-chong-ke-xuan-de-shi-zhong-yuan">三种可选的时钟源</h2>
<h3 id="nei-bu-shi-zhong-yuan">内部时钟源</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205145125349.png" alt="image-20241205145125349"></p>
<h3 id="ding-shi-qi-shu-ru-tong-dao-zuo-wei-shi-zhong-yuan">定时器输入通道作为时钟源</h3>
<blockquote>
<p>[!NOTE]</p>
<p>TI1：Timer Input 1</p>
<p>TI1FP1：Timer Input 1 after input Filter and Polarity(edge) detector</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204121957064.png" alt="image-20241204121957064"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205153635462.png" alt="image-20241205153635462"></p>
<h4 id="strong-ying-yong-chang-jing-strong"><strong>应用场景</strong></h4>
<ol>
<li><strong>外部事件计数</strong>
<ul>
<li>定时器可以通过 <code>TIMx_CH1</code> 捕获输入信号的每一个脉冲并进行计数。</li>
<li>典型应用：
<ul>
<li>计数外部传感器的信号，如编码器脉冲、转速信号。</li>
<li>红外光电开关的触发计数。</li>
</ul>
</li>
</ul>
</li>
<li><strong>频率测量</strong>
<ul>
<li>使用 <code>TIMx_CH1</code> 捕获输入信号的频率或周期。</li>
<li>实现方式：
<ul>
<li>配置定时器为输入捕获模式，记录信号边沿之间的时间间隔。</li>
</ul>
</li>
<li>典型应用：
<ul>
<li>测量输入信号频率（例如电机速度测量）。</li>
</ul>
</li>
</ul>
</li>
<li><strong>占空比测量</strong>
<ul>
<li><code>TIMx_CH1</code> 配合其他通道，可以测量信号的占空比。</li>
<li>实现方式：
<ul>
<li>配置为输入捕获模式，记录上升沿和下降沿的时间差。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="wai-bu-hong-fa-shu-ru-duan-kou-etr-zuo-wei-shi-zhong-yuan">外部触发输入端口ETR作为时钟源</h3>
<blockquote>
<p>[!NOTE]</p>
<p>ETR：External Trigger</p>
<p>ITR：Internal Timer</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204141554812.png" alt="image-20241204141554812"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205153719730.png" alt="image-20241205153719730"></p>
<h4 id="strong-ying-yong-chang-jing-strong-1"><strong>应用场景</strong></h4>
<ol>
<li><strong>外部时钟输入</strong>
<ul>
<li>定时器使用 <code>ETR</code> 的信号作为主时钟，而非内部时钟（如 APB 时钟）。</li>
<li>实现方式：
<ul>
<li>配置定时器为 <strong>外部时钟模式 1</strong>，通过 <code>ETR</code> 引脚输入时钟信号。</li>
</ul>
</li>
<li>典型应用：
<ul>
<li>使用外部晶振或其他高精度时钟源驱动定时器。</li>
<li>测量高频输入信号的脉冲个数。</li>
</ul>
</li>
</ul>
</li>
<li><strong>触发控制</strong>
<ul>
<li><code>ETR</code> 信号可用作触发信号源，用于启动或复位定时器计数器。</li>
<li>实现方式：
<ul>
<li>配置定时器为 <strong>复位模式</strong> 或 <strong>门控模式</strong>，根据 <code>ETR</code> 信号触发定时器操作。</li>
</ul>
</li>
<li>典型应用：
<ul>
<li>用一个外部事件启动定时器计数（例如外部按钮触发计时）。</li>
<li>用外部信号复位定时器（例如定时器同步）。</li>
</ul>
</li>
</ul>
</li>
<li><strong>编码器接口与同步</strong>
<ul>
<li>在编码器模式或定时器同步中，<code>ETR</code> 可用作从定时器的触发输入。</li>
<li>实现方式：
<ul>
<li>主从模式配置，将 <code>ETR</code> 信号作为触发源。</li>
</ul>
</li>
<li>典型应用：
<ul>
<li>多定时器同步操作（如 PWM 和输入捕获协同工作）。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="san-chong-ji-shu-mo-shi">三种计数模式</h2>
<h3 id="xiang-shang-ji-shu">向上计数</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204142731898.png" alt="image-20241204142731898"></p>
<h3 id="xiang-xia-ji-shu">向下计数</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204142747437.png" alt="image-20241204142747437"></p>
<h3 id="zhong-yang-dui-qi-ji-shu">中央对齐计数</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204143158175.png" alt="image-20241204143158175"></p>
<h2 id="pwm-jie-shao">PWM介绍</h2>
<h3 id="gai-nian">概念</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204144714300.png" alt="image-20241204144714300"></p>
<h3 id="pwm-can-shu">PWM参数</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204144910528.png" alt="image-20241204144910528"></p>
<h3 id="shi-yong-chang-jing">使用场景</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145019846.png" alt="image-20241204145019846" style="zoom: 50%;">
<h2 id="shu-chu-bi-jiao-gong-neng">输出比较功能</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145214662.png" alt="image-20241204145214662" style="zoom: 33%;">
<h3 id="kuang-tu">框图</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145422526.png" alt="image-20241204145422526"></p>
<h3 id="yin-jiao-fu-yong">引脚复用</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205154814340.png" alt="image-20241205154814340"></p>
<h3 id="shu-chu-bi-jiao-yuan-li">输出比较原理</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145638909.png" alt="image-20241204145638909"></p>
<h3 id="shu-chu-bi-jiao-de-8-chong-mo-shi">输出比较的8种模式</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150232804.png" alt="image-20241204150232804"></p>
<blockquote>
<p>[!NOTE]</p>
<p>复位值为000，即默认没有启用该输出通道。</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150202816.png" alt="image-20241204150202816"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205155618824.png" alt="image-20241205155618824" style="zoom:33%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150413815.png" alt="image-20241204150413815"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150500666.png" alt="image-20241204150500666"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150639079.png" alt="image-20241204150639079"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204174825746.png" alt="image-20241204174825746"></p>
<h2 id="shi-yan-1-led-hu-xi-deng">实验1-LED呼吸灯</h2>
<h3 id="ji-shu-mo-shi-pei-zhi">计数模式配置</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160143270.png" alt="image-20241205160143270" style="zoom: 50%;">
<h3 id="bu-huo-bi-jiao-mo-shi-xuan-ze">捕获/比较模式选择</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160252799.png" alt="image-20241205160252799" style="zoom:50%;">
<h3 id="bi-jiao-shu-chu-mo-shi-she-zhi">比较输出模式设置</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160735003.png" alt="image-20241205160735003" style="zoom:50%;">
<h3 id="bi-jiao-shu-chu-mo-shi-xia-de-bi-jiao-zhi">比较输出模式下的比较值</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160836723.png" alt="image-20241205160836723" style="zoom:50%;">
<h3 id="tong-dao-shu-chu-shi-neng-amp-gong-zuo-dian-ping-ji-xing">通道输出使能 &amp; 工作电平极性</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205161010527.png" alt="image-20241205161010527" style="zoom:50%;">
<blockquote>
<p>[!NOTE]</p>
<p>CCER中的CCxP极性（负载工作时的电平极性）：默认为高电平有效（active high，即高电平时驱动负载工作），即计数值小于比较值时输出高电平。如果是低电平驱动负载，那么极性可以配置为低电平有效。</p>
</blockquote>
<h3 id="ji-cun-qi-yi-lan">寄存器一览</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205164102625.png" alt="image-20241205164102625"></p>
<h3 id="shi-li-dai-ma">示例代码</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205170719406.png" alt="image-20241205170719406"></p>
<h4 id="tim-5">tim5</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM5_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM5_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM5_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========使能GPIOA和TIM5时钟</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM5EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIO复用推挽 mode=11 cnf=10</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF1_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF1_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器基本配置</span>
    <span class="token comment">// 定时器溢出频率 100Hz 10ms</span>
    TIM5<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 计数方向为向上计数</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器通道2配置</span>
    <span class="token comment">// 默认占空比为0</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为低电平点亮LED，因此输出工作电平极性为低电平</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2P<span class="token punctuation">;</span> <span class="token comment">// active low</span>
    <span class="token comment">// 通道输入输出选择：比较输出</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC2S<span class="token punctuation">;</span>
    <span class="token comment">// 比较输出模式：PWM1 110</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_2<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_1<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC2M_0<span class="token punctuation">;</span>
    <span class="token comment">// 使能通道比较输出</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2E<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> duty_cycle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-1">main</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> duty_cycle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">int8_t</span> step <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        duty_cycle <span class="token operator">+=</span> step<span class="token punctuation">;</span>
        <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span>duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>duty_cycle <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> duty_cycle <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            step <span class="token operator">=</span> <span class="token operator">-</span>step<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="delay">delay</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SYSTICK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SYSTICK_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> delay_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SYSTICK_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_CLKSOURCE <span class="token operator">|</span> SysTick_CTRL_TICKINT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 4个bit都为抢占优先级</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将SysTick中断优先级设置为10</span>
    <span class="token comment">// NVIC_EnableIRQ(SysTick_IRQn); // SysTick属于内核异常，不需要手动开启</span>

    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> delay_ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> cur_tick <span class="token operator">=</span> tick<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tick <span class="token operator">-</span> cur_tick <span class="token operator">&lt;</span> delay_ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hal-ku-shi-xian-2">HAL库实现</h3>
<h4 id="cube-pei-zhi-2">Cube配置</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205181459371.png" alt="image-20241205181459371"></p>
<h4 id="she-zhi-zhan-kong-bi">设置占空比</h4>
<p><code>tim.h</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN Prototypes */</span>
<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dutyCycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END Prototypes */</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>tim.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dutyCycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">__HAL_TIM_SET_COMPARE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim5<span class="token punctuation">,</span> TIM_CHANNEL_2<span class="token punctuation">,</span> dutyCycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="qi-dong-ding-shi-qi-tong-dao-shu-chu-pwm">启动定时器通道输出PWM</h4>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim5<span class="token punctuation">,</span> TIM_CHANNEL_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> dutyCycle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">int8_t</span> step <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    dutyCycle <span class="token operator">+=</span> step<span class="token punctuation">;</span>
    <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span>dutyCycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dutyCycle <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> dutyCycle <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        step <span class="token operator">=</span> <span class="token operator">-</span>step<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="shu-ru-bu-huo">输入捕获</h2>
<h3 id="ying-yong">应用</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205212053355.png" alt="image-20241205212053355"></p>
<h3 id="kuang-tu-1">框图</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204175246770.png" alt="image-20241204175246770"></p>
<h3 id="yuan-li">原理</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204180530012.png" alt="image-20241204180530012"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204180946906.png" alt="image-20241204180946906"></p>
<h3 id="ce-liang-pwm-zhou-qi-yuan-li">测量PWM周期原理</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205213337600.png" alt="image-20241205213337600"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205213619896.png" alt="image-20241205213619896"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205213846934.png" alt="image-20241205213846934"></p>
<h2 id="shi-yan-2-ce-liang-pwm-zhou-qi-pin-lu">实验2-测量PWM周期/频率</h2>
<ul>
<li>PA1：通过TIM5_CH2的比较输出功能产生PWM</li>
<li>短接PA1和PB6</li>
<li>PB6：通过TIM4_CH1的输入捕获功能测量输入的PWM周期</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205214430424.png" alt="image-20241205214430424"></p>
<h3 id="shu-ru-tong-dao-lu-bo-qi-pei-zhi">输入通道滤波器配置</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205214245028.png" alt="image-20241205214245028"></p>
<h3 id="tong-dao-bi-jiao-bu-huo-shi-neng-amp-bian-yan-jian-ce-ji-xing">通道比较/捕获使能 &amp; 边沿检测极性</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215027795.png" alt="image-20241205215027795"></p>
<h3 id="shu-ru-bu-huo-zhong-duan-shi-neng">输入捕获中断使能</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215143081.png" alt="image-20241205215143081"></p>
<h3 id="shu-ru-bu-huo-tong-dao-ying-she">输入捕获通道映射</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215745688.png" alt="image-20241205215745688"></p>
<p>对应下图中的多路选择器</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215850878.png" alt="image-20241205215850878"></p>
<h3 id="shi-li-dai-ma-1">示例代码</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206090405972.png" alt="image-20241206090405972"></p>
<p>我们可以对照框图，根据信号从引脚输入到产生捕获事件，来串起其中涉及到的寄存器。</p>
<ul>
<li>TI1S：Timer Input 1 Selection，选择引脚、还是XOR作为定时器输入1</li>
<li>IC1F：Input Capture 1 的前置滤波器</li>
<li>CC1P：Capture/Compare 1 的极性选择，这里为捕获上升沿（极性配置为高电平有效）还是下降沿</li>
<li>CC1S：Capture/Compare 1 Selction，捕获/比较模式选择
<ul>
<li>比较输出模式</li>
<li>输入捕获模式：选择TI1FP1（Timer Input 1 Filter Polarity 1）作为输入捕获IC1（Input Captrue）的来源</li>
<li>输入捕获模式：选择TI2FP1（Timer Input 2 Filter Polarity 1）作为输入捕获IC1（Input Captrue）的来源</li>
</ul>
</li>
<li>IC1PSC：Input Capture 1 Prescaler，输入捕获预分频，即多少次输入捕获事件后才触发一次CC1I中断事件</li>
</ul>
<h4 id="tim-5-ch-2-chan-sheng-pwm">TIM5_CH2产生PWM</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM5_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM5_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_CH1_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_CH2_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM5_H__ */</span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========使能GPIOA和TIM5时钟</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM5EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIO复用推挽 mode=11 cnf=10</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF1_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF1_0<span class="token punctuation">;</span>

    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE0<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF0_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF0_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器基本配置</span>
    <span class="token comment">// 定时器溢出频率 100Hz 10ms</span>
    TIM5<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 计数方向为向上计数</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器通道2配置</span>
    <span class="token comment">// 默认占空比为50</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为低电平点亮LED，因此输出有效电平极性为低电平</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2P<span class="token punctuation">;</span> <span class="token comment">// active low</span>
    <span class="token comment">// 通道输入输出选择：比较输出</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC2S<span class="token punctuation">;</span>
    <span class="token comment">// 比较输出模式：PWM1 110</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_2<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_1<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC2M_0<span class="token punctuation">;</span>
    <span class="token comment">// 使能通道比较输出</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2E<span class="token punctuation">;</span>

        <span class="token comment">// ===========定时器通道1配置</span>
    <span class="token comment">// 默认占空比为0</span>
    TIM5<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为低电平点亮LED，因此输出有效电平极性为低电平</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// active low</span>
    <span class="token comment">// 通道输入输出选择：比较输出</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S<span class="token punctuation">;</span>
    <span class="token comment">// 比较输出模式：PWM1 110</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span>
    <span class="token comment">// 使能通道比较输出</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1E<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_CH2_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> duty_cycle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_CH1_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> duty_cycle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="tim-4-ch-1-ce-liang-pwm">TIM4_CH1测量PWM</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM4_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM4_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM4_H__ */</span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-c-2">main.c</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========使能GPIOA和TIM4时钟</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM4EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIO浮空输入 mode=00 cnf=01 PB6</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_MODE6<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF6_1<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF6_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器基本配置</span>
    <span class="token comment">// 定时器输入频率 1MHz</span>
    TIM4<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">65535</span><span class="token punctuation">;</span> <span class="token comment">// 尽量不要溢出</span>
    <span class="token comment">// 计数方向为向上计数</span>
    TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器通道1配置</span>
    TIM4<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR2_TI1S<span class="token punctuation">;</span> <span class="token comment">// 选择CH1引脚作为TI1的来源</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1F<span class="token punctuation">;</span> <span class="token comment">// 不需要输入滤波，被测试的PWM信号没有噪声</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// 捕获上升沿</span>
    <span class="token comment">// 选择TI1的滤波/边沿检测输出1(TI1FP1)作为捕获来源(IC1): 01</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_CC1S_0<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1PSC<span class="token punctuation">;</span> <span class="token comment">// 不需要对捕获事件分频</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1E<span class="token punctuation">;</span> <span class="token comment">// 使能捕获事件发生时将计数值记录到CCR寄存器中</span>

    <span class="token comment">//============中断配置</span>
    TIM4<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_CC1IE<span class="token punctuation">;</span> <span class="token comment">// 使能捕获事件中断</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM4_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM4_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> TIM_SR_CC1IF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_CC1IF<span class="token punctuation">;</span>
        <span class="token comment">// 计数值清零，开始对下个PWM周期计数</span>
        TIM4<span class="token operator">-&gt;</span>CNT <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CNT_CNT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过CCR中捕获的计数值来计算PWM周期</span>
    <span class="token comment">// 单次计数 1/1MHz = 1us，再除以1000 返回毫秒数</span>
    <span class="token keyword">return</span> TIM4<span class="token operator">-&gt;</span>CCR1 <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 / (CCR1 * 1000000) =&gt; Hz，将us转为s，再取倒数</span>
        <span class="token keyword">return</span> <span class="token number">1000000.0</span> <span class="token operator">/</span> TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"exti.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> cycle <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> freq <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"cycle = %.2f ms, freq = %.2f Hz"</span><span class="token punctuation">,</span> cycle<span class="token punctuation">,</span> freq<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="si-kao-shi-jian-he-zhong-duan-liu-cheng">思考事件和中断流程</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206094121276.png" alt="image-20241206094121276"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206094155768.png" alt="image-20241206094155768"></p>
<p>在上述代码中，当捕获到上升沿时，会发生U更新事件，将计数器（CNT counter）的值捕获到CC1R中（相当于拍了个快照），<mark>该操作是由硬件电路自动完成的（硬件电路捕获到上升沿的时刻立即自动完成）</mark>。而如果我们通过CC1E使能了捕获/比较事件中断，那么该<mark>事件发生后</mark>（CC1R已保存了捕获的值），就会产生一个CC1I中断，递交NVIC，随后在合适的时机执行向量表中对应的中断处理函数（通过 <code>B</code>指令，关于ARM核异常处理机制，可参考本站文章《ARM核学习（五）异常处理》）。</p>
<p>所以在上述代码中，我们可以在中断处理函数中通过CC1R读取到捕获事件发生时计数器的快照值。</p>
<h3 id="hal-ku-shi-xian-3">HAL库实现</h3>
<h4 id="debug-amp-rcc">Debug &amp; RCC</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206101625690.png" alt="image-20241206101625690"></p>
<h4 id="chuan-kou-da-yin">串口打印</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206101717828.png" alt="image-20241206101717828"></p>
<h4 id="tim-5-ch-2-shu-chu-pwm">TIM5_CH2输出PWM</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206102508269.png" alt="image-20241206102508269"></p>
<h4 id="tim-4-ch-1-shu-ru-bu-huo-amp-afio-zhong-ying-she">TIM4_CH1输入捕获 &amp; AFIO重映射</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206103208047.png" alt="image-20241206103208047"></p>
<h4 id="tim-4-zhong-duan-shi-neng">TIM4中断使能</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206105647297.png" alt="image-20241206105647297"></p>
<h4 id="printf-zhong-ding-xiang">printf重定向</h4>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206103342197.png" alt="image-20241206103342197" style="zoom: 50%;">
<p><code>usart.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="shi-li-dai-ma-2">示例代码</h4>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_TIM4_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token comment">// TIM5 CH2 输出PWM</span>
  <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim5<span class="token punctuation">,</span> TIM_CHANNEL_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TIM4 CH1 输入捕获</span>
  <span class="token function">HAL_TIM_IC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cycle = %.2f ms, freq = %.2f Hz\n"</span><span class="token punctuation">,</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END WHILE */</span>

  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>tim.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_IC_CaptureCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">__HAL_TIM_SET_COUNTER</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过CCR中捕获的计数值来计算PWM周期</span>
    <span class="token comment">// 单次计数 1/1MHz = 1us，再除以1000 返回毫秒数</span>
    <span class="token keyword">return</span> <span class="token function">__HAL_TIM_GET_COMPARE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> CCR <span class="token operator">=</span> <span class="token function">__HAL_TIM_GET_COMPARE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CCR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 / (CCR1 * 1000000) =&gt; Hz，将us转为s，再取倒数</span>
        <span class="token keyword">return</span> <span class="token number">1000000.0</span> <span class="token operator">/</span> CCR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="shi-yan-3-tong-shi-ce-liang-pwm-zhou-qi-pin-lu-zhan-kong-bi">实验3-同时测量PWM周期/频率/占空比</h2>
<h3 id="ding-shi-qi-hong-fa-xin-hao">定时器触发信号</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206110818625.png" alt="image-20241206110818625"></p>
<h3 id="hong-fa-shu-ru-xin-hao-di-yi-lei-lai-yuan-yu-qi-ta-ding-shi-qi-de-trgo">触发输入信号第一类——来源于其他定时器的TRGO</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206111247477.png" alt="image-20241206111247477"></p>
<h3 id="hong-fa-shu-ru-xin-hao-di-er-lei-wai-bu-hong-fa-yin-jiao-etr">触发输入信号第二类——外部触发引脚ETR</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206111541318.png" alt="image-20241206111541318"></p>
<blockquote>
<p>[!NOTE]</p>
<p>TIMx_CHx引脚比ETR更具有针对性，主要用于输入捕获</p>
</blockquote>
<h3 id="hong-fa-shu-ru-xin-hao-di-san-lei-ti-1-f-ed">触发输入信号第三类——TI1F_ED</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206112051092.png" alt="image-20241206112051092"></p>
<h3 id="hong-fa-shu-ru-xin-hao-di-si-lei-ti-1-fp-1-ti-2-fp-2">触发输入信号第四类——TI1FP1/TI2FP2</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206112524528.png" alt="image-20241206112524528"></p>
<h3 id="ding-shi-qi-cong-mo-shi">定时器从模式</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206113102739.png" alt="image-20241206113102739"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206113306671.png" alt="image-20241206113306671"></p>
<h3 id="pwm-shu-ru-mo-shi">PWM输入模式</h3>
<blockquote>
<p>[!NOTE]</p>
<p>参考手册：15.3.6 PWM input mode</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206113849114.png" alt="image-20241206113849114"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206114143525.png" alt="image-20241206114143525"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206132233091.png" alt="image-20241206132233091"></p>
<h3 id="shi-li-dai-ma-3">示例代码</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206130223507.png" alt="image-20241206130223507"></p>
<p>在实验2的基础上，我们对照框图看看需要调整哪些配置：</p>
<ul>
<li>从模式控制器
<ul>
<li>之前我们通过上升沿捕获事件<mark>中断</mark>来将计数器的值清零</li>
<li>现在我们可以通过将TI1FP1作为从模式控制器的触发输入信号（TRGI），并配置从模式为复位模式，这样TI1FP1信号中的上升沿会触发从模式控制器自动将计数值清零（<mark>硬件自动完成</mark>）</li>
</ul>
</li>
<li>增加输入捕获通道2，但是输入捕获来源IC2不是CH2引脚，而是TI1经过滤波和边沿检测后的TI1FP2信号，我们可以将通道2的极性（CCER-CC2P）配置为下降沿，这样IC2的下降沿就会产生捕获事件，将PWM高电平对应的计数值记录到CC2R中</li>
</ul>
<h4 id="tim-4">tim4</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM4_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM4_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMDutyCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM4_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========使能GPIOA和TIM4时钟</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM4EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIO浮空输入 mode=00 cnf=01 PB6</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_MODE6<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF6_1<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF6_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器基本配置</span>
    <span class="token comment">// 定时器输入频率 1MHz</span>
    TIM4<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">65535</span><span class="token punctuation">;</span> <span class="token comment">// 尽量不要溢出</span>
    <span class="token comment">// 计数方向为向上计数</span>
    TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器通道1配置</span>
    TIM4<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR2_TI1S<span class="token punctuation">;</span> <span class="token comment">// 选择CH1引脚作为TI1的来源</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1F<span class="token punctuation">;</span> <span class="token comment">// 不需要输入滤波，被测试的PWM信号没有噪声</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// 捕获上升沿</span>
    <span class="token comment">// 选择TI1的滤波/边沿检测输出1(TI1FP1)作为捕获来源(IC1): 01</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_CC1S_0<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1PSC<span class="token punctuation">;</span> <span class="token comment">// 不需要对捕获事件分频</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span>
        TIM_CCER_CC1E<span class="token punctuation">;</span> <span class="token comment">// 使能输入捕获（事件发生时将计数值记录到CCR寄存器中）</span>

    <span class="token comment">// ===========定时器通道2配置</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// 捕获下降沿</span>
    <span class="token comment">// 选择TI1FP2作为IC2 =&gt; 10</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_CC2S_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC2S_0<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC2PSC<span class="token punctuation">;</span> <span class="token comment">// 不需要对捕获事件分频</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span>
        TIM_CCER_CC2E<span class="token punctuation">;</span> <span class="token comment">// 使能输入捕获（事件发生时将计数值记录到CCR寄存器中）</span>

    <span class="token comment">//============不需要中断来将计数值清零了，通过从模式+上升沿触发来自动完成</span>
    <span class="token comment">// TIM4-&gt;DIER |= TIM_DIER_CC1IE; // 使能捕获事件中断</span>
    <span class="token comment">// NVIC_SetPriorityGrouping(3);</span>
    <span class="token comment">// NVIC_SetPriority(TIM4_IRQn, 3);</span>
    <span class="token comment">// NVIC_EnableIRQ(TIM4_IRQn);</span>

    <span class="token comment">// =============从模式控制器配置</span>
    <span class="token comment">// 从模式选择：复位模式 =&gt; 100</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">|=</span> TIM_SMCR_SMS_2<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SMCR_SMS_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SMCR_SMS_0<span class="token punctuation">;</span>
    <span class="token comment">// 从模式触发输入多路选择：TI1FP1 =&gt; 101</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">|=</span> TIM_SMCR_TS_2<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SMCR_TS_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">|=</span> TIM_SMCR_TS_0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> TIM_SR_CC1IF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_CC1IF<span class="token punctuation">;</span>
        <span class="token comment">// 计数值清零，开始对下个PWM周期计数</span>
        TIM4<span class="token operator">-&gt;</span>CNT <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CNT_CNT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过CCR中捕获的计数值来计算PWM周期</span>
    <span class="token comment">// 单次计数 1/1MHz = 1us，再除以1000 返回毫秒数</span>
    <span class="token keyword">return</span> TIM4<span class="token operator">-&gt;</span>CCR1 <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 / (CCR1 * 1000000) =&gt; Hz，将us转为s，再取倒数</span>
        <span class="token keyword">return</span> <span class="token number">1000000.0</span> <span class="token operator">/</span> TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMDutyCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> TIM4<span class="token operator">-&gt;</span>CCR2 <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-2">main</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"exti.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> cycle <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> freq <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> duty <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMDutyCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"cycle = %.2f ms, freq = %.2f Hz, duty = %.2f %%"</span><span class="token punctuation">,</span> cycle<span class="token punctuation">,</span> freq<span class="token punctuation">,</span> duty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hal-ku-shi-xian-4">HAL库实现</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206141354596.png" alt="image-20241206141354596"></p>
<h1 id="gao-ji-ding-shi-qi">高级定时器</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206142745316.png" alt="image-20241206142745316"></p>
<h2 id="zhong-fu-ji-shu-qi">重复计数器</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206142916268.png" alt="image-20241206142916268"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206144030225.png" alt="image-20241206144030225"></p>
<h2 id="hu-bu-shu-chu">互补输出</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206144212749.png" alt=""></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206144550525.png" alt="image-20241206144550525"></p>
<h2 id="si-qu-shi-jian">死区时间</h2>
<p>死区时间指的是在两个开关器件（如 MOSFET 或 IGBT）切换过程中，故意引入的延时，用来确保一个开关完全关闭后，另一个开关才会导通。（<mark>MOS管具有关断慢，开通快的特性</mark>）</p>
<p><strong>例如：<strong>在 H 桥或半桥电路中，两个开关器件（上桥臂和下桥臂）不能同时导通，否则会造成</strong>直通故障</strong>，即电源正极直接短路到负极。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145048925.png" alt="image-20241206145048925"></p>
<h2 id="cha-che-shu-ru-xin-hao">刹车输入信号</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145502383.png" alt="image-20241206145502383"></p>
<h2 id="shi-yan-shu-chu-you-xian-ge-zhou-qi-de-pwm-bo">实验-输出有限个周期的PWM波</h2>
<h3 id="xu-qiu">需求</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145801442.png" alt="image-20241206145801442"></p>
<h3 id="ying-jian">硬件</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145943045.png" alt="image-20241206145943045" style="zoom:33%;">
<h3 id="ji-cun-qi-fen-xi">寄存器分析</h3>
<h4 id="zhong-fu-ji-shu-qi-rep">重复计数器REP</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145721960.png" alt="image-20241206145721960"></p>
<h4 id="zhu-shu-chu-shi-neng">主输出使能</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206150128592.png" alt="image-20241206150128592"></p>
<h3 id="shi-li-dai-ma-4">示例代码</h3>
<h4 id="tim-1">tim1</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========使能GPIOA和TIM1时钟</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_TIM1EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIO复用推挽 PA8 mode=11 cnf=10</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE8<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF8_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF8_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========定时器配置</span>
    <span class="token comment">// 定时器溢出频率 71MHz / 7200 / 5000 = 2Hz 0.5s</span>
    TIM1<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7199</span><span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">4999</span><span class="token punctuation">;</span>
    <span class="token comment">// 计数方向为向上计数</span>
    TIM1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>
    <span class="token comment">// 重复计数器</span>
    TIM1<span class="token operator">-&gt;</span>RCR <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 需要生成5个PWM周期</span>

    <span class="token comment">// ===========定时器通道1输出配置</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S<span class="token punctuation">;</span> <span class="token comment">// 配置通道为比较输出模式</span>
    <span class="token comment">// 配置输出模式为PWM1 =&gt; 110</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">2500</span><span class="token punctuation">;</span> <span class="token comment">// 配置比较值</span>
    <span class="token comment">// 配置输出使能，工作电平极性: 低电平点亮LED</span>
    TIM1<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> TIM_CR2_OIS1<span class="token punctuation">;</span> <span class="token comment">// 关闭主输出使能MOE后，输出通道的空闲状态：OC1=1</span>

    <span class="token comment">// 将所有预装载的寄存器加载到对应的工作寄存器中，并清除由此导致的中断标志</span>
    TIM1<span class="token operator">-&gt;</span>EGR <span class="token operator">|=</span> TIM_EGR_UG<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
    <span class="token comment">// 或者设置URS使UG不产生更新中断</span>
    <span class="token comment">// TIM1-&gt;CR1 |= TIM_CR1_URS;</span>
    <span class="token comment">// TIM1-&gt;EGR |= TIM_EGR_UG;</span>

    TIM1<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1E<span class="token punctuation">;</span>

    <span class="token comment">// ===========高级定时器相关配置</span>
    <span class="token comment">// 重复计数器更新中断</span>
    TIM1<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_UIE<span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM1_UP_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM1_UP_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM1_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 主输出使能，通道输出使能</span>
    TIM1<span class="token operator">-&gt;</span>BDTR <span class="token operator">|=</span> TIM_BDTR_MOE<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM1_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM1<span class="token operator">-&gt;</span>BDTR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_BDTR_MOE<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM1_UP_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"TIM1_UP_IRQHandler"</span><span class="token punctuation">)</span>
    <span class="token function">TIM1_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-3">main</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token function">TIM1_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="yi-liu-wen-ti">遗留问题</h4>
<p>如下两个不同的配置顺序会导致不同的结果</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 配置输出模式为PWM1 =&gt; 110</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">2500</span><span class="token punctuation">;</span> <span class="token comment">// 配置比较值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206172619192.png" alt="image-20241206172619192"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">TIM1<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">2500</span><span class="token punctuation">;</span> <span class="token comment">// 配置比较值</span>
<span class="token comment">// 配置输出模式为PWM1 =&gt; 110</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206172708938.png" alt="image-20241206172708938"></p>
<h3 id="shi-yong-ug-qiang-zhi-shua-xin-yu-zhuang-zai-zhi">使用UG强制刷新预装载值</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 将所有预加载的寄存器加载到对应的工作寄存器中，并清除由此导致的中断标志</span>
TIM1<span class="token operator">-&gt;</span>EGR <span class="token operator">|=</span> TIM_EGR_UG<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
<span class="token comment">// 或者设置URS使UG不产生更新中断</span>
<span class="token comment">// TIM1-&gt;CR1 |= TIM_CR1_URS;</span>
<span class="token comment">// TIM1-&gt;EGR |= TIM_EGR_UG;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184702361.png" alt="image-20241206184702361"></p>
<h3 id="hal-ku-shi-xian-5">HAL库实现</h3>
<h4 id="ding-shi-qi-he-tong-dao-pei-zhi">定时器和通道配置</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184508910.png" alt="image-20241206184508910"></p>
<h4 id="tong-guo-geng-xin-shi-jian-zhong-duan-lai-ting-zhi-ding-shi-qi">通过更新事件中断来停止定时器</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184152397.png" alt="image-20241206184152397"></p>
<h4 id="tim-1-ch-1-zhong-ying-she-wei-pa-8">TIM1_CH1重映射为PA8</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184220481.png" alt="image-20241206184220481"></p>
<h4 id="dai-ma-shi-xian">代码实现</h4>
<h5 id="main-c-3">main.c</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_TIM1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token comment">// 清除定时器初始化时调用UG(Update Generation)强制刷新预装载值产生的更新中断</span>
  <span class="token function">__HAL_TIM_CLEAR_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_IT_UPDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__HAL_TIM_ENABLE_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_IT_UPDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE END WHILE */</span>

  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="tim-c">tim.c</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">HAL_TIM_PWM_Stop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">安文</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zanwen.github.io/2024/12/04/52886.html">https://zanwen.github.io/2024/12/04/52886.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">安文</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/TIMER/">
                                    <span class="chip bg-color">TIMER</span>
                                </a>
                            
                                <a href="/tags/%E5%AE%9A%E6%97%B6%E5%99%A8/">
                                    <span class="chip bg-color">定时器</span>
                                </a>
                            
                                <a href="/tags/TIM/">
                                    <span class="chip bg-color">TIM</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/12/06/62380.html">
                    <div class="card-image">
                        
                        <img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/lin-zhi-7151302.jpg" class="responsive-img" alt="专职搬运工DMA(STM32F103ZE)">
                        
                        <span class="card-title">专职搬运工DMA(STM32F103ZE)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-12-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/STM32/" class="post-category">
                                    STM32
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/DMA/">
                        <span class="chip bg-color">DMA</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/11/30/28867.html">
                    <div class="card-image">
                        
                        <img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/pexels-319596550-28098320.jpg" class="responsive-img" alt="深入理解I²C协议及底层原理（基于STM32F103ZE）">
                        
                        <span class="card-title">深入理解I²C协议及底层原理（基于STM32F103ZE）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-11-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%8D%8F%E8%AE%AE/" class="post-category">
                                    协议
                                </a>
                            
                            <a href="/categories/%E5%8D%8F%E8%AE%AE/STM32/" class="post-category">
                                    STM32
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/I2C/">
                        <span class="chip bg-color">I2C</span>
                    </a>
                    
                    <a href="/tags/I%C2%B2C/">
                        <span class="chip bg-color">I²C</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">安文</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">87.9k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zanwen" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:872852458@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=872852458" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 872852458" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
