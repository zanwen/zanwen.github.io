<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="深入理解I²C协议及底层原理（基于STM32F103ZE）, 安文的博客">
    <meta name="description" content="参考手册

I²C协议手册：UM10204  I2C-bus specification and user manual
EEPROM M24C02
STM32F103参考手册：rm0008-stm32f101xx-stm32f102xx-">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>深入理解I²C协议及底层原理（基于STM32F103ZE） | 安文的博客</title>
    <link rel="icon" type="image/png" href="/medias/logo.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="安文的博客" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">安文的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">安文的博客</div>
        <div class="logo-desc">
            
            安文的博客 | 嵌入式 | 算法 | AI | 人工智能
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/pexels-319596550-28098320.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">深入理解I²C协议及底层原理（基于STM32F103ZE）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/I%C2%B2C/">
                                <span class="chip bg-color">I²C</span>
                            </a>
                        
                            <a href="/tags/I2C/">
                                <span class="chip bg-color">I2C</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%8D%8F%E8%AE%AE/" class="post-category">
                                协议
                            </a>
                        
                            <a href="/categories/%E5%8D%8F%E8%AE%AE/STM32/" class="post-category">
                                STM32
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-11-30
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-12-04
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    14.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    60 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="can-kao-shou-ce">参考手册</h1>
<ul>
<li>I²C协议手册：<a target="_blank" rel="noopener" href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">UM10204  I2C-bus specification and user manual</a></li>
<li><a target="_blank" rel="noopener" href="https://atta.szlcsc.com/upload/public/pdf/source/20140724/1457707167301.pdf">EEPROM M24C02</a></li>
<li>STM32F103参考手册：<a target="_blank" rel="noopener" href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></li>
<li>STM32103ZE数据手册：<a target="_blank" rel="noopener" href="https://www.st.com/resource/en/datasheet/stm32f103rc.pdf">STM32F103xC, STM32F103xD, STM32F103xE </a></li>
</ul>
<h1 id="i-2-c-gai-lan">I²C概览</h1>
<h2 id="gai-nian">概念</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130151131386.png" alt="image-20241130151131386"></p>
<h2 id="wu-li-ceng-dian-lu-lian-jie">物理层电路连接</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130151722614.png" alt="image-20241130151722614"></p>
<h2 id="xie-yi-ceng">协议层</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130152248208.png" alt="image-20241130152248208"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153034269.png" alt="image-20241130153034269"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130152552172.png" alt="image-20241130152552172"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153259952.png" alt="image-20241130153259952"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153342500.png" alt="image-20241130153342500"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153713298.png" alt="image-20241130153713298"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153731435.png" alt="image-20241130153731435"></p>
<h1 id="ruan-jian-kong-zhi-shi-xian-i-2-c-ji-cun-qi-ban-ben">软件控制实现I2C（寄存器版本）</h1>
<h2 id="shi-xu-zong-lan">时序总览</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201154135590.png" alt="I2C参考手册"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201154158566.png" alt="I2C参考手册"></p>
<h2 id="gpio-chu-shi-hua">GPIO初始化</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201081651313.png" alt="image-20241201081651313"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201082200624.png" alt="image-20241201082200624"></p>
<h3 id="shi-neng-shi-zhong">使能时钟</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="pei-zhi-gong-zuo-mo-shi-wei-tong-yong-kai-lou-shu-chu">配置工作模式为通用开漏输出</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201154628032.png" alt="I2C参考手册"></p>
<blockquote>
<p>[!NOTE]</p>
<p>如原理图所示，PB10/11外接了上拉电阻</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130193839904.png" alt="STM32参考手册"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="mo-ren-shu-chu-gao-dian-ping">默认输出高电平</h3>
<blockquote>
<p>When the bus is free, both lines are HIGH.</p>
</blockquote>
<p>根据I2C协议规范，SDA和SCL应该在总线为空闲状态时保持高电平，因此我们可以将其初始化为高电平：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

SCL_HIGH<span class="token punctuation">;</span>
SDA_HIGH<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="wan-zheng-chu-shi-hua-dai-ma">完整初始化代码</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIO时钟配置</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. 配置GPIO工作模式为通用开漏输出 mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 总线空闲状态时，默认高电平</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="scl-shi-zhong-pin-lu-amp-yan-shi-han-shu">SCL时钟频率&amp;延时函数</h2>
<p>以I2C标准模式为例，需要考虑如下三个参数（<mark>下文以标准模式为例进行说明</mark>）</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201155642567.png" alt="image-20241201155642567"></p>
<h3 id="scl-shi-zhong-pin-lu">SCL时钟频率</h3>
<img src="C:\Users\86157\AppData\Roaming\Typora\typora-user-images\image-20241201155834783.png" alt="image-20241201155834783" style="zoom:50%;">
<p>f<sub>SCL</sub>限制我们控制SCL输出高低电平产生方波脉冲时，频率<mark>最大</mark>为100kHz，即一个时钟周期（高电平时间+低电平时间）<mark>最短</mark>为<code>1/100kHz = 10us</code></p>
<h3 id="gao-dian-ping-zhou-qi-amp-di-dian-ping-zhou-qi">高电平周期&amp;低电平周期</h3>
<p>t<sub>LOW</sub>和t<sub>HIGH</sub>则要求我们SCL拉高时间至少持续4.7us，拉低时间至少持续4us</p>
<h3 id="yan-shi-han-shu">延时函数</h3>
<p>如下我们可以准备一个5us的延时函数（以STM32F103主频72M为例，通过逻辑分析仪调整其延时时间比5us略长即可），作为维持SCL高电平周期、低电平周期的时序控制；并且两者相加后为10us，也符合时钟周期要大于10us的规范</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!NOTE]</p>
<p>这里使用 <code>volatile</code>关键字来禁用编译器优化（例如将 <code>i</code>的值加载到寄存器后在寄存器中自减到0再回写内存），使得每次读写 <code>i</code>都强制访问内存，避免不同优化级别下该函数的延时表现不一致。</p>
</blockquote>
<blockquote>
<p>[!NOTE]</p>
<p>如果期望更短的延时，则可以针对4.7us和4us各自实现一个更精准地延时函数。</p>
<p>但对于一般场景来说，没必要优化那一点时间效率，I2C本就是低速通信协议，标准模式下的速度瓶颈为100kHz，这是由设备的电气特性决定的，因此<mark>不用太纠结常数级别的性能优化</mark>（例如将函数延时优化到再靠近 <code>Min</code>值一点）。</p>
</blockquote>
<p>由于后续时序控制很多地方会用到延时，为了程序有更好的移植性，我们可以将其定义成宏：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">STANDARD_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="qi-shi-xin-hao-start-condition">起始信号（Start Condition）</h2>
<blockquote>
<p>A HIGH to LOW transition on the SDA line while SCL is HIGH defines a START condition</p>
</blockquote>
<p><mark>起始信号的定义：在SCL高电平时，SDA由高到低的跳变。</mark></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201164737043.png" alt="image-20241201164737043" style="zoom:50%;">
<p>这里需要关注两个时延参数，起始信号建立时间（SU，set-up）和保持时间（HD，hold）：</p>
<ul>
<li>起始信号建立时间（先要将SDA准备为高电平状态，随后才能由高拉低）：SCL为高时，将SDA准备为高电平状态，并至少保持<mark>4.7us</mark></li>
<li>起始信号保持时间（在SCL为高时，将SDA拉低后，需要将SDA低电平状态保持一端时间）：至少为<mark>4us</mark></li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201165047337.png" alt="image-20241201165047337"></p>
<p>虽然t<sub>SU;STA</sub>被描述为发送重复起始信号时所需的时序要求，但这里为了封装成统一的接口，让调用方发送起始信号时无需关心该细节，我们统一增加该延时。</p>
<h3 id="shi-xu-kong-zhi">时序控制</h3>
<ul>
<li>拉高SCL，拉高SDA，维持一个SCL高电平周期（间接满足了SDA的建立时间）</li>
<li>SDA拉低，维持一个Start保持时间4us（可以复用5us的延时函数）</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDA拉高，并维持start建立时间</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDA拉低，并维持start保持时间</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!NOTE]</p>
<p>关于重复起始信号的定义，可以考虑下EEPROM的随机读时序：</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201170301458.png" alt="image-20241201170301458"></p>
<p>为了能够从指定地址读数据，因此需要先发送一个假写（dummy write），设置EEPROM内部地址的地址寄存器（类比理解调整磁头到指定的位置、翻书到指定的页面），然后重复发送起始信号，进入读模式，读取指定地址的数据。</p>
<h2 id="fa-song-zi-jie-shu-ju">发送字节数据</h2>
<h3 id="zi-jie-ge-shi">字节格式</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201170805761.png" alt="image-20241201170805761"></p>
<p>这里有几个细节需要注意：</p>
<ul>
<li>通过SDA传输的每个字节（数据）<mark>长度必须为8个bit</mark></li>
<li>在单次传输中，可被发送的字节数没有限制</li>
<li>发送方每发送一个字节，需要等待接收方响应一个ack确认信号</li>
<li>数据传输遵循<mark>高位优先</mark>的模式</li>
<li><mark>时钟拉伸/延展</mark>：如果一个目标（接收方/发送方）因为需要执行一些其他的操作（例如处理内部中断）无法接收/传输数据的下一个字节，它可以通过拉低SCL来强制控制器（主设备）进入等待模式（<mark>主设备尝试拉高SCL后需要轮询等待SCL真的为高电平状态</mark>），直到它准备好处理下个字节的传输了。</li>
</ul>
<h3 id="sda-shi-xu-can-shu">SDA时序参数</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201172812277.png" alt="image-20241201172812277"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201173649085.png" alt="image-20241201173649085"></p>
<ul>
<li>数据建立时间（SU;DAT data set-up time）：在SCL低电平时，我们可以修改SDA为下一个要发送的比特位。该参数要求我们修改在SCL为低时，SDA跳变稳定后需要后维持一段时间（再将SCL拉高让接收方采样），至少为<mark>250ns</mark></li>
<li>数据保持时间（HD;DAT data hold time）：tHD;DAT is the data hold time that is measured from the falling edge of SCL, applies to data in transmission and the acknowledge。该参数是指SDA在SCL下降沿之后需要保持的时间，表格中的 <code>Conditions</code>列标识了个该参数用于CBUS兼容控制器，对于I2C设备不做限制。<mark>这意味着，在SCL下降沿发生后，我们可以立即操作SDA的跳变。</mark></li>
<li>数据有效（稳定）时间（VD;DAT，data valid time）：tVD;DAT = time for data signal from SCL LOW to SDA output。该参数是指<mark>从设备发送数据时</mark>，从SCL下降沿到SDA跳变并稳定之间的时间，最大值为<mark>3.45us</mark>（<mark>这意味着我们应该延时3.45us来确保从设备建立了SDA并读取数据</mark>）</li>
</ul>
<h3 id="zong-jie">总结</h3>
<ul>
<li>data hold time：我们不用关心，只需要遵循SDA在SCL高电平周期保持不变即可</li>
<li>data valid time：我们只需要在SCL下降沿后立即修改SDA为下一个待发送bit即可（满足<code>&lt;3.45us</code>）</li>
<li>data set-up time：由于我们在SCL拉低并修改SDA后，需要保持一个SCL低电平周期（如前文所述5us），SDA建立时间也间接变成了5us（满足<code>&gt;250ns</code>）</li>
</ul>
<h3 id="shi-xu-kong-zhi-1">时序控制</h3>
<p>高位优先，依次发送数据字节的比特位：</p>
<ul>
<li>每次循环所做的操作：拉低SCL（拉低后才能修改SDA），修改SDA，等待SCL低电平周期过去，拉高SCL（让接收方采样），等待SCL高电平周期过去。</li>
<li>每个循环产生一个时钟周期（SCL低电平、SCL高电平），因此该操作产生了8个时钟周期（从起始信号后开始计算）。</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="du-qu-ack-9-sub-th-sub-clock-cycle">读取ACK（9<sub>th</sub> Clock Cycle）</h2>
<h3 id="sheng-cheng-di-jiu-ge-shi-zhong-zhou-qi-bing-du-qu-sda">生成第九个时钟周期并读取SDA</h3>
<p>之前是接收方读取SDA（接收数据），现在轮到发送方读取SDA（接收响应）了，因此我们无需关心SDA的时序控制了，我们<mark>控制SCL产生第九个时钟周期</mark>即可：</p>
<ul>
<li>拉低SCL（因为要拉高SDA释放总线，操作SDA前必须拉低SCL），拉高SDA（释放总线，交出控制权），维持一个SCL低电平周期（从设备可以在此期间修改SDA）</li>
<li>拉高SCL（告知从设备主设备要采样了，让它在SCL高电平期间维持SDA），维持一个SCL高电平周期，读取SDA（低电平为ACK，高电平为NACK）</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">SCL_LOW<span class="token punctuation">;</span>
SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
I2C_DELAY<span class="token punctuation">;</span>

SCL_HIGH<span class="token punctuation">;</span>
I2C_DELAY<span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="shou-hui-sda-kong-zhi-quan">收回SDA控制权</h3>
<blockquote>
<p>[!NOTE]</p>
<p>值得注意的是，与之前发送字节时不同（SDA控制权在主设备），而这里我们读取SDA后，从设备仍然处于保持SDA的状态（因为只要SCL高电平，从设备就认为主设备采样没有结束），因此为了确保后续的操作能够正确控制SDA，主设备应该在读取ACK后拉低SCL（从设备释放SDA，SDA恢复高电平）收回SDA控制权</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ting-zhi-xin-hao">停止信号</h2>
<blockquote>
<p>A LOW to HIGH transition on the SDA line while SCL is HIGH defines a STOP condition</p>
</blockquote>
<p><mark>停止信号的定义：在SCL高电平时，SDA由低到高的跳变。</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201181729885.png" alt="image-20241201181729885"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201181710622.png" alt="image-20241201181710622" style="zoom:33%;">
<p>如图，停止信号的时序参数有两个：</p>
<ul>
<li>建立时间：需要在SCL高电平时，将SDA准备为低电平状态，并保持至少4us</li>
<li>总线释放时间：在两次连续的传输之间，前一个的停止信号和后一个的起始信号之间的间隔至少为4.7us（SCL和SDA保持为高电平的时间）</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>由于此前实现的 <code>I2C_Start</code>中已经强制加入了起始信号建立时间（SU;STA，SCL为高时将SDA拉高并保持）5us，因此这里的t<sub>BUF</sub>可以省略</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201191223209.png" alt="image-20241201191223209"></p>
<h3 id="shi-xu-kong-zhi-2">时序控制</h3>
<ul>
<li>拉低SCL（修改SDA前需拉低SCL），将SDA准备为低电平，维持一个SCL低电平周期</li>
<li>拉高SDA</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="xie-eeprom-ce-shi">写EEPROM测试</h2>
<ul>
<li>写模式发送设备地址 <code>0xA0</code></li>
<li>设置读写地址寄存器为 <code>0x00</code>（类比磁盘设置磁头）</li>
<li>向 <code>0x00</code>地址写入数据 <code>‘a’</code></li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201191555496.png" alt="image-20241201191555496"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">STANDARD_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIO时钟配置</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. 配置GPIO工作模式为通用开漏输出 mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 总线空闲状态时，默认高电平</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDA拉高，并维持start建立时间（for repeated start and bus free time）</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDA拉低，并维持start保持时间</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="jie-shou-shu-ju">接收数据</h2>
<ul>
<li>接收数据时，主设备只需控制SCL产生8个时钟周期，SDA控制权交给从设备</li>
<li>低电平周期，从设备会建立（准备）SDA（<mark>前提是主设备对SDA总线是释放状态</mark>），并在高电平周期保持稳定（主设备可以在此期间读取SDA）</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// 释放SDA总线</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-ack-nack-9-sub-th-sub-clock-cycle">发送ACK/NACK（9<sub>th</sub> Clock Cycle）</h2>
<p>在第九个时钟周期，主设备需要给从设备响应ACK/NACK，ACK表示需要从设备继续发送数据，NACK则指示从设备停止发送数据（主设备随后发送停止信号结束此次传输）：</p>
<ol>
<li>拉低SCL（因为马上要修改SDA），根据响应ACK还是NACK来拉低/拉高SDA，维持一个SCL低电平周期</li>
<li>拉高SCL（让从设备采样），维持一个SCL高电平周期（让从设备采样）</li>
<li><mark>特别注意</mark>：如果是发送ACK，还需要将SDA拉高（当然别忘了修改SDA前先拉低SCL），以释放SDA总线，否则</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="du-eeprom-ce-shi">读EEPROM测试</h2>
<ol>
<li>假写（dummy write）
<ol>
<li>写模式发送设备地址 <code>0xA0</code></li>
<li>设置读写地址寄存器为 <code>0x00</code></li>
</ol>
</li>
<li>真读
<ol>
<li>读模式发送设备地址 <code>0xA1</code></li>
<li>接收一个数据字节</li>
<li>响应NACK</li>
</ol>
</li>
</ol>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201195027305.png" alt="image-20241201195027305"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">STANDARD_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIO时钟配置</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. 配置GPIO工作模式为通用开漏输出 mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 总线空闲状态时，默认高电平</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDA拉高，并维持start建立时间（for repeated start and bus free time）</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDA拉低，并维持start保持时间</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zong-jie-1">总结🌟</h2>
<h3 id="fan-shi">范式</h3>
<blockquote>
<p>[!IMPORTANT]</p>
<p>简而言之，在I2C通信过程中，根据不同阶段状态（接收数据、发送数据），要严格遵循相应的SCL/SDA时序：</p>
<ul>
<li>发送数据时（字节比特位或ACK）：先拉低SCL，建立SDA，并维持SDA建立时间，然后拉高SCL让接收方采样。</li>
<li>接收数据时（字节比特位或ACK）：先拉低SCL，主设备释放SDA，而后从设备应该在t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>时间内建立SDA（字节比特位或ACK），然后主设备延时至少t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>后拉高SCL读取SDA</li>
</ul>
</blockquote>
<h3 id="xing-neng-ce-shi">性能测试</h3>
<p>标准模式</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202111727091.png" alt="标准模式"></p>
<p>快速模式</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202111845187.png" alt="image-20241202111845187"></p>
<h2 id="tuo-zhan-shang-sheng-xia-jiang-shi-jian">拓展：上升/下降时间</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201195756988.png" alt="image-20241201195756988" style="zoom: 33%;">
<p>该参数描述的是引脚高低电平跳变（或者说转变/过度，transition）时间，需要查看MCU数据手册中关于IO口电气特性相关的描述：</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201200403108.png" alt="STM32F103数据手册"></p>
<p>回看前文GPIO初始化：</p>
<pre class="line-numbers language-none"><code class="language-none">GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);
GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF10_1 | GPIO_CRH_CNF11_1);
GPIOB-&gt;CRH |= (GPIO_CRH_CNF10_0 | GPIO_CRH_CNF11_0);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201200530058.png" alt="image-20241201200530058"></p>
<p>我们配置的的是最大输出模式，因此满足I2C的条件</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201195656068.png" alt="image-20241201195656068"></p>
<h2 id="wan-zheng-dai-ma">完整代码</h2>
<h3 id="i-2-c-soft-h">i2c_soft.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="i-2-c-soft-c">i2c_soft.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">FAST_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIO时钟配置</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. 配置GPIO工作模式为通用开漏输出 mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 总线空闲状态时，默认高电平</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDA拉高，并维持start建立时间（for repeated start and bus free time）</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDA拉低，并维持start保持时间</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="eerom-mc-24-c-02">EEROM(MC24C02)</h1>
<h2 id="te-xing">特性</h2>
<ul>
<li>支持I2C标准模式和快速模式</li>
<li>MC24C01容量128字节，C02容量256字节</li>
<li>每16个字节组织成一个页，可以推断：
<ul>
<li>有16个页</li>
<li>一个字节可以满足寻址（0x0~0xFF，共256个地址），高四位用于页寻址，第四位用于页内字节寻址</li>
</ul>
</li>
<li>写周期
<ul>
<li>单字节写操作、页内连续写操作，最大写周期为5ms</li>
<li>写操作后（单次I2C传输后）的5ms内，不应该再开启I2C传输（芯片内部需要时间持久化数据）</li>
</ul>
</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130155340046.png" alt="image-20241130155340046"></p>
<h2 id="nei-cun-jie-gou">内存结构</h2>
<ul>
<li>WC，write control，写使能</li>
<li>E2，E1，E0：设备地址中的低3位</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201201711873.png" alt="image-20241201201711873"></p>
<h2 id="she-bei-xun-zhi">设备寻址</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130155754947.png" alt="image-20241130155754947"></p>
<h2 id="du-xie-cao-zuo">读/写操作</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201201953699.png" alt="image-20241201201953699"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201202011850.png" alt="image-20241201202011850"></p>
<h3 id="zhu-yi">注意</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202114206166.png" alt="image-20241202114206166"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202114116570.png" alt="image-20241202114116570"></p>
<blockquote>
<p>[!NOTE]</p>
<p>连续写时，页内16字节相当于一个环形结构，写到页内最后一个字节时，下次写入将从页头重新开始。</p>
<p>而连续读时，则是将整个256字节作为一个环形结构，读到0xFF时，下次读将从0x00重新开始。</p>
</blockquote>
<h2 id="mo-kuai-feng-zhuang">模块封装</h2>
<h3 id="m-24-c-02-h">m24c02.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __M24C02_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="m-24-c-02-c">m24c02.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_W</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_R</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait for write cycle</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>DEV_ADDR_R<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"b1 = %d, b2 = %d, b3 = %d"</span><span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">)</span>
    
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"56789"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"1234567890abcdefghijk"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="yi-liu-wen-ti">遗留问题</h1>
<h2 id="di-ta-ding-shi-qi-yan-shi-chao-chang-wen-ti">嘀嗒定时器延时超长问题</h2>
<blockquote>
<p>[!IMPORTANT]</p>
<p>值得注意的是，建议使用简单的循环或定时器中断来比较精准地实现延时，而不要使用复杂的延时函数，例如我最初使用如下嘀嗒定时器时，<code>SysTick-&gt;CTRL &amp; SysTick_CTRL_ENABLE</code>会导致延时有时比预期超出很多（例如预期5us，会出现偶尔延时了15us的情况），但是去掉该代码后就正常了，原因暂时还没找到</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// AHB 72M</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">*</span> us<span class="token punctuation">;</span>
    <span class="token comment">//101: clock source, tick interrupt, enable</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
    <span class="token comment">// wait for count flag</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;</span> SysTick_CTRL_COUNTFLAG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> 
           <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;</span> SysTick_CTRL_ENABLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在使用逻辑分析仪观察上述代码延时产生的时钟脉冲时，总是会出现有脉冲延时超长的情况（例如15us）</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201161816608.png" alt="image-20241201161816608" style="zoom:33%;">
<p>去掉 <code>SysTick-&gt;CTRL &amp; SysTick_CTRL_ENABLE</code>后则延时正常了：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// AHB 72M</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">*</span> us<span class="token punctuation">;</span>
    <span class="token comment">//101: clock source, tick interrupt, enable</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
    <span class="token comment">// wait for count flag</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;</span> SysTick_CTRL_COUNTFLAG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201161925160.png" alt="image-20241201161925160" style="zoom:33%;">
<p>并且前者直接导致I2C通信无法走通（只有 <code>start</code>），而后者可以：</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201162331212.png" alt="image-20241201162331212"></p>
<h1 id="ruan-i-2-c-cu-yan-shi-ban-ben-can-kao-dai-ma">软I2C粗延时版本参考代码</h1>
<blockquote>
<p>[!NOTE]</p>
<p>该版本代码在每个SCL/SDA状态变更节点都进行足够长的延时来稳定信号，并增加冗余延时来确保时序的正确性，例如每个节点都延时10us、冗余拉低SCL等。这样做的好处就是不用精细分析/把控I2C规范中各个阶段对SCL/SDA的时序限制（例如建立时间最少为xxx，维持时间至少为xxx，等等），大大简化了开发流程，但会消耗一定性能。</p>
<p>由于I2C本身就是一种低速通信协议，协议本身规范了传输速度瓶颈（例如标准模式100kHz），即使更精细一点控制延时，也只能带来常数级别的性能提升，所以如果不是有特定的需求，建议优先考虑粗延时版本的实现（开发流程简单，功能更加稳定，容易排查错误）。</p>
<p>以下是精准延时和粗延时的性能对比</p>
</blockquote>
<h2 id="biao-zhun-mo-shi-jing-zhun-yan-shi">标准模式-精准延时</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201224438177.png" alt="image-20241201224438177"></p>
<h2 id="biao-zhun-mo-shi-cu-yan-shi">标准模式-粗延时</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201224556682.png" alt="image-20241201224556682"></p>
<h2 id="i-2-c-h">i2c.h</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__I2C_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__I2C_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">// 宏定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ACK</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NACK</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token comment">// 控制SCL、SDA的输出高低电平</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token comment">// 读取操作</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span></span></span>

<span class="token comment">// 定义操作的基本延迟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// 初始化</span>
<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发出起始信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发出停止信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主机发出应答信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主机发出非应答信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主机等待从设备发来应答信号</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主机发送一个字节的数据（写入）</span>
<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主机从EEPROM接收一个字节的数据（读取）</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="i-2-c-c">i2c.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c.h"</span></span>

<span class="token comment">// 初始化</span>
<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 配置时钟</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>

    <span class="token comment">// 2. GPIO工作模式配置：通用开漏输出 CNF-01，MODE-11</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 发出起始信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL拉高，SDA拉高</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCL保持不变，SDA拉低</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 发出停止信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL拉高，SDA拉低</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCL保持不变，SDA拉高</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主机发出应答信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL拉低，SDA拉高，准备发出信号</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCL保持不变，SDA拉低，输出应答</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 3. SDA保持不变，SCL拉高，开始数据线上信号采样</span>
    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 4. SDA保持不变，SCL拉低，结束数据线上信号采样</span>
    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 5. SDA拉高，释放数据总线</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主机发出非应答信号</span>
<span class="token keyword">void</span> <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL拉低，SDA拉高，准备发出信号</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDA保持不变，SCL拉高，开始数据线上信号采样</span>
    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 3. SDA保持不变，SCL拉低，结束数据线上信号采样</span>
    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主机等待从设备发来应答信号</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL拉低，SDA拉高，释放数据总线</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCL拉高，开始数据采样</span>
    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 3. 读取SDA数据线上的电平</span>
    <span class="token class-name">uint16_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    <span class="token comment">// 4. SCL拉低，结束数据采样</span>
    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack <span class="token operator">?</span> NACK <span class="token operator">:</span> ACK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主机发送一个字节的数据（写入）</span>
<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. SCL、SDA都拉低，等待数据翻转</span>
        SCL_LOW<span class="token punctuation">;</span>
        SDA_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 2. 取字节的最高位，向SDA写入数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 3. SCL拉高，数据采样</span>
        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 4. SCL拉低，采样结束</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 5. 左移1位</span>
        byte <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>

<span class="token comment">// 主机从EEPROM接收一个字节的数据（读取）</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 定义一个变量，用来保存接收的数据</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 循环处理每一位</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. SCL拉低，等待数据翻转</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 2. SCL拉高，开始采样</span>
        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 3. 数据采样，读取SDA</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 先做左移，新存入的位永远在最低位</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>   <span class="token comment">// 先存入最低位，然后每次都左移1位</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4. SCL拉低，结束采样</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="m-24-c-02-h-1">m24c02.h</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c.h"</span></span>

<span class="token comment">// 宏定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W_ADDR</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">R_ADDR</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token comment">// 初始化</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 向EEPROM写入一个字节</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取EEPROM的一个字节</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连续写入多个字节（页写）</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连续读取多个字节</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="m-24-c-02-c-1">m24c02.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * @Author: wushengran
 * @Date: 2024-05-31 11:48:48
 * @Description:
 *
 * Copyright (c) 2024 by atguigu, All Rights Reserved.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>

<span class="token comment">// 初始化</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 向EEPROM写入一个字节</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 发出开始信号</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 发送写地址</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 等待EEPROM应答</span>
    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ack <span class="token operator">==</span> ACK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 4. 发送内部地址</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 等待应答</span>
        <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. 发送具体数据</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7. 等待应答</span>
        <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 8. 发出一个停止信号</span>
        <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 延迟等待写入周期结束</span>
    <span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 读取EEPROM的一个字节</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 发出开始信号</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 发送写地址（假写）</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 等待EEPROM应答</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 发送内部地址</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 等待应答</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. 发出开始信号</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7. 发送读地址（真读）</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>R_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 8. 等待EEPROM应答</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 9. 读取一个字节</span>
    <span class="token class-name">uint8_t</span> byte <span class="token operator">=</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 10. 发送一个非应答</span>
    <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 11. 发出一个停止信号</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 连续写入多个字节（页写）</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 发出开始信号</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 发送写地址</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 等待EEPROM应答</span>
    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ack <span class="token operator">==</span> ACK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 4. 发送内部地址</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 等待应答</span>
        <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 利用循环不停发送数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// 6. 发送具体数据</span>
            <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 7. 等待应答</span>
            <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 8. 发出一个停止信号</span>
        <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 延迟等待写入周期结束</span>
    <span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 连续读取多个字节</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 发出开始信号</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 发送写地址（假写）</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 等待EEPROM应答</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 发送内部地址</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 等待应答</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. 发出开始信号</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7. 发送读地址（真读）</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>R_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 8. 等待EEPROM应答</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 利用循环连续读取多个字节</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 9. 读取一个字节</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 10. 发送一个应答或非应答</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">I2C_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 11. 发出一个停止信号</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="main-c">main.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 1. 初始化</span>
<span class="token function">USART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 向EEPROM依次写入单个字符</span>
<span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 读取字符</span>
<span class="token class-name">uint8_t</span> byte1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> byte2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> byte3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4. 串口输出打印</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"byte1 = %c\t byte2 = %c\t byte3 = %c\n"</span><span class="token punctuation">,</span> byte1<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 5. 写入多个字符</span>
<span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 6. 读取多个字符</span>
<span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 7. 串口打印</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 8. 测试超出16个字节的写入</span>
<span class="token comment">// 清零缓冲区</span>
<span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"1234567890abcdefghijk"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="shen-ru-li-jie-stm-32-i-2-c-wai-she">深入理解STM32 I²C外设</h1>
<h2 id="i-2-c-wai-she-kuang-tu-gai-lan">I2C外设框图概览</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203131201258.png" alt="image-20241203131201258"></p>
<h3 id="sda-shu-ju-zong-xian-xiang-guan">SDA数据总线相关</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203131730495.png" alt="image-20241203131730495"></p>
<ul>
<li>Data register：数据寄存器DR，我们可以通过读/写DR来实现接收/发送数据</li>
<li>Data shift register
<ul>
<li>发送模式下，写到DR的数据，最终会通过底层硬件电路移位寄存器来逐位发送（I2C协议规定MSB，即高位优先）</li>
<li>接收模式下，从SDA接收到的逻辑高低电平会逐位进入移位寄存器保存，并最终递交给DR</li>
<li>如果DR、移位寄存器都为空，那么写DR会直接递交给移位寄存器</li>
</ul>
</li>
<li>Comparator：在从设备模式下（当前MCU作为从设备），用于将接收到的数据和自己的设备地址比较，如果匹配，那么需要向主设备回复ACK
<ul>
<li>Own address register：I2C通信中自己的设备地址</li>
<li>Dual address register：该寄存器支持配置第二个设备地址</li>
</ul>
</li>
<li>PEC：Packet Error Check，帧错误检查相关
<ul>
<li>STM32内置了数据帧校验机制来提升通信的可靠性</li>
</ul>
</li>
</ul>
<h3 id="scl-shi-zhong-zong-xian-xiang-guan">SCL时钟总线相关</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203133135507.png" alt="image-20241203133135507"></p>
<ul>
<li>
<p>CCR：时钟控制寄存器，用于配置SCL的频率以遵循I2C协议标准</p>
</li>
<li>
<p>CR1&amp;CR2：外设控制寄存器，用于控制外设发出I2C通信各个阶段对应的信号，例如起始信号、停止信号、响应ACK等</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203133634503.png" alt="image-20241203133634503"></p>
</li>
<li>
<p>SR1&amp;SR2：外设状态寄存器，外设硬件在完成某个I2C通信节点时会置位相应的标志位，软件可以通过轮询这些标志位的状态来控制通信过程。例如SB（Start Bit）置1表示起始信号已发送，ADDR置1表示发送了从设备地址并收到了从设备的ACK响应等</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203133750393.png" alt="image-20241203133750393"></p>
</li>
</ul>
<h2 id="i-2-c-wai-she-chu-shi-hua">I2C外设初始化</h2>
<p>下面我们就以当前MCU的I2C外设作为I2C主设备来实现收发数据、读写EEPROM的功能，在此过程中分析相关寄存器的作用及底层原理。</p>
<blockquote>
<p>[!NOTE]</p>
<p><a target="_blank" rel="noopener" href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></p>
<p>主设备模式通信流程参考 26.3.3 I2C master mode</p>
<p>I2C外设寄存器描述参考 26.6 I2C registers</p>
</blockquote>
<h3 id="gpio-pei-zhi">GPIO配置</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203140210631.png" alt="image-20241203140210631"></p>
<p>关于引脚的复用功能映射可以在MCU数据手册的引脚描述相关章节找到：</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203142124640.png" alt="STM32F103ZE数据手册"></p>
<p>GPIO配置为外设的复用功能</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203142343120.png" alt="参考手册 GPIO configurations for device peripherals  "></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 1. GPIO时钟配置</span>
RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_I2C2EN<span class="token punctuation">;</span>

<span class="token comment">// 2. 配置GPIO工作模式为复用开漏输出 mode=11 cnf=11</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span> GPIO_CRH_CNF11<span class="token punctuation">)</span><span class="token punctuation">;</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_CNF10<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 特别注意，如下操作无法得到预期结果，GPIO工作不正常</span>
<span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</span>
<span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</span>
<span class="token comment">// 如下则是可以的</span>
<span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 | GPIO_CRH_CNF10);</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!IMPORTANT]</p>
<p>这里需要特别注意的是：</p>
<p>如下配置（同时配置PB10/11的CNF、同时配置PB10/11的MODE会导致GPIO工作不正常，暂时还未找到原因）</p>
<p>GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</p>
<p>GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</p>
<p>但如下一次性配置是可以的</p>
<p>GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 | GPIO_CRH_CNF10);</p>
</blockquote>
<h3 id="zhu-she-bei-mo-shi-suo-xu-pei-zhi">主设备模式所需配置</h3>
<blockquote>
<p>In Master mode, the I2C interface initiates a data transfer and generates the clock signal. A serial data transfer always begins with a Start condition and ends with a Stop condition.</p>
<p>Master mode is selected as soon as the Start condition is generated on the bus with a START bit.</p>
</blockquote>
<p>在主模式下，由I2C外设发起数据传输请求并控制SCL生成时钟信号。一次连续的数据传输总是开始于一个起始信号，终止于一个停止信号。</p>
<p>一旦通过总线产生了一个起始信号，当前I2C外设就会进入主设备模式。</p>
<blockquote>
<p>The following is the required sequence in master mode.<br>
 Program the peripheral input clock in I2C_CR2 register in order to generate correct<br>
timings<br>
 Configure the clock control registers<br>
 Configure the rise time register<br>
 Program the I2C_CR1 register to enable the peripheral<br>
 Set the START bit in the I2C_CR1 register to generate a Start condition</p>
</blockquote>
<p>在使用主设备模式之前，需要先操作如下软件序列</p>
<ol>
<li>为了产生正确的时序，需要配置I2C_CR2寄存器以设置外设输入时钟</li>
<li>配置时钟控制寄存器（SCL时钟频率）</li>
<li>配置上升时间寄存器</li>
<li>设置I2C_CR1寄存器使能外设</li>
<li>设置I2C_CR1寄存器中的START位来产生起始信号</li>
</ol>
<p>下面我们查阅寄存器描述章节来分析以上这几个操作所蕴含的细节。</p>
<h4 id="wai-she-shu-ru-shi-zhong-i-2-c-cr-2">外设输入时钟（I2C_CR2）</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203150802143.png" alt="image-20241203150802143"></p>
<blockquote>
<p>The FREQ bits must be configured with the APB clock frequency value (I2C peripheral connected to APB). The FREQ field is used by the peripheral to generate data setup and hold times compliant with the I2C specifications. The minimum allowed frequency is 2 MHz, the maximum frequency is limited by the maximum APB frequency and cannot exceed 50 MHz (peripheral intrinsic maximum limit).</p>
</blockquote>
<p><code>FREQ</code>比特位用来配置I2C外设的输入时钟频率，且必须参考APB时钟频率来配置（因为I2C外设挂载在APB总线上）。在STM32F103中，I2C挂载在APB1总线上，APB1最大频率为<mark>36MHz</mark>。</p>
<p>外设依赖该时钟源来遵循I2C协议规范产生数据建立和维持时间。</p>
<p>该字段最小可以配置为2MHz，最大不能超过APB总线时钟频率的限制，也不能超过50MHz（外设本身的物理特性限制）。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203151357832.png" alt="image-20241203151357832"></p>
<p>如下，我们可以配置为APB1最大频率36MHz来发挥外设最大性能：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">I2C2<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> <span class="token number">36</span><span class="token punctuation">;</span> <span class="token comment">// 必须小于等于APB1的最大时钟36MHz</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="scl-shi-zhong-pin-lu-ccr">SCL时钟频率(CCR)</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203152828329.png" alt="image-20241203152828329"></p>
<blockquote>
<p>[!NOTE]</p>
<p>f<sub>PCLK1</sub> must be at least 2 MHz to achieve Sm mode I²C frequencies. It must be at least 4 MHz to achieve Fm mode I²C frequencies. It must be a multiple of 10MHz to reach the 400 kHz maximum I²C Fm mode clock. The CCR register must be configured only when the I2C is disabled (PE = 0)</p>
</blockquote>
<p>这里再次提到了I2C对外设输入时钟（I2C_CR2中的FREQ）的要求：</p>
<ul>
<li>I2C标准模式：外设时钟至少为2MHz</li>
<li>I2C快速模式：外设时钟至少为4MHz</li>
<li>达到I2C快速模式最大速率400MHz：外设时钟必须为10MHz的倍数</li>
</ul>
<p>需要注意的是，CCR寄存器必须在PE=0（使能外设之前）时进行配置。</p>
<p>下面<mark>标准模式</mark>为例，配置SCL总线时钟频率：</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203153643894.png" alt="image-20241203153643894"></p>
<p>标准模式下，I2C外设的SCL高电平和低电平周期均为 CCR * T<sub>PCLK1</sub>（外设时钟周期），要想计算CCR，我们需要知道高电平周期t<sub>high</sub>和低电平周期t<sub>low</sub>，<code>Note</code>中提到需要查看数据手册中t<sub>r(SCL)</sub>和t<sub>w(SCLH)</sub>等参数的定义</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203154217552.png" alt="image-20241203154217552" style="zoom: 50%;">
<p>可以发现数据手册对于SCL高电平周期、低电平周期、SDA/SCL上升时间和下降时间等参数的范围限制和I2C协议手册是一致的。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203154644942.png" alt="image-20241203154644942">那么如果想实现标准模式下100kHz的最大频率，我们可以计算出对应的周期为10us。如果观察t<sub>w(SCLL)</sub>+t<sub>f(SCL)</sub>即SCL低电平最小宽度4.7us和下降时间最大值0.3us（300ns)，发现两者之和正好为5us，同样的SCL高电平最小宽度4us与上升时间最大宽度1us（1000ns)之和也正好为5us。这也解释了为什么标准模式下将T<sub>high</sub>和T<sub>low</sub>都设置为CCR * T<sub>PCLK1</sub>，<mark>相当于50%占空比</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203155632578.png" alt="image-20241203155632578"></p>
<p>既然知道了目标频率100kHz（对应周期10us），以及目标高低电平周期为5us，那么可以推出CCR为 5us / T<sub>PCLK1</sub>，即 5us / (1 / 36MHz)，即CCR = 180。</p>
<p>至此我们可以配置外设的速度模式和SCL的时钟频率了：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 5. 配置外设模式：标准模式（100kb/s）、SCL时钟频率（100kHz）</span>
I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CCR_FS<span class="token punctuation">;</span>
I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> <span class="token number">180</span><span class="token punctuation">;</span> <span class="token comment">// 5us/T(PCLK)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="scl-sda-zui-da-shang-sheng-shi-jian-trise">SCL/SDA最大上升时间（TRISE）</h4>
<blockquote>
<p>[!NOTE]</p>
<p>上升时间是指释放总线后，总线电压上升到逻辑高电平所需的时间</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203170939359.png" alt="image-20241203170939359"></p>
<p>寄存器描述：</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203160222421.png" alt="image-20241203160222421"></p>
<p>为什么要配置一个SCL最大上升时间TRISE呢？从上一节的分析中我们知道T<sub>high</sub>是包括上升时间和逻辑高电平时间的。从软件操作SCL拉高之后到物理层面SCL真正变为逻辑高电平是由一定的延时的，该延时由电路上拉电阻以及电容的电气特性决定。外设为了确保能够根据CCR的配置产生T<sub>high</sub>长度的高电平，会在拉高SCL后通过反馈回路（例如IDR寄存器）检测SCL的电压状态，当其达到逻辑高电平时，外设内部的高电平计数器就会开始计数（逻辑高电平每持续一个PCLK，就自增），直到计数值为我们配置的CCR，这样就实现了我们预期的5us高电平周期。</p>
<p>但是这样就有一个问题，根据I2C规范，真正的逻辑高电平持续4us就够了，上升时间可以最大容许1us（1000ns）；对于频率100kHz，周期为10us，占空比为5us的标准模式最大速率，<mark>I2C将5us高电平时间划分为了上升时间1us和逻辑高电平时间4us。</mark></p>
<p>而如果按照上述高电平计数器的工作机制，如果上升时间为0.5us，再加上计数器对应的逻辑高电平时间5us，</p>
<p>整体高电平周期就变成了0.5+5=5.5us，导致拉长了SCL的时钟周期（预期高电平周期只持续5us），<mark>降低了SCL的预期频率</mark>，从而降低了传输速率。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203161544044.png" alt="image-20241203161544044"></p>
<p>因此，TRISE其实是让我们告诉I2C外设的高电平周期计数器，不用从逻辑高电平才开始计数，从开始拉高SCL那一刻就可以开始计数（即使电压还没有到达逻辑高电平），并当计数值等于TRISE时（例如36，36 * T<sub>PCLK</sub> = 1us，<mark>该值用于提醒计数器到了最大上升的临界值，剩下的计数必须等到SCL逻辑高电平才能继续</mark>），才通过反馈回路检测SCL电压状态，如果SCL为逻辑高电平则继续计数直到CCR（这样确保了逻辑高电平<code>&gt;= 4us</code>），如果SCL没有达到逻辑高电平（例如上拉电阻、电容、滤波导致的时延，从设备拉低SCL导致的时钟拉伸等），那么计数器就会暂停计数，直到检测到SCL达到逻辑高电平才继续剩余的CCR-TRISE计数周期。</p>
<blockquote>
<p>[!NOTE]</p>
<p>简而言之，将TRISE配置为I2C规范的最大上升时间对应的计数值（最大上升时间 / 外设工作频率）之后，无论在该时间内的哪个时刻电压达到逻辑高电平，SCL高电平周期都为CCR对应的5us。而如果不配置TRISE，就会存在这种情况：0.8us后电压达到逻辑高电平，计数器开始计数CCR个周期（5us），SCL高电平为5.8us，SCL周期为10.8us，这样就降低了SCL的频率（预期为10us）</p>
</blockquote>
<p>现在我们来计算下TRISE的配置值</p>
<ul>
<li>36MHz外设频率，周期为1/36us</li>
<li>I2C规范标准模式下上升时间最大为1000ns，即1us</li>
<li>因此TRISE = 上升时间1us / 外设时钟周期 + 1 = <code>1 / (1 / 36) + 1 = 37</code></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_TRISE_TRISE<span class="token punctuation">;</span>
I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">|=</span> <span class="token number">37</span><span class="token punctuation">;</span> <span class="token comment">// 36 clock cycle + 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="wai-she-shi-neng">外设使能</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203171424466.png" alt="image-20241203171424466"></p>
<blockquote>
<p>[!NOTE]</p>
<p>需要注意，该配置应该在所有I2C配置完成之后</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_PE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="shi-li-dai-ma">示例代码</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIO时钟配置</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_I2C2EN<span class="token punctuation">;</span>

    <span class="token comment">// 2. 配置GPIO工作模式为复用开漏输出 mode=11 cnf=11</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span> GPIO_CRH_CNF11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_CNF10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 特别注意，如下操作无法得到预期结果，GPIO工作不正常</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</span>
    <span class="token comment">// 如下则是可以的</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 | GPIO_CRH_CNF10);</span>

    <span class="token comment">// 3. 配置外设为I2C模式（默认就是I2C模式，1-SMBUS模式）</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_SMBUS<span class="token punctuation">;</span>

    <span class="token comment">// 4. 配置外设时钟</span>
    I2C2<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> <span class="token number">36</span><span class="token punctuation">;</span> <span class="token comment">// 必须小于等于APB1的最大时钟频率36MHz</span>

    <span class="token comment">// 5. 配置外设模式：I2C标准模式（100kHz）、SCL时钟频率（100kHz）</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CCR_FS<span class="token punctuation">;</span> <span class="token comment">// 标准模式</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> <span class="token number">180</span><span class="token punctuation">;</span> <span class="token comment">// SCL高低电平周期5us / 外设时钟周期(1/36us) = 5 * 36</span>

    <span class="token comment">// 6. 配置TRISE-SCL最大上升时间</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_TRISE_TRISE<span class="token punctuation">;</span> <span class="token comment">// 清零</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">|=</span> <span class="token number">37</span><span class="token punctuation">;</span> <span class="token comment">// I2C标准模式最大上升时间1us / 外设时钟周期(1/36us) + 1 = 36 + 1</span>

    <span class="token comment">// 7. 使能外设</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_PE<span class="token punctuation">;</span> <span class="token comment">// Peripheral(I2C) Enable</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-qi-shi-xin-hao">发送起始信号</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203171713561.png" alt="image-20241203171713561"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203171644654.png" alt="image-20241203171644654"></p>
<p>设置 <code>START</code>位后，外设会在BUSY位被清除后产生一个起始信号并切换到主设备模式。</p>
<p><mark>起始信号的产生有个前提：总线是空闲状态</mark></p>
<ul>
<li>BUSY复位值为清除状态</li>
<li>当SDA或SCL被拉低时，BUSY会被硬件置位，表示总线正在用于通信</li>
<li>当停止条件产生后，BUSY会被硬件清除<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203172040017.png" alt="image-20241203172040017" style="zoom: 33%;"></li>
</ul>
<p>在主设备模式下，再次置位START会使外设在当前字节传输完成（如果移位寄存器正在传输字节数据）时产生ReStart重复起始信号。</p>
<p>一旦产生了起始信号，SB会被硬件置位，并且产生中断（如果设置了ITEVTEN位）。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203173333175.png" alt="image-20241203173333175"></p>
<p>因此主设备可以在设置START之后，轮询SR1中的SB，并在SB被置位后将从设备地址写入DR发送缓冲区。</p>
<h3 id="shi-li-dai-ma-1">示例代码</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 产生起始信号（当BUSY=1时不会立即产生）</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_START<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 起始信号产生后，由硬件置位SB</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_SB<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_Start timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 紧接着发送设备地址会写DR，读SR1写DR序列会清除SB，因此这里不需要手动清除SB</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-cong-she-bei-di-zhi">发送从设备地址</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203174842914.png" alt="image-20241203174842914"></p>
<p>轮询SR1等待起始信号发出后，主设备可以将从设备地址写入DR，然后从设备地址就会通过内部的移位寄存器发送到SDA总线上。</p>
<p>一旦从设备地址字节发送完成后，SR1中的ADDR会被硬件置位，并产生中断（如果配置了CR2中的ITEVFEN）。</p>
<p>因此，主设备可以轮询SR1中的ADDR，当其被置位后跟随一个读SR2操作，就可以清除ADDR标志位。</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203175416218.png" alt="image-20241203175416218" style="zoom: 50%;">
<blockquote>
<p>[!NOTE]</p>
<p>注意：当地址数据发送到SDA总线之后，并且收到了从设备的ACK，ADDR才会被置位。因此，与软件模拟I2C相比，我们不需要手动读取SDA并判断ACK/NACK了，硬件帮我们完成了这一步。</p>
</blockquote>
<h3 id="shi-li-dai-ma-2">示例代码</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 产生起始信号后，DR肯定为空，可以将从设备地址直接写入DR</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> addr<span class="token punctuation">;</span>
    <span class="token comment">// 等待硬件置位ADDR（表明从设备地址以发出并收到了相应从设备的ACK）</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_ADDR<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendAddr timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 清除ADDR标志位操作序列：读SR1后跟随一个读SR2</span>
    I2C2<span class="token operator">-&gt;</span>SR2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="zui-di-you-xiao-wei-biao-shi-du-xie">最低有效位表示读/写</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203180555453.png" alt="image-20241203180555453"></p>
<p>发送从设备地址时，主设备可以通过其中的最低有效为（LSB）来决定后续通信过程中，当前外设充当发送方还是接收方。</p>
<h2 id="zhu-she-bei-fa-song-shu-ju">主设备发送数据</h2>
<blockquote>
<p>Following the address transmission and after clearing ADDR, the master sends bytes from the DR register to the SDA line via the internal shift register.</p>
</blockquote>
<p>在发送完从设备地址并清除ADDR之后，接下来主设备可以经由内部的移位寄存器将写入DR的字节数据发送到SDA总线上。</p>
<blockquote>
<p>The master waits until the first data byte is written into I2C_DR (see Figure 273 Transfer sequencing EV8_1).</p>
</blockquote>
<p>主设备可以轮询SR1中的TXE，开始将第一个数据字节写入DR发送缓冲区：</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203181334652.png" alt="image-20241203181334652"></p>
<p>按照手册所述（see Figure 273 Transfer sequencing EV8_1），当前我们所处的阶段对应EV8_1，移位寄存器和DR缓冲区都为空，轮询TXE会立即通过，可以将第一个数据字节Data1写入DR。由于移位寄存器为空，写入DR的字节会被直接递交给移位寄存器并传输到SDA总线上。因为DR仍然是空的，第二次轮询TXE也会立即通过，会将第二个数据字节Data2写入DR。后续字节写入DR时则会出现移位寄存器正在发送Data1、DR缓冲区数据Data2等待递交移位寄存器的情况，因此轮询TXE可能会耗费一些时间。</p>
<blockquote>
<p>When the acknowledge pulse is received, the TxE bit is set by hardware and an interrupt is generated if the ITEVFEN and ITBUFEN bits are set</p>
</blockquote>
<p>当移位寄存器发送完一个字节（例如Data1）并且收到了从设备的ACK时，DR缓冲区中的数据会被递交给移位寄存器并且TXE会被硬件置位（指示我们可以向DR写入下一个要发送的数据了）。这时发送Data3前的轮询会通过，并将Data3写入DR。</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203184111734.png" alt="image-20241203184111734"></p>
<p>如上，我们可以从TxE的描述中获取更多细节。</p>
<ul>
<li>发送过程中，当DR寄存器为空时，DR会被硬件置位，但发送地址阶段除外</li>
<li>写DR可以清除该标志位；在起始信号、停止信号、外设使能后会由硬件清除。</li>
<li>如果收到了从设备的NACK，或者下个要发送的字节是帧错误检查字节，则TXE不会被置位。</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>以下两种情况TXE不会被清除：</p>
<ul>
<li>发送第一个数据字节时（因为直接写入了移位寄存器中，DR仍然是空的）。</li>
<li>当BTF被置位时向DR写入数据（该标志在TXE=1并且移位寄存器没有正在发送的数据时被置位），数据会被直接递交给移位寄存器。</li>
</ul>
</blockquote>
<blockquote>
<p>If TxE is set and a data byte was not written in the DR register before the end of the last data transmission, BTF is set and the interface waits until BTF is cleared by a read from I2C_SR1 followed by a write to I2C_DR, stretching SCL low.</p>
</blockquote>
<p>如果TXE被置位了，并且在上一个数据发送结束之前都没有数据字节被写入DR，BTF被置位。此时，外设会通过延伸（延展）SCL低电平，直到BTF被清除（读SR1后跟随一个写DR）</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203185842734.png" alt="image-20241203185842734"></p>
<p>想一想，正常情况下，为了更好的连贯性和发送速率，主设备应该不论轮询TXE并向DR写入待发送的字节，尽管移位寄存器可能还正在传输上个字节，但这并不影响将下个要传输的字节写入DR。</p>
<p>当TXE被置位（发送缓冲区为空），并且移位寄存器中的传输也结束了，还没写DR操作，会有如下几种情况：</p>
<ul>
<li>此次通信所有数据都一次写入DR了，此时可能移位寄存器正在传输倒数第二个字节，DR还暂存着最后一个要发送的字节，因此主设备在发送停止信号前需要轮询BTF确认DR为空了（TXE=1），移位寄存器也结束传输状态了并且最后一个字节的ACK也收到了（TXE=1），这时可以发出停止信号，随后TXE和BTF都会被清除。</li>
<li>主设备对该传输任务设置的优先级不高，不能及时检测到TXE并写DR，可以使用轮询BTF的方式来代替轮询TXE，但传输速率会下降，因为BTF被置位期间，SCL会处于低电平拉伸状态（stretch）</li>
<li><mark>主设备期望知道每个字节是否收到了ACK</mark>，因此每次向DR写入字节后，都轮询BTF，确认该字节发送完成并收到了从设备的ACK时才继续向DR写入下一个字节，这样能在某个字节收到不期望的NACK时做一些异常处理。</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203192337639.png" alt="image-20241203192337639"></p>
<p>手册中发送时序图也提到了这一点（参考EV_8），如果采用轮询TXE的方式连续发送多个字节，那么必须在DR为空，移位寄存器（非空）时，将下个字节写入DR以清除TXE。如果无法实现该操作序列，则建议轮询BTF来代替TXE以避免降低通信效率。</p>
<h4 id="shi-li-dai-ma-bu-deng-dai-mei-ge-zi-jie-de-ack-jie-guo">示例代码-不等待每个字节的ACK结果</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 等待发送缓冲区非空</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait TXE timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将数据传输到发送缓冲区，同时读SR1跟随一个写DR将清除TXE标志</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="shi-li-dai-ma-deng-dai-mei-ge-zi-jie-de-ack-jie-guo">示例代码-等待每个字节的ACK结果</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 等待发送缓冲区非空</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait TXE timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将数据传输到发送缓冲区，同时读SR1跟随一个写DR将清除TXE标志</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> data<span class="token punctuation">;</span>

    <span class="token comment">// 等待当前字节传输完成且收到ACK（可选，可以在超时时针对当前字节的NACK做异常处理）</span>
    timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_BTF<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait BTF timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里不需要手动清除BTF，下一个字节的写DR会清除BTF，停止信号也会清除BTF</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-ting-zhi-xin-hao-fa-song-mo-shi-xia">发送停止信号（发送模式下）</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203194648097.png" alt="image-20241203194648097"></p>
<p>在向DR写入最后一个数据字节后，软件可以产生一个停止信号，外设会自动返回从设备模式。</p>
<blockquote>
<p>[!NOTE]</p>
<p>产生停止信号的时机应该在检查到TXE或BTF被置位之后。</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203194909773.png" alt="image-20241203194909773"></p>
<p>设置该位后，在当前字节传输完成之后或当前起始信号发送之后将会产生停止信号。</p>
<h4 id="shi-li-dai-ma-3">示例代码</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 等待条件: 发送缓冲区为空</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zhu-she-bei-jie-shou-shu-ju">主设备接收数据</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203195407265.png" alt="image-20241203195407265"></p>
<p>在以写模式发送从设备地址，并清除ADDR标志后，I2C外设会进入主设备接收模式。</p>
<p>在该模式下，外设通过内部移位寄存器从SDA总线接收字节到DR中。在接收到每个字节后，外设会产生如下操作序列：</p>
<ol>
<li>如果设置了CR1中的ACK=1，外设会自动响应ACK脉冲</li>
<li>SR1中的RXNE会被硬件置位，并产生中断（如果使能了中断）</li>
</ol>
<p>如果RXNE被置位，并且DR中的数据在最近一次接收数据完成之前还没有被读取，此时接收到的数据无法存入DR，那么BTF会被硬件置位。外设会延伸SCL低电平（总线挂起），直到BTF被清除（一个读SR1操作后跟随一个读DR操作）</p>
<h4 id="shi-li-dai-ma-4">示例代码</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_ReceiveByte timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> I2C2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="xiang-ying-ack-nack">响应ACK/NACK</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203201826539.png" alt="image-20241203201826539"></p>
<p>将ACK设置为1后，外设会对每个接收到的字节响应ACK。如果设置为0，则对每个接收到的字节响应NACK。</p>
<h4 id="shi-li-dai-ma-5">示例代码：</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-ting-zhi-xin-hao-jie-shou-mo-shi-xia">发送停止信号（接收模式下）</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="zhu-she-bei-jie-shou-liu-cheng">主设备接收流程</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203202947534.png" alt="image-20241203202947534"></p>
<p>如果该任务有最高优先级可以使用该方式一。</p>
<p>主设备需要针对从设备接收的最后一个字节发送NACK。从设备在收到该NACK后，会释放对SCL和SDA总线的控制。接着主设备就可以发送停止信号或重新开始信号。</p>
<ol>
<li>为了在接收到最后一个字节后产生NACK脉冲，必须恰好在读倒数第二个数据字节时（在倒数第二个RXNE事件发生时）将ACK清零。否则最后一个字节传输结束时，ACK如果没有清零，外设就会自动响应ACK。</li>
<li>为了产生停止/重新开始信号，软件必须恰好在读倒数第二个数据字节时（在倒数第二个RXNE事件发生时）将STOP/START置位。</li>
<li>如果只需要接收一个字节，那么应该在紧跟着发送设备地址并清除ADDR之后将ACK清零并置位STOP。</li>
</ol>
<p>在停止信号产生之后，外设将自动回到从设备模式（SCL/SDA为释放状态）。</p>
<h3 id="shi-li-dai-ma-6">示例代码</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="wan-zheng-dai-ma-1">完整代码</h2>
<h3 id="i-2-c-hard-h">i2c_hard.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="i-2-c-hard-c">i2c_hard.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_hard.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMEOUT_COUNT</span> <span class="token expression"><span class="token number">0xFFFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OK</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAIL</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIO时钟配置</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_I2C2EN<span class="token punctuation">;</span>

    <span class="token comment">// 2. 配置GPIO工作模式为复用开漏输出 mode=11 cnf=11</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span> GPIO_CRH_CNF11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_CNF10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 特别注意，如下操作无法得到预期结果，GPIO工作不正常</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</span>
    <span class="token comment">// 如下则是可以的</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 |</span>
    <span class="token comment">// GPIO_CRH_CNF10);</span>

    <span class="token comment">// 3. 配置外设为I2C模式（默认就是I2C模式，1-SMBUS模式）</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_SMBUS<span class="token punctuation">;</span>

    <span class="token comment">// 4. 配置外设时钟</span>
    I2C2<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> <span class="token number">36</span><span class="token punctuation">;</span> <span class="token comment">// 必须小于等于APB1的最大时钟频率36MHz</span>

    <span class="token comment">// 5. 配置外设模式：I2C标准模式（100kHz）、SCL时钟频率（100kHz）</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CCR_FS<span class="token punctuation">;</span> <span class="token comment">// 标准模式</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> <span class="token number">180</span><span class="token punctuation">;</span> <span class="token comment">// SCL高低电平周期5us / 外设时钟周期(1/36us) = 5 * 36</span>

    <span class="token comment">// 6. 配置TRISE-SCL最大上升时间</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_TRISE_TRISE<span class="token punctuation">;</span> <span class="token comment">// 清零</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">|=</span>
        <span class="token number">37</span><span class="token punctuation">;</span> <span class="token comment">// I2C标准模式最大上升时间1us / 外设时钟周期(1/36us) + 1 = 36 + 1</span>

    <span class="token comment">// 7. 使能外设</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_PE<span class="token punctuation">;</span> <span class="token comment">// Peripheral(I2C) Enable</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 产生起始信号（当BUSY=1时不会立即产生）</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_START<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 起始信号产生后，由硬件置位SB</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_SB<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_Start timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 紧接着发送设备地址会写DR，读SR1写DR序列会清除SB，因此这里不需要手动清除SB</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 产生起始信号后，DR肯定为空，可以将从设备地址直接写入DR</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> addr<span class="token punctuation">;</span>
    <span class="token comment">// 等待硬件置位ADDR（表明从设备地址以发出并收到了相应从设备的ACK）</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_ADDR<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendAddr timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 清除ADDR标志位操作序列：读SR1后跟随一个读SR2</span>
    I2C2<span class="token operator">-&gt;</span>SR2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 等待发送缓冲区非空</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait TXE timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将数据传输到发送缓冲区，同时读SR1跟随一个写DR将清除TXE标志</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> data<span class="token punctuation">;</span>

    <span class="token comment">// 等待当前字节传输完成且收到ACK（可选，可以在超时时针对当前字节的NACK做异常处理）</span>
    timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_BTF<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait BTF timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里不需要手动清除BTF，下一个字节的写DR会清除BTF，停止信号也会清除BTF</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// 等待条件: 发送缓冲区为空</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_ReceiveByte timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> I2C2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="eeprom">EEPROM</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_hard.h"</span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __M24C02_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_W</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_R</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait for write cycle</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span>DEV_ADDR_R<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"b1 = %d, b2 = %d, b3 = %d"</span><span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">)</span>

    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"56789"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"12345"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="kuo-zhan-btf-biao-zhi-wei-de-zuo-yong">扩展：BTF标志位的作用</h2>
<p><code>BTF</code> (Byte Transfer Finished) 标志位的作用是指示当前<strong>字节传输完成</strong>，包括发送和接收场景。具体来说，它是一个硬件状态位，反映了数据寄存器（<code>DR</code>）和移位寄存器之间的数据传输状态。</p>
<h3 id="strong-btf-de-ding-yi-yu-zuo-yong-strong"><strong>BTF 的定义与作用</strong></h3>
<ol>
<li><strong>定义</strong>：
<ul>
<li>当移位寄存器中当前数据字节的传输完成（无论是发送还是接收），并且数据寄存器（<code>DR</code>）为空时，硬件会设置 <code>BTF</code> 标志位。</li>
<li>如果在接收模式中，<code>DR</code> 中的数据未被读取，或者在发送模式中新的数据未被写入，I2C 外设会拉低时钟线（SCL），即 <strong>“总线挂起”</strong>，以等待软件处理。</li>
</ul>
</li>
<li><strong>作用</strong>：
<ul>
<li>用于协调主机（MCU）和外设之间的数据流，避免数据丢失或错误。</li>
<li>指示是否需要读取 <code>DR</code>（在接收模式）或写入 <code>DR</code>（在发送模式）。</li>
</ul>
</li>
</ol>
<h1 id="stm-32-cube-mx-shi-xian-eeprom-du-xie">STM32CubeMX实现EEPROM读写</h1>
<h2 id="cube-pei-zhi">Cube配置</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094331841.png" alt="image-20241204094331841"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094511416.png" alt="image-20241204094511416"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094540825.png" alt="image-20241204094540825"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094637054.png" alt="image-20241204094637054"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094700542.png" alt="image-20241204094700542"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094733818.png" alt="image-20241204094733818"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094745141.png" alt="image-20241204094745141"></p>
<h2 id="mdk-pei-zhi">MDK配置</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094958368.png" alt="image-20241204094958368" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204095038798.png" alt="image-20241204095038798"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204095126110.png" alt="image-20241204095126110"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204095213099.png" alt="image-20241204095213099" style="zoom:50%;">
<h2 id="shi-li-dai-ma-7">示例代码</h2>
<h3 id="m-24-c-02-h-2">m24c02.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c.h"</span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __M24C02_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="m-24-c-02-c-2">m24c02.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_W</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_R</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_I2C_Mem_Write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hi2c2<span class="token punctuation">,</span> DEV_ADDR_W<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> I2C_MEMADD_SIZE_8BIT<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span>
                      size<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待EEPROM写周期结束</span>
    <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> byte<span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_I2C_Mem_Read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hi2c2<span class="token punctuation">,</span> DEV_ADDR_W<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> I2C_MEMADD_SIZE_8BIT<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span>
                     size<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b1 = %d, b2 = %d, b3 = %d\n"</span><span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"56789"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"12345"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="printf-zhong-ding-xiang">printf重定向</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c-1">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN Includes */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token comment">/* USER CODE END Includes */</span>  

<span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_I2C2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">安文</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zanwen.github.io/2024/11/30/28867.html">https://zanwen.github.io/2024/11/30/28867.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">安文</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/I%C2%B2C/">
                                    <span class="chip bg-color">I²C</span>
                                </a>
                            
                                <a href="/tags/I2C/">
                                    <span class="chip bg-color">I2C</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/12/04/52886.html">
                    <div class="card-image">
                        
                        <img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/pexels-248509299-12441849.jpg" class="responsive-img" alt="定时器的本质就是数数（基于STM32F103深入理解定时器）">
                        
                        <span class="card-title">定时器的本质就是数数（基于STM32F103深入理解定时器）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-12-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/STM32/" class="post-category">
                                    STM32
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/TIMER/">
                        <span class="chip bg-color">TIMER</span>
                    </a>
                    
                    <a href="/tags/%E5%AE%9A%E6%97%B6%E5%99%A8/">
                        <span class="chip bg-color">定时器</span>
                    </a>
                    
                    <a href="/tags/TIM/">
                        <span class="chip bg-color">TIM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/11/30/5535.html">
                    <div class="card-image">
                        
                        <img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/pexels-mei-lin-1483020-6666098.jpg" class="responsive-img" alt="MDK调试之可视化外设&amp;内核寄存器">
                        
                        <span class="card-title">MDK调试之可视化外设&amp;内核寄存器</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-11-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MDK/" class="post-category">
                                    MDK
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MDK/">
                        <span class="chip bg-color">MDK</span>
                    </a>
                    
                    <a href="/tags/Debug/">
                        <span class="chip bg-color">Debug</span>
                    </a>
                    
                    <a href="/tags/%E5%AF%84%E5%AD%98%E5%99%A8%E5%8F%AF%E8%A7%86%E5%8C%96/">
                        <span class="chip bg-color">寄存器可视化</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">安文</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">97.8k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zanwen" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:872852458@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=872852458" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 872852458" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
