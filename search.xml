<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆä¸‰ï¼‰æŒ‡ä»¤æµæ°´çº¿åˆ†æåŠä¼ªæŒ‡ä»¤</title>
    <url>/2024/11/24/14899.html</url>
    <content><![CDATA[<h1 id="zhi-ling-liu-shui-xian-fen-xi">æŒ‡ä»¤æµæ°´çº¿åˆ†æ</h1>
<h2 id="qian-yan">å‰è¨€</h2>
<p>åœ¨ARMæ ¸ä¸­ï¼Œä¸ºå¢åŠ å¤„ç†å™¨æŒ‡ä»¤æµçš„é€Ÿåº¦ï¼ŒARM7ç³»åˆ—ä½¿ç”¨3çº§æµæ°´çº¿ã€‚å…è®¸å¤šä¸ªæ“ä½œåŒæ—¶å¤„ç†ï¼Œè€Œéé¡º<br>
åºæ‰§è¡Œã€‚<mark>ä¸åŒçš„ARMæ ¸ï¼Œæµæ°´çº¿çš„çº§æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼ŒARMæ ¸ç‰ˆæœ¬è¶Šé«˜ï¼Œæµæ°´çº¿çº§æ•°è¶Šå¤šã€‚å¯¹äºè½¯ä»¶å·¥</mark><br>
<mark>ç¨‹å¸ˆç¼–ç¨‹è€Œè¨€ï¼Œç»Ÿä¸€æŒ‰ç…§ä¸‰çº§æµæ°´çº¿æ¥åˆ†æå°±å¯ä»¥äº†ã€‚</mark></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124174742518.png" alt="image-20241124174742518" style="zoom: 33%;">
<blockquote>
<p>åœ¨MDKä¸­æ–­ç‚¹è°ƒè¯•æ—¶ä¼šå‘ç°PCæŒ‡å‘çš„å½“å‰ä»£ç è¡Œï¼Œè¿™æ˜¯å› ä¸ºMDKè°ƒè¯•å±è”½äº†åº•å±‚æµæ°´çº¿ç»†èŠ‚ï¼Œä»¥é¿å…äº§ç”Ÿæ­§ä¹‰ã€‚</p>
</blockquote>
<p>åœ¨ARMçŠ¶æ€ï¼ŒæŒ‡ä»¤ä½å®½ä¸º32ä½4å­—èŠ‚ï¼Œå› æ­¤å½“PCé¢„å–ï¼ˆä¾‹å¦‚ï¼‰0x8åœ°å€çš„æŒ‡ä»¤æ—¶ï¼Œ0x4åœ°å€çš„æŒ‡ä»¤æ­£åœ¨è¢«è§£ç ã€0x0åœ°å€çš„æŒ‡ä»¤æ­£åœ¨è¢«æ‰§è¡Œã€‚ThumbçŠ¶æ€æ˜¯å‹ç¼©æ ¼å¼çš„æŒ‡ä»¤é›†ï¼ŒæŒ‡ä»¤ä½å®½æ˜¯16ä½2å­—èŠ‚ï¼Œå› æ­¤åå·®æ˜¯2ã€‚</p>
<h2 id="zui-jia-liu-shui-xian-fen-xi-jin-cao-zuo-ji-cun-qi">æœ€ä½³æµæ°´çº¿åˆ†æï¼ˆä»…æ“ä½œå¯„å­˜å™¨ï¼‰</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124175951254.png" alt="image-20241124175951254" style="zoom:50%;">
<h2 id="nei-cun-fang-wen-zhi-ling-liu-shui-xian">å†…å­˜è®¿é—®æŒ‡ä»¤æµæ°´çº¿</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124180204732.png" alt="image-20241124180204732"></p>
<p>ç”±äºå†…å­˜è®¿é—®æ•ˆç‡è¾ƒä½ï¼Œå› æ­¤åœ¨æ‰§è¡ŒLDRæŒ‡ä»¤æ—¶ï¼Œæ— æ³•åœ¨ä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸå†…å®Œæˆï¼ˆéœ€è¦Eã€Mã€Wä¸‰ä¸ªå‘¨æœŸï¼‰ã€‚è¿™æ ·ï¼Œå³ä½¿å®ƒå‰é¢çš„Dè·‘å¾—å¿«ï¼Œä½†è§£ç çš„æŒ‡ä»¤æ— æ³•ç§»äº¤ç»™Eï¼ˆå®ƒæ‰‹ä¸Šçš„æ´»è¿˜æ²¡å¹²å®Œï¼‰ï¼Œåªèƒ½å¹²ç­‰ï¼ŒFä¹Ÿæ˜¯ä¸€æ ·ã€‚</p>
<h2 id="fen-zhi-tiao-zhuan-liu-shui-xian-ju-li">åˆ†æ”¯ï¼ˆè·³è½¬ï¼‰æµæ°´çº¿ä¸¾ä¾‹</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124181209542.png" alt="image-20241124181209542"></p>
<p>åœ¨Eæ‰§è¡Œè·³è½¬æŒ‡ä»¤æ—¶ï¼Œè·‘åœ¨å®ƒå‰é¢çš„Fã€Dä¸å¾—ä¸ä¸¢å¼ƒå·²å®Œæˆçš„å·¥ï¼ˆè§£ç  <code>0x3004 SUB</code>ï¼Œé¢„å– <code>0x3008 AND</code>ï¼‰ä½œï¼Œè½¬è€Œä»ç›®æ ‡åœ°å€é‡æ–°å¼€å§‹Fã€Dã€Eæµç¨‹ã€‚</p>
<p>å›¾ä¸­Eæ‰§è¡Œ <code>BL 0X8FEC</code>æ—¶ï¼ŒFæ­£åœ¨é¢„å– <code>0x3008</code>åœ°å€çš„æŒ‡ä»¤ï¼Œåœ¨è¯¥æŒ‡ä»¤å‘¨æœŸç»“æŸæ—¶ï¼ŒPCæŒ‡å‘ <code>0x3008</code>ï¼Œä¸”ç”±äºæ˜¯ <code>BL</code>è·³è½¬ï¼Œå› æ­¤è¯¥å€¼ä¼šè¢«ä¿å­˜åˆ° <code>LR</code>å¯„å­˜å™¨ä¸­ã€‚</p>
<p>å½“æ‰§è¡Œ <code>L</code>æŒ‡ä»¤æ—¶ï¼Œä¼šå°†<code>LR</code>å›å†™åˆ° <code>PC</code>ä¸­ï¼Œä½†æ˜¯ç”±äºæ­¤å‰å¯¹äº <code>0X3004</code>çš„è§£ç å·¥ä½œè¢«ä¸¢å¼ƒäº†ï¼Œå› æ­¤å¤„ç†å™¨ä¼šè‡ªåŠ¨æ‰§è¡Œä¸€ä¸ª <code>A</code>æŒ‡ä»¤ï¼Œå°† <code>PC</code>è°ƒæ•´åˆ° <code>0x3004</code>çš„ä½ç½®æ¥ç€æ‰§è¡Œã€‚</p>
<h2 id="zong-jie">æ€»ç»“</h2>
<ul>
<li>å½“åªæœ‰å¯„å­˜å™¨æ“ä½œï¼ˆæ“ä½œæ•ˆç‡å’ŒCPUå¤„äºåŒä¸€é‡çº§ï¼‰æ—¶ï¼ŒæŒ‡ä»¤æµçº¿æ•ˆç‡æ˜¯æœ€é«˜çš„ï¼šåœ¨æ¯ä¸ªæŒ‡ä»¤å‘¨æœŸï¼Œæµæ°´çº¿ä¸Šçš„ä¸‰ä¸ªå·¥äººFã€Dã€Eéƒ½åœ¨ä¸åœäº’ç›¸é…åˆï¼Œé«˜æ•ˆå®ŒæˆæŒ‡ä»¤æ‰§è¡Œæ‰€éœ€çš„ä¸‰ä¸ªé˜¶æ®µçš„å·¥ä½œã€‚</li>
<li>å½“è®¿é—®å†…å­˜ï¼ˆå¤–è®¾ï¼‰æ—¶ï¼Œç”±äºç‰©ç†ç‰¹æ€§ï¼Œå¤„ç†å™¨çš„å·¥ä½œæ•ˆç‡è¿œé«˜äºå¤–è®¾ï¼Œå› æ­¤å·¥äººEåªèƒ½æ”¾æ…¢èŠ‚å¥å’Œå¤–è®¾ååŒæŠŠæ´»å¹²äº†ï¼Œè¿™æœŸé—´å³ä½¿Fã€Då®Œæˆäº†æ‰‹å¤´ä¸Šçš„æ´»ï¼Œç”±äºä¸èƒ½å‘Dã€Eç§»äº¤ï¼Œå› æ­¤ä¹Ÿåªèƒ½å¹²ç­‰ç€ã€‚å¯¼è‡´äº†çº§è”åœé¡¿ï¼ˆstallï¼‰çš„æ•ˆåº”ã€‚</li>
<li>å½“å‘ç”Ÿè·³è½¬æ—¶ï¼Œå·¥äººFã€Dè¶…å‰å®Œæˆçš„å·¥ä½œåªèƒ½è¢«è¿«ä¸¢å¼ƒï¼Œè½¬è€Œä»æ–°çš„æŒ‡ä»¤åœ°å€é‡æ–°å¼€å§‹å¹²æ´»ï¼Œä¸”å¦‚æœè·³è½¬å›æ¥ï¼Œä¹‹å‰å¹²å®Œçš„æ´»è¿˜å¾—é‡æ–°å†å¹²ä¸€æ¬¡ã€‚</li>
</ul>
<h1 id="chang-yong-wei-zhi-ling-fen-xi">å¸¸ç”¨ä¼ªæŒ‡ä»¤åˆ†æ</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124183925641.png" alt="image-20241124183925641"></p>
<h2 id="ldr-r-0-0-x-12345678-fen-xi">LDR R0,=0x12345678 åˆ†æ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124184043373.png" alt="image-20241124184043373"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124184314696.png" alt="image-20241124184314696"></p>
<p>ç¼–è¯‘å™¨ä¼šå°†å¸¸é‡ <code>0x12345678</code>é¢„å…ˆæ”¾åˆ°æŸä¸ªå†…å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯æ‰€æœ‰ä»£ç æŒ‡ä»¤ä¹‹åï¼‰ï¼Œå¹¶å°†LDRç¿»è¯‘æˆä¸€æ¡è¯»å†…å­˜çš„æŒ‡ä»¤ã€‚</p>
<h2 id="ldr-r-0-label-fen-xi">LDR R0,=label åˆ†æ</h2>
<p>æ ‡ç­¾æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå®ƒçš„å€¼å°±æ˜¯æ ‡ç­¾åç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå¯ä»¥ç†è§£ä¸ºç»™è¿™ä¸ªåœ°å€å–äº†ä¸ªåˆ«åã€‚</p>
<h3 id="dai-ma-duan-qi-shi-di-zhi-wei-0-x-0">ä»£ç æ®µèµ·å§‹åœ°å€ä¸º0x0</h3>
<p>å¯¹äºç»™å®šçš„ä»£ç æ®µèµ·å§‹åœ°å€å’ŒæŒ‡ä»¤ä½å®½ï¼Œæ¯æ¡æŒ‡ä»¤çš„å­˜æ”¾åœ°å€åœ¨ç¼–è¯‘é˜¶æ®µéƒ½å¯ä»¥ç¡®å®šï¼Œå¦‚ä¸‹å°†ä»£ç æ®µçš„èµ·å§‹åœ°å€é…ç½®ä¸º <code>0x0</code>ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124185737443.png" alt="image-20241124185737443" style="zoom:33%;">
<p>å¯¹äºARMçŠ¶æ€ä¸‹ï¼ˆæŒ‡ä»¤ä½å®½ä¸º4å­—èŠ‚ï¼‰ï¼Œå¦‚ä¸‹ä»£ç çš„æ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥é¡ºåºè®¡ç®—å…¶å­˜å‚¨åœ°å€</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#1			@0x00000000
	mov r2,#2			@0x00000004
	ldr r3,=addr		@0x00000008
	ldr r4,[r3]			@0x0000000C
	
stop:
	b stop				@0x00000010
	
addr:					@ç»™0x00000014å–äº†ä¸ªåˆ«åå«addr
	.word 0x12345678	@0x00000014 åœ¨è¿™ä¸ªåœ°å€å­˜æ”¾ä¸€ä¸ªå­—çš„æ•°æ®
		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ ‡ç­¾çš„å£°æ˜å¹¶ä¸å±äºæŒ‡ä»¤ï¼Œå› æ­¤ä¸å ç”¨åœ°å€ç©ºé—´ã€‚å…¶ä¸­ <code>ldr r3,=addr</code>ç­‰ä»·äº <code>ldr r3,=0x00000014</code>ã€‚</p>
<p><code>ldr r3,=addr</code>ï¼ˆå°†addrè¡¨ç¤ºçš„åœ°å€å€¼åŠ è½½åˆ°R3ï¼‰åˆ†æå¦‚ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124190511217.png" alt="image-20241124190511217"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124190550278.png" alt="image-20241124190550278"></p>
<p><code>ldr r4,[r3]</code>ï¼šä»R3å¯¹åº”çš„åœ°å€è¯»å–æ•°æ®ï¼ˆè¯¥æ•°æ® <code>0x12345678</code> åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡ <code>.word</code>ä¼ªæŒ‡ä»¤é¢„å…ˆå­˜å‚¨åœ¨äº†å†…å­˜ç©ºé—´ä¸­ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124190809542.png" alt="image-20241124190809542"></p>
<h3 id="dai-ma-duan-qi-shi-di-zhi-wei-0-x-2000">ä»£ç æ®µèµ·å§‹åœ°å€ä¸º0x2000</h3>
<p>å°†ä»£ç æ®µèµ·å§‹åœ°å€æ”¹ä¸º0x2000ï¼Œè®¡ç®—è§„åˆ™æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±èƒ½ç¡®å®šå„ä¸ªæŒ‡ä»¤ä»¥åŠ <code>.word</code>æ•°æ®å­˜æ”¾çš„åœ°å€ï¼ˆæ³¨æ„ä¿®æ”¹åéœ€è¦é‡æ–°ç¼–è¯‘ä¸‹ï¼‰ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124200510540.png" alt="image-20241124200510540" style="zoom:33%;">
<p>è°ƒè¯•å‰éœ€è¦ä¿®æ”¹ä¸‹å†…å­˜æ˜ å°„ï¼Œé»˜è®¤æ˜¯ä»0x0å¼€å§‹æ‰§è¡Œçš„ï¼Œæˆ‘ä»¬éœ€è¦è®©0x0åˆ°0x2000åŠå…¶åçš„ä¸€æ®µå†…å­˜éƒ½å¯æ‰§è¡Œï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124200751229.png" alt="image-20241124200751229" style="zoom:50%;">
<p>ç„¶ååœ¨ <code>_start</code>çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³è¿‡ä»0x0åˆ°0x2000ä¹‹é—´çš„æ— æ•ˆæŒ‡ä»¤ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124201005483.png" alt="image-20241124201005483" style="zoom: 33%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124200325028.png" alt="image-20241124200325028" style="zoom:33%;">
<h3 id="zong-jie-1">æ€»ç»“</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124195231017.png" alt="image-20241124195231017" style="zoom: 50%;">
<h2 id="ldr-r-0-label-fen-xi-1">LDR R0,label åˆ†æ</h2>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#1			
	mov r2,#2			
	ldr r3,addr			
	mov r4,r3			
stop:
	b stop				
addr:	
	.word 0x12345678	
		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ldr r3,=addr</code>å¯ä»¥ç†è§£ä¸ºå°†æ ‡ç­¾ <code>addr</code>çš„å€¼å½“åšå¸¸é‡åŠ è½½åˆ°R3ä¸­ï¼Œè€Œ <code>ldr r3,addr</code>åˆ™æ˜¯ä» <code>addr</code>å¯¹åº”çš„åœ°å€åŠ è½½æ•°æ®åˆ°R3ä¸­ï¼Œç›¸å½“äº <code>R3=p</code>å’Œ <code>R3=*p</code>çš„å…³ç³»</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124201244164.png" alt="image-20241124201244164" style="zoom: 33%;">
<h2 id="adr-r-0-label-dong-tai-huo-qu-biao-qian-di-zhi">ADR R0,label åŠ¨æ€è·å–æ ‡ç­¾åœ°å€</h2>
<blockquote>
<p>This instruction adds an immediate value to the PC value to form a PC-relative address, and writes the result to the destination register.</p>
</blockquote>
<p>ADR æ˜¯ â€œAddressâ€ çš„ç¼©å†™ï¼Œå®ƒæ˜¯ä¸€æ¡ç”¨äºç”Ÿæˆåœ°å€çš„ä¼ªæŒ‡ä»¤ã€‚ADR æŒ‡ä»¤ç”¨äºè®¡ç®—ä¸€ä¸ªç›®æ ‡åœ°å€ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ°æŒ‡å®šçš„å¯„å­˜å™¨ä¸­ã€‚ç›®æ ‡åœ°å€æ˜¯åŸºäºå½“å‰ PC åŠ ä¸Šä¸€ä¸ªåç§»é‡è®¡ç®—å¾—å‡ºçš„ï¼Œå› æ­¤å®ƒåªèƒ½è®¿é—®å½“å‰ä»£ç æ®µé™„è¿‘çš„åœ°å€ã€‚</p>
<h3 id="strong-zhi-ling-ge-shi-strong"><strong>æŒ‡ä»¤æ ¼å¼</strong></h3>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">ADR &lt;Rd&gt;, &lt;label&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>&lt;Rd&gt;</code>ï¼šç›®æ ‡å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨è®¡ç®—å‡ºçš„åœ°å€ã€‚</li>
<li><code>&lt;label&gt;</code>ï¼šç›®æ ‡åœ°å€æ ‡ç­¾ï¼Œå¿…é¡»ä½äºå½“å‰æŒ‡ä»¤å‰åä¸€å®šèŒƒå›´å†…ã€‚</li>
</ul>
<h3 id="shi-li">ç¤ºä¾‹</h3>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#1			
	mov r2,#2			
	adr r3,addr			
	ldr r4,[r3]		
stop:
	b stop				
addr:	
	.word 0x12345678	
		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124202620567.png" alt="image-20241124202620567"></p>
<h3 id="dui-bi-ldr-r-0-label">å¯¹æ¯” LDR R0,=label</h3>
<p>å¦‚ä¸‹å›¾ï¼Œ<code>LDR R0,=label</code>ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®ä»£ç æ®µèµ·å§‹åœ°å€å’ŒæŒ‡ä»¤ä½å®½è®¡ç®—å‡ºlabelå¯¹åº”çš„åœ°å€å€¼ï¼ˆ<code>0x00000014</code>ï¼‰ï¼Œå¹¶å•ç‹¬å¼€è¾Ÿä¸€ä¸ªå†…å­˜ï¼ˆ<code>0x00000018</code>ï¼‰å­˜æ”¾è¿™ä¸ª<mark>å†™æ­»</mark>çš„æ•°æ®ï¼Œåœ¨è¿è¡Œæ—¶é€šè¿‡LDRè¯»å–è¿™ä¸ªå†…å­˜ä¸­å†™æ­»çš„labelåœ°å€å€¼åˆ°R3ä¸­ã€‚</p>
<p>å¦‚æœèµ·å§‹åœ°å€ä¸º <code>0x2000</code>ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¼šåœ¨å†…å­˜ä¸­å­˜æ”¾ä¸€ä¸ªå†™æ­»çš„ <code>0x2014</code>ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸€ç§<mark>é™æ€çš„åšæ³•</mark>ï¼ˆå’Œç¼–è¯‘æ—¶è®¾ç½®çš„ä»£ç æ®µèµ·å§‹åœ°å€æ˜¯<mark>å¼ºç»‘å®šçš„</mark>ï¼‰ï¼Œå¦‚æœç¨‹åºæ¢ä¸€ä¸ªåœ°å€ç©ºé—´è¿è¡Œï¼Œè¿™ä¸ªå†™æ­»çš„åœ°å€å€¼å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124203311920.png" alt="image-20241124203311920"></p>
<p>è€Œ <code>ADR R0,label</code>åˆ™æ˜¯è¿è¡Œæ—¶åŠ¨æ€è·å–æ ‡ç­¾å¯¹åº”çš„åœ°å€å€¼ï¼Œä¾‹å¦‚ç¼–è¯‘å™¨çŸ¥é“æ‰§è¡Œå½“å‰æŒ‡ä»¤æ—¶ï¼Œé€šè¿‡åœ¨PCä¸Šåç§»4ä¸ªå­—èŠ‚å°±èƒ½å¯»å€åˆ°labelå¯¹åº”çš„åœ°å€ï¼Œé‚£ä¹ˆé€šè¿‡ <code>ADD</code>æŒ‡ä»¤å°±èƒ½åœ¨<mark>è¿è¡Œæ—¶åŠ¨æ€è·å–</mark>è¯¥labelå¯¹åº”çš„åœ°å€ã€‚è¿™ç§åšæ³•æ˜¯<mark>ä¸ä¾èµ–ç¼–è¯‘æ—¶è®¾å®šçš„ä»£ç æ®µèµ·å§‹åœ°å€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆèµ·å§‹åœ°å€ï¼Œéƒ½èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªæ­£ç¡®çš„æ ‡ç­¾åœ°å€</mark>ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124204230866.png" alt="image-20241124204230866"></p>
<h2 id="ru-he-pan-bie-dai-ma-zai-shi-ji-nei-cun-zhong-yun-xing-de-di-zhi">ğŸŒŸå¦‚ä½•åˆ¤åˆ«ä»£ç åœ¨å®é™…å†…å­˜ä¸­è¿è¡Œçš„åœ°å€ï¼Ÿ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124204803253.png" alt="image-20241124204803253"></p>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>æŒ‡ä»¤æµæ°´çº¿</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆäºŒï¼‰æŒ‡ä»¤é›†</title>
    <url>/2024/11/24/18972.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/ddi0406/cd/?lang=en">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
<h1 id="mdk-huan-jing-da-jian">MDKç¯å¢ƒæ­å»º</h1>
<h2 id="xia-zai-legacy-support-zhi-chi-bao">ä¸‹è½½Legacy Supportæ”¯æŒåŒ…</h2>
<p><a href="https://armkeil.blob.core.windows.net/legacy/MDK79525.EXE">https://armkeil.blob.core.windows.net/legacy/MDK79525.EXE</a></p>
<p>å®‰è£…åˆ°MDKçš„å®‰è£…ç›®å½•ä¸‹</p>
<h2 id="xia-zai-arm-gnu-gong-ju-lian">ä¸‹è½½ARM GNUå·¥å…·é“¾</h2>
<p><a href="https://developer.arm.com/-/media/Files/downloads/gnu/13.3.rel1/binrel/arm-gnu-toolchain-13.3.rel1-mingw-w64-i686-arm-none-eabi.exe">https://developer.arm.com/-/media/Files/downloads/gnu/13.3.rel1/binrel/arm-gnu-toolchain-13.3.rel1-mingw-w64-i686-arm-none-eabi.exe</a></p>
<blockquote>
<p><a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads">ä¸‹è½½é¡µé¢</a></p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124092507291.png" alt="image-20241124092507291" style="zoom:50%;">
<h2 id="chuang-jian-xiang-mu">åˆ›å»ºé¡¹ç›®</h2>
<p>å®‰è£…Legacy Supportä¹‹åï¼Œå¯ä»¥åœ¨Deviceä¸­å¯¹å…¶è¿›è¡Œé€‰æ‹©</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124091834836.png" alt="image-20241124091834836"></p>
<p>ç„¶åé€‰æ‹©ARM9E-Sï¼ˆLittle Endianï¼‰è¿›è¡Œä»¿çœŸ</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124092007126.png" alt="image-20241124092007126" style="zoom:50%;">
<p>é”®å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1
	mov r1,#2
	mov r2,#3
	
stop:
	b stop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093601960.png" alt="image-20241124093601960" style="zoom:50%;">
<h2 id="pei-zhi-arm-gnu-gong-ju-lian">é…ç½®ARM GNUå·¥å…·é“¾</h2>
<p>é…ç½®äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼Œå³æ­¤å‰ä¸‹è½½çš„ARM GNUçš„å®‰è£…è·¯å¾„</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093644442.png" alt="image-20241124093644442" style="zoom: 50%;">
<h2 id="bian-yi-xiang-mu">ç¼–è¯‘é¡¹ç›®</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093742741.png" alt="image-20241124093742741" style="zoom:50%;">
<h2 id="fang-zhen-diao-shi-pei-zhi">ä»¿çœŸ/è°ƒè¯•é…ç½®</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093931756.png" alt="image-20241124093931756" style="zoom: 50%;">
<p>é…ç½®ä»£ç æ®µå¼€å§‹åœ°å€ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094012862.png" alt="image-20241124094012862" style="zoom:50%;">
<p><mark>æ³¨æ„</mark>ï¼šæ¯æ¬¡ä¿®æ”¹äº†ç¼–è¯‘é…ç½®é€‰é¡¹åï¼Œæœ€å¥½é‡æ–°ç¼–è¯‘ä¸€ä¸‹ä»¥ä½¿å…¶ç”Ÿæ•ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094203216.png" alt="image-20241124094203216"></p>
<h2 id="kai-shi-diao-shi">å¼€å§‹è°ƒè¯•</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094253900.png" alt="image-20241124094253900"></p>
<p>å¦‚æœç‚¹å‡»è°ƒè¯•æŒ‰é’®åå‡ºç°å¦‚ä¸Šç•Œé¢ï¼Œåˆ™ä»¿çœŸç¯å¢ƒé…ç½®æˆåŠŸäº†ã€‚å·¦ä¾§æ˜¯ARMæ ¸çš„å¯„å­˜å™¨ï¼ˆå¯å‚è€ƒå¦ä¸€ç¯‡æ–‡ç« ã€ŠARMæ ¸ï¼ˆARMv7-A/Rï¼‰å­¦ä¹ ã€‹ï¼‰ï¼Œå³ä¸Šæ–¹æ˜¯å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ã€‚</p>
<p>ç‚¹å‡»å·¦ä¸Šæ–¹çš„è°ƒè¯•æŒ‰é’®ï¼Œå¯ä»¥å‘ç°ç«‹å³æ•°1ã€2ã€3è¢«ä¾æ¬¡åŠ è½½åˆ°å¯„å­˜å™¨R0ã€R1ã€R2ä¸­äº†ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094832406.png" alt="image-20241124094832406" style="zoom:50%;">
<h1 id="zhi-ling-ge-shi">æŒ‡ä»¤æ ¼å¼</h1>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124101014161.png" alt="image-20241124101014161" style="zoom:50%;">
<h2 id="he-fa-li-ji-shu">åˆæ³•ç«‹å³æ•°</h2>
<p>ç«‹å³æ•°ä½¿ç”¨ <code>#æ•°å­—</code>æ¥è¡¨ç¤º</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124102202527.png" alt="image-20241124102202527"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124102256351.png" alt="image-20241124102256351"></p>
<h2 id="ji-cun-qi-yi-wei">å¯„å­˜å™¨ç§»ä½</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124102702102.png" alt="image-20241124102702102"></p>
<h1 id="chang-yong-arm-he-zhi-ling">å¸¸ç”¨ARMæ ¸æŒ‡ä»¤</h1>
<p>å‚è§æ‰‹å†Œä¸­çš„ <mark>A8.8 Alphabetical list of instructions</mark>ç« èŠ‚</p>
<h2 id="shu-ju-chuan-song-zhi-ling">æ•°æ®ä¼ é€æŒ‡ä»¤</h2>
<h3 id="mov">MOV</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124103655266.png" alt="image-20241124103655266" style="zoom:50%;">
<h3 id="mvn">MVN</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124103924679.png" alt="image-20241124103924679" style="zoom:50%;">
<h3 id="ldr">LDR</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124104010947.png" alt="image-20241124104010947" style="zoom:50%;">
<p><mark>æ³¨æ„ï¼šæ•°å­—å¸¸é‡å‰éœ€è¦åŠ ä¸Šâ€œ=â€ï¼Œè¿™æ˜¯å¸¸é‡/å­—é¢é‡è¡¨ç¤ºçš„è¯­æ³•è§„åˆ™</mark></p>
<p>å½“æ•°æ®ä¸æ˜¯åˆæ³•ç«‹å³æ•°æ—¶ï¼Œä½œä¸ºMOVçš„æ›¿ä»£æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€æ¡ä¼ªæŒ‡ä»¤ï¼Œåº•å±‚æ˜¯é€šè¿‡å°†æ•°æ®ï¼ˆ<code>=</code>å·åé¢çš„æ•°å­—ï¼‰å…ˆå­˜æ”¾åˆ°å†…å­˜ï¼Œå†é€šè¿‡LDR(ä»å†…å­˜åŠ è½½åˆ°å¯„å­˜å™¨)æŒ‡ä»¤æ¥å®ç°çš„ã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124104851454.png" alt="image-20241124104851454" style="zoom: 33%;">
<h2 id="shu-ju-ji-suan-zhi-ling">æ•°æ®è®¡ç®—æŒ‡ä»¤</h2>
<h3 id="add-jia-fa">ADDåŠ æ³•</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124105251693.png" alt="image-20241124105251693" style="zoom:50%;">
<h3 id="sub-jian-fa">SUBå‡æ³•</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124105408936.png" alt="image-20241124105408936" style="zoom:50%;">
<p>é»˜è®¤æƒ…å†µä¸‹SUBæ˜¯ä¸ä¼šå½±å“CPSRçš„Næ ‡å¿—ä½çš„ï¼Œå¦‚æœéœ€è¦åˆ™è¦åŠ ä¸ŠSåç¼€ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124105935847.png" alt="image-20241124105935847" style="zoom: 33%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124110015698.png" alt="image-20241124110015698" style="zoom:33%;">
<h3 id="mul-cheng-fa">MULä¹˜æ³•</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124110117129.png" alt="image-20241124110117129"></p>
<h3 id="lian-xi">ç»ƒä¹ </h3>
<blockquote>
<p>ç»ƒä¹ 1ï¼š<br>
(2&lt;&lt;2)-5+0x12345678, è®¡ç®—çš„ç»“æœå­˜æ”¾åœ¨r0</p>
<p>ç»ƒä¹ 2ï¼š<br>
25-3*5+6 æœ€ç»ˆçš„è®¡ç®—ç»“æœå­˜æ”¾åœ¨r0ä¸­</p>
</blockquote>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#2
	mov r1,r0,lsl #2
	sub r1,r1,#5
	ldr r0,=0x12345678
	add r1,r1,r0
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#3
	mov r1,#5
	mul r2,r0,r1 @r0=3*5
	mov r1,#25
	sub r0,r1,r2 @r0=25-15
	add r0,r0,#6 @r0=10+6
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="wei-yun-suan-zhi-ling">ä½è¿ç®—æŒ‡ä»¤</h2>
<h3 id="and">AND</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124112800154.png" alt="image-20241124112800154" style="zoom:50%;">
<h3 id="orr-an-wei-huo">ORR-æŒ‰ä½æˆ–</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124112835561.png" alt="image-20241124112835561" style="zoom:50%;">
<h3 id="eor-an-wei-yi-huo-exclusive-or">EOR-æŒ‰ä½å¼‚æˆ–ï¼ˆExclusive ORï¼‰</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124113112400.png" alt="image-20241124113112400" style="zoom:50%;">
<h3 id="bic-wei-qing-chu-zhi-ling">BIC-ä½æ¸…é™¤æŒ‡ä»¤</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124113149176.png" alt="image-20241124113149176" style="zoom:50%;">
<h3 id="lian-xi-1">ç»ƒä¹ </h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124113304642.png" alt="image-20241124113304642" style="zoom:50%;">
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	ldr r0,=0x12345678
	ldr r1,=0xFFFF0000
	bic r1,r0,r1
	mov r0,r0,lsr #16
	add r0,r0,r1
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	ldr r0,=0xabcd
	
	mov r1,#0x7
	bic r0,r1,lsl #1
	
	mov r1,#0x5
	orr r0,r1,lsl #1
	
	mov r1,#0x1f
	bic r0,r1,lsl #7
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="bi-jiao-zhi-ling-cmp">æ¯”è¾ƒæŒ‡ä»¤CMP</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124114532330.png" alt="image-20241124114532330" style="zoom:50%;">
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#5
	mov r1,#6
	mov r2,#10
	
	cmp r0,r1
	addgt r1,r1,#1
	
	cmp r0,r2
	addle r2,r2,#1
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124114808027.png" alt="image-20241124114808027" style="zoom: 50%;">
<h2 id="tiao-zhuan-zhi-ling">è·³è½¬æŒ‡ä»¤</h2>
<h3 id="b-bl">B/BL</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124125817106.png" alt="image-20241124125817106"></p>
<blockquote>
<p>Branch causes a branch to a target address.</p>
</blockquote>
<p>BæŒ‡ä»¤ç”¨äºè·³è½¬åˆ°ä¸€ä¸ªç›®æ ‡åœ°å€ï¼ˆæŒ‡ä»¤å­˜æ”¾åœ°å€ï¼‰ï¼Œè¯¥æŒ‡ä»¤ä¼šä¿®æ”¹PCçš„å€¼ï¼Œå°±åƒä»å¤„ç†å™¨çš„é¡ºåºæ‰§è¡Œè·¯å¾„å¼€äº†ä¸€ä¸ªåˆ†å²”ä¸€æ ·ï¼Œè®©å¤„ç†å™¨ä»æ—¢å®šçš„é¡ºåºæŒ‡ä»¤åºåˆ—è·³åˆ°äº†å¦ä¸€ä¸ªæŒ‡ä»¤åºåˆ—ã€‚å¸¸ç”¨äºå‡½æ•°è°ƒç”¨ã€ä¸­æ–­å¤„ç†ã€‚</p>
<p>BLæŒ‡ä»¤åœ¨BæŒ‡ä»¤çš„åŸºç¡€ä¹‹ä¸Šå¢åŠ äº†ä¸€ä¸ªæ“ä½œï¼šå°†è·³è½¬å‰PCçš„å€¼ä¿å­˜åˆ°LRå¯„å­˜å™¨ä¸­ã€‚è¿™æ ·å¦‚æœæƒ³ä»åˆ†å²”å›åˆ°åŸæ¥çš„è·¯å¾„ç»§ç»­æ‰§è¡Œï¼Œåªéœ€å°†LRä¼šå†™PCå³å¯ã€‚</p>
<h4 id="si-xun-huan-de-shi-xian">æ­»å¾ªç¯çš„å®ç°</h4>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1
	mov r1,#2
	b _start
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="han-shu-diao-yong">å‡½æ•°è°ƒç”¨</h4>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1
	mov r1,#2
	bl add
	
	mov r3,r2
	
stop:
	b _start
	
add:
	add r2,r0,r1
	mov pc,lr
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡å•æ­¥è°ƒè¯•è§‚å¯ŸPCçš„å˜åŒ–æˆ‘ä»¬å¯ä»¥å‘ç°æ¯æ¡æ±‡ç¼–æŒ‡ä»¤çš„åœ°å€æ˜¯æŒ‰ç…§ç¼–å†™é¡ºåºä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ç¼–å€çš„ï¼Œæ¯æ¡æŒ‡ä»¤åœ°å€ç›¸éš”4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå³åç§»é‡ä¸º0x4</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 @instruction address =&gt; 0x00000000
	mov r1,#2 @instruction address =&gt; 0x00000004
	bl add	  @instruction address =&gt; 0x00000008
	
	mov r3,r2 @instruction address =&gt; 0x0000000C
	
stop:
	b _start  @instruction address =&gt; 0x00000010
	
add:
	add r2,r0,r1 @instruction address =&gt; 0x00000014
	mov pc,lr    @instruction address =&gt; 0x00000018<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="gei-pc-fu-zhi">ç»™PCèµ‹å€¼</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124125452912.png" alt="image-20241124125452912"></p>
<p>B/BLæŒ‡ä»¤æœ‰ä¸ªé™åˆ¶ï¼šè·³è½¬çš„ç›®æ ‡åœ°å€å’Œå½“å‰PCä¸­çš„æŒ‡ä»¤åœ°å€ä¹‹é—´çš„åç§»é‡ä¸èƒ½è¶…è¿‡32Må¤§å°ã€‚å¦‚æœè¶…è¿‡äº†è¿™ä¸ªèŒƒå›´ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥èµ‹å€¼PCæ¥å®ç°è·³è½¬ã€‚</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 			
	mov r1,#2
	ldr pc,=add_label
back_label:
	mov r3,#10
	
stop:
	b stop

add_label:
	add r2,r0,r1
	ldr pc,=back_label
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­æ ‡ç­¾åå­—é¢é‡ï¼ˆ<code>add_label</code>ã€<code>back_label</code>ã€<code>stop</code>ï¼‰æœ¬è´¨ä¸Šå°±æ˜¯ç»™æ ‡ç­¾åå†’å·åçš„æŒ‡ä»¤åœ°å€å–äº†ä¸ªåˆ«åï¼Œå…¶å€¼å°±æ˜¯å†’å·åç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼›ä¸”æ ‡ç­¾å£°æ˜ä¸å±äºæŒ‡ä»¤ï¼Œä¹Ÿå°±ä¸å ç”¨å†…å­˜ç©ºé—´ï¼Œå› æ­¤ <code>ldr pc,=add_label</code>ç­‰ä»·äº <code>ldr pc,=0x00000014</code>ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 			@0x00000000
	mov r1,#2			@0x00000004
	ldr pc,=add_label	@0x00000008
back_label:
	mov r3,#10			@0x0000000C
	
stop:
	b stop				@0x00000010

add_label:
	add r2,r0,r1 		@0x00000014
	ldr pc,=back_label	@0x00000018
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="lian-xi-2">ç»ƒä¹ </h4>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124131659348.png" alt="image-20241124131659348" style="zoom:50%;">
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0		@sum=0
	mov r1,#1		@i=1
loop:
	cmp r1,#100
	bgt stop		@stop loop if r1 &gt; 100
	add r0,r0,r1	@sum+=i
	add r1,r1,#1	@i++
	b loop			@continue loop
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="dan-ge-shu-ju-fang-wen-yi-ci-xing-fang-wen-yi-ge-zi-kuan-shu-ju">å•ä¸ªæ•°æ®è®¿é—®ï¼ˆä¸€æ¬¡æ€§è®¿é—®ä¸€ä¸ªå­—å®½æ•°æ®ï¼‰</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124132933599.png" alt="image-20241124132933599" style="zoom:50%;">
<h3 id="ji-cun-qi-jian-jie-xun-zhi">å¯„å­˜å™¨é—´æ¥å¯»å€</h3>
<p><mark>LDR &lt;ç›®æ ‡å¯„å­˜å™¨&gt; [æºå¯„å­˜å™¨]</mark>ï¼šä»æºå¯„å­˜å™¨æŒ‡å®šçš„åœ°å€ä¸­åŠ è½½æ•°æ®åˆ°ç›®æ ‡å¯„å­˜å™¨</p>
<p><mark>LDR &lt;æºå¯„å­˜å™¨&gt; [ç›®æ ‡å¯„å­˜å™¨]</mark>ï¼šå°†æºå¯„å­˜å™¨ä¸­çš„æ•°æ®å­˜å‚¨åˆ°ç›®æ ‡å¯„å­˜å™¨æŒ‡å®šçš„å†…å­˜åœ°å€ä¸­</p>
<p>å¦‚ä¸‹ä»£ç å°†æ•°æ® <code>0x12345678</code> å†™ï¼ˆå­˜å‚¨ï¼‰åˆ°å†…å­˜åœ°å€ <code>0x40000000</code>ä¸­ï¼Œå¹¶ä»æ”¹åœ°å€è¯»ï¼ˆåŠ è½½ï¼‰æ•°æ®åˆ°R2å¯„å­˜å™¨ä¸­</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0]		@write 0x12345678 to memory address 0x40000000 =&gt; *r0 = r1
	ldr r2,[r0]		@read 0x12345678 from memory address 0x40000000 =&gt; r2 = *r0
	
	b stop
	
stop:
	b stop

	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç‚¹å‡»è°ƒè¯•åï¼Œéœ€è¦æ˜ å°„ä¸€ä¸‹å½“å‰ç¨‹åºå¯è®¿é—®çš„å†…å­˜ç©ºé—´ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124143904811.png" alt="image-20241124143904811" style="zoom: 50%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124143956075.png" alt="image-20241124143956075" style="zoom:50%;">
<blockquote>
<p>0x40000000,0x4000FFFF</p>
</blockquote>
<p>ç„¶åå¯ä»¥æ‰“å¼€å†…å­˜æŸ¥çœ‹çª—å£ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124144137121.png" alt="image-20241124144137121" style="zoom: 50%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124144919193.png" alt="image-20241124144919193" style="zoom: 33%;">
<p>ç„¶åæ­¥è¿›åˆ° <code>str r1,[r0]</code>æ‰§è¡Œä¹‹åï¼Œä¼šå‘ç°æ•°æ®å·²è¢«å†™å…¥å¯¹åº”çš„å†…å­˜ã€‚è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå­˜å‚¨æ–¹å¼æ˜¯å­—èŠ‚å°ç«¯æ³•ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124145026768.png" alt="image-20241124145026768"></p>
<p>å†è¿›ä¸€æ­¥ï¼Œæ•°æ®ä»å†…å­˜åŠ è½½åˆ°äº†R2å¯„å­˜å™¨ä¸­</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124145228766.png" alt="image-20241124145228766" style="zoom:50%;">
<h3 id="ji-di-zhi-bian-zhi-xun-zhi">åŸºåœ°å€å˜å€å¯»å€</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124150404357.png" alt="å‚è€ƒæ‰‹å†Œ A8.5 Memory accesses"></p>
<h4 id="pian-yi-liang-xun-zhi">åç§»é‡å¯»å€</h4>
<blockquote>
<p>Offset addressing<br>
The offset value is applied to an address obtained from the base register. The result is used as the<br>
address for the memory access. The value of the base register is unchanged.<br>
The assembly language syntax for this mode is:<br>
<code>[&lt;Rn&gt;, &lt;offset&gt;]</code></p>
</blockquote>
<p><code>LDR/STR [&lt;Rn&gt;, &lt;offset&gt;]</code>ï¼šRnä¸ºåŸºåœ°å€ï¼Œoffsetä¸ºåç§»å­—èŠ‚æ•°</p>
<p>ç±»æ¯”ç†è§£ï¼šCè¯­è¨€ä¸­é€šè¿‡æŒ‡é’ˆåŠ åç§»é‡æ¥è®¿é—®å†…å­˜ï¼ˆ<code>num = *(p+1)</code>ï¼‰ï¼Œè¯¥æ“ä½œä¸ä¼šæ”¹å˜æŒ‡é’ˆçš„å€¼ã€‚</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0, #4]		@ *(r0+4)=r1
	ldr r2,[r0, #4]		@ r2=*(r0+4)
	
	b stop
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ³¨æ„ï¼šæ¯æ¬¡ç‚¹å‡»debugååšä¸€ä¸‹å†…å­˜æ˜ å°„ï¼š</mark></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124150820281.png" alt="image-20241124150820281" style="zoom: 50%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124150924297.png" alt="image-20241124150924297" style="zoom:33%;">
<h4 id="qian-suo-yin-xun-zhi">å‰ç´¢å¼•å¯»å€</h4>
<blockquote>
<p>Pre-indexed addressing<br>
The offset value is applied to an address obtained from the base register. The result is used as the<br>
address for the memory access, and written back into the base register.<br>
The assembly language syntax for this mode is:<br>
<code>[&lt;Rn&gt;, &lt;offset&gt;]!</code></p>
</blockquote>
<p><code>LDR/STR [&lt;Rn&gt;, &lt;offset&gt;]!</code>ï¼šRnä¸ºåŸºåœ°å€ï¼Œoffsetä¸ºåç§»å­—èŠ‚æ•°ã€‚</p>
<p>è¯¥æŒ‡ä»¤åœ¨åç§»é‡å¯»å€çš„åŸºç¡€ä¸ŠåŠ äº†ä¸ª <mark>!</mark>ï¼Œæ ‡ç¤ºåœ¨å†…å­˜è®¿é—®ä¹‹åå°†è®¿é—®çš„åœ°å€å›å†™åŸºåœ°å€Rnã€‚</p>
<p>ç±»æ¯”ç†è§£ï¼š<code>num = *p++ =&gt; num = *p; p++;</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0, #4]!		@ *(r0+4)=r1 r0+=4
	ldr r2,[r0]		@ r2=*r0
	
	b stop
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124152950125.png" alt="image-20241124152950125"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124153051739.png" alt="image-20241124153051739"></p>
<h4 id="hou-suo-yin-xun-zhi">åç´¢å¼•å¯»å€</h4>
<blockquote>
<p>Post-indexed addressing<br>
The address obtained from the base register is used, unchanged, as the address for the memory<br>
access. The offset value is applied to the address, and written back into the base register<br>
The assembly language syntax for this mode is:<br>
<code>[&lt;Rn&gt;], &lt;offset&gt;</code></p>
</blockquote>
<p><code>LDR/STR [&lt;Rn&gt;], &lt;offset&gt;</code>ï¼šRnä¸ºåŸºåœ°å€ï¼Œoffsetä¸ºåç§»å­—èŠ‚æ•°ã€‚</p>
<p>è¯¥æŒ‡ä»¤å…ˆä»Rnè®¿é—®å†…å­˜ï¼Œç„¶åå†å°†åç§»é‡æ›´æ–°åˆ°Rnä¸­ã€‚</p>
<p>ç±»æ¯”ç†è§£ï¼š<code>num = *p; p += offset</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0],#4	@ *(r0)=r1 r0+=4
	
	sub r0,r0,#4	@ r0-=4
	ldr r2,[r0]		@ r2=*r0
	
	b stop
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124153832192.png" alt="image-20241124153832192"></p>
<h4 id="zong-jie">ğŸŒŸæ€»ç»“</h4>
<ul>
<li>åç§»é‡å¯»å€ï¼šå°±æ˜¯åœ¨ç»™å®šåœ°å€ä¸ŠåŠ å‡ä¸€ä¸ªåç§»é‡æ¥è®¿é—®å†…å­˜ï¼ˆrelativeï¼‰</li>
<li>å‰ç´¢å¼•ï¼šå…ˆå¯¹ç»™å®šåœ°å€å¢å‡åç§»é‡è¿›è¡Œæ›´æ–°ï¼Œå†è®¿é—®æ›´æ–°åçš„åœ°å€</li>
<li>åç´¢å¼•ï¼šå…ˆè®¿é—®ç»™å®šåœ°å€ï¼Œå†å¯¹ç»™å®šåœ°å€åŠ å‡åç§»é‡å¹¶æ›´æ–°</li>
</ul>
<h4 id="lian-xi-3">ç»ƒä¹ </h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124154157004.png" alt="image-20241124154157004"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 				@i=1
	mov r1,#0x40000000 		@p
	
	bl write_data
	
	mov r0,#1				@i=1
	mov r1,#0x40000000 		@p=&gt;0x40000000
	ldr r2,=0x40000100		@q=&gt;0x40000100
	mov r3,#0				@num=0

	bl read_data
	
stop:
	b stop
	
write_data:
	str r0,[r1],#4 			@*p++=i
	add r0,r0,#1			@i++
	cmp r0,#10
	ble write_data 			@while(i&lt;=10)
	
	mov pc,lr				@return
	
read_data:
	ldr r3,[r1],#4			@num=*p++
	str r3,[r2],#4			@*q++=num
	add r0,r0,#1			@i++
	cmp r0,#10
	ble read_data			@while(i&lt;=10)
	
	mov pc,lr				@return
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124160123984.png" alt="image-20241124160123984"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124160205062.png" alt="image-20241124160205062"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	ldr r0,=0x1234
	ldr r1,=0x40000000 		@p=0x40000000
	str r0,[r1],#4			@*p++=0x1234
	
	ldr r0,=0xabcd
	str r0,[r1],#-4			@*p=0xabcd, p-=4
	
	ldr r2,[r1],#4			@num1=*p++
	ldr r3,[r1]				@num2=*p
	add r0,r2,r3			@sum=num1+num2
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="duo-ge-shu-ju-fang-wen">å¤šä¸ªæ•°æ®è®¿é—®</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124162052165.png" alt="image-20241124162052165" style="zoom:50%;">
<h3 id="zhi-ling-mo-shi">æŒ‡ä»¤æ¨¡å¼</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124162139880.png" alt="image-20241124162139880" style="zoom:50%;">
<p>ä»¥STMï¼ˆStore Multipleï¼Œå†™å¤šä¸ªæ•°æ®ä¸ºä¾‹ï¼ŒLDMæ˜¯ç±»ä¼¼çš„ï¼‰ï¼š</p>
<ul>
<li>STMIAï¼šIncrease Afterï¼Œå…ˆå‘åŸºåœ°å€å†™å…¥æ•°æ®ï¼Œç„¶åé€’å¢åŸºåœ°å€</li>
<li>STMIBï¼šIncrease Beforeï¼Œå…ˆé€’å¢åŸºåœ°å€ï¼Œå†å‘åŸºåœ°å€å†™å…¥æ•°æ®</li>
<li>STMDAï¼šDecrease Afterï¼Œå…ˆå‘åŸºåœ°å€å†™å…¥æ•°æ®ï¼Œç„¶åé€’å‡åŸºåœ°å€</li>
<li>STMDBï¼šDecrease Beforeï¼Œå…ˆé€’å‡åŸºåœ°å€ï¼Œå†å‘åŸºåœ°å€å†™å…¥æ•°æ®</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000			@p=0x40000000
	mov r1,#0x11				@buf[3] = {0x11,0x22,0x33}
	mov r2,#0x22
	mov r3,#0x33
	
	stmia r0!,{r1-r3} 			@*p++=buf[i]
	
stop:
	b stop
	
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124163643693.png" alt="image-20241124163643693"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000			@p=0x40000000
	mov r1,#0x11				@buf[3] = {0x11,0x22,0x33}
	mov r2,#0x22
	mov r3,#0x33
	
	stmia r0!,{r1-r3} 			@*p++=buf[i++]
	
	ldmdb r0!,{r4-r6}			@buf2[i++]=*--p
	
stop:
	b stop
	
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124163945572.png" alt="image-20241124163945572"></p>
<h2 id="zhan-cao-zuo-zhi-ling">æ ˆæ“ä½œæŒ‡ä»¤</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124164247925.png" alt="image-20241124164247925"></p>
<h3 id="zhan-zeng-chang-mo-shi">æ ˆå¢é•¿æ¨¡å¼</h3>
<p><mark>è‡ªåº•å‘ä¸Šï¼šæ ˆé¡¶æŒ‡é’ˆéšç€å…¥æ ˆè€Œé€’å¢ï¼ˆåœ°å€ï¼‰ï¼›è‡ªé¡¶å‘ä¸‹ï¼šæ ˆé¡¶æŒ‡é’ˆéšç€å…¥æ ˆè€Œé€’å‡</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124164335289.png" alt="image-20241124164335289"></p>
<h3 id="kong-dui-zhan-he-man-dui-zhan">ç©ºå †æ ˆå’Œæ»¡å †æ ˆ</h3>
<p><mark>å…¶å®å°±æ˜¯æ ˆé¡¶æŒ‡é’ˆæŒ‡å‘æ ˆé¡¶å…ƒç´ ï¼ˆæ»¡å †æ ˆï¼‰è¿˜æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå…¥æ ˆå…ƒç´ è¦å­˜æ”¾çš„ä½ç½®ï¼ˆç©ºå †æ ˆï¼‰</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124164412290.png" alt="image-20241124164412290"></p>
<h3 id="shi-li-ya-zhan-bao-cun-chu-zhan-hui-fu">ç¤ºä¾‹ï¼šå‹æ ˆä¿å­˜ï¼Œå‡ºæ ˆæ¢å¤</h3>
<blockquote>
<p>åœ¨ç¨‹åºä¸Šä¸‹æ–‡å‘ç”Ÿåˆ‡æ¢æ—¶ï¼ˆä¾‹å¦‚å‡½æ•°è°ƒç”¨ã€ä¸­æ–­å¤„ç†ï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å…ˆå°†å…ˆå‰ç¨‹åºæ‰§è¡ŒçŠ¶æ€ç›¸å…³çš„ä¿¡æ¯è¿›è¡Œä¿å­˜ï¼Œç„¶ååœ¨è¿”å›æ—¶è¿›è¡Œæ¢å¤ã€‚</p>
</blockquote>
<p>å¦‚ä¸‹ç¨‹åºä»¥é€šç”¨å¯„å­˜å™¨çš„æš‚å­˜å’Œæ¢å¤ä¸ºä¾‹æ¥æ¨¡æ‹Ÿè¿™ä¸€è¿‡ç¨‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#0x11				
	mov r2,#0x22
	mov r3,#0x33
	
	@first: set stack pointer(start address of stack, from high address to low)
	ldr sp,=0x4000fff0		
	@push to save general purpose registers and decrease stack pointer
	stmfd sp!,{r1-r3}		
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124170153676.png" alt="image-20241124170153676"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#0x11				
	mov r2,#0x22
	mov r3,#0x33
	
	@first: set stack pointer(start address of stack, from high address to low)
	ldr sp,=0x4000fff0		
	@push to save general purpose registers and decrease stack pointer
	stmfd sp!,{r1-r3}		
	
	@do something with general purpose registers
	mov r1,#0x00				
	mov r2,#0x00
	mov r3,#0x00
	
	@pop stack to recover general purpose registers
	ldmfd sp!,{r1-r3}
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124170518808.png" alt="image-20241124170518808"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124170639885.png" alt="image-20241124170639885"></p>
<h2 id="cpsr-spsr-cao-zuo-zhi-ling">CPSR/SPSRæ“ä½œæŒ‡ä»¤</h2>
<h3 id="mrs-move-to-register-from-special-register">MRSï¼ˆMove to Register from Special registerï¼‰</h3>
<blockquote>
<p>Move to Register from Special register moves the value from the CPSR or SPSR of the current mode into an ARM<br>
core register.<br>
An MRS that accesses the SPSR is UNPREDICTABLE if executed in User or System mode.<br>
An MRS that is executed in User mode and accesses the CPSR returns an UNKNOWN value for the<br>
CPSR.{E, A, I, F, M} fields.</p>
</blockquote>
<p><code>MRS{&lt;c&gt;}{&lt;q&gt;} &lt;Rd&gt;, &lt;spec_reg&gt;  </code></p>
<h3 id="msr-move-register-immediate-to-special-register">MSRï¼ˆMove register/immediate to Special Registerï¼‰</h3>
<blockquote>
<p>Move to Special register from ARM core register moves the value of an ARM core register to the CPSR or the SPSR of the current mode.</p>
</blockquote>
<p><code>MSR&lt;c&gt; &lt;spec_reg&gt;, #&lt;const&gt;  </code></p>
<p><code>MSR{&lt;c&gt;}{&lt;q&gt;} &lt;spec_reg&gt;, &lt;Rn&gt;  </code></p>
<h3 id="zong-jie-1">ğŸŒŸæ€»ç»“</h3>
<p><mark>MRSã€MSRåˆ†è¾¨</mark>ï¼š</p>
<ul>
<li>Råœ¨å‰é¢ï¼Œåˆ™æ“ä½œæ•°1ä¸ºé€šç”¨å¯„å­˜å™¨ï¼ˆè¦å°†CPSRè¯»åˆ°Rdï¼‰ï¼›</li>
<li>Såœ¨å‰é¢ï¼Œæ“ä½œæ•°ä¸ºç‰¹æ®Šå¯„å­˜å™¨ï¼ˆè¦å°†é€šç”¨å¯„å­˜å™¨å†™åˆ°CPSRï¼‰</li>
</ul>
<h3 id="lian-xi-4">ç»ƒä¹ </h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124171837704.png" alt="image-20241124171837704"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mrs r0,cpsr 		@move to r0 from cpsr
	mov r1,#1
	bic r0,r1,lsl #7	@bit clear bit7 of cpsr
	msr cpsr,r0			@write back to cpsr
	
	b stop
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124172405608.png" alt="image-20241124172405608"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mrs r0,cpsr 		@move to r0 from cpsr
	mov r1,#1
	bic r0,r1,lsl #7	@bit clear bit7 of cpsr
	msr cpsr,r0			@write back to cpsr
	
	mrs r0,cpsr
	orr r0,r1, lsl #7	@set bit7 of cpsr
	msr cpsr,r0			@write back to cpsr
	
	b stop
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">The END</h1>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>æŒ‡ä»¤é›†</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆä¸€ï¼‰å·¥ä½œæ¨¡å¼åŠå¯„å­˜å™¨èµ„æº</title>
    <url>/2024/11/23/1780.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/ddi0406/latest/">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
<h1 id="arm-he-ar-mv-7-a-r-gong-zuo-mo-shi">ARMæ ¸ï¼ˆARMv7-A/Rï¼‰å·¥ä½œæ¨¡å¼</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123192806705.png" alt="Table B1-1 ARM processor modes  "></p>
<ul>
<li>
<p>ä»å¼‚å¸¸æ¨¡å¼æ¥çœ‹ï¼Œåªæœ‰ User å’Œ System æ˜¯éå¼‚å¸¸æ¨¡å¼ï¼›</p>
</li>
<li>
<p>ä»ç‰¹æƒçº§åˆ«æ¥çœ‹ï¼Œåªæœ‰ User æ˜¯éç‰¹æƒçº§åˆ«ï¼›</p>
</li>
</ul>
<h2 id="privilege-level">Privilege Level</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123192948933.png" alt="Privilege Level"></p>
<h2 id="arm-processor-modes">ARM Processor Modes</h2>
<h3 id="user-mode">User mode</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123193912894.png" alt="image-20241123193912894"></p>
<ul>
<li>æ“ä½œç³»ç»Ÿé€šè¿‡åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œå¼•ç”¨ç¨‹åºæ¥é™åˆ¶å…¶å¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—®ï¼Œä¾‹å¦‚æ–‡ä»¶ã€è¿›ç¨‹ç­‰ã€‚</li>
<li>ç”¨æˆ·æ¨¡å¼ä¸‹çš„ä»»ä½•åº”ç”¨ç¨‹åºä¸èƒ½åˆ‡æ¢æ¨¡å¼ï¼Œé™¤éé€šè¿‡è½¯ä¸­æ–­æˆ–å¼‚å¸¸ã€‚</li>
</ul>
<h3 id="system-mode">System mode</h3>
<blockquote>
<p>Software executing in System mode executes at PL1. System mode has the same registers available</p>
<p>as User mode, and is not entered by any exception</p>
</blockquote>
<p>åœ¨ç³»ç»Ÿæ¨¡å¼ä¸‹è¿è¡Œçš„è½¯ä»¶æ‹¥æœ‰PL1çš„ç‰¹æƒï¼Œèƒ½å¤Ÿè®¿é—®ä¸€äº›å—æ§èµ„æºã€‚ç³»ç»Ÿæ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼å…±ç”¨åŒä¸€å¥—å¯ç”¨çš„å¯„å­˜å™¨ï¼Œå¹¶ä¸”æ— æ³•é€šè¿‡ä»»ä½•å¼‚å¸¸æ¥è¿›å…¥è¯¥æ¨¡å¼ã€‚</p>
<h3 id="supervisor-mode">Supervisor mode</h3>
<blockquote>
<p>Supervisor mode is the default mode to which a Supervisor Call exception is taken.<br>
Executing a SVC (Supervisor Call) instruction generates an Supervisor Call exception, that is taken<br>
to Supervisor mode.<br>
A processor enters Supervisor mode on Reset.</p>
</blockquote>
<p>ç®¡ç†æ¨¡å¼æ˜¯CPUä¸Šç”µåé»˜è®¤çš„æ¨¡å¼ï¼Œå› æ­¤åœ¨è¯¥æ¨¡å¼ä¸‹ä¸»è¦ç”¨æ¥åšç³»ç»Ÿçš„åˆå§‹åŒ–ï¼Œè½¯ä¸­æ–­å¤„ç†ä¹Ÿåœ¨è¯¥æ¨¡å¼ä¸‹ã€‚</p>
<p>å½“ç”¨æˆ·æ¨¡å¼ä¸‹çš„ç”¨æˆ·ç¨‹åºè¯·æ±‚ä½¿ç”¨ç¡¬ä»¶èµ„æºæ—¶ï¼Œé€šè¿‡è½¯ä»¶ä¸­æ–­è¿›å…¥è¯¥æ¨¡å¼ã€‚</p>
<h3 id="abort-mode">Abort mode</h3>
<blockquote>
<p>Abort mode is the default mode to which a Data Abort exception or Prefetch Abort exception is<br>
taken</p>
</blockquote>
<p>ç»ˆæ­¢æ¨¡å¼æ˜¯æ•°æ®ç»ˆæ­¢å¼‚å¸¸æˆ–æŒ‡ä»¤é¢„å–ç»ˆæ­¢å¼‚å¸¸å‘ç”Ÿæ—¶é»˜è®¤è¿›å…¥çš„æ¨¡å¼ã€‚</p>
<p>æ•°æ®ç»ˆæ­¢å¼‚å¸¸ï¼šå½“ç”¨æˆ·ç¨‹åºè®¿é—®éæ³•åœ°å€ã€æ²¡æœ‰æƒé™è¯»å–çš„åœ°å€æ—¶ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚ä¾‹å¦‚linuxä¸‹ç¼–ç¨‹æ—¶ç»å¸¸é‡åˆ°çš„<code>segment fault</code>ï¼š</p>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/%E8%A8%98%E6%86%B6%E9%AB%94%E5%8D%80%E6%AE%B5%E9%8C%AF%E8%AA%A4">ä»¥ä¸‹æ˜¯ä¸€äº›å¯¼è‡´å‚¨å­˜å™¨æ®µé”™è¯¯çš„ä¸€èˆ¬ç¼–ç¨‹é”™è¯¯</a>ï¼š</p>
<ul>
<li>å¼•ç”¨ç©ºæŒ‡é’ˆ</li>
<li>å¼•ç”¨æœªåˆå§‹åŒ–çš„é‡æŒ‡é’ˆ</li>
<li>å¼•ç”¨å·²ç»è¢«è°ƒç”¨free()å‡½æ•°é‡Šæ”¾äº†çš„æ‚¬ç©ºæŒ‡é’ˆ</li>
<li>ç¼“å†²åŒºæº¢å‡º</li>
<li>å †æ ˆæº¢å‡º</li>
<li>è¿è¡Œæœªæ­£ç¡®ç¼–è¯‘çš„ç¨‹åºï¼ˆå°½ç®¡å­˜åœ¨ç¼–è¯‘æ—¶é”™è¯¯ï¼ŒæŸäº›ç¼–è¯‘å™¨ä¾ç„¶ä¼šè¾“å‡ºå¯æ‰§è¡Œæ–‡ä»¶ï¼‰</li>
</ul>
</blockquote>
<p>é¢„å–æŒ‡ä»¤å¼‚å¸¸ï¼šé¢„å–æŒ‡ä»¤æ˜¯æŒ‡ä»¤æµæ°´çº¿ä¸­çš„æ¦‚å¿µã€‚è¯¥å¼‚å¸¸å‘ç”Ÿåœ¨é¢„å–æŒ‡ä»¤æ—¶æ— æ³•è·å–åˆ°æ­£ç¡®çš„å¯æ‰§è¡ŒæŒ‡ä»¤ï¼Œæˆ‘ä»¬æœ‰æ—¶è¿è¡Œé”™è¯¯ä»£ç ä¼šå‡ºç°ç¨‹åºè·‘é£äº†çš„æƒ…å†µå°±æ˜¯å› ä¸ºé¢„å–ä¸åˆ°æ­£ç¡®çš„æŒ‡ä»¤äº†ï¼ŒCPUæ— æ³•ç»§ç»­æ­£å¸¸æ‰§è¡Œã€‚</p>
<h3 id="undefined-mode">Undefined mode</h3>
<blockquote>
<p>Undefined mode is the default mode to which an instruction-related exception, including any<br>
attempt to execute an UNDEFINED instruction, is taken</p>
</blockquote>
<p>å½“CPUé‡åˆ°ä¸€ä¸ªå®ƒæ— æ³•è¯†åˆ«çš„æŒ‡ä»¤æ—¶å‘ç”Ÿè¯¥å¼‚å¸¸ã€‚ä¾‹å¦‚åœ¨ARMæ¶æ„çš„CPUä¸Šæ‰§è¡Œä¸€æ¡IntelæŒ‡ä»¤ã€‚</p>
<h3 id="fiq-mode">FIQ mode</h3>
<blockquote>
<p>FIQ mode is the default mode to which an FIQ interrupt is taken.</p>
</blockquote>
<p>FIQæ˜¯Fast Interrupt reQuetstï¼Œå¿«é€Ÿä¸­æ–­æ¨¡å¼ã€‚å¿«é€Ÿæ˜¯ç›¸å½“äºä¸€èˆ¬ä¸­æ–­æ¨¡å¼ï¼ˆIRQï¼‰è€Œè¨€çš„ï¼Œç”¨æ¥å¤„ç†å¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒç´§æ€¥çš„ä¸­æ–­ï¼Œä¸»è¦ç”¨äºé«˜é€Ÿæ•°æ®ä¼ è¾“åŠé€šé“å¤„ç†ä¸­ã€‚</p>
<h3 id="irq-mode">IRQ mode</h3>
<p>ä¸€èˆ¬ä¸­æ–­æ¨¡å¼ï¼Œä¹Ÿç§°æ™®é€šä¸­æ–­æ¨¡å¼ï¼Œç”¨äºå¤„ç†ä¸€èˆ¬çš„ä¸­æ–­è¯·æ±‚ã€‚é€šå¸¸åœ¨ç¡¬ä»¶ä¸­æ–­å‘ç”Ÿåè‡ªåŠ¨è¿›å…¥è¯¥æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸ºç‰¹æƒæ¨¡å¼ï¼Œèƒ½å¤Ÿè‡ªç”±è®¿é—®ç³»ç»Ÿç¡¬ä»¶èµ„æºã€‚</p>
<h1 id="arm-he-ji-cun-qi-zi-yuan">ARMæ ¸å¯„å­˜å™¨èµ„æº</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123201917744.png" alt="image-20241123201917744"></p>
<h2 id="gai-lan">æ¦‚è§ˆ</h2>
<h3 id="ji-cun-qi-gong-xiang">å¯„å­˜å™¨å…±äº«</h3>
<p>R0~R7è¿™å‡ ä¸ªå¯„å­˜å™¨æ˜¯æ‰€æœ‰æ¨¡å¼å…±äº«çš„ï¼Œè¿™æ„å‘³ç€åœ¨æ¨¡å¼å‘ç”Ÿåˆ‡æ¢æ—¶ï¼Œä¸ºäº†ä¸å½±å“å…ˆå‰æ¨¡å¼çš„å¯„å­˜å™¨æ•°æ®ï¼Œå½“å‰æ¨¡å¼éœ€è¦åœ¨ä½¿ç”¨è¿™äº›å¯„å­˜å™¨ä¹‹å‰å…ˆå°†å®ƒä»¬å‹æ ˆï¼ˆå†…å­˜åŒºåŸŸä¸­çš„æ ˆï¼‰ä¿å­˜ï¼Œå¹¶åœ¨æ¨¡å¼é€€å‡ºæ—¶å‡ºæ ˆä»¥å°†å¯„å­˜å™¨æ¢å¤æˆåŸæ ·ã€‚</p>
<p>åŒæ ·çš„R8~R12æ˜¯é™¤äº†FIQçš„æ‰€æœ‰æ¨¡å¼å…±äº«çš„ã€‚</p>
<h3 id="ji-cun-qi-du-you">å¯„å­˜å™¨ç‹¬æœ‰</h3>
<p>å¯¹äºR8~R12ï¼ŒFIQç”±è‡ªå·±ç‹¬æœ‰çš„å¯„å­˜å™¨ï¼Œè¿™æ˜¯ä¸ºäº†æé«˜è¯¥æ¨¡å¼çš„å¤„ç†æ•ˆç‡ï¼šåœ¨è¿›å…¥è¯¥æ¨¡å¼åï¼Œè®¿é—®è¿™å‡ ä¸ªå¯„å­˜å™¨æ— éœ€å‹æ ˆä¿æŠ¤å’Œå‡ºæ ˆå¤åŸã€‚<mark>è¿™ä¹Ÿæ˜¯FIQæ¯”IRQå¿«çš„åŸå› ä¹‹ä¸€ã€‚</mark></p>
<h3 id="yi-chang-mo-shi-ji-cun-qi">å¼‚å¸¸æ¨¡å¼å¯„å­˜å™¨</h3>
<p>å¯ä»¥å‘ç°ï¼Œå¯¹äºSPå’ŒLRå¯„å­˜å™¨ï¼Œé™¤äº†Userå’ŒSystemä¸¤ä¸ªéå¼‚å¸¸æ¨¡å¼ï¼Œå…¶ä»–æ¨¡å¼éƒ½å¯¹åº”æœ‰è‡ªå·±ç‹¬ç«‹çš„ã€‚å®ƒä»¬ä¸å¼‚å¸¸è·³è½¬æœ‰å…³ã€‚</p>
<h3 id="pc-ji-cun-qi">PCå¯„å­˜å™¨</h3>
<p>PCï¼ˆProgram Counterï¼‰ç¨‹åºè®¡æ•°å™¨ç”¨æ¥æŒ‡å‘æŒ‡ä»¤åœ°å€ï¼Œåœ¨32ä½CPUé¡ºåºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤ç›¸éš”4ä¸ªå­—èŠ‚ï¼Œåœ°å€ç›¸éš”0x4ï¼Œé€šè¿‡å°†PCçš„å€¼ä¾æ¬¡é€’å¢0x4å°±èƒ½å®ç°é¡ºåºæ‰§è¡Œçš„æ•ˆæœã€‚</p>
<p>ä½†æ˜¯å‘ç”Ÿæ¨¡å¼åˆ‡æ¢æ—¶ï¼Œéœ€è¦ä¿®æ”¹PCçš„å€¼ä»¥å‘Šè¯‰CPUä»å“ªé‡Œå¼€å§‹æ¥ç€æ‰§è¡Œç¨‹åºæŒ‡ä»¤ã€‚</p>
<h3 id="cpsr-spsr">CPSR/SPSR</h3>
<p>Current Program Status Registerï¼Œå½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼Œå…¶ä¸­åŒ…å«äº†å½“å‰ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€äº›çŠ¶æ€ä½ï¼Œä¾‹å¦‚</p>
<ul>
<li>Nï¼šnegtiveï¼Œè´Ÿæ•°æ ‡å¿—ï¼Œä¾‹å¦‚æ¯”è¾ƒæŒ‡ä»¤ <code>cmp</code> å°±æ˜¯å°†ä¸€ä¸ªæ•°å‡å»å¦ä¸€ä¸ªæ•°ï¼Œå¦‚æœç»“æœä¸ºè´Ÿï¼Œåˆ™å°†Nä½ç½®1ï¼Œåç»­æŒ‡ä»¤å¯ä»¥é€šè¿‡å¢åŠ æ¡ä»¶åç¼€ <code>lt</code>ã€<code>le</code>ï¼ˆless thanã€less than or equals toï¼‰ç»“åˆNæ ‡å¿—ä½æ¥å®ç°ç±»ä¼¼ <code>if</code>æ¡ä»¶çš„æ•ˆæœ</li>
<li>Cï¼šcarryï¼Œè¿›ä½æ ‡å¿—</li>
</ul>
<p>å¯ä»¥ç†è§£è¿™ä¸ªå¯„å­˜å™¨ä¿å­˜äº†å½“å‰ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<p>Saved Program Status Registerï¼Œæš‚å­˜çš„ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ã€‚å½“å‘ç”Ÿæ¨¡å¼åˆ‡æ¢æ—¶ï¼Œåº”é€šè¿‡SPSRä¿å­˜CPSRï¼ˆä¹‹å‰çš„ç¨‹åºè¿è¡ŒçŠ¶æ€ï¼‰ï¼Œå¹¶åœ¨è¿”å›æ—¶å°†SPSRä¼šå†™åˆ°CPSRã€‚</p>
<h2 id="ji-cun-qi-yong-tu-fen-xi">å¯„å­˜å™¨ç”¨é€”åˆ†æ</h2>
<h3 id="tong-yong-ji-cun-qi-r-0-10">é€šç”¨å¯„å­˜å™¨R0~10</h3>
<p>ç”¨æ¥å­˜æ”¾ç”¨æˆ·çš„æ•°æ®ï¼Œä¾‹å¦‚å‡½æ•°å…¥å‚ã€å‡½æ•°è¿”å›å€¼ç­‰</p>
<h3 id="zhan-xiang-guan-ji-cun-qi">æ ˆç›¸å…³å¯„å­˜å™¨</h3>
<ul>
<li>
<p>R11ï¼ˆfp: frame pointerï¼‰ï¼šç”¨æ¥è®°å½•ä¸€ä¸ªæ ˆç©ºé—´çš„å¼€å§‹åœ°å€</p>
</li>
<li>
<p>R12ï¼ˆipï¼šThe Intra-Procedure-call scratch registerï¼‰ç”¨æ¥ä¸´æ—¶å­˜å‚¨sp</p>
</li>
<li>
<p>R13ï¼ˆspï¼šstack pointerï¼‰ï¼šæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆæŒ‡å‘æ ˆé¡¶ï¼‰ï¼Œå‹æ ˆæ—¶æ ¹æ®è¯¥å¯„å­˜å™¨ä¸­çš„åœ°å€å­˜æ”¾æ•°æ®å¹¶æ›´æ–°æ ˆæŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªä½ç½®</p>
</li>
</ul>
<p><mark>æ ˆç©ºé—´çš„è®¡ç®—ï¼šsp - fp</mark></p>
<h3 id="tiao-zhuan-xiang-guan-branch-ji-cun-qi">è·³è½¬ç›¸å…³ï¼ˆbranchï¼‰å¯„å­˜å™¨</h3>
<ul>
<li>R14ï¼ˆlrï¼Œlink registerï¼‰ï¼šåœ¨å‘ç”Ÿè·³è½¬ï¼ˆå‡½æ•°è°ƒç”¨ï¼Œä¸­æ–­å¤„ç†ï¼‰æ—¶ï¼Œç”¨æ¥ä¿å­˜PCå¯„å­˜å™¨çš„å€¼ã€‚åé¢é€šè¿‡å°†lrä¼šå†™PCå³å¯å®ç°è·³è½¬åçš„è¿”å›ã€‚</li>
</ul>
<h3 id="pc-ji-cun-qi-1">PCå¯„å­˜å™¨</h3>
<p>program counterï¼šç”¨æ¥å­˜æ”¾CPUéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚</p>
<p>ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸ºcounterè®¡æ•°å™¨ï¼Œæ˜¯å› ä¸ºæŒ‡ä»¤å®½åº¦æ˜¯å›ºå®šçš„ï¼ˆä¾‹å¦‚ARMv7ä¸­æ˜¯32ä½å­—å®½ï¼‰ï¼Œé€šè¿‡åœ¨å½“å‰æŒ‡ä»¤çš„åœ°å€ä¸Šåç§»å›ºå®šçš„æŒ‡ä»¤ä½å®½ï¼ˆä¾‹å¦‚4ä¸ªå­—èŠ‚+0x4ï¼‰å°±èƒ½å–åˆ°é¡ºåºçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>
<h2 id="cpsr-cheng-xu-zhuang-tai-ji-cun-qi">CPSRï¼ˆç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124085427517.png" alt="image-20241124085427517"></p>
<h3 id="tiao-jian-biao-zhi-wei-ke-bei-xu-duo-zhi-ling-she-zhi">æ¡ä»¶æ ‡å¿—ä½ï¼ˆå¯è¢«è®¸å¤šæŒ‡ä»¤è®¾ç½®ï¼‰</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123230843319.png" alt="image-20241123230843319"></p>
<h3 id="n-fu-hao-tiao-jian-biao-zhi-wei">N-è´Ÿå·æ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Negative condition flag. Set to bit[31] of the result of the instruction. If the result is<br>
regarded as a twoâ€™s complement signed integer, then the processor sets N to 1 if the result<br>
is negative, and sets N to 0 if it is positive or zero.</p>
</blockquote>
<p>å½“æŒ‡ä»¤çš„ç»“æœä¸ºæœ‰ç¬¦å·æ•´æ•°æ—¶ï¼Œå¤„ç†å™¨ä¼šåœ¨è¯¥ç»“æœä¸ºè´Ÿæ•°æ—¶å°†Nç½®1ã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰æ—¶éœ€è¦æ ¹æ®æ¡ä»¶æ¥è·³è½¬ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">&gt;=</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”æŒ‡ä»¤ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov r0,a // å°†aåŠ è½½åˆ°r0å¯„å­˜å™¨
mov r1,b // å°†båŠ è½½åˆ°r1å¯„å­˜å™¨
cmp r0,r1 // é€šè¿‡r0-r1æ¥æ¯”è¾ƒä¸¤è€…çš„å€¼ï¼Œå¦‚æœç»“æœä¸ºè´Ÿæ•°åˆ™å°†Nç½®1ï¼Œå¦åˆ™ç½®0
bgt foo // bï¼šbranchåˆ†æ”¯è·³è½¬ gtï¼šgreater thanï¼Œå¦‚æœN=0ï¼ˆa&gt;=bï¼‰ï¼Œåˆ™è·³è½¬åˆ°fooå‡½æ•°å…¥å£åœ°å€
ble fun // leï¼šless than or equals toï¼Œå¦‚æœN=1ï¼ˆa&lt;bï¼‰ï¼Œåˆ™è·³è½¬åˆ°funå‡½æ•°å…¥å£åœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="z-ling-tiao-jian-biao-zhi-wei">Z-é›¶æ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Zero condition flag. Set to 1 if the result of the instruction is zero, and to 0 otherwise. A<br>
result of zero often indicates an equal result from a comparison</p>
</blockquote>
<p>å½“æŒ‡ä»¤ç»“æœä¸º0æ—¶ä¼šå°†Zç½®1ã€‚Zä½ä¸º1é€šå¸¸æ ‡ç¤ºäº†ä¸€ä¸ªç»“æœä¸º0çš„æ¯”è¾ƒæŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”æŒ‡ä»¤ ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov r0,a
mov r1,b
cmp r0,r1 // é€šè¿‡r0-r1æ¥æ¯”è¾ƒä¸¤è€…çš„å€¼ï¼Œå¦‚æœç»“æœä¸º0åˆ™å°†Zç½®1ï¼ˆå½“ç„¶ä¹Ÿä¼šå°†Nç½®0ï¼‰
beq foo // bï¼šbranchåˆ†æ”¯è·³è½¬ eqï¼šequals toï¼Œå¦‚æœZ=1ï¼Œåˆ™è·³è½¬fooå‡½æ•°å…¥å£åœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="c-jin-wei-tiao-jian-biao-zhi-wei">C-è¿›ä½æ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Carry condition flag. Set to 1 if the instruction results in a carry condition, for example an<br>
unsigned overflow on an addition.</p>
</blockquote>
<p>å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿäº†è¿›ä½ï¼Œåˆ™Cä½ä¼šè¢«ç½®1ã€‚ä¾‹å¦‚åŠ æ³•è¿‡ç¨‹ä¸­çš„æ— ç¬¦å·æº¢å‡ºã€‚ä»¥ <code>uint32_t</code>ä¸ºä¾‹ï¼Œæœ€å¤§ä¸º <code>0xFFFFFFFF</code>ï¼Œå¦‚æœå¯¹å…¶è¿›è¡ŒåŠ æ³•æ“ä½œåˆ™ä¼šäº§ç”Ÿè¿›ä½ï¼Œä¾‹å¦‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint32_t</span> a <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// äº§ç”Ÿè¿›ä½ï¼ŒCè¢«ç½®1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="v-yi-chu-tiao-jian-biao-zhi-wei">V-æº¢å‡ºæ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Overflow condition flag. Set to 1 if the instruction results in an overflow condition, for<br>
example a signed overflow on an addition</p>
</blockquote>
<p>å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿäº†æº¢å‡ºï¼ˆ<mark>è¶…è¿‡äº†æ•°æ®ç±»å‹çš„è¡¨ç¤ºèŒƒå›´</mark>ï¼‰ï¼Œä¾‹å¦‚åŠ æ³•ä¸­çš„æœ‰ç¬¦å·æº¢å‡ºï¼Œåˆ™ä¼šå°†è¯¥ä½ç½®1ã€‚è¿™é‡Œè¦å’ŒCä½åŒºåˆ†å¼€æ¥ï¼ŒCä½æ˜¯é’ˆå¯¹æ— ç¬¦å·çš„ï¼ˆè¿ç®—ä¸è€ƒè™‘ç¬¦å·ä½ï¼‰ï¼ŒVæ˜¯é’ˆå¯¹æœ‰ç¬¦å·çš„ã€‚ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">signed</span> <span class="token keyword">char</span> ch <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>
<span class="token keyword">signed</span> <span class="token keyword">char</span> tmp <span class="token operator">=</span> ch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// æœ‰ç¬¦å·charæœ€å¤§å€¼ä¸º127ï¼ŒåŠ 1åä¸º128è¶…è¿‡äº†charçš„æ ‡ç¤ºèŒƒå›´ï¼ˆ-128~127ï¼‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="i-f-jin-yong-biao-zhi-wei">I/F-ç¦ç”¨æ ‡å¿—ä½</h3>
<p>Iä½ç½®1æ ‡ç¤ºç¦ç”¨IRQå¼‚å¸¸ï¼ŒFä½ç½®1æ ‡ç¤ºç¦ç”¨FIQå¼‚å¸¸</p>
<blockquote>
<p>In an implementation that does not include the Security Extensions, setting a mask bit masks the<br>
corresponding exception, meaning it cannot be taken</p>
</blockquote>
<h3 id="t-biao-zhi-wei">Tæ ‡å¿—ä½</h3>
<p>æ ‡ç¤ºäº†å¤„ç†å™¨æŒ‡ä»¤é›†çš„çŠ¶æ€ï¼š</p>
<ul>
<li>ARMçŠ¶æ€ï¼š32ä½æŒ‡ä»¤</li>
<li>ThumbçŠ¶æ€ï¼š16ä½æŒ‡ä»¤ï¼ˆå¯ä»¥ç†è§£ä½ARMæŒ‡ä»¤çš„å‹ç¼©ç‰ˆï¼‰</li>
</ul>
<h3 id="m-biao-zhi-wei">Mæ ‡å¿—ä½</h3>
<p>æ ‡ç¤ºå¤„ç†å™¨å½“å‰çš„å·¥ä½œæ¨¡å¼ï¼Œå‚è§æœ¬æ–‡ <mark>ARM&nbsp;Processor&nbsp;Modes</mark>å¯¹åº”çš„ç« èŠ‚ã€‚</p>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆäº”ï¼‰å¼‚å¸¸å¤„ç†</title>
    <url>/2024/11/25/17360.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/ddi0406/cd/?lang=en">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
<ul>
<li>B1.8 Exception handling</li>
</ul>
<p><a href="https://developer.arm.com/documentation/den0013/latest/">ARMÂ® Cortexâ„¢-A Series Programmerâ€™s Guide Version: 4.0</a></p>
<h1 id="yi-chang-jie-shao">å¼‚å¸¸ä»‹ç»</h1>
<h2 id="shi-yao-shi-yi-chang">ä»€ä¹ˆæ˜¯å¼‚å¸¸</h2>
<p>å¼‚å¸¸æ˜¯å¤„ç†å™¨æ ¸åœ¨æ‰§è¡Œç¨‹åºæŒ‡ä»¤çš„è¿‡ç¨‹ä¸­çªç„¶é‡åˆ°äº†å¼‚å¸¸çš„äº‹æƒ…ï¼Œè¿™äº›äº‹ä»¶åŒ…æ‹¬<strong>ç¡¬ä»¶ä¸­æ–­ã€æŒ‡ä»¤æ‰§è¡Œé”™è¯¯ã€ç”¨æˆ·ç¨‹åºè¯·æ±‚æœåŠ¡ã€å†…å­˜è®¿é—®å¼‚å¸¸ã€å–æŒ‡ä»¤å¼‚å¸¸</strong>ç­‰ï¼Œå‡ ä¹æ¯ç§å¤„ç†å™¨éƒ½æ”¯æŒç‰¹å®šçš„å¼‚å¸¸å¤„ç†ï¼Œ<mark>ä¸­æ–­ä¹Ÿæ˜¯å¼‚å¸¸çš„ä¸€ç§</mark>ã€‚</p>
<h2 id="arm-de-yi-chang-yuan">ARMçš„å¼‚å¸¸æº</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125214514494.png" alt="image-20241125214514494"></p>
<h2 id="fiq-jiao-irq-kuai-de-yuan-yin">FIQè¾ƒIRQå¿«çš„åŸå› </h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125214951043.png" alt="image-20241125214951043"></p>
<h1 id="arm-he-yi-chang-chu-li-guo-cheng">ARMæ ¸å¼‚å¸¸å¤„ç†è¿‡ç¨‹</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125215607973.png" alt="image-20241125215607973"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125214441652.png" alt="å¤„ç†å™¨å·¥ä½œæ¨¡å¼åˆ‡æ¢"></p>
<h2 id="yi-chang-xiang-liang-biao">å¼‚å¸¸å‘é‡è¡¨</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125215846276.png" alt="image-20241125215846276"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125215810206.png" alt="image-20241125215810206"></p>
<blockquote>
<p>[!NOTE]</p>
<p>ARMæ ¸æ€ä¹ˆçŸ¥é“å¼‚å¸¸å‘é‡è¡¨æ”¾åœ¨å†…å­˜å“ªä¸ªåœ°æ–¹å‘¢ï¼Ÿ</p>
<ol>
<li>Cortex-Aæ¶æ„ç‰ˆæœ¬ä¹‹å‰ï¼Œæ˜¯ç”±åå¤„ç†å™¨ï¼ˆ<a href="https://developer.arm.com/documentation/den0013/d/ARM-Processor-Modes-and-Registers/Registers/Coprocessor-15?lang=en">Coprocessor 15</a>ï¼‰ <code>CP15</code>çš„<code>C1</code>å¯„å­˜å™¨æ¥å†³å®šçš„ï¼Œä¸”åªèƒ½å­˜æ”¾åœ¨ <code>0xFFFF0000</code>å’Œ<code>0x00000000</code>ä¸¤è€…ä¸­çš„ä¸€ä¸ªã€‚</li>
<li>ä»Cortex-Aæ¶æ„ç‰ˆæœ¬å¼€å§‹ï¼Œç”±åå¤„ç†å™¨ <code>CP15</code>çš„<code>c12</code>å¯„å­˜å™¨æ¥å†³å®šï¼Œä¸”ä¸é™åˆ¶èµ·å§‹åœ°å€</li>
</ol>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125221405786.png" alt="Table B1-3 The vector tables"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125222433967.png" alt="image-20241125222433967"></p>
<blockquote>
<p><a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/Exception-mode-summary?lang=en">https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/Exception-mode-summary?lang=en</a></p>
</blockquote>
<h2 id="cortex-a-chu-li-qi-yi-chang-xiang-liang-biao-ji-di-zhi-zhi-ding">Cortex-Aå¤„ç†å™¨å¼‚å¸¸å‘é‡è¡¨åŸºåœ°å€æŒ‡å®š</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125223320833.png" alt="image-20241125223320833"></p>
<blockquote>
<p><a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities?lang=en">https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities?lang=en</a></p>
</blockquote>
<blockquote>
<p>The first column in <a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities?lang=en#CEGHDCAE">Table 11.1</a> gives the vector offset within the vector table associated with the particular type of exception. This is a table of instructions that the ARM core jumps to when an exception is raised. These instructions are located in a specific place in memory. The default vector base address is <code>0x00000000</code>, but most ARM cores permit the vector base address to be moved to <code>0xFFFF0000</code> (or <code>HIVECS</code>). <strong>All Cortex-A series processors permit this, and it is the default address selected by the Linux kernel. Cores that implement the Security Extensions can additionally set the vector base address, separately for Secure and Non-secure states, using the CP15 Vector Base Address registers.</strong></p>
<p><a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/The-Vector-table?lang=en">https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/The-Vector-table?lang=en</a></p>
</blockquote>
<h3 id="cp-15-c-1">CP15 c1</h3>
<blockquote>
<p><a href="https://documentation-service.arm.com/static/602cf701083323480d479d18?token=">https://documentation-service.arm.com/static/602cf701083323480d479d18?token=</a></p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125225458216.png" alt="image-20241125225458216" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125225614769.png" alt="Table 4-52 SCTLR bit assignments (continued)  "></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125225701958.png" alt="image-20241125225701958"></p>
<h3 id="cp-15-c-12">CP15 c12</h3>
<blockquote>
<p><a href="https://developer.arm.com/documentation/ddi0406/cd/?lang=en">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125230347930.png" alt="image-20241125230347930"></p>
<blockquote>
<p>[!NOTE]</p>
<p>å…¶ä¸­é«˜ä½[31:5]æ˜¯å‘é‡è¡¨çš„åŸºåœ°å€ï¼Œä½ä½[4:0]æ˜¯å¼‚å¸¸å‘é‡çš„åç§»é‡ï¼ˆoffsetï¼‰</p>
</blockquote>
<h1 id="svc-swi-yi-chang-chu-li">SVC/SWIå¼‚å¸¸å¤„ç†</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126170039244.png" alt="image-20241126170039244"></p>
<h2 id="zai-cao-zuo-xi-tong-zhong-de-yun-yong">åœ¨æ“ä½œç³»ç»Ÿä¸­çš„è¿ç”¨</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126170125829.png" alt="image-20241126170125829"></p>
<h2 id="an-li-dai-ma">æ¡ˆä¾‹ä»£ç </h2>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
    b reset
    b undefined_instruction
    b software_interrupt
    b prefetch_abort
    b data_abort
    b not_used
    b irq_interrupt
    b fiq_interrupt 
    
undefined_instruction:.word undefined_instruction
prefetch_abort:.word prefetch_abort
data_abort:.word data_abort
not_used:.word not_used
irq_interrupt:.word irq_interrupt
fiq_interrupt:.word fiq_interrupt

reset:
    mov r0,#1
    mov r1,#2
    mov r2,#3
    
    swi #8      @will save CPSR to SPSR and set CPSR(T,M), save PC to LR
    
    mov r3,#4
    mov r4,#5
	
software_interrupt:
    ldr sp,=0x4000fff0
    stmfd sp!,{r0-r12,lr}
    
    ldr r0,[lr,#-4]
    mov r1,#0xff
    bic r0,r0,r1,lsl #24
    
    ldmfd sp!,{r0-r12,pc}
    
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ding-yi-yi-chang-xiang-liang-biao">å®šä¹‰å¼‚å¸¸å‘é‡è¡¨</h3>
<p>è¿™é‡Œæˆ‘ä»¬å°†å¼‚å¸¸å‘é‡è¡¨æ”¾åœ¨ä»£ç æ®µèµ·å§‹åœ°å€ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">_start:
    b reset
    b undefined_instruction
    b software_interrupt
    b prefetch_abort
    b data_abort
    b not_used
    b irq_interrupt
    b fiq_interrupt <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¼‚å¸¸å‘é‡è¡¨çš„æŒ‡ä»¤é¡ºåºå’Œåœ°å€åç§»éœ€è¦éµå¾ªè§„èŒƒï¼Œå½“å‘ç”Ÿå¼‚å¸¸è·³è½¬æ—¶å¤„ç†å™¨ä¼šæŒ‰ç…§è§„èŒƒä»å¼‚å¸¸å‘é‡è¡¨æ‰¾åˆ°å¯¹åº”çš„æŒ‡ä»¤æ¥æ‰§è¡Œ</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126174514822.png" alt="image-20241126174514822"></p>
<h3 id="cheng-xu-ru-kou-reset">ç¨‹åºå…¥å£reset</h3>
<p>ç¬¬ä¸€æ¡æŒ‡ä»¤è·³è½¬åˆ° <code>reset</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">reset:
    mov r0,#1
    mov r1,#2
    mov r2,#3
    
    swi #8      @will save CPSR to SPSR and set CPSR(T,M), save PC to LR
    
    mov r3,#4
    mov r4,#5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­æˆ‘ä»¬åœ¨ <code>swi</code>è½¯ä¸­æ–­æŒ‡ä»¤å‰åå¢åŠ äº†ä¸€äº›å¯„å­˜å™¨æ“ä½œæ¥éªŒè¯ä¸€äº›äº‹æƒ…ï¼š</p>
<ul>
<li>ä¸­æ–­è¿”å›åï¼Œä¸­æ–­å‰çš„å¯„å­˜å™¨åº”è¯¥ä¿æŒåŸæ ·</li>
<li>ä¸­æ–­è¿”å›åï¼Œåº”è¯¥æ¥ç€ä¸‹ä¸€æ¡æŒ‡ä»¤ç»§ç»­æ‰§è¡Œ</li>
</ul>
<h3 id="zhong-duan-tiao-zhuan-arm-he-zi-dong-zuo-de-shi-qing">ä¸­æ–­è·³è½¬â€”â€”ARMæ ¸è‡ªåŠ¨åšçš„äº‹æƒ…</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126175353623.png" alt="image-20241126175353623" style="zoom:50%;">
<ul>
<li>å°†å½“å‰CPSRä¿å­˜åˆ°å¼‚å¸¸çŠ¶æ€ä¸‹çš„SPSRä¸­</li>
<li>å¯¹CPSRè¿›è¡Œå¦‚ä¸‹è®¾ç½®
<ul>
<li>è¿›å…¥ARMçŠ¶æ€ï¼ˆå¯¹åº”CPSRçš„Tä½ï¼‰</li>
<li>è®¾ç½®å·¥ä½œæ¨¡å¼ä¸ºç›¸åº”çš„å¼‚å¸¸æ¨¡å¼ï¼ˆMä½ï¼‰</li>
<li>ç¦æ­¢ä¸­æ–­ï¼ˆè®¾ç½®Iä½å’ŒFä½ä¸º1ï¼‰</li>
</ul>
</li>
<li>å°†å½“å‰PCçš„å€¼ä¿å­˜åˆ°LRï¼Œä»¥ä¾¿å¼‚å¸¸å¤„ç†å®Œåèƒ½å¤Ÿè·³è½¬å›ä¸­æ–­å‘ç”Ÿçš„åœ°æ–¹ç»§ç»­æ‰§è¡Œ</li>
<li>å°†å½“å‰PCè®¾ç½®åˆ°å¼‚å¸¸å‘é‡è¡¨çš„ç›¸åº”ä½ç½®ï¼ˆç”±äºæˆ‘ä»¬æ‰§è¡Œçš„æ˜¯ <code>swi</code>è½¯ä¸­æ–­ï¼Œå› æ­¤ä¼šæ ¹æ®å¼‚å¸¸å‘é‡è¡¨è§„èŒƒï¼Œå°†PCæŒ‡å‘å‘é‡è¡¨çš„åŸºåœ°å€åç§» <code>0x08</code>çš„ä½ç½®ï¼‰</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>ç”±äºä½¿ç”¨çš„æ˜¯ARM9E-Sçš„æ ¸ï¼Œå› æ­¤æ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šå‘é‡è¡¨åŸºåœ°å€æ—¶ï¼Œé»˜è®¤ä¸º <code>0x00000000</code>ã€‚</p>
</blockquote>
<h3 id="zhong-duan-tiao-zhuan-cong-xiang-liang-biao-dao-zhong-duan-fu-wu-cheng-xu">ä¸­æ–­è·³è½¬â€”â€”ä»å‘é‡è¡¨åˆ°ä¸­æ–­æœåŠ¡ç¨‹åº</h3>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">_start:
    b reset
    b undefined_instruction
    b software_interrupt
    b prefetch_abort
    b data_abort
    b not_used
    b irq_interrupt
    b fiq_interrupt <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ ¹æ®å‘é‡è¡¨åŸºåœ°å€åŠåç§»é‡ <code>0x08</code>èƒ½å¤Ÿæ‰¾åˆ°æˆ‘ä»¬ç¼–å†™çš„ <code>b software_interrupt</code>ï¼Œæ¥ç€è·³è½¬åˆ°å¯¹åº”çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">software_interrupt:
ldr sp,=0x4000fff0
stmfd sp!,{r0-r12,lr}

ldr r0,[lr,#-4]
mov r1,#0xff
bic r0,r0,r1,lsl #24

ldmfd sp!,{r0-r12,pc}^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>è®¾ç½®SPï¼Œå°†R0-12ã€LRå‹æ ˆä¿æŠ¤ï¼›</p>
</li>
<li>
<p>å°†LRåç§» <code>-4</code>çš„åœ°å€ä¸­çš„å†…å®¹ç»™åˆ°R0ï¼Œç”±äºLRæ˜¯ç”±ARMæ ¸ä¸­æ–­è·³è½¬æ—¶è®¾ç½®çš„ï¼Œå› æ­¤æˆ‘ä»¬å›å¤´çœ‹çœ‹ä¸­æ–­è·³è½¬çš„åœ°æ–¹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126181400176.png" alt="image-20241126181400176"></p>
</li>
<li>
<p>æ¥ç€å°† <code>0xff</code>é€å…¥R1ï¼Œå¹¶å°†R1å·¦ç§»24ä½åä½œä¸ºæ©ç å°†R0ä¸­çš„é«˜8ä½æ¸…é›¶ï¼Œå¾—åˆ°ä¸­æ–­å· <code>#8</code></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126181736106.png" alt="image-20241126181736106"></p>
</li>
<li>
<p><code>ldmfd sp!,{r0-r12,pc}</code>ï¼Œå‡†å¤‡è¿”å›ï¼Œå‡ºæ ˆå¤åŸR0-R12ï¼Œå°†LRï¼ˆæŒ‡å‘ <code>mov r3,#4</code>ï¼‰é€åˆ°PCï¼Œä¸­æ–­è¿”å›</p>
</li>
</ul>
<blockquote>
<p>[!IMPORTANT]</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>ldmfd sp!,{r0-r12,pc}^</code>ä¸­çš„ <code>^</code>ï¼Œä¼šå°†SPSRæš‚å­˜çš„å€¼å†™å›CPSR</p>
</blockquote>
<h1 id="zong-jie">æ€»ç»“</h1>
<h2 id="yi-chang-chan-sheng-shi-arm-he-zi-dong-zuo-de-shi-qing">å¼‚å¸¸äº§ç”Ÿæ—¶ï¼ŒARMæ ¸è‡ªåŠ¨åšçš„äº‹æƒ…</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126190902985.png" alt="image-20241126190902985"></p>
<h2 id="yi-chang-sheng-cheng-zhi-qian-wo-men-xu-yao-zuo-de-shi-qing">å¼‚å¸¸ç”Ÿæˆä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126192006040.png" alt="image-20241126192006040"></p>
<h2 id="yi-chang-fan-hui">å¼‚å¸¸è¿”å›</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126192130322.png" alt="image-20241126192130322"></p>
<blockquote>
<p>[!NOTE]</p>
<p><code>S</code>åç¼€è¡¨æ˜åœ¨åŸæœ‰æŒ‡ä»¤åŸºç¡€ä¸Šï¼ŒåŒæ—¶å°†SPSRæ¢å¤åˆ°C</p>
</blockquote>
<h1 id="the-end">The End</h1>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>å¼‚å¸¸</tag>
        <tag>ä¸­æ–­</tag>
      </tags>
  </entry>
  <entry>
    <title>STM32å­˜å‚¨å™¨å’Œå¯„å­˜å™¨åˆ†æ</title>
    <url>/2024/12/08/34188.html</url>
    <content><![CDATA[<h1 id="chang-jian-cun-chu-qi-jie-shao">å¸¸è§å­˜å‚¨å™¨ä»‹ç»</h1>
<p>å­˜å‚¨å™¨æ˜¯è®¡ç®—æœºç»“æ„çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚å­˜å‚¨å™¨æ˜¯ç”¨æ¥å­˜å‚¨ç¨‹åºä»£ç å’Œæ•°æ®çš„éƒ¨ä»¶ï¼Œæœ‰äº†å­˜å‚¨å™¨è®¡ç®—æœºæ‰å…·æœ‰è®°å¿†åŠŸèƒ½ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208202713661.png" alt="image-20241208202713661"></p>
<h2 id="ram">RAM</h2>
<h3 id="sram">SRAM</h3>
<p>Static Random-Access Memoryï¼Œé™æ€éšæœºå­˜å–å­˜å‚¨å™¨ã€‚æ˜¯RAMçš„ä¸€ç§ï¼Œæ‰€è°“çš„â€œé™æ€â€ï¼Œæ˜¯æŒ‡è¿™ç§å­˜å‚¨å™¨åªè¦ä¿æŒé€šç”µï¼Œé‡Œé¢å‚¨å­˜çš„æ•°æ®å°±å¯ä»¥æ’å¸¸ä¿æŒã€‚</p>
<p>æ˜¯ç”¨ç”µè·¯å­˜å‚¨æ•°æ®ï¼ŒåŸºæœ¬ç»“æ„å°±æ˜¯å‰é¢å¤§å®¶å­¦ä¹ è¿‡çš„é‚£ç§<mark>è§¦å‘å™¨</mark>ç»“æ„ï¼ˆæ¯”å¦‚Dè§¦å‘å™¨ï¼‰ã€‚å®¹é‡ä¸€èˆ¬è¾ƒä½ï¼Œç”¨äº<mark>é«˜é€Ÿç¼“å­˜</mark>ã€‚æ¯”å¦‚èŠ¯ç‰‡å†…éƒ¨çš„å¯„å­˜å™¨å°±å¯ä»¥çœ‹æˆä¸€ç§SRAMã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208204117868.png" alt="image-20241208204117868"></p>
<h3 id="dram">DRAM</h3>
<p>åŠ¨æ€éšæœºå­˜å‚¨å™¨DRAMçš„å­˜å‚¨å•å…ƒä»¥<strong>ç”µå®¹çš„ç”µè·</strong>æ¥è¡¨ç¤ºæ•°æ®ï¼Œæœ‰ç”µè·ä»£è¡¨1ï¼Œæ— ç”µè·ä»£è¡¨0ã€‚</p>
<p>ä½†æ—¶é—´ä¸€é•¿ï¼Œ<mark>ä»£è¡¨1çš„ç”µå®¹ä¼šæ”¾ç”µï¼Œä»£è¡¨0çš„ç”µå®¹ä¼šå¸æ”¶ç”µè·ï¼Œå› æ­¤å®ƒéœ€è¦å®šæœŸåˆ·æ–°æ“ä½œ</mark>ï¼Œè¿™å°±æ˜¯â€œåŠ¨æ€ï¼ˆDynamicï¼‰â€ä¸€è¯æ‰€å½¢å®¹çš„ç‰¹æ€§ã€‚</p>
<p>åˆ·æ–°æ“ä½œä¼šå¯¹ç”µå®¹è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥ç”µé‡å¤§äºæ»¡ç”µé‡çš„1 / 2ï¼Œåˆ™è®¤ä¸ºå…¶ä»£è¡¨1ï¼Œå¹¶æŠŠç”µå®¹å……æ»¡ç”µï¼›è‹¥ç”µé‡å°äº1 / 2ï¼Œåˆ™è®¤ä¸ºå…¶ä»£è¡¨ 0ï¼Œå¹¶æŠŠç”µå®¹æ”¾ç”µï¼Œè—‰æ­¤æ¥ä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208204137999.png" alt="image-20241208204137999"></p>
<h2 id="rom">ROM</h2>
<p>ROM æ˜¯â€œRead Only Memoryâ€çš„ç¼©å†™ï¼Œæ„ä¸ºåªèƒ½è¯»çš„å­˜å‚¨å™¨ã€‚ç”±äºæŠ€æœ¯çš„å‘å±•ï¼Œåæ¥è®¾è®¡å‡ºäº†å¯ä»¥æ–¹ä¾¿å†™å…¥æ•°æ®çš„ROMï¼Œè€Œè¿™ä¸ªâ€œRead Only Memoryâ€çš„åç§°è¢«æ²¿ç”¨ä¸‹æ¥äº†ï¼Œç°åœ¨ä¸€èˆ¬ç”¨äºæŒ‡ä»£éæ˜“å¤±æ€§åŠå¯¼ä½“å­˜å‚¨å™¨ï¼ŒåŒ…æ‹¬åé¢ä»‹ç»çš„ FLASH å­˜å‚¨å™¨ï¼Œæœ‰äº›äººä¹ŸæŠŠå®ƒå½’åˆ° ROM ç±»é‡Œè¾¹ã€‚</p>
<h3 id="mask-rom">MASK ROM</h3>
<p>MASKï¼ˆæ©è†œï¼‰ROM å°±æ˜¯æ­£å®—çš„â€œ<mark>Read Only Memory</mark>â€ï¼Œå­˜å‚¨åœ¨å®ƒå†…éƒ¨çš„æ•°æ®æ˜¯åœ¨å‡ºå‚æ—¶ä½¿ç”¨ç‰¹æ®Šå·¥è‰ºå›ºåŒ–çš„ï¼Œç”Ÿäº§åå°±ä¸å¯ä¿®æ”¹ï¼Œå…¶ä¸»è¦ä¼˜åŠ¿æ˜¯å¤§æ‰¹é‡ç”Ÿäº§æ—¶æˆæœ¬ä½ã€‚å½“å‰åœ¨ç”Ÿäº§é‡å¤§ï¼Œæ•°æ®ä¸éœ€è¦ä¿®æ”¹çš„åœºåˆï¼Œè¿˜æœ‰åº”ç”¨ã€‚</p>
<h3 id="prom">PROM</h3>
<p>PROMï¼ˆ<strong>Programable</strong> ROMï¼‰ä¸º<mark>å¯ç¼–ç¨‹</mark>ROMã€‚ä½†æ˜¯åªä¾›ç”¨æˆ·å†™å…¥ä¸€æ¬¡ã€‚</p>
<h3 id="eprom">EPROM</h3>
<p>EPROMï¼ˆ<mark>Erasable Programmable</mark> ROMï¼‰æ˜¯<mark>å¯é‡å¤æ“¦å†™</mark>çš„å­˜å‚¨å™¨ï¼Œå®ƒè§£å†³äº†PROMèŠ¯ç‰‡åªèƒ½å†™å…¥ä¸€æ¬¡çš„é—®é¢˜ã€‚è¿™ç§å­˜å‚¨å™¨ä½¿ç”¨ç´«å¤–çº¿ç…§å°„ï¼ˆ30åˆ†é’Ÿï¼‰èŠ¯ç‰‡å†…éƒ¨æ“¦é™¤æ•°æ®ï¼Œæ“¦é™¤å’Œå†™å…¥éƒ½è¦ä¸“ç”¨çš„è®¾å¤‡ã€‚ç°åœ¨è¿™ç§å­˜å‚¨å™¨åŸºæœ¬æ·˜æ±°ï¼Œè¢«EEPROMå–ä»£ã€‚</p>
<h3 id="e-2-prom">EÂ²PROM</h3>
<p>EÂ²PROMï¼ˆElectrically Erasable Programmable ROMï¼‰æ˜¯<mark>ç”µå¯æ“¦é™¤</mark>å­˜å‚¨å™¨ã€‚EEPROMå¯ä»¥é‡å¤æ“¦å†™ï¼Œå®ƒçš„<mark>æ“¦é™¤å’Œå†™å…¥éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ç”µè·¯æ§åˆ¶</mark>ï¼Œä¸éœ€è¦å†ä½¿ç”¨å¤–éƒ¨è®¾å¤‡æ¥æ“¦å†™ã€‚è€Œä¸”å¯ä»¥æŒ‰å­—èŠ‚ä¸ºå•ä½ä¿®æ”¹æ•°æ®ï¼Œæ— éœ€æ•´ä¸ªèŠ¯ç‰‡æ“¦é™¤ã€‚ç°åœ¨ä¸»è¦ä½¿ç”¨çš„ROMèŠ¯ç‰‡éƒ½æ˜¯EEPROMã€‚</p>
<h3 id="flash">Flash</h3>
<p>FLASHå­˜å‚¨å™¨åˆç§°ä¸º<mark>é—ªå­˜</mark>ï¼Œå®ƒä¹Ÿæ˜¯å¯é‡å¤æ“¦å†™çš„å­˜å‚¨å™¨ï¼Œéƒ¨åˆ†ä¹¦ç±ä¼šæŠŠFLASHå­˜å‚¨å™¨ç§°ä¸º FLASH ROMï¼Œä½†å®ƒçš„<mark>å®¹é‡ä¸€èˆ¬æ¯”EEPROMå¤§å¾—å¤š</mark>ï¼Œä¸”åœ¨æ“¦é™¤æ—¶ï¼Œä¸€èˆ¬ä»¥å¤šä¸ªå­—èŠ‚ä¸ºå•ä½ã€‚</p>
<h3 id="ying-pan-ci-pan">ç¡¬ç›˜ï¼ˆç£ç›˜ï¼‰</h3>
<p>åˆç§°ç£ç›˜ï¼Œæ˜¯é ç£æ€§æ¥å­˜å‚¨æ•°æ®çš„ã€‚</p>
<h1 id="stm-32-f-103-de-cun-chu-qi">STM32F103çš„å­˜å‚¨å™¨</h1>
<p>STM32åŒ…å«ï¼š</p>
<ul>
<li>
<p>ç‰‡å†…SRAMï¼ˆ64Kï¼‰ï¼šå®ƒå¯ä»¥ä»¥å­—èŠ‚ã€åŠå­—ï¼ˆ16ä½ï¼‰æˆ–å…¨å­—ï¼ˆ32ä½ï¼‰è®¿é—®ã€‚SRAMçš„èµ·å§‹åœ°å€æ˜¯0x2000 0000ã€‚</p>
</li>
<li>
<p>ç‰‡å†…Flashï¼ˆæœ€å¤§å¯è¾¾2Mï¼‰ã€‚</p>
</li>
</ul>
<h2 id="cun-chu-qi-ying-she">å­˜å‚¨å™¨æ˜ å°„</h2>
<p>ä»€ä¹ˆå«å­˜å‚¨å™¨æ˜ å°„å‘¢ï¼Ÿ<mark>å­˜å‚¨å™¨æœ¬èº«å¹¶ä¸å…·å¤‡åœ°å€ä¿¡æ¯</mark>ï¼Œé‚£ä¹ˆCPUè¦å‡†ç¡®æ‰¾åˆ°å­˜å‚¨æŸä¸ªä¿¡æ¯çš„å­˜å‚¨å•å…ƒï¼Œå°±å¿…é¡»ä¸ºè¿™äº›å•å…ƒåˆ†é…ä¸€ä¸ªç›¸äº’å¯åŒºåˆ†çš„æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†å°±æ˜¯å¸¸è¯´çš„<mark>åœ°å€ç¼–ç </mark>ã€‚</p>
<p>STM32ä¸­é›†æˆå¤šç§å­˜å‚¨å™¨ï¼ˆ<mark>å„ç§å¤–è®¾ä¹Ÿéœ€è¦åˆ†é…åœ°å€</mark>ï¼‰ï¼ŒåŒä¸€ç±»å‹çš„å­˜å‚¨å™¨å½“ä½œä¸€ç»„blockï¼Œä¸ºæ¯ä¸€ä¸ªblockåˆ†é…ä¸€ä¸ªæ•°å€¼è¿ç»­ï¼Œå­˜å‚¨å•å…ƒæ•°ç›¸ç­‰ï¼Œä»¥16è¿›åˆ¶è¡¨ç¤ºçš„è‡ªç„¶æ•°é›†åˆä½œä¸ºå­˜å‚¨å™¨Blockçš„åœ°å€ç¼–ç ã€‚è¿™ç§è‡ªç„¶æ•°é›†åˆä¸å­˜å‚¨å™¨Blockçš„å¯¹åº”å…³ç³»å°±æ˜¯å­˜å‚¨å™¨æ˜ å°„ã€‚</p>
<p>å­˜å‚¨å™¨æ˜ å°„å…¶å®å°±æ˜¯å°†èŠ¯ç‰‡ç†è®ºä¸Šçš„åœ°å€ï¼ˆ32ä½æ€»çº¿å¯å¯»å€èŒƒå›´ä¸º4Gä¸ªå­—èŠ‚å­˜å‚¨å•å…ƒï¼‰åˆ†é…ç»™å„ä¸ªå­˜å‚¨å™¨ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå­˜å‚¨å™¨æ˜ å°„å¹¶ä¸æ˜¯åªé’ˆå¯¹SRAMå’Œç‰‡å†…Flashåšåœ°å€æ˜ å°„ï¼Œå…¶å®æ‰€æœ‰çš„ç‰‡å†…å¤–è®¾ï¼ˆæ¯”å¦‚IOå£ï¼‰éƒ½éœ€è¦åœ°å€ï¼Œä¹Ÿéƒ½éœ€è¦åšæ˜ å°„ã€‚</p>
<h2 id="cun-chu-qi-ying-she-tu">å­˜å‚¨å™¨æ˜ å°„å›¾</h2>
<p>èŠ¯ç‰‡èƒ½è®¿é—®çš„å­˜å‚¨ç©ºé—´æœ‰å¤šå¤§ï¼Œæ˜¯ç”±è°å®šçš„ï¼Ÿè¿™ä¸ªæ˜¯ç”±èŠ¯ç‰‡çš„åœ°å€æ€»çº¿çš„æ•°é‡å†³æ¥å®šçš„ï¼ŒSTM32èŠ¯ç‰‡å†…éƒ¨çš„åœ°<mark>å€æ€»çº¿ä¸º32æ ¹</mark>ã€‚æ‰€ä»¥STM32æœ‰4Gçš„<mark>åœ°å€ç©ºé—´</mark>ã€‚ï¼ˆè¿™ä¸ª4GBçš„æ˜¯STM32ç†è®ºåˆ†é…çš„åœ°å€ç©ºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´å®é™…ä¸Šå¹¶ä¸æ˜¯æœ‰è¿™ä¹ˆå¤§çš„å­˜å‚¨å•å…ƒï¼Œå¾ˆå¤šåœ°å€éƒ½æ˜¯é¢„ç•™åœ°å€ï¼Œç©ºç€è¿˜æ²¡ç”¨å‘¢ï¼‰ã€‚</p>
<p>ç¨‹åºå­˜å‚¨å™¨ã€æ•°æ®å­˜å‚¨å™¨ã€å¯„å­˜å™¨å’Œè¾“å…¥è¾“å‡ºç«¯å£è¢«ç»„ç»‡åœ¨è¿™ä¸ª4GBçš„çº¿æ€§åœ°å€ç©ºé—´å†…ã€‚æ•°æ®å­—èŠ‚ä»¥<mark>å°ç«¯æ ¼å¼</mark>ï¼ˆæ•°æ®ä½ä½å­—èŠ‚å­˜æ”¾åœ¨ä½ä½åœ°å€ï¼‰å­˜æ”¾åœ¨å­˜å‚¨å™¨ä¸­ã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p>ä½¿ç”¨å°ç«¯æ ¼å¼å­˜å‚¨æ•°æ®æœ‰ä¸ªå¥½å¤„ï¼šå½“å‘ç”Ÿå‘ä¸‹ç±»å‹è½¬æ¢æ—¶ï¼Œèƒ½å¤Ÿæ–¹ä¾¿åœ°ä»ä½ä½å­—èŠ‚å¼€å§‹æˆªæ–­æ•°æ®ã€‚</p>
</blockquote>
<p>ARMæŠŠå¯è®¿é—®çš„å­˜å‚¨å™¨ç©ºé—´åˆ†æˆ8ä¸ªä¸»è¦å—ï¼Œæ¯ä¸ªå—ä¸º512MBã€‚è¿™ä¸ªå®¹é‡æ˜¯éå¸¸å¤§çš„ï¼Œå› æ­¤èŠ¯ç‰‡å‚å•†å°±åœ¨æ¯å—å®¹é‡èŒƒå›´å†…è®¾è®¡å„è‡ªç‰¹è‰²çš„å¤–è®¾ã€‚ä½†æ˜¯æ¯å—åŒºåŸŸå®¹é‡å ç”¨è¶Šå¤§ï¼ŒèŠ¯ç‰‡æˆæœ¬å°±è¶Šé«˜ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬ä½¿ç”¨çš„ STM32 èŠ¯ç‰‡éƒ½æ˜¯åªç”¨äº†å…¶ä¸­ä¸€éƒ¨åˆ†ã€‚ARM åœ¨å¯¹è¿™ 4GB å®¹é‡åˆ†å—çš„æ—¶å€™æ˜¯<mark>æŒ‰ç…§å…¶åŠŸèƒ½åˆ’åˆ†</mark>ï¼Œæ¯å—éƒ½æœ‰å®ƒç‰¹æ®Šçš„ç”¨é€”ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208211220547.png" alt="image-20241208211220547"></p>
<p>åœ¨è¿™8ä¸ªBlocké‡Œé¢ï¼Œè¦ç‰¹åˆ«æ³¨æ„Block0ã€Block1å’ŒBlock2è¿™3ä¸ªå—ã€‚å› ä¸ºå…¶ä¸­åŒ…å«äº†STM32èŠ¯ç‰‡çš„å†…éƒ¨ Flashã€RAMå’Œç‰‡ä¸Šå¤–è®¾ã€‚ä¸‹é¢è¿˜æ˜¯æ ¹æ®å­˜å‚¨å™¨æ˜ å°„å›¾å†…ä¿¡æ¯æ¥ç®€å•çš„ä»‹ç»ä¸‹è¿™3ä¸ªBlocké‡Œé¢çš„å…·ä½“åŒºåŸŸåŠŸèƒ½åˆ’åˆ†ã€‚</p>
<h3 id="block-0">Block0</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208211250072.png" alt="image-20241208211250072"></p>
<ul>
<li>
<p><code>0x0000 0000-0x0007 FFFF</code>ï¼šå–å†³äº<mark>BOOTå¼•è„š</mark>ï¼Œå¯ä»¥æ˜¯ Flash çš„åˆ«åï¼Œä¹Ÿå¯ä»¥æ˜¯ç³»ç»Ÿå­˜å‚¨å™¨çš„åˆ«åã€‚ï¼ˆ512Kï¼‰</p>
</li>
<li>
<p><code>0x0008 0000-0x07FF FFFF</code>ï¼šé¢„ç•™ã€‚ï¼ˆ1Mï¼‰</p>
</li>
<li>
<p><code>0x0800 0000-0x0807 FFFF</code>ï¼šç‰‡å†… FLASHï¼Œæˆ‘ä»¬ç¼–å†™çš„ç¨‹åºå°±æ”¾åœ¨è¿™ä¸€åŒºåŸŸï¼ˆ512Kï¼‰</p>
</li>
<li>
<p><code>0x0808 0000-0x1FFF EFFF</code>ï¼šé¢„ç•™ã€‚ï¼ˆ383Mï¼‰</p>
</li>
<li>
<p><code>0x1FFF F000-0x1FFF F7FF</code>ï¼šç³»ç»Ÿå­˜å‚¨å™¨ï¼Œé‡Œé¢å­˜æ”¾çš„æ˜¯ ST å‡ºå‚æ—¶çƒ§å†™å¥½çš„ISPè‡ªä¸¾ç¨‹åºï¼Œç”¨æˆ·æ— æ³•æ”¹åŠ¨ã€‚ä½¿ç”¨ä¸²å£ä¸‹è½½çš„æ—¶å€™éœ€è¦ç”¨åˆ°è¿™éƒ¨åˆ†ç¨‹åºã€‚ï¼ˆ2Kï¼‰</p>
</li>
<li>
<p><code>0x1FFF F800-0x1FFF F80F</code>ï¼šå¯é€‰å­—èŠ‚ï¼Œç”¨äºé…ç½®è¯»å†™ä¿æŠ¤ã€BORçº§åˆ«ã€è½¯ä»¶/ç¡¬ä»¶çœ‹é—¨ç‹—ä»¥åŠå™¨ä»¶å¤„äºå¾…æœºæˆ–åœæ­¢æ¨¡å¼ä¸‹çš„å¤ä½ã€‚å½“èŠ¯ç‰‡ä¸å°å¿ƒè¢«é”ä½ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä»RAMé‡Œé¢å¯åŠ¨æ¥ä¿®æ”¹è¿™éƒ¨åˆ†ç›¸åº”çš„å¯„å­˜å™¨ä½ã€‚</p>
</li>
<li>
<p><code>0x1FFF F810-0x1FFF FFFF</code>ï¼šé¢„ç•™ã€‚</p>
</li>
</ul>
<h3 id="block-1">Block1</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208211508171.png" alt="image-20241208211508171"></p>
<p>Block1ç”¨äºè®¾è®¡ç‰‡å†…çš„SRAMï¼Œä¾‹å¦‚STM32F103ZET6çš„SRAMæ˜¯64KBã€‚ä»å­˜å‚¨å™¨æ˜ å°„å›¾ä¸­å¯ä»¥çœ‹åˆ°Block1å†…éƒ¨åˆåˆ’åˆ†äº†å‡ ä¸ªåŠŸèƒ½å—ï¼Œæˆ‘ä»¬æŒ‰åœ°å€ä»ä½åˆ°é«˜é¡ºåºä¾æ¬¡ä»‹ç»ã€‚</p>
<ul>
<li>0x2000 0000-0x2000 FFFFï¼šSRAMï¼Œå®¹é‡ä¸º 64KBã€‚</li>
<li>0x2001 0000-0x3FFF FFFFï¼šé¢„ç•™ã€‚</li>
</ul>
<h3 id="block-2">Block2</h3>
<p>Block2ç”¨äºè®¾è®¡ç‰‡å†…å¤–è®¾ï¼Œæ ¹æ®å¤–è®¾æ€»çº¿é€Ÿåº¦çš„ä¸åŒï¼ŒBlock2è¢«åˆ’åˆ†ä¸ºAHBå’ŒAPB ä¸¤éƒ¨åˆ†ï¼ŒAPBåˆè¢«åˆ†æˆAPB1å’ŒAPB2ã€‚è¿™äº›éƒ½å¯ä»¥åœ¨ä¸Šé¢å­˜å‚¨å™¨æ˜ å°„å›¾ä¸­å¯çœ‹åˆ°ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208211719069.png" alt="image-20241208211719069"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208211732607.png" alt="image-20241208211732607"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208211739568.png" alt="image-20241208211739568"></p>
<ul>
<li><code>0x4000 0000-0x4000 77FF</code>ï¼šAPB1æ€»çº¿å¤–è®¾ã€‚</li>
<li><code>0x4001 0000-0x4001 57FF</code>ï¼šAPB2æ€»çº¿å¤–è®¾ã€‚</li>
<li><code>0x4001 8000-0x4002 33FF</code>ï¼šAHBæ€»çº¿å¤–è®¾ã€‚</li>
</ul>
<h3 id="block-3-4-5">Block3,4,5</h3>
<p>åœ¨Block3ã€Block4ã€Block5ä¸­åŒ…å«äº†FSMCæ‰©å±•åŒºåŸŸï¼Œå¯ç”¨äºæ‰©å±•å¦‚ SRAMï¼ŒNORFLASH å’ŒNANDFLASHç­‰çš„å¤–éƒ¨å­˜å‚¨å™¨ã€‚</p>
<h1 id="ji-cun-qi">å¯„å­˜å™¨</h1>
<h2 id="shi-yao-shi-ji-cun-qi">ä»€ä¹ˆæ˜¯å¯„å­˜å™¨</h2>
<p>å‰é¢æˆ‘ä»¬å­¦ä¹ äº†å­˜å‚¨å™¨ROMå’ŒRAMï¼Œè¿˜åŒ…æ‹¬æˆ‘ä»¬æ‰€æœ‰çš„ç‰‡ä¸Šå¤–è®¾æˆ‘ä»¬éƒ½å¯ä»¥ç§°ä¸ºå­˜å‚¨å™¨ï¼ŒSTM32é€šè¿‡å­˜å‚¨å™¨æ˜ å°„ï¼Œå°±å¯ä»¥æ‰¾åˆ°è¿™äº›å­˜å‚¨å™¨ã€‚</p>
<p>æˆ‘ä»¬ç¼–ç¨‹çš„æ—¶å€™ç”¨çš„æœ€å¤šçš„è¿˜æ˜¯**å¯„å­˜å™¨ï¼Œ**é‚£ä¹ˆä»€ä¹ˆå«å¯„å­˜å™¨å‘¢ï¼Ÿ</p>
<p>åœ¨å­˜å‚¨å™¨ Block2 è¿™å—åŒºåŸŸï¼Œè®¾è®¡çš„æ˜¯<strong>ç‰‡ä¸Šå¤–è®¾</strong>ï¼Œå®ƒä»¬ä»¥4ä¸ªå­—èŠ‚ä¸º1ä¸ªå•å…ƒï¼Œå…± 32bitï¼Œæ¯ä¸€ä¸ªå•å…ƒå¯¹åº”ä¸åŒçš„åŠŸèƒ½ï¼Œå½“æˆ‘ä»¬æ§åˆ¶è¿™äº›å•å…ƒæ—¶å°±å¯ä»¥é©±åŠ¨å¤–è®¾å·¥ä½œã€‚æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ¯ä¸ªå•å…ƒçš„èµ·å§‹åœ°å€ï¼Œç„¶åé€šè¿‡ C è¯­è¨€æŒ‡é’ˆçš„æ“ä½œæ–¹å¼æ¥è®¿é—®è¿™äº›å•å…ƒï¼Œå¦‚æœæ¯æ¬¡éƒ½æ˜¯é€šè¿‡è¿™ç§åœ°å€çš„æ–¹å¼æ¥è®¿é—®ï¼Œä¸ä»…ä¸å¥½è®°å¿†è¿˜å®¹æ˜“å‡ºé”™ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥æ ¹æ®æ¯ä¸ªå•å…ƒåŠŸèƒ½çš„ä¸åŒï¼Œä»¥åŠŸèƒ½ä¸ºåç»™è¿™ä¸ªå†…å­˜å•å…ƒå–ä¸€ä¸ªåˆ«åã€‚</p>
<p>è¿™ä¸ª<strong>åˆ«å</strong>å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„<strong>å¯„å­˜å™¨ã€‚</strong></p>
<p>ä¸€å¥è¯æ€»ç»“ï¼šå¯„å­˜å™¨æ˜¯å•ç‰‡æœºå†…éƒ¨ä¸€ç§ç‰¹æ®Šçš„å­˜å‚¨å™¨ï¼Œå¯ä»¥å®ç°å¯¹å•ç‰‡æœºå„ä¸ªåŠŸèƒ½çš„æ§åˆ¶ã€‚</p>
<h2 id="ji-cun-qi-ying-she">å¯„å­˜å™¨æ˜ å°„</h2>
<p>è¿™ä¸ªç»™å·²ç»åˆ†é…å¥½åœ°å€çš„æœ‰ç‰¹å®šåŠŸèƒ½çš„å­˜å‚¨å™¨å•å…ƒå–åˆ«åçš„è¿‡ç¨‹å°±å«å¯„å­˜å™¨æ˜ å°„ã€‚</p>
<p>å¯„å­˜å™¨æ˜ å°„åœ¨STæä¾›çš„å¤´æ–‡ä»¶stm32f10x.hä¸­å·²ç»é€šè¿‡é¢„ç¼–è¯‘çš„å½¢å¼å®Œå…¨æ˜ å°„å¥½äº†ï¼Œä»¥åå¦‚æœå†æ“ä½œæŸä¸ªç‰¹å®šå¤–è®¾çš„æ—¶å€™ï¼Œå°±ä¸ç”¨ç›´æ¥æ“ä½œåœ°å€ï¼Œç›´æ¥æ“ä½œå¯¹åº”çš„å¯„å­˜å™¨åå°±å¯ä»¥äº†ã€‚</p>
<p>æ¯”å¦‚PAè¿™ç»„IOç«¯å£çš„æ˜ å°„ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// å¤–è®¾åŸºå€</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERIPH_BASE</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x40000000</span><span class="token punctuation">)</span> </span></span>
<span class="token comment">// APB2å¤–è®¾çš„åŸºå€ </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APB2PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x10000</span><span class="token punctuation">)</span> </span></span>
<span class="token comment">// GPIOA å¤–è®¾çš„åŸºå€</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOA_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>APB2PERIPH_BASE <span class="token operator">+</span> d<span class="token punctuation">)</span></span></span>
<span class="token comment">// åšäº†ç±»å‹è½¬æ¢ï¼Œåœ°å€ä»ç„¶æ˜¯GPIOA å¤–è®¾çš„åŸºå€</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOA</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOA_BASE<span class="token punctuation">)</span></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>Memory</tag>
        <tag>å­˜å‚¨å™¨</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆå››ï¼‰ATPCSæ ‡å‡†_æ±‡ç¼–ä¸Cæ··åˆç¼–ç¨‹_volatileå…³é”®å­—</title>
    <url>/2024/11/24/59994.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/dui0041/latest/Thumb-Procedure-Call-Standard/About-the-Thumb-Procedure-Call-Standard">The ARM-THUMB Procedure Call Standard</a></p>
<h1 id="atpcs-biao-zhun">ATPCSæ ‡å‡†</h1>
<h2 id="atpcs-biao-zhun-jie-shao">ATPCSæ ‡å‡†ä»‹ç»</h2>
<p>ATPCSæ˜¯<mark>ARM-Thumb Procedure Call Standard</mark>çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯<mark>ARM-Thumbçš„ç¨‹åºè°ƒç”¨æ ‡å‡†</mark>ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124210132131.png" alt="image-20241124210132131"></p>
<h2 id="ji-cun-qi-jiao-se">å¯„å­˜å™¨è§’è‰²</h2>
<blockquote>
<p>The first four registers r0-r3 are used to pass parameter values into a routine and result values out of a routine and to hold intermediate values within a routine (but, in general, only between subroutine calls). In ARM-state, register r12â€” also called IPâ€” can also be used to hold intermediate values between subroutine calls.</p>
</blockquote>
<p><mark>r0-r3</mark>é€šå¸¸ç”¨æ¥ä¼ é€’å‡½æ•°å‚æ•°ã€è¿”å›å‡½æ•°ç»“æœå’Œä¿å­˜å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´å˜é‡ï¼ˆä¾‹å¦‚ <code>sum=a+b</code>éœ€è¦å…ˆå°† <code>a+b</code>çš„è®¡ç®—ç»“æœå­˜åˆ°å¯„å­˜å™¨ä¸­å†å†™åˆ° <code>sum</code>å¯¹åº”çš„å†…å­˜ï¼‰ã€‚</p>
<p>åœ¨ARMçŠ¶æ€ä¸‹ï¼Œ<mark>r12ï¼Œä¹Ÿç§°ä¸ºIP</mark>å¯„å­˜å™¨ä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜ä¸´æ—¶å˜é‡ï¼Œå°¤å…¶æ˜¯å½“å…¶ä»–é€šç”¨å¯„å­˜å™¨ï¼ˆr0-r11ï¼‰å·²è¢«ä½¿ç”¨æ—¶ã€‚</p>
<blockquote>
<p><code>r12</code> (IP) is a <strong>general-purpose register</strong>, not reserved for any specific use in standard ARM programming.</p>
<p>The <strong>ARM Procedure Call Standard (AAPCS)</strong> defines it as a <strong>scratch register</strong>. This means:</p>
<ul>
<li>The <strong>caller</strong> can use it freely to store temporary values.</li>
<li>The <strong>callee</strong> (the function being called) does not preserve its value. If <code>r12</code> is used by the caller before calling another function, its value will be lost unless explicitly saved.</li>
</ul>
</blockquote>
<blockquote>
<p>Typically, the registers from r4 to r11 are used to hold the values of a routineâ€™s local variables. They are also labeled v1-v8. Only v1-v4 can be used uniformly by the whole Thumb instruction set (shown emboldened).</p>
</blockquote>
<p>ä¸€èˆ¬åœ°ï¼Œ<mark>r4-r11</mark>ç”¨æ¥ä¿å­˜å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œä»–ä»¬è¢«æ ‡è®°ä¸ºv1-v8ã€‚ThumbæŒ‡ä»¤é›†åªèƒ½ä½¿ç”¨v1-v4ã€‚</p>
<blockquote>
<p>In all variants of the procedure call standard, registers r12-r15 have special roles. In these roles they are labeled IP, SP, LR and PC (or ip, sp, lr, and pc, but this standard uses the upper case name for the special role)</p>
</blockquote>
<p><mark>r12-r15</mark>æœ‰ç€ç‰¹æ®Šçš„è§’è‰²ï¼Œä¾‹å¦‚IPï¼ˆä¸´æ—¶ä¿å­˜SPï¼‰ï¼ŒSPï¼ˆæŒ‡å‘æ ˆé¡¶ï¼‰ï¼ŒLRï¼ˆè·³è½¬æ—¶ç”¨æ¥ä¿å­˜PCï¼‰ã€PCï¼Œå¹¶ä¸”ä½¿ç”¨å¤§å†™æ¥æ ‡ç¤ºä»–ä»¬çš„ç‰¹æ®Šè§’è‰²ã€‚</p>
<blockquote>
<p>In some variants of the procedure call standard, r9 and r10 also have a special role. In these roles, r9 is labeled SB and r10 is labeled SL (or sb and sl).<br>
Only registers r0-r7, SP, LR and PC are ubiquitously available in Thumb state. Their synonyms and special names are shown emboldened. Few Thumb instructions can access the high registers, v5-v8, SB, SL and IP.<br>
In Thumb-state, r7 is often used as a work register and is also labeled WR</p>
</blockquote>
<h2 id="can-shu-chuan-di">å‚æ•°ä¼ é€’</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124212508273.png" alt="image-20241124212508273"></p>
<p><mark>åœ¨å®šä¹‰å‡½æ•°æ—¶ï¼Œå‚æ•°æ•°é‡å°½é‡ä¸è¦è¶…è¿‡4ä¸ªï¼Œè¿™æ ·æ•ˆç‡è¾ƒå¥½</mark></p>
<h2 id="han-shu-fan-hui-zhi">å‡½æ•°è¿”å›å€¼</h2>
<ul>
<li>è¿”å›å€¼ä¸ºä¸€ä¸ª32ä½çš„æ•´æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡å¯„å­˜å™¨0è¿”å›</li>
<li>è¿”å›å€¼ä¸ºä¸€ä¸ª64ä½æ•´æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡R0å’ŒR1è¿”å›ï¼Œä¾æ­¤ç±»æ¨</li>
</ul>
<h2 id="zhan-zheng-fen-xi">æ ˆå¸§åˆ†æ</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124213834303.png" alt="image-20241124213834303" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124213931226.png" alt="image-20241124213931226"></p>
<h1 id="fan-hui-bian-fen-xi-atpcs-biao-zhun">åæ±‡ç¼–åˆ†æATPCSæ ‡å‡†</h1>
<h2 id="zhun-bei-hui-bian-he-c-wen-jian">å‡†å¤‡æ±‡ç¼–å’ŒCæ–‡ä»¶</h2>
<p>å‡†å¤‡ä¸€ä¸ªæ±‡ç¼–å¯åŠ¨æ–‡ä»¶å’Œä¸€ä¸ªCæ–‡ä»¶ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125151255393.png" alt="image-20241125151255393"></p>
<p>åœ¨ <code>asm.s</code>ä¸­ï¼Œåœ¨è°ƒç”¨ <code>main_label</code>å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬æ“ä½œäº†ä¸‹R0-R2ï¼Œå¹¶è®¾ç½®äº†SPï¼Œæ¨¡æ‹Ÿåœ¨è°ƒç”¨å‡½æ•°å‰åšäº†ä¸€äº›æ“ä½œ</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x11			
	mov r1,#0x22
    mov r2,#0x33
    mov sp,#0x00002000
	bl main_label	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main_label</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	b <span class="token operator">=</span> i<span class="token operator">++</span> <span class="token operator">+</span> <span class="token operator">++</span>i<span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="jin-yong-bian-yi-you-hua">ç¦ç”¨ç¼–è¯‘ä¼˜åŒ–</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125151330962.png" alt="image-20241125151330962" style="zoom: 50%;">
<h2 id="diao-shi-fen-xi-amp-nei-cun-ying-she">è°ƒè¯•åˆ†æ&amp;å†…å­˜æ˜ å°„</h2>
<p>åœ¨ç‚¹å‡»debugåï¼Œæ­¥è¿›ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ·»åŠ ä¸€ä¸‹å†…å­˜æ˜ å°„ <code>0x00001000,0x00002000</code>ï¼Œå› ä¸ºåœ¨ <code>asm.s</code>ä¸­æˆ‘ä»¬æœ‰è®¾ç½®è¿‡SP <code>mov sp,#0x00002000</code>ï¼ˆ<mark>æ³¨æ„æ¯æ¬¡ç‚¹å‡»debugåéƒ½éœ€è¦æ‰‹åŠ¨æ˜ å°„ä¸‹</mark>ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125102205035.png" alt="image-20241125102205035"></p>
<p>æ¥ç€æˆ‘ä»¬æ­¥è¿›ï¼Œåœ¨è°ƒç”¨ <code>main_label</code>å‡½æ•°ä¹‹å‰ï¼Œå¯¹R0-R2ï¼ŒSP(R13)æœ‰æ‰€ä½¿ç”¨ï¼ˆæ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨å‰æ“ä½œè¿‡ç›¸å…³çš„å¯„å­˜å™¨ï¼‰ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125104048265.png" alt="image-20241125104048265"></p>
<p>å¯„å­˜å™¨çŠ¶æ€ç¤ºä¾‹ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132148176.png" alt="image-20241125132148176" style="zoom:50%;">
<h2 id="han-shu-diao-yong-fen-xi">å‡½æ•°è°ƒç”¨åˆ†æ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125115716832.png" alt="image-20241125115716832"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124213834303.png" alt="image-20241124213834303" style="zoom:50%;">
<p>å‚ç…§ATPCSæ ‡å‡†ï¼Œæˆ‘ä»¬æ¥ç€åˆ†æ <code>main_label</code>å‡½æ•°çš„æ‰§è¡Œã€‚</p>
<h3 id="jiang-sp-zan-cun-dao-ip">å°†SPæš‚å­˜åˆ°IP</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125104614719.png" alt="image-20241125104614719"></p>
<p>é¦–å…ˆå°†<code>R13(SP)</code>é€åˆ°äº†<code>R12(IP)</code>è¿›è¡Œä¿å­˜ï¼ˆè¿™é‡Œå¯ä»¥çœ‹å‡º<code>IP</code>çš„ä¸´æ—¶ä¿å­˜ä½œç”¨ï¼Œå°†å‡½æ•°è°ƒç”¨å‰çš„SPæ ˆé¡¶æŒ‡é’ˆæš‚å­˜èµ·æ¥ä»¥ä¾¿åç»­æ¢å¤ï¼‰ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132222836.png" alt="image-20241125132222836"></p>
<p>æ¥ç€æˆ‘ä»¬çœ‹ä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼š</p>
<p>å‹æ ˆPC,LR,IP,FP</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125105604588.png" alt="image-20241125105604588"></p>
<p>å°†<code>R11(FP)ã€R12(IP)ã€R14(LR)ã€PC(R15)</code>é€šè¿‡ <code>STMDB</code>æŒ‡ä»¤è¿›è¡Œå‹æ ˆï¼ˆå‚è€ƒå¦ä¸€ç¯‡æ–‡ç« ã€ŠARMæ ¸å­¦ä¹ ï¼ˆäºŒï¼‰æŒ‡ä»¤é›†ã€‹ï¼‰ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>ATPCSæ ‡å‡†è§„å®šä½¿ç”¨<mark>æ»¡å‡æ ˆæ¨¡å¼</mark>ï¼ˆä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿ï¼Œæ ˆé¡¶æŒ‡é’ˆSPæŒ‡å‘æœ€åä¸€ä¸ªå…¥æ ˆçš„æ•°æ®åœ°å€ï¼‰</li>
<li><code>STM</code>ï¼šå¤šæ•°æ®ä¼ è¾“æŒ‡ä»¤ï¼ŒåŒæ—¶å°†å¤šä¸ªæ•°æ®è¿›è¡Œå‹æ ˆ</li>
<li><code>DB</code>ï¼š <mark>Decrease&nbsp;Before</mark>ï¼ˆå…ˆé€’å‡SPç„¶åå‹æ ˆæ•°æ®ï¼‰ï¼Œè¿™é‡Œå‹æ ˆ4ä¸ªå¯„å­˜å™¨ï¼ˆå­—å®½4å­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥SPä¼šé€’å‡4*4=16</li>
<li>åŒæ—¶å‹æ ˆå¤šä¸ªå¯„å­˜å™¨æ—¶ï¼Œåºå·ï¼ˆRnä¸­çš„nï¼‰å¤§çš„å¯„å­˜å™¨å¯¹åº”æ ˆçš„é«˜åœ°å€ï¼Œåºå·å°çš„åˆ™å¯¹åº”ä½åœ°å€</li>
</ul>
<p>å¯„å­˜å™¨çŠ¶æ€ç¤ºæ„å›¾ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132238290.png" alt="image-20241125132238290" style="zoom:50%;">
<h3 id="she-zhi-zhan-ji-zhi-fp-zhan-di-shu-ju-de-di-zhi">è®¾ç½®æ ˆåŸºå€FPï¼ˆæ ˆåº•æ•°æ®çš„åœ°å€ï¼‰</h3>
<p>å°†R12(IPï¼Œä¹‹å‰ä¿å­˜äº†SPï¼Œå³è°ƒç”¨æ–¹callerçš„SP)ï¼Œé€šè¿‡ <code>SUB</code>æŒ‡ä»¤å‡4ï¼Œèµ‹å€¼ç»™R11ï¼ˆFPï¼Œæ ˆåŸºå€¼ï¼Œè¢«è°ƒæ–¹calleeå³ <code>main_label</code>å‡½æ•°çš„æ ˆçš„èµ·å§‹åœ°å€ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125115123312.png" alt="image-20241125115123312"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125120006973.png" alt="image-20241125120006973"></p>
<p>å¯„å­˜å™¨ç¤ºæ„å›¾:</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132458366.png" alt="image-20241125132458366"></p>
<blockquote>
<p>callerè¡¨ç¤ºè°ƒç”¨æ–¹ï¼Œcalleeè¡¨ç¤ºè¢«è°ƒæ–¹</p>
</blockquote>
<h3 id="zeng-jia-sp-kuo-da-zhan-kong-jian">å¢åŠ SPï¼Œæ‰©å¤§æ ˆç©ºé—´</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125121914111.png" alt="image-20241125121914111"></p>
<p>æ¥ç€é€šè¿‡ <code>SUB</code>æŒ‡ä»¤ï¼Œå°†SP(R13)å‡å» <code>0x00000010</code>ï¼ˆå³16å­—èŠ‚ï¼Œ4ä¸ªå­—ï¼‰ï¼Œç›¸å½“äºå°†SPä¸‹ç§»äº†å››ä¸ªå­˜å‚¨å•å…ƒ</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132531947.png" alt="image-20241125132531947"></p>
<p>è¿™æ ·å°±ç›¸å½“äºåœ¨æ ˆä¸­ç©ºå‡ºå››ä¸ªå­˜å‚¨å•å…ƒï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹</p>
<h3 id="han-shu-ru-can-ya-zhan">å‡½æ•°å…¥å‚å‹æ ˆ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125131249986.png" alt="image-20241125131249986"></p>
<p>è¿™é‡Œå°†R0å†™åˆ°R11ï¼ˆFPï¼Œæ ˆåŸºå€ï¼‰å‘ä¸‹åç§» <code>0x0018</code>ï¼ˆå³24å­—èŠ‚ï¼Œå…­ä¸ªå­—ï¼‰å¯¹åº”çš„å­˜å‚¨å•å…ƒä¸­ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125133004294.png" alt="image-20241125133004294"></p>
<p>åŒæ ·çš„ï¼Œå°†R1å†™åˆ°FPå‘ä¸‹åç§» <code>0x001C</code>ï¼ˆ28ä¸ªå­—èŠ‚ï¼Œ7ä¸ªå­—ï¼‰çš„å­˜å‚¨å•å…ƒä¸­ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134213403.png" alt="image-20241125134213403"></p>
<p>æ ¹æ®ATPCSæ ‡å‡†çš„è§„èŒƒï¼Œ<code>r0</code>é€šå¸¸ç”¨æ¥ä¼ é€’ç¬¬ä¸€ä¸ªå‚æ•°<code>a1</code>ï¼Œ<code>r1</code>é€šå¸¸ç”¨æ¥ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°<code>a2</code>ï¼Œå› æ­¤ä¸Šè¿°æ“ä½œèµ·å§‹å°±æ˜¯å°†å‡½æ•°çš„ä¸¤ä¸ªå…¥å‚ <code>main_label(int argc, const char *argv[])</code> å‹æ ˆ</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125131207660.png" alt="image-20241125131207660" style="zoom:33%;">
<h3 id="han-shu-ju-bu-bian-liang-ya-zhan">å‡½æ•°å±€éƒ¨å˜é‡å‹æ ˆ</h3>
<p>å¯¹åº” <code>int i = 0</code></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125133712296.png" alt="image-20241125133712296"></p>
<p>å…ˆå°†å¸¸é‡ <code>0</code>ä¼ è¾“åˆ°å¯„å­˜å™¨R3ä¸­ï¼ˆè¿™é‡ŒR3ä½œä¸ºé€šç”¨å¯„å­˜å™¨å­˜æ”¾ä¸´æ—¶çš„å¸¸é‡ï¼‰ï¼Œå†é€šè¿‡ <code>STR</code>æŒ‡ä»¤å‹æ ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134430454.png" alt="image-20241125134430454"></p>
<p>åŒæ ·çš„ï¼Œå°†å±€éƒ¨å˜é‡ <code>b</code>å‹æ ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134728492.png" alt="image-20241125134728492"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134805022.png" alt="image-20241125134805022"></p>
<h3 id="ji-yu-zhan-he-ji-cun-qi-zuo-yun-suan">åŸºäºæ ˆå’Œå¯„å­˜å™¨åšè¿ç®—</h3>
<p>æ¥ç€å°±åˆ°äº† <code>b = i++ + ++i;</code>è¿™ä¸€è¡Œä»£ç çš„æ‰§è¡Œï¼Œå®ƒçš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">++</span>i<span class="token punctuation">;</span>
b <span class="token operator">=</span> i <span class="token operator">+</span> i<span class="token punctuation">;</span>
i<span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125135029185.png" alt="image-20241125135029185"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125135429854.png" alt="image-20241125135429854"></p>
<p>æ¥ç€åˆ†æï¼Œæˆ‘ä»¬ä¼šå‘ç°å¤„ç†å™¨çš„è¡Œä¸ºä¸æˆ‘ä»¬åœ¨Cè¯­è¨€çš„é¢„æœŸæ­¥éª¤æ˜¯æœ‰å‡ºå…¥çš„ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºæŒ‡ä»¤é‡æ’åºçš„åŸå› ï¼Œ<mark>ä½†æ— è®ºæ€æ ·é‡æ’åºï¼Œå…¶ç»“æœä¸Cè¯­è¨€çš„é¢„æœŸæ­¥éª¤å¾—å‡ºçš„ç»“æœè¦ä¿æŒä¸€è‡´ã€‚</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125141616740.png" alt="image-20241125141616740"></p>
<h3 id="diao-yong-zi-han-shu-zi-guo-cheng-subroutine">è°ƒç”¨å­å‡½æ•°/å­è¿‡ç¨‹ï¼ˆsubroutineï¼‰</h3>
<p>è¿™ä¸æˆ‘ä»¬ä»æ±‡ç¼–å¼€å§‹è°ƒç”¨ <code>main_label</code>çš„åˆ†ææ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚</p>
<h3 id="han-shu-fan-hui">å‡½æ•°è¿”å›</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€çœ‹ <code>main_label</code>å‡½æ•°çš„æœ€åä¸€è¡Œ <code>return 0;</code>éƒ½åšäº†ä»€ä¹ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125144155014.png" alt="image-20241125144155014"></p>
<p>é¦–å…ˆå°†å¸¸é‡ <code>0</code>ï¼ˆè¿”å›å€¼ï¼‰ä¼ è¾“åˆ°R3è¿›è¡Œä¸´æ—¶ä¿å­˜ï¼›ç„¶åæ ¹æ®ATPCSæ ‡å‡†ï¼Œåº”è¯¥å°†è¿”å›å€¼é€šè¿‡R0æ¥ä¼ é€’ï¼Œå› æ­¤åˆå°†R3ä¼ è¾“åˆ°äº†R0</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125144454192.png" alt="image-20241125144454192" style="zoom:33%;">
<p>æ¥ç€é€šè¿‡ <code>SUB</code>ï¼Œå°†R13(SP)æŒ‡å‘R11(FP)å‘ä¸‹åç§»<code>0xC</code>çš„ä½ç½®ã€‚å¦‚ä¸‹å›¾ï¼ŒSPæŒ‡å‘è¿™ä¸ªä½ç½®åï¼Œç›¸å½“äºå°†å‡½æ•°å‚æ•°å’Œå±€éƒ¨å˜é‡å‡ºæ ˆé‡Šæ”¾äº†ï¼ˆå¯¹åº”å›¾ä¸­ç°è‰²éƒ¨åˆ†ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125144022274.png" alt="image-20241125144022274"></p>
<p>æ¥ç€é€šè¿‡ <code>LDMIA</code>å°†è¿˜ä¿å­˜åœ¨æ ˆä¸­çš„è°ƒç”¨æ–¹çš„<code>LR, SP, FP</code>æ¢å¤åˆ°<code>R14, R13, R11</code>ä¸­</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125145835783.png" alt="image-20241125145835783"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125145806719.png" alt="image-20241125145806719"></p>
<p>æ¥ç€é€šè¿‡ <code>BX</code>æŒ‡ä»¤æ ¹æ®LR(R14)è·³è½¬å›è°ƒç”¨æ–¹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125150802906.png" alt="image-20241125150802906"></p>
<blockquote>
<p>ä¸ºä»€ä¹ˆé€šè¿‡LRå¯ä»¥è·³è½¬å›å»å‘¢ï¼Ÿ</p>
</blockquote>
<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡ <code>bl main_label</code>è·³è½¬çš„ï¼Œ<code>l</code>åç¼€ä¼šå°†å½“å‰PCæš‚å­˜åˆ°LRä¸­ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ <code>BX R14</code>è·³è½¬å›å»ã€‚</p>
<h1 id="hui-bian-yu-c-hun-he-bian-cheng">æ±‡ç¼–ä¸Cæ··åˆç¼–ç¨‹</h1>
<h2 id="hui-bian-yu-yan-diao-yong-c-yu-yan">æ±‡ç¼–è¯­è¨€è°ƒç”¨Cè¯­è¨€</h2>
<h3 id="zai-kan-c-yu-yan-cheng-xu-ru-kou">å†çœ‹Cè¯­è¨€ç¨‹åºå…¥å£</h3>
<blockquote>
<p>Cè¯­è¨€ç¨‹åºçš„å…¥å£æ˜¯mainå‡½æ•°å—ï¼Ÿ</p>
</blockquote>
<p>ç»è¿‡ä¸Šæ–‡çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“Cè¯­è¨€å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¾èµ–æ ˆçš„ï¼Œåœ¨å‡½æ•°ä»£ç çœŸæ­£æ‰§è¡Œå‰éœ€è¦å°†è°ƒç”¨æ–¹ç¨‹åºçŠ¶æ€ç›¸å…³çš„å¯„å­˜å™¨å‹æ ˆä¿æŠ¤ï¼ˆä¾‹å¦‚ <code>LR, SP, FP</code>ï¼‰ã€å‡½æ•°å‚æ•°å‹æ ˆï¼Œå¦‚æœæœ‰å±€éƒ¨å˜é‡åˆ™ä¹Ÿéœ€è¦å‹æ ˆï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¿ç®—æ˜¯åŸºäºæ ˆå’Œå¯„å­˜å™¨çš„é…åˆæ¥å®Œæˆçš„ã€‚</p>
<p>å› æ­¤æ¯ä¸ªå‡½æ•°çš„åœ¨æ‰§è¡Œå‰éƒ½éœ€è¦è®¾ç½®æ ˆçš„èµ·å§‹åœ°å€ï¼ˆSPï¼‰ï¼Œ<code>main</code>å½“ç„¶ä¹Ÿä¸ä¾‹å¤–ï¼Œè€Œè¿™éœ€è¦å€ŸåŠ©æ±‡ç¼–æ¥å®Œæˆã€‚</p>
<h3 id="mei-you-she-zhi-sp-han-shu-wu-fa-zheng-chang-zhi-xing">æ²¡æœ‰è®¾ç½®SPï¼Œå‡½æ•°æ— æ³•æ­£å¸¸æ‰§è¡Œ</h3>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä¸‹ç¨‹åºï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125154604074.png" alt="image-20241125154604074"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x2			
	mov r1,#0x3
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">int add(int a, int b) {
    return a + b;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è°ƒè¯•å‰éœ€è¦å…ˆç¦ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–å¹¶é‡æ–°ç¼–è¯‘ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125154632764.png" alt="image-20241125154632764" style="zoom:33%;">
<p>è°ƒè¯•æ—¶ä¼šå‘ç°ï¼Œå‡½æ•°æ‰§è¡Œå‰çš„å‹æ ˆå¯¼è‡´SPå˜æˆäº†<code>0xFFFFFFF0</code>ï¼Œå¹¶ä¸”æ¥ç€æ­¥è¿›ï¼Œç¨‹åºæ— æ³•æŒ‰ç…§é¢„æœŸç»“æŸã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125155225192.png" alt="image-20241125155225192"></p>
<p>è¿™æ˜¯å› ä¸ºè°ƒç”¨å‡½æ•°æ—¶æ²¡æœ‰è®¾ç½®SPï¼ŒSPé»˜è®¤ä¸ºé›¶å€¼ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125155435833.png" alt="image-20241125155435833"></p>
<h3 id="han-shu-diao-yong-qian-xu-yao-zheng-que-she-zhi-sp">å‡½æ•°è°ƒç”¨å‰éœ€è¦æ­£ç¡®è®¾ç½®SP</h3>
<p>äºæ˜¯æˆ‘ä»¬åœ¨å‡½æ•°è°ƒç”¨å‰ï¼Œè®¾ç½®ä¸€ä¸‹æ ˆæŒ‡é’ˆSPï¼Œå¹¶å°†ç›¸åº”çš„å†…å­˜èŒƒå›´æ˜ å°„ä¸€ä¸‹</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x2			
	mov r1,#0x3
    ldr sp,=0x4000FFF0
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ³¨æ„ï¼Œè¿™é‡Œè¦å°†SPè®¾ç½®ä¸º4çš„æ•´æ•°å€</mark></p>
<p><code>0x40000000,0x4000FFFF</code></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125160139087.png" alt="image-20241125160139087" style="zoom: 50%;">
<p>è°ƒæ•´åå‘ç°å¯ä»¥æ­£å¸¸æ‰§è¡Œåˆ° <code>stop</code>ï¼Œå¹¶ä¸”å‡½æ•°è¿”å›å€¼ <code>2+3=5</code>ä¹Ÿé€šè¿‡R0ä¼ é€’äº†è¿‡æ¥</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125164223712.png" alt="image-20241125164223712"></p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥æ‰“å¼€å‡½æ•°è°ƒç”¨æ ˆçª—å£æ¥æ›´ç›´è§‚åœ°è§‚å¯Ÿå…¥å‚å‹æ ˆçš„è¿‡ç¨‹ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125164542704.png" alt="image-20241125164542704" style="zoom: 50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125165001604.png" alt="image-20241125165001604"></p>
<h2 id="c-yu-yan-nei-qian-hui-bian">Cè¯­è¨€å†…åµŒæ±‡ç¼–</h2>
<h3 id="ge-shi">æ ¼å¼</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125165243027.png" alt="image-20241125165243027" style="zoom: 50%;">
<h3 id="shi-li">ç¤ºä¾‹</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125172126182.png" alt="image-20241125172126182"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x2			
	mov r1,#0x3
    ldr sp,=0x4000FFF0
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    
    <span class="token keyword">asm</span><span class="token punctuation">(</span>
        <span class="token string">"add r0,%1,%2\n"</span>
        <span class="token string">"mov %0,r0\n"</span>
        <span class="token operator">:</span><span class="token string">"=r"</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token operator">:</span><span class="token string">"r"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token operator">:</span><span class="token string">"r0"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>æ³¨æ„ï¼šå¯ä»¥é€šè¿‡%nå¼•ç”¨è¾“å…¥åˆ—è¡¨ã€è¾“å‡ºåˆ—è¡¨ä¸­çš„å¯„å­˜å™¨ï¼Œä»è¾“å‡ºåˆ—è¡¨å¼€å§‹ç¼–å·ï¼Œè¾“å‡ºåˆ—è¡¨çš„ç¼–å·æ¥ç€è¾“å…¥åˆ—è¡¨çš„æœ€åä¸€ä¸ª</p>
</blockquote>
<ul>
<li>
<p>é€šè¿‡ <code>asm</code>å…³é”®å­—å†…åµŒä¸€æ®µæ±‡ç¼–ä»£ç </p>
</li>
<li>
<p><code>:"r"(a), "r"(b)</code>ï¼š<mark>è¾“å…¥åˆ—è¡¨</mark>ï¼Œå£°æ˜å°†Cç¨‹åºä¸­å“ªäº›å˜é‡è¾“å…¥åˆ°å†…åµŒæ±‡ç¼–çš„é€šç”¨å¯„å­˜å™¨ä¸­ï¼ˆå…·ä½“å“ªä¸ªå¯„å­˜å™¨æ˜¯æ— æ³•é¢„çŸ¥çš„ï¼Œå¯ä»¥é€šè¿‡ <code>%</code>è¿›è¡Œå¼•ç”¨ï¼‰ã€‚<mark>å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œåˆ™ç•™ä¸€ä¸ªç©ºçš„å†’å·å³å¯ï¼Œä½†ä¸èƒ½å»æ‰è¯¥è¡Œã€‚</mark></p>
</li>
<li>
<p><code>"add r0,%1,%2\n"</code>ï¼š<mark>æ±‡ç¼–æŒ‡ä»¤</mark>ï¼Œé€šè¿‡ <code>%1</code>ã€<code>%2</code>å¼•ç”¨è¾“å…¥åˆ—è¡¨çš„ä¸­çš„å˜é‡ <code>a</code>ã€<code>b</code>å¯¹åº”çš„å¯„å­˜å™¨ï¼Œå¹¶é€šè¿‡ <code>add</code>æŒ‡ä»¤å°†è¿™ä¸¤ä¸ªå¯„å­˜å™¨ç›¸åŠ ï¼Œç»“æœå­˜å…¥ <code>r0</code>ï¼›<mark>æ³¨æ„ï¼Œæ¢è¡Œæ˜¯ä¸å¯çœç•¥çš„ï¼Œæ ‡ç¤ºè¿™æ¡æŒ‡ä»¤ç»“æŸ</mark></p>
</li>
<li>
<p><code>:"=r"(c)</code>ï¼š<mark>è¾“å‡ºåˆ—è¡¨</mark>ï¼Œå£°æ˜å°†Cç¨‹åºçš„å“ªäº›å˜é‡çš„å€¼ç”±å†…åµŒæ±‡ç¼–è¾“å‡ºã€‚<code>=</code>æ ‡ç¤ºäº†è¯¥æ±‡ç¼–ç»“æŸæ—¶éœ€è¦å°†å¯„å­˜å™¨å†™å…¥å˜é‡ä¸­ã€‚</p>
</li>
<li>
<p><code>"mov %0,r0\n"</code>ï¼š<mark>æ±‡ç¼–æŒ‡ä»¤</mark>ï¼Œå°† <code>r0</code>ä¸­çš„å€¼è¾“å…¥åˆ° <code>%0</code>å¼•ç”¨çš„å¯„å­˜å™¨ä¸­ï¼Œç”±äºå¼•ç”¨ç¼–å·æ˜¯ä»è¾“å‡ºåˆ—è¡¨å¼€å§‹çš„ï¼Œå› æ­¤å¼•ç”¨çš„å°±æ˜¯å˜é‡ <code>c</code>å…³è”çš„å¯„å­˜å™¨</p>
</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125165906124.png" alt="image-20241125165906124"></p>
<p>è°ƒè¯•å‰åˆ«å¿˜äº†æ˜ å°„ä¸‹å†…å­˜ <code>0x40000000,0x4000FFFF</code></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125174751017.png" alt="image-20241125174751017"></p>
<h1 id="volatile-guan-jian-zi">volatileå…³é”®å­—</h1>
<h2 id="gcc-bian-yi-you-hua">gccç¼–è¯‘ä¼˜åŒ–</h2>
<h3 id="shi-li-cheng-xu">ç¤ºä¾‹ç¨‹åº</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125181741845.png" alt="image-20241125181741845"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
    ldr sp,=0x4000FFF0
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> global_a <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> global_b <span class="token operator">=</span> <span class="token number">0x4</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> global_a <span class="token operator">+</span> global_b<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>global_a <span class="token operator">&gt;</span> global_b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="kai-qi-bian-yi-qi-you-hua">å¼€å¯ç¼–è¯‘å™¨ä¼˜åŒ–</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125181830904.png" alt="image-20241125181830904" style="zoom: 50%;">
<h3 id="you-hua-hou-de-hui-bian-zhi-ling-fen-xi">ä¼˜åŒ–åçš„æ±‡ç¼–æŒ‡ä»¤åˆ†æ</h3>
<p>å†…å­˜æ˜ å°„ï¼š<code>0x40000000,0x4000FFFF</code></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125181717824.png" alt="image-20241125181717824"></p>
<p>å¯ä»¥å‘ç°åœ¨æ‰§è¡Œ <code>int c = global_a + global_b;</code>æ—¶ä»å†…å­˜è¯»å– <code>global_a</code>å’Œ <code>global_b</code>çš„å€¼åˆ°<code>R2, R3</code>ä¸­ï¼›ä½†æ˜¯æ‰§è¡Œ <code>if(global_a &gt; global_b)</code>ï¼Œå¹¶æ²¡é‡æ–°ä»å†…å­˜è¯»å– <code>global_a</code>å’Œ <code>global_b</code>çš„å€¼ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æ­¤å‰<code>R2, R3</code>çš„å¿«ç…§ã€‚</p>
<h3 id="bian-yi-qi-you-hua-si-xiang-ji-bi-duan">ç¼–è¯‘å™¨ä¼˜åŒ–æ€æƒ³åŠå¼Šç«¯</h3>
<blockquote>
<p>[!NOTE]</p>
<p>æ ¹æ®å¦ä¸€ç¯‡æ–‡ç« ã€ŠARMæ ¸å­¦ä¹ ï¼ˆä¸‰ï¼‰æŒ‡ä»¤æµæ°´çº¿åˆ†æåŠä¼ªæŒ‡ä»¤ã€‹çš„åˆ†æï¼Œè¿™æ˜¯å› ä¸ºå†…å­˜è®¿é—®æ“ä½œè¾ƒä½ï¼Œæ— æ³•å‘æŒ¥æŒ‡ä»¤æµæ°´çº¿çš„æœ€ä½³æ€§èƒ½ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¼˜åŒ–ä¼šä½¿ç”¨å¯„å­˜å™¨å¿«ç…§ä»£æ›¿å†…å­˜è®¿é—®</p>
</blockquote>
<p>é‚£ä¹ˆåœ¨<mark>å¹¶å‘åœºæ™¯</mark>ä¸‹ï¼Œå¦‚æœåœ¨æ‰§è¡Œ <code>if(global_a &gt; global_b)</code>æ—¶å‘ç”Ÿäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¹¶ä¸”å…¨å±€å˜é‡ <code>global_a</code>å’Œ <code>global_b</code>çš„å€¼è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆ <code>R2, R3</code>ä¸­çš„å€¼å°±ä¸æ˜¯æœ€æ–°çš„ï¼Œå› è€Œä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜ã€‚</p>
<h2 id="volatile-guan-jian-zi-de-zuo-yong">volatileå…³é”®å­—çš„ä½œç”¨</h2>
<blockquote>
<p>[!TIP]</p>
<p><code>volatile</code>å…³é”®å­—çš„è¯­æ„æ˜¯æ˜“å˜çš„ï¼Œè¢«è¯¥å…³é”®å­—ä¿®é¥°çš„å˜é‡åœ¨è¯»å†™æ—¶èƒ½å¤Ÿç¦æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä»è€Œä½¿å¾—æ¯æ¬¡è¯» <code>volatile</code>å˜é‡å¼ºåˆ¶ä»å†…å­˜è¯»å–æœ€æ–°å€¼ï¼ˆåœ¨CPU Cacheæ¨¡å‹ä¸­æ¯æ¬¡å†™ <code>volatile</code>å˜é‡ ä¹Ÿä¼šç«‹å³å°†å¯„å­˜å™¨ä¸­çš„å€¼åˆ·æ–°åˆ°å†…å­˜ï¼‰</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬ç»™ <code>global_a</code>å’Œ <code>global_b</code>åŠ ä¸Š <code>volatile</code>ä¿®é¥°åå†æ¥è°ƒè¯•ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125184042361.png" alt="image-20241125184042361"></p>
<p>å¯ä»¥å‘ç° <code>if(global_a &gt; global_b)</code>æ—¶ï¼Œé€šè¿‡ <code>LDR</code>æŒ‡ä»¤ï¼Œå¼ºåˆ¶ä»å†…å­˜è¯»å€¼äº†ã€‚</p>
<h1 id="the-end">The End</h1>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>ATPCS</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2024/11/12/16107.html</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="create-a-new-post">Create a new post</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="run-server">Run server</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="generate-static-files">Generate static files</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="deploy-to-remote-sites">Deploy to remote sites</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>MDKè°ƒè¯•ä¹‹å¯è§†åŒ–å¤–è®¾&amp;å†…æ ¸å¯„å­˜å™¨</title>
    <url>/2024/11/30/5535.html</url>
    <content><![CDATA[<h1 id="qian-yan">å‰è¨€</h1>
<p>æˆ‘ä»¬ç»å¸¸é‡åˆ°ä¸€ä¸ªå›°æƒ‘ï¼šæ˜æ˜æ„Ÿè§‰ä»£ç æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯è¿è¡Œæ—¶å°±æ˜¯æ— æ³•æŒ‰ç…§é¢„æœŸæ‰§è¡Œã€‚å¹¶ä¸”æŠŠåˆ«äººçš„ç¤ºä¾‹æ‹¿è¿‡æ¥è·‘æ˜¯å¯ä»¥è·‘é€šçš„ï¼Œç¡®è®¤äº†ç¡¬ä»¶æ²¡é—®é¢˜ï¼Œæ¯”å¯¹ä»£ç ä¹Ÿæ‰¾ä¸å‡ºå·®å¼‚ã€‚</p>
<p>è¿™é€šå¸¸æ˜¯å› ä¸ºä¸€äº›ç»†èŠ‚é—®é¢˜å¯¼è‡´çš„ï¼Œè¿™ç±»é—®é¢˜åœ¨é€æ£€æŸ¥æ—¶å¸¸å¸¸å› ä¸ºå½“å±€è€…è¿·éš¾ä»¥å‘ç°ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ä½è¿ç®—ç›¸å…³çš„ç»†èŠ‚é”™è¯¯ä¾‹å¦‚ï¼š</p>
<ul>
<li>
<p>æ¸…é›¶é”™è¯¯ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> GPIO_CRH_MODE10<span class="token punctuation">;</span> <span class="token comment">//æœŸæœ›å°†GPIOAçš„CRHå¯„å­˜å™¨ä¸­çš„PA10å·¥ä½œæ¨¡å¼æ¸…é›¶</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ä¸Šè¿°ä»£ç å°‘äº† <code>~</code>ï¼Œæ­£ç¡®æ“ä½œå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_MODE10<span class="token punctuation">;</span> <span class="token comment">//æœŸæœ›å°†GPIOAçš„CRHå¯„å­˜å™¨ä¸­çš„PA10å·¥ä½œæ¨¡å¼æ¸…é›¶</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>åˆ¤æ–­æŸä¸€ä½æ˜¯å¦ä¸º1ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡æŒ‰ä½ä¸æ¥åˆ¤æ–­æŸä¸€ä½æ˜¯å¦ä¸º1åº”è¯¥æ“ä½œå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h1 id="mdk-wai-she-ji-cun-qi-shi-tu">MDKå¤–è®¾å¯„å­˜å™¨è§†å›¾</h1>
<p>é€šè¿‡MDKçš„DebugåŠŸèƒ½ï¼Œæˆ‘ä»¬å®æ—¶æŸ¥çœ‹ä»£ç æ‰§è¡Œåˆ°æ–­ç”µæ—¶ï¼Œå¯¹åº”çš„å¤–è®¾å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œä»è€Œå¯è§†åŒ–åœ°åˆ†æå“åº”çš„å¯„å­˜å™¨æ˜¯å¦çœŸçš„æŒ‰ç…§é¢„æœŸè¢«è®¾ç½®äº†ï¼Œä»è€Œé¿å…æ£€æŸ¥ä»£ç æ—¶æ— æ³•å¯Ÿè§‰ç»†èŠ‚é”™è¯¯çš„æƒ…å†µã€‚</p>
<p>ä»¥ <code>GPIOA-&gt;CRH &amp;= GPIO_CRH_MODE10</code>ä¸ºä¾‹ï¼Œæˆ‘ä»¬æœŸæœ›é€šè¿‡è¿™ä¸€è¡Œä»£ç å°† <code>CRH</code>å¯„å­˜å™¨çš„ç¬¬8ã€9ä¸ªbitæ¸…é›¶</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130112416568.png" alt="image-20241130112416568"></p>
<h2 id="she-zhi-duan-dian">è®¾ç½®æ–­ç‚¹</h2>
<p>å¯ä»¥åœ¨è¯¥è¡Œä»£ç çš„å·¦ä¾§ç‚¹å‡»æ‰“ä¸Šæ–­ç‚¹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130112531806.png" alt="image-20241130112531806"></p>
<h2 id="fang-xing-cheng-xu-dao-duan-dian-chu-zan-ting">æ”¾è¡Œç¨‹åºåˆ°æ–­ç‚¹å¤„æš‚åœ</h2>
<p>ç„¶åè¿›å…¥Debugæ¨¡å¼å¹¶é€šè¿‡Runä½¿ç¨‹åºåœåœ¨æ–­ç‚¹å¤„ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130112707073.png" alt="image-20241130112707073"></p>
<h2 id="da-kai-wai-she-xi-tong-shi-tu">æ‰“å¼€å¤–è®¾ç³»ç»Ÿè§†å›¾</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130112746427.png" alt="image-20241130112746427"></p>
<h2 id="zhao-dao-dui-ying-ji-cun-qi">æ‰¾åˆ°å¯¹åº”å¯„å­˜å™¨</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130112926649.png" alt="image-20241130112926649" style="zoom:50%;">
<h2 id="bu-jin-bing-cha-kan-dui-ying-ji-cun-qi-shi-fou-an-zhao-yu-qi-bei-she-zhi">æ­¥è¿›å¹¶æŸ¥çœ‹å¯¹åº”å¯„å­˜å™¨æ˜¯å¦æŒ‰ç…§é¢„æœŸè¢«è®¾ç½®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130113658038.png" alt="image-20241130113658038"></p>
<p>æ­¥è¿›åå‘ç°æœ¬æ¥é¢„æœŸåªè®¾ç½®MODE10ï¼Œç»“æœå‘ç°å…¶ä»–çš„bitä½ä¹Ÿè¢«å½±å“äº†ï¼ˆé«˜äº®éƒ¨åˆ†ï¼‰ï¼Œè¯´æ˜æˆ‘ä»¬çš„ä»£ç æœ‰é—®é¢˜</p>
<h1 id="zhi-jie-xiu-gai-ji-cun-qi-bing-sheng-xiao">ç›´æ¥ä¿®æ”¹å¯„å­˜å™¨å¹¶ç”Ÿæ•ˆ</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130115225062.png" alt="image-20241130115225062"></p>
<p>å¦‚ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‹¾é€‰/å–æ¶ˆå‹¾é€‰ï¼ˆç›¸å½“äºODRç½®1/0ï¼‰ï¼Œå¹¶å®æ—¶è§‚å¯ŸLEDçš„å˜åŒ–ã€‚å…¶ä»–å¯„å­˜å™¨ä¸­å¯ç¼–è¾‘çš„åœ°æ–¹åº”è¯¥ä¹Ÿéƒ½æ˜¯å¯ä»¥å®æ—¶æ‰‹åŠ¨ä¿®æ”¹çš„ã€‚</p>
<h1 id="arm-he-xiang-guan-ji-cun-qi">ARMæ ¸ç›¸å…³å¯„å­˜å™¨</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130115446304.png" alt="image-20241130115446304"></p>
]]></content>
      <categories>
        <category>MDK</category>
      </categories>
      <tags>
        <tag>MDK</tag>
        <tag>Debug</tag>
        <tag>å¯„å­˜å™¨å¯è§†åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title>STM32å­˜å‚¨èµ„æºæ‰©å±•ä¹‹FSMC</title>
    <url>/2024/12/09/16017.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><strong>STM32</strong></p>
<ul>
<li>STM32F103å‚è€ƒæ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></li>
<li>STM32103ZEæ•°æ®æ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/datasheet/stm32f103rc.pdf">STM32F103xC, STM32F103xD, STM32F103xE </a></li>
</ul>
<p><strong>FSMCæ‰©å±•SRAM</strong></p>
<ul>
<li><a href="https://www.issi.com/WW/pdf/62WV51216ALL.pdf">SRAM IS62WV51216BLL-55TLI æ•°æ®æ‰‹å†Œ</a></li>
</ul>
<p><strong>FSMCæ‰©å±•LCDæ¨¡ç»„</strong></p>
<ul>
<li>LCDé©±åŠ¨æ¨¡ç»„ï¼šä¸­æ™¯å›­ZJY350IT002</li>
<li>LCDé©±åŠ¨èŠ¯ç‰‡ï¼š<a href="https://www.hpinfotech.ro/ILI9486.pdf">ILI9486</a></li>
</ul>
<p>å­—æ¨¡å–æ¨¡å·¥å…·</p>
<ul>
<li><a href="https://github.com/materone/Arduino/blob/master/TFTToolsDocs/%E6%96%87%E5%AD%97%E5%8F%96%E6%A8%A1%E8%BD%AF%E4%BB%B6(%E8%B5%A0%E9%80%81)/PCtoLCD2002%E5%AE%8C%E7%BE%8E%E7%89%88/PCtoLCD2002.exe">PCtoLCD2002å®Œç¾ç‰ˆ</a></li>
</ul>
<p>å›¾ç‰‡å–æ¨¡å·¥å…·</p>
<ul>
<li><a href="https://www.e-paper-display.com/download_detail/downloadsId=625.html">Image2Lcd Ver3.2</a></li>
</ul>
<h1 id="fsmc-gai-shu">FSMCæ¦‚è¿°</h1>
<p>MCUè‡ªå¸¦çš„FLASHå’ŒSRAMèµ„æºæ˜¯ååˆ†æœ‰é™çš„ï¼Œç›¸æ¯”äºPCæœºçš„å­˜å‚¨ç©ºé—´è€Œè¨€è¦å°çš„å¯æ€œã€‚ä¸€èˆ¬æƒ…å†µå¯¹äºåµŒå…¥å¼åº”ç”¨æ¥è¯´è¿™ç‚¹å­˜å‚¨ç©ºé—´ä¸€èˆ¬ä¹Ÿå°±å¤Ÿç”¨äº†ï¼Œä½†é¿å…ä¸äº†ä¸€äº›<mark>å¤§é‡æ¶ˆè€—å†…å­˜çš„åº”ç”¨</mark>ï¼Œ æ¯”å¦‚è¯´<mark>å›¾åƒå¤„ç†</mark>ã€‚å¯¹äºè¿™ç±»<mark>å¯¹å†…å­˜è¦æ±‚è¾ƒé«˜çš„åº”ç”¨ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦æ‰©å±•ä¸€ä¸ªFLASHæˆ–è€…SRAM</mark>ã€‚STM32æä¾›çš„FSMCå°±æ˜¯ç”¨æ¥å®Œæˆè¿™é¡¹åŠŸèƒ½çš„ã€‚</p>
<p>FSMCï¼ˆFlexible static memory controllerï¼Œçµæ´»çš„é™æ€å­˜å‚¨å™¨æ§åˆ¶å™¨ï¼‰ï¼ŒSTM32å¯ä»¥é€šè¿‡FSMCä¸SRAMã€ROMã€PSRAMã€Nor Flashå’ŒNandFlashå­˜å‚¨å™¨çš„å¼•è„šç›¸è¿ï¼Œä»è€Œè¿›è¡Œæ•°æ®çš„äº¤æ¢ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œ<mark>FSMC åªèƒ½æ‰©å±•é™æ€çš„å†…å­˜ï¼ˆS:staticï¼‰ï¼Œä¸èƒ½æ˜¯åŠ¨æ€çš„å†…å­˜</mark>ï¼Œæ¯”å¦‚ SDRAM å°±ä¸èƒ½æ‰©å±•ã€‚</p>
<p><mark>FSMCæŠŠAHBæ€»çº¿ä¸Šçš„æ•°æ®è½¬æ¢ä¸ºå¯¹åº”å¤–è®¾çš„é€šä¿¡åè®®</mark>ï¼Œ<mark>æ§åˆ¶å¤–è®¾çš„è®¿é—®æ—¶åº</mark>ï¼Œ<mark>ä»¥è‡³äºæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç¨‹åºä¸­å¯»å€è®¿é—®</mark>ã€‚</p>
<h1 id="fsmc-zu-cheng">FSMCç»„æˆ</h1>
<h2 id="gong-neng-kuang-tu">åŠŸèƒ½æ¡†å›¾</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209090941576.png" alt="image-20241209090941576"></p>
<p>FSMCä¸»è¦ç”±4éƒ¨åˆ†ç»„æˆï¼šAHBæ€»çº¿æ¥å£ï¼ˆåŒ…æ‹¬FSMCçš„é…ç½®å¯„å­˜å™¨ï¼‰ã€NORé—ªå­˜/SRAMæ§åˆ¶å™¨ã€NANDé—ªå­˜/PCå¡æ§åˆ¶å™¨ã€å¤–è®¾æ¥å£å››ä¸ªéƒ¨åˆ†æ„æˆã€‚</p>
<p>æœ¬æ¬¡å®éªŒéœ€è¦ç”¨åˆ°çš„å¼•è„šå¦‚ä¸‹ï¼š</p>
<ul>
<li>FSMC_A[25:0]ï¼šåœ°å€æ€»çº¿</li>
<li>FSMC_D[15:0]ï¼šåŒå‘æ•°æ®æ€»çº¿</li>
<li>FSMC_NE[4:1]ï¼šç‰‡é€‰å¼•è„šï¼Œä½ç”µå¹³æœ‰æ•ˆ</li>
<li>FSMC_NOEï¼šè¯»ä½¿èƒ½ï¼Œä½ç”µå¹³æœ‰æ•ˆ</li>
<li>FSMC_NWEï¼šå†™ä½¿èƒ½ï¼Œä½ç”µå¹³æœ‰æ•ˆ</li>
</ul>
<h2 id="ahb-zong-xian-jie-kou">AHBæ€»çº¿æ¥å£</h2>
<p>AHBæ€»çº¿æ¥å£æ˜¯CPUã€DMAç­‰AHBæ€»çº¿ä¸»è®¾å¤‡è®¿é—®FSMCçš„é€šé“ï¼Œå®ƒè´Ÿè´£<mark>æŠŠAHBæ€»çº¿äº‹åŠ¡è½¬æ¢æˆä¸ºå¤–è®¾é€šä¿¡çš„åè®®</mark>ã€‚</p>
<p>AHBæ€»çº¿äº‹åŠ¡çš„è¯·æ±‚å¯ä»¥æ˜¯8ã€16æˆ–è€…32ä½çš„ï¼Œä½†å¤–è®¾å™¨ä»¶çš„æ•°æ®çº¿ä½å®½æ˜¯æ’å®šçš„ã€‚å¦‚æœä¸¤è€…å®½åº¦ç›¸åŒå°±ä¸å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚æœæ€»çº¿äº‹åŠ¡çš„ä½å®½å¤§äºå¤–è®¾çš„ä½å®½ï¼Œé‚£ä¹ˆæ€»çº¿æ¥å£å°†æŠŠæ€»çº¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªè¿ç»­çš„8ä½æˆ–16ä½å½¢å¼è®¿é—®å¤–è®¾ã€‚æˆ‘ä»¬åº”å½“å°½é‡é¿å…æ€»çº¿äº‹åŠ¡å®½åº¦å°äºå¤–è®¾å®½åº¦çš„æƒ…å†µå‡ºç°ï¼Œå› ä¸ºè¿™å°†å¯èƒ½å¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ï¼Œå…·ä½“ä¸å¤–è®¾ç±»å‹æœ‰å…³ç³»ã€‚</p>
<p>é…ç½®å¯„å­˜å™¨åˆ™æè¿°äº†<mark>æ‰©å±•å¤–è®¾çš„å…·ä½“å½¢å¼ã€é€šä¿¡åè®®å’Œæ¥å£å½¢å¼</mark>ã€‚ç”¨äºæ€»çº¿æ¥å£å°†AHBæ€»çº¿äº‹åŠ¡è½¬æ¢ä¸ºå¤–è®¾é€šä¿¡åè®®ï¼Œ é©±åŠ¨NORé—ªå­˜/SRAMæ§åˆ¶å™¨å’ŒNANDé—ªå­˜/PCå¡æ§åˆ¶å™¨ï¼Œè¿›è€Œæ§åˆ¶å¤–è®¾ã€‚</p>
<h2 id="nor-shan-cun-psram-kong-zhi-qi">NORé—ªå­˜/PSRAMæ§åˆ¶å™¨</h2>
<p>NOR/PSRAMå†…å­˜æ§åˆ¶å™¨æ”¯æŒå„ç§åŒæ­¥å’Œå¼‚æ­¥çš„å†…å­˜ã€‚æ‰€è°“<mark>åŒæ­¥å†…å­˜</mark>å°±æ˜¯åœ¨è¯»å†™å†…å­˜çš„æ—¶å€™<mark>éœ€è¦ä¸€ä¸ªåŒæ­¥æ—¶é’Ÿæ¥æŒ‡å¯¼æ•°æ®çš„å‘é€å’Œæ¥æ”¶</mark>ï¼Œ ä¸æˆ‘ä»¬åœ¨ä¸²å£é€šä¿¡ä¸­æåˆ°çš„åŒæ­¥/å¼‚æ­¥é€šä¿¡æ˜¯ä¸€ä¸ªé“ç†ã€‚å¯¹äºåŒæ­¥å†…å­˜ï¼ŒFSMCåªä¼šåœ¨è¯»å†™æ“ä½œçš„æ—¶å€™äº§ç”Ÿé©±åŠ¨æ—¶é’Ÿï¼Œè€Œä¸”å…¶é¢‘ç‡æ˜¯ç³»ç»Ÿæ€»çº¿æ—¶é’Ÿ<mark>HCLKçš„åˆ†é¢‘</mark>ã€‚</p>
<p>NOR/PSRAMæ§åˆ¶å™¨ç”¨äºç”Ÿæˆ<mark>é€‚å½“çš„æ—¶åº</mark>ï¼Œä»¥é©±åŠ¨8ä½ã€16ä½ã€32ä½çš„å¼‚æ­¥SRAMå’ŒROMã€å¼‚æ­¥æˆ–è€…çªå‘æ¨¡å¼çš„PSRAMå’ŒNORé—ªå­˜ã€‚æˆ‘ä»¬é€šè¿‡<mark>é…ç½®å¯„å­˜å™¨</mark>æè¿°<mark>å¤–è®¾çš„ç‰¹å¾å’Œæ—¶åº</mark>åï¼Œæ§åˆ¶å™¨å°±å¯ä»¥ä¸ºæˆ‘ä»¬ç”Ÿæˆå¯¹åº”çš„<mark>é©±åŠ¨æ—¶åº</mark>ã€‚</p>
<h2 id="nand-shan-cun-pc-qia-kong-zhi-qi">NANDé—ªå­˜/PCå¡æ§åˆ¶å™¨</h2>
<p>NAND/PCå¡æ§åˆ¶å™¨ç”¨äºé©±åŠ¨8ä½æˆ–è€…16ä½çš„NANDé—ªå­˜ä»¥åŠ16ä½çš„PCå¡å…¼å®¹è®¾å¤‡ã€‚</p>
<h2 id="wai-she-jie-kou">å¤–è®¾æ¥å£</h2>
<p>ç”¨äºä¸è¦æ‰©å±•å¤–è®¾è”é€šç”¨çš„ã€‚åœ¨æ¥çº¿æ—¶å¿…é¡»æ ¹æ®æ¯ä¸ªå¤–è®¾çš„ç‰¹ç‚¹ï¼Œæ¥è¿›è¡Œåˆé€‚çš„æ¥çº¿ã€‚</p>
<h1 id="wai-bu-she-bei-di-zhi-ying-she">å¤–éƒ¨è®¾å¤‡åœ°å€æ˜ å°„</h1>
<p>ä»FSMCçš„è§’åº¦çœ‹ï¼Œå¯ä»¥æŠŠå¤–éƒ¨å­˜å‚¨å™¨åˆ’åˆ†ä¸ºå›ºå®šå¤§å°ä¸º4ä¸ª256Må­—èŠ‚çš„å­˜å‚¨å—ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209091825457.png" alt="image-20241209091825457"></p>
<p>å­˜å‚¨å—1ç”¨äºè®¿é—®æœ€å¤š4ä¸ªNORé—ªå­˜æˆ–PSRAMå­˜å‚¨è®¾å¤‡ã€‚è¿™ä¸ªå­˜å‚¨åŒºè¢«åˆ’åˆ†ä¸º4ä¸ªNOR/PSRAMåŒºå¹¶æœ‰4ä¸ªä¸“ç”¨çš„ç‰‡é€‰ã€‚å­˜å‚¨å—2å’Œ3ç”¨äºè®¿é—®NANDé—ªå­˜è®¾å¤‡ï¼Œæ¯ä¸ªå­˜å‚¨å—è¿æ¥ä¸€ä¸ªNANDé—ªå­˜ã€‚å­˜å‚¨å—4ç”¨äºè®¿é—®PCå¡è®¾å¤‡ã€‚</p>
<p>æ¯ä¸€ä¸ªå­˜å‚¨å—ä¸Šçš„å­˜å‚¨å™¨ç±»å‹æ˜¯ç”±ç”¨æˆ·åœ¨é…ç½®å¯„å­˜å™¨ä¸­å®šä¹‰çš„ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209092125741.png" alt="image-20241209092125741"></p>
<h1 id="fsmc-kong-zhi-nor-shan-cun-huo-psram-de-shi-xu">FSMCæ§åˆ¶NORé—ªå­˜æˆ–PSRAMçš„æ—¶åº</h1>
<p>FSMC å¤–è®¾æ”¯æŒè¾“å‡ºå¤šç§ä¸åŒçš„æ—¶åºä»¥ä¾¿äºæ§åˆ¶ä¸åŒçš„å­˜å‚¨å™¨ï¼Œå®ƒå…·æœ‰6ç§æ¨¡å¼ï¼š1ï¼ŒAï¼Œ2/Bï¼ŒCï¼ŒDï¼Œå¤ç”¨æ¨¡å¼ã€‚</p>
<p>æ‰€æœ‰ä¿¡å·ç”±å†…éƒ¨æ—¶é’ŸHCLKä¿æŒåŒæ­¥ï¼Œä½†è¯¥æ—¶é’Ÿä¸ä¼šè¾“å‡ºåˆ°å¤–éƒ¨æ‰©å±•çš„å­˜å‚¨å™¨ã€‚FSMCå§‹ç»ˆåœ¨ç‰‡é€‰ä¿¡å·NEå¤±æ•ˆå‰å¯¹æ•°æ®çº¿é‡‡æ ·ï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯ç¬¦åˆå­˜å‚¨å™¨çš„æ•°æ®ä¿æŒæ—¶åºã€‚</p>
<p>æ‰€æœ‰çš„æ§åˆ¶å™¨è¾“å‡ºä¿¡å·åœ¨å†…éƒ¨æ—¶é’Ÿï¼ˆHCLKï¼‰çš„ä¸Šå‡æ²¿å˜åŒ–ï¼Œåœ¨åŒæ­¥å†™æ¨¡å¼ï¼ˆPSRAMï¼‰ä¸‹ï¼Œè¯»å†™çš„æ•°æ®åœ¨å­˜å‚¨å™¨æ—¶é’Ÿï¼ˆCLKï¼‰çš„ä¸‹é™æ²¿å˜åŒ–ã€‚</p>
<p>æˆ‘ä»¬ä»¥è¯»å†™SRAMçš„æ¨¡å¼Aä¸ºä¾‹æ¥ä»‹ç»ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209093534030.png" alt="image-20241209093534030"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209093541612.png" alt="image-20241209093541612"></p>
<p>å½“å†…æ ¸å‘å‡ºè®¿é—®æŸä¸ªæŒ‡å‘å¤–éƒ¨å­˜å‚¨å™¨çš„åœ°å€æ—¶ï¼ŒFSMCå¤–è®¾ä¼š<mark>æ ¹æ®é…ç½®</mark>æ§åˆ¶ä¿¡å·çº¿äº§ç”Ÿæ—¶åºè®¿é—®å­˜å‚¨å™¨ï¼ˆç¡¬ä»¶è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„æ—¶åºï¼‰ï¼Œä¸Šå›¾ä¸­çš„æ˜¯è®¿é—®å¤–éƒ¨ SRAM æ—¶ FSMC å¤–è®¾çš„è¯»å†™æ—¶åºã€‚</p>
<p>åœ¨è¯»æ—¶åºä¸­ï¼Œä¸€ä¸ªå­˜å‚¨å™¨æ“ä½œå‘¨æœŸç”±1ä¸ªåœ°å€å»ºç«‹å‘¨æœŸï¼ˆADDSETï¼‰ï¼Œ1ä¸ªæ•°æ®å»ºç«‹å‘¨æœŸï¼ˆDATASETï¼‰å’Œ2ä¸ªHCLKå‘¨æœŸç»„æˆã€‚</p>
<ul>
<li>åœ¨åœ°å€å»ºç«‹å‘¨æœŸä¸­ï¼Œåœ°å€çº¿å‘å‡ºè¦è®¿é—®çš„åœ°å€ï¼Œæ•°æ®æ©ç ä¿¡å·çº¿æŒ‡ç¤ºå‡ºè¦è¯»å–åœ°å€çš„é«˜ã€ä½å­—èŠ‚éƒ¨åˆ†ï¼Œç‰‡é€‰ä¿¡å·ä½¿èƒ½å­˜å‚¨å™¨èŠ¯ç‰‡</li>
<li>åœ°å€å»ºç«‹å‘¨æœŸç»“æŸåè¯»ä½¿èƒ½ä¿¡å·çº¿å‘å‡ºè¯»ä½¿èƒ½ä¿¡å·ï¼Œæ¥ç€å­˜å‚¨å™¨é€šè¿‡æ•°æ®ä¿¡å·çº¿æŠŠç›®æ ‡æ•°æ®ä¼ è¾“ç»™ FSMCï¼ŒFSMC æŠŠå®ƒäº¤ç»™å†…æ ¸ã€‚</li>
</ul>
<p>å†™æ—¶åºç±»ä¼¼ï¼ŒåŒºåˆ«æ˜¯å®ƒçš„ä¸€ä¸ªå­˜å‚¨å™¨æ“ä½œå‘¨æœŸä»…ç”±1ä¸ªåœ°å€å»ºç«‹å‘¨æœŸï¼ˆADDSETï¼‰å’Œ1ä¸ªæ•°æ®å»ºç«‹å‘¨æœŸï¼ˆDATASTï¼‰ç»„æˆï¼Œä¸”åœ¨æ•°æ®å»ºç«‹å‘¨æœŸæœŸé—´å†™ä½¿èƒ½ä¿¡å·çº¿å‘å‡ºå†™ä¿¡å·ï¼Œæ¥ç€ FSMC æŠŠæ•°æ®é€šè¿‡æ•°æ®çº¿ä¼ è¾“åˆ°å­˜å‚¨å™¨ä¸­ã€‚</p>
<h1 id="fsmc-ying-yong-an-li-kuo-zhan-wai-bu-sram">FSMCåº”ç”¨æ¡ˆä¾‹ï¼šæ‰©å±•å¤–éƒ¨SRAM</h1>
<h2 id="xu-qiu-miao-shu">éœ€æ±‚æè¿°</h2>
<p>ä½¿ç”¨FSMCæ‰©å±•<strong>å¤–éƒ¨SRAM</strong>ã€‚ç„¶åæŠŠå†…å­˜æ•°æ®å­˜å‚¨åˆ°å¤–éƒ¨SRAMä¸­ã€‚</p>
<p>STM32F1 ç³»åˆ—çš„èŠ¯ç‰‡ä¸æ”¯æŒæ‰©å±•SDRAMï¼ˆSTM32F429 ç³»åˆ—æ”¯æŒï¼‰ï¼Œå®ƒä»…æ”¯æŒä½¿ç”¨ FSMC å¤–è®¾æ‰©å±• SRAMã€‚ç”±äºå¼•è„šæ•°é‡çš„é™åˆ¶ï¼Œåªæœ‰ STM32F103ZE æˆ–ä»¥ä¸Šå‹å·çš„èŠ¯ç‰‡æ‰å¯ä»¥æ‰©å±•å¤–éƒ¨ SRAMã€‚</p>
<h2 id="sram-xin-pian-is-62-wv-51216">SRAMèŠ¯ç‰‡IS62WV51216</h2>
<h3 id="yin-jiao-fen-xi">å¼•è„šåˆ†æ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209095609954.png" alt="image-20241209095609954"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209095617710.png" alt="image-20241209095617710"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209095704421.png" alt="image-20241209095704421" style="zoom:50%;">
<p>SRAM çš„æ§åˆ¶æ¯”è¾ƒç®€å•ï¼Œåªè¦æ§åˆ¶ä¿¡å·çº¿ä½¿èƒ½äº†è®¿é—®ï¼Œä»åœ°å€çº¿è¾“å…¥è¦è®¿é—®çš„åœ°å€ï¼Œå³å¯ä» I/O æ•°æ®çº¿å†™å…¥æˆ–è¯»å‡ºæ•°æ®ã€‚</p>
<h3 id="du-cao-zuo-shi-xu-fen-xi">è¯»æ“ä½œæ—¶åºåˆ†æ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209153403455.png" alt="image-20241209153403455"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209152956978.png" alt="image-20241209152956978"></p>
<h3 id="xie-cao-zuo-shi-xu-fen-xi">å†™æ“ä½œæ—¶åºåˆ†æ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209160059962.png" alt="image-20241209160059962"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209153846776.png" alt="image-20241209153846776"></p>
<h2 id="mo-shi-1-kuo-zhan-sram-shi-jian">æ¨¡å¼1æ‰©å±•SRAMå®è·µ</h2>
<h3 id="ying-jian-lian-jie">ç¡¬ä»¶è¿æ¥</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209164452355.png" alt="image-20241209164452355"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209170014723.png" alt="æ•°æ®æ‰‹å†Œå¼•è„šå®šä¹‰"></p>
<h4 id="fsmc-pian-xuan-yin-jiao-amp-di-zhi-ying-she">FSMCç‰‡é€‰å¼•è„š &amp; åœ°å€æ˜ å°„</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209165522561.png" alt="image-20241209165522561"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209165654692.png" alt="image-20241209165654692"></p>
<h3 id="rcc-shi-zhong-shi-neng">RCCæ—¶é’Ÿä½¿èƒ½</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¼€å¯FSMCå’ŒGPIOæ—¶é’Ÿ-DEFG</span>
    RCC<span class="token operator">-&gt;</span>AHBENR <span class="token operator">|=</span> RCC_AHBENR_FSMCEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPDEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPEEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPFEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPGEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="gpio-pei-zhi">GPIOé…ç½®</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209170812776.png" alt="image-20241209170812776" style="zoom: 33%;">
<p>å¦‚ä¸Šï¼Œæ‰€æœ‰æ¶‰åŠåˆ°çš„å¼•è„šé…ç½®ä¸ºå¤ç”¨æ¨æŒ½å³å¯ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 1 é…ç½® A0-A18 åœ°å€ç«¯å£çš„è¾“å‡ºæ¨¡å¼ å¤ç”¨æ¨æŒ½è¾“å‡ºCNF:10 50MHzé€Ÿåº¦ MODE:11*/</span>
    <span class="token comment">/* =============MODE=============== */</span>
    GPIOF<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1 <span class="token operator">|</span>
                   GPIO_CRL_MODE2 <span class="token operator">|</span>
                   GPIO_CRL_MODE3 <span class="token operator">|</span>
                   GPIO_CRL_MODE4 <span class="token operator">|</span>
                   GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE12 <span class="token operator">|</span>
                   GPIO_CRH_MODE13 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span>
                   GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1 <span class="token operator">|</span>
                   GPIO_CRL_MODE2 <span class="token operator">|</span>
                   GPIO_CRL_MODE3 <span class="token operator">|</span>
                   GPIO_CRL_MODE4 <span class="token operator">|</span>
                   GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span>
                   GPIO_CRH_MODE12 <span class="token operator">|</span>
                   GPIO_CRH_MODE13<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* =============CNF=============== */</span>
    GPIOF<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF2_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF3_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF4_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOF<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF2_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF3_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF4_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF12_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF13_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF12_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF13_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF2_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF3_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF4_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF2_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF3_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF4_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF11_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF12_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF13_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF11_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF12_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF13_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
        2 æ•°æ®ç«¯å£ å¤ç”¨æ¨æŒ½è¾“å‡º
            åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå³ä½¿æ•°æ®çº¿è¢«é…ç½®ä¸ºè¾“å‡ºæ¨¡å¼ï¼ŒFSMCæ§åˆ¶å™¨ä»ç„¶èƒ½å¤Ÿç®¡ç†æ•°æ®çº¿çš„æ–¹å‘ï¼Œä½¿å…¶åœ¨éœ€è¦æ—¶æˆä¸ºè¾“å…¥çº¿ã€‚
            è¿™ç§è‡ªåŠ¨åˆ‡æ¢æ˜¯ç”±FSMCæ§åˆ¶å™¨ç¡¬ä»¶ç®¡ç†çš„ï¼Œä¸éœ€è¦è½¯ä»¶å¹²é¢„ã€‚
            å› æ­¤ï¼Œå³ä½¿GPIOé…ç½®ä¸ºå¤ç”¨æ¨æŒ½è¾“å‡ºï¼ŒFSMCä¾ç„¶å¯ä»¥å®ç°è¯»å–æ“ä½œã€‚
    */</span>
    <span class="token comment">/* =============MODE=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span>
                   GPIO_CRH_MODE9 <span class="token operator">|</span>
                   GPIO_CRH_MODE10 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span>
                   GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span>
                   GPIO_CRH_MODE9 <span class="token operator">|</span>
                   GPIO_CRH_MODE10 <span class="token operator">|</span>
                   GPIO_CRH_MODE11 <span class="token operator">|</span>
                   GPIO_CRH_MODE12 <span class="token operator">|</span>
                   GPIO_CRH_MODE13 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span>
                   GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* =============CNF=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF9_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF9_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF7_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF7_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF9_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF11_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF12_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF13_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF9_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF11_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF12_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF13_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3 å…¶ä»–æ§åˆ¶ç«¯å£  å¤ç”¨æ¨æŒ½è¾“å‡º */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE4 <span class="token operator">|</span>
                   GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF4_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF4_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="afio-pei-zhi">AFIOé…ç½®</h3>
<p>FSMCå¯¹å¼•è„šçš„å¤ç”¨åªæœ‰ä¸€å¥—ï¼Œæ²¡æœ‰å¤‡ç”¨çš„é‡æ˜ å°„å¼•è„šï¼Œå› æ­¤AFIOæ— éœ€é¢å¤–é…ç½®ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209165234660.png" alt="image-20241209165234660"></p>
<h3 id="fsmc-bank-jie-gou-ti">FSMC Bankç»“æ„ä½“</h3>
<p>åœ¨è®¿é—®FSMCçš„Bankå¯„å­˜å™¨çš„æ—¶stm32f10x.hå¹¶æ²¡æœ‰ç»™æ‰€æœ‰çš„å¯„å­˜å™¨èµ·åå­—ï¼Œè€Œæ˜¯ç”¨äº†<strong>ä¸€ä¸ªæ•°ç»„</strong>å­˜å‚¨äº†æ‰€æœ‰çš„å¯„å­˜å™¨ã€‚æ¯ä¸ªæ•°ç»„é•¿åº¦ä¸º8ï¼Œè¡¨ç¤ºä¸€å…±å­˜å‚¨äº†8ä¸ªå¯„å­˜å™¨ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    __IO <span class="token class-name">uint32_t</span> BTCR<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> FSMC_Bank1_TypeDef<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209172258808.png" alt="image-20241209172258808"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209173124836.png" alt="image-20241209173124836"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BCR3 =&gt; BTCR[4]</span>
    <span class="token comment">// å¼€å¯å†™ä½¿èƒ½ï¼Œå…è®¸å‘SRAMå†™å…¥æ•°æ®</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR3_WREN<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨æ•°æ®æ€»çº¿å®½åº¦ä¸º16</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR3_MWID<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR3_MWID_0<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨ç±»å‹ä¸ºSRAM</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR3_MTYP<span class="token punctuation">;</span>
    <span class="token comment">// åœ°å€-æ•°æ®å¤ç”¨ä½¿èƒ½ï¼šå…³é—­</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR3_MUXEN<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½å­˜å‚¨å™¨å¯¹åº”çš„Bank</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR3_MBKEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="kong-zhi-ji-cun-qi-bcr-fen-qu-3-bck-3">æ§åˆ¶å¯„å­˜å™¨BCRï¼ˆåˆ†åŒº3-BCK3ï¼‰</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209143356091.png" alt="Mode 1 - SRAM/PSRAM (CRAM)  "></p>
<h3 id="shi-xu-sheng-cheng-ji-cun-qi-btr-fen-qu-3-btr-3">æ—¶åºç”Ÿæˆå¯„å­˜å™¨BTRï¼ˆåˆ†åŒº3-BTR3ï¼‰</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209161414874.png" alt="image-20241209161414874"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209200755382.png" alt="image-20241209200755382"></p>
<p>ç»“åˆè¿™é‡Œçš„STM32å‚è€ƒæ‰‹å†Œä»¥åŠä¹‹å‰å¯¹SRAMè¯»/å†™æ“ä½œçš„æ—¶åºåˆ†æï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ADDSETå’ŒDATASETè¯¥å¦‚ä½•é…ç½®ã€‚</p>
<p>åœ°å€è®¿é—®é˜¶æ®µ</p>
<ul>
<li>SRAMè¯»/å†™æ“ä½œï¼šå¯¹äºåœ°å€è®¿é—®æ—¶é—´/åœ°å€å»ºç«‹æ—¶é—´ï¼Œæœ€å°å€¼å¯ä»¥ä¸º0ï¼Œå› æ­¤ADDSETæˆ‘ä»¬å¯ä»¥é…ç½®ä¸º0.</li>
</ul>
<p>æ•°æ®è®¿é—®é˜¶æ®µ</p>
<ul>
<li>SRAMè¯»æ“ä½œï¼šSRAMè¾“å‡ºä½¿èƒ½è®¿é—®æ—¶é—´æœ€å°å¯ä»¥ä¸º0ï¼Œå¯¹åº”<mark>DATASETå¯ä»¥é…ç½®ä¸º0</mark></li>
<li>SRAMå†™æ“ä½œï¼šå†™ä½¿èƒ½æœ‰æ•ˆç”µå¹³æ—¶é—´æ—¶é—´æœ€å°ä¸º40nsï¼ˆ55nsç‰ˆæœ¬SRAMï¼‰ï¼Œæ ¹æ®STM32F103çš„HCLKé¢‘ç‡72MHzï¼ˆå‘¨æœŸçº¦13.9nsï¼‰ï¼Œå¯¹åº”<mark>DATASETæˆ‘ä»¬å¯ä»¥é…ç½®ä¸º4</mark>ï¼Œå³4ä¸ªHCLKå‘¨æœŸæ»¡è¶³æœ€å°40nsçš„æ—¶åºè¦æ±‚ã€‚å› ä¸ºæ¨¡å¼1æ—¶åºç”Ÿæˆå¯„å­˜å™¨åªæœ‰ä¸€ä¸ªBTRï¼Œå› æ­¤DATASETå¯ä»¥å–æœ€å¤§å€¼4ã€‚ï¼ˆå…¶ä»–æ¨¡å¼éœ€è¦åˆ†å¼€é…ç½®è¯»ã€å†™æ—¶åºå‚æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡BCRä¸­çš„EXTMODä½å’ŒBWTRæ¥å®ç°ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>å¦‚ä¸‹ä»¥55nsè®¿é—®æ—¶é—´ç‰ˆæœ¬çš„SRAMä¸ºä¾‹ï¼ˆIS62WV51216BLL-55TLI  ï¼‰</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209162731600.png" alt="image-20241209162731600"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BTR3 =&gt; BTCR[5]</span>
    <span class="token comment">// åœ°å€è®¿é—®/å»ºç«‹æ—¶é—´ï¼ˆHCLKæ•°é‡ï¼‰é…ç½®ä¸º0ï¼Œå®é™…ä¸º(0+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR3_ADDSET<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®è®¿é—®/å»ºç«‹æ—¶é—´é…ç½®ä¸º4ï¼ˆ4*HCLKï¼‰ï¼Œå®é™…ä¸º(4+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR3_DATAST<span class="token punctuation">;</span>
    <span class="token comment">// 4 =&gt; 0100</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BTR3_DATAST_2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="wan-zheng-dai-ma">å®Œæ•´ä»£ç </h3>
<h4 id="fsmc-h">fsmc.h</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__FSMC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__FSMC_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __FSMC_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="fsmc-c">fsmc.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fsmc.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¼€å¯FSMCå’ŒGPIOæ—¶é’Ÿ-DEFG</span>
    RCC<span class="token operator">-&gt;</span>AHBENR <span class="token operator">|=</span> RCC_AHBENR_FSMCEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPDEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPEEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPFEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPGEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 1 é…ç½® A0-A18 åœ°å€ç«¯å£çš„è¾“å‡ºæ¨¡å¼ å¤ç”¨æ¨æŒ½è¾“å‡ºCNF:10 50MHzé€Ÿåº¦ MODE:11*/</span>
    <span class="token comment">/* =============MODE=============== */</span>
    GPIOF<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1 <span class="token operator">|</span>
                   GPIO_CRL_MODE2 <span class="token operator">|</span>
                   GPIO_CRL_MODE3 <span class="token operator">|</span>
                   GPIO_CRL_MODE4 <span class="token operator">|</span>
                   GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE12 <span class="token operator">|</span>
                   GPIO_CRH_MODE13 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span>
                   GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1 <span class="token operator">|</span>
                   GPIO_CRL_MODE2 <span class="token operator">|</span>
                   GPIO_CRL_MODE3 <span class="token operator">|</span>
                   GPIO_CRL_MODE4 <span class="token operator">|</span>
                   GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span>
                   GPIO_CRH_MODE12 <span class="token operator">|</span>
                   GPIO_CRH_MODE13<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* =============CNF=============== */</span>
    GPIOF<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF2_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF3_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF4_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOF<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF2_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF3_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF4_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF12_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF13_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF12_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF13_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF2_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF3_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF4_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF2_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF3_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF4_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF11_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF12_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF13_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF11_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF12_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF13_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
        2 æ•°æ®ç«¯å£ å¤ç”¨æ¨æŒ½è¾“å‡º
            åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå³ä½¿æ•°æ®çº¿è¢«é…ç½®ä¸ºè¾“å‡ºæ¨¡å¼ï¼ŒFSMCæ§åˆ¶å™¨ä»ç„¶èƒ½å¤Ÿç®¡ç†æ•°æ®çº¿çš„æ–¹å‘ï¼Œä½¿å…¶åœ¨éœ€è¦æ—¶æˆä¸ºè¾“å…¥çº¿ã€‚
            è¿™ç§è‡ªåŠ¨åˆ‡æ¢æ˜¯ç”±FSMCæ§åˆ¶å™¨ç¡¬ä»¶ç®¡ç†çš„ï¼Œä¸éœ€è¦è½¯ä»¶å¹²é¢„ã€‚
            å› æ­¤ï¼Œå³ä½¿GPIOé…ç½®ä¸ºå¤ç”¨æ¨æŒ½è¾“å‡ºï¼ŒFSMCä¾ç„¶å¯ä»¥å®ç°è¯»å–æ“ä½œã€‚
    */</span>
    <span class="token comment">/* =============MODE=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span>
                   GPIO_CRH_MODE9 <span class="token operator">|</span>
                   GPIO_CRH_MODE10 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span>
                   GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span>
                   GPIO_CRH_MODE9 <span class="token operator">|</span>
                   GPIO_CRH_MODE10 <span class="token operator">|</span>
                   GPIO_CRH_MODE11 <span class="token operator">|</span>
                   GPIO_CRH_MODE12 <span class="token operator">|</span>
                   GPIO_CRH_MODE13 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span>
                   GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* =============CNF=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF9_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF9_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF7_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF7_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF9_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF11_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF12_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF13_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF9_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF11_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF12_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF13_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3 å…¶ä»–æ§åˆ¶ç«¯å£  å¤ç”¨æ¨æŒ½è¾“å‡º */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE4 <span class="token operator">|</span>
                   GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF4_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF4_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span>
                   GPIO_CRL_MODE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span>
                   GPIO_CRL_CNF1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span>
                    GPIO_CRL_CNF1_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BCR3 =&gt; BTCR[4]</span>
    <span class="token comment">// å¼€å¯å†™ä½¿èƒ½ï¼Œå…è®¸å‘SRAMå†™å…¥æ•°æ®</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR3_WREN<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨æ•°æ®æ€»çº¿å®½åº¦ä¸º16</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR3_MWID<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR3_MWID_0<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨ç±»å‹ä¸ºSRAM</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR3_MTYP<span class="token punctuation">;</span>
    <span class="token comment">// åœ°å€-æ•°æ®å¤ç”¨ä½¿èƒ½ï¼šå…³é—­</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR3_MUXEN<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½å­˜å‚¨å™¨å¯¹åº”çš„Bank</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR3_MBKEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BTR3 =&gt; BTCR[5]</span>
    <span class="token comment">// åœ°å€è®¿é—®/å»ºç«‹æ—¶é—´ï¼ˆHCLKæ•°é‡ï¼‰é…ç½®ä¸º0ï¼Œå®é™…ä¸º(0+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR3_ADDSET<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®è®¿é—®/å»ºç«‹æ—¶é—´é…ç½®ä¸º4ï¼ˆ4*HCLKï¼‰ï¼Œå®é™…ä¸º(4+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR3_DATAST<span class="token punctuation">;</span>
    <span class="token comment">// 4 =&gt; 0100</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BTR3_DATAST_2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fsmc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// ç¼–è¯‘å™¨å…³é”®å­—ï¼š__attribute__ç”¨äºè®¾ç½®å˜é‡çš„å±æ€§ï¼Œatç”¨äºæŒ‡å®šå­˜æ”¾åœ°å€</span>
<span class="token class-name">uint16_t</span> var1 <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0x68000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> var2 <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0x68000004</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœ°å€å¿…é¡»4å­—èŠ‚å¯¹é½</span>

<span class="token class-name">uint16_t</span> var3<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token comment">// å±€éƒ¨å˜é‡åœ¨æ ˆä¸Šåˆ†é…ï¼Œå…¶åœ°å€ä¸å‡½æ•°æ‰§è¡Œæ—¶çš„æ ˆæŒ‡é’ˆSPæœ‰å…³</span>
    <span class="token class-name">uint16_t</span> var4 <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0x68000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x68000020</span><span class="token punctuation">;</span>

    var1 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    var2 <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    var3 <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    var4 <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"var1 = %d, @%p"</span><span class="token punctuation">,</span> var1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>var1<span class="token punctuation">)</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"var2 = %d, @%p"</span><span class="token punctuation">,</span> var2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>var2<span class="token punctuation">)</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"var3 = %d, @%p"</span><span class="token punctuation">,</span> var3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>var3<span class="token punctuation">)</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"var4 = %d, @%p"</span><span class="token punctuation">,</span> var4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>var4<span class="token punctuation">)</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"p = %d, @%p"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-ku-shi-xian">HALåº“å®ç°</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209214014618.png" alt="image-20241209214014618"></p>
<h1 id="zai-kan-nei-cun-ying-she">å†çœ‹å†…å­˜æ˜ å°„</h1>
<h3 id="sram-di-zhi-xian-jie-kou-25-0">SRAMåœ°å€çº¿æ¥å£[25:0]</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209192818430.png" alt="image-20241209192818430" style="zoom:50%;">
<p>STM32å°†32bit-4Gåœ°å€ç©ºé—´åˆ’åˆ†ä¸ºäº†8ä¸ª<mark>blockå—</mark>ï¼Œå› æ­¤32bitçš„é«˜3ä½å¯ä»¥ä½œä¸º<mark>å—å·</mark>ã€‚</p>
<p>è€Œåœ¨block3å†…ï¼Œåˆå¯ä»¥ä½¿ç”¨ä¸€ä¸ªbitæ¥è¡¨ç¤º<mark>bankï¼ˆå†…å­˜ç»„å·ï¼‰</mark>ã€‚é«˜ä¸‰ä½å›ºå®šä¸º011ï¼Œ0110è¡¨ç¤ºbank1ï¼Œ0111è¡¨ç¤ºbank2ã€‚</p>
<p>åœ¨bank1ä¸­ï¼Œåˆå¯ä»¥ä½¿ç”¨ä¸¤ä½æ¥è¡¨ç¤º<mark>åŒºå·</mark>ï¼Œå¯¹åº”NOR/PSRAM1~4ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209193611218.png" alt="image-20241209193611218"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209194339740.png" alt="image-20241209194339740"></p>
<p>è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆFSMCæ¡†å›¾ä¸­ï¼Œåœ°å€çº¿å¼•è„šåªæœ‰26ä¸ªï¼Œå› ä¸ºé«˜6ä½ï¼ˆblock-3bitï¼Œbank-1bitï¼Œåˆ†åŒº-2bitï¼‰ç”¨äºå®šä½åˆ†åŒºï¼Œä½26bitæ‰ç”¨äºå®šä½å­˜å‚¨å™¨å†…éƒ¨å•å…ƒ</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209194648357.png" alt="image-20241209194648357" style="zoom:50%;">
<h2 id="shu-ju-kuan-du-amp-gao-di-zi-jie-yan-ma">æ•°æ®å®½åº¦ &amp; é«˜/ä½å­—èŠ‚æ©ç </h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209195756530.png" alt="image-20241209195756530"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241209195955072.png" alt="image-20241209195955072"></p>
<h1 id="fsmc-kuo-zhan-lcd-xian-cun">FSMCæ‰©å±•LCDæ˜¾å­˜</h1>
<h2 id="lcd-jie-kou-lei-xing">LCDæ¥å£ç±»å‹</h2>
<p>LCDçš„æ¥å£æœ‰å¤šç§ï¼Œåˆ†ç±»å¾ˆç»†ã€‚ä¸»è¦çœ‹LCDçš„é©±åŠ¨æ–¹å¼å’Œæ§åˆ¶æ–¹å¼ï¼Œç›®å‰å½©è‰²LCDçš„è¿æ¥æ–¹å¼ä¸€èˆ¬æœ‰è¿™ä¹ˆå‡ ç§ï¼šMCUæ¨¡å¼ï¼ŒRGBæ¨¡å¼ï¼ŒSPIæ¨¡å¼ï¼ŒVSYNCæ¨¡å¼ï¼ŒMDDIæ¨¡å¼ï¼ŒDSIæ¨¡å¼ã€‚</p>
<p>ä½†åº”ç”¨æ¯”è¾ƒå¤šçš„å°±æ˜¯MCUæ¨¡å¼å’ŒRGBæ¨¡å¼ã€‚</p>
<h3 id="mcu-mo-shi">MCUæ¨¡å¼</h3>
<p>å› ä¸ºä¸»è¦é’ˆå¯¹å•ç‰‡æœºçš„é¢†åŸŸåœ¨ä½¿ç”¨ï¼Œå› æ­¤å¾—åï¼Œå…¶ä¸»è¦ç‰¹ç‚¹æ˜¯ä»·æ ¼ä¾¿å®œã€‚MCU-LCDæ¥å£çš„æ ‡å‡†æœ¯è¯­æ˜¯Intelæå‡ºçš„<mark>8080æ€»çº¿æ ‡å‡†</mark>ï¼Œå› æ­¤åœ¨å¾ˆå¤šæ–‡æ¡£ä¸­ç”¨ <mark>I80</mark> æ¥æŒ‡MCU-LCDå±ã€‚</p>
<p>å¯¹äºMCUæ¥å£çš„LCMï¼ˆLCD Moduleï¼‰ï¼Œå…¶å†…éƒ¨çš„èŠ¯ç‰‡å°±å«<mark>LCDé©±åŠ¨å™¨</mark>ï¼Œéƒ½<mark>å¸¦GRAMï¼ˆæ˜¾å­˜ï¼‰</mark>ã€‚ä¸»è¦åŠŸèƒ½æ˜¯<mark>å¯¹ä¸»æœºå‘è¿‡çš„æ•°æ®/å‘½ä»¤ï¼Œè¿›è¡Œå˜æ¢ï¼Œå˜æˆæ¯ä¸ªåƒç´ çš„RGBæ•°æ®ï¼Œä½¿ä¹‹åœ¨å±ä¸Šæ˜¾ç¤ºå‡ºæ¥</mark>ã€‚</p>
<h3 id="rgb-mo-shi">RGBæ¨¡å¼</h3>
<p>RGBæ¨¡å¼æ˜¯å¤§å±é‡‡ç”¨è¾ƒå¤šçš„æ¨¡å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”µè„‘æ˜¾ç¤ºå™¨ã€‚</p>
<p>å¯¹äºRGBæ¥å£çš„LCMï¼Œä¸»æœºè¾“å‡ºçš„ç›´æ¥æ˜¯æ¯ä¸ªåƒç´ çš„RGBæ•°æ®ï¼Œä¸éœ€è¦è¿›è¡Œå˜æ¢ï¼ˆGAMMAæ ¡æ­£ç­‰é™¤å¤–ï¼‰ï¼Œå¯¹äºè¿™ç§æ¥å£ï¼Œéœ€è¦åœ¨ä¸»æœºéƒ¨åˆ†æœ‰ä¸ªLCDæ§åˆ¶å™¨(å¹³å¸¸æ‰€è¯´çš„æ˜¾å¡)ï¼Œä»¥äº§ç”ŸRGBæ•°æ®å’Œç‚¹ã€è¡Œã€å¸§åŒæ­¥ä¿¡å·ã€‚</p>
<h2 id="ye-jing-mo-kuai-z-350-it-002">æ¶²æ™¶æ¨¡å—Z350IT002</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210115304883.png" alt="image-20241210115304883"></p>
<p>è¿™é‡Œä½¿ç”¨çš„æ¶²æ™¶æ˜¾ç¤ºæ¨¡å—æ˜¯Z350IT002ã€‚è¿™æ˜¯ä¸€æ¬¾ <mark>TFT LCDï¼ˆè–„è†œæ™¶ä½“ç®¡æ¶²æ™¶æ˜¾ç¤ºå™¨ï¼‰æ¨¡å—</mark>ã€‚TFT LCD ä»¥å…¶ä¼˜ç§€çš„æ˜¾ç¤ºæ€§èƒ½å’Œä½åŠŸè€—ç‰¹æ€§è€Œå¹¿æ³›åº”ç”¨äºå„ç§ç”µå­è®¾å¤‡ã€‚</p>
<p>ï¼ˆ1ï¼‰<strong>åˆ†è¾¨ç‡</strong></p>
<p>æ¨¡å—çš„åˆ†è¾¨ç‡ä¸º 320RGB Ã— 480 ç‚¹é˜µã€‚è¿™æ„å‘³ç€å±å¹•æ¨ªå‘æœ‰ 320 ä¸ªåƒç´ ç‚¹ï¼Œæ¯ä¸ªåƒç´ ç‚¹ç”±çº¢ã€ç»¿ã€è“ä¸‰ç§é¢œè‰²ç»„æˆï¼Œçºµå‘æœ‰ 480 ä¸ªåƒç´ ç‚¹ã€‚è¿™ç§åˆ†è¾¨ç‡é€‚åˆäºæ˜¾ç¤ºæ¸…æ™°çš„å›¾åƒå’Œæ–‡å­—ã€‚</p>
<p>ï¼ˆ2ï¼‰<strong>æ„é€ </strong></p>
<p>å®ƒç”± 960 ä¸ªæºï¼ˆsourceï¼‰å’Œ 480 ä¸ªé—¨ï¼ˆgateï¼‰æ„æˆã€‚æºç”¨äºæ¨ªå‘çš„åƒç´ ç‚¹é©±åŠ¨ï¼Œé—¨ç”¨äºçºµå‘çš„åƒç´ ç‚¹é©±åŠ¨ã€‚è¿™ç§ç»“æ„æœ‰åŠ©äºç²¾ç¡®åœ°æ§åˆ¶æ¯ä¸ªåƒç´ ç‚¹ï¼Œä»è€Œæä¾›æ¸…æ™°çš„å›¾åƒæ˜¾ç¤ºã€‚</p>
<p>ï¼ˆ3ï¼‰<strong>å¾®æ§åˆ¶å™¨æ¥å£</strong></p>
<p>Z350IT002 è®¾è®¡äº†æ˜“äºé€šè¿‡å¾®æ§åˆ¶å™¨è®¿é—®å’Œæ§åˆ¶çš„æ¥å£ã€‚è¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆäºåµŒå…¥å¼ç³»ç»Ÿæˆ–å…¶ä»–éœ€è¦ç›´æ¥ç”±å¾®æ§åˆ¶å™¨æ§åˆ¶æ˜¾ç¤ºå±çš„åº”ç”¨ã€‚</p>
<p>ï¼ˆ4ï¼‰<strong>åº”ç”¨é¢†åŸŸ</strong></p>
<p>è€ƒè™‘åˆ°å…¶å°ºå¯¸å’Œåˆ†è¾¨ç‡ï¼ŒZ350IT002 ç‰¹åˆ«é€‚ç”¨äºä¸­å°å°ºå¯¸çš„æ˜¾ç¤ºéœ€æ±‚ï¼Œå¦‚ä¾¿æºå¼è®¾å¤‡ã€å·¥ä¸šæ§åˆ¶é¢æ¿ã€å°å‹åµŒå…¥å¼ç³»ç»Ÿç­‰ã€‚</p>
<p>ï¼ˆ5ï¼‰<strong>æ˜¾ç¤ºæ•ˆæœ</strong></p>
<p>ä½œä¸ºä¸€æ¬¾ TFT LCDï¼ŒZ350IT002 å¯ä»¥æä¾›è‰¯å¥½çš„é¢œè‰²å¯¹æ¯”åº¦å’Œäº®åº¦ï¼Œé€‚åˆäºéœ€è¦ä¸­ç­‰åˆ†è¾¨ç‡å’Œé«˜è‰²å½©è´¨é‡çš„åº”ç”¨ã€‚</p>
<p>æ€»ä½“è€Œè¨€ï¼ŒZ350IT002 æ˜¯ä¸€æ¬¾é€‚ç”¨äºå¤šç§ä¸­å°å‹ç”µå­è®¾å¤‡çš„TFT LCDæ˜¾ç¤ºæ¨¡å—ï¼Œå…¶æ˜“äºå¾®æ§åˆ¶å™¨é›†æˆçš„ç‰¹ç‚¹ä½¿å…¶æˆä¸ºè®¸å¤šåµŒå…¥å¼åº”ç”¨å’Œå·¥ä¸šäº§å“çš„ç†æƒ³é€‰æ‹©ã€‚</p>
<h2 id="kong-zhi-qi-xin-pian-ili-9486">æ§åˆ¶å™¨èŠ¯ç‰‡ILI9486</h2>
<p>æ¶²æ™¶æ¨¡å—Z350IT002å†…éƒ¨ä½¿ç”¨çš„æ§åˆ¶èŠ¯ç‰‡æ˜¯ï¼š<mark>ILI9486</mark>ã€‚</p>
<p>ILI9486 æ˜¯ä¸€æ¬¾æµè¡Œçš„ LCD æ§åˆ¶å™¨èŠ¯ç‰‡ï¼Œç”± <mark>Ilitek</mark> å…¬å¸ç”Ÿäº§ï¼Œé€šå¸¸ç”¨äºé©±åŠ¨ä¸­å°å°ºå¯¸çš„ TFTï¼ˆè–„è†œæ™¶ä½“ç®¡ï¼‰LCD æ˜¾ç¤ºå±ã€‚</p>
<p>å…·æœ‰320RGBx480ç‚¹çš„åˆ†è¾¨ç‡ã€‚å®ƒåŒ…æ‹¬960é€šé“çš„æºé©±åŠ¨å™¨å’Œ480é€šé“çš„é—¨é©±åŠ¨å™¨ï¼Œä»¥åŠç”¨äº320RGBx480ç‚¹å›¾å½¢æ•°æ®çš„345600å­—èŠ‚GRAMå’Œç”µæºä¾›åº”ç”µè·¯ã€‚</p>
<p>å¦å¤–ILI9486<strong>æ”¯æŒå¤šç§æ¥å£ç±»å‹</strong>ï¼ŒåŒ…æ‹¬ï¼š</p>
<p>ï¼ˆ1ï¼‰å¹¶è¡ŒCPUæ•°æ®æ€»çº¿æ¥å£ï¼Œæ”¯æŒ8ä½ã€9ä½ã€16ä½å’Œ18ä½ã€‚</p>
<p>ï¼ˆ2ï¼‰3çº¿å’Œ4çº¿ä¸²è¡Œå¤–è®¾æ¥å£ï¼ˆSPIï¼‰ã€‚</p>
<p>ï¼ˆ3ï¼‰ç¬¦åˆRGBï¼ˆ16ä½/18ä½ï¼‰æ•°æ®æ€»çº¿ï¼Œç”¨äºè§†é¢‘å›¾åƒæ˜¾ç¤ºã€‚</p>
<p>ï¼ˆ4ï¼‰é«˜é€Ÿä¸²è¡Œæ¥å£ï¼Œæä¾›ä¸€ä¸ªæ•°æ®å’Œæ—¶é’Ÿé€šé“ï¼Œæ”¯æŒæœ€é«˜è¾¾500Mbpsçš„MIPI DSIé“¾è·¯ã€‚</p>
<p>ï¼ˆ5ï¼‰æ”¯æŒMDDIæ¥å£ã€‚</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>æœ¬æ¡ˆä¾‹ä½¿ç”¨çš„èŠ¯ç‰‡æ¥å£å›ºå®šä¸º16ä½çš„å¹¶è¡Œ8080æ¥å£ã€‚</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210115735601.png" alt="image-20241210115735601"></p>
<h2 id="shi-yong-stm-32-de-fsmc-lai-shi-xian-8080-shi-xu">ä½¿ç”¨STM32çš„FSMCæ¥å®ç°8080æ—¶åº</h2>
<p>8080 é€šè®¯æ¥å£æ—¶åºå¯ä»¥ç”± STM32 ä½¿ç”¨æ™®é€š I/O æ¥å£è¿›è¡Œæ¨¡æ‹Ÿï¼Œä½†è¿™æ ·æ•ˆç‡å¤ªä½ï¼ŒSTM32 æä¾›äº†ä¸€ç§ç‰¹åˆ«çš„æ§åˆ¶æ–¹æ³•â€”â€”ä½¿ç”¨ FSMC æ¥å£å®ç° 8080 æ—¶åºã€‚æˆ‘ä»¬åœ¨å‰é¢ä½¿ç”¨CubeMXæ‰©å±•SRAMæ—¶å€™å·²ç»å¯ä»¥çœ‹åˆ°äº†è¿™ç‚¹ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210115908848.png" alt="image-20241210115908848"></p>
<p>æ—¶åºçš„æ§åˆ¶FSMCå¯ä»¥å®Œæˆï¼Œä½†æ˜¯å¦‚ä½•å‘GRAMå†™æ•°æ®ï¼Œå†™ä»€ä¹ˆæ ¼å¼çš„æ•°æ®å‘¢ï¼Ÿ</p>
<p><mark>GRAM</mark>ï¼Œä½œç”¨å¯ä»¥ç†è§£ä¸ºæ˜¾å­˜ï¼Œ GRAM ä¸­<mark>æ¯ä¸ªå­˜å‚¨å•å…ƒéƒ½å¯¹åº”ç€æ¶²æ™¶é¢æ¿çš„ä¸€ä¸ªåƒç´ ç‚¹</mark>ã€‚ä½¿åƒç´ ç‚¹å‘ˆç°ç‰¹å®šçš„é¢œè‰²ï¼Œè€Œå¤šä¸ªåƒç´ ç‚¹ç»„åˆèµ·æ¥å°±æˆä¸ºä¸€ä¸ªä½ æƒ³è¡¨è¾¾çš„ä¸œè¥¿ï¼Œä¸€æ®µæ–‡å­—æˆ–è€…ä¸€å‰¯å›¾ã€‚</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>æŒ‰ç…§æ ‡å‡†çš„æ ¼å¼ï¼Œ16 ä½çš„åƒç´ ç‚¹çš„ä¸‰åŸè‰²æè¿°çš„ä½æ•°ä¸ºR:G:B=5ï¼š6ï¼š5ï¼Œ æè¿°ç»¿è‰²çš„ä½æ•°æ¯”è¾ƒå¤šæ˜¯å› ä¸ºäººçœ¼å¯¹ç»¿è‰²æ›´ä¸ºæ•æ„Ÿã€‚</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210121109948.png" alt="image-20241210121109948"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210121308068.png" alt="image-20241210121308068"></p>
<h1 id="shi-yan-shi-yong-fsmc-kong-zhi-lcd-xian-shi">å®éªŒ-ä½¿ç”¨FSMCæ§åˆ¶LCDæ˜¾ç¤º</h1>
<h2 id="ying-jian-dian-lu-she-ji">ç¡¬ä»¶ç”µè·¯è®¾è®¡</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210121354587.png" alt="image-20241210121354587"></p>
<p>ï¼ˆ1ï¼‰D0-D15æ˜¯16ä½æ•°æ®æ€»çº¿æ¥å£ã€‚åˆ†åˆ«æ¥FSMCçš„D0-D15ã€‚</p>
<p>ï¼ˆ2ï¼‰RSTæ˜¯LCDå¤ä½å¼•è„šï¼Œä½ç”µå¹³å¤ä½ã€‚æ¥LCD-RSTï¼ˆPG15ï¼‰ã€‚</p>
<p>ï¼ˆ3ï¼‰RDæ˜¯è¯»æ§åˆ¶å¼•è„šï¼Œä¸Šå‡æ²¿æ—¶è¯»æ•°æ®ã€‚æ¥FSMC-NOEï¼ˆPD4ï¼‰ã€‚</p>
<p>ï¼ˆ4ï¼‰WRæ˜¯å†™æ§åˆ¶å¼•è„šï¼Œä¸Šå‡æ²¿æ—¶å†™æ•°æ®ã€‚æ¥FSMC-NWEï¼ˆPD5ï¼‰ã€‚</p>
<p>ï¼ˆ5ï¼‰RSæ˜¯æ•°æ®æˆ–å‘½ä»¤é€‰æ‹©å¼•è„šRS=1å†™æ•°æ®ï¼ŒRS=0å†™å‘½ä»¤ã€‚æ¥FSMC-A10ï¼ˆPG0ï¼‰ã€‚</p>
<p>ï¼ˆ6ï¼‰CSæ˜¯ç‰‡é€‰å¼•è„šï¼Œä½ç”µå¹³æœ‰æ•ˆã€‚æ¥FSMC-NE4ï¼ˆPG12ï¼‰ã€‚</p>
<p>ï¼ˆ7ï¼‰LEDAæ˜¯èƒŒå…‰ç”µæºï¼ˆ3.0V-3.4Vï¼‰å¼•è„šã€‚</p>
<p>ï¼ˆ8ï¼‰LEDKæ˜¯èƒŒå…‰äº®åº¦æ§åˆ¶å¼•è„šã€‚é€šè¿‡LCD-BGï¼ˆPB0ï¼‰æ¥é©±åŠ¨MOSç®¡Q5çš„å¯¼é€šç”µæµã€‚å¯ä»¥é€šè¿‡ç»™LCD-BGè¾“å‡ºPWMæ³¢æ¥æ§åˆ¶èƒŒå…‰çš„äº®åº¦ã€‚å ç©ºæ¯”è¶Šå¤§ï¼ŒèƒŒå…‰å°±ä¼šè¶Šäº®ã€‚</p>
<p>ï¼ˆ9ï¼‰YDï¼ŒXLï¼ŒYUï¼ŒXRæ˜¯è§¦æ‘¸å±æ§åˆ¶å¼•è„šã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210152837116.png" alt="ä¸­æ™¯å›­ZJY350IT002 LCDæ¨¡ç»„"></p>
<h2 id="fsmc-xun-zhi">FSMCå¯»å€</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210121607390.png" alt="image-20241210121607390" style="zoom:50%;">
<p>æ‰©å±•LCDçš„æ—¶å€™,ä½¿ç”¨çš„æ˜¯å—1çš„åœ°å€ï¼Œä¸€å…±4*64MB = 256MBï¼Œæ¯éƒ¨åˆ†çš„åœ°å€å¦‚ä¸‹ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210121731878.png" alt="image-20241210121731878" style="zoom:50%;">
<p>æˆ‘ä»¬é€‰æ‹©çš„æ˜¯NE4ï¼Œ æ‰€ä»¥åœ°å€èŒƒå›´æ˜¯ï¼š<code>0X6C00 0000 ~ 0X6FFF FFFF</code>ï¼Œå¯„å­˜å™¨çš„åŸºåœ°å€æ˜¯<code>6C000000</code>ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210121747875.png" alt="image-20241210121747875"></p>
<blockquote>
<p>[!NOTE]</p>
<p>æ³¨æ„ï¼šå½“ä½¿ç”¨16ä½å®½çš„å¤–éƒ¨å­˜å‚¨å™¨æ—¶ï¼Œç”¨HADDR[25:1]è¡¨ç¤ºå¤–éƒ¨çš„FSMC_A[24:0]ï¼Œå†…éƒ¨åœ°å€ç›¸å½“äºå·¦ç§»äº†1ä½ï¼Œæ‰€ä»¥è®¡ç®—åœ°å€çš„æ—¶å€™è¦æ³¨æ„ã€‚</p>
<p>LCDæˆ‘ä»¬é€‰æ‹©çš„æ˜¯16ä½å®½åº¦çš„ï¼Œé€‰æ‹©åœ°å€çº¿æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ˜¯A10æ¥LCDçš„D/CXï¼ˆæ•°æ®/å‘½ä»¤å¼•è„šï¼‰ã€‚</p>
<p>å½“A10=0æ—¶ï¼Œè¡¨ç¤º<strong>å†™å‘½ä»¤</strong>ï¼Œæ‰€ä»¥åœ°å€æ˜¯ï¼š<code>0x6C00 0000</code>ã€‚</p>
<p>å½“A10=1æ—¶ï¼Œè¡¨ç¤º<strong>å†™æ•°æ®</strong>ï¼Œæ‰€ä»¥åœ°å€æ˜¯ï¼š<code>0x6C00 0000 + 1&lt;&lt;11 = 0x6C00 0800</code></p>
</blockquote>
<h2 id="fsmc-chu-shi-hua">FSMCåˆå§‹åŒ–</h2>
<h3 id="fsmc-h-1">fsmc.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__FSMC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__FSMC_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __FSMC_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="fsmc-c-1">fsmc.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fsmc.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¼€å¯FSMCå’ŒGPIOæ—¶é’Ÿ-DEFG</span>
    RCC<span class="token operator">-&gt;</span>AHBENR <span class="token operator">|=</span> RCC_AHBENR_FSMCEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPDEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPEEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPGEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 1 é…ç½® A10 åœ°å€ç«¯å£çš„è¾“å‡ºæ¨¡å¼ å¤ç”¨æ¨æŒ½è¾“å‡ºCNF:10 50MHzé€Ÿåº¦ MODE:11*/</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE0<span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF0_1<span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF0_0<span class="token punctuation">;</span>

    <span class="token comment">/*
        2 æ•°æ®ç«¯å£ å¤ç”¨æ¨æŒ½è¾“å‡º
            åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå³ä½¿æ•°æ®çº¿è¢«é…ç½®ä¸ºè¾“å‡ºæ¨¡å¼ï¼ŒFSMCæ§åˆ¶å™¨ä»ç„¶èƒ½å¤Ÿç®¡ç†æ•°æ®çº¿çš„æ–¹å‘ï¼Œä½¿å…¶åœ¨éœ€è¦æ—¶æˆä¸ºè¾“å…¥çº¿ã€‚
            è¿™ç§è‡ªåŠ¨åˆ‡æ¢æ˜¯ç”±FSMCæ§åˆ¶å™¨ç¡¬ä»¶ç®¡ç†çš„ï¼Œä¸éœ€è¦è½¯ä»¶å¹²é¢„ã€‚
            å› æ­¤ï¼Œå³ä½¿GPIOé…ç½®ä¸ºå¤ç”¨æ¨æŒ½è¾“å‡ºï¼ŒFSMCä¾ç„¶å¯ä»¥å®ç°è¯»å–æ“ä½œã€‚
    */</span>
    <span class="token comment">/* =============MODE=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span> GPIO_CRL_MODE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span> GPIO_CRH_MODE9 <span class="token operator">|</span> GPIO_CRH_MODE10 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span> GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span>
        <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span> GPIO_CRH_MODE9 <span class="token operator">|</span> GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11 <span class="token operator">|</span>
         GPIO_CRH_MODE12 <span class="token operator">|</span> GPIO_CRH_MODE13 <span class="token operator">|</span> GPIO_CRH_MODE14 <span class="token operator">|</span> GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* =============CNF=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span> GPIO_CRL_CNF1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span> GPIO_CRL_CNF1_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span> GPIO_CRH_CNF9_1 <span class="token operator">|</span> GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span> GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span> GPIO_CRH_CNF9_0 <span class="token operator">|</span> GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span> GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF7_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF7_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span> GPIO_CRH_CNF9_1 <span class="token operator">|</span> GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF11_1 <span class="token operator">|</span> GPIO_CRH_CNF12_1 <span class="token operator">|</span> GPIO_CRH_CNF13_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span> GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span> GPIO_CRH_CNF9_0 <span class="token operator">|</span> GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF11_0 <span class="token operator">|</span> GPIO_CRH_CNF12_0 <span class="token operator">|</span> GPIO_CRH_CNF13_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span> GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3 å…¶ä»–æ§åˆ¶ç«¯å£  å¤ç”¨æ¨æŒ½è¾“å‡º */</span>
    <span class="token comment">// NOE NWE PD4 PD5</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE4 <span class="token operator">|</span> GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF4_1 <span class="token operator">|</span> GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF4_0 <span class="token operator">|</span> GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// NE4 PG12</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE12<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF12_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF12_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BCR4 =&gt; BTCR[6]</span>
    <span class="token comment">// å¼€å¯å†™ä½¿èƒ½ï¼Œå…è®¸å‘SRAMå†™å…¥æ•°æ®</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR4_WREN<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨æ•°æ®æ€»çº¿å®½åº¦ä¸º16</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR4_MWID<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR4_MWID_0<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨ç±»å‹ä¸ºSRAM</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR4_MTYP<span class="token punctuation">;</span>
    <span class="token comment">// åœ°å€-æ•°æ®å¤ç”¨ä½¿èƒ½ï¼šå…³é—­</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR4_MUXEN<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½å­˜å‚¨å™¨å¯¹åº”çš„Bank</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR4_MBKEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BTR4 =&gt; BTCR[7]</span>
    <span class="token comment">// åœ°å€è®¿é—®/å»ºç«‹æ—¶é—´ï¼ˆHCLKæ•°é‡ï¼‰é…ç½®ä¸º0ï¼Œå®é™…ä¸º(0+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR4_ADDSET<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®è®¿é—®/å»ºç«‹æ—¶é—´é…ç½®ä¸º3 =&gt; 0011ï¼Œå®é™…ä¸º(3+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR4_DATAST<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BTR4_DATAST_0<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BTR4_DATAST_1<span class="token punctuation">;</span>
    <span class="token comment">// æ€»çº¿è¯»-å†™åˆ‡æ¢ç©ºé—²æ—¶é—´é…ç½®ä¸º0 =&gt; (0+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR4_BUSTURN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="lcd-chu-shi-hua">LCDåˆå§‹åŒ–</h2>
<h3 id="lcd-h">lcd.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__LCD_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LCD_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fsmc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SRAM_BANK4</span> <span class="token expression"><span class="token number">0x6C000000</span></span></span>
<span class="token comment">// PA10ä¸º0ï¼šå‘é€å‘½ä»¤</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_ADDR_CMD</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>SRAM_BANK4<span class="token punctuation">)</span></span></span>
<span class="token comment">// PA10ä¸º1ï¼šå‘é€æ•°æ®ï¼ˆSRAMæ•°æ®æ€»çº¿å®½åº¦ä¸º16æ—¶ï¼ŒFSMCä¼šå°†AHBåœ°å€çº¿[25:1]&gt;&gt;1è¾“å…¥åˆ°SRAMï¼Œå› æ­¤è¿™é‡Œçš„bit12å¯¹åº”FSMCçš„PA10-bit11ï¼‰</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_ADDR_DATA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>SRAM_BANK4 <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x01</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPLAY_W</span> <span class="token expression"><span class="token number">320</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPLAY_H</span> <span class="token expression"><span class="token number">480</span></span></span>


<span class="token comment">//ç”»ç¬”é¢œè‰²</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WHITE</span>         	 <span class="token expression"><span class="token number">0xFFFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLACK</span>         	 <span class="token expression"><span class="token number">0x0000</span>	  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLUE</span>         	 <span class="token expression"><span class="token number">0x001F</span>  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BRED</span>             <span class="token expression"><span class="token number">0XF81F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRED</span> 			 <span class="token expression"><span class="token number">0XFFE0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GBLUE</span>			 <span class="token expression"><span class="token number">0X07FF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RED</span>           	 <span class="token expression"><span class="token number">0xF800</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAGENTA</span>       	 <span class="token expression"><span class="token number">0xF81F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GREEN</span>         	 <span class="token expression"><span class="token number">0x07E0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CYAN</span>          	 <span class="token expression"><span class="token number">0x7FFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">YELLOW</span>        	 <span class="token expression"><span class="token number">0xFFE0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BROWN</span> 			 <span class="token expression"><span class="token number">0XBC40</span> </span><span class="token comment">//æ£•è‰²</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BRRED</span> 			 <span class="token expression"><span class="token number">0XFC07</span> </span><span class="token comment">//æ£•çº¢è‰²</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRAY</span>  			 <span class="token expression"><span class="token number">0X8430</span> </span><span class="token comment">//ç°è‰²</span></span>

<span class="token keyword">void</span> <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// èƒŒå…‰å¼€å…³</span>
<span class="token keyword">void</span> <span class="token function">LCD_BGOn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_BGOff</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åŸºç¡€å‚æ•°é…ç½®</span>
<span class="token keyword">void</span> <span class="token function">LCD_RegConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å†™å‘½ä»¤ã€å­—èŠ‚</span>
<span class="token keyword">void</span> <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è¯»æ•°æ®</span>
<span class="token class-name">uint16_t</span> <span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¯»LCDè®¾å¤‡ID</span>
<span class="token class-name">uint32_t</span> <span class="token function">LCD_ReadId</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è®¾ç½®æ˜¾ç¤ºåŒºåŸŸ</span>
<span class="token keyword">void</span> <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> width<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ¸…å±</span>
<span class="token keyword">void</span> <span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __LCD_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="lcd-c">lcd.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LCD_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPGEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    <span class="token comment">/* LCD å¤ä½å’ŒèƒŒå…‰  é€šç”¨æ¨æŒ½è¾“å‡º MODE=11 CNF=00 */</span>
    <span class="token comment">// PG15 PB0</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE15<span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF15<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE0<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹åŒ–FSMCï¼Œå°†LCDæ˜¾å­˜æ¥å…¥FMSC Bank1 NOR/PSRAM-4</span>
    <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆå§‹åŒ–LCDç‰¹å®šå¼•è„š</span>
    <span class="token function">LCD_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// LCDç¡¬ä»¶å¤ä½åˆå§‹åŒ–ï¼ˆä¸Šç”µåéœ€è¦åˆå§‹åŒ–LCDï¼‰</span>
    <span class="token function">LCD_Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯LCDèƒŒå…‰</span>
    <span class="token function">LCD_BGOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®ä¸€äº›LCDåŸºæœ¬å‚æ•°</span>
    <span class="token function">LCD_RegConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹‰ä½RSTï¼Œåˆå§‹åŒ–LCD</span>
    GPIOG<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR15<span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR15<span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_BGOn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR0<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_BGOff</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR0<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">LCD_RegConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 1. è®¾ç½®ç°é˜¶ç”µå‹ä»¥è°ƒæ•´TFTé¢æ¿çš„ä¼½é©¬ç‰¹æ€§ï¼Œ æ­£æ ¡å‡†ã€‚ä¸€èˆ¬å‡ºå‚å°±è®¾ç½®å¥½äº† */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x89</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x4B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x1B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 2. è®¾ç½®ç°é˜¶ç”µå‹ä»¥è°ƒæ•´TFTé¢æ¿çš„ä¼½é©¬ç‰¹æ€§ï¼Œè´Ÿæ ¡å‡† */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0XE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x1A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x2F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x43</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3.  Adjust Control 3 (F7h)  */</span>
    <span class="token comment">/*LCD_WriteCmd(0XF7);
   LCD_WriteData(0xA9);
   LCD_WriteData(0x51);
   LCD_WriteData(0x2C);
   LCD_WriteData(0x82);*/</span>
    <span class="token comment">/* DSI write DCS command, use loose packet RGB 666 */</span>

    <span class="token comment">/* 4. ç”µæºæ§åˆ¶1*/</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xC0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* æ­£ä¼½é©¬ç”µå‹ */</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* è´Ÿä¼½é©¬ç”µå‹ */</span>

    <span class="token comment">/* 5. ç”µæºæ§åˆ¶2 */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xC1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 6. VCOMæ§åˆ¶ */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0XC5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 7. Frame Rate Control (In Normal Mode/Full Colors) (B1h) */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0xB0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 8.  Display Inversion Control (B4h) ï¼ˆæ­£è´Ÿç”µå‹åè½¬ï¼Œå‡å°‘ç”µç£å¹²æ‰°ï¼‰*/</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 9.  Display Function Control (B6h)  */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0xA2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 10. Entry Mode Set (B7h)  */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0xc6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 11. HS Lanes Control (BEh) */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xBE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 12.  Interface Pixel Format (3Ah) */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x3A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x55</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 0x55 : 16 bits/pixel  */</span>

    <span class="token comment">/* 13. Sleep Out (11h) å…³é—­ä¼‘çœ æ¨¡å¼ */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 14. è®¾ç½®å±å¹•æ–¹å‘å’ŒRGB */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 14. display on */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>LCD_ADDR_CMD <span class="token operator">=</span> cmd<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>LCD_ADDR_DATA <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token class-name">uint16_t</span> <span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span>LCD_ADDR_DATA<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token class-name">uint32_t</span> <span class="token function">LCD_ReadId</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dummy read</span>
    <span class="token class-name">uint32_t</span> lcdId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    lcdId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
    lcdId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
    lcdId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> lcdId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> width<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®åˆ—èŒƒå›´</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Start Column çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// End Column çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®¾ç½®è¡ŒèŒƒå›´</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Start Page çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>y <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// End Page çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DISPLAY_W<span class="token punctuation">,</span> DISPLAY_H<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™å†…å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> count <span class="token operator">=</span> DISPLAY_W <span class="token operator">*</span> DISPLAY_H<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ce-shi-du-qu-lcd-id-amp-zhi-ding-yan-se-qing-ping">æµ‹è¯•â€”â€”è¯»å–LCD ID &amp; æŒ‡å®šé¢œè‰²æ¸…å±</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token class-name">uint32_t</span> lcdId <span class="token operator">=</span> <span class="token function">LCD_ReadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"lcdId = %#x"</span><span class="token punctuation">,</span> lcdId<span class="token punctuation">)</span>

    <span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span>MAGENTA<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hui-zhi-ascii-zi-fu">ç»˜åˆ¶Asciiå­—ç¬¦</h2>
<h3 id="hui-zhi-dan-ge-zi-fu">ç»˜åˆ¶å•ä¸ªå­—ç¬¦</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210195945067.png" alt="image-20241210195945067"></p>
<blockquote>
<p>[!NOTE]</p>
<p>å–æ¨¡è¯´æ˜ï¼šä»ç¬¬ä¸€è¡Œå¼€å§‹å‘å³æ¯å–8ä¸ªç‚¹ä½œä¸ºä¸€ä¸ªå­—èŠ‚ï¼Œå¦‚æœæœ€åä¸è¶³8ä¸ªç‚¹å°±è¡¥æ»¡8ä½ã€‚   å–æ¨¡é¡ºåºæ˜¯ä»ä½åˆ°é«˜ ï¼Œå³ç¬¬ä¸€ä¸ªç‚¹ä½œä¸ºæœ€ä½ä½ã€‚å¦‚<code>*-------</code>å–ä¸º<code>00000001</code>ã€‚</p>
<p>ä»£ç ä¸­ä½¿ç”¨çš„å­—æ¨¡è§é™„å½•ã€‚</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ch<span class="token punctuation">,</span>
                          <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> index <span class="token operator">=</span> ch <span class="token operator">-</span> <span class="token char">' '</span><span class="token punctuation">;</span> <span class="token comment">// å­—ç¬¦åœ¨ç æ ‡ä¸­çš„ç´¢å¼•</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">12</span> <span class="token operator">||</span> height <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>dotMatrix <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">12</span> <span class="token operator">?</span> ascii_1206<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">:</span> ascii_1608<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç”Ÿæˆçš„ç è¡¨ä¸­ï¼Œåˆ—ç¼–ç é‡‡ç”¨é€†åºï¼Œå› æ­¤é€æ¬¡åˆ¤æ–­å­—èŠ‚çš„ä½ä½</span>
            <span class="token class-name">uint8_t</span> colByte <span class="token operator">=</span> dotMatrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>colByte <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                colByte <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">24</span> <span class="token operator">||</span> height <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>dotMatrix <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">12</span> <span class="token operator">?</span> ascii_2412<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">:</span> ascii_3216<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ—ä¸º12æˆ–16ï¼Œå¯¹åº”ä¸¤ä¸ªå­—èŠ‚,å› æ­¤è¦å¾ªç¯çš„å­—èŠ‚æ•°ä¸º (height * 2)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç”Ÿæˆçš„ç è¡¨ä¸­ï¼Œåˆ—ç¼–ç é‡‡ç”¨é€†åºï¼Œå› æ­¤é€æ¬¡åˆ¤æ–­å­—èŠ‚çš„ä½ä½</span>
            <span class="token class-name">uint8_t</span> colByte <span class="token operator">=</span> dotMatrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœå®½åº¦ä¸º24/2=12ï¼Œåˆ™å¥‡æ•°å­—èŠ‚åªå–ä½4ä½</span>
            <span class="token class-name">uint8_t</span> colCount <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">24</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                colCount <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> colCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>colByte <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                colByte <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token class-name">uint32_t</span> lcdId <span class="token operator">=</span> <span class="token function">LCD_ReadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"lcdId = %#x"</span><span class="token punctuation">,</span> lcdId<span class="token punctuation">)</span>

    <span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"display done"</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hui-zhi-zi-fu-chuan">ç»˜åˆ¶å­—ç¬¦ä¸²</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_DisplayAsciiStr</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> width <span class="token operator">=</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> <span class="token char">'\n'</span> <span class="token operator">||</span> x <span class="token operator">+</span> width <span class="token operator">&gt;</span> DISPLAY_W<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            y <span class="token operator">+=</span> height<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                str<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> textColor<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        x <span class="token operator">+=</span> width<span class="token punctuation">;</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">LCD_DisplayAsciiStr</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello World! All is well!\nEnjoy yourself!"</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span>
                    WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hui-zhi-zhong-wen">ç»˜åˆ¶ä¸­æ–‡</h3>
<blockquote>
<p>[!NOTE]</p>
<p>ä»£ç ä¸­å¼•ç”¨çš„å­—æ¨¡è¯·è§é™„å½•ã€‚</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210195222774.png" alt="image-20241210195222774"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_DisplayChinese</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> index<span class="token punctuation">,</span>
                        <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> height<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes <span class="token operator">=</span> chineses<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint8_t</span> colByte <span class="token operator">=</span> bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>colByte <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            colByte <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_DisplayChinese</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> RED<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="hui-zhi-tu-pian">ç»˜åˆ¶å›¾ç‰‡</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210200150934.png" alt="image-20241210200150934"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241210200539162.png" alt="image-20241210200539162"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_DisplayImg</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åƒç´ 240*240ï¼Œæ¯ä¸ªåƒç´ ä½¿ç”¨16bitçœŸå½©æ ¼å¼</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">240</span> <span class="token operator">*</span> <span class="token number">240</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†ç›¸é‚»çš„ä¸¤ä¸ªå­—èŠ‚ç»„è£…ä¸º16bitçœŸå½©æ ¼å¼</span>
        <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>gImage_img<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> gImage_img<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">LCD_DisplayImg(50, 50);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/6c22ee3d8fdf9b3ff1540890307ffb0.jpg" alt="6c22ee3d8fdf9b3ff1540890307ffb0" style="zoom: 33%;">
<h2 id="hui-zhi-ji-he-tu-xing-dian-xian-ju-xing-yuan">ç»˜åˆ¶å‡ ä½•å›¾å½¢â€”â€”ç‚¹/çº¿/çŸ©å½¢/åœ†</h2>
<h3 id="lcd-c-1">lcd.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> w <span class="token operator">*</span> w<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x2<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y2<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                  <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x1 <span class="token operator">==</span> x2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–œç‡ä¸å­˜åœ¨</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> y1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> y2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> i<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> k <span class="token operator">=</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> b <span class="token operator">=</span> y1 <span class="token operator">-</span> k <span class="token operator">*</span> x1<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x <span class="token operator">=</span> x1<span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> x2<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>k <span class="token operator">*</span> x <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawRectangle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x2<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y2<span class="token punctuation">,</span>
                       <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                          <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æåæ ‡æ–¹ç¨‹ x = x0 + rcosÎ¸, y = y0 + rsinÎ¸</span>
    <span class="token comment">// Î¸ =&gt; [0, Ï€/2], Î± =&gt; [0, 90Â°]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> deltaX <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token class-name">uint16_t</span> deltaY <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token comment">// ç¡®å®šå››ä¸ªè±¡é™ä¸­å¯¹åº”çš„ç‚¹</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawSolidCircle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> i<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawSolidCirclePlus</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> deltaX <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token class-name">uint16_t</span> deltaY <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token comment">// é€šè¿‡ç›´çº¿æ¥ç”»åœ†</span>
        <span class="token comment">// ä¸€äºŒè±¡é™çš„ç‚¹è¿çº¿</span>
        <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸‰å››è±¡é™çš„ç‚¹è¿çº¿</span>
        <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// çº¿æ®µä¸¤ç«¯ç«¯ç‚¹é¢œè‰²ï¼ˆåœ†å‘¨é¢œè‰²ï¼‰</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c-1">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> BLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ–œçº¿</span>
<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> GREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å‚çº¿</span>
<span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> BLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// çŸ©å½¢</span>
<span class="token function">LCD_DrawRectangle</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> RED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ç©ºå¿ƒåœ†</span>
<span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> RED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å®å¿ƒåœ†</span>
<span class="token comment">// LCD_DrawSolidCircle(100, 350, 50, 2, BLUE, RED);</span>
<span class="token function">LCD_DrawSolidCirclePlus</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> BLUE<span class="token punctuation">,</span> RED<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="wan-zheng-shi-li-dai-ma">å®Œæ•´ç¤ºä¾‹ä»£ç </h2>
<h3 id="fsmc-h-2">fsmc.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__FSMC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__FSMC_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __FSMC_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="fsmc-c-2">fsmc.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fsmc.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_RCC_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¼€å¯FSMCå’ŒGPIOæ—¶é’Ÿ-DEFG</span>
    RCC<span class="token operator">-&gt;</span>AHBENR <span class="token operator">|=</span> RCC_AHBENR_FSMCEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPDEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPEEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPGEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 1 é…ç½® A10 åœ°å€ç«¯å£çš„è¾“å‡ºæ¨¡å¼ å¤ç”¨æ¨æŒ½è¾“å‡ºCNF:10 50MHzé€Ÿåº¦ MODE:11*/</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE0<span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF0_1<span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF0_0<span class="token punctuation">;</span>

    <span class="token comment">/*
        2 æ•°æ®ç«¯å£ å¤ç”¨æ¨æŒ½è¾“å‡º
            åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå³ä½¿æ•°æ®çº¿è¢«é…ç½®ä¸ºè¾“å‡ºæ¨¡å¼ï¼ŒFSMCæ§åˆ¶å™¨ä»ç„¶èƒ½å¤Ÿç®¡ç†æ•°æ®çº¿çš„æ–¹å‘ï¼Œä½¿å…¶åœ¨éœ€è¦æ—¶æˆä¸ºè¾“å…¥çº¿ã€‚
            è¿™ç§è‡ªåŠ¨åˆ‡æ¢æ˜¯ç”±FSMCæ§åˆ¶å™¨ç¡¬ä»¶ç®¡ç†çš„ï¼Œä¸éœ€è¦è½¯ä»¶å¹²é¢„ã€‚
            å› æ­¤ï¼Œå³ä½¿GPIOé…ç½®ä¸ºå¤ç”¨æ¨æŒ½è¾“å‡ºï¼ŒFSMCä¾ç„¶å¯ä»¥å®ç°è¯»å–æ“ä½œã€‚
    */</span>
    <span class="token comment">/* =============MODE=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span> GPIO_CRL_MODE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span> GPIO_CRH_MODE9 <span class="token operator">|</span> GPIO_CRH_MODE10 <span class="token operator">|</span>
                   GPIO_CRH_MODE14 <span class="token operator">|</span> GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span>
        <span class="token punctuation">(</span>GPIO_CRH_MODE8 <span class="token operator">|</span> GPIO_CRH_MODE9 <span class="token operator">|</span> GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11 <span class="token operator">|</span>
         GPIO_CRH_MODE12 <span class="token operator">|</span> GPIO_CRH_MODE13 <span class="token operator">|</span> GPIO_CRH_MODE14 <span class="token operator">|</span> GPIO_CRH_MODE15<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* =============CNF=============== */</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF0_1 <span class="token operator">|</span> GPIO_CRL_CNF1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF0_0 <span class="token operator">|</span> GPIO_CRL_CNF1_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span> GPIO_CRH_CNF9_1 <span class="token operator">|</span> GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span> GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span> GPIO_CRH_CNF9_0 <span class="token operator">|</span> GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span> GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF7_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF7_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF8_1 <span class="token operator">|</span> GPIO_CRH_CNF9_1 <span class="token operator">|</span> GPIO_CRH_CNF10_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF11_1 <span class="token operator">|</span> GPIO_CRH_CNF12_1 <span class="token operator">|</span> GPIO_CRH_CNF13_1 <span class="token operator">|</span>
                   GPIO_CRH_CNF14_1 <span class="token operator">|</span> GPIO_CRH_CNF15_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOE<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF8_0 <span class="token operator">|</span> GPIO_CRH_CNF9_0 <span class="token operator">|</span> GPIO_CRH_CNF10_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF11_0 <span class="token operator">|</span> GPIO_CRH_CNF12_0 <span class="token operator">|</span> GPIO_CRH_CNF13_0 <span class="token operator">|</span>
                    GPIO_CRH_CNF14_0 <span class="token operator">|</span> GPIO_CRH_CNF15_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3 å…¶ä»–æ§åˆ¶ç«¯å£  å¤ç”¨æ¨æŒ½è¾“å‡º */</span>
    <span class="token comment">// NOE NWE PD4 PD5</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_MODE4 <span class="token operator">|</span> GPIO_CRL_MODE5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRL_CNF4_1 <span class="token operator">|</span> GPIO_CRL_CNF5_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOD<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_CNF4_0 <span class="token operator">|</span> GPIO_CRL_CNF5_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// NE4 PG12</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE12<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF12_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF12_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_BCR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BCR4 =&gt; BTCR[6]</span>
    <span class="token comment">// å¼€å¯å†™ä½¿èƒ½ï¼Œå…è®¸å‘SRAMå†™å…¥æ•°æ®</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR4_WREN<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨æ•°æ®æ€»çº¿å®½åº¦ä¸º16</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR4_MWID<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR4_MWID_0<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®å­˜å‚¨å™¨ç±»å‹ä¸ºSRAM</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR4_MTYP<span class="token punctuation">;</span>
    <span class="token comment">// åœ°å€-æ•°æ®å¤ç”¨ä½¿èƒ½ï¼šå…³é—­</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BCR4_MUXEN<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½å­˜å‚¨å™¨å¯¹åº”çš„Bank</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BCR4_MBKEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FSMC_BTR_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½® BTR4 =&gt; BTCR[7]</span>
    <span class="token comment">// åœ°å€è®¿é—®/å»ºç«‹æ—¶é—´ï¼ˆHCLKæ•°é‡ï¼‰é…ç½®ä¸º0ï¼Œå®é™…ä¸º(0+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR4_ADDSET<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®è®¿é—®/å»ºç«‹æ—¶é—´é…ç½®ä¸º3 =&gt; 0011ï¼Œå®é™…ä¸º(3+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR4_DATAST<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BTR4_DATAST_0<span class="token punctuation">;</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">|=</span> FSMC_BTR4_DATAST_1<span class="token punctuation">;</span>
    <span class="token comment">// æ€»çº¿è¯»-å†™åˆ‡æ¢ç©ºé—²æ—¶é—´é…ç½®ä¸º0 =&gt; (0+1)HCLK</span>
    FSMC_Bank1<span class="token operator">-&gt;</span>BTCR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>FSMC_BTR4_BUSTURN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="lcd-h-1">lcd.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__LCD_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LCD_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fsmc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SRAM_BANK4</span> <span class="token expression"><span class="token number">0x6C000000</span></span></span>
<span class="token comment">// PA10ä¸º0ï¼šå‘é€å‘½ä»¤</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_ADDR_CMD</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>SRAM_BANK4<span class="token punctuation">)</span></span></span>
<span class="token comment">// PA10ä¸º1ï¼šå‘é€æ•°æ®ï¼ˆSRAMæ•°æ®æ€»çº¿å®½åº¦ä¸º16æ—¶ï¼ŒFSMCä¼šå°†AHBåœ°å€çº¿[25:1]&gt;&gt;1è¾“å…¥åˆ°SRAMï¼Œå› æ­¤è¿™é‡Œçš„bit12å¯¹åº”FSMCçš„PA10-bit11ï¼‰</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_ADDR_DATA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>SRAM_BANK4 <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x01</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPLAY_W</span> <span class="token expression"><span class="token number">320</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPLAY_H</span> <span class="token expression"><span class="token number">480</span></span></span>

<span class="token comment">// ç”»ç¬”é¢œè‰²</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WHITE</span> <span class="token expression"><span class="token number">0xFFFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLACK</span> <span class="token expression"><span class="token number">0x0000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLUE</span> <span class="token expression"><span class="token number">0x001F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BRED</span> <span class="token expression"><span class="token number">0XF81F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRED</span> <span class="token expression"><span class="token number">0XFFE0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GBLUE</span> <span class="token expression"><span class="token number">0X07FF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RED</span> <span class="token expression"><span class="token number">0xF800</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAGENTA</span> <span class="token expression"><span class="token number">0xF81F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GREEN</span> <span class="token expression"><span class="token number">0x07E0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CYAN</span> <span class="token expression"><span class="token number">0x7FFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">YELLOW</span> <span class="token expression"><span class="token number">0xFFE0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BROWN</span> <span class="token expression"><span class="token number">0XBC40</span> </span><span class="token comment">// æ£•è‰²</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BRRED</span> <span class="token expression"><span class="token number">0XFC07</span> </span><span class="token comment">// æ£•çº¢è‰²</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRAY</span> <span class="token expression"><span class="token number">0X8430</span>  </span><span class="token comment">// ç°è‰²</span></span>

<span class="token keyword">void</span> <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_BGOn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_BGOff</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_RegConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> <span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint32_t</span> <span class="token function">LCD_ReadId</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> width<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ch<span class="token punctuation">,</span>
                          <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_DisplayAsciiStr</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_DisplayChinese</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> index<span class="token punctuation">,</span>
                        <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_DisplayImg</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x2<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y2<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                  <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawRectangle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x2<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y2<span class="token punctuation">,</span>
                       <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ç©ºå¿ƒåœ†</span>
<span class="token keyword">void</span> <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                          <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å®å¿ƒåœ†</span>
<span class="token keyword">void</span> <span class="token function">LCD_DrawSolidCircle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">LCD_DrawSolidCirclePlus</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                             <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __LCD_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="lcd-c-2">lcd.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token comment">// #include "img.h"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd_font.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LCD_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPGEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    <span class="token comment">/* LCD å¤ä½å’ŒèƒŒå…‰  é€šç”¨æ¨æŒ½è¾“å‡º MODE=11 CNF=00 */</span>
    <span class="token comment">// PG15 PB0</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE15<span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF15<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE0<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹åŒ–FSMCï¼Œå°†LCDæ˜¾å­˜æ¥å…¥FMSC Bank1 NOR/PSRAM-4</span>
    <span class="token function">FSMC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆå§‹åŒ–LCDç‰¹å®šå¼•è„š</span>
    <span class="token function">LCD_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// LCDç¡¬ä»¶å¤ä½åˆå§‹åŒ–ï¼ˆä¸Šç”µåéœ€è¦åˆå§‹åŒ–LCDï¼‰</span>
    <span class="token function">LCD_Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯LCDèƒŒå…‰</span>
    <span class="token function">LCD_BGOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®ä¸€äº›LCDåŸºæœ¬å‚æ•°</span>
    <span class="token function">LCD_RegConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹‰ä½RSTï¼Œåˆå§‹åŒ–LCD</span>
    GPIOG<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR15<span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOG<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR15<span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_BGOn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR0<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_BGOff</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR0<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">LCD_RegConfig</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 1. è®¾ç½®ç°é˜¶ç”µå‹ä»¥è°ƒæ•´TFTé¢æ¿çš„ä¼½é©¬ç‰¹æ€§ï¼Œ æ­£æ ¡å‡†ã€‚ä¸€èˆ¬å‡ºå‚å°±è®¾ç½®å¥½äº† */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x89</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x4B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x1B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 2. è®¾ç½®ç°é˜¶ç”µå‹ä»¥è°ƒæ•´TFTé¢æ¿çš„ä¼½é©¬ç‰¹æ€§ï¼Œè´Ÿæ ¡å‡† */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0XE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x1A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x2F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x43</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3.  Adjust Control 3 (F7h)  */</span>
    <span class="token comment">/*LCD_WriteCmd(0XF7);
   LCD_WriteData(0xA9);
   LCD_WriteData(0x51);
   LCD_WriteData(0x2C);
   LCD_WriteData(0x82);*/</span>
    <span class="token comment">/* DSI write DCS command, use loose packet RGB 666 */</span>

    <span class="token comment">/* 4. ç”µæºæ§åˆ¶1*/</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xC0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* æ­£ä¼½é©¬ç”µå‹ */</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* è´Ÿä¼½é©¬ç”µå‹ */</span>

    <span class="token comment">/* 5. ç”µæºæ§åˆ¶2 */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xC1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 6. VCOMæ§åˆ¶ */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0XC5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 7. Frame Rate Control (In Normal Mode/Full Colors) (B1h) */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0xB0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 8.  Display Inversion Control (B4h) ï¼ˆæ­£è´Ÿç”µå‹åè½¬ï¼Œå‡å°‘ç”µç£å¹²æ‰°ï¼‰*/</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 9.  Display Function Control (B6h)  */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0xA2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 10. Entry Mode Set (B7h)  */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xB7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0xc6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 11. HS Lanes Control (BEh) */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0xBE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 12.  Interface Pixel Format (3Ah) */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x3A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x55</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 0x55 : 16 bits/pixel  */</span>

    <span class="token comment">/* 13. Sleep Out (11h) å…³é—­ä¼‘çœ æ¨¡å¼ */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 14. è®¾ç½®å±å¹•æ–¹å‘å’ŒRGB */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 14. display on */</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>LCD_ADDR_CMD <span class="token operator">=</span> cmd<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>LCD_ADDR_DATA <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token class-name">uint16_t</span> <span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span>LCD_ADDR_DATA<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token class-name">uint32_t</span> <span class="token function">LCD_ReadId</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dummy read</span>
    <span class="token class-name">uint32_t</span> lcdId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    lcdId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
    lcdId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
    lcdId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">LCD_ReadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> lcdId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> width<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®åˆ—èŒƒå›´</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Start Column çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// End Column çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®¾ç½®è¡ŒèŒƒå›´</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Start Page çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>y <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// End Page çš„é«˜ä½å­—èŠ‚ã€ä½ä½å­—èŠ‚</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DISPLAY_W<span class="token punctuation">,</span> DISPLAY_H<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> count <span class="token operator">=</span> DISPLAY_W <span class="token operator">*</span> DISPLAY_H<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ch<span class="token punctuation">,</span>
                          <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> index <span class="token operator">=</span> ch <span class="token operator">-</span> <span class="token char">' '</span><span class="token punctuation">;</span> <span class="token comment">// å­—ç¬¦åœ¨ç æ ‡ä¸­çš„ç´¢å¼•</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">12</span> <span class="token operator">||</span> height <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>dotMatrix <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">12</span> <span class="token operator">?</span> ascii_1206<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">:</span> ascii_1608<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç”Ÿæˆçš„ç è¡¨ä¸­ï¼Œåˆ—ç¼–ç é‡‡ç”¨é€†åºï¼Œå› æ­¤é€æ¬¡åˆ¤æ–­å­—èŠ‚çš„ä½ä½</span>
            <span class="token class-name">uint8_t</span> colByte <span class="token operator">=</span> dotMatrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>colByte <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                colByte <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">24</span> <span class="token operator">||</span> height <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>dotMatrix <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">12</span> <span class="token operator">?</span> ascii_2412<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">:</span> ascii_3216<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ—ä¸º12æˆ–16ï¼Œå¯¹åº”ä¸¤ä¸ªå­—èŠ‚,å› æ­¤è¦å¾ªç¯çš„å­—èŠ‚æ•°ä¸º (height * 2)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç”Ÿæˆçš„ç è¡¨ä¸­ï¼Œåˆ—ç¼–ç é‡‡ç”¨é€†åºï¼Œå› æ­¤é€æ¬¡åˆ¤æ–­å­—èŠ‚çš„ä½ä½</span>
            <span class="token class-name">uint8_t</span> colByte <span class="token operator">=</span> dotMatrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœå®½åº¦ä¸º24/2=12ï¼Œåˆ™å¥‡æ•°å­—èŠ‚åªå–ä½4ä½</span>
            <span class="token class-name">uint8_t</span> colCount <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">==</span> <span class="token number">24</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                colCount <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> colCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>colByte <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                colByte <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DisplayAsciiStr</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> width <span class="token operator">=</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> <span class="token char">'\n'</span> <span class="token operator">||</span> x <span class="token operator">+</span> width <span class="token operator">&gt;</span> DISPLAY_W<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            y <span class="token operator">+=</span> height<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                str<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> textColor<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        x <span class="token operator">+=</span> width<span class="token punctuation">;</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DisplayChinese</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> height<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> index<span class="token punctuation">,</span>
                        <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> height<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes <span class="token operator">=</span> chineses<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint8_t</span> colByte <span class="token operator">=</span> bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>colByte <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            colByte <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DisplayImg</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åƒç´ 240*240ï¼Œæ¯ä¸ªåƒç´ ä½¿ç”¨16bitçœŸå½©æ ¼å¼</span>
    <span class="token comment">//     for (uint32_t i = 0; i &lt; 240 * 240 * 2; i += 2) {</span>
    <span class="token comment">//         // å°†ç›¸é‚»çš„ä¸¤ä¸ªå­—èŠ‚ç»„è£…ä¸º16bitçœŸå½©æ ¼å¼</span>
    <span class="token comment">//         LCD_WriteData((gImage_img[i] &lt;&lt; 8) | gImage_img[i + 1]);</span>
    <span class="token comment">//     }</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_SetArea</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å†™æ˜¾å­˜</span>
    <span class="token function">LCD_WriteCmd</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> w <span class="token operator">*</span> w<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LCD_WriteData</span><span class="token punctuation">(</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x2<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y2<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                  <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x1 <span class="token operator">==</span> x2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–œç‡ä¸å­˜åœ¨</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> y1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> y2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> i<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> k <span class="token operator">=</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> b <span class="token operator">=</span> y1 <span class="token operator">-</span> k <span class="token operator">*</span> x1<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x <span class="token operator">=</span> x1<span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> x2<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>k <span class="token operator">*</span> x <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawRectangle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y1<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x2<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y2<span class="token punctuation">,</span>
                       <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                          <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æåæ ‡æ–¹ç¨‹ x = x0 + rcosÎ¸, y = y0 + rsinÎ¸</span>
    <span class="token comment">// Î¸ =&gt; [0, Ï€/2], Î± =&gt; [0, 90Â°]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> deltaX <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token class-name">uint16_t</span> deltaY <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token comment">// ç¡®å®šå››ä¸ªè±¡é™ä¸­å¯¹åº”çš„ç‚¹</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawSolidCircle</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> i<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LCD_DrawSolidCirclePlus</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> r<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> w<span class="token punctuation">,</span>
                         <span class="token class-name">uint16_t</span> textColor<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a <span class="token operator">&lt;=</span> <span class="token number">90</span><span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> deltaX <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token class-name">uint16_t</span> deltaY <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">3.14</span> <span class="token operator">*</span> a <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
        <span class="token comment">// é€šè¿‡ç›´çº¿æ¥ç”»åœ†</span>
        <span class="token comment">// ä¸€äºŒè±¡é™çš„ç‚¹è¿çº¿</span>
        <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸‰å››è±¡é™çš„ç‚¹è¿çº¿</span>
        <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> bgColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// çº¿æ®µä¸¤ç«¯ç«¯ç‚¹é¢œè‰²ï¼ˆåœ†å‘¨é¢œè‰²ï¼‰</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">+</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">-</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span>x <span class="token operator">-</span> deltaX<span class="token punctuation">,</span> y <span class="token operator">+</span> deltaY<span class="token punctuation">,</span> w<span class="token punctuation">,</span> textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c-2">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token class-name">uint32_t</span> lcdId <span class="token operator">=</span> <span class="token function">LCD_ReadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"lcdId = %#x"</span><span class="token punctuation">,</span> lcdId<span class="token punctuation">)</span>

    <span class="token function">LCD_ClearAll</span><span class="token punctuation">(</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_DisplayAsciiChar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token char">'A'</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LCD_DisplayAsciiStr</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span>
                        <span class="token string">"Hello World! All is well!\nEnjoy yourself!"</span><span class="token punctuation">,</span> MAGENTA<span class="token punctuation">,</span>
                        WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LCD_DisplayChinese</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> RED<span class="token punctuation">,</span> WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// LCD_DisplayImg(50, 50);</span>

    <span class="token function">LCD_DrawPoint</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> BLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ–œçº¿</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> GREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‚çº¿</span>
    <span class="token function">LCD_DrawLine</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> BLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// çŸ©å½¢</span>
    <span class="token function">LCD_DrawRectangle</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> RED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç©ºå¿ƒåœ†</span>
    <span class="token function">LCD_DrawHollowCircle</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> RED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å®å¿ƒåœ†</span>
    <span class="token comment">// LCD_DrawSolidCircle(100, 350, 50, 2, BLUE, RED);</span>
    <span class="token function">LCD_DrawSolidCirclePlus</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> BLUE<span class="token punctuation">,</span> RED<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"display done"</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="zi-mo">å­—æ¨¡</h3>
<ul>
<li>
<p>å­—ç¬¦å­—æ¨¡ï¼š<a href="https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_font.h">https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_font.h</a></p>
</li>
<li>
<p>å›¾ç‰‡å­—æ¨¡ï¼š<a href="https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_img.h">https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_img.h</a></p>
</li>
</ul>
<h1 id="yi-liu-wen-ti">é—ç•™é—®é¢˜</h1>
<h2 id="fsmc-busturn-can-shu">FSMC BUSTURNå‚æ•°</h2>
<h3 id="strong-1-is-62-wv-51216-bll-de-guan-jian-can-shu-strong"><strong>1. IS62WV51216BLL çš„å…³é”®å‚æ•°</strong></h3>
<p>æŸ¥çœ‹ IS62WV51216BLL-55TLI æ•°æ®æ‰‹å†Œå¯çŸ¥ï¼š</p>
<ul>
<li><strong>55ns</strong> è¡¨ç¤ºå…¶æœ€çŸ­çš„è®¿é—®æ—¶é—´ï¼ˆAccess Timeï¼‰ä¸º 55nsã€‚</li>
<li>è¿™æ˜¯ç‰‡é€‰æœ‰æ•ˆåˆ°æ•°æ®æœ‰æ•ˆçš„æ—¶é—´ã€‚</li>
<li>å¯¹äº FSMC é…ç½®ï¼Œå…³é”®å‚æ•°åŒ…æ‹¬ï¼š
<ul>
<li><strong>Address Setup Time (tAS)</strong>ï¼šåœ°å€ç¨³å®šåˆ°å†™/è¯»ä½¿èƒ½çš„æ—¶é—´ã€‚</li>
<li><strong>Data Setup Time (tDS)</strong>ï¼šæ•°æ®å¿…é¡»ä¿æŒç¨³å®šçš„æ—¶é—´ã€‚</li>
<li><strong>Access Time (tACC)</strong>ï¼šä»ç‰‡é€‰æœ‰æ•ˆåˆ°æ•°æ®æœ‰æ•ˆçš„æ—¶é—´ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h3 id="strong-2-fsmc-de-xiang-guan-shi-xu-can-shu-strong"><strong>2. FSMC çš„ç›¸å…³æ—¶åºå‚æ•°</strong></h3>
<p>FSMC æä¾›ä¸€ç³»åˆ—å¯„å­˜å™¨ç”¨äºé…ç½®ä¸å¤–éƒ¨å­˜å‚¨å™¨çš„æ—¶åºï¼š</p>
<ul>
<li><strong>ADDSET</strong>ï¼ˆAddress Setup Timeï¼‰ï¼šåœ°å€ä¿¡å·å»ºç«‹åˆ°ç¬¬ä¸€æ¬¡æ—¶é’Ÿè¾¹æ²¿çš„æ—¶é—´ã€‚</li>
<li><strong>DATAST</strong>ï¼ˆData Setup Timeï¼‰ï¼šæ•°æ®ç¨³å®šæœ‰æ•ˆçš„æ—¶é—´ã€‚</li>
<li><strong>BUSRUN</strong>ï¼ˆBus Turnaround Durationï¼‰ï¼šç”¨äºæ€»çº¿æ–¹å‘åˆ‡æ¢çš„æ—¶é—´ã€‚</li>
<li><strong>CLKDIV</strong>ï¼ˆClock Divide Ratioï¼‰ï¼šå¤–éƒ¨å­˜å‚¨å™¨è®¿é—®çš„æ—¶é’Ÿåˆ†é¢‘ã€‚</li>
<li><strong>ACCMOD</strong>ï¼ˆAccess Modeï¼‰ï¼šè®¿é—®æ¨¡å¼ï¼ŒåŒ…æ‹¬åŒæ­¥/å¼‚æ­¥ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼Œ<strong>BUSRUN</strong> çš„ä½œç”¨æ˜¯ç¡®ä¿åœ¨è¯»/å†™æ–¹å‘åˆ‡æ¢æ—¶ï¼Œæœ‰è¶³å¤Ÿçš„ç­‰å¾…æ—¶é—´ï¼Œé¿å…æ€»çº¿äº‰ç”¨ã€‚</p>
<hr>
<h3 id="strong-3-busrun-de-pei-zhi-si-lu-strong"><strong>3. BUSRUN çš„é…ç½®æ€è·¯</strong></h3>
<h4 id="strong-shi-yong-chang-jing-strong"><strong>ä½¿ç”¨åœºæ™¯</strong></h4>
<ul>
<li>BUSRUN å‚æ•°é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š
<ol>
<li><strong>è¯»/å†™åˆ‡æ¢</strong>ï¼šCPU ä»å†™æ“ä½œåˆ‡æ¢åˆ°è¯»æ“ä½œæ—¶ï¼Œéœ€è¦æ€»çº¿æ–¹å‘åˆ‡æ¢æ—¶é—´ã€‚</li>
<li><strong>å¤šè®¾å¤‡å…±äº«æ€»çº¿</strong>ï¼šå¦‚æœå¤šä¸ªè®¾å¤‡å…±ç”¨ FSMC çš„æ•°æ®æ€»çº¿ï¼Œåˆ‡æ¢æ—¶å¯èƒ½éœ€è¦åŠ å…¥æ—¶é—´ç¼“å†²ã€‚</li>
</ol>
</li>
</ul>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/Snipaste_2024-12-09_21-28-42.png" alt="Snipaste_2024-12-09_21-28-42" style="zoom: 50%;">
<h4 id="strong-dian-xing-qing-kuang-strong"><strong>å…¸å‹æƒ…å†µ</strong></h4>
<p>å¯¹äº IS62WV51216BLL-55TLIï¼š</p>
<ul>
<li>æ–¹å‘åˆ‡æ¢æ—¶é—´é€šå¸¸åœ¨ 10ns ä»¥ä¸‹ã€‚</li>
<li>STM32F103 çš„ HCLK å‡è®¾ä¸º 72MHzï¼ˆå‘¨æœŸçº¦ä¸º 13.88nsï¼‰ã€‚</li>
<li>å› æ­¤ï¼Œ<strong>BUSRUN é€šå¸¸è®¾ç½®ä¸º 1</strong>ï¼ˆå¯¹åº” 1 ä¸ª HCLK å‘¨æœŸï¼‰ã€‚</li>
</ul>
<h1 id="fu-lu">é™„å½•</h1>
<h2 id="lcd-zi-mo">LCDå­—æ¨¡</h2>
<ul>
<li>
<p>å­—ç¬¦å­—æ¨¡ï¼š<a href="https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_font.h">https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_font.h</a></p>
</li>
<li>
<p>å›¾ç‰‡å­—æ¨¡ï¼š<a href="https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_img.h">https://github.com/zanwen/Miscellaneous/blob/main/HexoBlog/lcd_img.h</a></p>
</li>
</ul>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>FSMC</tag>
        <tag>STM32</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸“èŒæ¬è¿å·¥DMA(STM32F103ZE)</title>
    <url>/2024/12/06/62380.html</url>
    <content><![CDATA[<h1 id="dma-jie-shao">DMAä»‹ç»</h1>
<p>ç›´æ¥å­˜å‚¨å™¨å­˜å–ï¼ˆdirect memory accessï¼ŒDMAï¼‰ç”¨æ¥æä¾›åœ¨<mark>å¤–è®¾å’Œå­˜å‚¨å™¨ä¹‹é—´</mark>æˆ–è€…<mark>å­˜å‚¨å™¨å’Œå­˜å‚¨å™¨ä¹‹é—´</mark>çš„é«˜é€Ÿæ•°æ®ä¼ è¾“ã€‚æ— é¡»CPUå¹²é¢„ï¼Œæ•°æ®å¯ä»¥é€šè¿‡DMAå¿«é€Ÿåœ°ç§»åŠ¨ï¼Œè¿™å°±èŠ‚çœäº†CPUçš„èµ„æºæ¥åšå…¶ä»–æ“ä½œã€‚</p>
<p>2ä¸ªDMAæ§åˆ¶å™¨æœ‰12ä¸ªé€šé“ï¼ˆDMA1æœ‰7ä¸ªé€šé“ï¼ŒDMA2æœ‰5ä¸ªé€šé“ï¼‰ï¼Œæ¯ä¸ªé€šé“ä¸“é—¨ç”¨æ¥ç®¡ç†æ¥è‡ªäºä¸€ä¸ªæˆ–å¤šä¸ªå¤–è®¾å¯¹å­˜å‚¨å™¨è®¿é—®çš„è¯·æ±‚ã€‚è¿˜æœ‰ä¸€ä¸ªä»²è£å™¨æ¥åè°ƒå„ä¸ªDMAè¯·æ±‚çš„ä¼˜å…ˆæƒã€‚</p>
<p>DMAæ§åˆ¶å™¨å’ŒCortexâ„¢-M3æ ¸å¿ƒå…±äº«ç³»ç»Ÿæ•°æ®æ€»çº¿ï¼Œæ‰§è¡Œç›´æ¥å­˜å‚¨å™¨æ•°æ®ä¼ è¾“ã€‚å½“CPUå’ŒDMAåŒæ—¶è®¿é—®ç›¸åŒçš„ç›®æ ‡ï¼ˆRAMæˆ–å¤–è®¾ï¼‰æ—¶ï¼ŒDMAè¯·æ±‚ä¼šæš‚åœCPUè®¿é—®ç³»ç»Ÿæ€»çº¿è¾¾è‹¥å¹²ä¸ªå‘¨æœŸï¼Œæ€»çº¿ä»²è£å™¨æ‰§è¡Œå¾ªç¯è°ƒåº¦ï¼Œä»¥ä¿è¯CPUè‡³å°‘å¯ä»¥å¾—åˆ°ä¸€åŠçš„ç³»ç»Ÿæ€»çº¿ï¼ˆå­˜å‚¨å™¨æˆ–å¤–è®¾ï¼‰å¸¦å®½ã€‚</p>
<p>è¦æ³¨æ„çš„æ˜¯DMA2åªå­˜åœ¨äºå¤§å®¹é‡äº§å“å’Œäº’è”å‹äº§å“ä¸­ã€‚</p>
<h2 id="dma-kuang-tu">DMAæ¡†å›¾</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206225250686.png" alt="image-20241206225250686"></p>
<h2 id="dma-qing-qiu">DMAè¯·æ±‚</h2>
<p>å¦‚æœå¤–è®¾è¦æƒ³é€šè¿‡DMAæ¥ä¼ è¾“æ•°æ®ï¼Œå¿…é¡»å…ˆç»™DMAæ§åˆ¶å™¨å‘é€DMAè¯·æ±‚ï¼ŒDMAæ§åˆ¶å™¨æ”¶åˆ°è¯·æ±‚ä¿¡å·ä¹‹åï¼Œæ§åˆ¶å™¨ä¼šç»™å¤–è®¾ä¸€ä¸ªåº”ç­”ä¿¡å·ï¼Œå½“å¤–è®¾å¾—åˆ°æ§åˆ¶å™¨çš„åº”ç­”ä¿¡å·åï¼Œå¤–è®¾ä¼šç«‹å³é‡Šæ”¾å®ƒçš„è¯·æ±‚ã€‚</p>
<p>DMAæœ‰DMA1å’ŒDMA2ä¸¤ä¸ªæ§åˆ¶å™¨ï¼ŒDMA1æœ‰7ä¸ªé€šé“ï¼ŒDMA2æœ‰5ä¸ªé€šé“ï¼Œä¸åŒDMAæ§åˆ¶å™¨çš„é€šé“å¯¹åº”ç€ä¸åŒçš„å¤–è®¾è¯·æ±‚ï¼Œè¿™å†³å®šäº†æˆ‘ä»¬åœ¨è½¯ä»¶ç¼–ç¨‹ä¸Šè¯¥æ€ä¹ˆè®¾ç½®ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206225359841.png" alt="image-20241206225359841"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/Snipaste_2024-12-06_22-54-12.png" alt=""></p>
<h2 id="dma-tong-dao">DMAé€šé“</h2>
<p>DMAå…·æœ‰12ä¸ªç‹¬ç«‹å¯ç¼–ç¨‹çš„é€šé“ï¼Œå…¶ä¸­ DMA1æœ‰7ä¸ªé€šé“ï¼ŒDMA2æœ‰5ä¸ªé€šé“ï¼Œæ¯ä¸ªé€šé“å¯¹åº”ä¸åŒçš„å¤–è®¾çš„DMAè¯·æ±‚ã€‚è™½ç„¶æ¯ä¸ªé€šé“å¯ä»¥æ¥æ”¶å¤šä¸ªå¤–è®¾çš„è¯·æ±‚ï¼Œä½†æ˜¯<strong>åŒä¸€æ—¶é—´åªèƒ½æ¥æ”¶ä¸€ä¸ª</strong>ï¼Œä¸èƒ½åŒæ—¶æ¥æ”¶å¤šä¸ªã€‚</p>
<h2 id="zhong-cai-qi">ä»²è£å™¨</h2>
<p>å½“å‘ç”Ÿå¤šä¸ªDMAé€šé“è¯·æ±‚æ—¶ï¼Œå°±æ„å‘³ç€æœ‰å…ˆåå“åº”å¤„ç†çš„é¡ºåºé—®é¢˜ï¼Œè¿™ä¸ªå°±ç”±ä»²è£å™¨ç®¡ç†ã€‚ä»²è£å™¨ç®¡ç†DMAé€šé“è¯·æ±‚åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚</p>
<p>ç¬¬ä¸€é˜¶æ®µå±äºè½¯ä»¶é˜¶æ®µï¼Œå¯ä»¥åœ¨DMA_CCRxå¯„å­˜å™¨ä¸­è®¾ç½®ï¼Œæœ‰4ä¸ªç­‰çº§ï¼šéå¸¸é«˜ã€é«˜ã€ä¸­å’Œä½å››ä¸ªä¼˜å…ˆçº§ã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µå±äºç¡¬ä»¶é˜¶æ®µï¼Œå¦‚æœä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„DMAé€šé“è¯·æ±‚è®¾ç½®çš„ä¼˜å…ˆçº§ä¸€æ ·ï¼Œåˆ™ä»–ä»¬ä¼˜å…ˆçº§å–å†³äºé€šé“ç¼–å·ï¼Œç¼–å·è¶Šä½ä¼˜å…ˆæƒè¶Šé«˜ï¼Œæ¯”å¦‚é€šé“ 1 é«˜äºé€šé“ 2ã€‚</p>
<p>åœ¨å¤§å®¹é‡äº§å“å’Œäº’è”å‹äº§å“ä¸­ï¼ŒDMA1æ§åˆ¶å™¨æ‹¥æœ‰é«˜äºDMA2æ§åˆ¶å™¨çš„ä¼˜å…ˆçº§ã€‚</p>
<h2 id="chuan-shu-fang-xiang">ä¼ è¾“æ–¹å‘</h2>
<p>å­˜å‚¨å™¨åˆ°å¤–è®¾ï¼Œå¤–è®¾åˆ°å­˜å‚¨å™¨ï¼Œå­˜å‚¨å™¨åˆ°å­˜å‚¨å™¨ã€‚è¿™é‡Œçš„å­˜å‚¨å™¨æŒ‡çš„æ˜¯ROMå’ŒRAMã€‚æ³¨æ„DMAæ²¡æœ‰åŠæ³•æŠŠæ•°æ®ä»RAMä¼ è¾“åˆ°ROMï¼ˆflashï¼‰ã€‚</p>
<h1 id="shi-yan-rom-dao-ram">å®éªŒ-ROMåˆ°RAM</h1>
<h2 id="xu-qiu">éœ€æ±‚</h2>
<p>ä½¿ç”¨å¯„å­˜å™¨æ“ä½œæŠŠROMä¸­çš„æ•°æ®é€šè¿‡DMAä¼ è¾“åˆ°RAMï¼Œç„¶åæŠŠæ•°æ®é€šè¿‡printfå‘é€åˆ°ä¸²å£éªŒè¯æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>DMAä¼ è¾“ä¸æ¶‰åŠå¤–è®¾ï¼Œæ‰€ä»¥é€šé“éšä¾¿é€‰ã€‚æˆ‘ä»¬é€‰DMA1çš„1é€šé“ã€‚</p>
<h2 id="ji-cun-qi-fen-xi">å¯„å­˜å™¨åˆ†æ</h2>
<h3 id="rcc-shi-zhong">RCCæ—¶é’Ÿ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206230728038.png" alt="image-20241206230728038"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206230802590.png" alt="image-20241206230802590"></p>
<h3 id="chuan-shu-fang-xiang-1">ä¼ è¾“æ–¹å‘</h3>
<p><img src="C:%5CUsers%5C86157%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20241206231014436.png" alt="image-20241206231014436"></p>
<blockquote>
<p>[!NOTE]</p>
<p>å¯ä»¥å°†ROMå½“åšå¤–è®¾</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206231212616.png" alt="image-20241206231212616"></p>
<h3 id="yuan-mu-biao-de-ji-di-zhi">æº/ç›®æ ‡çš„åŸºåœ°å€</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206232727151.png" alt="image-20241206232727151"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206232751481.png" alt="image-20241206232751481"></p>
<h3 id="chuan-shu-shu-ju-de-kuan-du">ä¼ è¾“æ•°æ®çš„å®½åº¦</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206231527504.png" alt="image-20241206231527504"></p>
<h3 id="wai-she-he-nei-cun-di-zhi-shi-fou-zi-zeng">å¤–è®¾å’Œå†…å­˜åœ°å€æ˜¯å¦è‡ªå¢</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206231649649.png" alt="image-20241206231649649" style="zoom:50%;">
<h3 id="chuan-shu-shu-ju-de-chang-du">ä¼ è¾“æ•°æ®çš„é•¿åº¦</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206232018096.png" alt="image-20241206232018096"></p>
<h3 id="chuan-shu-zhong-duan-shi-neng">ä¼ è¾“ä¸­æ–­ä½¿èƒ½</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206232112172.png" alt="image-20241206232112172"></p>
<h3 id="tong-dao-chuan-shu-shi-neng">é€šé“ä¼ è¾“ä½¿èƒ½</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206232831121.png" alt="image-20241206232831121"></p>
<h3 id="zhong-duan-zhuang-tai-r-amp-zhong-duan-biao-zhi-qing-chu-w">ä¸­æ–­çŠ¶æ€Â® &amp; ä¸­æ–­æ ‡å¿—æ¸…é™¤(w)</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206233352731.png" alt="image-20241206233352731"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206233342185.png" alt="image-20241206233342185"></p>
<h2 id="shi-li-dai-ma">ç¤ºä¾‹ä»£ç </h2>
<h3 id="dma-1-h">dma1.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__DMA1_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__DMA1_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">DMA1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DMA1_Transmit</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> srcAddr<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> destAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> byteSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DMA1_CH1_TransmitCompleteCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __DMA1_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="dma-1-c">dma1.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dma1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">DMA1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä½¿èƒ½AHBæ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>AHBENR <span class="token operator">|=</span> RCC_AHBENR_DMA1EN<span class="token punctuation">;</span>

    <span class="token comment">// é…ç½®DMAé€šé“ï¼ˆä½¿ç”¨å†…å­˜åˆ°å†…å­˜æ¨¡å¼æ—¶ï¼ŒDMAæ‰€æœ‰é€šé“éƒ½å¯ä»¥é€‰æ‹©ï¼Œè¿™é‡Œä»¥é€šé“1ä¸ºä¾‹ï¼‰</span>
    <span class="token comment">// ä¼ è¾“æ¨¡å¼ï¼šå†…å­˜åˆ°å†…å­˜</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_MEM2MEM<span class="token punctuation">;</span>
    <span class="token comment">// ä¼ è¾“æ–¹å‘ï¼šä»å¤–è®¾è¯»å–æ•°æ®ï¼ˆå†…å­˜åˆ°å†…å­˜æ¨¡å¼ä¸‹ï¼Œæä¾›æ•°æ®çš„å†…å­˜å¯ä»¥å½“åšå¤–è®¾ï¼‰</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_DIR<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®å®½åº¦ï¼Œç»Ÿä¸€ä¸º8å­—èŠ‚</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_PSIZE<span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_MSIZE<span class="token punctuation">;</span>
    <span class="token comment">// åœ°å€è‡ªåŠ¨é€’å¢</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_PINC<span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_MINC<span class="token punctuation">;</span>

    <span class="token comment">// ä½¿èƒ½ä¼ è¾“å®Œæˆä¸­æ–­ Transmit Complete Interrupt Enable</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_TCIE<span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>DMA1_Channel1_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>DMA1_Channel1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DMA1_Transmit</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> srcAddr<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> destAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> byteSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤–è®¾åœ°å€ï¼ˆå†…å­˜åˆ°å†…å­˜æ¨¡å¼ä¸‹ï¼Œä¸ºå†…å­˜ä¸­æºæ•°æ®çš„åŸºåœ°å€ï¼‰</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CPAR <span class="token operator">=</span> srcAddr<span class="token punctuation">;</span>
    <span class="token comment">// å†…å­˜åœ°å€ï¼ˆå†…å­˜åˆ°å†…å­˜æ¨¡å¼ä¸‹ï¼Œä¸ºå†…å­˜ä¸­å­˜æ”¾æ•°æ®çš„ç›®æ ‡åœ°å€ï¼‰</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CMAR <span class="token operator">=</span> destAddr<span class="token punctuation">;</span>
    <span class="token comment">// æŒ‡å®šè¦ä¼ è¾“çš„æ•°æ®æ•°é‡</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CNDTR <span class="token operator">=</span> byteSize<span class="token punctuation">;</span>

    <span class="token comment">// ä½¿èƒ½é€šé“ï¼Œå¼€å§‹ä¼ è¾“</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_EN<span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"DMA start"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DMA1_Channel1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"DMA1_Channel1_IRQHandler"</span><span class="token punctuation">)</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦ä¸ºä¼ è¾“å®Œæˆäº‹ä»¶å¯¹åº”çš„ä¸­æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DMA1<span class="token operator">-&gt;</span>ISR <span class="token operator">&amp;</span> DMA_ISR_TCIF1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…é™¤ä¸­æ–­æ ‡å¿—</span>
        DMA1<span class="token operator">-&gt;</span>IFCR <span class="token operator">|=</span> DMA_IFCR_CTCIF1<span class="token punctuation">;</span>
        <span class="token function">DMA1_CH1_TransmitCompleteCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…³é—­DMAé€šé“</span>
        DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_EN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">DMA1_CH1_TransmitCompleteCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dma1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token class-name">uint8_t</span> src<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> dest<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DMA1_CH1_TransmitCompleteCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG_DUMP</span><span class="token punctuation">(</span><span class="token string">"dest data =&gt; "</span><span class="token punctuation">,</span> dest<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DMA1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"src address =&gt; %p, dest address =&gt; %p"</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DMA1_Transmit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>src<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>dest<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="rom-amp-ram-di-zhi-yan-zheng">ROM &amp; RAMåœ°å€éªŒè¯</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207104428811.png" alt="image-20241207104428811"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207104440939.png" alt="image-20241207104440939"></p>
<h2 id="hal-ku-shi-xian">HALåº“å®ç°</h2>
<h3 id="cube-pei-zhi">Cubeé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207110716672.png" alt="image-20241207110716672"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207110804672.png" alt="image-20241207110804672"></p>
<h3 id="zhu-ce-chuan-shu-wan-cheng-hui-diao-amp-zhong-duan-fang-shi-kai-qi-dma-chuan-shu">æ³¨å†Œä¼ è¾“å®Œæˆå›è°ƒ &amp; ä¸­æ–­æ–¹å¼å¼€å¯DMAä¼ è¾“</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN PV */</span>
<span class="token keyword">const</span> <span class="token class-name">uint8_t</span> src<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> dest<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END PV */</span>

<span class="token comment">/* Private function prototypes -----------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN PFP */</span>
<span class="token keyword">void</span> <span class="token function">DMA_XferCpltCallback</span><span class="token punctuation">(</span>DMA_HandleTypeDef <span class="token operator">*</span>_hdma<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END PFP */</span>


<span class="token comment">/* USER CODE BEGIN 4 */</span>
<span class="token keyword">void</span> <span class="token function">DMA_XferCpltCallback</span><span class="token punctuation">(</span>DMA_HandleTypeDef <span class="token operator">*</span>_hdma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_DMA_Abort_IT</span><span class="token punctuation">(</span>_hdma<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span> dest<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 4 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_DMA_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
<span class="token function">HAL_DMA_RegisterCallback</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_memtomem_dma1_channel1<span class="token punctuation">,</span>
                         HAL_DMA_XFER_CPLT_CB_ID<span class="token punctuation">,</span> DMA_XferCpltCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"src =&gt; %p, dest =&gt; %p\n"</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">HAL_DMA_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdma_memtomem_dma1_channel1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>src<span class="token punctuation">,</span>
                 <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>dest<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="shi-yan-ram-dao-uart">å®éªŒ-RAMåˆ°UART</h1>
<h2 id="wai-she-te-ding-dma-tong-dao">å¤–è®¾ç‰¹å®šDMAé€šé“</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207114408798.png" alt="image-20241207114408798"></p>
<h2 id="wai-she-shi-neng-dma-mo-shi">å¤–è®¾ä½¿èƒ½DMAæ¨¡å¼</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207114541503.png" alt="image-20241207114541503"></p>
<h2 id="shi-li-dai-ma-1">ç¤ºä¾‹ä»£ç </h2>
<h3 id="dma-1-ch-4">DMA1_CH4</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dma1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">DMA1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä½¿èƒ½AHBæ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>AHBENR <span class="token operator">|=</span> RCC_AHBENR_DMA1EN<span class="token punctuation">;</span>

    <span class="token comment">// é…ç½®DMAé€šé“ï¼ˆä½¿ç”¨å†…å­˜åˆ°å†…å­˜æ¨¡å¼æ—¶ï¼ŒDMAæ‰€æœ‰é€šé“éƒ½å¯ä»¥é€‰æ‹©ï¼Œè¿™é‡Œä»¥é€šé“1ä¸ºä¾‹ï¼‰</span>
    <span class="token comment">// ä¼ è¾“æ–¹å‘ï¼šä»å†…å­˜è¯»ï¼Œå‘é€åˆ°å¤–è®¾uart</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR4_DIR<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®å®½åº¦ï¼Œç»Ÿä¸€ä¸º8å­—èŠ‚</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR4_PSIZE<span class="token punctuation">;</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR4_MSIZE<span class="token punctuation">;</span>
    <span class="token comment">// å†…å­˜åœ°å€è‡ªå¢ï¼ŒUARTç¼“å†²åŒºåœ°å€ä¸è‡ªå¢</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR4_MINC<span class="token punctuation">;</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR4_PINC<span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœå¼€å¯å¾ªç¯ä¼ è¾“æ¨¡å¼ï¼Œé‚£ä¹ˆä¼ è¾“å®Œæˆä¸­æ–­ä¸­ä¸è¦åœæ­¢DMAé€šé“</span>
    <span class="token comment">//DMA1_Channel4-&gt;CCR |= DMA_CCR4_CIRC;</span>

    <span class="token comment">// ä½¿èƒ½ä¼ è¾“å®Œæˆä¸­æ–­ Transmit Complete Interrupt Enable</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR4_TCIE<span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>DMA1_Channel4_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>DMA1_Channel4_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DMA1_Transmit</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> srcAddr<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> destAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> byteSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CMAR <span class="token operator">=</span> srcAddr<span class="token punctuation">;</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CPAR <span class="token operator">=</span> destAddr<span class="token punctuation">;</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CNDTR <span class="token operator">=</span> byteSize<span class="token punctuation">;</span>

    <span class="token comment">// ä½¿èƒ½é€šé“ï¼Œå¼€å§‹ä¼ è¾“</span>
    DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR4_EN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DMA1_Channel4_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦ä¸ºä¼ è¾“å®Œæˆäº‹ä»¶å¯¹åº”çš„ä¸­æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DMA1<span class="token operator">-&gt;</span>ISR <span class="token operator">&amp;</span> DMA_ISR_TCIF4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…é™¤ä¸­æ–­æ ‡å¿—</span>
        DMA1<span class="token operator">-&gt;</span>IFCR <span class="token operator">|=</span> DMA_IFCR_CTCIF4<span class="token punctuation">;</span>
        <span class="token comment">// å…³é—­DMAé€šé“</span>
        DMA1_Channel4<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR4_EN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="uart-shi-neng-dma-fa-song">UARTä½¿èƒ½DMAå‘é€</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// å‘é€æ•°æ®ä½¿èƒ½DMA</span>
USART1<span class="token operator">-&gt;</span>CR3 <span class="token operator">|=</span> USART_CR3_DMAT<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="main">main</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dma1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token class-name">uint8_t</span> src<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token char">'a'</span><span class="token punctuation">,</span> <span class="token char">'b'</span><span class="token punctuation">,</span> <span class="token char">'c'</span><span class="token punctuation">,</span> <span class="token char">'d'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DMA1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">DMA1_Transmit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>src<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-ku-shi-xian-1">HALåº“å®ç°</h2>
<h3 id="wai-she-xia-de-dma-she-zhi">å¤–è®¾ä¸‹çš„DMAè®¾ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207121451388.png" alt="image-20241207121451388"></p>
<h3 id="yi-dma-fang-shi-qu-dong-wai-she">ä»¥DMAæ–¹å¼é©±åŠ¨å¤–è®¾</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_DMA_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token class-name">uint8_t</span> data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token char">'a'</span><span class="token punctuation">,</span> <span class="token char">'b'</span><span class="token punctuation">,</span> <span class="token char">'c'</span><span class="token punctuation">,</span> <span class="token char">'d'</span><span class="token punctuation">,</span> <span class="token char">'e'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">HAL_UART_Transmit_DMA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE END WHILE */</span>

  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="yuan-ma-fen-xi">æºç åˆ†æ</h3>
<ul>
<li><code>MX_USART1_UART_Init</code>ï¼šDMAåˆå§‹åŒ–ï¼š<code>HAL_UART_MspInit</code></li>
<li><code>HAL_UART_Transmit_DMA</code>ï¼šè°ƒç”¨ <code>HAL_DMA_Start_IT</code></li>
</ul>
<h1 id="xun-huan-chuan-shu-mo-shi">å¾ªç¯ä¼ è¾“æ¨¡å¼</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207120044568.png" alt="image-20241207120044568"></p>
]]></content>
      <categories>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>DMA</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»æŒ‰é”®æ§åˆ¶LEDå¼€å§‹æ·±å…¥ç†è§£å¤–éƒ¨ä¸­æ–­ï¼ˆåŸºäºSTM32F103ZEï¼‰</title>
    <url>/2024/11/27/59863.html</url>
    <content><![CDATA[<h1 id="qian-yan">å‰è¨€</h1>
<h2 id="can-kao-shou-ce">å‚è€ƒæ‰‹å†Œ</h2>
<p><a href="https://www.st.com.cn/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">STM32F101xx, STM32F102xx, STM32F103xx, STM32F105xx and STM32F107xx advanced ArmÂ®-based 32-bit MCUs</a></p>
<p><a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xxx/20xxx/21xxx/L1xxxx CortexÂ®-M3 programming manual</a></p>
<h2 id="wei-shi-yao-xu-yao-wai-bu-zhong-duan">ä¸ºä»€ä¹ˆéœ€è¦å¤–éƒ¨ä¸­æ–­</h2>
<blockquote>
<p>[!NOTE]</p>
<p>æŒ‰é”®æ‰«æä¹Ÿå¯ä»¥å®ç°æŒ‰é”®æ§åˆ¶LEDäº®ç­ï¼Œä¸ºä»€ä¹ˆéœ€è¦å¤–éƒ¨ä¸­æ–­å‘¢ï¼Ÿ</p>
</blockquote>
<p>å½“æˆ‘ä»¬ä½¿ç”¨æŒ‰é”®æ‰«æçš„æ–¹æ¡ˆæ—¶ï¼ŒCPUéœ€è¦ä¸»åŠ¨çš„ä¸æ–­è½®è¯¢æŸ¥çœ‹æŒ‰é”®çš„çŠ¶æ€ï¼Œå‘ç°å…¶è¢«æŒ‰ä¸‹æ—¶å°±å°†LEDçŠ¶æ€åè½¬ä¸€ä¸‹ã€‚</p>
<p>å¦‚æœæŠŠæˆ‘ä»¬è‡ªå·±æ¯”ä½œCPUï¼Œè¿™å°±ç›¸å½“äºæˆ‘ä»¬ç½‘è´­ä¹‹åï¼Œä¸æ–­å»å¿«é€’ç‚¹è¯¢é—®å¿«é€’æœ‰æ²¡æœ‰åˆ°ï¼Œå¦‚æœæ²¡æœ‰å°±ä¸€ç›´å¹²ç­‰åœ¨é‚£é‡Œï¼Œç›´åˆ°å–åˆ°å¿«é€’ã€‚åœ¨æ­¤æœŸé—´ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•å»åšå…¶ä»–äº‹æƒ…ï¼Œæ—¶é—´éƒ½è¢«æµªè´¹æ‰äº†ã€‚</p>
<h2 id="hao-lai-wu-yuan-ze-kong-zhi-fan-zhuan">å¥½è±ååŸåˆ™/æ§åˆ¶åè½¬</h2>
<p>è¿˜æœ‰ä¸€ä¸ªè‘—åçš„å¥½è±ååŸåˆ™ï¼šå½“æ¼”å‘˜å»è¯•é•œåï¼Œå‰§ç»„ä¼šå‘ŠçŸ¥æ¼”å‘˜ä¸è¦æ‰“ç”µè¯ç»™æˆ‘ä»¬ï¼Œæœ‰ç»“æœäº†æˆ‘ä»¬ä¼šé€šçŸ¥ä½ ã€‚</p>
<p>å¥½è±ååŸåˆ™æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªè®¾è®¡ç†å¿µï¼Œå¸¸ç”¨æ¥æŒ‡å¯¼æ¨¡å—ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š</p>
<blockquote>
<p>â€œDonâ€™t call us, weâ€™ll call you.â€<br>
â€œåˆ«è°ƒç”¨æˆ‘ä»¬ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ä½ ã€‚â€</p>
</blockquote>
<p>è¿™æ„å‘³ç€ï¼Œåœ¨ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ä¸­ï¼Œä¸‹å±‚æ¨¡å—ä¸ä¸»åŠ¨è°ƒç”¨ä¸Šå±‚æ¨¡å—ï¼Œè€Œæ˜¯é€šè¿‡æŸç§æœºåˆ¶ï¼ˆä¾‹å¦‚å›è°ƒå‡½æ•°ã€äº‹ä»¶é©±åŠ¨æˆ–ä¾èµ–æ³¨å…¥ï¼‰è®©ä¸Šå±‚æ¨¡å—åœ¨åˆé€‚çš„æ—¶å€™å»è°ƒç”¨ä¸‹å±‚æ¨¡å—ã€‚</p>
<p>è¿™ä¸€åŸåˆ™å¼ºè°ƒ æ§åˆ¶åè½¬ï¼ˆIOCï¼ŒInversion of Controlï¼‰ï¼Œç›®çš„æ˜¯è§£è€¦æ¨¡å—ï¼Œå¢å¼ºä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<h1 id="yi-chang-xiang-liang-biao">å¼‚å¸¸å‘é‡è¡¨</h1>
<h2 id="arm-he-yi-chang-xiang-liang-biao">ARMæ ¸å¼‚å¸¸å‘é‡è¡¨</h2>
<p>ç±»ä¼¼çš„ï¼Œåœ¨æŒ‰é”®æ§åˆ¶LEDæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æ— æ³•é¢„çŸ¥ç”¨æˆ·ä¼šåœ¨ä½•æ—¶æŒ‰ä¸‹æŒ‰é”®ï¼Œå› æ­¤é€šè¿‡CPUä¸»åŠ¨åœ°ä¸æ–­è½®è¯¢è¿™ä¸€äº‹ä»¶æ˜¯ä¸æ˜æ™ºçš„ã€‚æˆ‘ä»¬åº”è¯¥å°†æ§åˆ¶æƒäº¤è¿˜ç»™ç”¨æˆ·ï¼Œå¸Œæœ›ç”¨æˆ·åœ¨æŒ‰ä¸‹æŒ‰é”®æ—¶ï¼ŒCPUèƒ½å¤Ÿè¢«åŠ¨åœ°æ„ŸçŸ¥åˆ°ï¼Œå¹¶æ‰§è¡Œæˆ‘ä»¬é¢„å…ˆç¼–å†™å¥½çš„æŒ‰é”®äº‹ä»¶å¤„ç†é€»è¾‘ã€‚</p>
<p>ARMæ ¸æ˜¯æ”¯æŒä¸­æ–­è¿™ä¸€æœºåˆ¶çš„ï¼Œå½“ä¸­æ–­å‘ç”Ÿæ—¶ï¼ŒARMèƒ½å¤Ÿåœä¸‹æ‰‹å¤´ä¸Šçš„äº‹æƒ…ã€ä¿å­˜å·¥ä½œç°åœºï¼Œè½¬è€Œæ‰§è¡Œå¯¹åº”çš„ä¸­æ–­å¤„ç†æœåŠ¡ç¨‹åºï¼Œå®Œæˆåå†è·³è½¬ä¼šä¸­æ–­å‰çš„åœ°æ–¹ï¼Œæ¢å¤å·¥ä½œç°åœºå¹¶ç»§ç»­æ‰§è¡Œæ—¢å®šç¨‹åºã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241127224011740.png" alt="image-20241127224011740" style="zoom: 50%;">
<blockquote>
<p><a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xxx/20xxx/21xxx/L1xxxx CortexÂ®-M3 programming manual</a> P156</p>
<p>The vector table contains the reset value of the stack pointer, and the start addresses, alsocalled exception vectors, for all exception handlers</p>
</blockquote>
<p>ä¸Šè¿°æ˜¯ARMæ ¸å¯¹åº”å¼‚å¸¸ï¼ˆä¸­æ–­æ˜¯å¼‚å¸¸çš„ä¸€ç§ï¼‰å‘é‡è¡¨çš„è§„èŒƒï¼šä¸Šç”µååº”è¯¥åˆå§‹åŒ–SPæ ˆæŒ‡é’ˆï¼Œæ¥ç€æ‰§è¡Œ<code>Reset</code>å¼‚å¸¸å¤„ç†å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥å¯¹åº”STM32æä¾›çš„æ ‡å‡†å¤–è®¾åº“ä¸­çš„å¯åŠ¨æ±‡ç¼–ç¨‹åº <code>startup.s</code>æ¥çœ‹ä¸‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">__Vectors       DCD     __initial_sp               ; Top of Stack
                DCD     Reset_Handler              ; Reset Handler
                ...
                
; Reset handler
Reset_Handler   PROC
                EXPORT  Reset_Handler             [WEAK]
                IMPORT  __main
                IMPORT  SystemInit
                LDR     R0, =SystemInit
                BLX     R0               
                LDR     R0, =__main
                BX      R0
                ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥å‘ç°<code>Reset</code>å¼‚å¸¸çš„æ‰§è¡Œåšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>æ‰§è¡Œ <code>SystemInit</code>å‡½æ•°ï¼šå¯ä»¥åœ¨<code>system_stm32f1xx.c</code>æ‰¾åˆ°å®šä¹‰ï¼Œå…¶ä¸­åšäº†ç³»ç»Ÿæ—¶é’Ÿçš„åˆå§‹åŒ–</li>
<li>æ‰§è¡Œ <code>main</code>å‡½æ•°</li>
</ol>
<h2 id="yi-chang-fen-lei">å¼‚å¸¸åˆ†ç±»</h2>
<p>ARMæ ¸è§„èŒƒä¸­æä¾›äº†84ä¸ªä¸­æ–­ï¼ˆè§ä¸Šè¡¨ï¼‰ï¼Œä½†STM32F103åªå®ç°äº†70ä¸ªï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241127230557526.png" alt="image-20241127230557526"></p>
<blockquote>
<p><a href="https://www.st.com.cn/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">STM32F101xx, STM32F102xx, STM32F103xx, STM32F105xx and STM32F107xx advanced ArmÂ®-based 32-bit MCUs</a> P1136</p>
</blockquote>
<p>è¿™äº›å¼‚å¸¸å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>ARMæ ¸å¼‚å¸¸ï¼šä¾‹å¦‚å¤ä½å¼‚å¸¸ï¼Œç”¨äºä¸Šç”µåæ‰§è¡Œç”¨æˆ·ç¨‹åº</li>
<li>å¤–è®¾ä¸­æ–­å¼‚å¸¸ï¼šç”±STM32æ ¹æ®ARMå¼‚å¸¸è§„èŒƒåŠSOCï¼ˆç‰‡ä¸Šå¤–è®¾ï¼‰å®ç°ï¼Œä¾‹å¦‚USARTä¸­æ–­ã€DMAä¸­æ–­ã€å®šæ—¶å™¨ä¸­æ–­ç­‰</li>
<li>å¤–éƒ¨å¼‚å¸¸ï¼šé€šè¿‡æœç”¨GPIOå¼•è„šè¾“å…¥åŠŸèƒ½æ¥å®ç°ï¼Œå¯ä»¥é€šè¿‡ç‰‡å¤–ç¡¬ä»¶è§¦å‘ï¼ˆä¾‹å¦‚æŒ‰é”®ï¼‰</li>
</ul>
<h2 id="yi-chang-tiao-zhuan">å¼‚å¸¸è·³è½¬</h2>
<p>å½“å…·ä½“çš„å¼‚å¸¸å‘ç”Ÿæ—¶ï¼ŒARMæ ¸ä¼šæ ¹æ®è¯¥å¼‚å¸¸åœ¨å‘é‡è¡¨ä¸­çš„åç§»åœ°å€æ‰¾åˆ°å¯¹åº”çš„å¼‚å¸¸å¤„ç†æŒ‡ä»¤æ¥æ‰§è¡Œï¼Œä¾‹å¦‚å¤–éƒ¨ä¸­æ–­10å°±ä¼šæ‰¾åˆ° <code>startup_stm32f103xe.s</code>ä¸­çš„ <code>DCD     EXTI15_10_IRQHandler</code>ã€‚é€šè¿‡<code>DCD</code>æŒ‡ä»¤å­˜æ”¾äº† <code>EXTI15_10_IRQHandler</code>å‡½æ•°çš„å…¥å£åœ°å€ï¼ˆå¦‚æœæˆ‘ä»¬å®šä¹‰äº†è¯¥å‡½æ•°ï¼Œåˆ™åœ¨é“¾æ¥æ—¶å°±èƒ½å¤Ÿæ‰¾åˆ°å¯¹åº”çš„å…¥å£åœ°å€ï¼‰</p>
<h1 id="stm-32-wai-bu-zhong-duan-shi-jian">STM32å¤–éƒ¨ä¸­æ–­å®è·µ</h1>
<blockquote>
<p>[!NOTE]</p>
<p>è¿™é‡Œä»¥STM32F103ZEä¸ºä¾‹</p>
</blockquote>
<h2 id="stm-32-zhong-duan-ti-xi-jia-gou">STM32ä¸­æ–­ä½“ç³»æ¶æ„</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128082243029.png" alt="image-20241128082243029"></p>
<h2 id="gpio-shu-ru-fu-yong-exti">GPIOè¾“å…¥å¤ç”¨EXTI</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128084910018.png" alt="image-20241128084910018"></p>
<p>å¯ä»¥å‘ç°ï¼Œè¾“å…¥ä¸ä»…ä¼šä¼ è¾“åˆ°è¾“å…¥æ•°æ®å¯„å­˜å™¨IDRï¼Œä¹Ÿä¼šæ¥å…¥åˆ°å¤ç”¨åŠŸèƒ½è¾“å…¥ï¼ˆAF Inputï¼‰ï¼›</p>
<p>å¦‚ä¸‹ï¼ŒEXTIçš„å·¦è¾¹æ˜¯å¤šä¸ªGPIOè¿æ¥åˆ°å¤šè·¯é€‰æ‹©å™¨ï¼Œå³è¾¹è¿åˆ°ä¸­æ–­çº¿ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡ä¸€æ ¹ä¸­æ–­çº¿å¤„ç†A-G 7ä¸ªIOå£çš„å¼•è„šã€‚å…·ä½“ä¸­æ–­å’Œå…¶ä¸­å“ªä¸ªå¼•è„šçŸ­æ¥ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®EXTIä¸­çš„å¯„å­˜å™¨ï¼ˆå¤šè·¯é€‰æ‹©å¯„å­˜å™¨ï¼‰æ¥é€‰æ‹©å…·ä½“çš„å¼•è„šã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128084718261.png" alt="image-20241128084718261" style="zoom:50%;">
<h2 id="wai-bu-zhong-duan-kong-zhi-qi-kuang-tu">å¤–éƒ¨ä¸­æ–­æ§åˆ¶å™¨æ¡†å›¾</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128082339103.png" alt="image-20241128082339103" style="zoom:50%;">
<ul>
<li>ï¼ˆfalling/rising trigger selection registerï¼‰è¾¹æ²¿è§¦å‘é€‰æ‹©å¯„å­˜å™¨ï¼šå¯é…ç½®è§¦å‘æ–¹å¼ä¸ºä¸Šå‡æ²¿ã€ä¸‹é™æ²¿ã€è¿˜æ˜¯ä¸¤è€…å‡å¯</li>
<li>ï¼ˆsoftware interrupt event registerï¼‰è½¯ä»¶ä¸­æ–­äº‹ä»¶å¯„å­˜å™¨ï¼šå’Œå¤–éƒ¨ä¸­æ–­é€šè¿‡ <mark>æˆ–é—¨</mark>ç›¸æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç¨‹åºä¸­è®¾ç½®è¯¥å¯„å­˜å™¨ä»è€Œå®ç°è½¯ä»¶è§¦å‘ä¸­æ–­çš„æ•ˆæœï¼Œè€Œä¸æ˜¯å¤–éƒ¨ç¡¬ä»¶è®¾å¤‡ï¼ˆä¾‹å¦‚æŒ‰é”®æŒ‰ä¸‹ï¼‰è§¦å‘</li>
<li>ï¼ˆinterrupt mask registerï¼‰ä¸­æ–­å±è”½ï¼ˆ<mark>mask</mark>ï¼‰å¯„å­˜å™¨ï¼šè¯¥å¯„å­˜å™¨ä¸å¤–éƒ¨ä¸­æ–­é€šè¿‡ <mark>ä¸é—¨</mark>ç›¸æ¥ï¼Œå½“è¯¥å¯„å­˜å™¨è®¾ç½®ä¸º1æ—¶ï¼Œè¡¨æ˜ä¸è¦å±è”½è¯¥å¤–éƒ¨ä¸­æ–­ï¼Œå½“å…¶å‘ç”Ÿæ—¶å°†å…¶é€’äº¤ç»™ <mark>NVIC</mark></li>
<li>ï¼ˆpending request registerï¼‰ä¸­æ–­å¾…å¤„ç†ï¼ˆpendingï¼‰è¯·æ±‚å¯„å­˜å™¨ï¼šå¦‚æœè¯¥å¤–éƒ¨ä¸­æ–­ç»è¿‡äº†å‰è¿°å¯„å­˜å™¨çš„å±‚å±‚è€ƒéªŒï¼Œé‚£ä¹ˆè¯¥å¯„å­˜å™¨ä¼šè¢«è®¾ç½®ï¼ˆç¡¬ä»¶è®¾ç½®ï¼‰ï¼›è¯¥å¯„å­˜å™¨ä¸ <mark>NVIC</mark>å¯¹æ¥ï¼Œ<mark>NVIC</mark>æ£€æµ‹åˆ°è¯¥å¯„å­˜å™¨è¢«è®¾ç½®ï¼Œé‚£ä¹ˆå°±ä¼šæ”¶åˆ°ä¸­æ–­å¾…å¤„ç†è¯·æ±‚ã€‚ï¼ˆç›¸å½“äºEXTIé€šçŸ¥NVICæœ‰å¤–éƒ¨ä¸­æ–­äº†ï¼‰</li>
</ul>
<h2 id="zhong-duan-you-xian-ji-ceng-ji-hua-fen">ä¸­æ–­ä¼˜å…ˆçº§å±‚çº§åˆ’åˆ†</h2>
<p>ç”±äºè¿™ä¸€éƒ¨åˆ†éš¶å±äºARMæ ¸ï¼Œå› æ­¤éœ€è¦æŸ¥çœ‹ARMæ ¸ç›¸å…³çš„å‚è€ƒæ‰‹å†Œ</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128090342846.png" alt="image-20241128090342846"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128090422528.png" alt="image-20241128090422528"></p>
<blockquote>
<p><a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xxx/20xxx/21xxx/L1xxxx CortexÂ®-M3 programming manual</a></p>
</blockquote>
<p>å¦‚æœå°†è¿™ä¸‰ä¸ªæ¯”ç‰¹ä½é…ç½®ä¸º <code>011</code>ï¼Œé‚£ä¹ˆå°±ä¸åˆ’åˆ†å‡ºå­ä¼˜å…ˆçº§ï¼Œè€Œåªä½¿ç”¨æŠ¢å ä¼˜å…ˆçº§</p>
<h2 id="zhong-duan-you-xian-ji-she-zhi">ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128091551647.png" alt="image-20241128091551647"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128091800612.png" alt="image-20241128091800612" style="zoom:50%;">
<blockquote>
<p>[!NOTE]</p>
<p>å…¶ä¸­å…«ä½çš„é«˜å››ä½ï¼ˆ[7:4]ï¼‰ç”¨æ¥è¡¨ç¤ºä¼˜å…ˆçº§çš„å€¼ï¼Œoffsetåˆ™å¯¹åº”ä¸­æ–­å·</p>
</blockquote>
<h1 id="dai-ma-shi-xian-ji-cun-qi-ban-ben">ä»£ç å®ç°ï¼ˆå¯„å­˜å™¨ç‰ˆæœ¬ï¼‰</h1>
<h2 id="kai-qi-shi-zhong">å¼€å¯æ—¶é’Ÿ</h2>
<p>æ‰¾åˆ°GPIOå’ŒAFIOå¤–è®¾æŒ‚è½½çš„æ€»çº¿ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128100638280.png" alt="image-20241128100638280" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128100807316.png" alt="image-20241128100807316"></p>
<p>å¢åŠ èŠ¯ç‰‡å‹å·çš„å®šä¹‰ <code>#define STM32F10X_HD</code>ä»¥å¼€å¯å®å®šä¹‰<code>RCC_APB2ENR_IOPFEN</code></p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">#if !defined (STM32F10X_LD) &amp;&amp; !defined (STM32F10X_LD_VL) &amp;&amp; !defined (STM32F10X_MD) &amp;&amp; !defined (STM32F10X_MD_VL) &amp;&amp; !defined (STM32F10X_HD) &amp;&amp; !defined (STM32F10X_HD_VL) &amp;&amp; !defined (STM32F10X_XL) &amp;&amp; !defined (STM32F10X_CL) 
  /* #define STM32F10X_LD */     /*!&lt; STM32F10X_LD: STM32 Low density devices */
  /* #define STM32F10X_LD_VL */  /*!&lt; STM32F10X_LD_VL: STM32 Low density Value Line devices */
  /* #define STM32F10X_MD */     /*!&lt; STM32F10X_MD: STM32 Medium density devices */
  /* #define STM32F10X_MD_VL */  /*!&lt; STM32F10X_MD_VL: STM32 Medium density Value Line devices */
  #define STM32F10X_HD     /*!&lt; STM32F10X_HD: STM32 High density devices */
  /* #define STM32F10X_HD_VL */  /*!&lt; STM32F10X_HD_VL: STM32 High density value line devices */
  /* #define STM32F10X_XL */     /*!&lt; STM32F10X_XL: STM32 XL-density devices */
  /* #define STM32F10X_CL */     /*!&lt; STM32F10X_CL: STM32 Connectivity line devices */
#endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿èƒ½æ—¶é’Ÿï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// gpio clock</span>
RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPFEN<span class="token punctuation">;</span>
<span class="token comment">// afio clock</span>
RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_AFIOEN<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="gpio-pei-zhi">GPIOé…ç½®</h2>
<p>ç”±äºä¸€ç«¯æ¥3V3ï¼Œå› æ­¤GPIOå¯ä»¥é…ç½®æˆè¾“å…¥ä¸‹æ‹‰ï¼Œè¿™æ ·æŒ‰ä¸‹æ—¶èƒ½å¤Ÿäº§ç”Ÿä¸€ä¸ªä¸Šå‡æ²¿ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128092332887.png" alt="image-20241128092332887" style="zoom: 33%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128092630183.png" alt="image-20241128092630183"></p>
<p>å¹¶é€šè¿‡ODRå°†ä¸Šä¸‹æ‹‰é€‰æ‹©ä¸ºä¸‹æ‹‰</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128093513456.png" alt="image-20241128093513456" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128093142134.png" alt="image-20241128093142134"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// gpio config for PF10</span>
   GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_MODE10<span class="token punctuation">;</span>   <span class="token comment">// input mode</span>
   GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF10_1<span class="token punctuation">;</span>   <span class="token comment">// input with pull-up/down</span>
   GPIOF<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF10_0<span class="token punctuation">;</span>
   GPIOF<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">;</span>   <span class="token comment">// pull-down</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="afio-fu-yong-shu-ru-wei-wai-bu-zhong-duan">AFIOå¤ç”¨è¾“å…¥ä¸ºå¤–éƒ¨ä¸­æ–­</h2>
<p>æ¥ç€æˆ‘ä»¬éœ€è¦æ‰“é€šGPIOè¾“å…¥åˆ°EXTIçš„é€šè·¯</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128092916951.png" alt="image-20241128092916951"></p>
<p>å°†å¤–éƒ¨ä¸­æ–­çº¿10ï¼ˆEXTI10ï¼‰é€‰æ‹©ä¸ºPF10ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128093641646.png" alt="image-20241128093641646"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// afio config</span>
    AFIO<span class="token operator">-&gt;</span>EXTICR<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>AFIO_EXTICR3_EXTI10<span class="token punctuation">;</span>
    AFIO<span class="token operator">-&gt;</span>EXTICR<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> AFIO_EXTICR3_EXTI10_PF<span class="token punctuation">;</span>   <span class="token comment">// select PF as exti10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="exti-pei-zhi">EXTIé…ç½®</h2>
<p>å¯¹ç…§å…¶å†…éƒ¨æ¡†å›¾ï¼Œçœ‹ä¸‹å“ªäº›å¯„å­˜å™¨éœ€è¦é…ç½®</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128094127920.png" alt="image-20241128094127920" style="zoom:50%;">
<h3 id="jie-chu-zhong-duan-ping-bi">è§£é™¤ä¸­æ–­å±è”½</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128094000914.png" alt="image-20241128094000914"></p>
<h3 id="qi-yong-shang-sheng-yan-hong-fa">å¯ç”¨ä¸Šå‡æ²¿è§¦å‘</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128094036359.png" alt="image-20241128094036359"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// exti config</span>
    EXTI<span class="token operator">-&gt;</span>IMR <span class="token operator">|=</span> EXTI_IMR_MR10<span class="token punctuation">;</span>   <span class="token comment">// unmask interrupt</span>
    EXTI<span class="token operator">-&gt;</span>RTSR <span class="token operator">|=</span> EXTI_RTSR_TR10<span class="token punctuation">;</span>   <span class="token comment">// rising edge trigger</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="nvic-pei-zhi">NVICé…ç½®</h2>
<h3 id="you-xian-ji-ceng-ji-she-zhi">ä¼˜å…ˆçº§å±‚çº§è®¾ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128094413013.png" alt="image-20241128094413013"></p>
<h3 id="wei-wai-bu-zhong-duan-hao-zhi-ding-you-xian-ji">ä¸ºå¤–éƒ¨ä¸­æ–­å·æŒ‡å®šä¼˜å…ˆçº§</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128094538150.png" alt="image-20241128094538150" style="zoom:50%;">
<blockquote>
<p>[!NOTE]</p>
<p>è¿™é‡Œæ¯8ä¸ªbitå¯¹åº”ä¸€ä¸ªä¸­æ–­å·çš„ä¼˜å…ˆçº§ï¼Œå› æ­¤ä½¿ç”¨äº†21ä¸ª32bitçš„IPRå¯„å­˜å™¨æ¥å­˜å‚¨84ä¸ªä¸­æ–­å·å¯¹åº”çš„ä¼˜å…ˆçº§</p>
</blockquote>
<h3 id="shi-neng-wai-bu-zhong-duan">ä½¿èƒ½å¤–éƒ¨ä¸­æ–­</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128094859410.png" alt="image-20241128094859410"></p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>æ³¨æ„EXTIæœ‰ä¸­æ–­å±è”½å¼€å…³ï¼ŒNVICä¹Ÿæœ‰ä¸­æ–­ä½¿èƒ½å¼€å…³ï¼›</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128095539003.png" alt="image-20241128095539003"></p>
<blockquote>
<p>[!NOTE]</p>
<p>ä¸€ä¸ªbitå­˜å‚¨ä¸€ä¸ªä¸­æ–­å¯¹åº”çš„ä½¿èƒ½å¼€å…³ï¼Œä½¿ç”¨äº†3ä¸ª32bitçš„ISERå¯„å­˜å™¨æ¥å­˜å‚¨ä¸­æ–­å·<mark>0~67</mark>çš„ä½¿èƒ½å¼€å…³</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// nvic config</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// only pre-priority</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI15_10_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>EXTI15_10_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// response interrupt</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ding-yi-zhong-duan-chu-li-han-shu">å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°</h2>
<p>åœ¨ <code>startup.s</code>ä¸­æ‰¾åˆ° EXTI10å¯¹åº”çš„ä¸­æ–­å‡½æ•°åç§°çš„å£°æ˜ <code>EXTI15_10_IRQHandler</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">__Vectors       DCD     __initial_sp               ; Top of Stack
                DCD     Reset_Handler              ; Reset Handler
                DCD     NMI_Handler                ; NMI Handler
                ...
                DCD     EXTI15_10_IRQHandler       ; EXTI Line 15..10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç»è¿‡æŒ‰é”®æŠ–åŠ¨åˆ¤æ–­ååè½¬LEDçŠ¶æ€ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">EXTI15_10_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EXTI<span class="token operator">-&gt;</span>PR <span class="token operator">|=</span> EXTI_PR_PR10<span class="token punctuation">;</span>   <span class="token comment">// clear pending flag</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR10<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LED_Toggle</span><span class="token punctuation">(</span>LED1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>å¤–éƒ¨ä¸­æ–­</tag>
        <tag>EXTI</tag>
      </tags>
  </entry>
  <entry>
    <title>STM32ç³»ç»Ÿæ—¶é’Ÿåˆå§‹åŒ–æºç è§£æï¼ˆSPLåº“ï¼ŒSTM32F103ZEï¼‰</title>
    <url>/2024/11/23/19447.html</url>
    <content><![CDATA[<h1 id="yi-bei-jing">ä¸€ã€èƒŒæ™¯</h1>
<h2 id="kai-fa-huan-jing">å¼€å‘ç¯å¢ƒ</h2>
<ul>
<li>STM32F103ZET6</li>
</ul>
<h2 id="yuan-li-tu">åŸç†å›¾</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123160212385.png" alt="image-20241123160212385"></p>
<h3 id="hse-gao-su-wai-bu-jing-zhen-high-speed-external-oscillator">HSE-é«˜é€Ÿå¤–éƒ¨æ™¶æŒ¯High Speed External oscillator</h3>
<p>é€šè¿‡23ã€24å·å¼•è„šæ¥å…¥8Mçš„é«˜é€Ÿå¤–éƒ¨æ™¶æŒ¯ã€‚</p>
<h3 id="hsi-di-su-wai-bu-jing-zhen-low-speed-external-oscillator">HSI-ä½é€Ÿå¤–éƒ¨æ™¶æŒ¯Low Speed External oscillator</h3>
<p>é€šè¿‡GPIOå¼•è„šPC14å’ŒPC15çš„å¤ç”¨æ¥å…¥32.768kHzä½é€Ÿå¤–éƒ¨æ™¶æŒ¯ã€‚</p>
<h2 id="yi-cube-de-tu-xing-hua-pei-zhi-wei-li-shuo-ming">ä»¥Cubeçš„å›¾å½¢åŒ–é…ç½®ä¸ºä¾‹è¯´æ˜</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123160112667.png" alt="image-20241123160112667"></p>
<p>MCUå†…ç½®äº†ä¸¤ä¸ªRCéœ‡è¡ç”µè·¯ï¼š</p>
<ul>
<li>HSI RCï¼ŒHigh Speed Internal RCï¼Œ8Mé«˜é€Ÿå†…éƒ¨RCéœ‡è¡ç”µè·¯</li>
<li>LSI RCï¼ŒLow Speed Internal RCï¼Œ40kHzä½é€Ÿå†…éƒ¨RCéœ‡è¡ç”µè·¯</li>
</ul>
<h3 id="wei-shi-yao-mcu-nei-zhi-liao-huan-xu-yao-wai-jie-jing-zhen">ä¸ºä»€ä¹ˆMCUå†…ç½®äº†ï¼Œè¿˜éœ€è¦å¤–æ¥æ™¶æŒ¯</h3>
<ul>
<li>
<p>RCéœ‡è¡ç”µè·¯å®¹æ˜“å—åˆ°å…¶ä»–ç”µè·¯å¹²æ‰°ï¼Œå¯¼è‡´ä¿¡å·ä¸ç¨³å®šï¼Œä¸”ç²¾åº¦è¿œæ¯”æ™¶æŒ¯ä½ã€‚</p>
</li>
<li>
<p>ç”±äºMCUçš„å¾®å°å°è£…ï¼Œæ— æ³•å†…åµŒè¾ƒå¤§çš„æ™¶æŒ¯</p>
</li>
<li>
<p>å°†æ™¶æŒ¯çš„çµæ´»é€‰æ‹©æƒäº¤ç»™å¼€å‘è€…</p>
</li>
</ul>
<h3 id="cube-pei-zhi-jie-xi">Cubeé…ç½®è§£æ</h3>
<p>å¤–æ¥æ™¶æŒ¯é€šè¿‡å¼•è„šæ¥å…¥MCUï¼Œä½†ç”±äºMCUçš„ä¸»é¢‘è¾ƒé«˜ï¼Œä¸€èˆ¬å°†HSEé€šè¿‡PLLï¼ˆé”ç›¸ç¯ï¼Œç”¨æ¥å€é¢‘ï¼‰æé«˜é¢‘ç‡å†ä½œä¸ºç³»ç»Ÿæ—¶é’ŸSYSCLKçš„æ¥æºã€‚</p>
<p>å›¾ä¸­ <mark>Mux</mark>æ˜¯å¤šè·¯é€‰æ‹©å™¨ <mark>Multiplex</mark>çš„ç¼©å†™ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„8M HSEç»è¿‡äº†1åˆ†é¢‘ï¼ˆå³ä¸åˆ†é¢‘ï¼‰ï¼Œè¿æ¥åˆ°äº†PLL Source Muxï¼Œé€šè¿‡è¿™ä¸ªå¤šè·¯é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬ä½¿ç”¨HSEè€Œä¸æ˜¯HSIä½œä¸ºPLLçš„æ—¶é’Ÿæ¥æºï¼ˆHSEåœ¨ç²¾åº¦å’Œç¨³å®šæ€§ä¸Šè¦æ¯”HSIå¥½å¾ˆå¤šï¼‰ã€‚</p>
<p>æ¥ç€ç»è¿‡äº†PLLMulï¼Œå³é”ç›¸ç¯å€é¢‘ï¼ˆPLL Multiplyï¼‰ï¼Œå°†HSEçš„é¢‘ç‡æ”¾å¤§äº†9å€å¾—åˆ°PLLCLKï¼ˆ8M * 9 = 72Mï¼‰ï¼Œå¹¶è¿æ¥åˆ°äº†System Clock Muxï¼ˆå³ç³»ç»Ÿæ—¶é’Ÿå¤šè·¯é€‰æ‹©å™¨ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å½“ç„¶é€‰æ‹©ç¨³å®šã€é«˜ç²¾åº¦ã€é«˜é¢‘çš„PLLCLKä½œä¸ºç³»ç»Ÿæ—¶é’Ÿã€‚</p>
<h1 id="er-shi-zhong-chu-shi-hua-guo-cheng-yuan-ma-fen-xi-spl-ku">äºŒã€æ—¶é’Ÿåˆå§‹åŒ–è¿‡ç¨‹æºç åˆ†æï¼ˆSPLåº“ï¼‰</h1>
<h2 id="shang-dian-fu-wei-hou-hui-fa-sheng-shi-yao">ä¸Šç”µ/å¤ä½åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h2>
<p>MCUå¯åŠ¨çš„æ±‡ç¼–æ–‡ä»¶ <code>startup.s</code>ä¼šè¢«æ‰§è¡Œï¼š</p>
<p><code>startup_stm32f10x_hd.s</code></p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">Reset_Handler   PROC
                EXPORT  Reset_Handler             [WEAK]
                IMPORT  __main
                IMPORT  SystemInit
                LDR     R0, =SystemInit
                BLX     R0               
                LDR     R0, =__main
                BX      R0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ‰§è¡ŒSystemInitå‡½æ•°</mark></p>
<p>å°† <code>SystemInit</code> å‡½æ•°çš„å…¥å£åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨R0ï¼Œé€šè¿‡ <code>BLX</code>è·³è½¬åˆ°å…¶å¯¹åº”çš„ä»£ç æ®µæ‰§è¡Œè¯¥å‡½æ•°ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†ç³»ç»Ÿæ—¶é’Ÿçš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p>
<p><mark>æ‰§è¡Œmainå‡½æ•°</mark></p>
<p>å°† <code>main</code> å‡½æ•°çš„å…¥å£åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨R0ï¼Œé€šè¿‡ <code>BX</code>è·³è½¬åˆ°å…¶å¯¹åº”çš„ä»£ç æ®µæ‰§è¡Œè¯¥å‡½æ•°ï¼Œæ‰§è¡Œç”¨æˆ·ä»£ç ã€‚</p>
<blockquote>
<p>è¯¥åˆå§‹åŒ–é¡ºåºéµå¾ªARMçš„CMSISï¼ˆCortex Microcontroller Software Interface Standardï¼‰æ ‡å‡†</p>
</blockquote>
<h2 id="system-init">SystemInit</h2>
<p><a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">STM32F107å‚è€ƒæ‰‹å†Œ</a></p>
<h3 id="qi-yong-hsi-xian-rang-mcu-you-xin-tiao">å¯ç”¨HSIï¼Œå…ˆè®©MCUæœ‰å¿ƒè·³</h3>
<p>åœ¨<code>system_stm32f10x.c</code>ä¸­æ‰¾åˆ° <code>SystemInit</code>å‡½æ•°ï¼Œæ¡ä»¶ç¼–è¯‘æ˜¾ç¤ºç°è‰²çš„éƒ¨åˆ†å¯ä»¥å¿½ç•¥</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set HSION bit */</span>
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000001</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å…ˆå¼€å¯HSIé«˜é€Ÿå†…éƒ¨æ—¶é’Ÿï¼ˆæ—¶é’Ÿç›¸å½“äºMCUå¿ƒè·³ï¼Œå…ˆè®©MCUæœ‰å¿ƒè·³èƒ½å¤Ÿå·¥ä½œï¼Œåé¢å†å°†æ—¶é’Ÿæºé€šè¿‡å¤šè·¯é€‰æ‹©å™¨åˆ‡æ¢ä¸ºæˆ‘ä»¬é…ç½®çš„HSEï¼‰ï¼Œå°†å¯„å­˜å™¨çš„ç¬¬0ä½è®¾ç½®ä¸º1ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123165840693.png" alt="image-20241123165840693"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123165911410.png" alt="image-20241123165911410"></p>
<h3 id="fu-wei-shi-zhong-xiang-guan-ji-cun-qi-bi-te-wei">å¤ä½æ—¶é’Ÿç›¸å…³å¯„å­˜å™¨æ¯”ç‰¹ä½</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Reset SW, HPRE, PPRE1, PPRE2, ADCPRE and MCO bits */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xF8FF0000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è¯¥æ“ä½œä¼šå°†CFGRï¼ˆæ—¶é’Ÿé…ç½®ï¼‰å¯„å­˜å™¨å¦‚ä¸‹æ¯”ç‰¹ä½æ¸…é›¶ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123170556835.png" alt="image-20241123170556835"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123170704055.png" alt="image-20241123170704055"></p>
<p>é€‰æ‹©HSIï¼ˆä¸Šä¸€æ­¥å·²ç»å¼€å¯äº†ï¼‰ä½œä¸ºç³»ç»Ÿæ—¶é’Ÿï¼Œå…¶ä»–çš„ï¼ˆHPRE, PPRE1, PPRE2, ADCPRE and MCOï¼‰åˆ†æè¿‡ç¨‹ç±»ä¼¼ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Reset HSEON, CSSON and PLLON bits */</span>
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFEF6FFFF</span><span class="token punctuation">;</span>

<span class="token comment">/* Reset HSEBYP bit */</span>
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFFFBFFFF</span><span class="token punctuation">;</span>

<span class="token comment">/* Reset PLLSRC, PLLXTPRE, PLLMUL and USBPRE/OTGFSPRE bits */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFF80FFFF</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åŒæ ·çš„ï¼Œä¹Ÿæ˜¯å°†ä¸€äº›ä½æ¸…é›¶ï¼Œå°†ç³»ç»Ÿæ—¶é’Ÿåˆå§‹åŒ–ä¸ºä»…ç”±HSIä½œä¸ºæ—¶é’Ÿæºçš„åˆå§‹çŠ¶æ€</p>
<h3 id="set-sys-clock-she-zhi-xi-tong-shi-zhong">SetSysClockè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Enable HSE */</span>    
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CR_HSEON<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">/* Wait till HSE is ready and if Time out is reached exit */</span>
<span class="token keyword">do</span>
<span class="token punctuation">{</span>
  HSEStatus <span class="token operator">=</span> RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_HSERDY<span class="token punctuation">;</span>
  StartUpCounter<span class="token operator">++</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HSEStatus <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>StartUpCounter <span class="token operator">!=</span> HSE_STARTUP_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œå¼€å¯äº†HSEå¤–éƒ¨é«˜é€Ÿæ—¶é’Ÿï¼Œå¹¶ç­‰å¾…HSEçš„çŠ¶æ€è½¬å˜ä¸ºREADYï¼ˆç”±ç¡¬ä»¶ç½®ä½ï¼‰ã€‚</p>
<h3 id="xi-tong-shi-zhong-shu">ç³»ç»Ÿæ—¶é’Ÿæ ‘</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* HCLK = SYSCLK */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_HPRE_DIV1<span class="token punctuation">;</span>
  
<span class="token comment">/* PCLK2 = HCLK */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_PPRE2_DIV1<span class="token punctuation">;</span>

<span class="token comment">/* PCLK1 = HCLK */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_PPRE1_DIV2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°†ç³»ç»Ÿæ—¶é’Ÿä½œä¸ºAHBå’ŒAPB2çš„æ—¶é’Ÿæºï¼ˆå¯¹åº”HCLKå’ŒPCLK2ï¼‰ï¼Œå°†ç³»ç»Ÿæ—¶é’Ÿ2åˆ†é¢‘ï¼Œä½œä¸ºAPB1çš„æ—¶é’Ÿæºï¼ˆå¯¹åº”PCLK2ï¼‰ã€‚</p>
<blockquote>
<p>AHBæŒ‚è½½äº†Cortexæ ¸ã€DMAç­‰ä¸»åŠ¨å•å…ƒ</p>
<p>APB2æŒ‚è½½äº†GPIOã€USRAT1ã€ADCç­‰éœ€è¦é«˜é€Ÿç‡æ—¶é’Ÿçš„å•å…ƒ</p>
<p>APB1åˆ™æŒ‚è½½äº†TIMERã€I2Cç­‰ä¸éœ€è¦é‚£ä¹ˆé«˜é¢‘çš„å•å…ƒ</p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123172121666.png" alt="image-20241123172121666" style="zoom: 50%;">
<h3 id="pll-bei-pin">PLLå€é¢‘</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*  PLL configuration: PLLCLK = HSE * 9 = 72 MHz */</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span>RCC_CFGR_PLLSRC <span class="token operator">|</span> RCC_CFGR_PLLXTPRE <span class="token operator">|</span>
                                        RCC_CFGR_PLLMULL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>RCC_CFGR_PLLSRC_HSE <span class="token operator">|</span> RCC_CFGR_PLLMULL9<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å°†PLLæ—¶é’Ÿæ¥æºRCC_CFGR_PLLSRCã€HSEè¿›å…¥PLLåçš„åˆ†é¢‘RCC_CFGR_PLLXTPREã€PLLå€é¢‘ç³»æ•°RCC_CFGR_PLLMULLæ¸…é›¶ï¼›</li>
<li>é€‰æ‹©PLLæ—¶é’Ÿæ¥æºä¸ºHSEï¼ˆRCC_CFGR_PLLSRC_HSEï¼‰ï¼Œå€é¢‘ç³»æ•°ä¸º9ï¼ˆRCC_CFGR_PLLMULL9ï¼‰</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Enable PLL */</span>
    RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> RCC_CR_PLLON<span class="token punctuation">;</span>

    <span class="token comment">/* Wait till PLL is ready */</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯åŠ¨PLLé”ç›¸ç¯ï¼Œå¹¶ç­‰å¾…å®ƒç¨³å®šã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Select PLL as system clock source */</span>
   RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span>RCC_CFGR_SW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_SW_PLL<span class="token punctuation">;</span>    

   <span class="token comment">/* Wait till PLL is used as system clock source */</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_SWS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x08</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡ç³»ç»Ÿæ—¶é’Ÿçš„å¤šè·¯é€‰æ‹©å™¨å°†PLLé€‰æ‹©ä¸ºç³»ç»Ÿæ—¶é’Ÿæºï¼Œå¹¶ç­‰å¾…æ­¤åˆ‡æ¢å®Œæˆã€‚</p>
]]></content>
      <categories>
        <category>STM32</category>
        <category>æºç åˆ†æ</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>SPL</tag>
        <tag>STM32F103ZE</tag>
        <tag>æ—¶é’Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>UARTæ¥æ”¶ç¼“å†²åŒºæº¢å‡ºå¼‚å¸¸ï¼ˆHAL_UART_ERROR_OREï¼‰é—®é¢˜è®°å½•</title>
    <url>/2024/11/12/13750.html</url>
    <content><![CDATA[<h1 id="wen-ti-bei-jing">é—®é¢˜èƒŒæ™¯</h1>
<h2 id="kai-fa-huan-jing">å¼€å‘ç¯å¢ƒ</h2>
<ul>
<li>ç¡¬ä»¶ï¼šGD32F407VET6å¼€å‘ç‰ˆ</li>
<li>IDEï¼šSTM32CubeMX + Clion + ARM GNU</li>
<li>çƒ§å½•ï¼šOpenOCD</li>
</ul>
<h2 id="shi-yan-mu-biao">å®éªŒç›®æ ‡</h2>
<p>ä½¿ç”¨Cubeé…ç½®ä¸²å£USART1åŠå…¶ä¸­æ–­ï¼Œå¼•è„šå¤ç”¨PA9/PA10ï¼Œé€šè¿‡ä½¿èƒ½æ¥æ”¶ä¸­æ–­ <code>Receive_IT</code>ï¼Œå®ç°æ¥æ”¶7å­—èŠ‚æ—¶ï¼Œåœ¨ä¸­æ–­å›è°ƒä¸­å¤„ç†è¯¥7ä¸ªå­—èŠ‚æ•°æ®ï¼ˆç®€å•å›ä¼ ï¼Œå³echoï¼‰ï¼Œå¹¶å†æ¬¡å¼€å¯æ¥æ”¶ä¸­æ–­ï¼Œä»è€Œå®ç°ä¸æ–­æ¥æ”¶7å­—èŠ‚ã€å›ä¼ 7å­—èŠ‚çš„åŠŸèƒ½ã€‚</p>
<h2 id="yu-dao-wen-ti">é‡åˆ°é—®é¢˜</h2>
<p>å‘é€å­—èŠ‚æ•°ä¸º7æ—¶ï¼Œèƒ½å¤Ÿæ­£å¸¸echoï¼›ä½†æ˜¯ä¸ä¸º7æ—¶ï¼Œæœ¬æ¥æœŸæœ›æ˜¯å•æ¬¡å‘é€å­—èŠ‚æ•°ï¼š</p>
<ul>
<li>å¤§äº7å­—èŠ‚æ—¶ï¼Œåº”è¯¥ä¹Ÿèƒ½æ¯æ¬¡è§¦å‘ä¸­æ–­ï¼Œåªæ˜¯å¤šä½™çš„å­—èŠ‚æ•°è¢«ä¸¢å¼ƒäº†è€Œå·²</li>
<li>å°‘äº7å­—èŠ‚æ—¶ï¼ˆä¾‹å¦‚5ï¼‰ï¼Œåˆ™é€šè¿‡å†æ¬¡å‘é€ä¹Ÿèƒ½è§¦å‘ä¸­æ–­</li>
</ul>
<p>ä½†å®éªŒè¿‡ç¨‹ä¸­å‘ç°è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä¼šå‘é€echoäº†ä¸€ä¸¤æ¬¡ä¹‹åï¼Œåé¢æ— è®ºå‘é€å¤šå°‘æ•°æ®éƒ½æ— æ³•å†echoçš„æƒ…å†µ</p>
<h1 id="qing-jing-zai-xian">æƒ…æ™¯å†ç°</h1>
<h2 id="cube-pei-zhi">Cubeé…ç½®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212649840.png" alt="image-20241112212649840"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212742297.png" alt="image-20241112212742297"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212813159.png" alt="image-20241112212813159"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212840656.png" alt="image-20241112212840656"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212935188.png" alt="image-20241112212935188"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212959621.png" alt="image-20241112212959621"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213059038.png" alt="image-20241112213059038"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213254243.png" alt="image-20241112213254243"></p>
<h2 id="dao-ru-clion">å¯¼å…¥Clion</h2>
<h3 id="bian-yi-pei-zhi-jiao-cha-bian-yi">ç¼–è¯‘é…ç½®-äº¤å‰ç¼–è¯‘</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213601046.png" alt="image-20241112213601046"></p>
<h3 id="cmake-pei-zhi">Cmakeé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213656961.png" alt="image-20241112213656961"></p>
<h3 id="open-ocd-shao-lu-pei-zhi">OpenOCDçƒ§å½•é…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213740944.png" alt="image-20241112213740944"></p>
<p><code>daplink.cfg</code>ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none"># choose st-link/j-link/dap-link etc.
adapter driver cmsis-dap
transport select swd

# 0x10000 = 64K Flash Size
# set FLASH_SIZE 0x20000

# 512KB Flash
set FLASH_SIZE 0x80000

source [find target/stm32f4x.cfg]

# download speed = 10MHz
# adapter speed 10000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="dai-ma-liu-cheng">ä»£ç æµç¨‹</h2>
<ul>
<li>ä¸Šç”µåå¯ç”¨æ¥æ”¶ä¸­æ–­</li>
<li>åœ¨æ¥æ”¶å®Œæ¯•å›è°ƒä¸­echoï¼Œå¹¶å†æ¬¡å¯ç”¨æ¥æ”¶ä¸­æ–­</li>
</ul>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token class-name">uint8_t</span> rxbuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">/* USER CODE BEGIN 1 */</span>
    <span class="token function">__HAL_RCC_HSI_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__HAL_RCC_SYSCLK_CONFIG</span><span class="token punctuation">(</span>RCC_SYSCLKSOURCE_HSI<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END 1 */</span>

    <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

    <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* USER CODE BEGIN Init */</span>

    <span class="token comment">/* USER CODE END Init */</span>

    <span class="token comment">/* Configure the system clock */</span>
    <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* USER CODE BEGIN SysInit */</span>

    <span class="token comment">/* USER CODE END SysInit */</span>

    <span class="token comment">/* Initialize all configured peripherals */</span>
    <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END 2 */</span>

    <span class="token comment">/* Infinite loop */</span>
    <span class="token comment">/* USER CODE BEGIN WHILE */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//        HAL_UART_Transmit_IT(&amp;huart1, (uint8_t *)"Hello, World!\r\n", 14);</span>
        <span class="token comment">//        HAL_Delay(1000);</span>
        <span class="token comment">/* USER CODE END WHILE */</span>

        <span class="token comment">/* USER CODE BEGIN 3 */</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="yuan-ma-fen-xi">æºç åˆ†æ</h1>
<h2 id="qi-yong-jie-shou-zhong-duan-hal-uart-receive-it">å¯ç”¨æ¥æ”¶ä¸­æ–­HAL_UART_Receive_IT</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> rxbuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>HAL_UART_Receive_IT -&gt; UART_Start_Receive_IT</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">huart<span class="token operator">-&gt;</span>pRxBuffPtr <span class="token operator">=</span> pData<span class="token punctuation">;</span>
huart<span class="token operator">-&gt;</span>RxXferSize <span class="token operator">=</span> Size<span class="token punctuation">;</span>
huart<span class="token operator">-&gt;</span>RxXferCount <span class="token operator">=</span> Size<span class="token punctuation">;</span>

huart<span class="token operator">-&gt;</span>ErrorCode <span class="token operator">=</span> HAL_UART_ERROR_NONE<span class="token punctuation">;</span>
huart<span class="token operator">-&gt;</span>RxState <span class="token operator">=</span> HAL_UART_STATE_BUSY_RX<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
<span class="token comment">/* Enable the UART Error Interrupt: (Frame error, noise error, overrun error) */</span>
<span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_ERR<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Enable the UART Data Register not empty Interrupt */</span>
<span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>pRxBuffPtr</code> ï¼š<strong>ä¿å­˜æˆ‘ä»¬ä¼ å…¥çš„bufæŒ‡é’ˆ</strong></li>
<li><code>RxXferSize</code> ï¼š<strong>ä¿å­˜æˆ‘ä»¬ä¼ å…¥çš„bufå¤§å°</strong></li>
<li><code>RxXferCount</code>ï¼š <strong>åˆå§‹åŒ–å¾…æ¥æ”¶æ•°æ®æ•°é‡</strong></li>
<li><code>ErrorCode</code>ï¼šåˆå§‹åŒ–é”™è¯¯ç ä¸º no error</li>
<li><code>RxState</code>ï¼š<strong>æ ‡è¯†UARTå¤„äºæ¥æ”¶çŠ¶æ€ï¼ˆData Reception process is ongoingï¼‰</strong></li>
<li>å¼€å¯UARTå¼‚å¸¸ä¸­æ–­
<ul>
<li>å¸§å¼‚å¸¸ï¼ˆFrame errorï¼‰</li>
<li>å™ªå£°å¼‚å¸¸ï¼ˆnoise errorï¼‰</li>
<li><em><strong>æ¥æ”¶ç¼“å†²åŒºæº¢å‡ºå¼‚å¸¸ï¼ˆoverrun errorï¼‰</strong></em></li>
</ul>
</li>
<li>å¼€å¯æ¥æ”¶å¯„å­˜å™¨éç©ºä¸­æ–­ï¼ˆEnable the UART Data Register not empty Interruptï¼‰</li>
</ul>
<h2 id="uart-zhong-duan-xiang-liang-biao">UARTä¸­æ–­å‘é‡è¡¨</h2>
<p><em><strong>startup_stm32f407vetx.s</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>word     USART1_IRQHandler                 <span class="token comment">/* USART1                       */</span>       <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em><strong>stm32f4xx_it.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 0 */</span>

  <span class="token comment">/* USER CODE END USART1_IRQn 0 */</span>
  <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 1 */</span>

  <span class="token comment">/* USER CODE END USART1_IRQn 1 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="shu-ju-jie-shou-chu-li">æ•°æ®æ¥æ”¶å¤„ç†</h2>
<p><em><strong>stm32f4xx_it.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* If no error occurs */</span>
    errorflags <span class="token operator">=</span> <span class="token punctuation">(</span>isrflags <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>USART_SR_PE <span class="token operator">|</span> USART_SR_FE <span class="token operator">|</span> USART_SR_ORE <span class="token operator">|</span> USART_SR_NE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorflags <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* UART in mode Receiver -------------------------------------------------*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isrflags <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr1its <span class="token operator">&amp;</span> USART_CR1_RXNEIE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">UART_Receive_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰§è¡Œæ¥æ”¶æ•°æ®é€»è¾‘ï¼ˆUART_Receive_ITï¼‰çš„å‰ç½®æ¡ä»¶ï¼š</p>
<ul>
<li>æ²¡æœ‰UARTç›¸å…³çš„å¼‚å¸¸ï¼ˆerrorflagsï¼‰</li>
<li>æ¥æ”¶å¯„å­˜å™¨éç©ºï¼ˆUSART_SR_RXNEï¼‰</li>
<li>æ¥æ”¶å¯„å­˜å™¨éç©ºä¸­æ–­ä½¿èƒ½æ˜¯å¼€å¯çš„ï¼ˆUSART_CR1_RXNEIEï¼‰</li>
</ul>
<h2 id="zhu-zi-jie-shou-shu-ju-data-register">é€å­—æ¥æ”¶æ•°æ®ï¼ˆData Registerï¼‰</h2>
<p><em><strong>stm32f4xx_hal_uart.c/UART_Receive_IT</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check that a Rx process is ongoing */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>RxState <span class="token operator">==</span> HAL_UART_STATE_BUSY_RX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">*</span>pdata8bits <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">-&gt;</span>DR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	huart<span class="token operator">-&gt;</span>pRxBuffPtr <span class="token operator">+=</span> <span class="token number">1U</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>huart<span class="token operator">-&gt;</span>RxXferCount <span class="token operator">==</span> <span class="token number">0U</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*Call legacy weak Rx complete callback*/</span>
		<span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>åˆ¤æ–­UARTæ˜¯ä¸æ˜¯å¤„äºæ¥æ”¶è¿›ç¨‹ä¸­
<ul>
<li>æˆ‘ä»¬ä¹‹å‰è°ƒç”¨è¿‡ <code>HAL_UART_Receive_IT</code>ï¼Œé‡Œé¢ä¼šç½®ä½è¿™ä¸ªçŠ¶æ€ <code>huart-&gt;RxState = HAL_UART_STATE_BUSY_RX</code></li>
</ul>
</li>
<li>ä»DRï¼ˆUARTæ•°æ®å¯„å­˜å™¨ï¼‰ä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚åˆ°ç”¨æˆ·è‡ªå®šä¹‰ç¼“å†²åŒºä¸­ï¼ˆæˆ‘ä»¬è°ƒç”¨ <code>HAL_UART_Receive_IT</code> æ—¶ä¼ å…¥è¿‡ä¸€ä¸ª7å­—èŠ‚çš„<code>buf</code>ï¼‰</li>
<li>é€’å‡å‰©ä½™å¾…æ¥æ”¶æ•°æ®æ•°é‡ <code>huart-&gt;RxXferCount</code>ï¼ˆä¹‹å‰è¢«åˆå§‹åŒ–ä¸º7ï¼‰
<ul>
<li>å¦‚æœé€’å‡ä¸º0ï¼Œåˆ™è¯´æ˜æ¥æ”¶çš„å­—èŠ‚æ•°å¡«æ»¡äº†ç”¨æˆ·æŒ‡å®šç¼“å†²åŒºå¤§å°</li>
<li>ç„¶åè°ƒç”¨ <code>HAL_UART_RxCpltCallback</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>weak</code>å‡½æ•°ï¼ˆé»˜è®¤æ˜¯ä¸€ä¸ªç©ºå®ç°ï¼‰ï¼Œç”¨æˆ·å¯ä»¥å£°æ˜ä¸€ä¸ªå¯¹åº”çš„é <code>weak</code>ç‰ˆä»¥å®ç°å›è°ƒå¤„ç†ã€‚è¿™ä¸ªç†å¿µæ˜¯ç»å…¸çš„<strong>hooké’©å­å‡½æ•°</strong>ã€‚</li>
</ul>
</li>
</ul>
<h2 id="zhong-xie-huan-chong-qu-jie-shou-wan-bi-hui-diao">é‡å†™ç¼“å†²åŒºæ¥æ”¶å®Œæ¯•å›è°ƒ</h2>
<p>åŸå‹ï¼š</p>
<p><em><strong>stm32f4xx_hal_uart.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__weak <span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Prevent unused argument(s) compilation warning */</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* NOTE: This function should not be modified, when the callback is needed,
             the HAL_UART_RxCpltCallback could be implemented in the user file
     */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‡å†™ï¼š</p>
<p><em><strong>main.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token class-name">uint8_t</span> rxbuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 0 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å°†ç¼“å†²åŒº7å­—èŠ‚æ•°æ®é€šè¿‡UART TXå‘é€ï¼Œé‡‡ç”¨è½®è¯¢æ–¹å¼ï¼ˆæ¯å‘ä¸€ä¸ªå­—èŠ‚è½®è¯¢å‘é€çŠ¶æ€ï¼‰ï¼Œè¶…æ—¶æ—¶é—´100ms</li>
<li>é‡æ–°å¼€å¯æ¥æ”¶ä¸­æ–­ï¼Œä»¥å®ç°ä¸‹ä¸€æ¬¡çš„echo</li>
</ul>
<h2 id="ding-chang-7-zi-jie-echo-ce-shi">å®šé•¿7å­—èŠ‚echoæµ‹è¯•</h2>
<p>è‡³æ­¤ï¼Œå®šé•¿7å­—èŠ‚æ•°æ®echoåŠŸèƒ½å°±å®ç°äº†</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241113084959956.png" alt="image-20241113084959956"></p>
<h2 id="chao-7-zi-jie-echo-ce-shi">è¶…7å­—èŠ‚echoæµ‹è¯•</h2>
<p><img src="C:/Users/86157/AppData/Roaming/Typora/typora-user-images/image-20241113085040298.png" alt="image-20241113085040298"></p>
<p>ä¸ºä»€ä¹ˆè¶…è¿‡æˆ‘ä»¬æŒ‡å®šçš„ç¼“å†²åŒºå¤§å°ï¼ˆ<code>HAL_UART_Transmit</code>çš„å…¥å‚ <code>Size</code>ï¼‰åï¼ŒåŠŸèƒ½å°±ä¸æ•´è¡Œäº†å‘¢ï¼Ÿ</p>
<h2 id="uart-zhong-duan-isr-yi-chang-liu-cheng">UARTä¸­æ–­ISR-å¼‚å¸¸æµç¨‹</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* If no error occurs */</span>
    errorflags <span class="token operator">=</span> <span class="token punctuation">(</span>isrflags <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>USART_SR_PE <span class="token operator">|</span> USART_SR_FE <span class="token operator">|</span> USART_SR_ORE <span class="token operator">|</span> USART_SR_NE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorflags <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">UART_Receive_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token comment">/* If some errors occur */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>errorflags <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cr3its <span class="token operator">&amp;</span> USART_CR3_EIE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
                                  <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr1its <span class="token operator">&amp;</span> <span class="token punctuation">(</span>USART_CR1_RXNEIE <span class="token operator">|</span> USART_CR1_PEIE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* UART Over-Run interrupt occurred
         huart-&gt;ErrorCode |= HAL_UART_ERROR_ORE;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æ²¡æœ‰å¼‚å¸¸æ—¶ï¼Œä¼šæ‰§è¡Œ <code>UART_Receive_IT</code>é€å­—æ¥æ”¶æ•°æ®å¹¶åœ¨å¡«æ»¡ç¼“å†²åŒºåè§¦å‘æ¥æ”¶å®Œæ¯•å›è°ƒ <code>HAL_UART_RxCpltCallback</code></li>
<li>ä½†æ˜¯å½“æˆ‘ä»¬å‘é€8å­—èŠ‚æ—¶ï¼Œä¼šè§¦å‘UARTçš„æ¥æ”¶æº¢å‡ºé”™è¯¯ï¼Œç»§è€Œè½¬å‘å¼‚å¸¸å¤„ç†æµç¨‹</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* Call UART Error Call back function if need be --------------------------*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>ErrorCode <span class="token operator">!=</span> HAL_UART_ERROR_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">/*Call legacy weak error callback*/</span>
    <span class="token function">HAL_UART_ErrorCallback</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å› ä¸ºå¼‚å¸¸å¤„ç†æµç¨‹ä¸ä¼šæ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>HAL_UART_RxCpltCallback</code>ï¼Œä¹Ÿå°±æ²¡æœ‰é‡æ–°å¼€å¯æ¥æ”¶ä¸­æ–­ <code>HAL_UART_RxCpltCallback</code>ï¼Œæ‰€ä»¥å°±å‡ºç°äº†å‘é€8å­—èŠ‚æ—¶ï¼Œåç»­æ²¡æœ‰å›ä¼ çš„ç°è±¡ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241113085040298.png" alt="image-20241113085040298"></p>
<h1 id="si-kao-yi-liu-wen-ti">æ€è€ƒ/é—ç•™é—®é¢˜</h1>
<h2 id="usart-sr-ore-shi-ru-he-bei-she-zhi-de">USART_SR_OREæ˜¯å¦‚ä½•è¢«è®¾ç½®çš„</h2>
<p>ä¸ºä»€ä¹ˆå‘é€8å­—èŠ‚æ—¶ä¼šè§¦å‘USART_SR_OREé”™è¯¯ï¼Ÿ</p>
]]></content>
      <categories>
        <category>STM32</category>
        <category>è¸©å‘è®°å½•</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>Clion</tag>
        <tag>GD32</tag>
        <tag>HAL</tag>
        <tag>UART</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£I2Cæ—¶åºï¼ˆä»¥I2Cå®æ—¶æ—¶é’ŸPCF8563ä¸ºæ¡ˆä¾‹ï¼‰</title>
    <url>/2024/11/16/31289.html</url>
    <content><![CDATA[<h1 id="yi-qian-yan">ä¸€ã€å‰è¨€</h1>
<h2 id="ying-jian-bei-jing">ç¡¬ä»¶èƒŒæ™¯</h2>
<ul>
<li>GD32F407VET6</li>
<li>I2Cå®æ—¶æ—¶é’ŸPCF8563</li>
</ul>
<h2 id="yuan-li-tu">åŸç†å›¾</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116194724707.png" alt="image-20241116194724707" style="zoom: 33%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116194750339.png" alt="image-20241116194750339" style="zoom:33%;">
<h2 id="wen-dang-zi-liao">æ–‡æ¡£èµ„æ–™</h2>
<ul>
<li><a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a></li>
<li><a href="https://atta.szlcsc.com/upload/public/pdf/source/20230921/9DB04F89E1E4336DD7CCB7C268B77442.pdf">I 2 C å®æ—¶æ—¶é’Ÿ/æ—¥å†èŠ¯ç‰‡ PCF8563</a></li>
</ul>
<h1 id="er-en-zhi-pu-nxp-i-2-c-zong-xian-xie-yi-shi-xu-jie-xi">äºŒã€æ©æ™ºæµ¦ï¼ˆNXPï¼‰I2Cæ€»çº¿åè®®æ—¶åºè§£æ</h1>
<blockquote>
<p>å‚è§<a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a>ä¸­çš„</p>
<p>**6 Electrical specifications and timing for I/O stages and bus lines  **</p>
<p>**Table 11.â€‡Characteristics of the SDA and SCL bus lines for Standard, Fast, and Fast-mode Plus I2C-bus devices **</p>
</blockquote>
<h2 id="overview">Overview</h2>
<h3 id="sda-scl-zong-xian-te-xing">SDA/SCLæ€»çº¿ç‰¹æ€§</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116195121046.png" alt="image-20241116195121046"></p>
<h3 id="shi-xu-ding-yi">æ—¶åºå®šä¹‰</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116202433638.png" alt="image-20241116202433638"></p>
<h2 id="i-2-c-chuan-shu-kong-zhi">I2Cä¼ è¾“æ§åˆ¶</h2>
<p>I2Cè§„å®šå•æ¬¡é€šä¿¡éœ€è¦éµå¾ªå¦‚ä¸‹ä¸¤ä¸ªæ§åˆ¶</p>
<h3 id="shu-ju-chuan-shu-kong-zhi">æ•°æ®ä¼ è¾“æ§åˆ¶</h3>
<p><mark>åœ¨SCLä¸ºä½æ—¶å¯ä»¥ä¿®æ”¹SDAï¼›SCLä¸ºé«˜æ—¶ï¼ŒSDAåº”è¯¥ä¿æŒä¸å˜ã€‚</mark></p>
<p>åœ¨SCLä¸ºä½ç”µå¹³æ—¶ï¼Œå‡†å¤‡SDAï¼ˆå‘é€æ–¹ï¼‰ï¼›åœ¨SCLä¸ºé«˜æ—¶ï¼Œä¿æŒSDAï¼ˆåœ¨æ­¤æœŸé—´æ¥é€æ–¹ä¼šè¯»å–SDAï¼‰ã€‚</p>
<p>è¿™ä¸€ç‚¹åœ¨<a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a>ä¸­çš„ <strong>3.1.3 Data validity</strong>è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>The data on the SDA line must be stable during the HIGH period of the clock. The HIGH or LOW state of the data line can only change when the clock signal on the SCL line is LOW (see Figure 4). One clock pulse is generated for each data bit transferred.</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116214251742.png" alt="image-20241116214251742"></p>
<h2 id="qi-shi-zhong-zhi-kong-zhi">èµ·å§‹/ç»ˆæ­¢æ§åˆ¶</h2>
<p>åœ¨SCLä¸ºé«˜æ—¶ï¼Œæ‹‰ä½SDAï¼ˆéœ€è¦æå‰å‡†å¤‡å¥½SDAä¸ºé«˜ï¼‰ï¼›åœ¨SCLä¸ºä½æ—¶ï¼Œæ‹‰é«˜SDAï¼ˆéœ€è¦æå‰å‡†å¤‡å¥½SDAä¸ºä½ï¼‰ã€‚</p>
<p><mark>å¯ä»¥å‘ç°ä¸ºäº†åŒºåˆ†æ•°æ®ä¼ è¾“æ§åˆ¶ï¼Œç‰¹æ„åœ¨SCLä¸ºé«˜æ—¶æ“ä½œSDAã€‚</mark></p>
<p>è¿™ä¸€ç‚¹åœ¨<a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a>ä¸­çš„ <strong>3.1.4 START and STOP conditions</strong> è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>All transactions begin with a START (S) and are terminated by a STOP (P) (see Figure 5). A HIGH to LOW transition on the SDA line while SCL is HIGH defines a START condition. A LOW to HIGH transition on the SDA line while SCL is HIGH defines a STOP condition.</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116214423843.png" alt="image-20241116214423843"></p>
<h2 id="f-sub-scl-sub-shi-zhong-xian-pin-lu-frequency-for-scl">f<sub>SCL</sub>æ—¶é’Ÿçº¿é¢‘ç‡ï¼ˆfrequency for SCLï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116201656138.png" alt="image-20241116201656138"></p>
<p>è¯¥å‚æ•°è§„å®šäº†I2Cçš„SCLæ—¶é’Ÿçº¿çš„é¢‘ç‡ï¼Œä»¥Fast-modeä¸ºä¾‹ï¼Œæœ€å¤§ä¸º400kHzã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åœ¨æ“ä½œSCLæ—¶ï¼Œå°†SCLç½®0çš„æ—¶é—´+éšåå°†SCLç½®1çš„æ—¶é—´ä¹‹å’Œä¸èƒ½å°äº 1/400kHz = 2.5usï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116201725124.png" alt="image-20241116201725124"></p>
<p>ä»¥GD32F4ä¸ºä¾‹ï¼Œå¯¹åº”æ ‡å‡†åº“å‡½æ•° <code>gpio_output_options_set</code>ä¸­çš„ <code>speed</code>å‚æ•°ï¼Œå³æ§åˆ¶GPIOå¼•è„šè¾“å‡ºé«˜ä½ç”µå¹³æ—¶ï¼Œèƒ½å¤Ÿè¾¾åˆ°çš„æœ€å¤§é¢‘ç‡ã€‚</p>
<h2 id="t-sub-hd-sta-sub-qi-shi-xin-hao-bao-chi-shi-jian-hol-d-time-for-start-condition">t<sub>HD;STA</sub>èµ·å§‹ä¿¡å·ä¿æŒæ—¶é—´ï¼ˆHolD time for START conditionï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116202607065.png" alt="image-20241116202607065"></p>
<p>è¯¥å‚æ•°è§„å®šäº†èµ·å§‹ä¿¡å·ï¼ˆSTART conditionï¼‰éœ€è¦ä¿æŒçš„æ—¶é—´ï¼ˆåœ¨SCLä¸ºé«˜ç”µå¹³æ—¶ï¼Œå°†SDAç”±é«˜æ‹‰ä½åéœ€è¦ä¿æŒçš„æ—¶é—´ï¼‰</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116202932000.png" alt="image-20241116202932000" style="zoom: 50%;">
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116204002371.png" alt="image-20241116204002371"></p>
<ol>
<li>hold time (<mark>repeated</mark>) START conditionï¼š<mark>repeated</mark>è¡¨æ˜ç¬¬ä¸€ä¸ªèµ·å§‹ä¿¡å·åçš„é‡å¤èµ·å§‹ä¿¡å·éƒ½éœ€è¦éµå¾ªè¿™ä¸ªè§„åˆ™ï¼Œä¾‹å¦‚åœ¨<a href="https://atta.szlcsc.com/upload/public/pdf/source/20230921/9DB04F89E1E4336DD7CCB7C268B77442.pdf">PCF8563</a>ä¸­æåˆ°çš„ <mark>å†™åœ°å€ï¼Œè¯»æ•°æ®</mark>æ¨¡å¼ä¸­ï¼Œåœ¨ç¬¬ä¸€ä¸ªSï¼ˆèµ·å§‹ä¿¡å·ï¼‰ä¹‹åæœ‰ä¸€ä¸ª <mark>dummy&nbsp;write</mark>ï¼ˆæŒ‡å®šåé¢è¿ç»­è¯»çš„èµ·å§‹å¯„å­˜å™¨åœ°å€ï¼‰ï¼Œç„¶ååˆæœ‰ä¸€ä¸ªSï¼Œç´§æ¥ç€æ‰æ˜¯çœŸæ­£çš„è¿ç»­è¯»æ•°æ®ã€‚è¿™é‡Œç¬¬äºŒä¸ªSå°±å±äº <mark>repeated&nbsp;START&nbsp;condition</mark>ã€‚</li>
</ol>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116203555124.png" alt="image-20241116203555124" style="zoom: 33%;">
<ol start="2">
<li>
<p><mark>After this period, the first clock pulse is generated</mark>ï¼šæš—ç¤ºæˆ‘ä»¬åœ¨è¿™ä¸ªt<sub>HD;STA</sub>å‘¨æœŸï¼ˆç›¸å½“äºI2Cé€šä¿¡çš„å‡†å¤‡é˜¶æ®µï¼‰è¿‡åï¼Œä¸»è®¾å¤‡åº”è¯¥ç”Ÿæˆç¬¬ä¸€ä¸ªæ—¶é’Ÿè„‰å†²å¼€å§‹ä¼ è¾“æ•°æ®ã€‚å› æ­¤æ—¶åºå®šä¹‰é‡Œä¹Ÿç»™å‡ºäº†å¦‚ä¸‹ç¤ºæ„å›¾ï¼Œ<strong>æš—ç¤ºæˆ‘ä»¬åœ¨å»¶æ—¶t<sub>HD;STA</sub>ä¹‹åï¼Œåº”è¯¥å°†SCLæ‹‰ä½</strong>ï¼ˆå›¾ä¸­ <mark>1<sup>st</sup>&nbsp;clock&nbsp;cycle</mark>ä¹Ÿè¿›ä¸€æ­¥å°è¯äº†è¿™ä¸€ç‚¹ï¼‰ã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116204645958.png" alt="image-20241116204645958" style="zoom:50%;">
</li>
</ol>
<h2 id="t-sub-low-sub-t-sub-high-sub-shi-zhong-xian-gao-di-dian-ping-zhou-qi-kong-zhi-scl-low-high-period">t<sub>LOW</sub>/t<sub>HIGH</sub>æ—¶é’Ÿçº¿é«˜ä½ç”µå¹³å‘¨æœŸæ§åˆ¶ï¼ˆSCL low/high periodï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116204955105.png" alt="image-20241116204955105"></p>
<p>è¯¥å‚æ•°è§„å®šäº†æˆ‘ä»¬ä¼ è¾“æ•°æ®æ‹‰é«˜æ‹‰ä½SCLæ—¶ï¼Œå…¶é«˜ä½ç”µå¹³åº”è¯¥æŒç»­çš„æ—¶é—´ï¼Œä»¥Fast-modeä¸ºä¾‹ï¼ŒSCLä½ç”µå¹³æœ€ä½æŒç»­1.3usï¼Œé«˜ç”µå¹³åˆ™æœ€ä½0.6us</p>
<h2 id="t-sub-su-sta-sub-qi-shi-xin-hao-jian-li-zhun-bei-shi-jian-set-up-time-for-start">t<sub>SU;STA</sub> èµ·å§‹ä¿¡å·å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼ˆSetUp time for STARTï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116205306146.png" alt="image-20241116205306146"></p>
<p>è¯¥å‚æ•°è§„å®šäº†èµ·å§‹ä¿¡å·çš„å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼Œè¿™ä¸ªå‚æ•°æœ‰ç‚¹éš¾ç†è§£ã€‚æˆ‘ä»¬å‚ç…§æ—¶åºå®šä¹‰æ¥çœ‹ä¸‹ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116205502756.png" alt="image-20241116205502756" style="zoom: 50%;">
<p>å’Œt<sub>HD;STA</sub>å¯¹æ¯”æ¥çœ‹ï¼Œt<sub>HD;STA</sub>è§„å®šäº†èµ·å§‹ä¿¡å·çš„ä¿æŒæ—¶é—´ï¼ˆSCLä¸ºé«˜æ—¶ï¼Œæ‹‰ä½SDAå¹¶ä¿æŒï¼‰ã€‚</p>
<p>t<sub>SU;STA</sub> åˆ™æ˜¯ç”¨äºé‡å¤èµ·å§‹ä¿¡å·çš„ï¼ˆæ¯æ¬¡é€šä¿¡è‡³å°‘å¯¹åº”ä¸€ä¸ªSTARTå’ŒSTOPï¼Œè¿ç»­çš„å¤šæ¬¡é€šä¿¡ä¸­ç´§æ¥ç€å‰ä¸€æ¬¡é€šä¿¡STOPä¹‹åçš„STARTå¯ç§°ä¸º <mark>repeated START</mark>ï¼Œå‰é¢ä»‹ç»çš„ <mark>å†™åœ°å€ï¼Œè¿ç»­è¯»æ¨¡å¼</mark>å¯¹åº”çš„START,START,STOPä¸­ç¬¬äºŒä¸ªSTARTä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚</p>
<p>å¯¹äºé‡å¤èµ·å§‹ä¿¡å·è€Œè¨€ï¼ŒSCLå¯èƒ½æ˜¯ä»¥ä½ç”µå¹³å¼€å§‹çš„ï¼ˆä¾‹å¦‚ä¸Šä¸€æ¬¡é€šä¿¡å°†SCLæ‹‰ä½äº†ï¼‰ï¼Œä¸ºäº†æ»¡è¶³å®ç°èµ·å§‹ä¿¡å·ï¼ˆæ‹‰ä½SDAï¼‰çš„<mark>å‰ç½®æ¡ä»¶ï¼ˆSCLä¸ºé«˜ï¼ŒSDAä¸ºé«˜ï¼‰</mark>ï¼Œè¯¥å‚æ•°è§„å®šäº†åœ¨æ‹‰ä½SDAä¹‹å‰ï¼ŒSDAåº”è¯¥åœ¨SCLä¸ºé«˜æœŸé—´ä¿æŒé«˜ç”µå¹³çš„æ—¶é—´ã€‚</p>
<h2 id="qi-shi-zhong-zhi-xin-hao-de-shi-xian">èµ·å§‹/ç»ˆæ­¢ä¿¡å·çš„å®ç°</h2>
<p>è¿™é‡Œæˆ‘ä»¬å·²ç»å¯ä»¥å†™å‡ºèµ·å§‹ä¿¡å·çš„ä¼ªä»£ç äº†ï¼ˆæ‰€æœ‰å»¶æ—¶ä»¥ Fast-mode ä¸ºä¾‹ï¼‰ï¼š</p>
<p><code>I2C_Start()</code></p>
<pre class="line-numbers language-none"><code class="language-none">// å‰ç½®æ¡ä»¶
SDA = HIGH
SCL = HIGH
// å‰ç½®æ¡ä»¶å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´
delay 0.6us

// èµ·å§‹ä¿¡å·(SCL,SDAä¸ºé«˜æ—¶ï¼Œæ‹‰ä½SDA)
SDA = LOW
// èµ·å§‹ä¿¡å·ä¿æŒæ—¶é—´
delay 0.6

// å¼€å§‹ç¬¬ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸä½ç”µå¹³é˜¶æ®µ
SCL = 0;
delay 1.3us<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”çš„Cè¯­è¨€å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SCL_PIN</span>    <span class="token expression">GPIO_PIN_6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SDA_PIN</span>    <span class="token expression">GPIO_PIN_7</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_PORT</span>  <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_RCU</span>   <span class="token expression">RCU_GPIOB</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start setup</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start hold</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ³¨æ„</mark>ï¼šè¿™é‡Œç¬¬22è¡Œï¼Œå¹¶æ²¡æœ‰å’Œä¼ªä»£ç ä¸­çš„1.3usä¿æŒä¸€è‡´ï¼Œæ˜¯å› ä¸ºåœ¨åç»­çš„æ•°æ®ä¼ è¾“ä¸­ï¼Œç½®ä½SDAåæ˜¯éœ€è¦ä¸€ä¸ªsetupæ—¶å»¶çš„ï¼ˆä¾‹å¦‚1usï¼‰ï¼Œæ— å½¢ä¹‹é—´å»¶é•¿äº†SCLä½ç”µå¹³çš„æ—¶é—´ï¼ˆç›¸å½“äºå˜æˆä¸º2usï¼‰ï¼Œè¯¦è§åæ–‡åˆ†æã€‚</p>
<h2 id="t-sub-hd-dat-sub-shu-ju-bao-chi-shi-jian-hol-d-time-for-data">t<sub>HD;DAT</sub>æ•°æ®ä¿æŒæ—¶é—´ï¼ˆHolD time for DATAï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116212042232.png" alt="image-20241116212042232"></p>
<p>å¯ä»¥å‘ç°è¯¥å‚æ•°å¯¹åº”ä¸¤ç§æ¡ä»¶ï¼š <mark>CBUS compatible controllers</mark>å’Œ <mark>I2C-bus devices</mark>ï¼Œæˆ‘ä»¬è¿™é‡Œåªå…³å¿ƒI2Cï¼Œè¦æ±‚æŒç»­çš„æœ€å°æ—¶é—´ä¸º0ï¼Œç›¸å½“äºä¸éœ€è¦æ§åˆ¶æ—¶å»¶ï¼Œæš‚æ—¶å¯ä»¥å¿½ç•¥è¯¥å‚æ•°ã€‚</p>
<h2 id="t-sub-su-dat-sub-shu-ju-jian-li-zhun-bei-shi-jian-set-up-time-for-data">t<sub>SU;DAT</sub>æ•°æ®å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼ˆSetUp time for DATAï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116212548515.png" alt="image-20241116212548515"></p>
<p>è¯¥å‚æ•°è§„å®šäº†SDAå»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼Œä¹Ÿå³åœ¨SCLä¸ºä½æ—¶ï¼Œç½®ä½SDAä¸ºä¸‹ä¸€ä¸ªè¦å‘é€çš„æ•°æ®åï¼Œåˆ°æ‹‰é«˜SCLï¼ˆä»¥è®©æ¥æ”¶æ–¹è¯»å–æ•°æ®ï¼‰ä¹‹å‰åº”è¯¥ä¿æŒçš„æ—¶é—´ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116214624147.png" alt="image-20241116214624147" style="zoom:50%;">
<p>æˆ‘ä»¬æ¯æ¬¡å‘é€æ•°æ®éƒ½éµå¾ªå¦‚ä¸‹æµç¨‹</p>
<ul>
<li>æ‹‰ä½SCLï¼Œå¹¶å»¶æ—¶t<sub>LOW</sub></li>
<li>å‡†å¤‡SDAï¼ˆä¸‹ä¸€æ¬¡è¦å‘é€çš„æ•°æ®ï¼‰ï¼Œå¹¶å»¶æ—¶t<sub>SU;DAT</sub></li>
<li>æ‹‰é«˜SCLï¼Œå¹¶å»¶æ—¶/t<sub>HIGH</sub></li>
</ul>
<h2 id="fa-song-yi-ge-zi-jie-de-shi-xian">å‘é€ä¸€ä¸ªå­—èŠ‚çš„å®ç°</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºå‘é€ä¸€ä¸ªå­—èŠ‚çš„ä¼ªä»£ç äº†ï¼ˆæ¥ç€ä¹‹å‰çš„ <code>I2C_Start</code>ï¼‰ï¼š</p>
<p><code>I2C_SendByte</code></p>
<pre class="line-numbers language-none"><code class="language-none">uint8_t byte
// éœ€è¦å¾ªç¯8æ¬¡ï¼Œå‘é€ä¸€ä¸ªå­—èŠ‚8ä¸ªbit
for(i = 0 ; i &lt; 8 ; i++) {
    // æ­¤å‰I2C_Startçš„ç»“å°¾ä»¥å°†SCLæ‹‰ä½ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å‡†å¤‡SDA
    SDA = (byte &amp; (0x08 &gt;&gt; i)) ? HIGH : LOW
    delay 1us // SDAå»ºç«‹æ—¶é—´ï¼Œè¿™æœŸé—´SCLä»æœªä½ç”µå¹³ï¼Œå› æ­¤ä¸€å…±æŒç»­äº†2us
    
    SCL = HIGH
    delay 1us // SCLé«˜ç”µå¹³å‘¨æœŸ
    
    SCL = LOW // å¼€å¯ä¸‹ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸ
    delay 1us // SCLä½ç”µå¹³å‘¨æœŸ
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”GD32F4çš„Cè¯­è¨€å®ç°ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start setup</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start hold</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data set-up</span>

        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="t-sub-r-sub-t-sub-f-sub-shang-sheng-yan-xia-jiang-yan-shi-jian-rising-falling-edge">t<sub>r</sub> / t<sub>f</sub>ä¸Šå‡æ²¿/ä¸‹é™æ²¿æ—¶é—´ï¼ˆRising/Falling edgeï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116220318791.png" alt="image-20241116220318791"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116220810270.png" alt="image-20241116220810270" style="zoom:33%;">
<p>è¿™ä¸¤ä¸ªå‚æ•°è§„å®šäº†SCLå’ŒSDAçš„ä¸Šå‡æ²¿ï¼ˆr-rising edgeï¼‰ã€ä¸‹é™æ²¿ï¼ˆf-falling edgeï¼‰çš„æ—¶é—´æ§åˆ¶ã€‚è¿™ä¸ªå‚æ•°å’ŒGPIOå¯¹åº”ç”µæ°”ç‰¹æ€§ä¸­çš„å‹æ‘†ç‡ï¼ˆ<mark>Slew Rate</mark>ï¼‰ã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p>è¯¥å‚æ•°å¯ä»¥åœ¨MCUæ•°æ®æ‰‹å†Œä¸ç”µæ°”ç‰¹æ€§ï¼ˆ<code>Electrical characteristics  </code>ï¼‰ç›¸å…³çš„ç« èŠ‚ä¸­å¯ä»¥æ‰¾åˆ°ï¼ˆ<code>AC characteristics</code> ï¼‰</p>
</blockquote>
<h2 id="t-sub-su-sto-sub-zhong-zhi-xin-hao-jian-li-zhun-bei-shi-jian-set-up-time-for-stop">t<sub>SU;STO</sub>ç»ˆæ­¢ä¿¡å·å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼ˆSetUp time for STOPï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116221510344.png" alt="image-20241116221510344"></p>
<p>ç”±äºç»ˆæ­¢ä¿¡å·ï¼ˆæ‹‰é«˜SDAï¼‰æ˜¯æœ‰å‰ç½®æ¡ä»¶çš„ï¼ˆSCLä¸ºé«˜ï¼ŒSDAä¸ºä½ï¼‰ï¼Œè¯¥å‚æ•°è§„å®šäº†åœ¨æ‹‰é«˜SDAä¹‹å‰ï¼ŒSDAåœ¨SCLä¸ºé«˜æœŸé—´ä¿æŒä½ç”µå¹³çš„æ—¶é—´ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116222328620.png" alt="image-20241116222328620"></p>
<h2 id="t-sub-buf-sub-zong-xian-shi-fang-shi-jian-b-us-free-time">t<sub>BUF</sub>æ€»çº¿é‡Šæ”¾æ—¶é—´ï¼ˆBUs Free timeï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116222447598.png" alt="image-20241116222447598"></p>
<p>è¯¥å‚æ•°è§„å®šäº†åœ¨ä¸€ä¸ªç»ˆæ­¢ä¿¡å·ï¼ˆPï¼‰å’Œä¸‹ä¸€ä¸ªèµ·å§‹ä¿¡å·ï¼ˆSï¼‰ä¹‹é—´ï¼Œæ€»çº¿åº”è¯¥è¢«é‡Šæ”¾ï¼ˆSCL/SDAä¿æŒé«˜ç”µå¹³ï¼‰çš„æ—¶é—´ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116222631166.png" alt="image-20241116222631166"></p>
<h2 id="zhong-zhi-xin-hao-de-shi-xian">ç»ˆæ­¢ä¿¡å·çš„å®ç°</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç»ˆæ­¢ä¿¡å·çš„ä¼ªä»£ç äº†ï¼š</p>
<p><code>I2C_Stop</code></p>
<pre class="line-numbers language-none"><code class="language-none">// å‰ç½®æ¡ä»¶ï¼šSDAä¸ºä½ï¼ŒSCLä¸ºé«˜
// æ­¤å‰I2C_SendByteçš„ç»“å°¾å·²å°†SCLæ‹‰ä½ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥å‡†å¤‡SDA
SDA = 0
delay 1us // ä¸ºäº†ç¡®ä¿SCLä½ç”µå¹³å‘¨æœŸå¤§äº1.3usï¼Œè¿™é‡Œè¡¥å……ä¸€ä¸ª1us
SCL = HIGH
delay 1us // SCLé«˜ç”µå¹³å‘¨æœŸ
delay 1us // è¡¥å……1usï¼Œç¡®ä¿&gt;æ€»çº¿é‡Šæ”¾æ—¶é—´1.3us<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”Cè¯­è¨€å®ç°ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//stop setup</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//bus free time between a STOP and START condition</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="t-sub-vd-dat-sub-t-sub-vd-ack-sub-shu-ju-ack-you-xiao-shi-jian-valid-time-for-data-ack">t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>æ•°æ®/ACKæœ‰æ•ˆæ—¶é—´ï¼ˆValid time for DATA/ACKï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116223438554.png" alt="image-20241116223438554"></p>
<p>ä¸ªäººç†è§£è¿™ä¸¤ä¸ªå‚æ•°æ˜¯åœ¨æ¥æ”¶çš„åœºæ™¯ä¸‹ä½¿ç”¨çš„ï¼Œåœ¨ä½œä¸ºæ¥æ”¶æ–¹é‡Šæ”¾SDAï¼ˆæ‹‰é«˜SDAï¼‰ä¹‹åï¼Œå‘é€æ–¹ä¼šé€šè¿‡æ‹‰é«˜/æ‹‰ä½SDAæ¥å‡†å¤‡ACK/æ•°æ®æ¯”ç‰¹ï¼Œç„¶åæˆ‘ä»¬éœ€è¦ç­‰å¾…t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>è¿™æ ·ä¸€ä¸ªæ—¶é—´ç¡®ä¿å‘é€æ–¹å‡†å¤‡å¥½SDAäº†ï¼Œç„¶åæˆ‘ä»¬å†æ‹‰é«˜SCLï¼ˆè®©å‘é€æ–¹ä¿æŒSDAï¼‰ï¼Œå¹¶è¯»å–SDAã€‚</p>
<h2 id="jie-shou-ack-shu-ju-zi-jie-dai-ma-shi-xian">æ¥æ”¶ACK/æ•°æ®å­—èŠ‚ä»£ç å®ç°</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ¥æ”¶ackå’Œæ•°æ®å­—èŠ‚çš„ä»£ç äº†ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_IN</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_INPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_OUT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_OUTPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_READ</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_input_bit_get</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

bool <span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bool success <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    success <span class="token operator">=</span> <span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">;</span> <span class="token comment">// read ack</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl low</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">receive_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// slave keep data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// read data</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// let slave prepare next data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="san-i-2-c-wan-zheng-dai-ma">ä¸‰ã€I2Cå®Œæ•´ä»£ç </h1>
<h2 id="code-hal-i-2-c-soft-h-code"><code>hal_i2c_soft.h</code></h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/16.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HAL_I2C_SOFT_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HAL_I2C_SOFT_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"gd32f4xx.h"</span></span>

<span class="token keyword">void</span> <span class="token function">hal_i2c_soft_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">hal_i2c_soft_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">hal_i2c_soft_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">hal_i2c_soft_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//HAL_I2C_SOFT_H</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="code-hal-i-2-c-soft-c-code"><code>hal_i2c_soft.c</code></h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/16.</span>
<span class="token comment">//</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hal_i2c_soft.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SCL_PIN</span>    <span class="token expression">GPIO_PIN_6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SDA_PIN</span>    <span class="token expression">GPIO_PIN_7</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_PORT</span>  <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_RCU</span>   <span class="token expression">RCU_GPIOB</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_IN</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_INPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_OUT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_OUTPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_READ</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_input_bit_get</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">hal_i2c_soft_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä½¿èƒ½GPIOBæ—¶é’Ÿ</span>
    <span class="token function">rcu_periph_clock_enable</span><span class="token punctuation">(</span>I2C_GPIO_RCU<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// é…ç½®PB6ï¼ˆSCLï¼‰å’ŒPB7ï¼ˆSDAï¼‰ä¸ºå¼€æ¼è¾“å‡ºæ¨¡å¼</span>
    <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_OUTPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SCL_PIN <span class="token operator">|</span> I2C_SDA_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_output_options_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_OTYPE_OD<span class="token punctuation">,</span> GPIO_OSPEED_50MHZ<span class="token punctuation">,</span> I2C_SCL_PIN <span class="token operator">|</span> I2C_SDA_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å°†SCLå’ŒSDAçº¿æ‹‰é«˜</span>
    <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN <span class="token operator">|</span> I2C_SDA_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start setup</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start hold</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//stop setup</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//bus free time between a STOP and START condition</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> bool <span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bool success <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    success <span class="token operator">=</span> <span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">;</span> <span class="token comment">// read ack</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl low</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">send_ack</span><span class="token punctuation">(</span>bool ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// set sda to reponse ack/nack</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sda setup</span>

    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// let slave read ack</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reset scl for next operation</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data set-up</span>

        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">receive_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// slave keep data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// read data</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// let slave prepare next data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> bool <span class="token function">start_for_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">send_byte</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write dev_addr failed"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">send_byte</span><span class="token punctuation">(</span>reg_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write reg_addr failed"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> bool <span class="token function">start_for_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">send_byte</span><span class="token punctuation">(</span>dev_addr <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// read from slave</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write dev_addr for read failed"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">hal_i2c_soft_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">start_for_write</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">,</span> reg_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">send_byte</span><span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write data[%d] failed"</span><span class="token punctuation">,</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">hal_i2c_soft_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// dummy write for register address</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">start_for_write</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">,</span> reg_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// continuous read</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">start_for_read</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">receive_byte</span><span class="token punctuation">(</span>buf<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">send_ack</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">receive_byte</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">send_ack</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>åè®®</category>
      </categories>
      <tags>
        <tag>I2C</tag>
        <tag>æ—¶åº</tag>
        <tag>PCF8563</tag>
        <tag>IÂ²C</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¨¡æ•°è½¬æ¢ADC(STM32F103ZE)</title>
    <url>/2024/12/07/52846.html</url>
    <content><![CDATA[<h1 id="gai-shu">æ¦‚è¿°</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207132054463.png" alt=""></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207132628019.png" alt="image-20241207132628019"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207132958431.png" alt="image-20241207132958431"></p>
<h1 id="stm-32-zhong-de-adc">STM32ä¸­çš„ADC</h1>
<p>STM32F103ç³»åˆ—æä¾›äº†3ä¸ªADCï¼Œç²¾åº¦ä¸º12ä½ï¼Œæ¯ä¸ªADCæœ€å¤šæœ‰16ä¸ªé€šé“å’Œ2ä¸ªå†…éƒ¨ä¿¡å·æºã€‚</p>
<p>STM32F103çš„ADCæ˜¯ä¸€ç§é€æ¬¡é€¼è¿‘å‹æ¨¡æ‹Ÿæ•°å­—è½¬æ¢å™¨ã€‚å„é€šé“çš„A/Dè½¬æ¢å¯ä»¥å•æ¬¡ã€è¿ç»­ã€æ‰«ææˆ–é—´æ–­æ¨¡å¼æ‰§è¡Œã€‚ADCçš„ç»“æœå¯ä»¥å·¦å¯¹é½æˆ–å³å¯¹é½æ–¹å¼å­˜å‚¨åœ¨16ä½æ•°æ®å¯„å­˜å™¨ä¸­ã€‚æ¨¡æ‹Ÿçœ‹é—¨ç‹—ç‰¹æ€§å…è®¸åº”ç”¨ç¨‹åºæ£€æµ‹è¾“å…¥ç”µå‹æ˜¯å¦è¶…å‡ºç”¨æˆ·å®šä¹‰çš„é«˜/ä½é˜ˆå€¼ã€‚ADCçš„è¾“å…¥æ—¶é’Ÿä¸å¾—è¶…è¿‡14MHzï¼Œå®ƒæ˜¯ç”±PCLK2ç»åˆ†é¢‘äº§ç”Ÿã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207133434436.png" alt="image-20241207133434436"></p>
<h2 id="adc-lei-xing">ADCç±»å‹</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207141746294.png" alt="image-20241207141746294"></p>
<h2 id="zhu-ci-bi-jin-xing-gong-zuo-yuan-li">é€æ¬¡é€¼è¿‘å‹å·¥ä½œåŸç†</h2>
<h3 id="lei-bi-tian-ping-cheng-zhong-jian-hua-guo-cheng">ç±»æ¯”å¤©å¹³ç§°é‡ç®€åŒ–è¿‡ç¨‹</h3>
<p>ç±»æ¯”ç§°é‡æœªçŸ¥é‡é‡çš„ç‰©ä½“çš„æœ€ä¼˜æ–¹æ³•ï¼šå…ˆä¸Šå¤§ç ç ï¼Œåä¸Šå°ç ç ï¼›å¦‚æœæŸæ¬¡å¢åŠ ç ç åå‘ç°ç ç ç«¯è¾ƒé‡ï¼Œåˆ™å°†è¯¥ç ç æ›¿æ¢ä¸ºè¾ƒå°ä¸€ç‚¹çš„ç ç ï¼›å¦‚æœæŸæ¬¡å¢åŠ ç ç åå‘ç°ç ç ç«¯è¾ƒè½»ï¼Œåˆ™ç»§ç»­å¢åŠ ä¸€ä¸ªè¾ƒå°ä¸€ç‚¹çš„ç ç ã€‚ç›´è‡³å¤©å¹³ä¸¤ç«¯å¹³è¡¡ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207144028375.png" alt="image-20241207144028375"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207144527257.png" alt="image-20241207144527257"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207144601805.png" alt="image-20241207144601805"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207144649256.png" alt="image-20241207144649256"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207144659421.png" alt="image-20241207144659421"></p>
<h3 id="dian-lu-yuan-li">ç”µè·¯åŸç†</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207142920535.png" alt="image-20241207142920535"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207143812523.png" alt="image-20241207143812523"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207143952014.png" alt="image-20241207143952014"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207144920604.png" alt="image-20241207144920604"></p>
<h3 id="zhuan-huan-guo-cheng-fen-xi">è½¬æ¢è¿‡ç¨‹åˆ†æ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207145340136.png" alt="image-20241207145340136"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207145417112.png" alt="image-20241207145417112"></p>
<h2 id="adc-gong-neng-fen-xi">ADCåŠŸèƒ½åˆ†æ</h2>
<h3 id="mo-ni-dian-yuan-amp-mo-ni-can-kao-dian-ya">æ¨¡æ‹Ÿç”µæº &amp; æ¨¡æ‹Ÿå‚è€ƒç”µå‹</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207150154532.png" alt="image-20241207150154532"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207150859556.png" alt="image-20241207150859556"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207150113218.png" alt="image-20241207150113218"></p>
<h3 id="shu-ru-tong-dao">è¾“å…¥é€šé“</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207151028730.png" alt="image-20241207151028730"></p>
<h3 id="tong-dao-zu-ruo-gan-tong-dao-de-luo-ji-zu-zhi-xu-lie">é€šé“ç»„ï¼ˆè‹¥å¹²é€šé“çš„é€»è¾‘ç»„ç»‡åºåˆ—ï¼‰</h3>
<blockquote>
<p>[!NOTE]</p>
<p>ç±»æ¯”ä¸€ä¸‹æ­Œæ›²å’Œæ­Œå•çš„å…³ç³»ï¼š</p>
<ul>
<li>å¯ä»¥å°†æ¯ä¸ªé€šé“çš„è½¬æ¢ä»»åŠ¡ç±»æ¯”ä¸ºä¸€é¦–æ­Œæ›²çš„æ’­æ”¾</li>
<li>æˆ‘ä»¬å¯ä»¥å°†è‹¥å¹²é¦–æ­ŒæŒ‰ç…§è‡ªå·±çˆ±å¥½çš„æ’­æ”¾é¡ºåºç»„ç»‡ä¸ºä¸€ä¸ªæƒ¯å¸¸æ­Œå•åˆ—è¡¨ï¼ˆå¸¸è§„ç»„ï¼‰ï¼Œå¹¶è¿›è¡Œé¡ºåº/å¾ªç¯æ”¾</li>
<li>æœ‰æ—¶çªç„¶å…´èµ·ï¼Œç‰¹åˆ«æƒ³å¬å‡ é¦–æ­Œï¼Œäºæ˜¯å°†å®ƒä»¬æ’é˜Ÿåˆ°å½“å‰æ’­æ”¾åˆ—è¡¨ä¸­ï¼ˆä¾‹å¦‚â€œä¸‹ä¸€é¦–æ’­æ”¾â€åŠŸèƒ½ï¼‰ï¼Œè¿™æ ·å®ƒä»¬èƒ½å¤Ÿæ¯”æƒ¯å¸¸åˆ—è¡¨ä¸­çš„æ­Œæ›²ä¼˜å…ˆæ’­æ”¾</li>
</ul>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207151700153.png" alt="image-20241207151700153"></p>
<h4 id="chang-gui-zu">å¸¸è§„ç»„</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207152657556.png" alt="image-20241207152657556"></p>
<h4 id="cha-ru-zu">æ’å…¥ç»„</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207153813447.png" alt="image-20241207153813447"></p>
<h3 id="hong-fa-yuan">è§¦å‘æº</h3>
<h4 id="ruan-jian-hong-fa">è½¯ä»¶è§¦å‘</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207154500929.png" alt="image-20241207154500929"></p>
<h3 id="zhuan-huan-fang-shi">è½¬æ¢æ–¹å¼</h3>
<blockquote>
<p>[!NOTE]</p>
<p>ç±»æ¯”æ­Œå•æ’­æ”¾ï¼š</p>
<ul>
<li>æ‰«ææ¨¡å¼ï¼šå¼€å¯åˆ™è‡ªä¸Šè€Œä¸‹é¡ºåºæ’­æ”¾æ­Œå•åˆ—è¡¨ï¼›å…³é—­åˆ™ä»…æ’­æ”¾åˆ—è¡¨ä¸­ç¬¬ä¸€é¦–æ­Œ</li>
<li>è¿ç»­è½¬æ¢ï¼šæ˜¯å¦å¾ªç¯æ’­æ”¾
<ul>
<li>æ‰«æ+è¿ç»­ï¼šå¾ªç¯æ’­æ”¾æ­Œå•</li>
<li>éæ‰«æ+è¿ç»­ï¼šå¾ªç¯æ’­æ”¾æ­Œå•ç¬¬ä¸€é¦–æ­Œ</li>
</ul>
</li>
</ul>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207154823940.png" alt="image-20241207154823940"></p>
<h3 id="shi-jian-amp-zhong-duan">äº‹ä»¶ &amp; ä¸­æ–­</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207155421171.png" alt="image-20241207155421171"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207211313719.png" alt="image-20241207211313719"></p>
<h4 id="zhuan-huan-jie-shu-zhong-duan">è½¬æ¢ç»“æŸä¸­æ–­</h4>
<p>æ•°æ®è½¬æ¢ç»“æŸåï¼Œå¯ä»¥äº§ç”Ÿä¸­æ–­ï¼Œä¸­æ–­åˆ†ä¸ºä¸‰ç§ï¼šè§„åˆ™é€šé“è½¬æ¢ç»“æŸä¸­æ–­ï¼Œæ³¨å…¥è½¬æ¢é€šé“è½¬æ¢ç»“æŸä¸­æ–­ï¼Œæ¨¡æ‹Ÿçœ‹é—¨ç‹—ä¸­æ–­ã€‚å…¶ä¸­è½¬æ¢ç»“æŸä¸­æ–­å¾ˆå¥½ç†è§£ï¼Œè·Ÿæˆ‘ä»¬å¹³æ—¶æ¥è§¦çš„ä¸­æ–­ä¸€æ ·ï¼Œæœ‰ç›¸åº”çš„ä¸­æ–­æ ‡å¿—ä½å’Œä¸­æ–­ä½¿èƒ½ä½ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®ä¸­æ–­ç±»å‹å†™ç›¸åº”é…å¥—çš„ä¸­æ–­æœåŠ¡ç¨‹åºã€‚</p>
<h4 id="mo-ni-kan-men-gou-zhong-duan">æ¨¡æ‹Ÿçœ‹é—¨ç‹—ä¸­æ–­</h4>
<p>å½“è¢« ADC è½¬æ¢çš„æ¨¡æ‹Ÿç”µå‹ä½äºä½é˜ˆå€¼æˆ–è€…é«˜äºé«˜é˜ˆå€¼æ—¶ï¼Œå°±ä¼šäº§ç”Ÿä¸­æ–­ï¼Œå‰ææ˜¯æˆ‘ä»¬å¼€å¯äº†æ¨¡æ‹Ÿçœ‹é—¨ç‹—ä¸­æ–­ï¼Œå…¶ä¸­ä½é˜ˆå€¼å’Œé«˜é˜ˆå€¼ç”± ADC_LTR å’Œ ADC_HTR è®¾ç½®ã€‚ä¾‹å¦‚æˆ‘ä»¬è®¾ç½®é«˜é˜ˆå€¼æ˜¯2.5Vï¼Œé‚£ä¹ˆæ¨¡æ‹Ÿç”µå‹è¶…è¿‡ 2.5V çš„æ—¶å€™ï¼Œå°±ä¼šäº§ç”Ÿæ¨¡æ‹Ÿçœ‹é—¨ç‹—ä¸­æ–­ï¼Œåä¹‹ä½é˜ˆå€¼ä¹Ÿä¸€æ ·ã€‚</p>
<h3 id="dma-qing-qiu">DMAè¯·æ±‚</h3>
<p>è§„åˆ™å’Œæ³¨å…¥é€šé“è½¬æ¢ç»“æŸåï¼Œé™¤äº†äº§ç”Ÿä¸­æ–­å¤–ï¼Œè¿˜å¯ä»¥äº§ç”ŸDMAè¯·æ±‚ï¼ŒæŠŠè½¬æ¢å¥½çš„æ•°æ®ç›´æ¥å­˜å‚¨åœ¨å†…å­˜é‡Œé¢ã€‚è¦æ³¨æ„çš„æ˜¯åªæœ‰<strong>ADC1å’ŒADC3å¯ä»¥äº§ç”ŸDMAè¯·æ±‚</strong>ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207155811981.png" alt="image-20241207155811981"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207155845368.png" alt="image-20241207155845368"></p>
<h3 id="shu-ju-dui-qi">æ•°æ®å¯¹é½</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207160310466.png" alt="image-20241207160310466"></p>
<h3 id="zhuan-huan-shi-jian-ji-suan">è½¬æ¢æ—¶é—´è®¡ç®—</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207160652894.png" alt="image-20241207160652894"></p>
<h1 id="an-li-cai-ji-ke-bian-dian-zu-dian-ya">æ¡ˆä¾‹-é‡‡é›†å¯å˜ç”µé˜»ç”µå‹</h1>
<h2 id="ying-jian-dian-lu">ç¡¬ä»¶ç”µè·¯</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207170951408.png" alt="image-20241207170951408"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207170929018.png" alt="image-20241207170929018"></p>
<h2 id="ji-cun-qi-fen-xi">å¯„å­˜å™¨åˆ†æ</h2>
<h3 id="rcc-shi-zhong">RCCæ—¶é’Ÿ</h3>
<blockquote>
<p>[!NOTE]</p>
<p>è™½ç„¶æŒ‚è½½åœ¨APB2ä¸Šï¼Œä½†æ˜¯ADCçš„æœ€å¤§è¾“å…¥é¢‘ç‡ä¸º14MHz</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207171058355.png" alt="image-20241207171058355"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207171350684.png" alt="image-20241207171350684"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207171330944.png" alt="image-20241207171330944"></p>
<h3 id="adc-shu-ru-shi-zhong-yu-fen-pin">ADCè¾“å…¥æ—¶é’Ÿé¢„åˆ†é¢‘</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207172036548.png" alt="image-20241207172036548"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207172049933.png" alt="image-20241207172049933"></p>
<p>ç”±äºAPB2ä¸º72MHzï¼Œè¦æ»¡è¶³ADCè¾“å…¥æ—¶é’Ÿæœ€å¤§14MHzçš„è¦æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®é¢„åˆ†é¢‘ä¸º6ã€‚</p>
<h3 id="gpio-gong-zuo-mo-shi">GPIOå·¥ä½œæ¨¡å¼</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207172607090.png" alt="image-20241207172607090"></p>
<p>GPIOå·¥ä½œæ¨¡å¼éœ€è¦é…ç½®æ¨¡æ‹Ÿä¿¡å·è¾“å…¥ï¼Œç”±äºä¸éœ€è¦ç»è¿‡TTLé‡‡æ ·åˆ°IDRä¸­ï¼Œå› æ­¤GPIOçš„æ—¶é’Ÿå¯ä»¥ä¸ç”¨å¼€å¯ã€‚</p>
<blockquote>
<p>[!TIP]</p>
<p>ä½†ä¸ºäº†ç»Ÿä¸€ç¼–ç¨‹ï¼Œæœ€å¥½è¿˜æ˜¯å…»æˆç”¨åˆ°äº†GPIOåˆ™å¼€å¯å¯¹åº”æ—¶é’Ÿçš„ä¹ æƒ¯ï¼Œé™¤éæœ‰ç‰¹æ®Šçš„è€ƒé‡ã€‚</p>
</blockquote>
<h3 id="bian-pai-chang-gui-zu-tong-dao-xu-lie">ç¼–æ’å¸¸è§„ç»„é€šé“åºåˆ—</h3>
<p>ç°åœ¨å¤–éƒ¨æ¨¡æ‹Ÿä¿¡å·èƒ½å¤Ÿé€šè¿‡PC0åˆ°è¾¾ADC1é€šé“10äº†ï¼Œæˆ‘ä»¬éœ€è¦å°†é€šé“ç»„ç»‡åˆ°å¸¸è§„ç»„ä¸­ï¼Œè¿™æ ·ADCæ‰èƒ½çŸ¥é“æŒ‰ç…§ä»€ä¹ˆæµç¨‹æ¥æ‰§è¡Œè¿™äº›é€šé“çš„è½¬æ¢ä»»åŠ¡ã€‚</p>
<h4 id="xu-lie-shu-liang">åºåˆ—æ•°é‡</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207173824003.png" alt="image-20241207173824003"></p>
<p>è¿™é‡Œæˆ‘ä»¬åªä½¿ç”¨é€šé“10æ¥é‡‡é›†å¯å˜ç”µé˜»ç”µå‹ï¼Œå› æ­¤åºåˆ—åªéœ€åŒ…å«é€šé“10å³å¯ï¼Œæ•°é‡ä¸º1.</p>
<h4 id="xu-lie-shun-xu">åºåˆ—é¡ºåº</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207174007845.png" alt="image-20241207174007845"></p>
<p>é€šè¿‡SQ1å¯ä»¥æŒ‡å®šå¸¸è§„ç»„ä¸­ç¬¬ä¸€ä¸ªè¦è½¬æ¢çš„é€šé“ç¼–å·ï¼ˆä»0åˆ°17ï¼‰ï¼ŒSQ2åˆ™ç”¨æ¥æŒ‡å®šç¬¬äºŒä¸ªè¦è½¬æ¢çš„é€šé“ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<h3 id="adc-kong-zhi-xiang-guan">ADCæ§åˆ¶ç›¸å…³</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207181439887.png" alt="image-20241207181439887"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207181613976.png" alt="image-20241207181613976"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ADCæ§åˆ¶ç›¸å…³</span>
<span class="token comment">// å…³é—­æ‰«ææ¨¡å¼ï¼Œå¸¸è§„ç»„åªæœ‰ä¸€ä¸ªé€šé“</span>
ADC1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_CR1_SCAN<span class="token punctuation">;</span>
<span class="token comment">// å¼€å¯è¿ç»­æ¨¡å¼ï¼Œå¾ªç¯é‡‡æ ·å¯è°ƒç”µé˜»ç”µå‹</span>
ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_CONT<span class="token punctuation">;</span>
<span class="token comment">// æ•°æ®å¯¹é½ï¼šå³å¯¹é½</span>
ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_CR2_ALIGN<span class="token punctuation">;</span>
<span class="token comment">// ä½¿èƒ½å¤–éƒ¨è§¦å‘ADCé‡‡æ ·</span>
ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_EXTTRIG<span class="token punctuation">;</span>
<span class="token comment">// å¤–éƒ¨è§¦å‘æºé€‰æ‹©è½¯ä»¶è§¦å‘ =&gt; 111</span>
ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_EXTSEL<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="cai-yang-shi-jian">é‡‡æ ·æ—¶é—´</h3>
<h4 id="strong-cai-yang-shi-jian-de-zuo-yong-strong"><strong>é‡‡æ ·æ—¶é—´çš„ä½œç”¨</strong></h4>
<ul>
<li>ADC å†…éƒ¨æœ‰ä¸€ä¸ªé‡‡æ ·ä¿æŒç”µè·¯ï¼Œç”±é‡‡æ ·ç”µå®¹å’Œå¼€å…³ç»„æˆã€‚åœ¨é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œé‡‡æ ·ç”µå®¹éœ€è¦é€šè¿‡è¾“å…¥ä¿¡å·çš„é©±åŠ¨å®Œæˆå……ç”µï¼Œé‡‡æ ·æ—¶é—´å°±æ˜¯ç»™é‡‡æ ·ç”µå®¹å……ç”µåˆ°ç›®æ ‡ç”µå‹æ‰€éœ€è¦çš„æ—¶é—´ã€‚</li>
<li>å¦‚æœé‡‡æ ·æ—¶é—´å¤ªçŸ­ï¼Œé‡‡æ ·ç”µå®¹æœªå……æ»¡ï¼Œç”µå‹è¾¾ä¸åˆ°ç¨³å®šå€¼ï¼Œä¼šå¯¼è‡´ ADC è¾“å‡ºçš„æ•°å­—å€¼ä¸å‡†ç¡®ã€‚</li>
</ul>
<h4 id="strong-cai-yang-shi-jian-you-shi-yao-jue-ding-strong"><strong>é‡‡æ ·æ—¶é—´ç”±ä»€ä¹ˆå†³å®š</strong></h4>
<ul>
<li><strong>è¾“å…¥é˜»æŠ—ï¼š</strong> è¾“å…¥ä¿¡å·æºçš„é˜»æŠ—è¶Šé«˜ï¼Œé‡‡æ ·ç”µå®¹å……ç”µè¶Šæ…¢ï¼Œéœ€è¦æ›´é•¿çš„é‡‡æ ·æ—¶é—´ã€‚</li>
<li><strong>ADC é‡‡æ ·ç”µå®¹ï¼š</strong> STM32 çš„é‡‡æ ·ç”µå®¹é€šå¸¸åœ¨å‡ å pF åˆ°å‡ ç™¾ pF èŒƒå›´ã€‚</li>
<li><strong>ä¿¡å·é¢‘ç‡ï¼š</strong> é«˜é¢‘ä¿¡å·éœ€è¦æ›´å¿«çš„é‡‡æ ·æ—¶é—´ï¼Œä½†ä»éœ€è¶³å¤Ÿæ—¶é—´å……ç”µã€‚</li>
</ul>
<h4 id="adc-dian-qi-te-xing">ADCç”µæ°”ç‰¹æ€§</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207212034901.png" alt="image-20241207212034901"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207181039478.png" alt="image-20241207181039478"></p>
<h4 id="cai-yang-shi-jian-she-zhi">é‡‡æ ·æ—¶é—´è®¾ç½®</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207182324177.png" alt="image-20241207182324177"></p>
<h3 id="adc-huan-xing-amp-xiao-zhun">ADCå”¤é†’ &amp; æ ¡å‡†</h3>
<h4 id="adc-huan-xing-amp-guan-bi-amp-hong-fa-ad-zhuan-huan">ADCå”¤é†’ &amp; å…³é—­ &amp; è§¦å‘ADè½¬æ¢</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207190825998.png" alt="image-20241207190825998"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207190616679.png" alt="image-20241207190616679"></p>
<blockquote>
<p>[!NOTE]</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡ADONå¼€å¯è½¬æ¢é’ˆå¯¹çš„æ˜¯å¸¸è§„ç»„ã€‚</p>
</blockquote>
<h4 id="adc-xiao-zhun">ADCæ ¡å‡†</h4>
<p>ADCæ ¡å‡†èƒ½å¤Ÿæ˜¾è‘—å‡å°‘ç”±äºå†…éƒ¨ç”µå®¹ç»„å˜åŒ–å¯¼è‡´çš„ç²¾åº¦é”™è¯¯ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207191313952.png" alt="image-20241207191313952"></p>
<blockquote>
<p>[!NOTE]</p>
<ul>
<li>å»ºè®®æ¯æ¬¡å”¤é†’ADCåï¼Œéƒ½æ‰§è¡Œä¸€æ¬¡æ ¡å‡†</li>
<li>å¿…é¡»åœ¨ADCä¸Šç”µè‡³å°‘ä¸¤ä¸ªADCæ—¶é’Ÿå‘¨æœŸåï¼Œæ‰å¼€å§‹æ ¡å‡†</li>
</ul>
</blockquote>
<h3 id="ruan-jian-hong-fa-ad-zhuan-huan">è½¯ä»¶è§¦å‘ADè½¬æ¢</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207193334202.png" alt="image-20241207193334202"></p>
<h3 id="zhuang-tai-ji-cun-qi">çŠ¶æ€å¯„å­˜å™¨</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207194215560.png" alt="image-20241207194215560"></p>
<h3 id="shi-xu-kong-zhi">æ—¶åºæ§åˆ¶</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207193043135.png" alt="image-20241207193043135"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207192938318.png" alt="image-20241207192938318"></p>
<h3 id="shi-li-dai-ma">ç¤ºä¾‹ä»£ç </h3>
<h4 id="adc-h">adc.h</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__ADC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__ADC_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">ADC1_StartConvert</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">ADC1_ReadVoltage</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __ADC_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="adc-c">adc.c</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ADCè¾“å…¥æ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_ADC1EN<span class="token punctuation">;</span>
    <span class="token comment">// APB2 6åˆ†é¢‘ =&gt; 10</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token operator">~</span>RCC_CFGR_ADCPRE<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_ADCPRE_1<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token operator">~</span>RCC_CFGR_ADCPRE_0<span class="token punctuation">;</span>

    <span class="token comment">// GPIOå·¥ä½œæ¨¡å¼é…ç½®ä¸ºæ¨¡æ‹Ÿè¾“å…¥ MODE=00 CNF=00</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPCEN<span class="token punctuation">;</span>
    GPIOC<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span> GPIO_CRL_CNF0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç¼–æ’å¸¸è§„ç»„é€šé“åºåˆ—</span>
    <span class="token comment">// åºåˆ—æ•°é‡ä¸º1 =&gt; 0000</span>
    ADC1<span class="token operator">-&gt;</span>SQR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SQR1_L<span class="token punctuation">;</span>
    <span class="token comment">// å°†é€šé“10é…ç½®ä¸ºè½¬æ¢åºåˆ—ç¬¬ä¸€ä¸ª =&gt; 01010</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SQR3_SQ1<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">|=</span> ADC_SQR3_SQ1_3<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">|=</span> ADC_SQR3_SQ1_1<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®é€šé“10çš„é‡‡æ ·æ—¶é—´ 13.5 cycles =&gt; 010</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP10<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP10_2<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">|=</span> ADC_SMPR1_SMP10_1<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP10_0<span class="token punctuation">;</span>

    <span class="token comment">// ADCæ§åˆ¶ç›¸å…³</span>
    <span class="token comment">// å…³é—­æ‰«ææ¨¡å¼ï¼Œå¸¸è§„ç»„åªæœ‰ä¸€ä¸ªé€šé“</span>
    ADC1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_CR1_SCAN<span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯è¿ç»­æ¨¡å¼ï¼Œå¾ªç¯é‡‡æ ·å¯è°ƒç”µé˜»ç”µå‹</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_CONT<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®å¯¹é½ï¼šå³å¯¹é½</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_CR2_ALIGN<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½å¤–éƒ¨è§¦å‘ADCé‡‡æ ·</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_EXTTRIG<span class="token punctuation">;</span>
    <span class="token comment">// å¤–éƒ¨è§¦å‘æºé€‰æ‹©è½¯ä»¶è§¦å‘ =&gt; 111</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_EXTSEL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ADC1_StartConvert</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å”¤é†’ADC</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_ADON<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…è‡³å°‘ä¸¤ä¸ªADCæ—¶é’Ÿå‘¨æœŸåå¼€å§‹æ‰§è¡Œæ ¡å‡†</span>
    <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_CAL<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…æ ¡å‡†ç»“æŸ</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;</span> ADC_CR2_CAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è½¯ä»¶è§¦å‘å¼€å§‹è½¬æ¢ï¼Œç”±äºé…ç½®äº†è¿ç»­æ¨¡å¼ï¼Œå› æ­¤è§¦å‘ä¸€æ¬¡åå¸¸è§„ç»„çš„è½¬æ¢ä¼šå¾ªç¯ä¸æ–­</span>
    <span class="token comment">// ä¹Ÿå¯ä»¥é€šè¿‡ADONè§¦å‘å¸¸è§„ç»„è½¬æ¢</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_SWSTART<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…ç¬¬ä¸€æ¬¡è½¬æ¢å®Œæˆ</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> ADC_SR_EOC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">ADC1_ReadVoltage</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> adc_val <span class="token operator">=</span> ADC1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
    <span class="token keyword">double</span> voltage <span class="token operator">=</span> adc_val <span class="token operator">*</span> <span class="token number">3.3</span> <span class="token operator">/</span> <span class="token number">4095</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"adc_val = %d, voltage = %.2fV"</span><span class="token punctuation">,</span> adc_val<span class="token punctuation">,</span> voltage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> voltage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token function">ADC1_StartConvert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ADC1_ReadVoltage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-shi-xian">HALå®ç°</h2>
<h4 id="cube-pei-zhi">Cubeé…ç½®</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207202209344.png" alt="image-20241207202209344"></p>
<blockquote>
<p>[!TIP]</p>
<p>æˆ‘ä»¬å¯ä»¥å­¦ä¹ Cubeå›¾å½¢åŒ–ç•Œé¢ä¸­å¯¹å„ä¸ªå¯„å­˜å™¨çš„ç¼–æ’å½¢å¼æ¥æ¨¡å—åŒ–ç†è§£å¯„å­˜å™¨ã€‚</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207202257369.png" alt="image-20241207202257369"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207202232215.png" alt="image-20241207202232215"></p>
<h4 id="main-c-1">main.c</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_ADC1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token comment">// perform calibration before start adc</span>
  <span class="token function">HAL_ADCEx_Calibration_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_ADC_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">double</span> v <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3.3</span> <span class="token operator">/</span> <span class="token number">4095</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v = %.2fV\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END WHILE */</span>
  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="an-li-duo-tong-dao-dma">æ¡ˆä¾‹-å¤šé€šé“+DMA</h1>
<h2 id="xu-qiu">éœ€æ±‚</h2>
<p>PC0æ˜¯10é€šé“ï¼Œé‡‡é›†çš„æ˜¯å¯å˜ç”µé˜»å™¨çš„ç”µå‹ã€‚PC2å¯¹åº”çš„æ˜¯12é€šé“ï¼Œä½¿ç”¨æœé‚¦çº¿è¿æ¥åˆ°ç”µæºæˆ–åœ°ï¼Œæµ‹è¯•ä»–ä»¬çš„ç”µå‹ã€‚</p>
<p>å½“å¤šä¸ªé€šé“åŒæ—¶é‡‡é›†æ—¶ï¼Œä¸€èˆ¬å°±éœ€è¦ä½¿ç”¨DMAæ¥ä¼ è¾“æ•°æ®ï¼Œå¦åˆ™æ•°æ®å¦‚æœæ¥ä¸åŠå–å‡ºï¼Œåˆ™ä¼šå¯¼è‡´æ•°æ®è¢«è¦†ç›–ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241207214851385.png" alt="image-20241207214851385"></p>
<h2 id="shi-li-dai-ma-1">ç¤ºä¾‹ä»£ç </h2>
<h3 id="adc-h-1">adc.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__ADC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__ADC_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">ADC1_StartConvert_DMA</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> bufAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __ADC_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="adc-c-1">adc.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ADCè¾“å…¥æ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_ADC1EN<span class="token punctuation">;</span>
    <span class="token comment">// APB2 6åˆ†é¢‘ =&gt; 10</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token operator">~</span>RCC_CFGR_ADCPRE<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_ADCPRE_1<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token operator">~</span>RCC_CFGR_ADCPRE_0<span class="token punctuation">;</span>

    <span class="token comment">// GPIOå·¥ä½œæ¨¡å¼é…ç½®ä¸ºæ¨¡æ‹Ÿè¾“å…¥ MODE=00 CNF=00</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPCEN<span class="token punctuation">;</span>
    GPIOC<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_MODE0 <span class="token operator">|</span> GPIO_CRL_CNF0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOC<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRL_MODE2 <span class="token operator">|</span> GPIO_CRL_CNF2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç¼–æ’å¸¸è§„ç»„é€šé“åºåˆ—</span>
    <span class="token comment">// åºåˆ—æ•°é‡ä¸º2 =&gt; 0001</span>
    ADC1<span class="token operator">-&gt;</span>SQR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SQR1_L<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SQR1 <span class="token operator">|=</span> ADC_SQR1_L_0<span class="token punctuation">;</span>
    <span class="token comment">// å°†é€šé“10é…ç½®ä¸ºè½¬æ¢åºåˆ—ç¬¬ä¸€ä¸ª =&gt; 01010</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SQR3_SQ1<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">|=</span> ADC_SQR3_SQ1_3<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">|=</span> ADC_SQR3_SQ1_1<span class="token punctuation">;</span>
    <span class="token comment">// å°†é€šé“12é…ç½®ä¸ºè½¬æ¢åºåˆ—ç¬¬äºŒä¸ª =&gt; 01100</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SQR3_SQ2<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">|=</span> ADC_SQR3_SQ2_3<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SQR3 <span class="token operator">|=</span> ADC_SQR3_SQ2_2<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®é€šé“10çš„é‡‡æ ·æ—¶é—´ 7.5 cycles =&gt; 001</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP10<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP10_2<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP10_1<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">|=</span> ADC_SMPR1_SMP10_0<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®é€šé“12çš„é‡‡æ ·æ—¶é—´ 7.5 cycles =&gt; 001</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP12<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP12_2<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_SMPR1_SMP12_1<span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>SMPR1 <span class="token operator">|=</span> ADC_SMPR1_SMP12_0<span class="token punctuation">;</span>

    <span class="token comment">// ADCæ§åˆ¶ç›¸å…³</span>
    <span class="token comment">// å¼€å¯æ‰«ææ¨¡å¼ï¼Œå¸¸è§„ç»„æœ‰ä¸¤ä¸ªé€šé“</span>
    ADC1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> ADC_CR1_SCAN<span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯è¿ç»­æ¨¡å¼</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_CONT<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®å¯¹é½ï¼šå³å¯¹é½</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>ADC_CR2_ALIGN<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½å¤–éƒ¨è§¦å‘ADCé‡‡æ ·</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_EXTTRIG<span class="token punctuation">;</span>
    <span class="token comment">// å¤–éƒ¨è§¦å‘æºé€‰æ‹©è½¯ä»¶è§¦å‘ =&gt; 111</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_EXTSEL<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½DMAæ¨¡å¼</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_DMA<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init_DMA_Channel</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> bufAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> dataSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä½¿èƒ½DMAæ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>AHBENR <span class="token operator">|=</span> RCC_AHBENR_DMA1EN<span class="token punctuation">;</span>
    <span class="token comment">// ADC1ä½¿ç”¨DMA1é€šé“1</span>
    <span class="token comment">// ä»å¤–è®¾è¯»åˆ°å†…å­˜</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_DIR<span class="token punctuation">;</span>
    <span class="token comment">// æºåœ°å€å’Œç›®æ ‡åœ°å€</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CPAR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>DR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CMAR <span class="token operator">=</span> bufAddr<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®å®½åº¦å’Œæ•°é‡ï¼Œæ³¨æ„DMAçš„DRæ˜¯16bit</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_MSIZE<span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_MSIZE_0<span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_PSIZE<span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_PSIZE_0<span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CNDTR <span class="token operator">=</span> dataSize<span class="token punctuation">;</span>
    <span class="token comment">// ADC.DRåœ°å€ä¸å˜ï¼Œå†…å­˜åœ°å€è‡ªå¢</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>DMA_CCR1_PINC<span class="token punctuation">;</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_MINC<span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯å¾ªç¯æ¨¡å¼ï¼Œå’ŒADCè¿ç»­æ¨¡å¼é…åˆ</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_CIRC<span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯DMAé€šé“</span>
    DMA1_Channel1<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> DMA_CCR1_EN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ADC1_StartConvert_DMA</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> bufAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> dataSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å”¤é†’ADC</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_ADON<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…è‡³å°‘ä¸¤ä¸ªADCæ—¶é’Ÿå‘¨æœŸåå¼€å§‹æ‰§è¡Œæ ¡å‡†</span>
    <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_CAL<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…æ ¡å‡†ç»“æŸ</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;</span> ADC_CR2_CAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¼€å§‹è½¬æ¢å‰å»ºç«‹DMAé€šé“</span>
    <span class="token function">Init_DMA_Channel</span><span class="token punctuation">(</span>bufAddr<span class="token punctuation">,</span> dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è½¯ä»¶è§¦å‘å¼€å§‹è½¬æ¢</span>
    ADC1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> ADC_CR2_SWSTART<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…å¸¸è§„ç»„é¦–æ¬¡è½¬æ¢å®Œæˆ</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> ADC_SR_EOC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c-2">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token class-name">uint16_t</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">ADC1_StartConvert_DMA</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"v1 = %.2fV, v2 = %.2fV"</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3.3</span> <span class="token operator">/</span> <span class="token number">4095</span><span class="token punctuation">,</span>
                  buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3.3</span> <span class="token operator">/</span> <span class="token number">4095</span><span class="token punctuation">)</span>
        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="dma-tong-dao-jian-li-shi-ji-wen-ti">DMAé€šé“å»ºç«‹æ—¶æœºé—®é¢˜</h2>
<blockquote>
<p>[!TIP]</p>
<p>åº”è¯¥åœ¨ADCä¸Šç”µåï¼Œå†å»ºç«‹DMAé€šé“ï¼›åœ¨ADCæ‰ç”µçŠ¶æ€å»ºç«‹DMAé€šé“åˆ™å¯èƒ½å¤±è´¥ã€‚</p>
<p>åœ¨å»ºç«‹DMAé€šé“æ—¶ï¼Œåº”è¯¥ç¡®ä¿åŒæ–¹æ˜¯æ´»è·ƒçŠ¶æ€ã€‚</p>
</blockquote>
<h2 id="hal-ku-shi-xian">HALåº“å®ç°</h2>
<h3 id="chang-gui-zu-tong-dao-bian-pai">å¸¸è§„ç»„é€šé“ç¼–æ’</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208083218931.png" alt="image-20241208083218931"></p>
<h3 id="kai-qi-dma">å¼€å¯DMA</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208083357152.png" alt="image-20241208083357152"></p>
<h3 id="jin-yong-dma-zhong-duan">ç¦ç”¨DMAä¸­æ–­</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208083449124.png" alt="image-20241208083449124"></p>
<h3 id="adc-shi-zhong-yu-fen-pin">ADCæ—¶é’Ÿé¢„åˆ†é¢‘</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208083304844.png" alt="image-20241208083304844"></p>
<h3 id="main-c-3">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_DMA_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_ADC1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token class-name">uint16_t</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">HAL_ADCEx_Calibration_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_ADC_Start_DMA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"V1 = %.2fV, V2 = %.2fV\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3.3</span> <span class="token operator">/</span> <span class="token number">4095</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3.3</span> <span class="token operator">/</span> <span class="token number">4095</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END WHILE */</span>

  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="yuan-ma-fen-xi">æºç åˆ†æ</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">HAL_StatusTypeDef <span class="token function">HAL_ADC_Start_DMA</span><span class="token punctuation">(</span>ADC_HandleTypeDef<span class="token operator">*</span> hadc<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span><span class="token operator">*</span> pData<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> Length<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* Enable the ADC peripheral */</span>
    tmp_hal_status <span class="token operator">=</span> <span class="token function">ADC_Enable</span><span class="token punctuation">(</span>hadc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 	<span class="token comment">/* Start the DMA channel */</span>
  	<span class="token function">HAL_DMA_Start_IT</span><span class="token punctuation">(</span>hadc<span class="token operator">-&gt;</span>DMA_Handle<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>hadc<span class="token operator">-&gt;</span>Instance<span class="token operator">-&gt;</span>DR<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pData<span class="token punctuation">,</span> Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>ADC</tag>
      </tags>
  </entry>
  <entry>
    <title>ç®€æ˜“ç‰ˆè£¸æœºå¤šä»»åŠ¡è°ƒåº¦æ¡†æ¶</title>
    <url>/2024/11/26/21297.html</url>
    <content><![CDATA[<h1 id="kuang-jia-jian-mo">æ¡†æ¶å»ºæ¨¡</h1>
<h2 id="kuang-jia-chou-xiang">æ¡†æ¶æŠ½è±¡</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126093047180.png" alt="image-20241126093047180"></p>
<h2 id="mo-kuai-hua-fen">æ¨¡å—åˆ’åˆ†</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241126094329449.png" alt="image-20241126094329449"></p>
<h1 id="scheduler">Scheduler</h1>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/25.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SCHEDULER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SCHEDULER_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"gd32f4xx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdbool.h"</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">task_function_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
    TASK_READY<span class="token punctuation">,</span>
    TASK_RUNNING<span class="token punctuation">,</span>
    TASK_WAITING
<span class="token punctuation">}</span> <span class="token class-name">task_state_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token class-name">task_state_t</span>  task_state<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> task_interval_ms<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> task_time_waiting_ms<span class="token punctuation">;</span>
    <span class="token class-name">task_function_t</span> task_function<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">task_t</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">task_update</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">task_execute</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span><span class="token comment">//__SCHEDULER_H</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/25.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scheduler.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"app.h"</span></span>

<span class="token keyword">static</span> <span class="token class-name">task_t</span> tasks<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        TASK_READY<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> app_ui_led_flow<span class="token punctuation">,</span>
        TASK_READY<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> app_debug_key_scan<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> TASK_SIZE <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tasks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">task_update</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TASK_SIZE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_time_waiting_ms<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_time_waiting_ms <span class="token operator">&gt;=</span> tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_interval_ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_state <span class="token operator">=</span> TASK_READY<span class="token punctuation">;</span>
            tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_time_waiting_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">task_execute</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TASK_SIZE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_state <span class="token operator">==</span> TASK_READY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_state <span class="token operator">=</span> TASK_RUNNING<span class="token punctuation">;</span>
            tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">task_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>task_state <span class="token operator">=</span> TASK_WAITING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="app">App</h1>
<h2 id="ren-wu-jie-kou-guan-li">ä»»åŠ¡æ¥å£ç®¡ç†</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/25.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">APP_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APP_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">app_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">app_ui_led_flow</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">app_debug_key_scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span><span class="token comment">//APP_H</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ying-yong-chu-shi-hua">åº”ç”¨åˆå§‹åŒ–</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/25.</span>
<span class="token comment">//</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"app.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"int_led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"int_key.h"</span></span>

<span class="token keyword">void</span> <span class="token function">app_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">int_led_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">int_key_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"app_init done"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="liu-shui-deng-ren-wu-shi-xian">æµæ°´ç¯ä»»åŠ¡å®ç°</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/25.</span>
<span class="token comment">//</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"app.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"int_led.h"</span></span>

<span class="token keyword">void</span> <span class="token function">app_ui_led_flow</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//    LOG_DEBUG("app_ui_led_flow invoke")</span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> led_index <span class="token operator">=</span> LED1<span class="token punctuation">;</span>
    <span class="token function">int_led_on</span><span class="token punctuation">(</span>led_index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    led_index<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>led_index <span class="token operator">==</span> LED_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">int_led_off_all</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        led_index <span class="token operator">=</span> LED1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="an-jian-sao-miao-ren-wu-shi-xian">æŒ‰é”®æ‰«æä»»åŠ¡å®ç°</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/25.</span>
<span class="token comment">//</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"app.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"int_key.h"</span></span>

<span class="token keyword">void</span> <span class="token function">app_debug_key_scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">int_key_scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">key_up_callback</span><span class="token punctuation">(</span>KEY_NO key_no<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"key up"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">key_down_callback</span><span class="token punctuation">(</span>KEY_NO key_no<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"key down"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ding-shi-qi-geng-xin-ren-wu-zhuang-tai">å®šæ—¶å™¨æ›´æ–°ä»»åŠ¡çŠ¶æ€</h1>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">hal_timer5_update_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">task_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>æ¶æ„</category>
      </categories>
      <tags>
        <tag>å¤šä»»åŠ¡</tag>
        <tag>è°ƒåº¦</tag>
      </tags>
  </entry>
  <entry>
    <title>å®šæ—¶å™¨çš„æœ¬è´¨å°±æ˜¯æ•°æ•°ï¼ˆåŸºäºSTM32F103æ·±å…¥ç†è§£å®šæ—¶å™¨ï¼‰</title>
    <url>/2024/12/04/52886.html</url>
    <content><![CDATA[<h1 id="can-kao-shou-ce">å‚è€ƒæ‰‹å†Œ</h1>
<ul>
<li>STM32F103å‚è€ƒæ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></li>
<li>STM32103ZEæ•°æ®æ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/datasheet/stm32f103rc.pdf">STM32F103xC, STM32F103xD, STM32F103xE </a></li>
<li>STM32F103 Cortext-M3 ç¼–ç¨‹æ‰‹å†Œ<a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xxx/20xxx/21xxx/L1xxxx CortexÂ®-M3 programming manual</a></li>
</ul>
<h1 id="xi-tong-di-ta-ding-shi-qi-sys-tick-timer">ç³»ç»Ÿå˜€å—’å®šæ—¶å™¨SysTick Timer</h1>
<p>è¯¥å®šæ—¶å™¨å’ŒåµŒå¥—å‘é‡ä¸­æ–­æ§åˆ¶å™¨NVICä¸€æ ·ï¼Œæ˜¯Cortext-M3å†…æ ¸ä¸­å†…ç½®çš„å¤–è®¾ï¼Œåœ¨<a href="https://www.st.com/resource/en/programming_manual/pm0056-stm32f10xxx20xxx21xxxl1xxxx-cortexm3-programming-manual-stmicroelectronics.pdf">STM32F10xxx/20xxx/21xxx/L1xxxx CortexÂ®-M3 programming manual</a>çš„å¦‚ä¸‹ç« èŠ‚ä¸­å¯ä»¥æŸ¥é˜…ç›¸å…³çš„è¯´æ˜ã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205082312825.png" alt="image-20241205082312825" style="zoom:33%;">
<blockquote>
<p>The processor has a 24-bit system timer, SysTick, that counts down from the reload value to zero, reloads (wraps to) the value in the LOAD register on the next clock edge, then counts down on subsequent clocks.</p>
<p>When the processor is halted for debugging the counter does not decrement.</p>
</blockquote>
<p>Cortex-M3å¤„ç†å™¨æœ‰ä¸€ä¸ª24bitçš„ç³»ç»Ÿçº§å®šæ—¶å™¨SysTickï¼Œè¯¥å®šæ—¶å™¨ä¼šä»è£…è½½å€¼å‘ä¸‹è®¡æ•°åˆ°é›¶ï¼Œç„¶ååœ¨ä¸‹ä¸ªæ—¶é’Ÿå‘¨æœŸè£…è½½LOADå¯„å­˜å™¨ä¸­æŒ‡å®šçš„é‡æ–°è£…è½½å€¼ï¼Œå¹¶åœ¨éšåçš„æ—¶é’Ÿç»§ç»­å‘ä¸‹è®¡æ•°ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ—¶ï¼Œå½“å¤„ç†å™¨å› è°ƒè¯•è€Œä¸­æ–­æ‰§è¡Œæ—¶ï¼Œè¯¥è®¡æ•°å™¨ä¸ä¼šé€’å‡ã€‚</p>
<h2 id="zhong-zhuang-zai-zhi-ji-cun-qi-load">é‡è£…è½½å€¼å¯„å­˜å™¨LOAD</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205083512747.png" alt="image-20241205083512747"></p>
<p>LOADå¯„å­˜å™¨ç”¨äºæŒ‡å®šå®šæ—¶å™¨è®¡æ•°çš„é‡è£…è½½å€¼RELOADï¼Œå½“å®šæ—¶å™¨è¢«å¯ç”¨æˆ–é€’å‡åˆ°é›¶æ—¶ï¼ŒLOADå¯„å­˜å™¨æŒ‡å®šçš„å€¼ä¼šè¢«åŠ è½½åˆ°VALå¯„å­˜å™¨ä¸­ï¼ˆè¯¥å¯„å­˜å™¨ä¸ºå®šæ—¶å™¨å½“å‰çš„è®¡æ•°å€¼ï¼‰ã€‚</p>
<p>RELOADå€¼éœ€è¦æ ¹æ®ä½¿ç”¨åœºæ™¯æ¥è®¡ç®—ï¼š</p>
<ul>
<li>å¦‚æœæƒ³è¦<mark>æ¯Nä¸ªå¤„ç†å™¨æ—¶é’Ÿå‘¨æœŸ</mark>å°±äº§ç”Ÿè§¦å‘äº‹ä»¶ï¼Œéœ€è¦å°†RELOADè®¾ç½®ä¸ºN-1ã€‚ä¾‹å¦‚æ¯100ä¸ªæ—¶é’Ÿè„‰å†²éœ€è¦è§¦å‘ä¸€æ¬¡SysTickä¸­æ–­ï¼Œéœ€è¦å°†RELOADè®¾ç½®ä¸º99ã€‚ï¼ˆå½“RELOADè®¾ç½®ä¸º99åï¼Œå¼€å¯å®šæ—¶å™¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ—¶é’Ÿè„‰å†²RELOADä¼šè¢«åŠ è½½åˆ°VALå¯„å­˜å™¨ä¸­ï¼Œå¹¶åœ¨éšåçš„æ¯ä¸ªæ—¶é’Ÿè„‰å†²å°†99é€’å‡1ï¼Œå› æ­¤åœ¨å¼€å¯å®šæ—¶å™¨åçš„ç¬¬100ä¸ªæ—¶é’Ÿè„‰å†²ï¼ŒVALä¼šå˜æˆ0ï¼Œå¹¶äº§ç”Ÿä¸­æ–­äº‹ä»¶ï¼‰ã€‚</li>
<li>å¦‚æœéœ€è¦åœ¨<mark>Nä¸ªå¤„ç†å™¨æ—¶é’Ÿå‘¨æœŸçš„å»¶æ—¶å</mark>è§¦å‘ä¸€ä¸ªå•æ¬¡çš„SysTickä¸­æ–­ï¼Œéœ€è¦å°†RELOADè®¾ç½®ä¸ºNã€‚ä¾‹å¦‚å¦‚æœéœ€è¦åœ¨400ä¸ªæ—¶é’Ÿè„‰å†²ä¹‹åè§¦å‘ä¸€æ¬¡SysTickä¸­æ–­ï¼Œéœ€è¦å°†RELOADè®¾ç½®ä¸º400ã€‚ï¼ˆå¼€å¯å®šæ—¶å™¨åï¼Œåœ¨ç¬¬ä¸€ä¸ªè„‰å†²å°†RELOADè£…è½½åˆ°VALï¼Œåœ¨ç¬¬401ä¸ªè„‰å†²VALé€’å‡ä¸º0ï¼Œå¹¶äº§ç”Ÿä¸­æ–­äº‹ä»¶ï¼‰</li>
</ul>
<p>å‰è€…å¸¸ç”¨äºå‘¨æœŸæ€§åœ°äº§ç”Ÿä¸­æ–­ï¼ˆæ¯Nä¸ªæ—¶é’Ÿå‘¨æœŸçš„æœ€åä¸€ä¸ªå‘¨æœŸè§¦å‘æ¬¡ï¼‰ï¼Œè€Œåè€…å¸¸ç”¨äºå•æ¬¡ä¸å®šé•¿åº¦çš„å»¶æ—¶ï¼ˆç­‰åˆ°Kä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæ•´ç»“æŸï¼Œç¬¬K+1ä¸ªè„‰å†²å¼€å§‹æ—¶è§¦å‘ä¸€æ¬¡äº‹ä»¶ï¼‰ã€‚</p>
<h2 id="dang-qian-ji-shu-zhi-ji-cun-qi-val">å½“å‰è®¡æ•°å€¼å¯„å­˜å™¨VAL</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205091342807.png" alt="image-20241205091342807"></p>
<p>è¯¥å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯SysTickè®¡æ•°å™¨å½“å‰çš„è®¡æ•°å€¼ã€‚è¯»æ“ä½œä¼šè¿”å›å½“å‰è®¡æ•°å€¼ï¼Œä»»ä½•å†™æ“ä½œä¼šå°†å½“å‰è®¡æ•°å€¼æ¸…é›¶ï¼Œå¹¶æ¸…é™¤CTRLå¯„å­˜å™¨ä¸­çš„COUNTFALGä½ã€‚</p>
<p>è¯¥å¯„å­˜å™¨æ˜¯SysTickå†…éƒ¨çš„ä¸€ä¸ªçŠ¶æ€å¯„å­˜å™¨ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šç›´æ¥æ“ä½œè¯¥å¯„å­˜å™¨ã€‚</p>
<h2 id="sys-tick-kong-zhi-he-zhuang-tai-ji-cun-qi-ctrl">SysTickæ§åˆ¶å’ŒçŠ¶æ€å¯„å­˜å™¨CTRL</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205083016981.png" alt="image-20241205083016981"></p>
<h3 id="ding-shi-qi-shi-neng-enable">å®šæ—¶å™¨ä½¿èƒ½ENABLE</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205083115544.png" alt="image-20241205083115544"></p>
<p>å°†ENABLEç½®ä½åï¼Œå®šæ—¶å™¨ä¼šå°†LOADå¯„å­˜å™¨ä¸­RELOADå€¼åŠ è½½åˆ°VALå¯„å­˜å™¨ä¸­ï¼Œç„¶åå¼€å§‹å‘ä¸‹è®¡æ•°ã€‚åˆ°è¾¾0åï¼Œä¼šå°†COUNTFLAGç½®ä½ï¼Œå¹¶æ ¹æ®TICKINTæ˜¯å¦è¢«ç½®ä½æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦äº§ç”ŸSysTickä¸­æ–­ã€‚ç„¶åç»§ç»­é‡æ–°è£…è½½RELOADå€¼å¹¶å¼€å§‹è®¡æ•°ã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p>æ³¨æ„ï¼šå¦‚æœ¬ç« èŠ‚å¼€å¤´æ‰€æåˆ°çš„ï¼Œå¹¶ä¸æ˜¯å°†ENABLEç½®ä½åï¼Œå®šæ—¶å™¨å¹¶ä¸ä¼šé©¬ä¸ŠåŠ è½½RELOADï¼Œè€Œæ˜¯è¦ç­‰ä¸€ä¸ªæ—¶é’Ÿè„‰å†²ã€‚åŒæ ·çš„ï¼Œå½“é€’å‡åˆ°0æ—¶ï¼Œä¼šç½®ä½COUNTFLAGå¹¶æ ¹æ®TICKINTäº§ç”Ÿä¸­æ–­ï¼Œå¹¶åœ¨ä¸‹ä¸ªè„‰å†²é‡æ–°è£…è½½RELOADå€¼ã€‚</p>
</blockquote>
<h3 id="sys-tick-yi-chang-qing-qiu-shi-neng-tickint">SysTickå¼‚å¸¸è¯·æ±‚ä½¿èƒ½TICKINT</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094011349.png" alt="image-20241205094011349"></p>
<p>å°†TICKINTç½®ä½åï¼Œå½“è®¡æ•°å™¨é€’å‡åˆ°0æ—¶ä¼šå‘å‡ºSysTickå¼‚å¸¸è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¼šè¢«é€’äº¤NVICï¼Œéšåå¤„ç†å™¨ä¼šé€šè¿‡å¼‚å¸¸å‘é‡è¡¨æ‰¾åˆ°ç›¸åº”çš„å¼‚å¸¸å¤„ç†ç¨‹åºæ¥æ‰§è¡Œã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p>è½¯ä»¶å¯ä»¥é€šè¿‡è½®è¯¢COUNTFLAGæ¥åˆ¤æ–­SysTickæ˜¯å¦è®¡æ•°åˆ°äº†0.</p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094354149.png" alt="image-20241205094354149" style="zoom:50%;">
<blockquote>
<p>[!NOTE]</p>
<p>å…³äºARMæ ¸å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå¯å‚è€ƒæœ¬ç«™æ–‡ç« ã€ŠARMæ ¸å­¦ä¹ ï¼ˆäº”ï¼‰å¼‚å¸¸å¤„ç†ã€‹</p>
</blockquote>
<h3 id="sys-tick-shi-zhong-yuan-xuan-ze-clksource">SysTickæ—¶é’Ÿæºé€‰æ‹©CLKSOURCE</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094708579.png" alt="image-20241205094708579" style="zoom: 50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094832430.png" alt="å‚è€ƒæ‰‹å†Œ-æ—¶é’Ÿæ ‘"></p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥é…ç½®ä¸ºå¤„ç†å™¨æ—¶é’ŸAHBï¼Œæˆ–å…¶8åˆ†é¢‘ã€‚</p>
<h3 id="ji-shu-biao-zhi-wei-countflag">è®¡æ•°æ ‡å¿—ä½COUNTFLAG</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205094958147.png" alt="image-20241205094958147"></p>
<p>å½“å®šæ—¶å™¨è®¡æ•°åˆ°0æ—¶ï¼Œè¯¥æ ‡å¿—ä½ä¼šè¢«ç½®ä½ã€‚è¿™é‡Œè¿˜æœ‰ä¸ªç»†èŠ‚ï¼Œè¯»å–åˆ°COUNTFLAGä¸º1åä¼šæ¸…é™¤è¯¥ä½ã€‚</p>
<h2 id="an-li-sys-tick-shi-xian-led-mei-miao-fan-zhuan-yi-ci">æ¡ˆä¾‹-SysTickå®ç°LEDæ¯ç§’ç¿»è½¬ä¸€æ¬¡</h2>
<h3 id="systick-h">systick.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SYSTICK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SYSTICK_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SYSTICK_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="systick-c">systick.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>

<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_CLKSOURCE <span class="token operator">|</span> SysTick_CTRL_TICKINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>

<span class="token class-name">uint16_t</span> tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick_ms<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tick_ms <span class="token operator">&gt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LED_Toggle</span><span class="token punctuation">(</span>LED1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="nvic-zhong-duan-pei-zhi">NVICä¸­æ–­é…ç½®</h2>
<p>ç”±äºSysTickä¸ºCM3å†…ç½®çš„å¤–è®¾ï¼ŒNVICé»˜è®¤æ³¨å†Œäº†SysTickã€‚</p>
<h3 id="zhong-duan-shi-neng-amp-mo-ren-you-xian-ji">ä¸­æ–­ä½¿èƒ½&amp;é»˜è®¤ä¼˜å…ˆçº§</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205105610255.png" alt="image-20241205105610255"></p>
<p>å¦‚ä¸Šå›¾ï¼Œå¯ä»¥çœ‹å‡ºSysTickä¸­æ–­ä½¿èƒ½é»˜è®¤æ˜¯ç½®ä½çš„ï¼Œå¹¶ä¸”ä¼˜å…ˆçº§ä¸º0ã€‚</p>
<h3 id="zi-ding-yi-sys-tick-you-xian-ji">è‡ªå®šä¹‰SysTickä¼˜å…ˆçº§</h3>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">void SysTick_Init(void) {
    SysTick-&gt;LOAD = SystemCoreClock / 1000 - 1;
    SysTick-&gt;CTRL |= (SysTick_CTRL_CLKSOURCE | SysTick_CTRL_TICKINT);

    NVIC_SetPriorityGrouping(3); // 4ä¸ªbitéƒ½ä¸ºæŠ¢å ä¼˜å…ˆçº§
    NVIC_SetPriority(SysTick_IRQn, 10); // å°†SysTickä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®ä¸º10
    // NVIC_EnableIRQ(SysTick_IRQn); // SysTickå±äºå†…æ ¸å¼‚å¸¸ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¼€å¯

    SysTick-&gt;CTRL |= SysTick_CTRL_ENABLE;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205110044145.png" alt="image-20241205110044145"></p>
<h2 id="hal-ku-shi-xian">HALåº“å®ç°</h2>
<h3 id="cube-pei-zhi">Cubeé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205110622283.png" alt="image-20241205110622283"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205110642343.png" alt="image-20241205110642343"></p>
<h3 id="main-c-1">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE END WHILE */</span>
  <span class="token function">HAL_GPIO_TogglePin</span><span class="token punctuation">(</span>LED1_GPIO_Port<span class="token punctuation">,</span> LED1_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-ku-yan-shi-han-shu-fen-xi">HALåº“å»¶æ—¶å‡½æ•°åˆ†æ</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>HAL_Init</code>åšäº†SysTickçš„åˆå§‹åŒ–ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set Interrupt Group Priority */</span>
<span class="token function">HAL_NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span>NVIC_PRIORITYGROUP_4<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Use systick as time base source and configure 1ms tick (default clock after Reset is HSI) */</span>
<span class="token function">HAL_InitTick</span><span class="token punctuation">(</span>TICK_INT_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚ä¸Šï¼Œå°†ä¼˜å…ˆçº§åˆ†ç»„è®¾ç½®ä¸º <code>#define NVIC_PRIORITYGROUP_4     0x00000003U</code>ï¼Œå³ä¼˜å…ˆçº§é…ç½®ç”¨çš„4ä¸ªbitå…¨éƒ¨ç”¨äºæŠ¢å ä¼˜å…ˆçº§ï¼Œä¸è®¾ç½®å“åº”ä¼˜å…ˆçº§ï¼ˆSubpriorityï¼‰</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NVIC_PRIORITYGROUP_4</span>         <span class="token expression"><span class="token number">0x00000003U</span> </span><span class="token comment">/*!&lt; 4 bits for pre-emption priority
                                                      0 bits for subpriority */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç„¶åé€šè¿‡ <code>HAL_InitTick</code>åˆå§‹åŒ–SysTickï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__weak HAL_StatusTypeDef <span class="token function">HAL_InitTick</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> TickPriority<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* Configure the SysTick to have interrupt in 1ms time basis*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_SYSTICK_Config</span><span class="token punctuation">(</span>SystemCoreClock <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000U</span> <span class="token operator">/</span> uwTickFreq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0U</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> HAL_ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Configure the SysTick IRQ priority */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TickPriority <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> __NVIC_PRIO_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> TickPriority<span class="token punctuation">,</span> <span class="token number">0U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uwTickPrio <span class="token operator">=</span> TickPriority<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> HAL_ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Return function status */</span>
  <span class="token keyword">return</span> HAL_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡ <code>HAL_SYSTICK_Config</code>é…ç½®äº†SysTickç›¸å…³çš„å¯„å­˜å™¨ï¼ˆæ¯1msè§¦å‘ä¸€æ¬¡ä¸­æ–­ï¼‰ï¼Œç„¶åé€šè¿‡ <code>HAL_NVIC_SetPriority</code>è®¾ç½®äº†SysTickä¸­æ–­çš„ä¼˜å…ˆçº§ã€‚</p>
<p>åœ¨ä¸­æ–­å›è°ƒå‡½æ•°ä¸­ï¼Œå°†è®¡æ•°å™¨ <code>uwTick</code>è‡ªå¢ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE BEGIN SysTick_IRQn 0 */</span>

  <span class="token comment">/* USER CODE END SysTick_IRQn 0 */</span>
  <span class="token function">HAL_IncTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN SysTick_IRQn 1 */</span>
    
  <span class="token comment">/* USER CODE END SysTick_IRQn 1 */</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">HAL_IncTick</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  uwTick <span class="token operator">+=</span> uwTickFreq<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è°ƒç”¨ <code>HAL_Delay</code>æ—¶ï¼Œé¦–å…ˆä¼šè·å– <code>uwTick</code>çš„å½“å‰å€¼ <code>tickstart</code>ï¼Œé€šè¿‡ <code>while</code>å»¶æ—¶ç›´åˆ°è‡ªå¢çš„<code>uwTick</code>å’Œ <code>tickstart</code>ä¹‹é—´çš„å·®å€¼è¾¾åˆ°æˆ‘ä»¬ä¼ å…¥çš„ <code>Delay</code>æ¯«ç§’æ•°ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__weak <span class="token keyword">void</span> <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> Delay<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span> tickstart <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> wait <span class="token operator">=</span> Delay<span class="token punctuation">;</span>

  <span class="token comment">/* Add a freq to guarantee minimum wait */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>wait <span class="token operator">&lt;</span> HAL_MAX_DELAY<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    wait <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uwTickFreq<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tickstart<span class="token punctuation">)</span> <span class="token operator">&lt;</span> wait<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ji-ben-ding-shi-qi">åŸºæœ¬å®šæ—¶å™¨</h1>
<h2 id="gai-shu">æ¦‚è¿°</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103009989.png" alt="image-20241204103009989"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103508116.png" alt="image-20241204103508116"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103554574.png" alt="image-20241204103554574"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204103719970.png" alt="image-20241204103719970"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204104016311.png" alt="image-20241204104016311"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204104848858.png" alt="image-20241204104848858"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204104746716.png" alt="image-20241204104746716"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204105125520.png" alt="image-20241204105125520"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204110522459.png" alt="image-20241204110522459"></p>
<h2 id="ji-cun-qi-gong-neng-fen-xi">å¯„å­˜å™¨åŠŸèƒ½åˆ†æ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205113657990.png" alt="image-20241205113657990"></p>
<p>æˆ‘ä»¬ä¸å¦¨ä»RCCæ—¶é’Ÿæ¥å…¥å®šæ—¶å™¨å¼€å§‹åˆ†æï¼Œä»¥æ¯ç§’è§¦å‘ä¸€æ¬¡å®šæ—¶æº¢å‡ºäº‹ä»¶ä¸ºä¾‹ï¼Œçœ‹çœ‹æˆ‘ä»¬éœ€è¦é…ç½®å“ªäº›å¯„å­˜å™¨ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205114035094.png" alt="image-20241205114035094"></p>
<p>åŸºæœ¬å®šæ—¶TIM6æŒ‚è½½åœ¨APB1ä½é€Ÿå¤–è®¾æ€»çº¿ä¸Šï¼Œå…¶æœ€å¤§æ—¶é’Ÿé¢‘ç‡ä¸º36MHzã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205114222915.png" alt="image-20241205114222915"></p>
<p>ä½†æ˜¯APB1ä¸æ˜¯ç›´æ¥æ¥å…¥TM6çš„ã€‚å¦‚ä¸Šå›¾ï¼Œå¦‚æœAPB1çš„é¢„åˆ†é…ç³»æ•°å¦‚æœä¸æ˜¯ä¸º1ï¼Œé‚£ä¹ˆä¼šå°†å…¶2å€é¢‘åå†ç»™åˆ°åé¢çš„TIM6ã€‚å› æ­¤TIM6çš„è¾“å…¥æ—¶é’Ÿå®é™…ä¸Šä¸º72MHzã€‚</p>
<h3 id="zi-dong-zhuang-zai-zhi-ji-cun-qi-arr-amp-yu-fen-pin-ji-cun-qi-psc">è‡ªåŠ¨è£…è½½å€¼å¯„å­˜å™¨ARR &amp; é¢„åˆ†é¢‘å¯„å­˜å™¨PSC</h3>
<p>ä¸ºäº†å¾—åˆ°å‘¨æœŸä¸º1sçš„å®šæ—¶å™¨æº¢å‡ºç‡ï¼ˆå³1Hzï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®šæ—¶å™¨çš„é‡è£…è½½å€¼å’Œé¢„åˆ†é¢‘å™¨çœ‹åšè¾“å…¥æ—¶é’Ÿçš„ä¸¤ä¸ªåˆ†é¢‘ç³»æ•°ï¼Œç»è¿‡é¢„åˆ†é¢‘å™¨å’Œå®šæ—¶å™¨è®¡æ•°å‘¨æœŸåï¼Œèƒ½å¤Ÿå°†72MHzè¾“å…¥æ—¶é’Ÿé¢‘ç‡å˜ä¸º1Hzçš„å®šæ—¶å™¨æº¢å‡ºç‡ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205133045398.png" alt="image-20241205133045398"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205133101610.png" alt="image-20241205133101610"></p>
<p>å¦‚ä¸Šï¼Œç”±äºå®šæ—¶å™¨è‡ªåŠ¨è£…è½½å€¼å’Œåˆ†é¢‘å™¨ä¸º16bitï¼Œå› æ­¤æœ€å¤§å€¼ä¸º65535ï¼Œä¸ºäº†å°†72MHzå˜ä¸º1Hzï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é¢„åˆ†é¢‘å™¨ï¼ˆ7200åˆ†é¢‘ï¼‰å…ˆå°†72000000Hzå…ˆå˜ä¸º10000Hzï¼Œç„¶åå†é€šè¿‡10000ä¸ªè®¡æ•°å‘¨æœŸå°†å…¶å˜ä¸º1Hzã€‚</p>
<ul>
<li>PSCé…ç½®ä¸º7200-1ï¼ŒPSCä¸º0æ—¶ä»£è¡¨ä¸åˆ†é¢‘ï¼Œå› æ­¤PSCé…ç½®çš„å€¼å¯¹åº”çš„å®é™…åˆ†é¢‘ç³»æ•°ä¸ºPSC+1</li>
<li>ARRé…ç½®ä¸º10000-1ï¼Œå› ä¸ºè®¡æ•°åˆ°9999æ—¶ï¼Œè¿˜éœ€è¦ä¸€ä¸ªè„‰å†²æ‰èƒ½è®¡æ•°å™¨çš„å€¼å˜ä¸º0ï¼Œè€Œéšåè®¡æ•°åˆ°9999åˆ™éœ€è¦9999ä¸ªè„‰å†²ï¼ŒåŠ ä¸Šå˜ä¸º0çš„ï¼Œä¸€å…±10000ä¸ªè„‰å†²</li>
</ul>
<h3 id="dang-qian-ji-shu-zhi-ji-cun-qi-cnt">å½“å‰è®¡æ•°å€¼å¯„å­˜å™¨CNT</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205115451556.png" alt="image-20241205115451556"></p>
<p>ARRä¸­é…ç½®çš„å€¼ä¼šè¢«åŠ è½½åˆ°è¯¥å¯„å­˜å™¨ï¼Œè¯¥å¯„å­˜å™¨å®æ—¶åæ˜ å½“å‰çš„è®¡æ•°å€¼ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥æ“ä½œè¯¥å¯„å­˜å™¨ã€‚</p>
<h3 id="zhong-duan-shi-neng-ji-cun-qi-dier-amp-zhuang-tai-ji-cun-qi-sr">ä¸­æ–­ä½¿èƒ½å¯„å­˜å™¨DIER &amp; çŠ¶æ€å¯„å­˜å™¨SR</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205115848928.png" alt="image-20241205115848928"></p>
<p>é€šè¿‡UIEæˆ‘ä»¬å¯ä»¥å¼€å¯å®šæ—¶å™¨æ›´æ–°ï¼ˆè®¡æ•°å€¼åˆ°è¾¾è£…è½½å€¼ï¼‰ä¸­æ–­ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205115843854.png" alt="image-20241205115843854"></p>
<p>åœ¨å¤„ç†ä¸­æ–­åï¼Œæˆ‘ä»¬éœ€è¦æ¸…é™¤UIFä¸­æ–­æ ‡å¿—ä½ï¼Œé¿å…é‡å¤è§¦å‘ä¸­æ–­ã€‚</p>
<h3 id="shou-dong-chan-sheng-geng-xin-shi-jian-egr">æ‰‹åŠ¨äº§ç”Ÿæ›´æ–°äº‹ä»¶EGR</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205120551269.png" alt="image-20241205120551269"></p>
<h3 id="kong-zhi-ji-cun-qi-cr-1">æ§åˆ¶å¯„å­˜å™¨CR1</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205120745275.png" alt="image-20241205120745275"></p>
<h2 id="an-li-led-zhuang-tai-fan-zhuan">æ¡ˆä¾‹-LEDçŠ¶æ€ç¿»è½¬</h2>
<h3 id="systick">systick</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SYSTICK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SYSTICK_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SYSTICK_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>

<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_CLKSOURCE <span class="token operator">|</span> SysTick_CTRL_TICKINT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4ä¸ªbitéƒ½ä¸ºæŠ¢å ä¼˜å…ˆçº§</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†SysTickä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®ä¸º10</span>
    <span class="token comment">// NVIC_EnableIRQ(SysTick_IRQn); // SysTickå±äºå†…æ ¸å¼‚å¸¸ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¼€å¯</span>

    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="tim-6">TIM6</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM6_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM6_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM6_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim6.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¼€å¯TIM6è¾“å…¥æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM6EN<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®ä¸­æ–­é¢‘ç‡</span>
    <span class="token comment">// 72MHz / 7200 / 1000 = 1Hz = 1s(interrupt frequence)</span>
    TIM6<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM6<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">10000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// å¼€å¯å®šæ—¶å™¨æ›´æ–°ä¸­æ–­</span>
    TIM6<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_UIE<span class="token punctuation">;</span>
    <span class="token comment">// æ³¨å†Œåˆ°NVICï¼Œä¼˜å…ˆçº§ä¸º2</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM6<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
    <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main">main</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim6.h"</span></span>

<span class="token class-name">uint16_t</span> tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick_ms<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tick_ms <span class="token operator">&gt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LED_Toggle</span><span class="token punctuation">(</span>LED1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tick_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM6_UpdateCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LED_Toggle</span><span class="token punctuation">(</span>LED2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">TIM6_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="psc-he-arr-yu-zhuang-zai-zhi-wen-ti">PSCå’ŒARRé¢„è£…è½½å€¼é—®é¢˜</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205145640935.png" alt="image-20241205145640935"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸¤ä¸ªå¯„å­˜å™¨åº•ä¸‹éƒ½æœ‰é˜´å½±ï¼Œè¿™è¡¨ç¤ºARRå’ŒPSCæ˜¯<mark>é¢„è£…è½½å¯„å­˜å™¨</mark>ï¼ŒARRå’ŒPSCä¸­é…ç½®çš„å€¼ä¼šåœ¨æ¯æ¬¡æ›´æ–°äº‹ä»¶å‘ç”Ÿæ—¶è¢«åŠ è½½åº•å±‚å·¥ä½œçš„å¯„å­˜å™¨ä¸­ï¼ˆ<mark>active register</mark>ï¼‰ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205131723712.png" alt="image-20241205131723712"></p>
<p>å¦‚æœARPEé…ç½®ä¸º1ï¼Œé‚£ä¹ˆå†™å…¥ARRå€¼ä¸ä¼šç«‹å³è¢«åŠ è½½åˆ°Auto-reload Registerï¼Œè€Œæ˜¯è¦ç­‰åˆ°æ›´æ–°äº‹ä»¶å‘ç”Ÿã€‚é…ç½®ä¸º0ï¼Œåˆ™å†™å…¥ARRçš„å€¼ä¼šç«‹å³è¢«åŠ è½½åˆ°Auto-reload Registerã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205132208017.png" alt="image-20241205132208017"></p>
<blockquote>
<p>[!NOTE]</p>
<p>ä½†æ˜¯ï¼Œå†™å…¥PSCçš„å€¼åªæœ‰åœ¨æ¯æ¬¡æ›´æ–°äº‹ä»¶å‘ç”Ÿæ—¶æ‰ä¼šè¢«åŠ è½½åˆ°è¿è½¬ä¸­çš„PSC Prescalerï¼ˆactive prescaler registerï¼‰ä¸­ã€‚</p>
</blockquote>
<p>å› æ­¤ä¸Šè¿°æ¡ˆä¾‹ä¸­ï¼Œåœ¨TIM6å¯åŠ¨åï¼ŒAuto-reload Registerä¸­çš„å€¼ä¸º9999ï¼Œè€ŒPSC Prescaleä¸º0ï¼Œç­‰å¾…9999*(1/72MHz)å³å¤§çº¦(10000/72)usåï¼ŒPSC Prescaleræ‰ä¼šè¢«åŠ è½½ä¸º7199ã€‚</p>
<p>æ‰€ä»¥ä¼šå¯¼è‡´LED1å’ŒLED2äº¤æ›¿é—ªçƒçš„ç°è±¡ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„æ¯éš”1ç§’LED1å’ŒLED2åŒæ—¶ç¿»è½¬çŠ¶æ€ã€‚</p>
<p>è¦æƒ³åˆå§‹åŒ–TIM6æ—¶å¼ºåˆ¶å°†PSCé¢„è£…è½½å€¼åˆ·æ–°åˆ°å·¥ä½œå¯„å­˜å™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡EGRæ‰‹åŠ¨äº§ç”Ÿä¸€ä¸ªæ›´æ–°äº‹ä»¶ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¼€å¯TIM6è¾“å…¥æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM6EN<span class="token punctuation">;</span>
    <span class="token comment">// é…ç½®ä¸­æ–­é¢‘ç‡</span>
    <span class="token comment">// 72MHz / 7200 / 1000 = 1Hz = 1s(interrupt frequence)</span>
    TIM6<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM6<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">10000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// é€šè¿‡EGRæ‰‹åŠ¨äº§ç”Ÿä¸€æ¬¡æ›´æ–°äº‹ä»¶ï¼Œå°†PSCé¢„è£…è½½å€¼åˆ·æ–°åˆ°Prescalerå¯„å­˜å™¨ä¸­</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token comment">// å¯ç”¨å®šæ—¶å™¨</span>
    TIM6<span class="token operator">-&gt;</span>EGR <span class="token operator">|=</span> TIM_EGR_UG<span class="token punctuation">;</span> <span class="token comment">// äº§ç”Ÿæ›´æ–°äº‹ä»¶</span>
    TIM6<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span> <span class="token comment">// æ¸…é™¤æ›´æ–°äº‹ä»¶ä¸­æ–­æ ‡å¿—</span>
    TIM6<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token comment">// å…³é—­å®šæ—¶å™¨</span>

    <span class="token comment">// å¼€å¯å®šæ—¶å™¨æ›´æ–°ä¸­æ–­</span>
    TIM6<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_UIE<span class="token punctuation">;</span>
    <span class="token comment">// æ³¨å†Œåˆ°NVICï¼Œä¼˜å…ˆçº§ä¸º2</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-ku-shi-xian-1">HALåº“å®ç°</h2>
<h3 id="cube-pei-zhi-1">Cubeé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144127438.png" alt="image-20241205144127438"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144135329.png" alt="image-20241205144135329"></p>
<h3 id="yuan-ma-fen-xi">æºç åˆ†æ</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">TIM_HandleTypeDef htim6<span class="token punctuation">;</span>

<span class="token comment">/* TIM6 init function */</span>
<span class="token keyword">void</span> <span class="token function">MX_TIM6_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TIM_MasterConfigTypeDef sMasterConfig <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Instance <span class="token operator">=</span> TIM6<span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Prescaler <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>CounterMode <span class="token operator">=</span> TIM_COUNTERMODE_UP<span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Period <span class="token operator">=</span> <span class="token number">10000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    htim6<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoReloadPreload <span class="token operator">=</span> TIM_AUTORELOAD_PRELOAD_ENABLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_TIM_Base_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim6<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sMasterConfig<span class="token punctuation">.</span>MasterOutputTrigger <span class="token operator">=</span> TIM_TRGO_RESET<span class="token punctuation">;</span>
    sMasterConfig<span class="token punctuation">.</span>MasterSlaveMode <span class="token operator">=</span> TIM_MASTERSLAVEMODE_DISABLE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_TIMEx_MasterConfigSynchronization</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sMasterConfig<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">HAL_TIM_Base_MspInit</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>tim_baseHandle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tim_baseHandle<span class="token operator">-&gt;</span>Instance <span class="token operator">==</span> TIM6<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">__HAL_RCC_TIM6_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* TIM6 interrupt Init */</span>
        <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM6_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="tian-jia-ding-shi-qi-6-de-zhong-duan-hui-diao-han-shu">æ·»åŠ å®šæ—¶å™¨6çš„ä¸­æ–­å›è°ƒå‡½æ•°</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144214052.png" alt="image-20241205144214052"></p>
<p>åœ¨<code>tim.c</code>ä¸­æ·»åŠ HALåº“çš„å®šæ—¶å™¨<strong>æº¢å‡ºä¸­æ–­</strong>å›è°ƒå‡½æ•°ã€‚ï¼ˆå®šæ—¶å™¨çš„å›è°ƒå‡½æ•°æ¯”è¾ƒå¤šï¼Œè¿™æ¬¡æˆ‘ä»¬åªä½¿ç”¨åˆ°äº†æº¢å‡ºä¸­æ–­å›è°ƒå‡½æ•°ï¼‰ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// å®šæ—¶å™¨6äº§ç”Ÿä¸­æ–­ã€‚ä»»ä½•ä¸€ä¸ªå®šæ—¶å™¨äº§ç”Ÿä¸­æ–­éƒ½ä¼šè¿›å…¥åˆ°è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­ä¸‹å®šæ—¶å™¨å®ä¾‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>htim<span class="token operator">-&gt;</span>Instance <span class="token operator">==</span> TIM6<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ç¿»è½¬LEDB</span>
        <span class="token function">HAL_GPIO_TogglePin</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="yi-zhong-duan-fang-shi-kai-qi-ding-shi-qi">ä»¥ä¸­æ–­æ–¹å¼å¼€å¯å®šæ—¶å™¨</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MX_TIM6_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¯åŠ¨å®šæ—¶å™¨6</span>
    <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="tong-yong-ding-shi-qi">é€šç”¨å®šæ—¶å™¨</h1>
<h2 id="gai-shu-1">æ¦‚è¿°</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205144420381.png" alt="image-20241205144420381" style="zoom:50%;">
<h2 id="yong-you-ji-ben-ding-shi-qi-de-suo-you-gong-neng">æ‹¥æœ‰åŸºæœ¬å®šæ—¶å™¨çš„æ‰€æœ‰åŠŸèƒ½</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205145016647.png" alt="image-20241205145016647"></p>
<h2 id="san-chong-ke-xuan-de-shi-zhong-yuan">ä¸‰ç§å¯é€‰çš„æ—¶é’Ÿæº</h2>
<h3 id="nei-bu-shi-zhong-yuan">å†…éƒ¨æ—¶é’Ÿæº</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205145125349.png" alt="image-20241205145125349"></p>
<h3 id="ding-shi-qi-shu-ru-tong-dao-zuo-wei-shi-zhong-yuan">å®šæ—¶å™¨è¾“å…¥é€šé“ä½œä¸ºæ—¶é’Ÿæº</h3>
<blockquote>
<p>[!NOTE]</p>
<p>TI1ï¼šTimer Input 1</p>
<p>TI1FP1ï¼šTimer Input 1 after input Filter and Polarity(edge) detector</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204121957064.png" alt="image-20241204121957064"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205153635462.png" alt="image-20241205153635462"></p>
<h4 id="strong-ying-yong-chang-jing-strong"><strong>åº”ç”¨åœºæ™¯</strong></h4>
<ol>
<li><strong>å¤–éƒ¨äº‹ä»¶è®¡æ•°</strong>
<ul>
<li>å®šæ—¶å™¨å¯ä»¥é€šè¿‡ <code>TIMx_CH1</code> æ•è·è¾“å…¥ä¿¡å·çš„æ¯ä¸€ä¸ªè„‰å†²å¹¶è¿›è¡Œè®¡æ•°ã€‚</li>
<li>å…¸å‹åº”ç”¨ï¼š
<ul>
<li>è®¡æ•°å¤–éƒ¨ä¼ æ„Ÿå™¨çš„ä¿¡å·ï¼Œå¦‚ç¼–ç å™¨è„‰å†²ã€è½¬é€Ÿä¿¡å·ã€‚</li>
<li>çº¢å¤–å…‰ç”µå¼€å…³çš„è§¦å‘è®¡æ•°ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>é¢‘ç‡æµ‹é‡</strong>
<ul>
<li>ä½¿ç”¨ <code>TIMx_CH1</code> æ•è·è¾“å…¥ä¿¡å·çš„é¢‘ç‡æˆ–å‘¨æœŸã€‚</li>
<li>å®ç°æ–¹å¼ï¼š
<ul>
<li>é…ç½®å®šæ—¶å™¨ä¸ºè¾“å…¥æ•è·æ¨¡å¼ï¼Œè®°å½•ä¿¡å·è¾¹æ²¿ä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚</li>
</ul>
</li>
<li>å…¸å‹åº”ç”¨ï¼š
<ul>
<li>æµ‹é‡è¾“å…¥ä¿¡å·é¢‘ç‡ï¼ˆä¾‹å¦‚ç”µæœºé€Ÿåº¦æµ‹é‡ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>å ç©ºæ¯”æµ‹é‡</strong>
<ul>
<li><code>TIMx_CH1</code> é…åˆå…¶ä»–é€šé“ï¼Œå¯ä»¥æµ‹é‡ä¿¡å·çš„å ç©ºæ¯”ã€‚</li>
<li>å®ç°æ–¹å¼ï¼š
<ul>
<li>é…ç½®ä¸ºè¾“å…¥æ•è·æ¨¡å¼ï¼Œè®°å½•ä¸Šå‡æ²¿å’Œä¸‹é™æ²¿çš„æ—¶é—´å·®ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="wai-bu-hong-fa-shu-ru-duan-kou-etr-zuo-wei-shi-zhong-yuan">å¤–éƒ¨è§¦å‘è¾“å…¥ç«¯å£ETRä½œä¸ºæ—¶é’Ÿæº</h3>
<blockquote>
<p>[!NOTE]</p>
<p>ETRï¼šExternal Trigger</p>
<p>ITRï¼šInternal Timer</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204141554812.png" alt="image-20241204141554812"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205153719730.png" alt="image-20241205153719730"></p>
<h4 id="strong-ying-yong-chang-jing-strong-1"><strong>åº”ç”¨åœºæ™¯</strong></h4>
<ol>
<li><strong>å¤–éƒ¨æ—¶é’Ÿè¾“å…¥</strong>
<ul>
<li>å®šæ—¶å™¨ä½¿ç”¨ <code>ETR</code> çš„ä¿¡å·ä½œä¸ºä¸»æ—¶é’Ÿï¼Œè€Œéå†…éƒ¨æ—¶é’Ÿï¼ˆå¦‚ APB æ—¶é’Ÿï¼‰ã€‚</li>
<li>å®ç°æ–¹å¼ï¼š
<ul>
<li>é…ç½®å®šæ—¶å™¨ä¸º <strong>å¤–éƒ¨æ—¶é’Ÿæ¨¡å¼ 1</strong>ï¼Œé€šè¿‡ <code>ETR</code> å¼•è„šè¾“å…¥æ—¶é’Ÿä¿¡å·ã€‚</li>
</ul>
</li>
<li>å…¸å‹åº”ç”¨ï¼š
<ul>
<li>ä½¿ç”¨å¤–éƒ¨æ™¶æŒ¯æˆ–å…¶ä»–é«˜ç²¾åº¦æ—¶é’Ÿæºé©±åŠ¨å®šæ—¶å™¨ã€‚</li>
<li>æµ‹é‡é«˜é¢‘è¾“å…¥ä¿¡å·çš„è„‰å†²ä¸ªæ•°ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>è§¦å‘æ§åˆ¶</strong>
<ul>
<li><code>ETR</code> ä¿¡å·å¯ç”¨ä½œè§¦å‘ä¿¡å·æºï¼Œç”¨äºå¯åŠ¨æˆ–å¤ä½å®šæ—¶å™¨è®¡æ•°å™¨ã€‚</li>
<li>å®ç°æ–¹å¼ï¼š
<ul>
<li>é…ç½®å®šæ—¶å™¨ä¸º <strong>å¤ä½æ¨¡å¼</strong> æˆ– <strong>é—¨æ§æ¨¡å¼</strong>ï¼Œæ ¹æ® <code>ETR</code> ä¿¡å·è§¦å‘å®šæ—¶å™¨æ“ä½œã€‚</li>
</ul>
</li>
<li>å…¸å‹åº”ç”¨ï¼š
<ul>
<li>ç”¨ä¸€ä¸ªå¤–éƒ¨äº‹ä»¶å¯åŠ¨å®šæ—¶å™¨è®¡æ•°ï¼ˆä¾‹å¦‚å¤–éƒ¨æŒ‰é’®è§¦å‘è®¡æ—¶ï¼‰ã€‚</li>
<li>ç”¨å¤–éƒ¨ä¿¡å·å¤ä½å®šæ—¶å™¨ï¼ˆä¾‹å¦‚å®šæ—¶å™¨åŒæ­¥ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>ç¼–ç å™¨æ¥å£ä¸åŒæ­¥</strong>
<ul>
<li>åœ¨ç¼–ç å™¨æ¨¡å¼æˆ–å®šæ—¶å™¨åŒæ­¥ä¸­ï¼Œ<code>ETR</code> å¯ç”¨ä½œä»å®šæ—¶å™¨çš„è§¦å‘è¾“å…¥ã€‚</li>
<li>å®ç°æ–¹å¼ï¼š
<ul>
<li>ä¸»ä»æ¨¡å¼é…ç½®ï¼Œå°† <code>ETR</code> ä¿¡å·ä½œä¸ºè§¦å‘æºã€‚</li>
</ul>
</li>
<li>å…¸å‹åº”ç”¨ï¼š
<ul>
<li>å¤šå®šæ—¶å™¨åŒæ­¥æ“ä½œï¼ˆå¦‚ PWM å’Œè¾“å…¥æ•è·ååŒå·¥ä½œï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="san-chong-ji-shu-mo-shi">ä¸‰ç§è®¡æ•°æ¨¡å¼</h2>
<h3 id="xiang-shang-ji-shu">å‘ä¸Šè®¡æ•°</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204142731898.png" alt="image-20241204142731898"></p>
<h3 id="xiang-xia-ji-shu">å‘ä¸‹è®¡æ•°</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204142747437.png" alt="image-20241204142747437"></p>
<h3 id="zhong-yang-dui-qi-ji-shu">ä¸­å¤®å¯¹é½è®¡æ•°</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204143158175.png" alt="image-20241204143158175"></p>
<h2 id="pwm-jie-shao">PWMä»‹ç»</h2>
<h3 id="gai-nian">æ¦‚å¿µ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204144714300.png" alt="image-20241204144714300"></p>
<h3 id="pwm-can-shu">PWMå‚æ•°</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204144910528.png" alt="image-20241204144910528"></p>
<h3 id="shi-yong-chang-jing">ä½¿ç”¨åœºæ™¯</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145019846.png" alt="image-20241204145019846" style="zoom: 50%;">
<h2 id="shu-chu-bi-jiao-gong-neng">è¾“å‡ºæ¯”è¾ƒåŠŸèƒ½</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145214662.png" alt="image-20241204145214662" style="zoom: 33%;">
<h3 id="kuang-tu">æ¡†å›¾</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145422526.png" alt="image-20241204145422526"></p>
<h3 id="yin-jiao-fu-yong">å¼•è„šå¤ç”¨</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205154814340.png" alt="image-20241205154814340"></p>
<h3 id="shu-chu-bi-jiao-yuan-li">è¾“å‡ºæ¯”è¾ƒåŸç†</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204145638909.png" alt="image-20241204145638909"></p>
<h3 id="shu-chu-bi-jiao-de-8-chong-mo-shi">è¾“å‡ºæ¯”è¾ƒçš„8ç§æ¨¡å¼</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150232804.png" alt="image-20241204150232804"></p>
<blockquote>
<p>[!NOTE]</p>
<p>å¤ä½å€¼ä¸º000ï¼Œå³é»˜è®¤æ²¡æœ‰å¯ç”¨è¯¥è¾“å‡ºé€šé“ã€‚</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150202816.png" alt="image-20241204150202816"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205155618824.png" alt="image-20241205155618824" style="zoom:33%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150413815.png" alt="image-20241204150413815"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150500666.png" alt="image-20241204150500666"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204150639079.png" alt="image-20241204150639079"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204174825746.png" alt="image-20241204174825746"></p>
<h2 id="shi-yan-1-led-hu-xi-deng">å®éªŒ1-LEDå‘¼å¸ç¯</h2>
<h3 id="ji-shu-mo-shi-pei-zhi">è®¡æ•°æ¨¡å¼é…ç½®</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160143270.png" alt="image-20241205160143270" style="zoom: 50%;">
<h3 id="bu-huo-bi-jiao-mo-shi-xuan-ze">æ•è·/æ¯”è¾ƒæ¨¡å¼é€‰æ‹©</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160252799.png" alt="image-20241205160252799" style="zoom:50%;">
<h3 id="bi-jiao-shu-chu-mo-shi-she-zhi">æ¯”è¾ƒè¾“å‡ºæ¨¡å¼è®¾ç½®</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160735003.png" alt="image-20241205160735003" style="zoom:50%;">
<h3 id="bi-jiao-shu-chu-mo-shi-xia-de-bi-jiao-zhi">æ¯”è¾ƒè¾“å‡ºæ¨¡å¼ä¸‹çš„æ¯”è¾ƒå€¼</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205160836723.png" alt="image-20241205160836723" style="zoom:50%;">
<h3 id="tong-dao-shu-chu-shi-neng-amp-gong-zuo-dian-ping-ji-xing">é€šé“è¾“å‡ºä½¿èƒ½ &amp; å·¥ä½œç”µå¹³ææ€§</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205161010527.png" alt="image-20241205161010527" style="zoom:50%;">
<blockquote>
<p>[!NOTE]</p>
<p>CCERä¸­çš„CCxPææ€§ï¼ˆè´Ÿè½½å·¥ä½œæ—¶çš„ç”µå¹³ææ€§ï¼‰ï¼šé»˜è®¤ä¸ºé«˜ç”µå¹³æœ‰æ•ˆï¼ˆactive highï¼Œå³é«˜ç”µå¹³æ—¶é©±åŠ¨è´Ÿè½½å·¥ä½œï¼‰ï¼Œå³è®¡æ•°å€¼å°äºæ¯”è¾ƒå€¼æ—¶è¾“å‡ºé«˜ç”µå¹³ã€‚å¦‚æœæ˜¯ä½ç”µå¹³é©±åŠ¨è´Ÿè½½ï¼Œé‚£ä¹ˆææ€§å¯ä»¥é…ç½®ä¸ºä½ç”µå¹³æœ‰æ•ˆã€‚</p>
</blockquote>
<h3 id="ji-cun-qi-yi-lan">å¯„å­˜å™¨ä¸€è§ˆ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205164102625.png" alt="image-20241205164102625"></p>
<h3 id="shi-li-dai-ma">ç¤ºä¾‹ä»£ç </h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205170719406.png" alt="image-20241205170719406"></p>
<h4 id="tim-5">tim5</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM5_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM5_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM5_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========ä½¿èƒ½GPIOAå’ŒTIM5æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM5EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIOå¤ç”¨æ¨æŒ½ mode=11 cnf=10</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF1_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF1_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨åŸºæœ¬é…ç½®</span>
    <span class="token comment">// å®šæ—¶å™¨æº¢å‡ºé¢‘ç‡ 100Hz 10ms</span>
    TIM5<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¡æ•°æ–¹å‘ä¸ºå‘ä¸Šè®¡æ•°</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨é€šé“2é…ç½®</span>
    <span class="token comment">// é»˜è®¤å ç©ºæ¯”ä¸º0</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// å› ä¸ºä½ç”µå¹³ç‚¹äº®LEDï¼Œå› æ­¤è¾“å‡ºå·¥ä½œç”µå¹³ææ€§ä¸ºä½ç”µå¹³</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2P<span class="token punctuation">;</span> <span class="token comment">// active low</span>
    <span class="token comment">// é€šé“è¾“å…¥è¾“å‡ºé€‰æ‹©ï¼šæ¯”è¾ƒè¾“å‡º</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC2S<span class="token punctuation">;</span>
    <span class="token comment">// æ¯”è¾ƒè¾“å‡ºæ¨¡å¼ï¼šPWM1 110</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_2<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_1<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC2M_0<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½é€šé“æ¯”è¾ƒè¾“å‡º</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2E<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> duty_cycle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-1">main</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> duty_cycle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">int8_t</span> step <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        duty_cycle <span class="token operator">+=</span> step<span class="token punctuation">;</span>
        <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span>duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>duty_cycle <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> duty_cycle <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            step <span class="token operator">=</span> <span class="token operator">-</span>step<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="delay">delay</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SYSTICK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SYSTICK_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> delay_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SYSTICK_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token punctuation">(</span>SysTick_CTRL_CLKSOURCE <span class="token operator">|</span> SysTick_CTRL_TICKINT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 4ä¸ªbitéƒ½ä¸ºæŠ¢å ä¼˜å…ˆçº§</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†SysTickä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®ä¸º10</span>
    <span class="token comment">// NVIC_EnableIRQ(SysTick_IRQn); // SysTickå±äºå†…æ ¸å¼‚å¸¸ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¼€å¯</span>

    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tick<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">SysTick_Callback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> delay_ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> cur_tick <span class="token operator">=</span> tick<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tick <span class="token operator">-</span> cur_tick <span class="token operator">&lt;</span> delay_ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hal-ku-shi-xian-2">HALåº“å®ç°</h3>
<h4 id="cube-pei-zhi-2">Cubeé…ç½®</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205181459371.png" alt="image-20241205181459371"></p>
<h4 id="she-zhi-zhan-kong-bi">è®¾ç½®å ç©ºæ¯”</h4>
<p><code>tim.h</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN Prototypes */</span>
<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dutyCycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END Prototypes */</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>tim.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dutyCycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">__HAL_TIM_SET_COMPARE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim5<span class="token punctuation">,</span> TIM_CHANNEL_2<span class="token punctuation">,</span> dutyCycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="qi-dong-ding-shi-qi-tong-dao-shu-chu-pwm">å¯åŠ¨å®šæ—¶å™¨é€šé“è¾“å‡ºPWM</h4>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim5<span class="token punctuation">,</span> TIM_CHANNEL_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> dutyCycle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">int8_t</span> step <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    dutyCycle <span class="token operator">+=</span> step<span class="token punctuation">;</span>
    <span class="token function">TIM5_SetDutyCycle</span><span class="token punctuation">(</span>dutyCycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dutyCycle <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> dutyCycle <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        step <span class="token operator">=</span> <span class="token operator">-</span>step<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="shu-ru-bu-huo">è¾“å…¥æ•è·</h2>
<h3 id="ying-yong">åº”ç”¨</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205212053355.png" alt="image-20241205212053355"></p>
<h3 id="kuang-tu-1">æ¡†å›¾</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204175246770.png" alt="image-20241204175246770"></p>
<h3 id="yuan-li">åŸç†</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204180530012.png" alt="image-20241204180530012"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204180946906.png" alt="image-20241204180946906"></p>
<h3 id="ce-liang-pwm-zhou-qi-yuan-li">æµ‹é‡PWMå‘¨æœŸåŸç†</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205213337600.png" alt="image-20241205213337600"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205213619896.png" alt="image-20241205213619896"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205213846934.png" alt="image-20241205213846934"></p>
<h2 id="shi-yan-2-ce-liang-pwm-zhou-qi-pin-lu">å®éªŒ2-æµ‹é‡PWMå‘¨æœŸ/é¢‘ç‡</h2>
<ul>
<li>PA1ï¼šé€šè¿‡TIM5_CH2çš„æ¯”è¾ƒè¾“å‡ºåŠŸèƒ½äº§ç”ŸPWM</li>
<li>çŸ­æ¥PA1å’ŒPB6</li>
<li>PB6ï¼šé€šè¿‡TIM4_CH1çš„è¾“å…¥æ•è·åŠŸèƒ½æµ‹é‡è¾“å…¥çš„PWMå‘¨æœŸ</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205214430424.png" alt="image-20241205214430424"></p>
<h3 id="shu-ru-tong-dao-lu-bo-qi-pei-zhi">è¾“å…¥é€šé“æ»¤æ³¢å™¨é…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205214245028.png" alt="image-20241205214245028"></p>
<h3 id="tong-dao-bi-jiao-bu-huo-shi-neng-amp-bian-yan-jian-ce-ji-xing">é€šé“æ¯”è¾ƒ/æ•è·ä½¿èƒ½ &amp; è¾¹æ²¿æ£€æµ‹ææ€§</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215027795.png" alt="image-20241205215027795"></p>
<h3 id="shu-ru-bu-huo-zhong-duan-shi-neng">è¾“å…¥æ•è·ä¸­æ–­ä½¿èƒ½</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215143081.png" alt="image-20241205215143081"></p>
<h3 id="shu-ru-bu-huo-tong-dao-ying-she">è¾“å…¥æ•è·é€šé“æ˜ å°„</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215745688.png" alt="image-20241205215745688"></p>
<p>å¯¹åº”ä¸‹å›¾ä¸­çš„å¤šè·¯é€‰æ‹©å™¨</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241205215850878.png" alt="image-20241205215850878"></p>
<h3 id="shi-li-dai-ma-1">ç¤ºä¾‹ä»£ç </h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206090405972.png" alt="image-20241206090405972"></p>
<p>æˆ‘ä»¬å¯ä»¥å¯¹ç…§æ¡†å›¾ï¼Œæ ¹æ®ä¿¡å·ä»å¼•è„šè¾“å…¥åˆ°äº§ç”Ÿæ•è·äº‹ä»¶ï¼Œæ¥ä¸²èµ·å…¶ä¸­æ¶‰åŠåˆ°çš„å¯„å­˜å™¨ã€‚</p>
<ul>
<li>TI1Sï¼šTimer Input 1 Selectionï¼Œé€‰æ‹©å¼•è„šã€è¿˜æ˜¯XORä½œä¸ºå®šæ—¶å™¨è¾“å…¥1</li>
<li>IC1Fï¼šInput Capture 1 çš„å‰ç½®æ»¤æ³¢å™¨</li>
<li>CC1Pï¼šCapture/Compare 1 çš„ææ€§é€‰æ‹©ï¼Œè¿™é‡Œä¸ºæ•è·ä¸Šå‡æ²¿ï¼ˆææ€§é…ç½®ä¸ºé«˜ç”µå¹³æœ‰æ•ˆï¼‰è¿˜æ˜¯ä¸‹é™æ²¿</li>
<li>CC1Sï¼šCapture/Compare 1 Selctionï¼Œæ•è·/æ¯”è¾ƒæ¨¡å¼é€‰æ‹©
<ul>
<li>æ¯”è¾ƒè¾“å‡ºæ¨¡å¼</li>
<li>è¾“å…¥æ•è·æ¨¡å¼ï¼šé€‰æ‹©TI1FP1ï¼ˆTimer Input 1 Filter Polarity 1ï¼‰ä½œä¸ºè¾“å…¥æ•è·IC1ï¼ˆInput Captrueï¼‰çš„æ¥æº</li>
<li>è¾“å…¥æ•è·æ¨¡å¼ï¼šé€‰æ‹©TI2FP1ï¼ˆTimer Input 2 Filter Polarity 1ï¼‰ä½œä¸ºè¾“å…¥æ•è·IC1ï¼ˆInput Captrueï¼‰çš„æ¥æº</li>
</ul>
</li>
<li>IC1PSCï¼šInput Capture 1 Prescalerï¼Œè¾“å…¥æ•è·é¢„åˆ†é¢‘ï¼Œå³å¤šå°‘æ¬¡è¾“å…¥æ•è·äº‹ä»¶åæ‰è§¦å‘ä¸€æ¬¡CC1Iä¸­æ–­äº‹ä»¶</li>
</ul>
<h4 id="tim-5-ch-2-chan-sheng-pwm">TIM5_CH2äº§ç”ŸPWM</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM5_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM5_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_CH1_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM5_CH2_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM5_H__ */</span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========ä½¿èƒ½GPIOAå’ŒTIM5æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM5EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIOå¤ç”¨æ¨æŒ½ mode=11 cnf=10</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF1_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF1_0<span class="token punctuation">;</span>

    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE0<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF0_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF0_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨åŸºæœ¬é…ç½®</span>
    <span class="token comment">// å®šæ—¶å™¨æº¢å‡ºé¢‘ç‡ 100Hz 10ms</span>
    TIM5<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7200</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¡æ•°æ–¹å‘ä¸ºå‘ä¸Šè®¡æ•°</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨é€šé“2é…ç½®</span>
    <span class="token comment">// é»˜è®¤å ç©ºæ¯”ä¸º50</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token comment">// å› ä¸ºä½ç”µå¹³ç‚¹äº®LEDï¼Œå› æ­¤è¾“å‡ºæœ‰æ•ˆç”µå¹³ææ€§ä¸ºä½ç”µå¹³</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2P<span class="token punctuation">;</span> <span class="token comment">// active low</span>
    <span class="token comment">// é€šé“è¾“å…¥è¾“å‡ºé€‰æ‹©ï¼šæ¯”è¾ƒè¾“å‡º</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC2S<span class="token punctuation">;</span>
    <span class="token comment">// æ¯”è¾ƒè¾“å‡ºæ¨¡å¼ï¼šPWM1 110</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_2<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC2M_1<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC2M_0<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½é€šé“æ¯”è¾ƒè¾“å‡º</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC2E<span class="token punctuation">;</span>

        <span class="token comment">// ===========å®šæ—¶å™¨é€šé“1é…ç½®</span>
    <span class="token comment">// é»˜è®¤å ç©ºæ¯”ä¸º0</span>
    TIM5<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// å› ä¸ºä½ç”µå¹³ç‚¹äº®LEDï¼Œå› æ­¤è¾“å‡ºæœ‰æ•ˆç”µå¹³ææ€§ä¸ºä½ç”µå¹³</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// active low</span>
    <span class="token comment">// é€šé“è¾“å…¥è¾“å‡ºé€‰æ‹©ï¼šæ¯”è¾ƒè¾“å‡º</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S<span class="token punctuation">;</span>
    <span class="token comment">// æ¯”è¾ƒè¾“å‡ºæ¨¡å¼ï¼šPWM1 110</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
    TIM5<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½é€šé“æ¯”è¾ƒè¾“å‡º</span>
    TIM5<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1E<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_CH2_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CCR2 <span class="token operator">=</span> duty_cycle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM5_CH1_SetDutyCycle</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> duty_cycle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM5<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> duty_cycle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="tim-4-ch-1-ce-liang-pwm">TIM4_CH1æµ‹é‡PWM</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM4_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM4_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM4_H__ */</span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-c-2">main.c</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========ä½¿èƒ½GPIOAå’ŒTIM4æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM4EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIOæµ®ç©ºè¾“å…¥ mode=00 cnf=01 PB6</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_MODE6<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF6_1<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF6_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨åŸºæœ¬é…ç½®</span>
    <span class="token comment">// å®šæ—¶å™¨è¾“å…¥é¢‘ç‡ 1MHz</span>
    TIM4<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">65535</span><span class="token punctuation">;</span> <span class="token comment">// å°½é‡ä¸è¦æº¢å‡º</span>
    <span class="token comment">// è®¡æ•°æ–¹å‘ä¸ºå‘ä¸Šè®¡æ•°</span>
    TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨é€šé“1é…ç½®</span>
    TIM4<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR2_TI1S<span class="token punctuation">;</span> <span class="token comment">// é€‰æ‹©CH1å¼•è„šä½œä¸ºTI1çš„æ¥æº</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1F<span class="token punctuation">;</span> <span class="token comment">// ä¸éœ€è¦è¾“å…¥æ»¤æ³¢ï¼Œè¢«æµ‹è¯•çš„PWMä¿¡å·æ²¡æœ‰å™ªå£°</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// æ•è·ä¸Šå‡æ²¿</span>
    <span class="token comment">// é€‰æ‹©TI1çš„æ»¤æ³¢/è¾¹æ²¿æ£€æµ‹è¾“å‡º1(TI1FP1)ä½œä¸ºæ•è·æ¥æº(IC1): 01</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_CC1S_0<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1PSC<span class="token punctuation">;</span> <span class="token comment">// ä¸éœ€è¦å¯¹æ•è·äº‹ä»¶åˆ†é¢‘</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1E<span class="token punctuation">;</span> <span class="token comment">// ä½¿èƒ½æ•è·äº‹ä»¶å‘ç”Ÿæ—¶å°†è®¡æ•°å€¼è®°å½•åˆ°CCRå¯„å­˜å™¨ä¸­</span>

    <span class="token comment">//============ä¸­æ–­é…ç½®</span>
    TIM4<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_CC1IE<span class="token punctuation">;</span> <span class="token comment">// ä½¿èƒ½æ•è·äº‹ä»¶ä¸­æ–­</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM4_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM4_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> TIM_SR_CC1IF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_CC1IF<span class="token punctuation">;</span>
        <span class="token comment">// è®¡æ•°å€¼æ¸…é›¶ï¼Œå¼€å§‹å¯¹ä¸‹ä¸ªPWMå‘¨æœŸè®¡æ•°</span>
        TIM4<span class="token operator">-&gt;</span>CNT <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CNT_CNT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡CCRä¸­æ•è·çš„è®¡æ•°å€¼æ¥è®¡ç®—PWMå‘¨æœŸ</span>
    <span class="token comment">// å•æ¬¡è®¡æ•° 1/1MHz = 1usï¼Œå†é™¤ä»¥1000 è¿”å›æ¯«ç§’æ•°</span>
    <span class="token keyword">return</span> TIM4<span class="token operator">-&gt;</span>CCR1 <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 / (CCR1 * 1000000) =&gt; Hzï¼Œå°†usè½¬ä¸ºsï¼Œå†å–å€’æ•°</span>
        <span class="token keyword">return</span> <span class="token number">1000000.0</span> <span class="token operator">/</span> TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"exti.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> cycle <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> freq <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"cycle = %.2f ms, freq = %.2f Hz"</span><span class="token punctuation">,</span> cycle<span class="token punctuation">,</span> freq<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="si-kao-shi-jian-he-zhong-duan-liu-cheng">æ€è€ƒäº‹ä»¶å’Œä¸­æ–­æµç¨‹</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206094121276.png" alt="image-20241206094121276"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206094155768.png" alt="image-20241206094155768"></p>
<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå½“æ•è·åˆ°ä¸Šå‡æ²¿æ—¶ï¼Œä¼šå‘ç”ŸUæ›´æ–°äº‹ä»¶ï¼Œå°†è®¡æ•°å™¨ï¼ˆCNT counterï¼‰çš„å€¼æ•è·åˆ°CC1Rä¸­ï¼ˆç›¸å½“äºæ‹äº†ä¸ªå¿«ç…§ï¼‰ï¼Œ<mark>è¯¥æ“ä½œæ˜¯ç”±ç¡¬ä»¶ç”µè·¯è‡ªåŠ¨å®Œæˆçš„ï¼ˆç¡¬ä»¶ç”µè·¯æ•è·åˆ°ä¸Šå‡æ²¿çš„æ—¶åˆ»ç«‹å³è‡ªåŠ¨å®Œæˆï¼‰</mark>ã€‚è€Œå¦‚æœæˆ‘ä»¬é€šè¿‡CC1Eä½¿èƒ½äº†æ•è·/æ¯”è¾ƒäº‹ä»¶ä¸­æ–­ï¼Œé‚£ä¹ˆè¯¥<mark>äº‹ä»¶å‘ç”Ÿå</mark>ï¼ˆCC1Rå·²ä¿å­˜äº†æ•è·çš„å€¼ï¼‰ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªCC1Iä¸­æ–­ï¼Œé€’äº¤NVICï¼Œéšååœ¨åˆé€‚çš„æ—¶æœºæ‰§è¡Œå‘é‡è¡¨ä¸­å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆé€šè¿‡ <code>B</code>æŒ‡ä»¤ï¼Œå…³äºARMæ ¸å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå¯å‚è€ƒæœ¬ç«™æ–‡ç« ã€ŠARMæ ¸å­¦ä¹ ï¼ˆäº”ï¼‰å¼‚å¸¸å¤„ç†ã€‹ï¼‰ã€‚</p>
<p>æ‰€ä»¥åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­é€šè¿‡CC1Rè¯»å–åˆ°æ•è·äº‹ä»¶å‘ç”Ÿæ—¶è®¡æ•°å™¨çš„å¿«ç…§å€¼ã€‚</p>
<h3 id="hal-ku-shi-xian-3">HALåº“å®ç°</h3>
<h4 id="debug-amp-rcc">Debug &amp; RCC</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206101625690.png" alt="image-20241206101625690"></p>
<h4 id="chuan-kou-da-yin">ä¸²å£æ‰“å°</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206101717828.png" alt="image-20241206101717828"></p>
<h4 id="tim-5-ch-2-shu-chu-pwm">TIM5_CH2è¾“å‡ºPWM</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206102508269.png" alt="image-20241206102508269"></p>
<h4 id="tim-4-ch-1-shu-ru-bu-huo-amp-afio-zhong-ying-she">TIM4_CH1è¾“å…¥æ•è· &amp; AFIOé‡æ˜ å°„</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206103208047.png" alt="image-20241206103208047"></p>
<h4 id="tim-4-zhong-duan-shi-neng">TIM4ä¸­æ–­ä½¿èƒ½</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206105647297.png" alt="image-20241206105647297"></p>
<h4 id="printf-zhong-ding-xiang">printfé‡å®šå‘</h4>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206103342197.png" alt="image-20241206103342197" style="zoom: 50%;">
<p><code>usart.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="shi-li-dai-ma-2">ç¤ºä¾‹ä»£ç </h4>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_TIM4_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token comment">// TIM5 CH2 è¾“å‡ºPWM</span>
  <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim5<span class="token punctuation">,</span> TIM_CHANNEL_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TIM4 CH1 è¾“å…¥æ•è·</span>
  <span class="token function">HAL_TIM_IC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cycle = %.2f ms, freq = %.2f Hz\n"</span><span class="token punctuation">,</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END WHILE */</span>

  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>tim.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_IC_CaptureCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">__HAL_TIM_SET_COUNTER</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡CCRä¸­æ•è·çš„è®¡æ•°å€¼æ¥è®¡ç®—PWMå‘¨æœŸ</span>
    <span class="token comment">// å•æ¬¡è®¡æ•° 1/1MHz = 1usï¼Œå†é™¤ä»¥1000 è¿”å›æ¯«ç§’æ•°</span>
    <span class="token keyword">return</span> <span class="token function">__HAL_TIM_GET_COMPARE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> CCR <span class="token operator">=</span> <span class="token function">__HAL_TIM_GET_COMPARE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CCR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 / (CCR1 * 1000000) =&gt; Hzï¼Œå°†usè½¬ä¸ºsï¼Œå†å–å€’æ•°</span>
        <span class="token keyword">return</span> <span class="token number">1000000.0</span> <span class="token operator">/</span> CCR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="shi-yan-3-tong-shi-ce-liang-pwm-zhou-qi-pin-lu-zhan-kong-bi">å®éªŒ3-åŒæ—¶æµ‹é‡PWMå‘¨æœŸ/é¢‘ç‡/å ç©ºæ¯”</h2>
<h3 id="ding-shi-qi-hong-fa-xin-hao">å®šæ—¶å™¨è§¦å‘ä¿¡å·</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206110818625.png" alt="image-20241206110818625"></p>
<h3 id="hong-fa-shu-ru-xin-hao-di-yi-lei-lai-yuan-yu-qi-ta-ding-shi-qi-de-trgo">è§¦å‘è¾“å…¥ä¿¡å·ç¬¬ä¸€ç±»â€”â€”æ¥æºäºå…¶ä»–å®šæ—¶å™¨çš„TRGO</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206111247477.png" alt="image-20241206111247477"></p>
<h3 id="hong-fa-shu-ru-xin-hao-di-er-lei-wai-bu-hong-fa-yin-jiao-etr">è§¦å‘è¾“å…¥ä¿¡å·ç¬¬äºŒç±»â€”â€”å¤–éƒ¨è§¦å‘å¼•è„šETR</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206111541318.png" alt="image-20241206111541318"></p>
<blockquote>
<p>[!NOTE]</p>
<p>TIMx_CHxå¼•è„šæ¯”ETRæ›´å…·æœ‰é’ˆå¯¹æ€§ï¼Œä¸»è¦ç”¨äºè¾“å…¥æ•è·</p>
</blockquote>
<h3 id="hong-fa-shu-ru-xin-hao-di-san-lei-ti-1-f-ed">è§¦å‘è¾“å…¥ä¿¡å·ç¬¬ä¸‰ç±»â€”â€”TI1F_ED</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206112051092.png" alt="image-20241206112051092"></p>
<h3 id="hong-fa-shu-ru-xin-hao-di-si-lei-ti-1-fp-1-ti-2-fp-2">è§¦å‘è¾“å…¥ä¿¡å·ç¬¬å››ç±»â€”â€”TI1FP1/TI2FP2</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206112524528.png" alt="image-20241206112524528"></p>
<h3 id="ding-shi-qi-cong-mo-shi">å®šæ—¶å™¨ä»æ¨¡å¼</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206113102739.png" alt="image-20241206113102739"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206113306671.png" alt="image-20241206113306671"></p>
<h3 id="pwm-shu-ru-mo-shi">PWMè¾“å…¥æ¨¡å¼</h3>
<blockquote>
<p>[!NOTE]</p>
<p>å‚è€ƒæ‰‹å†Œï¼š15.3.6 PWM input mode</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206113849114.png" alt="image-20241206113849114"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206114143525.png" alt="image-20241206114143525"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206132233091.png" alt="image-20241206132233091"></p>
<h3 id="shi-li-dai-ma-3">ç¤ºä¾‹ä»£ç </h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206130223507.png" alt="image-20241206130223507"></p>
<p>åœ¨å®éªŒ2çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯¹ç…§æ¡†å›¾çœ‹çœ‹éœ€è¦è°ƒæ•´å“ªäº›é…ç½®ï¼š</p>
<ul>
<li>ä»æ¨¡å¼æ§åˆ¶å™¨
<ul>
<li>ä¹‹å‰æˆ‘ä»¬é€šè¿‡ä¸Šå‡æ²¿æ•è·äº‹ä»¶<mark>ä¸­æ–­</mark>æ¥å°†è®¡æ•°å™¨çš„å€¼æ¸…é›¶</li>
<li>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†TI1FP1ä½œä¸ºä»æ¨¡å¼æ§åˆ¶å™¨çš„è§¦å‘è¾“å…¥ä¿¡å·ï¼ˆTRGIï¼‰ï¼Œå¹¶é…ç½®ä»æ¨¡å¼ä¸ºå¤ä½æ¨¡å¼ï¼Œè¿™æ ·TI1FP1ä¿¡å·ä¸­çš„ä¸Šå‡æ²¿ä¼šè§¦å‘ä»æ¨¡å¼æ§åˆ¶å™¨è‡ªåŠ¨å°†è®¡æ•°å€¼æ¸…é›¶ï¼ˆ<mark>ç¡¬ä»¶è‡ªåŠ¨å®Œæˆ</mark>ï¼‰</li>
</ul>
</li>
<li>å¢åŠ è¾“å…¥æ•è·é€šé“2ï¼Œä½†æ˜¯è¾“å…¥æ•è·æ¥æºIC2ä¸æ˜¯CH2å¼•è„šï¼Œè€Œæ˜¯TI1ç»è¿‡æ»¤æ³¢å’Œè¾¹æ²¿æ£€æµ‹åçš„TI1FP2ä¿¡å·ï¼Œæˆ‘ä»¬å¯ä»¥å°†é€šé“2çš„ææ€§ï¼ˆCCER-CC2Pï¼‰é…ç½®ä¸ºä¸‹é™æ²¿ï¼Œè¿™æ ·IC2çš„ä¸‹é™æ²¿å°±ä¼šäº§ç”Ÿæ•è·äº‹ä»¶ï¼Œå°†PWMé«˜ç”µå¹³å¯¹åº”çš„è®¡æ•°å€¼è®°å½•åˆ°CC2Rä¸­</li>
</ul>
<h4 id="tim-4">tim4</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TIM4_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TIM4_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMDutyCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __TIM4_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========ä½¿èƒ½GPIOAå’ŒTIM4æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_TIM4EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIOæµ®ç©ºè¾“å…¥ mode=00 cnf=01 PB6</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_MODE6<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF6_1<span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF6_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨åŸºæœ¬é…ç½®</span>
    <span class="token comment">// å®šæ—¶å™¨è¾“å…¥é¢‘ç‡ 1MHz</span>
    TIM4<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">65535</span><span class="token punctuation">;</span> <span class="token comment">// å°½é‡ä¸è¦æº¢å‡º</span>
    <span class="token comment">// è®¡æ•°æ–¹å‘ä¸ºå‘ä¸Šè®¡æ•°</span>
    TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨é€šé“1é…ç½®</span>
    TIM4<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR2_TI1S<span class="token punctuation">;</span> <span class="token comment">// é€‰æ‹©CH1å¼•è„šä½œä¸ºTI1çš„æ¥æº</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1F<span class="token punctuation">;</span> <span class="token comment">// ä¸éœ€è¦è¾“å…¥æ»¤æ³¢ï¼Œè¢«æµ‹è¯•çš„PWMä¿¡å·æ²¡æœ‰å™ªå£°</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// æ•è·ä¸Šå‡æ²¿</span>
    <span class="token comment">// é€‰æ‹©TI1çš„æ»¤æ³¢/è¾¹æ²¿æ£€æµ‹è¾“å‡º1(TI1FP1)ä½œä¸ºæ•è·æ¥æº(IC1): 01</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_CC1S_0<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC1PSC<span class="token punctuation">;</span> <span class="token comment">// ä¸éœ€è¦å¯¹æ•è·äº‹ä»¶åˆ†é¢‘</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span>
        TIM_CCER_CC1E<span class="token punctuation">;</span> <span class="token comment">// ä½¿èƒ½è¾“å…¥æ•è·ï¼ˆäº‹ä»¶å‘ç”Ÿæ—¶å°†è®¡æ•°å€¼è®°å½•åˆ°CCRå¯„å­˜å™¨ä¸­ï¼‰</span>

    <span class="token comment">// ===========å®šæ—¶å™¨é€šé“2é…ç½®</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span> <span class="token comment">// æ•è·ä¸‹é™æ²¿</span>
    <span class="token comment">// é€‰æ‹©TI1FP2ä½œä¸ºIC2 =&gt; 10</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_CC2S_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC2S_0<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_IC2PSC<span class="token punctuation">;</span> <span class="token comment">// ä¸éœ€è¦å¯¹æ•è·äº‹ä»¶åˆ†é¢‘</span>
    TIM4<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span>
        TIM_CCER_CC2E<span class="token punctuation">;</span> <span class="token comment">// ä½¿èƒ½è¾“å…¥æ•è·ï¼ˆäº‹ä»¶å‘ç”Ÿæ—¶å°†è®¡æ•°å€¼è®°å½•åˆ°CCRå¯„å­˜å™¨ä¸­ï¼‰</span>

    <span class="token comment">//============ä¸éœ€è¦ä¸­æ–­æ¥å°†è®¡æ•°å€¼æ¸…é›¶äº†ï¼Œé€šè¿‡ä»æ¨¡å¼+ä¸Šå‡æ²¿è§¦å‘æ¥è‡ªåŠ¨å®Œæˆ</span>
    <span class="token comment">// TIM4-&gt;DIER |= TIM_DIER_CC1IE; // ä½¿èƒ½æ•è·äº‹ä»¶ä¸­æ–­</span>
    <span class="token comment">// NVIC_SetPriorityGrouping(3);</span>
    <span class="token comment">// NVIC_SetPriority(TIM4_IRQn, 3);</span>
    <span class="token comment">// NVIC_EnableIRQ(TIM4_IRQn);</span>

    <span class="token comment">// =============ä»æ¨¡å¼æ§åˆ¶å™¨é…ç½®</span>
    <span class="token comment">// ä»æ¨¡å¼é€‰æ‹©ï¼šå¤ä½æ¨¡å¼ =&gt; 100</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">|=</span> TIM_SMCR_SMS_2<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SMCR_SMS_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SMCR_SMS_0<span class="token punctuation">;</span>
    <span class="token comment">// ä»æ¨¡å¼è§¦å‘è¾“å…¥å¤šè·¯é€‰æ‹©ï¼šTI1FP1 =&gt; 101</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">|=</span> TIM_SMCR_TS_2<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SMCR_TS_1<span class="token punctuation">;</span>
    TIM4<span class="token operator">-&gt;</span>SMCR <span class="token operator">|=</span> TIM_SMCR_TS_0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> TIM4<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM4_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> TIM_SR_CC1IF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TIM4<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_CC1IF<span class="token punctuation">;</span>
        <span class="token comment">// è®¡æ•°å€¼æ¸…é›¶ï¼Œå¼€å§‹å¯¹ä¸‹ä¸ªPWMå‘¨æœŸè®¡æ•°</span>
        TIM4<span class="token operator">-&gt;</span>CNT <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CNT_CNT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡CCRä¸­æ•è·çš„è®¡æ•°å€¼æ¥è®¡ç®—PWMå‘¨æœŸ</span>
    <span class="token comment">// å•æ¬¡è®¡æ•° 1/1MHz = 1usï¼Œå†é™¤ä»¥1000 è¿”å›æ¯«ç§’æ•°</span>
    <span class="token keyword">return</span> TIM4<span class="token operator">-&gt;</span>CCR1 <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 / (CCR1 * 1000000) =&gt; Hzï¼Œå°†usè½¬ä¸ºsï¼Œå†å–å€’æ•°</span>
        <span class="token keyword">return</span> <span class="token number">1000000.0</span> <span class="token operator">/</span> TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">TIM4_CH1_GetPWMDutyCycle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> TIM4<span class="token operator">-&gt;</span>CCR2 <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> TIM4<span class="token operator">-&gt;</span>CCR1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-2">main</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim5.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim4.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"exti.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM5_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">TIM5_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM4_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> cycle <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> freq <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMFreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> duty <span class="token operator">=</span> <span class="token function">TIM4_CH1_GetPWMDutyCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"cycle = %.2f ms, freq = %.2f Hz, duty = %.2f %%"</span><span class="token punctuation">,</span> cycle<span class="token punctuation">,</span> freq<span class="token punctuation">,</span> duty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="hal-ku-shi-xian-4">HALåº“å®ç°</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206141354596.png" alt="image-20241206141354596"></p>
<h1 id="gao-ji-ding-shi-qi">é«˜çº§å®šæ—¶å™¨</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206142745316.png" alt="image-20241206142745316"></p>
<h2 id="zhong-fu-ji-shu-qi">é‡å¤è®¡æ•°å™¨</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206142916268.png" alt="image-20241206142916268"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206144030225.png" alt="image-20241206144030225"></p>
<h2 id="hu-bu-shu-chu">äº’è¡¥è¾“å‡º</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206144212749.png" alt=""></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206144550525.png" alt="image-20241206144550525"></p>
<h2 id="si-qu-shi-jian">æ­»åŒºæ—¶é—´</h2>
<p>æ­»åŒºæ—¶é—´æŒ‡çš„æ˜¯åœ¨ä¸¤ä¸ªå¼€å…³å™¨ä»¶ï¼ˆå¦‚ MOSFET æˆ– IGBTï¼‰åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œæ•…æ„å¼•å…¥çš„å»¶æ—¶ï¼Œç”¨æ¥ç¡®ä¿ä¸€ä¸ªå¼€å…³å®Œå…¨å…³é—­åï¼Œå¦ä¸€ä¸ªå¼€å…³æ‰ä¼šå¯¼é€šã€‚ï¼ˆ<mark>MOSç®¡å…·æœ‰å…³æ–­æ…¢ï¼Œå¼€é€šå¿«çš„ç‰¹æ€§</mark>ï¼‰</p>
<p><strong>ä¾‹å¦‚ï¼š<strong>åœ¨ H æ¡¥æˆ–åŠæ¡¥ç”µè·¯ä¸­ï¼Œä¸¤ä¸ªå¼€å…³å™¨ä»¶ï¼ˆä¸Šæ¡¥è‡‚å’Œä¸‹æ¡¥è‡‚ï¼‰ä¸èƒ½åŒæ—¶å¯¼é€šï¼Œå¦åˆ™ä¼šé€ æˆ</strong>ç›´é€šæ•…éšœ</strong>ï¼Œå³ç”µæºæ­£æç›´æ¥çŸ­è·¯åˆ°è´Ÿæã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145048925.png" alt="image-20241206145048925"></p>
<h2 id="cha-che-shu-ru-xin-hao">åˆ¹è½¦è¾“å…¥ä¿¡å·</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145502383.png" alt="image-20241206145502383"></p>
<h2 id="shi-yan-shu-chu-you-xian-ge-zhou-qi-de-pwm-bo">å®éªŒ-è¾“å‡ºæœ‰é™ä¸ªå‘¨æœŸçš„PWMæ³¢</h2>
<h3 id="xu-qiu">éœ€æ±‚</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145801442.png" alt="image-20241206145801442"></p>
<h3 id="ying-jian">ç¡¬ä»¶</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145943045.png" alt="image-20241206145943045" style="zoom:33%;">
<h3 id="ji-cun-qi-fen-xi">å¯„å­˜å™¨åˆ†æ</h3>
<h4 id="zhong-fu-ji-shu-qi-rep">é‡å¤è®¡æ•°å™¨REP</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206145721960.png" alt="image-20241206145721960"></p>
<h4 id="zhu-shu-chu-shi-neng">ä¸»è¾“å‡ºä½¿èƒ½</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206150128592.png" alt="image-20241206150128592"></p>
<h3 id="shi-li-dai-ma-4">ç¤ºä¾‹ä»£ç </h3>
<h4 id="tim-1">tim1</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ===========ä½¿èƒ½GPIOAå’ŒTIM1æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_TIM1EN<span class="token punctuation">;</span>

    <span class="token comment">// ===========GPIOå¤ç”¨æ¨æŒ½ PA8 mode=11 cnf=10</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE8<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF8_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF8_0<span class="token punctuation">;</span>

    <span class="token comment">// ===========å®šæ—¶å™¨é…ç½®</span>
    <span class="token comment">// å®šæ—¶å™¨æº¢å‡ºé¢‘ç‡ 71MHz / 7200 / 5000 = 2Hz 0.5s</span>
    TIM1<span class="token operator">-&gt;</span>PSC <span class="token operator">=</span> <span class="token number">7199</span><span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token number">4999</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¡æ•°æ–¹å‘ä¸ºå‘ä¸Šè®¡æ•°</span>
    TIM1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_DIR<span class="token punctuation">;</span>
    <span class="token comment">// é‡å¤è®¡æ•°å™¨</span>
    TIM1<span class="token operator">-&gt;</span>RCR <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// éœ€è¦ç”Ÿæˆ5ä¸ªPWMå‘¨æœŸ</span>

    <span class="token comment">// ===========å®šæ—¶å™¨é€šé“1è¾“å‡ºé…ç½®</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_CC1S<span class="token punctuation">;</span> <span class="token comment">// é…ç½®é€šé“ä¸ºæ¯”è¾ƒè¾“å‡ºæ¨¡å¼</span>
    <span class="token comment">// é…ç½®è¾“å‡ºæ¨¡å¼ä¸ºPWM1 =&gt; 110</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">2500</span><span class="token punctuation">;</span> <span class="token comment">// é…ç½®æ¯”è¾ƒå€¼</span>
    <span class="token comment">// é…ç½®è¾“å‡ºä½¿èƒ½ï¼Œå·¥ä½œç”µå¹³ææ€§: ä½ç”µå¹³ç‚¹äº®LED</span>
    TIM1<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1P<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> TIM_CR2_OIS1<span class="token punctuation">;</span> <span class="token comment">// å…³é—­ä¸»è¾“å‡ºä½¿èƒ½MOEåï¼Œè¾“å‡ºé€šé“çš„ç©ºé—²çŠ¶æ€ï¼šOC1=1</span>

    <span class="token comment">// å°†æ‰€æœ‰é¢„è£…è½½çš„å¯„å­˜å™¨åŠ è½½åˆ°å¯¹åº”çš„å·¥ä½œå¯„å­˜å™¨ä¸­ï¼Œå¹¶æ¸…é™¤ç”±æ­¤å¯¼è‡´çš„ä¸­æ–­æ ‡å¿—</span>
    TIM1<span class="token operator">-&gt;</span>EGR <span class="token operator">|=</span> TIM_EGR_UG<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
    <span class="token comment">// æˆ–è€…è®¾ç½®URSä½¿UGä¸äº§ç”Ÿæ›´æ–°ä¸­æ–­</span>
    <span class="token comment">// TIM1-&gt;CR1 |= TIM_CR1_URS;</span>
    <span class="token comment">// TIM1-&gt;EGR |= TIM_EGR_UG;</span>

    TIM1<span class="token operator">-&gt;</span>CCER <span class="token operator">|=</span> TIM_CCER_CC1E<span class="token punctuation">;</span>

    <span class="token comment">// ===========é«˜çº§å®šæ—¶å™¨ç›¸å…³é…ç½®</span>
    <span class="token comment">// é‡å¤è®¡æ•°å™¨æ›´æ–°ä¸­æ–­</span>
    TIM1<span class="token operator">-&gt;</span>DIER <span class="token operator">|=</span> TIM_DIER_UIE<span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>TIM1_UP_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>TIM1_UP_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM1_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸»è¾“å‡ºä½¿èƒ½ï¼Œé€šé“è¾“å‡ºä½¿èƒ½</span>
    TIM1<span class="token operator">-&gt;</span>BDTR <span class="token operator">|=</span> TIM_BDTR_MOE<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM1_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM1<span class="token operator">-&gt;</span>BDTR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_BDTR_MOE<span class="token punctuation">;</span>
    TIM1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CR1_CEN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TIM1_UP_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TIM1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"TIM1_UP_IRQHandler"</span><span class="token punctuation">)</span>
    <span class="token function">TIM1_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-3">main</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token function">TIM1_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="yi-liu-wen-ti">é—ç•™é—®é¢˜</h4>
<p>å¦‚ä¸‹ä¸¤ä¸ªä¸åŒçš„é…ç½®é¡ºåºä¼šå¯¼è‡´ä¸åŒçš„ç»“æœ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// é…ç½®è¾“å‡ºæ¨¡å¼ä¸ºPWM1 =&gt; 110</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">2500</span><span class="token punctuation">;</span> <span class="token comment">// é…ç½®æ¯”è¾ƒå€¼</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206172619192.png" alt="image-20241206172619192"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">TIM1<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">2500</span><span class="token punctuation">;</span> <span class="token comment">// é…ç½®æ¯”è¾ƒå€¼</span>
<span class="token comment">// é…ç½®è¾“å‡ºæ¨¡å¼ä¸ºPWM1 =&gt; 110</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_2<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">|=</span> TIM_CCMR1_OC1M_1<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>CCMR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_CCMR1_OC1M_0<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206172708938.png" alt="image-20241206172708938"></p>
<h3 id="shi-yong-ug-qiang-zhi-shua-xin-yu-zhuang-zai-zhi">ä½¿ç”¨UGå¼ºåˆ¶åˆ·æ–°é¢„è£…è½½å€¼</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// å°†æ‰€æœ‰é¢„åŠ è½½çš„å¯„å­˜å™¨åŠ è½½åˆ°å¯¹åº”çš„å·¥ä½œå¯„å­˜å™¨ä¸­ï¼Œå¹¶æ¸…é™¤ç”±æ­¤å¯¼è‡´çš„ä¸­æ–­æ ‡å¿—</span>
TIM1<span class="token operator">-&gt;</span>EGR <span class="token operator">|=</span> TIM_EGR_UG<span class="token punctuation">;</span>
TIM1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;=</span> <span class="token operator">~</span>TIM_SR_UIF<span class="token punctuation">;</span>
<span class="token comment">// æˆ–è€…è®¾ç½®URSä½¿UGä¸äº§ç”Ÿæ›´æ–°ä¸­æ–­</span>
<span class="token comment">// TIM1-&gt;CR1 |= TIM_CR1_URS;</span>
<span class="token comment">// TIM1-&gt;EGR |= TIM_EGR_UG;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184702361.png" alt="image-20241206184702361"></p>
<h3 id="hal-ku-shi-xian-5">HALåº“å®ç°</h3>
<h4 id="ding-shi-qi-he-tong-dao-pei-zhi">å®šæ—¶å™¨å’Œé€šé“é…ç½®</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184508910.png" alt="image-20241206184508910"></p>
<h4 id="tong-guo-geng-xin-shi-jian-zhong-duan-lai-ting-zhi-ding-shi-qi">é€šè¿‡æ›´æ–°äº‹ä»¶ä¸­æ–­æ¥åœæ­¢å®šæ—¶å™¨</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184152397.png" alt="image-20241206184152397"></p>
<h4 id="tim-1-ch-1-zhong-ying-she-wei-pa-8">TIM1_CH1é‡æ˜ å°„ä¸ºPA8</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241206184220481.png" alt="image-20241206184220481"></p>
<h4 id="dai-ma-shi-xian">ä»£ç å®ç°</h4>
<h5 id="main-c-3">main.c</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_TIM1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token comment">// æ¸…é™¤å®šæ—¶å™¨åˆå§‹åŒ–æ—¶è°ƒç”¨UG(Update Generation)å¼ºåˆ¶åˆ·æ–°é¢„è£…è½½å€¼äº§ç”Ÿçš„æ›´æ–°ä¸­æ–­</span>
  <span class="token function">__HAL_TIM_CLEAR_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_IT_UPDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__HAL_TIM_ENABLE_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_IT_UPDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE END WHILE */</span>

  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="tim-c">tim.c</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 1 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">HAL_TIM_PWM_Stop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>TIMER</tag>
        <tag>å®šæ—¶å™¨</tag>
        <tag>TIM</tag>
      </tags>
  </entry>
  <entry>
    <title>ç®—æ³•ä¹‹ç¾</title>
    <url>/2024/11/26/23674.html</url>
    <content><![CDATA[<h1 id="chun-bian-cheng-ti">çº¯ç¼–ç¨‹é¢˜</h1>
<h1 id="zhao-gui-lu-ti">æ‰¾è§„å¾‹é¢˜</h1>
<h1 id="lian-biao">é“¾è¡¨</h1>
<h1 id="zhan-he-dui-lie">æ ˆå’Œé˜Ÿåˆ—</h1>
<h1 id="di-gui-he-fen-zhi">é€’å½’å’Œåˆ†æ²»</h1>
<h1 id="pai-xu">æ’åº</h1>
<h1 id="er-fen-cha-zhao">äºŒåˆ†æŸ¥æ‰¾</h1>
<h1 id="ha-xi">å“ˆå¸Œ</h1>
<h1 id="er-cha-shu">äºŒå‰æ ‘</h1>
<h2 id="qian-zhong-hou-xu-bian-li-dfs">å‰ä¸­ååºéå†ï¼ˆDFSï¼‰</h2>
<h3 id="di-gui-shi-xian">é€’å½’å®ç°</h3>
<h3 id="fei-di-gui-shi-xian">éé€’å½’å®ç°</h3>
<h4 id="a-href-https-leetcode-cn-problems-binary-tree-preorder-traversal-144-er-cha-shu-de-qian-xu-bian-li-a"><a href="https://leetcode.cn/problems/binary-tree-preorder-traversal/">144. äºŒå‰æ ‘çš„å‰åºéå†</a></h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
<span class="token comment">/**
 * Note: The returned array must be malloced, assume caller calls free().
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_STACK_SIZE</span> <span class="token expression"><span class="token number">100</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
    LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">,</span>
    RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">,</span>
    SUBTREE_PROCESSED
<span class="token punctuation">}</span> TraverseState<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>
    TraverseState state<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Frame<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Frame<span class="token operator">*</span> frames<span class="token punctuation">[</span>MAX_STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Stack<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">,</span> Frame<span class="token operator">*</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> MAX_STACK_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    stack<span class="token operator">-&gt;</span>frames<span class="token punctuation">[</span>stack<span class="token operator">-&gt;</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> MAX_STACK_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">--</span>stack<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">isEmpty</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

Frame<span class="token operator">*</span> <span class="token function">peek</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> stack<span class="token operator">-&gt;</span>frames<span class="token punctuation">[</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pushNode</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Frame<span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp<span class="token operator">-&gt;</span>node <span class="token operator">=</span> node<span class="token punctuation">;</span>
        tmp<span class="token operator">-&gt;</span>state <span class="token operator">=</span> LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">;</span>
        <span class="token function">push</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">preorderTraversal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> returnSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>returnSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> MAX_STACK_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Stack<span class="token operator">*</span> stack <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Frame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>state <span class="token operator">==</span> LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>returnSize<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span>
            <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frame<span class="token operator">-&gt;</span>state <span class="token operator">=</span> RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>state <span class="token operator">==</span> RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frame<span class="token operator">-&gt;</span>state <span class="token operator">=</span> SUBTREE_PROCESSED<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">pop</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="a-href-https-leetcode-cn-problems-binary-tree-inorder-traversal-94-er-cha-shu-de-zhong-xu-bian-li-a"><a href="https://leetcode.cn/problems/binary-tree-inorder-traversal/">94. äºŒå‰æ ‘çš„ä¸­åºéå†</a></h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
<span class="token comment">/**
 * Note: The returned array must be malloced, assume caller calls free().
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_STACK_SIZE</span> <span class="token expression"><span class="token number">100</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
    LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">,</span>
    RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">,</span>
    SUBTREE_PROCESSED
<span class="token punctuation">}</span> TraverseState<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>
    TraverseState state<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Frame<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Frame<span class="token operator">*</span> frames<span class="token punctuation">[</span>MAX_STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Stack<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">,</span> Frame<span class="token operator">*</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> MAX_STACK_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    stack<span class="token operator">-&gt;</span>frames<span class="token punctuation">[</span>stack<span class="token operator">-&gt;</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> MAX_STACK_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">--</span>stack<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">isEmpty</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

Frame<span class="token operator">*</span> <span class="token function">peek</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> stack<span class="token operator">-&gt;</span>frames<span class="token punctuation">[</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pushNode</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Frame<span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp<span class="token operator">-&gt;</span>node <span class="token operator">=</span> node<span class="token punctuation">;</span>
        tmp<span class="token operator">-&gt;</span>state <span class="token operator">=</span> LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">;</span>
        <span class="token function">push</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">inorderTraversal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> returnSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>returnSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> MAX_STACK_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Stack<span class="token operator">*</span> stack <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Frame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>state <span class="token operator">==</span> LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frame<span class="token operator">-&gt;</span>state <span class="token operator">=</span> RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>state <span class="token operator">==</span> RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>returnSize<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span>
            <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frame<span class="token operator">-&gt;</span>state <span class="token operator">=</span> SUBTREE_PROCESSED<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">pop</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="a-href-https-leetcode-cn-problems-binary-tree-postorder-traversal-145-er-cha-shu-de-hou-xu-bian-li-a"><a href="https://leetcode.cn/problems/binary-tree-postorder-traversal/">145. äºŒå‰æ ‘çš„ååºéå†</a></h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
<span class="token comment">/**
 * Note: The returned array must be malloced, assume caller calls free().
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_STACK_SIZE</span> <span class="token expression"><span class="token number">100</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
    LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">,</span>
    RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">,</span>
    SUBTREE_PROCESSED
<span class="token punctuation">}</span> TraverseState<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>
    TraverseState state<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Frame<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Frame<span class="token operator">*</span> frames<span class="token punctuation">[</span>MAX_STACK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Stack<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">,</span> Frame<span class="token operator">*</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> MAX_STACK_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    stack<span class="token operator">-&gt;</span>frames<span class="token punctuation">[</span>stack<span class="token operator">-&gt;</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> MAX_STACK_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">--</span>stack<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">isEmpty</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> stack<span class="token operator">-&gt;</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

Frame<span class="token operator">*</span> <span class="token function">peek</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> stack<span class="token operator">-&gt;</span>frames<span class="token punctuation">[</span>stack<span class="token operator">-&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pushNode</span><span class="token punctuation">(</span>Stack<span class="token operator">*</span> stack<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Frame<span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Frame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp<span class="token operator">-&gt;</span>node <span class="token operator">=</span> node<span class="token punctuation">;</span>
        tmp<span class="token operator">-&gt;</span>state <span class="token operator">=</span> LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">;</span>
        <span class="token function">push</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">postorderTraversal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> returnSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>returnSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> MAX_STACK_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Stack<span class="token operator">*</span> stack <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Frame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>state <span class="token operator">==</span> LEFT_SUBTREE_UNPROCESSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frame<span class="token operator">-&gt;</span>state <span class="token operator">=</span> RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>state <span class="token operator">==</span> RIGHT_SUBTREE_UNPROCESSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pushNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frame<span class="token operator">-&gt;</span>state <span class="token operator">=</span> SUBTREE_PROCESSED<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>returnSize<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span>
            <span class="token function">pop</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="a-href-https-leetcode-cn-problems-n-ary-tree-preorder-traversal-589-n-cha-shu-de-qian-xu-bian-li-a"><a href="https://leetcode.cn/problems/n-ary-tree-preorder-traversal/">589. N å‰æ ‘çš„å‰åºéå†</a></h4>
<h4 id="a-href-https-leetcode-cn-problems-n-ary-tree-postorder-traversal-590-n-cha-shu-de-hou-xu-bian-li-a"><a href="https://leetcode.cn/problems/n-ary-tree-postorder-traversal/">590. N å‰æ ‘çš„ååºéå†</a></h4>
<h2 id="an-ceng-bian-li-bfs">æŒ‰å±‚éå†ï¼ˆBFSï¼‰</h2>
<h4 id="a-href-https-leetcode-cn-problems-binary-tree-level-order-traversal-102-er-cha-shu-de-ceng-xu-bian-li-a"><a href="https://leetcode.cn/problems/binary-tree-level-order-traversal/">102. äºŒå‰æ ‘çš„å±‚åºéå†</a></h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128141110383.png" alt="image-20241128141110383"></p>
<h5 id="fang-fa-yi-you-size-lai-zuo-mei-yi-ceng-de-fen-ge">ğŸŒŸæ–¹æ³•ä¸€ï¼šç”±sizeæ¥åšæ¯ä¸€å±‚çš„åˆ†éš”</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
<span class="token comment">/**
 * Return an array of arrays of size *returnSize.
 * The sizes of the arrays are returned as *returnColumnSizes array.
 * Note: Both returned array and *columnSizes array must be malloced, assume caller calls free().
 */</span>
<span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token function">levelOrder</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> returnSize<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> returnColumnSizes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>returnSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>returnColumnSizes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> queue<span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> head<span class="token punctuation">,</span> tail<span class="token punctuation">;</span>
    head <span class="token operator">=</span> tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> root<span class="token punctuation">;</span> <span class="token comment">// enqueue root</span>

    <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> ans <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>levelSizes <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>tail <span class="token operator">-</span> head <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        levelSizes<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">=</span> tail <span class="token operator">-</span> head<span class="token punctuation">;</span>
        ans<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> levelSizes<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> levelSizes<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span>node <span class="token operator">=</span> queue<span class="token punctuation">[</span>head<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// dequeue</span>
            ans<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>left<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>right <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>right<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        level<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>returnSize <span class="token operator">=</span> level<span class="token punctuation">;</span>
    <span class="token operator">*</span>returnColumnSizes <span class="token operator">=</span> levelSizes<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ans<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="fang-fa-er-ji-lu-ceng-hao">æ–¹æ³•äºŒï¼šè®°å½•å±‚å·</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdlib.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdbool.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../tree.h"</span></span>
<span class="token comment">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
<span class="token comment">/**
 * Return an array of arrays of size *returnSize.
 * The sizes of the arrays are returned as *returnColumnSizes array.
 * Note: Both returned array and *columnSizes array must be malloced, assume caller calls free().
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> TreeNode_t<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_ListNode</span> <span class="token punctuation">{</span>
    TreeNode_t <span class="token operator">*</span>treeNode<span class="token punctuation">;</span>
    <span class="token keyword">int</span> level<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">_ListNode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_ListNode</span> ListNode_t<span class="token punctuation">;</span>


<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ListNode_t<span class="token operator">*</span> head<span class="token punctuation">;</span>
    ListNode_t<span class="token operator">*</span> tail<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Queue<span class="token punctuation">;</span>

Queue<span class="token operator">*</span> <span class="token function">initQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ListNode_t<span class="token operator">*</span> dummy <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ListNode_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dummy<span class="token operator">-&gt;</span>treeNode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    dummy<span class="token operator">-&gt;</span>level <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    dummy<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    Queue <span class="token operator">*</span>queue <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queue<span class="token operator">-&gt;</span>head <span class="token operator">=</span> queue<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> dummy<span class="token punctuation">;</span>
    queue<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> queue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">isEmpty</span><span class="token punctuation">(</span>Queue <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queue<span class="token operator">-&gt;</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">offer</span><span class="token punctuation">(</span>Queue <span class="token operator">*</span>queue<span class="token punctuation">,</span> TreeNode_t<span class="token operator">*</span> treeNode<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ListNode_t<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ListNode_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>treeNode <span class="token operator">=</span> treeNode<span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>level <span class="token operator">=</span> level<span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    queue<span class="token operator">-&gt;</span>tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
    queue<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span>
    queue<span class="token operator">-&gt;</span>size<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ListNode_t<span class="token operator">*</span> <span class="token function">poll</span><span class="token punctuation">(</span>Queue <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-&gt;</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ListNode_t <span class="token operator">*</span>node <span class="token operator">=</span> queue<span class="token operator">-&gt;</span>head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    queue<span class="token operator">-&gt;</span>head<span class="token operator">-&gt;</span>next <span class="token operator">=</span> node<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    queue<span class="token operator">-&gt;</span>size<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        queue<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> queue<span class="token operator">-&gt;</span>head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token function">levelOrder</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> returnSize<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> returnColumnSizes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>returnSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>returnColumnSizes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span>res <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>levelSizes <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>returnColumnSizes <span class="token operator">=</span> levelSizes<span class="token punctuation">;</span>

    Queue<span class="token operator">*</span> queue <span class="token operator">=</span> <span class="token function">initQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">offer</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>level <span class="token operator">=</span>  <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‡ºé˜Ÿå…ƒç´ </span>
        ListNode_t <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœå…ƒç´ æ‰€åœ¨å±‚çº§ä¸ç­‰äºå½“å‰è¦æ”¶é›†çš„å±‚çº§ï¼Œå°†ä¹‹å‰å·²æ”¶é›†çš„å±‚çº§ä¿å­˜åˆ°ç»“æœä¸­</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>level <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> level<span class="token punctuation">;</span>
            levelSizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span> <span class="token comment">// è®°å½•è¿™ä¸€å±‚çš„èŠ‚ç‚¹æ•°é‡</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// å¼€å§‹ä¸‹ä¸€å±‚çº§çš„æ”¶é›†</span>
            level <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        TreeNode_t <span class="token operator">*</span>treeNode <span class="token operator">=</span> node<span class="token operator">-&gt;</span>treeNode<span class="token punctuation">;</span>
        <span class="token comment">// æ”¶é›†æ•°å€¼</span>
        level<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> treeNode<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span>
        <span class="token comment">// å°†å­èŠ‚ç‚¹å…¥é˜Ÿ</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>treeNode<span class="token operator">-&gt;</span>left <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">offer</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> treeNode<span class="token operator">-&gt;</span>left<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>treeNode<span class="token operator">-&gt;</span>right <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">offer</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> treeNode<span class="token operator">-&gt;</span>right<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> level<span class="token punctuation">;</span>
    levelSizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span> <span class="token comment">// è®°å½•è¿™ä¸€å±‚çš„èŠ‚ç‚¹æ•°é‡</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>returnSize <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="fang-fa-san-you-null-lai-zuo-mei-ceng-de-fen-ge">æ–¹æ³•ä¸‰ï¼šç”±nullæ¥åšæ¯å±‚çš„åˆ†éš”</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token function">levelOrder</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> returnSize<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> returnColumnSizes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>returnSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>returnColumnSizes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> ans <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>levelSizes <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> queue<span class="token punctuation">[</span><span class="token number">4000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> head<span class="token punctuation">,</span> tail<span class="token punctuation">;</span>
    head <span class="token operator">=</span> tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> root<span class="token punctuation">;</span> <span class="token comment">// enqueue root</span>
    queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// enqueue level separator</span>

    <span class="token keyword">int</span> <span class="token operator">*</span>levelVals <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>tail <span class="token operator">-</span> head <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span>node <span class="token operator">=</span> queue<span class="token punctuation">[</span>head<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            levelVals<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>left<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>right <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>right<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            levelSizes<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>  <span class="token comment">// record level size</span>
            ans<span class="token punctuation">[</span>level<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> levelVals<span class="token punctuation">;</span>   <span class="token comment">// record level values</span>
            levelVals <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>tail <span class="token operator">-</span> head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// store next level</span>
            j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// index of next level</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>tail <span class="token operator">&gt;</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">[</span>tail<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// separator for next level</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>returnSize <span class="token operator">=</span> level<span class="token punctuation">;</span>
    <span class="token operator">*</span>returnColumnSizes <span class="token operator">=</span> levelSizes<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ans<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="di-gui-jie-fa">é€’å½’è§£æ³•</h5>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">levelOrder</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ans<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ ‡å‡†DFSéå†äºŒå‰æ ‘</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token comment">// å‰åºéå†</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ans<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> level<span class="token punctuation">)</span> ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆå§‹åŒ–æ”¶é›†å½“å‰å±‚èŠ‚ç‚¹çš„é›†åˆ</span>
        ans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">dfs</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> ans<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dfs</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> ans<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="a-href-https-leetcode-cn-com-problems-cong-shang-dao-xia-da-yin-er-cha-shu-iii-lcof-jian-zhi-offer-32-iii-cong-shang-dao-xia-da-yin-er-cha-shu-iii-a-zhi-zi-xing"><a href="https://leetcode-cn.com/problems/cong-shang-dao-xia-da-yin-er-cha-shu-iii-lcof/">å‰‘æŒ‡ Offer 32 - III. ä»ä¸Šåˆ°ä¸‹æ‰“å°äºŒå‰æ ‘ III</a>ï¼ˆä¹‹å­—å½¢ï¼‰</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
<span class="token comment">/**
 * Return an array of arrays of size *returnSize.
 * The sizes of the arrays are returned as *returnColumnSizes array.
 * Note: Both returned array and *columnSizes array must be malloced, assume caller calls free().
 */</span>
<span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token function">decorateRecord</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span><span class="token operator">*</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> returnSize<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> returnColumnSizes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>returnSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span><span class="token operator">*</span>q1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">501</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span><span class="token operator">*</span>q2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">501</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> top1<span class="token punctuation">,</span> top2<span class="token punctuation">;</span>
    top1 <span class="token operator">=</span> top2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span>ans <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>levelSizes <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool reverse <span class="token operator">=</span> false<span class="token punctuation">;</span>

    q1<span class="token punctuation">[</span>top1<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> root<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>top1 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> <span class="token operator">*</span>arr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> top1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>top1 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span>node <span class="token operator">=</span> q1<span class="token punctuation">[</span><span class="token operator">--</span>top1<span class="token punctuation">]</span><span class="token punctuation">;</span>
            arr<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>reverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>right <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> q2<span class="token punctuation">[</span>top2<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>right<span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> q2<span class="token punctuation">[</span>top2<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>left<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> q2<span class="token punctuation">[</span>top2<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>left<span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>right <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> q2<span class="token punctuation">[</span>top2<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token operator">-&gt;</span>right<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        reverse <span class="token operator">=</span> <span class="token operator">!</span>reverse<span class="token punctuation">;</span>
        levelSizes<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">=</span> index<span class="token punctuation">;</span>
        ans<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">;</span>
        level<span class="token operator">++</span><span class="token punctuation">;</span>
        
        <span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token operator">*</span><span class="token operator">*</span>tmp <span class="token operator">=</span> q1<span class="token punctuation">;</span>
        q1 <span class="token operator">=</span> q2<span class="token punctuation">;</span>
        q2 <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token keyword">int</span> tmp2 <span class="token operator">=</span> top1<span class="token punctuation">;</span>
        top1 <span class="token operator">=</span> top2<span class="token punctuation">;</span>
        top2 <span class="token operator">=</span> tmp2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">free</span><span class="token punctuation">(</span>q1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>returnSize <span class="token operator">=</span> level<span class="token punctuation">;</span>
    <span class="token operator">*</span>returnColumnSizes <span class="token operator">=</span> levelSizes<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ans<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>ç®—æ³•</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£IÂ²Cåè®®åŠåº•å±‚åŸç†ï¼ˆåŸºäºSTM32F103ZEï¼‰</title>
    <url>/2024/11/30/28867.html</url>
    <content><![CDATA[<h1 id="can-kao-shou-ce">å‚è€ƒæ‰‹å†Œ</h1>
<ul>
<li>IÂ²Cåè®®æ‰‹å†Œï¼š<a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">UM10204  I2C-bus specification and user manual</a></li>
<li><a href="https://atta.szlcsc.com/upload/public/pdf/source/20140724/1457707167301.pdf">EEPROM M24C02</a></li>
<li>STM32F103å‚è€ƒæ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></li>
<li>STM32103ZEæ•°æ®æ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/datasheet/stm32f103rc.pdf">STM32F103xC, STM32F103xD, STM32F103xE </a></li>
</ul>
<h1 id="i-2-c-gai-lan">IÂ²Cæ¦‚è§ˆ</h1>
<h2 id="gai-nian">æ¦‚å¿µ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130151131386.png" alt="image-20241130151131386"></p>
<h2 id="wu-li-ceng-dian-lu-lian-jie">ç‰©ç†å±‚ç”µè·¯è¿æ¥</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130151722614.png" alt="image-20241130151722614"></p>
<h2 id="xie-yi-ceng">åè®®å±‚</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130152248208.png" alt="image-20241130152248208"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153034269.png" alt="image-20241130153034269"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130152552172.png" alt="image-20241130152552172"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153259952.png" alt="image-20241130153259952"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153342500.png" alt="image-20241130153342500"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153713298.png" alt="image-20241130153713298"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130153731435.png" alt="image-20241130153731435"></p>
<h1 id="ruan-jian-kong-zhi-shi-xian-i-2-c-ji-cun-qi-ban-ben">è½¯ä»¶æ§åˆ¶å®ç°I2Cï¼ˆå¯„å­˜å™¨ç‰ˆæœ¬ï¼‰</h1>
<h2 id="shi-xu-zong-lan">æ—¶åºæ€»è§ˆ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201154135590.png" alt="I2Cå‚è€ƒæ‰‹å†Œ"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201154158566.png" alt="I2Cå‚è€ƒæ‰‹å†Œ"></p>
<h2 id="gpio-chu-shi-hua">GPIOåˆå§‹åŒ–</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201081651313.png" alt="image-20241201081651313"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201082200624.png" alt="image-20241201082200624"></p>
<h3 id="shi-neng-shi-zhong">ä½¿èƒ½æ—¶é’Ÿ</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="pei-zhi-gong-zuo-mo-shi-wei-tong-yong-kai-lou-shu-chu">é…ç½®å·¥ä½œæ¨¡å¼ä¸ºé€šç”¨å¼€æ¼è¾“å‡º</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201154628032.png" alt="I2Cå‚è€ƒæ‰‹å†Œ"></p>
<blockquote>
<p>[!NOTE]</p>
<p>å¦‚åŸç†å›¾æ‰€ç¤ºï¼ŒPB10/11å¤–æ¥äº†ä¸Šæ‹‰ç”µé˜»</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130193839904.png" alt="STM32å‚è€ƒæ‰‹å†Œ"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="mo-ren-shu-chu-gao-dian-ping">é»˜è®¤è¾“å‡ºé«˜ç”µå¹³</h3>
<blockquote>
<p>When the bus is free, both lines are HIGH.</p>
</blockquote>
<p>æ ¹æ®I2Cåè®®è§„èŒƒï¼ŒSDAå’ŒSCLåº”è¯¥åœ¨æ€»çº¿ä¸ºç©ºé—²çŠ¶æ€æ—¶ä¿æŒé«˜ç”µå¹³ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å…¶åˆå§‹åŒ–ä¸ºé«˜ç”µå¹³ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

SCL_HIGH<span class="token punctuation">;</span>
SDA_HIGH<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="wan-zheng-chu-shi-hua-dai-ma">å®Œæ•´åˆå§‹åŒ–ä»£ç </h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIOæ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. é…ç½®GPIOå·¥ä½œæ¨¡å¼ä¸ºé€šç”¨å¼€æ¼è¾“å‡º mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. æ€»çº¿ç©ºé—²çŠ¶æ€æ—¶ï¼Œé»˜è®¤é«˜ç”µå¹³</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="scl-shi-zhong-pin-lu-amp-yan-shi-han-shu">SCLæ—¶é’Ÿé¢‘ç‡&amp;å»¶æ—¶å‡½æ•°</h2>
<p>ä»¥I2Cæ ‡å‡†æ¨¡å¼ä¸ºä¾‹ï¼Œéœ€è¦è€ƒè™‘å¦‚ä¸‹ä¸‰ä¸ªå‚æ•°ï¼ˆ<mark>ä¸‹æ–‡ä»¥æ ‡å‡†æ¨¡å¼ä¸ºä¾‹è¿›è¡Œè¯´æ˜</mark>ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201155642567.png" alt="image-20241201155642567"></p>
<h3 id="scl-shi-zhong-pin-lu">SCLæ—¶é’Ÿé¢‘ç‡</h3>
<img src="C:\Users\86157\AppData\Roaming\Typora\typora-user-images\image-20241201155834783.png" alt="image-20241201155834783" style="zoom:50%;">
<p>f<sub>SCL</sub>é™åˆ¶æˆ‘ä»¬æ§åˆ¶SCLè¾“å‡ºé«˜ä½ç”µå¹³äº§ç”Ÿæ–¹æ³¢è„‰å†²æ—¶ï¼Œé¢‘ç‡<mark>æœ€å¤§</mark>ä¸º100kHzï¼Œå³ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆé«˜ç”µå¹³æ—¶é—´+ä½ç”µå¹³æ—¶é—´ï¼‰<mark>æœ€çŸ­</mark>ä¸º<code>1/100kHz = 10us</code></p>
<h3 id="gao-dian-ping-zhou-qi-amp-di-dian-ping-zhou-qi">é«˜ç”µå¹³å‘¨æœŸ&amp;ä½ç”µå¹³å‘¨æœŸ</h3>
<p>t<sub>LOW</sub>å’Œt<sub>HIGH</sub>åˆ™è¦æ±‚æˆ‘ä»¬SCLæ‹‰é«˜æ—¶é—´è‡³å°‘æŒç»­4.7usï¼Œæ‹‰ä½æ—¶é—´è‡³å°‘æŒç»­4us</p>
<h3 id="yan-shi-han-shu">å»¶æ—¶å‡½æ•°</h3>
<p>å¦‚ä¸‹æˆ‘ä»¬å¯ä»¥å‡†å¤‡ä¸€ä¸ª5usçš„å»¶æ—¶å‡½æ•°ï¼ˆä»¥STM32F103ä¸»é¢‘72Mä¸ºä¾‹ï¼Œé€šè¿‡é€»è¾‘åˆ†æä»ªè°ƒæ•´å…¶å»¶æ—¶æ—¶é—´æ¯”5usç•¥é•¿å³å¯ï¼‰ï¼Œä½œä¸ºç»´æŒSCLé«˜ç”µå¹³å‘¨æœŸã€ä½ç”µå¹³å‘¨æœŸçš„æ—¶åºæ§åˆ¶ï¼›å¹¶ä¸”ä¸¤è€…ç›¸åŠ åä¸º10usï¼Œä¹Ÿç¬¦åˆæ—¶é’Ÿå‘¨æœŸè¦å¤§äº10usçš„è§„èŒƒ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!NOTE]</p>
<p>è¿™é‡Œä½¿ç”¨ <code>volatile</code>å…³é”®å­—æ¥ç¦ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–ï¼ˆä¾‹å¦‚å°† <code>i</code>çš„å€¼åŠ è½½åˆ°å¯„å­˜å™¨ååœ¨å¯„å­˜å™¨ä¸­è‡ªå‡åˆ°0å†å›å†™å†…å­˜ï¼‰ï¼Œä½¿å¾—æ¯æ¬¡è¯»å†™ <code>i</code>éƒ½å¼ºåˆ¶è®¿é—®å†…å­˜ï¼Œé¿å…ä¸åŒä¼˜åŒ–çº§åˆ«ä¸‹è¯¥å‡½æ•°çš„å»¶æ—¶è¡¨ç°ä¸ä¸€è‡´ã€‚</p>
</blockquote>
<blockquote>
<p>[!NOTE]</p>
<p>å¦‚æœæœŸæœ›æ›´çŸ­çš„å»¶æ—¶ï¼Œåˆ™å¯ä»¥é’ˆå¯¹4.7uså’Œ4uså„è‡ªå®ç°ä¸€ä¸ªæ›´ç²¾å‡†åœ°å»¶æ—¶å‡½æ•°ã€‚</p>
<p>ä½†å¯¹äºä¸€èˆ¬åœºæ™¯æ¥è¯´ï¼Œæ²¡å¿…è¦ä¼˜åŒ–é‚£ä¸€ç‚¹æ—¶é—´æ•ˆç‡ï¼ŒI2Cæœ¬å°±æ˜¯ä½é€Ÿé€šä¿¡åè®®ï¼Œæ ‡å‡†æ¨¡å¼ä¸‹çš„é€Ÿåº¦ç“¶é¢ˆä¸º100kHzï¼Œè¿™æ˜¯ç”±è®¾å¤‡çš„ç”µæ°”ç‰¹æ€§å†³å®šçš„ï¼Œå› æ­¤<mark>ä¸ç”¨å¤ªçº ç»“å¸¸æ•°çº§åˆ«çš„æ€§èƒ½ä¼˜åŒ–</mark>ï¼ˆä¾‹å¦‚å°†å‡½æ•°å»¶æ—¶ä¼˜åŒ–åˆ°å†é è¿‘ <code>Min</code>å€¼ä¸€ç‚¹ï¼‰ã€‚</p>
</blockquote>
<p>ç”±äºåç»­æ—¶åºæ§åˆ¶å¾ˆå¤šåœ°æ–¹ä¼šç”¨åˆ°å»¶æ—¶ï¼Œä¸ºäº†ç¨‹åºæœ‰æ›´å¥½çš„ç§»æ¤æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å®šä¹‰æˆå®ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">STANDARD_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="qi-shi-xin-hao-start-condition">èµ·å§‹ä¿¡å·ï¼ˆStart Conditionï¼‰</h2>
<blockquote>
<p>A HIGH to LOW transition on the SDA line while SCL is HIGH defines a START condition</p>
</blockquote>
<p><mark>èµ·å§‹ä¿¡å·çš„å®šä¹‰ï¼šåœ¨SCLé«˜ç”µå¹³æ—¶ï¼ŒSDAç”±é«˜åˆ°ä½çš„è·³å˜ã€‚</mark></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201164737043.png" alt="image-20241201164737043" style="zoom:50%;">
<p>è¿™é‡Œéœ€è¦å…³æ³¨ä¸¤ä¸ªæ—¶å»¶å‚æ•°ï¼Œèµ·å§‹ä¿¡å·å»ºç«‹æ—¶é—´ï¼ˆSUï¼Œset-upï¼‰å’Œä¿æŒæ—¶é—´ï¼ˆHDï¼Œholdï¼‰ï¼š</p>
<ul>
<li>èµ·å§‹ä¿¡å·å»ºç«‹æ—¶é—´ï¼ˆå…ˆè¦å°†SDAå‡†å¤‡ä¸ºé«˜ç”µå¹³çŠ¶æ€ï¼Œéšåæ‰èƒ½ç”±é«˜æ‹‰ä½ï¼‰ï¼šSCLä¸ºé«˜æ—¶ï¼Œå°†SDAå‡†å¤‡ä¸ºé«˜ç”µå¹³çŠ¶æ€ï¼Œå¹¶è‡³å°‘ä¿æŒ<mark>4.7us</mark></li>
<li>èµ·å§‹ä¿¡å·ä¿æŒæ—¶é—´ï¼ˆåœ¨SCLä¸ºé«˜æ—¶ï¼Œå°†SDAæ‹‰ä½åï¼Œéœ€è¦å°†SDAä½ç”µå¹³çŠ¶æ€ä¿æŒä¸€ç«¯æ—¶é—´ï¼‰ï¼šè‡³å°‘ä¸º<mark>4us</mark></li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201165047337.png" alt="image-20241201165047337"></p>
<p>è™½ç„¶t<sub>SU;STA</sub>è¢«æè¿°ä¸ºå‘é€é‡å¤èµ·å§‹ä¿¡å·æ—¶æ‰€éœ€çš„æ—¶åºè¦æ±‚ï¼Œä½†è¿™é‡Œä¸ºäº†å°è£…æˆç»Ÿä¸€çš„æ¥å£ï¼Œè®©è°ƒç”¨æ–¹å‘é€èµ·å§‹ä¿¡å·æ—¶æ— éœ€å…³å¿ƒè¯¥ç»†èŠ‚ï¼Œæˆ‘ä»¬ç»Ÿä¸€å¢åŠ è¯¥å»¶æ—¶ã€‚</p>
<h3 id="shi-xu-kong-zhi">æ—¶åºæ§åˆ¶</h3>
<ul>
<li>æ‹‰é«˜SCLï¼Œæ‹‰é«˜SDAï¼Œç»´æŒä¸€ä¸ªSCLé«˜ç”µå¹³å‘¨æœŸï¼ˆé—´æ¥æ»¡è¶³äº†SDAçš„å»ºç«‹æ—¶é—´ï¼‰</li>
<li>SDAæ‹‰ä½ï¼Œç»´æŒä¸€ä¸ªStartä¿æŒæ—¶é—´4usï¼ˆå¯ä»¥å¤ç”¨5usçš„å»¶æ—¶å‡½æ•°ï¼‰</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDAæ‹‰é«˜ï¼Œå¹¶ç»´æŒstartå»ºç«‹æ—¶é—´</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDAæ‹‰ä½ï¼Œå¹¶ç»´æŒstartä¿æŒæ—¶é—´</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!NOTE]</p>
<p>å…³äºé‡å¤èµ·å§‹ä¿¡å·çš„å®šä¹‰ï¼Œå¯ä»¥è€ƒè™‘ä¸‹EEPROMçš„éšæœºè¯»æ—¶åºï¼š</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201170301458.png" alt="image-20241201170301458"></p>
<p>ä¸ºäº†èƒ½å¤Ÿä»æŒ‡å®šåœ°å€è¯»æ•°æ®ï¼Œå› æ­¤éœ€è¦å…ˆå‘é€ä¸€ä¸ªå‡å†™ï¼ˆdummy writeï¼‰ï¼Œè®¾ç½®EEPROMå†…éƒ¨åœ°å€çš„åœ°å€å¯„å­˜å™¨ï¼ˆç±»æ¯”ç†è§£è°ƒæ•´ç£å¤´åˆ°æŒ‡å®šçš„ä½ç½®ã€ç¿»ä¹¦åˆ°æŒ‡å®šçš„é¡µé¢ï¼‰ï¼Œç„¶åé‡å¤å‘é€èµ·å§‹ä¿¡å·ï¼Œè¿›å…¥è¯»æ¨¡å¼ï¼Œè¯»å–æŒ‡å®šåœ°å€çš„æ•°æ®ã€‚</p>
<h2 id="fa-song-zi-jie-shu-ju">å‘é€å­—èŠ‚æ•°æ®</h2>
<h3 id="zi-jie-ge-shi">å­—èŠ‚æ ¼å¼</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201170805761.png" alt="image-20241201170805761"></p>
<p>è¿™é‡Œæœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>é€šè¿‡SDAä¼ è¾“çš„æ¯ä¸ªå­—èŠ‚ï¼ˆæ•°æ®ï¼‰<mark>é•¿åº¦å¿…é¡»ä¸º8ä¸ªbit</mark></li>
<li>åœ¨å•æ¬¡ä¼ è¾“ä¸­ï¼Œå¯è¢«å‘é€çš„å­—èŠ‚æ•°æ²¡æœ‰é™åˆ¶</li>
<li>å‘é€æ–¹æ¯å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œéœ€è¦ç­‰å¾…æ¥æ”¶æ–¹å“åº”ä¸€ä¸ªackç¡®è®¤ä¿¡å·</li>
<li>æ•°æ®ä¼ è¾“éµå¾ª<mark>é«˜ä½ä¼˜å…ˆ</mark>çš„æ¨¡å¼</li>
<li><mark>æ—¶é’Ÿæ‹‰ä¼¸/å»¶å±•</mark>ï¼šå¦‚æœä¸€ä¸ªç›®æ ‡ï¼ˆæ¥æ”¶æ–¹/å‘é€æ–¹ï¼‰å› ä¸ºéœ€è¦æ‰§è¡Œä¸€äº›å…¶ä»–çš„æ“ä½œï¼ˆä¾‹å¦‚å¤„ç†å†…éƒ¨ä¸­æ–­ï¼‰æ— æ³•æ¥æ”¶/ä¼ è¾“æ•°æ®çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œå®ƒå¯ä»¥é€šè¿‡æ‹‰ä½SCLæ¥å¼ºåˆ¶æ§åˆ¶å™¨ï¼ˆä¸»è®¾å¤‡ï¼‰è¿›å…¥ç­‰å¾…æ¨¡å¼ï¼ˆ<mark>ä¸»è®¾å¤‡å°è¯•æ‹‰é«˜SCLåéœ€è¦è½®è¯¢ç­‰å¾…SCLçœŸçš„ä¸ºé«˜ç”µå¹³çŠ¶æ€</mark>ï¼‰ï¼Œç›´åˆ°å®ƒå‡†å¤‡å¥½å¤„ç†ä¸‹ä¸ªå­—èŠ‚çš„ä¼ è¾“äº†ã€‚</li>
</ul>
<h3 id="sda-shi-xu-can-shu">SDAæ—¶åºå‚æ•°</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201172812277.png" alt="image-20241201172812277"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201173649085.png" alt="image-20241201173649085"></p>
<ul>
<li>æ•°æ®å»ºç«‹æ—¶é—´ï¼ˆSU;DAT data set-up timeï¼‰ï¼šåœ¨SCLä½ç”µå¹³æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹SDAä¸ºä¸‹ä¸€ä¸ªè¦å‘é€çš„æ¯”ç‰¹ä½ã€‚è¯¥å‚æ•°è¦æ±‚æˆ‘ä»¬ä¿®æ”¹åœ¨SCLä¸ºä½æ—¶ï¼ŒSDAè·³å˜ç¨³å®šåéœ€è¦åç»´æŒä¸€æ®µæ—¶é—´ï¼ˆå†å°†SCLæ‹‰é«˜è®©æ¥æ”¶æ–¹é‡‡æ ·ï¼‰ï¼Œè‡³å°‘ä¸º<mark>250ns</mark></li>
<li>æ•°æ®ä¿æŒæ—¶é—´ï¼ˆHD;DAT data hold timeï¼‰ï¼štHD;DAT is the data hold time that is measured from the falling edge of SCL, applies to data in transmission and the acknowledgeã€‚è¯¥å‚æ•°æ˜¯æŒ‡SDAåœ¨SCLä¸‹é™æ²¿ä¹‹åéœ€è¦ä¿æŒçš„æ—¶é—´ï¼Œè¡¨æ ¼ä¸­çš„ <code>Conditions</code>åˆ—æ ‡è¯†äº†ä¸ªè¯¥å‚æ•°ç”¨äºCBUSå…¼å®¹æ§åˆ¶å™¨ï¼Œå¯¹äºI2Cè®¾å¤‡ä¸åšé™åˆ¶ã€‚<mark>è¿™æ„å‘³ç€ï¼Œåœ¨SCLä¸‹é™æ²¿å‘ç”Ÿåï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³æ“ä½œSDAçš„è·³å˜ã€‚</mark></li>
<li>æ•°æ®æœ‰æ•ˆï¼ˆç¨³å®šï¼‰æ—¶é—´ï¼ˆVD;DATï¼Œdata valid timeï¼‰ï¼štVD;DAT = time for data signal from SCL LOW to SDA outputã€‚è¯¥å‚æ•°æ˜¯æŒ‡<mark>ä»è®¾å¤‡å‘é€æ•°æ®æ—¶</mark>ï¼Œä»SCLä¸‹é™æ²¿åˆ°SDAè·³å˜å¹¶ç¨³å®šä¹‹é—´çš„æ—¶é—´ï¼Œæœ€å¤§å€¼ä¸º<mark>3.45us</mark>ï¼ˆ<mark>è¿™æ„å‘³ç€æˆ‘ä»¬åº”è¯¥å»¶æ—¶3.45usæ¥ç¡®ä¿ä»è®¾å¤‡å»ºç«‹äº†SDAå¹¶è¯»å–æ•°æ®</mark>ï¼‰</li>
</ul>
<h3 id="zong-jie">æ€»ç»“</h3>
<ul>
<li>data hold timeï¼šæˆ‘ä»¬ä¸ç”¨å…³å¿ƒï¼Œåªéœ€è¦éµå¾ªSDAåœ¨SCLé«˜ç”µå¹³å‘¨æœŸä¿æŒä¸å˜å³å¯</li>
<li>data valid timeï¼šæˆ‘ä»¬åªéœ€è¦åœ¨SCLä¸‹é™æ²¿åç«‹å³ä¿®æ”¹SDAä¸ºä¸‹ä¸€ä¸ªå¾…å‘é€bitå³å¯ï¼ˆæ»¡è¶³<code>&lt;3.45us</code>ï¼‰</li>
<li>data set-up timeï¼šç”±äºæˆ‘ä»¬åœ¨SCLæ‹‰ä½å¹¶ä¿®æ”¹SDAåï¼Œéœ€è¦ä¿æŒä¸€ä¸ªSCLä½ç”µå¹³å‘¨æœŸï¼ˆå¦‚å‰æ–‡æ‰€è¿°5usï¼‰ï¼ŒSDAå»ºç«‹æ—¶é—´ä¹Ÿé—´æ¥å˜æˆäº†5usï¼ˆæ»¡è¶³<code>&gt;250ns</code>ï¼‰</li>
</ul>
<h3 id="shi-xu-kong-zhi-1">æ—¶åºæ§åˆ¶</h3>
<p>é«˜ä½ä¼˜å…ˆï¼Œä¾æ¬¡å‘é€æ•°æ®å­—èŠ‚çš„æ¯”ç‰¹ä½ï¼š</p>
<ul>
<li>æ¯æ¬¡å¾ªç¯æ‰€åšçš„æ“ä½œï¼šæ‹‰ä½SCLï¼ˆæ‹‰ä½åæ‰èƒ½ä¿®æ”¹SDAï¼‰ï¼Œä¿®æ”¹SDAï¼Œç­‰å¾…SCLä½ç”µå¹³å‘¨æœŸè¿‡å»ï¼Œæ‹‰é«˜SCLï¼ˆè®©æ¥æ”¶æ–¹é‡‡æ ·ï¼‰ï¼Œç­‰å¾…SCLé«˜ç”µå¹³å‘¨æœŸè¿‡å»ã€‚</li>
<li>æ¯ä¸ªå¾ªç¯äº§ç”Ÿä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆSCLä½ç”µå¹³ã€SCLé«˜ç”µå¹³ï¼‰ï¼Œå› æ­¤è¯¥æ“ä½œäº§ç”Ÿäº†8ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆä»èµ·å§‹ä¿¡å·åå¼€å§‹è®¡ç®—ï¼‰ã€‚</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="du-qu-ack-9-sub-th-sub-clock-cycle">è¯»å–ACKï¼ˆ9<sub>th</sub> Clock Cycleï¼‰</h2>
<h3 id="sheng-cheng-di-jiu-ge-shi-zhong-zhou-qi-bing-du-qu-sda">ç”Ÿæˆç¬¬ä¹ä¸ªæ—¶é’Ÿå‘¨æœŸå¹¶è¯»å–SDA</h3>
<p>ä¹‹å‰æ˜¯æ¥æ”¶æ–¹è¯»å–SDAï¼ˆæ¥æ”¶æ•°æ®ï¼‰ï¼Œç°åœ¨è½®åˆ°å‘é€æ–¹è¯»å–SDAï¼ˆæ¥æ”¶å“åº”ï¼‰äº†ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€å…³å¿ƒSDAçš„æ—¶åºæ§åˆ¶äº†ï¼Œæˆ‘ä»¬<mark>æ§åˆ¶SCLäº§ç”Ÿç¬¬ä¹ä¸ªæ—¶é’Ÿå‘¨æœŸ</mark>å³å¯ï¼š</p>
<ul>
<li>æ‹‰ä½SCLï¼ˆå› ä¸ºè¦æ‹‰é«˜SDAé‡Šæ”¾æ€»çº¿ï¼Œæ“ä½œSDAå‰å¿…é¡»æ‹‰ä½SCLï¼‰ï¼Œæ‹‰é«˜SDAï¼ˆé‡Šæ”¾æ€»çº¿ï¼Œäº¤å‡ºæ§åˆ¶æƒï¼‰ï¼Œç»´æŒä¸€ä¸ªSCLä½ç”µå¹³å‘¨æœŸï¼ˆä»è®¾å¤‡å¯ä»¥åœ¨æ­¤æœŸé—´ä¿®æ”¹SDAï¼‰</li>
<li>æ‹‰é«˜SCLï¼ˆå‘ŠçŸ¥ä»è®¾å¤‡ä¸»è®¾å¤‡è¦é‡‡æ ·äº†ï¼Œè®©å®ƒåœ¨SCLé«˜ç”µå¹³æœŸé—´ç»´æŒSDAï¼‰ï¼Œç»´æŒä¸€ä¸ªSCLé«˜ç”µå¹³å‘¨æœŸï¼Œè¯»å–SDAï¼ˆä½ç”µå¹³ä¸ºACKï¼Œé«˜ç”µå¹³ä¸ºNACKï¼‰</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">SCL_LOW<span class="token punctuation">;</span>
SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
I2C_DELAY<span class="token punctuation">;</span>

SCL_HIGH<span class="token punctuation">;</span>
I2C_DELAY<span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="shou-hui-sda-kong-zhi-quan">æ”¶å›SDAæ§åˆ¶æƒ</h3>
<blockquote>
<p>[!NOTE]</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸ä¹‹å‰å‘é€å­—èŠ‚æ—¶ä¸åŒï¼ˆSDAæ§åˆ¶æƒåœ¨ä¸»è®¾å¤‡ï¼‰ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬è¯»å–SDAåï¼Œä»è®¾å¤‡ä»ç„¶å¤„äºä¿æŒSDAçš„çŠ¶æ€ï¼ˆå› ä¸ºåªè¦SCLé«˜ç”µå¹³ï¼Œä»è®¾å¤‡å°±è®¤ä¸ºä¸»è®¾å¤‡é‡‡æ ·æ²¡æœ‰ç»“æŸï¼‰ï¼Œå› æ­¤ä¸ºäº†ç¡®ä¿åç»­çš„æ“ä½œèƒ½å¤Ÿæ­£ç¡®æ§åˆ¶SDAï¼Œä¸»è®¾å¤‡åº”è¯¥åœ¨è¯»å–ACKåæ‹‰ä½SCLï¼ˆä»è®¾å¤‡é‡Šæ”¾SDAï¼ŒSDAæ¢å¤é«˜ç”µå¹³ï¼‰æ”¶å›SDAæ§åˆ¶æƒ</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ting-zhi-xin-hao">åœæ­¢ä¿¡å·</h2>
<blockquote>
<p>A LOW to HIGH transition on the SDA line while SCL is HIGH defines a STOP condition</p>
</blockquote>
<p><mark>åœæ­¢ä¿¡å·çš„å®šä¹‰ï¼šåœ¨SCLé«˜ç”µå¹³æ—¶ï¼ŒSDAç”±ä½åˆ°é«˜çš„è·³å˜ã€‚</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201181729885.png" alt="image-20241201181729885"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201181710622.png" alt="image-20241201181710622" style="zoom:33%;">
<p>å¦‚å›¾ï¼Œåœæ­¢ä¿¡å·çš„æ—¶åºå‚æ•°æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>å»ºç«‹æ—¶é—´ï¼šéœ€è¦åœ¨SCLé«˜ç”µå¹³æ—¶ï¼Œå°†SDAå‡†å¤‡ä¸ºä½ç”µå¹³çŠ¶æ€ï¼Œå¹¶ä¿æŒè‡³å°‘4us</li>
<li>æ€»çº¿é‡Šæ”¾æ—¶é—´ï¼šåœ¨ä¸¤æ¬¡è¿ç»­çš„ä¼ è¾“ä¹‹é—´ï¼Œå‰ä¸€ä¸ªçš„åœæ­¢ä¿¡å·å’Œåä¸€ä¸ªçš„èµ·å§‹ä¿¡å·ä¹‹é—´çš„é—´éš”è‡³å°‘ä¸º4.7usï¼ˆSCLå’ŒSDAä¿æŒä¸ºé«˜ç”µå¹³çš„æ—¶é—´ï¼‰</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>ç”±äºæ­¤å‰å®ç°çš„ <code>I2C_Start</code>ä¸­å·²ç»å¼ºåˆ¶åŠ å…¥äº†èµ·å§‹ä¿¡å·å»ºç«‹æ—¶é—´ï¼ˆSU;STAï¼ŒSCLä¸ºé«˜æ—¶å°†SDAæ‹‰é«˜å¹¶ä¿æŒï¼‰5usï¼Œå› æ­¤è¿™é‡Œçš„t<sub>BUF</sub>å¯ä»¥çœç•¥</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201191223209.png" alt="image-20241201191223209"></p>
<h3 id="shi-xu-kong-zhi-2">æ—¶åºæ§åˆ¶</h3>
<ul>
<li>æ‹‰ä½SCLï¼ˆä¿®æ”¹SDAå‰éœ€æ‹‰ä½SCLï¼‰ï¼Œå°†SDAå‡†å¤‡ä¸ºä½ç”µå¹³ï¼Œç»´æŒä¸€ä¸ªSCLä½ç”µå¹³å‘¨æœŸ</li>
<li>æ‹‰é«˜SDA</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="xie-eeprom-ce-shi">å†™EEPROMæµ‹è¯•</h2>
<ul>
<li>å†™æ¨¡å¼å‘é€è®¾å¤‡åœ°å€ <code>0xA0</code></li>
<li>è®¾ç½®è¯»å†™åœ°å€å¯„å­˜å™¨ä¸º <code>0x00</code>ï¼ˆç±»æ¯”ç£ç›˜è®¾ç½®ç£å¤´ï¼‰</li>
<li>å‘ <code>0x00</code>åœ°å€å†™å…¥æ•°æ® <code>â€˜aâ€™</code></li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201191555496.png" alt="image-20241201191555496"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">STANDARD_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIOæ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. é…ç½®GPIOå·¥ä½œæ¨¡å¼ä¸ºé€šç”¨å¼€æ¼è¾“å‡º mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. æ€»çº¿ç©ºé—²çŠ¶æ€æ—¶ï¼Œé»˜è®¤é«˜ç”µå¹³</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDAæ‹‰é«˜ï¼Œå¹¶ç»´æŒstartå»ºç«‹æ—¶é—´ï¼ˆfor repeated start and bus free timeï¼‰</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDAæ‹‰ä½ï¼Œå¹¶ç»´æŒstartä¿æŒæ—¶é—´</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="jie-shou-shu-ju">æ¥æ”¶æ•°æ®</h2>
<ul>
<li>æ¥æ”¶æ•°æ®æ—¶ï¼Œä¸»è®¾å¤‡åªéœ€æ§åˆ¶SCLäº§ç”Ÿ8ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒSDAæ§åˆ¶æƒäº¤ç»™ä»è®¾å¤‡</li>
<li>ä½ç”µå¹³å‘¨æœŸï¼Œä»è®¾å¤‡ä¼šå»ºç«‹ï¼ˆå‡†å¤‡ï¼‰SDAï¼ˆ<mark>å‰ææ˜¯ä¸»è®¾å¤‡å¯¹SDAæ€»çº¿æ˜¯é‡Šæ”¾çŠ¶æ€</mark>ï¼‰ï¼Œå¹¶åœ¨é«˜ç”µå¹³å‘¨æœŸä¿æŒç¨³å®šï¼ˆä¸»è®¾å¤‡å¯ä»¥åœ¨æ­¤æœŸé—´è¯»å–SDAï¼‰</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾SDAæ€»çº¿</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-ack-nack-9-sub-th-sub-clock-cycle">å‘é€ACK/NACKï¼ˆ9<sub>th</sub> Clock Cycleï¼‰</h2>
<p>åœ¨ç¬¬ä¹ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œä¸»è®¾å¤‡éœ€è¦ç»™ä»è®¾å¤‡å“åº”ACK/NACKï¼ŒACKè¡¨ç¤ºéœ€è¦ä»è®¾å¤‡ç»§ç»­å‘é€æ•°æ®ï¼ŒNACKåˆ™æŒ‡ç¤ºä»è®¾å¤‡åœæ­¢å‘é€æ•°æ®ï¼ˆä¸»è®¾å¤‡éšåå‘é€åœæ­¢ä¿¡å·ç»“æŸæ­¤æ¬¡ä¼ è¾“ï¼‰ï¼š</p>
<ol>
<li>æ‹‰ä½SCLï¼ˆå› ä¸ºé©¬ä¸Šè¦ä¿®æ”¹SDAï¼‰ï¼Œæ ¹æ®å“åº”ACKè¿˜æ˜¯NACKæ¥æ‹‰ä½/æ‹‰é«˜SDAï¼Œç»´æŒä¸€ä¸ªSCLä½ç”µå¹³å‘¨æœŸ</li>
<li>æ‹‰é«˜SCLï¼ˆè®©ä»è®¾å¤‡é‡‡æ ·ï¼‰ï¼Œç»´æŒä¸€ä¸ªSCLé«˜ç”µå¹³å‘¨æœŸï¼ˆè®©ä»è®¾å¤‡é‡‡æ ·ï¼‰</li>
<li><mark>ç‰¹åˆ«æ³¨æ„</mark>ï¼šå¦‚æœæ˜¯å‘é€ACKï¼Œè¿˜éœ€è¦å°†SDAæ‹‰é«˜ï¼ˆå½“ç„¶åˆ«å¿˜äº†ä¿®æ”¹SDAå‰å…ˆæ‹‰ä½SCLï¼‰ï¼Œä»¥é‡Šæ”¾SDAæ€»çº¿ï¼Œå¦åˆ™</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="du-eeprom-ce-shi">è¯»EEPROMæµ‹è¯•</h2>
<ol>
<li>å‡å†™ï¼ˆdummy writeï¼‰
<ol>
<li>å†™æ¨¡å¼å‘é€è®¾å¤‡åœ°å€ <code>0xA0</code></li>
<li>è®¾ç½®è¯»å†™åœ°å€å¯„å­˜å™¨ä¸º <code>0x00</code></li>
</ol>
</li>
<li>çœŸè¯»
<ol>
<li>è¯»æ¨¡å¼å‘é€è®¾å¤‡åœ°å€ <code>0xA1</code></li>
<li>æ¥æ”¶ä¸€ä¸ªæ•°æ®å­—èŠ‚</li>
<li>å“åº”NACK</li>
</ol>
</li>
</ol>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201195027305.png" alt="image-20241201195027305"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">STANDARD_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIOæ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. é…ç½®GPIOå·¥ä½œæ¨¡å¼ä¸ºé€šç”¨å¼€æ¼è¾“å‡º mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. æ€»çº¿ç©ºé—²çŠ¶æ€æ—¶ï¼Œé»˜è®¤é«˜ç”µå¹³</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDAæ‹‰é«˜ï¼Œå¹¶ç»´æŒstartå»ºç«‹æ—¶é—´ï¼ˆfor repeated start and bus free timeï¼‰</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDAæ‹‰ä½ï¼Œå¹¶ç»´æŒstartä¿æŒæ—¶é—´</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zong-jie-1">æ€»ç»“ğŸŒŸ</h2>
<h3 id="fan-shi">èŒƒå¼</h3>
<blockquote>
<p>[!IMPORTANT]</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œåœ¨I2Cé€šä¿¡è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®ä¸åŒé˜¶æ®µçŠ¶æ€ï¼ˆæ¥æ”¶æ•°æ®ã€å‘é€æ•°æ®ï¼‰ï¼Œè¦ä¸¥æ ¼éµå¾ªç›¸åº”çš„SCL/SDAæ—¶åºï¼š</p>
<ul>
<li>å‘é€æ•°æ®æ—¶ï¼ˆå­—èŠ‚æ¯”ç‰¹ä½æˆ–ACKï¼‰ï¼šå…ˆæ‹‰ä½SCLï¼Œå»ºç«‹SDAï¼Œå¹¶ç»´æŒSDAå»ºç«‹æ—¶é—´ï¼Œç„¶åæ‹‰é«˜SCLè®©æ¥æ”¶æ–¹é‡‡æ ·ã€‚</li>
<li>æ¥æ”¶æ•°æ®æ—¶ï¼ˆå­—èŠ‚æ¯”ç‰¹ä½æˆ–ACKï¼‰ï¼šå…ˆæ‹‰ä½SCLï¼Œä¸»è®¾å¤‡é‡Šæ”¾SDAï¼Œè€Œåä»è®¾å¤‡åº”è¯¥åœ¨t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>æ—¶é—´å†…å»ºç«‹SDAï¼ˆå­—èŠ‚æ¯”ç‰¹ä½æˆ–ACKï¼‰ï¼Œç„¶åä¸»è®¾å¤‡å»¶æ—¶è‡³å°‘t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>åæ‹‰é«˜SCLè¯»å–SDA</li>
</ul>
</blockquote>
<h3 id="xing-neng-ce-shi">æ€§èƒ½æµ‹è¯•</h3>
<p>æ ‡å‡†æ¨¡å¼</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202111727091.png" alt="æ ‡å‡†æ¨¡å¼"></p>
<p>å¿«é€Ÿæ¨¡å¼</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202111845187.png" alt="image-20241202111845187"></p>
<h2 id="tuo-zhan-shang-sheng-xia-jiang-shi-jian">æ‹“å±•ï¼šä¸Šå‡/ä¸‹é™æ—¶é—´</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201195756988.png" alt="image-20241201195756988" style="zoom: 33%;">
<p>è¯¥å‚æ•°æè¿°çš„æ˜¯å¼•è„šé«˜ä½ç”µå¹³è·³å˜ï¼ˆæˆ–è€…è¯´è½¬å˜/è¿‡åº¦ï¼Œtransitionï¼‰æ—¶é—´ï¼Œéœ€è¦æŸ¥çœ‹MCUæ•°æ®æ‰‹å†Œä¸­å…³äºIOå£ç”µæ°”ç‰¹æ€§ç›¸å…³çš„æè¿°ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201200403108.png" alt="STM32F103æ•°æ®æ‰‹å†Œ"></p>
<p>å›çœ‹å‰æ–‡GPIOåˆå§‹åŒ–ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);
GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF10_1 | GPIO_CRH_CNF11_1);
GPIOB-&gt;CRH |= (GPIO_CRH_CNF10_0 | GPIO_CRH_CNF11_0);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201200530058.png" alt="image-20241201200530058"></p>
<p>æˆ‘ä»¬é…ç½®çš„çš„æ˜¯æœ€å¤§è¾“å‡ºæ¨¡å¼ï¼Œå› æ­¤æ»¡è¶³I2Cçš„æ¡ä»¶</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201195656068.png" alt="image-20241201195656068"></p>
<h2 id="wan-zheng-dai-ma">å®Œæ•´ä»£ç </h2>
<h3 id="i-2-c-soft-h">i2c_soft.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="i-2-c-soft-c">i2c_soft.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STANDARD_MODE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAST_MODE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_MODE</span> <span class="token expression">FAST_MODE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> STANDARD_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>I2C_MODE <span class="token operator">==</span> FAST_MODE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIOæ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. é…ç½®GPIOå·¥ä½œæ¨¡å¼ä¸ºé€šç”¨å¼€æ¼è¾“å‡º mode=11 cnf=01</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. æ€»çº¿ç©ºé—²çŠ¶æ€æ—¶ï¼Œé»˜è®¤é«˜ç”µå¹³</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. SCL, SDAæ‹‰é«˜ï¼Œå¹¶ç»´æŒstartå»ºç«‹æ—¶é—´ï¼ˆfor repeated start and bus free timeï¼‰</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDAæ‹‰ä½ï¼Œå¹¶ç»´æŒstartä¿æŒæ—¶é—´</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    I2C_DELAY<span class="token punctuation">;</span>

    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_5us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">i2c_delay_2us</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="eerom-mc-24-c-02">EEROM(MC24C02)</h1>
<h2 id="te-xing">ç‰¹æ€§</h2>
<ul>
<li>æ”¯æŒI2Cæ ‡å‡†æ¨¡å¼å’Œå¿«é€Ÿæ¨¡å¼</li>
<li>MC24C01å®¹é‡128å­—èŠ‚ï¼ŒC02å®¹é‡256å­—èŠ‚</li>
<li>æ¯16ä¸ªå­—èŠ‚ç»„ç»‡æˆä¸€ä¸ªé¡µï¼Œå¯ä»¥æ¨æ–­ï¼š
<ul>
<li>æœ‰16ä¸ªé¡µ</li>
<li>ä¸€ä¸ªå­—èŠ‚å¯ä»¥æ»¡è¶³å¯»å€ï¼ˆ0x0~0xFFï¼Œå…±256ä¸ªåœ°å€ï¼‰ï¼Œé«˜å››ä½ç”¨äºé¡µå¯»å€ï¼Œç¬¬å››ä½ç”¨äºé¡µå†…å­—èŠ‚å¯»å€</li>
</ul>
</li>
<li>å†™å‘¨æœŸ
<ul>
<li>å•å­—èŠ‚å†™æ“ä½œã€é¡µå†…è¿ç»­å†™æ“ä½œï¼Œæœ€å¤§å†™å‘¨æœŸä¸º5ms</li>
<li>å†™æ“ä½œåï¼ˆå•æ¬¡I2Cä¼ è¾“åï¼‰çš„5mså†…ï¼Œä¸åº”è¯¥å†å¼€å¯I2Cä¼ è¾“ï¼ˆèŠ¯ç‰‡å†…éƒ¨éœ€è¦æ—¶é—´æŒä¹…åŒ–æ•°æ®ï¼‰</li>
</ul>
</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130155340046.png" alt="image-20241130155340046"></p>
<h2 id="nei-cun-jie-gou">å†…å­˜ç»“æ„</h2>
<ul>
<li>WCï¼Œwrite controlï¼Œå†™ä½¿èƒ½</li>
<li>E2ï¼ŒE1ï¼ŒE0ï¼šè®¾å¤‡åœ°å€ä¸­çš„ä½3ä½</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201201711873.png" alt="image-20241201201711873"></p>
<h2 id="she-bei-xun-zhi">è®¾å¤‡å¯»å€</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130155754947.png" alt="image-20241130155754947"></p>
<h2 id="du-xie-cao-zuo">è¯»/å†™æ“ä½œ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201201953699.png" alt="image-20241201201953699"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201202011850.png" alt="image-20241201202011850"></p>
<h3 id="zhu-yi">æ³¨æ„</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202114206166.png" alt="image-20241202114206166"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241202114116570.png" alt="image-20241202114116570"></p>
<blockquote>
<p>[!NOTE]</p>
<p>è¿ç»­å†™æ—¶ï¼Œé¡µå†…16å­—èŠ‚ç›¸å½“äºä¸€ä¸ªç¯å½¢ç»“æ„ï¼Œå†™åˆ°é¡µå†…æœ€åä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œä¸‹æ¬¡å†™å…¥å°†ä»é¡µå¤´é‡æ–°å¼€å§‹ã€‚</p>
<p>è€Œè¿ç»­è¯»æ—¶ï¼Œåˆ™æ˜¯å°†æ•´ä¸ª256å­—èŠ‚ä½œä¸ºä¸€ä¸ªç¯å½¢ç»“æ„ï¼Œè¯»åˆ°0xFFæ—¶ï¼Œä¸‹æ¬¡è¯»å°†ä»0x00é‡æ–°å¼€å§‹ã€‚</p>
</blockquote>
<h2 id="mo-kuai-feng-zhuang">æ¨¡å—å°è£…</h2>
<h3 id="m-24-c-02-h">m24c02.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_soft.h"</span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __M24C02_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="m-24-c-02-c">m24c02.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_W</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_R</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait for write cycle</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>DEV_ADDR_R<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_WaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_SendNAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_SendAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"b1 = %d, b2 = %d, b3 = %d"</span><span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">)</span>
    
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"56789"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"1234567890abcdefghijk"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="yi-liu-wen-ti">é—ç•™é—®é¢˜</h1>
<h2 id="di-ta-ding-shi-qi-yan-shi-chao-chang-wen-ti">å˜€å—’å®šæ—¶å™¨å»¶æ—¶è¶…é•¿é—®é¢˜</h2>
<blockquote>
<p>[!IMPORTANT]</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå»ºè®®ä½¿ç”¨ç®€å•çš„å¾ªç¯æˆ–å®šæ—¶å™¨ä¸­æ–­æ¥æ¯”è¾ƒç²¾å‡†åœ°å®ç°å»¶æ—¶ï¼Œè€Œä¸è¦ä½¿ç”¨å¤æ‚çš„å»¶æ—¶å‡½æ•°ï¼Œä¾‹å¦‚æˆ‘æœ€åˆä½¿ç”¨å¦‚ä¸‹å˜€å—’å®šæ—¶å™¨æ—¶ï¼Œ<code>SysTick-&gt;CTRL &amp; SysTick_CTRL_ENABLE</code>ä¼šå¯¼è‡´å»¶æ—¶æœ‰æ—¶æ¯”é¢„æœŸè¶…å‡ºå¾ˆå¤šï¼ˆä¾‹å¦‚é¢„æœŸ5usï¼Œä¼šå‡ºç°å¶å°”å»¶æ—¶äº†15usçš„æƒ…å†µï¼‰ï¼Œä½†æ˜¯å»æ‰è¯¥ä»£ç åå°±æ­£å¸¸äº†ï¼ŒåŸå› æš‚æ—¶è¿˜æ²¡æ‰¾åˆ°</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// AHB 72M</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">*</span> us<span class="token punctuation">;</span>
    <span class="token comment">//101: clock source, tick interrupt, enable</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
    <span class="token comment">// wait for count flag</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;</span> SysTick_CTRL_COUNTFLAG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> 
           <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;</span> SysTick_CTRL_ENABLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨ä½¿ç”¨é€»è¾‘åˆ†æä»ªè§‚å¯Ÿä¸Šè¿°ä»£ç å»¶æ—¶äº§ç”Ÿçš„æ—¶é’Ÿè„‰å†²æ—¶ï¼Œæ€»æ˜¯ä¼šå‡ºç°æœ‰è„‰å†²å»¶æ—¶è¶…é•¿çš„æƒ…å†µï¼ˆä¾‹å¦‚15usï¼‰</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201161816608.png" alt="image-20241201161816608" style="zoom:33%;">
<p>å»æ‰ <code>SysTick-&gt;CTRL &amp; SysTick_CTRL_ENABLE</code>ååˆ™å»¶æ—¶æ­£å¸¸äº†ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// AHB 72M</span>
    SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> <span class="token number">72</span> <span class="token operator">*</span> us<span class="token punctuation">;</span>
    <span class="token comment">//101: clock source, tick interrupt, enable</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">|=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
    <span class="token comment">// wait for count flag</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;</span> SysTick_CTRL_COUNTFLAG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>SysTick_CTRL_ENABLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201161925160.png" alt="image-20241201161925160" style="zoom:33%;">
<p>å¹¶ä¸”å‰è€…ç›´æ¥å¯¼è‡´I2Cé€šä¿¡æ— æ³•èµ°é€šï¼ˆåªæœ‰ <code>start</code>ï¼‰ï¼Œè€Œåè€…å¯ä»¥ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201162331212.png" alt="image-20241201162331212"></p>
<h1 id="ruan-i-2-c-cu-yan-shi-ban-ben-can-kao-dai-ma">è½¯I2Cç²—å»¶æ—¶ç‰ˆæœ¬å‚è€ƒä»£ç </h1>
<blockquote>
<p>[!NOTE]</p>
<p>è¯¥ç‰ˆæœ¬ä»£ç åœ¨æ¯ä¸ªSCL/SDAçŠ¶æ€å˜æ›´èŠ‚ç‚¹éƒ½è¿›è¡Œè¶³å¤Ÿé•¿çš„å»¶æ—¶æ¥ç¨³å®šä¿¡å·ï¼Œå¹¶å¢åŠ å†—ä½™å»¶æ—¶æ¥ç¡®ä¿æ—¶åºçš„æ­£ç¡®æ€§ï¼Œä¾‹å¦‚æ¯ä¸ªèŠ‚ç‚¹éƒ½å»¶æ—¶10usã€å†—ä½™æ‹‰ä½SCLç­‰ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ä¸ç”¨ç²¾ç»†åˆ†æ/æŠŠæ§I2Cè§„èŒƒä¸­å„ä¸ªé˜¶æ®µå¯¹SCL/SDAçš„æ—¶åºé™åˆ¶ï¼ˆä¾‹å¦‚å»ºç«‹æ—¶é—´æœ€å°‘ä¸ºxxxï¼Œç»´æŒæ—¶é—´è‡³å°‘ä¸ºxxxï¼Œç­‰ç­‰ï¼‰ï¼Œå¤§å¤§ç®€åŒ–äº†å¼€å‘æµç¨‹ï¼Œä½†ä¼šæ¶ˆè€—ä¸€å®šæ€§èƒ½ã€‚</p>
<p>ç”±äºI2Cæœ¬èº«å°±æ˜¯ä¸€ç§ä½é€Ÿé€šä¿¡åè®®ï¼Œåè®®æœ¬èº«è§„èŒƒäº†ä¼ è¾“é€Ÿåº¦ç“¶é¢ˆï¼ˆä¾‹å¦‚æ ‡å‡†æ¨¡å¼100kHzï¼‰ï¼Œå³ä½¿æ›´ç²¾ç»†ä¸€ç‚¹æ§åˆ¶å»¶æ—¶ï¼Œä¹Ÿåªèƒ½å¸¦æ¥å¸¸æ•°çº§åˆ«çš„æ€§èƒ½æå‡ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯æœ‰ç‰¹å®šçš„éœ€æ±‚ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘ç²—å»¶æ—¶ç‰ˆæœ¬çš„å®ç°ï¼ˆå¼€å‘æµç¨‹ç®€å•ï¼ŒåŠŸèƒ½æ›´åŠ ç¨³å®šï¼Œå®¹æ˜“æ’æŸ¥é”™è¯¯ï¼‰ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ç²¾å‡†å»¶æ—¶å’Œç²—å»¶æ—¶çš„æ€§èƒ½å¯¹æ¯”</p>
</blockquote>
<h2 id="biao-zhun-mo-shi-jing-zhun-yan-shi">æ ‡å‡†æ¨¡å¼-ç²¾å‡†å»¶æ—¶</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201224438177.png" alt="image-20241201224438177"></p>
<h2 id="biao-zhun-mo-shi-cu-yan-shi">æ ‡å‡†æ¨¡å¼-ç²—å»¶æ—¶</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241201224556682.png" alt="image-20241201224556682"></p>
<h2 id="i-2-c-h">i2c.h</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__I2C_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__I2C_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">// å®å®šä¹‰</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ACK</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NACK</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token comment">// æ§åˆ¶SCLã€SDAçš„è¾“å‡ºé«˜ä½ç”µå¹³</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR10<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR11<span class="token punctuation">)</span></span></span>

<span class="token comment">// è¯»å–æ“ä½œ</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token punctuation">(</span>GPIOB<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR11<span class="token punctuation">)</span></span></span>

<span class="token comment">// å®šä¹‰æ“ä½œçš„åŸºæœ¬å»¶è¿Ÿ</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// åˆå§‹åŒ–</span>
<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å‘å‡ºèµ·å§‹ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å‘å‡ºåœæ­¢ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸»æœºå‘å‡ºåº”ç­”ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸»æœºå‘å‡ºéåº”ç­”ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸»æœºç­‰å¾…ä»è®¾å¤‡å‘æ¥åº”ç­”ä¿¡å·</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸»æœºå‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆå†™å…¥ï¼‰</span>
<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸»æœºä»EEPROMæ¥æ”¶ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆè¯»å–ï¼‰</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="i-2-c-c">i2c.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c.h"</span></span>

<span class="token comment">// åˆå§‹åŒ–</span>
<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. é…ç½®æ—¶é’Ÿ</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>

    <span class="token comment">// 2. GPIOå·¥ä½œæ¨¡å¼é…ç½®ï¼šé€šç”¨å¼€æ¼è¾“å‡º CNF-01ï¼ŒMODE-11</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_MODE11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GPIO_CRH_CNF10_1 <span class="token operator">|</span> GPIO_CRH_CNF11_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_CNF10_0 <span class="token operator">|</span> GPIO_CRH_CNF11_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å‘å‡ºèµ·å§‹ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCLæ‹‰é«˜ï¼ŒSDAæ‹‰é«˜</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCLä¿æŒä¸å˜ï¼ŒSDAæ‹‰ä½</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å‘å‡ºåœæ­¢ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCLæ‹‰é«˜ï¼ŒSDAæ‹‰ä½</span>
    SCL_HIGH<span class="token punctuation">;</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCLä¿æŒä¸å˜ï¼ŒSDAæ‹‰é«˜</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸»æœºå‘å‡ºåº”ç­”ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCLæ‹‰ä½ï¼ŒSDAæ‹‰é«˜ï¼Œå‡†å¤‡å‘å‡ºä¿¡å·</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCLä¿æŒä¸å˜ï¼ŒSDAæ‹‰ä½ï¼Œè¾“å‡ºåº”ç­”</span>
    SDA_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 3. SDAä¿æŒä¸å˜ï¼ŒSCLæ‹‰é«˜ï¼Œå¼€å§‹æ•°æ®çº¿ä¸Šä¿¡å·é‡‡æ ·</span>
    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 4. SDAä¿æŒä¸å˜ï¼ŒSCLæ‹‰ä½ï¼Œç»“æŸæ•°æ®çº¿ä¸Šä¿¡å·é‡‡æ ·</span>
    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 5. SDAæ‹‰é«˜ï¼Œé‡Šæ”¾æ•°æ®æ€»çº¿</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸»æœºå‘å‡ºéåº”ç­”ä¿¡å·</span>
<span class="token keyword">void</span> <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCLæ‹‰ä½ï¼ŒSDAæ‹‰é«˜ï¼Œå‡†å¤‡å‘å‡ºä¿¡å·</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SDAä¿æŒä¸å˜ï¼ŒSCLæ‹‰é«˜ï¼Œå¼€å§‹æ•°æ®çº¿ä¸Šä¿¡å·é‡‡æ ·</span>
    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 3. SDAä¿æŒä¸å˜ï¼ŒSCLæ‹‰ä½ï¼Œç»“æŸæ•°æ®çº¿ä¸Šä¿¡å·é‡‡æ ·</span>
    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸»æœºç­‰å¾…ä»è®¾å¤‡å‘æ¥åº”ç­”ä¿¡å·</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. SCLæ‹‰ä½ï¼ŒSDAæ‹‰é«˜ï¼Œé‡Šæ”¾æ•°æ®æ€»çº¿</span>
    SCL_LOW<span class="token punctuation">;</span>
    SDA_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 2. SCLæ‹‰é«˜ï¼Œå¼€å§‹æ•°æ®é‡‡æ ·</span>
    SCL_HIGH<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token comment">// 3. è¯»å–SDAæ•°æ®çº¿ä¸Šçš„ç”µå¹³</span>
    <span class="token class-name">uint16_t</span> ack <span class="token operator">=</span> READ_SDA<span class="token punctuation">;</span>

    <span class="token comment">// 4. SCLæ‹‰ä½ï¼Œç»“æŸæ•°æ®é‡‡æ ·</span>
    SCL_LOW<span class="token punctuation">;</span>
    I2C_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack <span class="token operator">?</span> NACK <span class="token operator">:</span> ACK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸»æœºå‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆå†™å…¥ï¼‰</span>
<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. SCLã€SDAéƒ½æ‹‰ä½ï¼Œç­‰å¾…æ•°æ®ç¿»è½¬</span>
        SCL_LOW<span class="token punctuation">;</span>
        SDA_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 2. å–å­—èŠ‚çš„æœ€é«˜ä½ï¼Œå‘SDAå†™å…¥æ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            SDA_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            SDA_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 3. SCLæ‹‰é«˜ï¼Œæ•°æ®é‡‡æ ·</span>
        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 4. SCLæ‹‰ä½ï¼Œé‡‡æ ·ç»“æŸ</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 5. å·¦ç§»1ä½</span>
        byte <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>

<span class="token comment">// ä¸»æœºä»EEPROMæ¥æ”¶ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆè¯»å–ï¼‰</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨æ¥ä¿å­˜æ¥æ”¶çš„æ•°æ®</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// å¾ªç¯å¤„ç†æ¯ä¸€ä½</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. SCLæ‹‰ä½ï¼Œç­‰å¾…æ•°æ®ç¿»è½¬</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 2. SCLæ‹‰é«˜ï¼Œå¼€å§‹é‡‡æ ·</span>
        SCL_HIGH<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>

        <span class="token comment">// 3. æ•°æ®é‡‡æ ·ï¼Œè¯»å–SDA</span>
        data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// å…ˆåšå·¦ç§»ï¼Œæ–°å­˜å…¥çš„ä½æ°¸è¿œåœ¨æœ€ä½ä½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>   <span class="token comment">// å…ˆå­˜å…¥æœ€ä½ä½ï¼Œç„¶åæ¯æ¬¡éƒ½å·¦ç§»1ä½</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4. SCLæ‹‰ä½ï¼Œç»“æŸé‡‡æ ·</span>
        SCL_LOW<span class="token punctuation">;</span>
        I2C_DELAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="m-24-c-02-h-1">m24c02.h</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c.h"</span></span>

<span class="token comment">// å®å®šä¹‰</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W_ADDR</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">R_ADDR</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token comment">// åˆå§‹åŒ–</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å‘EEPROMå†™å…¥ä¸€ä¸ªå­—èŠ‚</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¯»å–EEPROMçš„ä¸€ä¸ªå­—èŠ‚</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿ç»­å†™å…¥å¤šä¸ªå­—èŠ‚ï¼ˆé¡µå†™ï¼‰</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿ç»­è¯»å–å¤šä¸ªå­—èŠ‚</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="m-24-c-02-c-1">m24c02.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * @Author: wushengran
 * @Date: 2024-05-31 11:48:48
 * @Description:
 *
 * Copyright (c) 2024 by atguigu, All Rights Reserved.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>

<span class="token comment">// åˆå§‹åŒ–</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å‘EEPROMå†™å…¥ä¸€ä¸ªå­—èŠ‚</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. å‘å‡ºå¼€å§‹ä¿¡å·</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. å‘é€å†™åœ°å€</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. ç­‰å¾…EEPROMåº”ç­”</span>
    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ack <span class="token operator">==</span> ACK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 4. å‘é€å†…éƒ¨åœ°å€</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. ç­‰å¾…åº”ç­”</span>
        <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. å‘é€å…·ä½“æ•°æ®</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7. ç­‰å¾…åº”ç­”</span>
        <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 8. å‘å‡ºä¸€ä¸ªåœæ­¢ä¿¡å·</span>
        <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å»¶è¿Ÿç­‰å¾…å†™å…¥å‘¨æœŸç»“æŸ</span>
    <span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¯»å–EEPROMçš„ä¸€ä¸ªå­—èŠ‚</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. å‘å‡ºå¼€å§‹ä¿¡å·</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. å‘é€å†™åœ°å€ï¼ˆå‡å†™ï¼‰</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. ç­‰å¾…EEPROMåº”ç­”</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. å‘é€å†…éƒ¨åœ°å€</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. ç­‰å¾…åº”ç­”</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. å‘å‡ºå¼€å§‹ä¿¡å·</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7. å‘é€è¯»åœ°å€ï¼ˆçœŸè¯»ï¼‰</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>R_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 8. ç­‰å¾…EEPROMåº”ç­”</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 9. è¯»å–ä¸€ä¸ªå­—èŠ‚</span>
    <span class="token class-name">uint8_t</span> byte <span class="token operator">=</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 10. å‘é€ä¸€ä¸ªéåº”ç­”</span>
    <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 11. å‘å‡ºä¸€ä¸ªåœæ­¢ä¿¡å·</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿ç»­å†™å…¥å¤šä¸ªå­—èŠ‚ï¼ˆé¡µå†™ï¼‰</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. å‘å‡ºå¼€å§‹ä¿¡å·</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. å‘é€å†™åœ°å€</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. ç­‰å¾…EEPROMåº”ç­”</span>
    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ack <span class="token operator">==</span> ACK<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 4. å‘é€å†…éƒ¨åœ°å€</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. ç­‰å¾…åº”ç­”</span>
        <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ©ç”¨å¾ªç¯ä¸åœå‘é€æ•°æ®</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// 6. å‘é€å…·ä½“æ•°æ®</span>
            <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 7. ç­‰å¾…åº”ç­”</span>
            <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 8. å‘å‡ºä¸€ä¸ªåœæ­¢ä¿¡å·</span>
        <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å»¶è¿Ÿç­‰å¾…å†™å…¥å‘¨æœŸç»“æŸ</span>
    <span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿ç»­è¯»å–å¤šä¸ªå­—èŠ‚</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. å‘å‡ºå¼€å§‹ä¿¡å·</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. å‘é€å†™åœ°å€ï¼ˆå‡å†™ï¼‰</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>W_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. ç­‰å¾…EEPROMåº”ç­”</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. å‘é€å†…éƒ¨åœ°å€</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>innerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. ç­‰å¾…åº”ç­”</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. å‘å‡ºå¼€å§‹ä¿¡å·</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7. å‘é€è¯»åœ°å€ï¼ˆçœŸè¯»ï¼‰</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>R_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 8. ç­‰å¾…EEPROMåº”ç­”</span>
    <span class="token function">I2C_Wait4Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆ©ç”¨å¾ªç¯è¿ç»­è¯»å–å¤šä¸ªå­—èŠ‚</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 9. è¯»å–ä¸€ä¸ªå­—èŠ‚</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I2C_ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 10. å‘é€ä¸€ä¸ªåº”ç­”æˆ–éåº”ç­”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">I2C_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">I2C_Nack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 11. å‘å‡ºä¸€ä¸ªåœæ­¢ä¿¡å·</span>
    <span class="token function">I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="main-c">main.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 1. åˆå§‹åŒ–</span>
<span class="token function">USART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. å‘EEPROMä¾æ¬¡å†™å…¥å•ä¸ªå­—ç¬¦</span>
<span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. è¯»å–å­—ç¬¦</span>
<span class="token class-name">uint8_t</span> byte1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> byte2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> byte3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4. ä¸²å£è¾“å‡ºæ‰“å°</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"byte1 = %c\t byte2 = %c\t byte3 = %c\n"</span><span class="token punctuation">,</span> byte1<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 5. å†™å…¥å¤šä¸ªå­—ç¬¦</span>
<span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 6. è¯»å–å¤šä¸ªå­—ç¬¦</span>
<span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 7. ä¸²å£æ‰“å°</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 8. æµ‹è¯•è¶…å‡º16ä¸ªå­—èŠ‚çš„å†™å…¥</span>
<span class="token comment">// æ¸…é›¶ç¼“å†²åŒº</span>
<span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"1234567890abcdefghijk"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="shen-ru-li-jie-stm-32-i-2-c-wai-she">æ·±å…¥ç†è§£STM32 IÂ²Cå¤–è®¾</h1>
<h2 id="i-2-c-wai-she-kuang-tu-gai-lan">I2Cå¤–è®¾æ¡†å›¾æ¦‚è§ˆ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203131201258.png" alt="image-20241203131201258"></p>
<h3 id="sda-shu-ju-zong-xian-xiang-guan">SDAæ•°æ®æ€»çº¿ç›¸å…³</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203131730495.png" alt="image-20241203131730495"></p>
<ul>
<li>Data registerï¼šæ•°æ®å¯„å­˜å™¨DRï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»/å†™DRæ¥å®ç°æ¥æ”¶/å‘é€æ•°æ®</li>
<li>Data shift register
<ul>
<li>å‘é€æ¨¡å¼ä¸‹ï¼Œå†™åˆ°DRçš„æ•°æ®ï¼Œæœ€ç»ˆä¼šé€šè¿‡åº•å±‚ç¡¬ä»¶ç”µè·¯ç§»ä½å¯„å­˜å™¨æ¥é€ä½å‘é€ï¼ˆI2Cåè®®è§„å®šMSBï¼Œå³é«˜ä½ä¼˜å…ˆï¼‰</li>
<li>æ¥æ”¶æ¨¡å¼ä¸‹ï¼Œä»SDAæ¥æ”¶åˆ°çš„é€»è¾‘é«˜ä½ç”µå¹³ä¼šé€ä½è¿›å…¥ç§»ä½å¯„å­˜å™¨ä¿å­˜ï¼Œå¹¶æœ€ç»ˆé€’äº¤ç»™DR</li>
<li>å¦‚æœDRã€ç§»ä½å¯„å­˜å™¨éƒ½ä¸ºç©ºï¼Œé‚£ä¹ˆå†™DRä¼šç›´æ¥é€’äº¤ç»™ç§»ä½å¯„å­˜å™¨</li>
</ul>
</li>
<li>Comparatorï¼šåœ¨ä»è®¾å¤‡æ¨¡å¼ä¸‹ï¼ˆå½“å‰MCUä½œä¸ºä»è®¾å¤‡ï¼‰ï¼Œç”¨äºå°†æ¥æ”¶åˆ°çš„æ•°æ®å’Œè‡ªå·±çš„è®¾å¤‡åœ°å€æ¯”è¾ƒï¼Œå¦‚æœåŒ¹é…ï¼Œé‚£ä¹ˆéœ€è¦å‘ä¸»è®¾å¤‡å›å¤ACK
<ul>
<li>Own address registerï¼šI2Cé€šä¿¡ä¸­è‡ªå·±çš„è®¾å¤‡åœ°å€</li>
<li>Dual address registerï¼šè¯¥å¯„å­˜å™¨æ”¯æŒé…ç½®ç¬¬äºŒä¸ªè®¾å¤‡åœ°å€</li>
</ul>
</li>
<li>PECï¼šPacket Error Checkï¼Œå¸§é”™è¯¯æ£€æŸ¥ç›¸å…³
<ul>
<li>STM32å†…ç½®äº†æ•°æ®å¸§æ ¡éªŒæœºåˆ¶æ¥æå‡é€šä¿¡çš„å¯é æ€§</li>
</ul>
</li>
</ul>
<h3 id="scl-shi-zhong-zong-xian-xiang-guan">SCLæ—¶é’Ÿæ€»çº¿ç›¸å…³</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203133135507.png" alt="image-20241203133135507"></p>
<ul>
<li>
<p>CCRï¼šæ—¶é’Ÿæ§åˆ¶å¯„å­˜å™¨ï¼Œç”¨äºé…ç½®SCLçš„é¢‘ç‡ä»¥éµå¾ªI2Cåè®®æ ‡å‡†</p>
</li>
<li>
<p>CR1&amp;CR2ï¼šå¤–è®¾æ§åˆ¶å¯„å­˜å™¨ï¼Œç”¨äºæ§åˆ¶å¤–è®¾å‘å‡ºI2Cé€šä¿¡å„ä¸ªé˜¶æ®µå¯¹åº”çš„ä¿¡å·ï¼Œä¾‹å¦‚èµ·å§‹ä¿¡å·ã€åœæ­¢ä¿¡å·ã€å“åº”ACKç­‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203133634503.png" alt="image-20241203133634503"></p>
</li>
<li>
<p>SR1&amp;SR2ï¼šå¤–è®¾çŠ¶æ€å¯„å­˜å™¨ï¼Œå¤–è®¾ç¡¬ä»¶åœ¨å®ŒæˆæŸä¸ªI2Cé€šä¿¡èŠ‚ç‚¹æ—¶ä¼šç½®ä½ç›¸åº”çš„æ ‡å¿—ä½ï¼Œè½¯ä»¶å¯ä»¥é€šè¿‡è½®è¯¢è¿™äº›æ ‡å¿—ä½çš„çŠ¶æ€æ¥æ§åˆ¶é€šä¿¡è¿‡ç¨‹ã€‚ä¾‹å¦‚SBï¼ˆStart Bitï¼‰ç½®1è¡¨ç¤ºèµ·å§‹ä¿¡å·å·²å‘é€ï¼ŒADDRç½®1è¡¨ç¤ºå‘é€äº†ä»è®¾å¤‡åœ°å€å¹¶æ”¶åˆ°äº†ä»è®¾å¤‡çš„ACKå“åº”ç­‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203133750393.png" alt="image-20241203133750393"></p>
</li>
</ul>
<h2 id="i-2-c-wai-she-chu-shi-hua">I2Cå¤–è®¾åˆå§‹åŒ–</h2>
<p>ä¸‹é¢æˆ‘ä»¬å°±ä»¥å½“å‰MCUçš„I2Cå¤–è®¾ä½œä¸ºI2Cä¸»è®¾å¤‡æ¥å®ç°æ”¶å‘æ•°æ®ã€è¯»å†™EEPROMçš„åŠŸèƒ½ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­åˆ†æç›¸å…³å¯„å­˜å™¨çš„ä½œç”¨åŠåº•å±‚åŸç†ã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p><a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></p>
<p>ä¸»è®¾å¤‡æ¨¡å¼é€šä¿¡æµç¨‹å‚è€ƒ 26.3.3 I2C master mode</p>
<p>I2Cå¤–è®¾å¯„å­˜å™¨æè¿°å‚è€ƒ 26.6 I2C registers</p>
</blockquote>
<h3 id="gpio-pei-zhi">GPIOé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203140210631.png" alt="image-20241203140210631"></p>
<p>å…³äºå¼•è„šçš„å¤ç”¨åŠŸèƒ½æ˜ å°„å¯ä»¥åœ¨MCUæ•°æ®æ‰‹å†Œçš„å¼•è„šæè¿°ç›¸å…³ç« èŠ‚æ‰¾åˆ°ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203142124640.png" alt="STM32F103ZEæ•°æ®æ‰‹å†Œ"></p>
<p>GPIOé…ç½®ä¸ºå¤–è®¾çš„å¤ç”¨åŠŸèƒ½</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203142343120.png" alt="å‚è€ƒæ‰‹å†Œ GPIO configurations for device peripherals  "></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 1. GPIOæ—¶é’Ÿé…ç½®</span>
RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_I2C2EN<span class="token punctuation">;</span>

<span class="token comment">// 2. é…ç½®GPIOå·¥ä½œæ¨¡å¼ä¸ºå¤ç”¨å¼€æ¼è¾“å‡º mode=11 cnf=11</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span> GPIO_CRH_CNF11<span class="token punctuation">)</span><span class="token punctuation">;</span>
GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_CNF10<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ç‰¹åˆ«æ³¨æ„ï¼Œå¦‚ä¸‹æ“ä½œæ— æ³•å¾—åˆ°é¢„æœŸç»“æœï¼ŒGPIOå·¥ä½œä¸æ­£å¸¸</span>
<span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</span>
<span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</span>
<span class="token comment">// å¦‚ä¸‹åˆ™æ˜¯å¯ä»¥çš„</span>
<span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 | GPIO_CRH_CNF10);</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!IMPORTANT]</p>
<p>è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š</p>
<p>å¦‚ä¸‹é…ç½®ï¼ˆåŒæ—¶é…ç½®PB10/11çš„CNFã€åŒæ—¶é…ç½®PB10/11çš„MODEä¼šå¯¼è‡´GPIOå·¥ä½œä¸æ­£å¸¸ï¼Œæš‚æ—¶è¿˜æœªæ‰¾åˆ°åŸå› ï¼‰</p>
<p>GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</p>
<p>GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</p>
<p>ä½†å¦‚ä¸‹ä¸€æ¬¡æ€§é…ç½®æ˜¯å¯ä»¥çš„</p>
<p>GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 | GPIO_CRH_CNF10);</p>
</blockquote>
<h3 id="zhu-she-bei-mo-shi-suo-xu-pei-zhi">ä¸»è®¾å¤‡æ¨¡å¼æ‰€éœ€é…ç½®</h3>
<blockquote>
<p>In Master mode, the I2C interface initiates a data transfer and generates the clock signal. A serial data transfer always begins with a Start condition and ends with a Stop condition.</p>
<p>Master mode is selected as soon as the Start condition is generated on the bus with a START bit.</p>
</blockquote>
<p>åœ¨ä¸»æ¨¡å¼ä¸‹ï¼Œç”±I2Cå¤–è®¾å‘èµ·æ•°æ®ä¼ è¾“è¯·æ±‚å¹¶æ§åˆ¶SCLç”Ÿæˆæ—¶é’Ÿä¿¡å·ã€‚ä¸€æ¬¡è¿ç»­çš„æ•°æ®ä¼ è¾“æ€»æ˜¯å¼€å§‹äºä¸€ä¸ªèµ·å§‹ä¿¡å·ï¼Œç»ˆæ­¢äºä¸€ä¸ªåœæ­¢ä¿¡å·ã€‚</p>
<p>ä¸€æ—¦é€šè¿‡æ€»çº¿äº§ç”Ÿäº†ä¸€ä¸ªèµ·å§‹ä¿¡å·ï¼Œå½“å‰I2Cå¤–è®¾å°±ä¼šè¿›å…¥ä¸»è®¾å¤‡æ¨¡å¼ã€‚</p>
<blockquote>
<p>The following is the required sequence in master mode.<br>
ï‚· Program the peripheral input clock in I2C_CR2 register in order to generate correct<br>
timings<br>
ï‚· Configure the clock control registers<br>
ï‚· Configure the rise time register<br>
ï‚· Program the I2C_CR1 register to enable the peripheral<br>
ï‚· Set the START bit in the I2C_CR1 register to generate a Start condition</p>
</blockquote>
<p>åœ¨ä½¿ç”¨ä¸»è®¾å¤‡æ¨¡å¼ä¹‹å‰ï¼Œéœ€è¦å…ˆæ“ä½œå¦‚ä¸‹è½¯ä»¶åºåˆ—</p>
<ol>
<li>ä¸ºäº†äº§ç”Ÿæ­£ç¡®çš„æ—¶åºï¼Œéœ€è¦é…ç½®I2C_CR2å¯„å­˜å™¨ä»¥è®¾ç½®å¤–è®¾è¾“å…¥æ—¶é’Ÿ</li>
<li>é…ç½®æ—¶é’Ÿæ§åˆ¶å¯„å­˜å™¨ï¼ˆSCLæ—¶é’Ÿé¢‘ç‡ï¼‰</li>
<li>é…ç½®ä¸Šå‡æ—¶é—´å¯„å­˜å™¨</li>
<li>è®¾ç½®I2C_CR1å¯„å­˜å™¨ä½¿èƒ½å¤–è®¾</li>
<li>è®¾ç½®I2C_CR1å¯„å­˜å™¨ä¸­çš„STARTä½æ¥äº§ç”Ÿèµ·å§‹ä¿¡å·</li>
</ol>
<p>ä¸‹é¢æˆ‘ä»¬æŸ¥é˜…å¯„å­˜å™¨æè¿°ç« èŠ‚æ¥åˆ†æä»¥ä¸Šè¿™å‡ ä¸ªæ“ä½œæ‰€è•´å«çš„ç»†èŠ‚ã€‚</p>
<h4 id="wai-she-shu-ru-shi-zhong-i-2-c-cr-2">å¤–è®¾è¾“å…¥æ—¶é’Ÿï¼ˆI2C_CR2ï¼‰</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203150802143.png" alt="image-20241203150802143"></p>
<blockquote>
<p>The FREQ bits must be configured with the APB clock frequency value (I2C peripheral connected to APB). The FREQ field is used by the peripheral to generate data setup and hold times compliant with the I2C specifications. The minimum allowed frequency is 2 MHz, the maximum frequency is limited by the maximum APB frequency and cannot exceed 50 MHz (peripheral intrinsic maximum limit).</p>
</blockquote>
<p><code>FREQ</code>æ¯”ç‰¹ä½ç”¨æ¥é…ç½®I2Cå¤–è®¾çš„è¾“å…¥æ—¶é’Ÿé¢‘ç‡ï¼Œä¸”å¿…é¡»å‚è€ƒAPBæ—¶é’Ÿé¢‘ç‡æ¥é…ç½®ï¼ˆå› ä¸ºI2Cå¤–è®¾æŒ‚è½½åœ¨APBæ€»çº¿ä¸Šï¼‰ã€‚åœ¨STM32F103ä¸­ï¼ŒI2CæŒ‚è½½åœ¨APB1æ€»çº¿ä¸Šï¼ŒAPB1æœ€å¤§é¢‘ç‡ä¸º<mark>36MHz</mark>ã€‚</p>
<p>å¤–è®¾ä¾èµ–è¯¥æ—¶é’Ÿæºæ¥éµå¾ªI2Cåè®®è§„èŒƒäº§ç”Ÿæ•°æ®å»ºç«‹å’Œç»´æŒæ—¶é—´ã€‚</p>
<p>è¯¥å­—æ®µæœ€å°å¯ä»¥é…ç½®ä¸º2MHzï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡APBæ€»çº¿æ—¶é’Ÿé¢‘ç‡çš„é™åˆ¶ï¼Œä¹Ÿä¸èƒ½è¶…è¿‡50MHzï¼ˆå¤–è®¾æœ¬èº«çš„ç‰©ç†ç‰¹æ€§é™åˆ¶ï¼‰ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203151357832.png" alt="image-20241203151357832"></p>
<p>å¦‚ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä¸ºAPB1æœ€å¤§é¢‘ç‡36MHzæ¥å‘æŒ¥å¤–è®¾æœ€å¤§æ€§èƒ½ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">I2C2<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> <span class="token number">36</span><span class="token punctuation">;</span> <span class="token comment">// å¿…é¡»å°äºç­‰äºAPB1çš„æœ€å¤§æ—¶é’Ÿ36MHz</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="scl-shi-zhong-pin-lu-ccr">SCLæ—¶é’Ÿé¢‘ç‡(CCR)</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203152828329.png" alt="image-20241203152828329"></p>
<blockquote>
<p>[!NOTE]</p>
<p>f<sub>PCLK1</sub> must be at least 2 MHz to achieve Sm mode IÂ²C frequencies. It must be at least 4 MHz to achieve Fm mode IÂ²C frequencies. It must be a multiple of 10MHz to reach the 400 kHz maximum IÂ²C Fm mode clock. The CCR register must be configured only when the I2C is disabled (PE = 0)</p>
</blockquote>
<p>è¿™é‡Œå†æ¬¡æåˆ°äº†I2Cå¯¹å¤–è®¾è¾“å…¥æ—¶é’Ÿï¼ˆI2C_CR2ä¸­çš„FREQï¼‰çš„è¦æ±‚ï¼š</p>
<ul>
<li>I2Cæ ‡å‡†æ¨¡å¼ï¼šå¤–è®¾æ—¶é’Ÿè‡³å°‘ä¸º2MHz</li>
<li>I2Cå¿«é€Ÿæ¨¡å¼ï¼šå¤–è®¾æ—¶é’Ÿè‡³å°‘ä¸º4MHz</li>
<li>è¾¾åˆ°I2Cå¿«é€Ÿæ¨¡å¼æœ€å¤§é€Ÿç‡400MHzï¼šå¤–è®¾æ—¶é’Ÿå¿…é¡»ä¸º10MHzçš„å€æ•°</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCCRå¯„å­˜å™¨å¿…é¡»åœ¨PE=0ï¼ˆä½¿èƒ½å¤–è®¾ä¹‹å‰ï¼‰æ—¶è¿›è¡Œé…ç½®ã€‚</p>
<p>ä¸‹é¢<mark>æ ‡å‡†æ¨¡å¼</mark>ä¸ºä¾‹ï¼Œé…ç½®SCLæ€»çº¿æ—¶é’Ÿé¢‘ç‡ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203153643894.png" alt="image-20241203153643894"></p>
<p>æ ‡å‡†æ¨¡å¼ä¸‹ï¼ŒI2Cå¤–è®¾çš„SCLé«˜ç”µå¹³å’Œä½ç”µå¹³å‘¨æœŸå‡ä¸º CCR * T<sub>PCLK1</sub>ï¼ˆå¤–è®¾æ—¶é’Ÿå‘¨æœŸï¼‰ï¼Œè¦æƒ³è®¡ç®—CCRï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“é«˜ç”µå¹³å‘¨æœŸt<sub>high</sub>å’Œä½ç”µå¹³å‘¨æœŸt<sub>low</sub>ï¼Œ<code>Note</code>ä¸­æåˆ°éœ€è¦æŸ¥çœ‹æ•°æ®æ‰‹å†Œä¸­t<sub>r(SCL)</sub>å’Œt<sub>w(SCLH)</sub>ç­‰å‚æ•°çš„å®šä¹‰</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203154217552.png" alt="image-20241203154217552" style="zoom: 50%;">
<p>å¯ä»¥å‘ç°æ•°æ®æ‰‹å†Œå¯¹äºSCLé«˜ç”µå¹³å‘¨æœŸã€ä½ç”µå¹³å‘¨æœŸã€SDA/SCLä¸Šå‡æ—¶é—´å’Œä¸‹é™æ—¶é—´ç­‰å‚æ•°çš„èŒƒå›´é™åˆ¶å’ŒI2Cåè®®æ‰‹å†Œæ˜¯ä¸€è‡´çš„ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203154644942.png" alt="image-20241203154644942">é‚£ä¹ˆå¦‚æœæƒ³å®ç°æ ‡å‡†æ¨¡å¼ä¸‹100kHzçš„æœ€å¤§é¢‘ç‡ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºå¯¹åº”çš„å‘¨æœŸä¸º10usã€‚å¦‚æœè§‚å¯Ÿt<sub>w(SCLL)</sub>+t<sub>f(SCL)</sub>å³SCLä½ç”µå¹³æœ€å°å®½åº¦4.7uså’Œä¸‹é™æ—¶é—´æœ€å¤§å€¼0.3usï¼ˆ300ns)ï¼Œå‘ç°ä¸¤è€…ä¹‹å’Œæ­£å¥½ä¸º5usï¼ŒåŒæ ·çš„SCLé«˜ç”µå¹³æœ€å°å®½åº¦4usä¸ä¸Šå‡æ—¶é—´æœ€å¤§å®½åº¦1usï¼ˆ1000ns)ä¹‹å’Œä¹Ÿæ­£å¥½ä¸º5usã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæ ‡å‡†æ¨¡å¼ä¸‹å°†T<sub>high</sub>å’ŒT<sub>low</sub>éƒ½è®¾ç½®ä¸ºCCR * T<sub>PCLK1</sub>ï¼Œ<mark>ç›¸å½“äº50%å ç©ºæ¯”</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203155632578.png" alt="image-20241203155632578"></p>
<p>æ—¢ç„¶çŸ¥é“äº†ç›®æ ‡é¢‘ç‡100kHzï¼ˆå¯¹åº”å‘¨æœŸ10usï¼‰ï¼Œä»¥åŠç›®æ ‡é«˜ä½ç”µå¹³å‘¨æœŸä¸º5usï¼Œé‚£ä¹ˆå¯ä»¥æ¨å‡ºCCRä¸º 5us / T<sub>PCLK1</sub>ï¼Œå³ 5us / (1 / 36MHz)ï¼Œå³CCR = 180ã€‚</p>
<p>è‡³æ­¤æˆ‘ä»¬å¯ä»¥é…ç½®å¤–è®¾çš„é€Ÿåº¦æ¨¡å¼å’ŒSCLçš„æ—¶é’Ÿé¢‘ç‡äº†ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 5. é…ç½®å¤–è®¾æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼ï¼ˆ100kb/sï¼‰ã€SCLæ—¶é’Ÿé¢‘ç‡ï¼ˆ100kHzï¼‰</span>
I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CCR_FS<span class="token punctuation">;</span>
I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> <span class="token number">180</span><span class="token punctuation">;</span> <span class="token comment">// 5us/T(PCLK)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="scl-sda-zui-da-shang-sheng-shi-jian-trise">SCL/SDAæœ€å¤§ä¸Šå‡æ—¶é—´ï¼ˆTRISEï¼‰</h4>
<blockquote>
<p>[!NOTE]</p>
<p>ä¸Šå‡æ—¶é—´æ˜¯æŒ‡é‡Šæ”¾æ€»çº¿åï¼Œæ€»çº¿ç”µå‹ä¸Šå‡åˆ°é€»è¾‘é«˜ç”µå¹³æ‰€éœ€çš„æ—¶é—´</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203170939359.png" alt="image-20241203170939359"></p>
<p>å¯„å­˜å™¨æè¿°ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203160222421.png" alt="image-20241203160222421"></p>
<p>ä¸ºä»€ä¹ˆè¦é…ç½®ä¸€ä¸ªSCLæœ€å¤§ä¸Šå‡æ—¶é—´TRISEå‘¢ï¼Ÿä»ä¸Šä¸€èŠ‚çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“T<sub>high</sub>æ˜¯åŒ…æ‹¬ä¸Šå‡æ—¶é—´å’Œé€»è¾‘é«˜ç”µå¹³æ—¶é—´çš„ã€‚ä»è½¯ä»¶æ“ä½œSCLæ‹‰é«˜ä¹‹ååˆ°ç‰©ç†å±‚é¢SCLçœŸæ­£å˜ä¸ºé€»è¾‘é«˜ç”µå¹³æ˜¯ç”±ä¸€å®šçš„å»¶æ—¶çš„ï¼Œè¯¥å»¶æ—¶ç”±ç”µè·¯ä¸Šæ‹‰ç”µé˜»ä»¥åŠç”µå®¹çš„ç”µæ°”ç‰¹æ€§å†³å®šã€‚å¤–è®¾ä¸ºäº†ç¡®ä¿èƒ½å¤Ÿæ ¹æ®CCRçš„é…ç½®äº§ç”ŸT<sub>high</sub>é•¿åº¦çš„é«˜ç”µå¹³ï¼Œä¼šåœ¨æ‹‰é«˜SCLåé€šè¿‡åé¦ˆå›è·¯ï¼ˆä¾‹å¦‚IDRå¯„å­˜å™¨ï¼‰æ£€æµ‹SCLçš„ç”µå‹çŠ¶æ€ï¼Œå½“å…¶è¾¾åˆ°é€»è¾‘é«˜ç”µå¹³æ—¶ï¼Œå¤–è®¾å†…éƒ¨çš„é«˜ç”µå¹³è®¡æ•°å™¨å°±ä¼šå¼€å§‹è®¡æ•°ï¼ˆé€»è¾‘é«˜ç”µå¹³æ¯æŒç»­ä¸€ä¸ªPCLKï¼Œå°±è‡ªå¢ï¼‰ï¼Œç›´åˆ°è®¡æ•°å€¼ä¸ºæˆ‘ä»¬é…ç½®çš„CCRï¼Œè¿™æ ·å°±å®ç°äº†æˆ‘ä»¬é¢„æœŸçš„5usé«˜ç”µå¹³å‘¨æœŸã€‚</p>
<p>ä½†æ˜¯è¿™æ ·å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ ¹æ®I2Cè§„èŒƒï¼ŒçœŸæ­£çš„é€»è¾‘é«˜ç”µå¹³æŒç»­4uså°±å¤Ÿäº†ï¼Œä¸Šå‡æ—¶é—´å¯ä»¥æœ€å¤§å®¹è®¸1usï¼ˆ1000nsï¼‰ï¼›å¯¹äºé¢‘ç‡100kHzï¼Œå‘¨æœŸä¸º10usï¼Œå ç©ºæ¯”ä¸º5usçš„æ ‡å‡†æ¨¡å¼æœ€å¤§é€Ÿç‡ï¼Œ<mark>I2Cå°†5usé«˜ç”µå¹³æ—¶é—´åˆ’åˆ†ä¸ºäº†ä¸Šå‡æ—¶é—´1uså’Œé€»è¾‘é«˜ç”µå¹³æ—¶é—´4usã€‚</mark></p>
<p>è€Œå¦‚æœæŒ‰ç…§ä¸Šè¿°é«˜ç”µå¹³è®¡æ•°å™¨çš„å·¥ä½œæœºåˆ¶ï¼Œå¦‚æœä¸Šå‡æ—¶é—´ä¸º0.5usï¼Œå†åŠ ä¸Šè®¡æ•°å™¨å¯¹åº”çš„é€»è¾‘é«˜ç”µå¹³æ—¶é—´5usï¼Œ</p>
<p>æ•´ä½“é«˜ç”µå¹³å‘¨æœŸå°±å˜æˆäº†0.5+5=5.5usï¼Œå¯¼è‡´æ‹‰é•¿äº†SCLçš„æ—¶é’Ÿå‘¨æœŸï¼ˆé¢„æœŸé«˜ç”µå¹³å‘¨æœŸåªæŒç»­5usï¼‰ï¼Œ<mark>é™ä½äº†SCLçš„é¢„æœŸé¢‘ç‡</mark>ï¼Œä»è€Œé™ä½äº†ä¼ è¾“é€Ÿç‡ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203161544044.png" alt="image-20241203161544044"></p>
<p>å› æ­¤ï¼ŒTRISEå…¶å®æ˜¯è®©æˆ‘ä»¬å‘Šè¯‰I2Cå¤–è®¾çš„é«˜ç”µå¹³å‘¨æœŸè®¡æ•°å™¨ï¼Œä¸ç”¨ä»é€»è¾‘é«˜ç”µå¹³æ‰å¼€å§‹è®¡æ•°ï¼Œä»å¼€å§‹æ‹‰é«˜SCLé‚£ä¸€åˆ»å°±å¯ä»¥å¼€å§‹è®¡æ•°ï¼ˆå³ä½¿ç”µå‹è¿˜æ²¡æœ‰åˆ°è¾¾é€»è¾‘é«˜ç”µå¹³ï¼‰ï¼Œå¹¶å½“è®¡æ•°å€¼ç­‰äºTRISEæ—¶ï¼ˆä¾‹å¦‚36ï¼Œ36 * T<sub>PCLK</sub> = 1usï¼Œ<mark>è¯¥å€¼ç”¨äºæé†’è®¡æ•°å™¨åˆ°äº†æœ€å¤§ä¸Šå‡çš„ä¸´ç•Œå€¼ï¼Œå‰©ä¸‹çš„è®¡æ•°å¿…é¡»ç­‰åˆ°SCLé€»è¾‘é«˜ç”µå¹³æ‰èƒ½ç»§ç»­</mark>ï¼‰ï¼Œæ‰é€šè¿‡åé¦ˆå›è·¯æ£€æµ‹SCLç”µå‹çŠ¶æ€ï¼Œå¦‚æœSCLä¸ºé€»è¾‘é«˜ç”µå¹³åˆ™ç»§ç»­è®¡æ•°ç›´åˆ°CCRï¼ˆè¿™æ ·ç¡®ä¿äº†é€»è¾‘é«˜ç”µå¹³<code>&gt;= 4us</code>ï¼‰ï¼Œå¦‚æœSCLæ²¡æœ‰è¾¾åˆ°é€»è¾‘é«˜ç”µå¹³ï¼ˆä¾‹å¦‚ä¸Šæ‹‰ç”µé˜»ã€ç”µå®¹ã€æ»¤æ³¢å¯¼è‡´çš„æ—¶å»¶ï¼Œä»è®¾å¤‡æ‹‰ä½SCLå¯¼è‡´çš„æ—¶é’Ÿæ‹‰ä¼¸ç­‰ï¼‰ï¼Œé‚£ä¹ˆè®¡æ•°å™¨å°±ä¼šæš‚åœè®¡æ•°ï¼Œç›´åˆ°æ£€æµ‹åˆ°SCLè¾¾åˆ°é€»è¾‘é«˜ç”µå¹³æ‰ç»§ç»­å‰©ä½™çš„CCR-TRISEè®¡æ•°å‘¨æœŸã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå°†TRISEé…ç½®ä¸ºI2Cè§„èŒƒçš„æœ€å¤§ä¸Šå‡æ—¶é—´å¯¹åº”çš„è®¡æ•°å€¼ï¼ˆæœ€å¤§ä¸Šå‡æ—¶é—´ / å¤–è®¾å·¥ä½œé¢‘ç‡ï¼‰ä¹‹åï¼Œæ— è®ºåœ¨è¯¥æ—¶é—´å†…çš„å“ªä¸ªæ—¶åˆ»ç”µå‹è¾¾åˆ°é€»è¾‘é«˜ç”µå¹³ï¼ŒSCLé«˜ç”µå¹³å‘¨æœŸéƒ½ä¸ºCCRå¯¹åº”çš„5usã€‚è€Œå¦‚æœä¸é…ç½®TRISEï¼Œå°±ä¼šå­˜åœ¨è¿™ç§æƒ…å†µï¼š0.8usåç”µå‹è¾¾åˆ°é€»è¾‘é«˜ç”µå¹³ï¼Œè®¡æ•°å™¨å¼€å§‹è®¡æ•°CCRä¸ªå‘¨æœŸï¼ˆ5usï¼‰ï¼ŒSCLé«˜ç”µå¹³ä¸º5.8usï¼ŒSCLå‘¨æœŸä¸º10.8usï¼Œè¿™æ ·å°±é™ä½äº†SCLçš„é¢‘ç‡ï¼ˆé¢„æœŸä¸º10usï¼‰</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬æ¥è®¡ç®—ä¸‹TRISEçš„é…ç½®å€¼</p>
<ul>
<li>36MHzå¤–è®¾é¢‘ç‡ï¼Œå‘¨æœŸä¸º1/36us</li>
<li>I2Cè§„èŒƒæ ‡å‡†æ¨¡å¼ä¸‹ä¸Šå‡æ—¶é—´æœ€å¤§ä¸º1000nsï¼Œå³1us</li>
<li>å› æ­¤TRISE = ä¸Šå‡æ—¶é—´1us / å¤–è®¾æ—¶é’Ÿå‘¨æœŸ + 1 = <code>1 / (1 / 36) + 1 = 37</code></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_TRISE_TRISE<span class="token punctuation">;</span>
I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">|=</span> <span class="token number">37</span><span class="token punctuation">;</span> <span class="token comment">// 36 clock cycle + 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="wai-she-shi-neng">å¤–è®¾ä½¿èƒ½</h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203171424466.png" alt="image-20241203171424466"></p>
<blockquote>
<p>[!NOTE]</p>
<p>éœ€è¦æ³¨æ„ï¼Œè¯¥é…ç½®åº”è¯¥åœ¨æ‰€æœ‰I2Cé…ç½®å®Œæˆä¹‹å</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_PE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="shi-li-dai-ma">ç¤ºä¾‹ä»£ç </h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIOæ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_I2C2EN<span class="token punctuation">;</span>

    <span class="token comment">// 2. é…ç½®GPIOå·¥ä½œæ¨¡å¼ä¸ºå¤ç”¨å¼€æ¼è¾“å‡º mode=11 cnf=11</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span> GPIO_CRH_CNF11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_CNF10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç‰¹åˆ«æ³¨æ„ï¼Œå¦‚ä¸‹æ“ä½œæ— æ³•å¾—åˆ°é¢„æœŸç»“æœï¼ŒGPIOå·¥ä½œä¸æ­£å¸¸</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</span>
    <span class="token comment">// å¦‚ä¸‹åˆ™æ˜¯å¯ä»¥çš„</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 | GPIO_CRH_CNF10);</span>

    <span class="token comment">// 3. é…ç½®å¤–è®¾ä¸ºI2Cæ¨¡å¼ï¼ˆé»˜è®¤å°±æ˜¯I2Cæ¨¡å¼ï¼Œ1-SMBUSæ¨¡å¼ï¼‰</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_SMBUS<span class="token punctuation">;</span>

    <span class="token comment">// 4. é…ç½®å¤–è®¾æ—¶é’Ÿ</span>
    I2C2<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> <span class="token number">36</span><span class="token punctuation">;</span> <span class="token comment">// å¿…é¡»å°äºç­‰äºAPB1çš„æœ€å¤§æ—¶é’Ÿé¢‘ç‡36MHz</span>

    <span class="token comment">// 5. é…ç½®å¤–è®¾æ¨¡å¼ï¼šI2Cæ ‡å‡†æ¨¡å¼ï¼ˆ100kHzï¼‰ã€SCLæ—¶é’Ÿé¢‘ç‡ï¼ˆ100kHzï¼‰</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CCR_FS<span class="token punctuation">;</span> <span class="token comment">// æ ‡å‡†æ¨¡å¼</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> <span class="token number">180</span><span class="token punctuation">;</span> <span class="token comment">// SCLé«˜ä½ç”µå¹³å‘¨æœŸ5us / å¤–è®¾æ—¶é’Ÿå‘¨æœŸ(1/36us) = 5 * 36</span>

    <span class="token comment">// 6. é…ç½®TRISE-SCLæœ€å¤§ä¸Šå‡æ—¶é—´</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_TRISE_TRISE<span class="token punctuation">;</span> <span class="token comment">// æ¸…é›¶</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">|=</span> <span class="token number">37</span><span class="token punctuation">;</span> <span class="token comment">// I2Cæ ‡å‡†æ¨¡å¼æœ€å¤§ä¸Šå‡æ—¶é—´1us / å¤–è®¾æ—¶é’Ÿå‘¨æœŸ(1/36us) + 1 = 36 + 1</span>

    <span class="token comment">// 7. ä½¿èƒ½å¤–è®¾</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_PE<span class="token punctuation">;</span> <span class="token comment">// Peripheral(I2C) Enable</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-qi-shi-xin-hao">å‘é€èµ·å§‹ä¿¡å·</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203171713561.png" alt="image-20241203171713561"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203171644654.png" alt="image-20241203171644654"></p>
<p>è®¾ç½® <code>START</code>ä½åï¼Œå¤–è®¾ä¼šåœ¨BUSYä½è¢«æ¸…é™¤åäº§ç”Ÿä¸€ä¸ªèµ·å§‹ä¿¡å·å¹¶åˆ‡æ¢åˆ°ä¸»è®¾å¤‡æ¨¡å¼ã€‚</p>
<p><mark>èµ·å§‹ä¿¡å·çš„äº§ç”Ÿæœ‰ä¸ªå‰æï¼šæ€»çº¿æ˜¯ç©ºé—²çŠ¶æ€</mark></p>
<ul>
<li>BUSYå¤ä½å€¼ä¸ºæ¸…é™¤çŠ¶æ€</li>
<li>å½“SDAæˆ–SCLè¢«æ‹‰ä½æ—¶ï¼ŒBUSYä¼šè¢«ç¡¬ä»¶ç½®ä½ï¼Œè¡¨ç¤ºæ€»çº¿æ­£åœ¨ç”¨äºé€šä¿¡</li>
<li>å½“åœæ­¢æ¡ä»¶äº§ç”Ÿåï¼ŒBUSYä¼šè¢«ç¡¬ä»¶æ¸…é™¤<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203172040017.png" alt="image-20241203172040017" style="zoom: 33%;"></li>
</ul>
<p>åœ¨ä¸»è®¾å¤‡æ¨¡å¼ä¸‹ï¼Œå†æ¬¡ç½®ä½STARTä¼šä½¿å¤–è®¾åœ¨å½“å‰å­—èŠ‚ä¼ è¾“å®Œæˆï¼ˆå¦‚æœç§»ä½å¯„å­˜å™¨æ­£åœ¨ä¼ è¾“å­—èŠ‚æ•°æ®ï¼‰æ—¶äº§ç”ŸReStarté‡å¤èµ·å§‹ä¿¡å·ã€‚</p>
<p>ä¸€æ—¦äº§ç”Ÿäº†èµ·å§‹ä¿¡å·ï¼ŒSBä¼šè¢«ç¡¬ä»¶ç½®ä½ï¼Œå¹¶ä¸”äº§ç”Ÿä¸­æ–­ï¼ˆå¦‚æœè®¾ç½®äº†ITEVTENä½ï¼‰ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203173333175.png" alt="image-20241203173333175"></p>
<p>å› æ­¤ä¸»è®¾å¤‡å¯ä»¥åœ¨è®¾ç½®STARTä¹‹åï¼Œè½®è¯¢SR1ä¸­çš„SBï¼Œå¹¶åœ¨SBè¢«ç½®ä½åå°†ä»è®¾å¤‡åœ°å€å†™å…¥DRå‘é€ç¼“å†²åŒºã€‚</p>
<h3 id="shi-li-dai-ma-1">ç¤ºä¾‹ä»£ç </h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº§ç”Ÿèµ·å§‹ä¿¡å·ï¼ˆå½“BUSY=1æ—¶ä¸ä¼šç«‹å³äº§ç”Ÿï¼‰</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_START<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// èµ·å§‹ä¿¡å·äº§ç”Ÿåï¼Œç”±ç¡¬ä»¶ç½®ä½SB</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_SB<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_Start timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç´§æ¥ç€å‘é€è®¾å¤‡åœ°å€ä¼šå†™DRï¼Œè¯»SR1å†™DRåºåˆ—ä¼šæ¸…é™¤SBï¼Œå› æ­¤è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨æ¸…é™¤SB</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-cong-she-bei-di-zhi">å‘é€ä»è®¾å¤‡åœ°å€</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203174842914.png" alt="image-20241203174842914"></p>
<p>è½®è¯¢SR1ç­‰å¾…èµ·å§‹ä¿¡å·å‘å‡ºåï¼Œä¸»è®¾å¤‡å¯ä»¥å°†ä»è®¾å¤‡åœ°å€å†™å…¥DRï¼Œç„¶åä»è®¾å¤‡åœ°å€å°±ä¼šé€šè¿‡å†…éƒ¨çš„ç§»ä½å¯„å­˜å™¨å‘é€åˆ°SDAæ€»çº¿ä¸Šã€‚</p>
<p>ä¸€æ—¦ä»è®¾å¤‡åœ°å€å­—èŠ‚å‘é€å®Œæˆåï¼ŒSR1ä¸­çš„ADDRä¼šè¢«ç¡¬ä»¶ç½®ä½ï¼Œå¹¶äº§ç”Ÿä¸­æ–­ï¼ˆå¦‚æœé…ç½®äº†CR2ä¸­çš„ITEVFENï¼‰ã€‚</p>
<p>å› æ­¤ï¼Œä¸»è®¾å¤‡å¯ä»¥è½®è¯¢SR1ä¸­çš„ADDRï¼Œå½“å…¶è¢«ç½®ä½åè·Ÿéšä¸€ä¸ªè¯»SR2æ“ä½œï¼Œå°±å¯ä»¥æ¸…é™¤ADDRæ ‡å¿—ä½ã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203175416218.png" alt="image-20241203175416218" style="zoom: 50%;">
<blockquote>
<p>[!NOTE]</p>
<p>æ³¨æ„ï¼šå½“åœ°å€æ•°æ®å‘é€åˆ°SDAæ€»çº¿ä¹‹åï¼Œå¹¶ä¸”æ”¶åˆ°äº†ä»è®¾å¤‡çš„ACKï¼ŒADDRæ‰ä¼šè¢«ç½®ä½ã€‚å› æ­¤ï¼Œä¸è½¯ä»¶æ¨¡æ‹ŸI2Cç›¸æ¯”ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨è¯»å–SDAå¹¶åˆ¤æ–­ACK/NACKäº†ï¼Œç¡¬ä»¶å¸®æˆ‘ä»¬å®Œæˆäº†è¿™ä¸€æ­¥ã€‚</p>
</blockquote>
<h3 id="shi-li-dai-ma-2">ç¤ºä¾‹ä»£ç </h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// äº§ç”Ÿèµ·å§‹ä¿¡å·åï¼ŒDRè‚¯å®šä¸ºç©ºï¼Œå¯ä»¥å°†ä»è®¾å¤‡åœ°å€ç›´æ¥å†™å…¥DR</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> addr<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…ç¡¬ä»¶ç½®ä½ADDRï¼ˆè¡¨æ˜ä»è®¾å¤‡åœ°å€ä»¥å‘å‡ºå¹¶æ”¶åˆ°äº†ç›¸åº”ä»è®¾å¤‡çš„ACKï¼‰</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_ADDR<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendAddr timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¸…é™¤ADDRæ ‡å¿—ä½æ“ä½œåºåˆ—ï¼šè¯»SR1åè·Ÿéšä¸€ä¸ªè¯»SR2</span>
    I2C2<span class="token operator">-&gt;</span>SR2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="zui-di-you-xiao-wei-biao-shi-du-xie">æœ€ä½æœ‰æ•ˆä½è¡¨ç¤ºè¯»/å†™</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203180555453.png" alt="image-20241203180555453"></p>
<p>å‘é€ä»è®¾å¤‡åœ°å€æ—¶ï¼Œä¸»è®¾å¤‡å¯ä»¥é€šè¿‡å…¶ä¸­çš„æœ€ä½æœ‰æ•ˆä¸ºï¼ˆLSBï¼‰æ¥å†³å®šåç»­é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œå½“å‰å¤–è®¾å……å½“å‘é€æ–¹è¿˜æ˜¯æ¥æ”¶æ–¹ã€‚</p>
<h2 id="zhu-she-bei-fa-song-shu-ju">ä¸»è®¾å¤‡å‘é€æ•°æ®</h2>
<blockquote>
<p>Following the address transmission and after clearing ADDR, the master sends bytes from the DR register to the SDA line via the internal shift register.</p>
</blockquote>
<p>åœ¨å‘é€å®Œä»è®¾å¤‡åœ°å€å¹¶æ¸…é™¤ADDRä¹‹åï¼Œæ¥ä¸‹æ¥ä¸»è®¾å¤‡å¯ä»¥ç»ç”±å†…éƒ¨çš„ç§»ä½å¯„å­˜å™¨å°†å†™å…¥DRçš„å­—èŠ‚æ•°æ®å‘é€åˆ°SDAæ€»çº¿ä¸Šã€‚</p>
<blockquote>
<p>The master waits until the first data byte is written into I2C_DR (see Figure 273 Transfer sequencing EV8_1).</p>
</blockquote>
<p>ä¸»è®¾å¤‡å¯ä»¥è½®è¯¢SR1ä¸­çš„TXEï¼Œå¼€å§‹å°†ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚å†™å…¥DRå‘é€ç¼“å†²åŒºï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203181334652.png" alt="image-20241203181334652"></p>
<p>æŒ‰ç…§æ‰‹å†Œæ‰€è¿°ï¼ˆsee Figure 273 Transfer sequencing EV8_1ï¼‰ï¼Œå½“å‰æˆ‘ä»¬æ‰€å¤„çš„é˜¶æ®µå¯¹åº”EV8_1ï¼Œç§»ä½å¯„å­˜å™¨å’ŒDRç¼“å†²åŒºéƒ½ä¸ºç©ºï¼Œè½®è¯¢TXEä¼šç«‹å³é€šè¿‡ï¼Œå¯ä»¥å°†ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚Data1å†™å…¥DRã€‚ç”±äºç§»ä½å¯„å­˜å™¨ä¸ºç©ºï¼Œå†™å…¥DRçš„å­—èŠ‚ä¼šè¢«ç›´æ¥é€’äº¤ç»™ç§»ä½å¯„å­˜å™¨å¹¶ä¼ è¾“åˆ°SDAæ€»çº¿ä¸Šã€‚å› ä¸ºDRä»ç„¶æ˜¯ç©ºçš„ï¼Œç¬¬äºŒæ¬¡è½®è¯¢TXEä¹Ÿä¼šç«‹å³é€šè¿‡ï¼Œä¼šå°†ç¬¬äºŒä¸ªæ•°æ®å­—èŠ‚Data2å†™å…¥DRã€‚åç»­å­—èŠ‚å†™å…¥DRæ—¶åˆ™ä¼šå‡ºç°ç§»ä½å¯„å­˜å™¨æ­£åœ¨å‘é€Data1ã€DRç¼“å†²åŒºæ•°æ®Data2ç­‰å¾…é€’äº¤ç§»ä½å¯„å­˜å™¨çš„æƒ…å†µï¼Œå› æ­¤è½®è¯¢TXEå¯èƒ½ä¼šè€—è´¹ä¸€äº›æ—¶é—´ã€‚</p>
<blockquote>
<p>When the acknowledge pulse is received, the TxE bit is set by hardware and an interrupt is generated if the ITEVFEN and ITBUFEN bits are set</p>
</blockquote>
<p>å½“ç§»ä½å¯„å­˜å™¨å‘é€å®Œä¸€ä¸ªå­—èŠ‚ï¼ˆä¾‹å¦‚Data1ï¼‰å¹¶ä¸”æ”¶åˆ°äº†ä»è®¾å¤‡çš„ACKæ—¶ï¼ŒDRç¼“å†²åŒºä¸­çš„æ•°æ®ä¼šè¢«é€’äº¤ç»™ç§»ä½å¯„å­˜å™¨å¹¶ä¸”TXEä¼šè¢«ç¡¬ä»¶ç½®ä½ï¼ˆæŒ‡ç¤ºæˆ‘ä»¬å¯ä»¥å‘DRå†™å…¥ä¸‹ä¸€ä¸ªè¦å‘é€çš„æ•°æ®äº†ï¼‰ã€‚è¿™æ—¶å‘é€Data3å‰çš„è½®è¯¢ä¼šé€šè¿‡ï¼Œå¹¶å°†Data3å†™å…¥DRã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203184111734.png" alt="image-20241203184111734"></p>
<p>å¦‚ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä»TxEçš„æè¿°ä¸­è·å–æ›´å¤šç»†èŠ‚ã€‚</p>
<ul>
<li>å‘é€è¿‡ç¨‹ä¸­ï¼Œå½“DRå¯„å­˜å™¨ä¸ºç©ºæ—¶ï¼ŒDRä¼šè¢«ç¡¬ä»¶ç½®ä½ï¼Œä½†å‘é€åœ°å€é˜¶æ®µé™¤å¤–</li>
<li>å†™DRå¯ä»¥æ¸…é™¤è¯¥æ ‡å¿—ä½ï¼›åœ¨èµ·å§‹ä¿¡å·ã€åœæ­¢ä¿¡å·ã€å¤–è®¾ä½¿èƒ½åä¼šç”±ç¡¬ä»¶æ¸…é™¤ã€‚</li>
<li>å¦‚æœæ”¶åˆ°äº†ä»è®¾å¤‡çš„NACKï¼Œæˆ–è€…ä¸‹ä¸ªè¦å‘é€çš„å­—èŠ‚æ˜¯å¸§é”™è¯¯æ£€æŸ¥å­—èŠ‚ï¼Œåˆ™TXEä¸ä¼šè¢«ç½®ä½ã€‚</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>ä»¥ä¸‹ä¸¤ç§æƒ…å†µTXEä¸ä¼šè¢«æ¸…é™¤ï¼š</p>
<ul>
<li>å‘é€ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚æ—¶ï¼ˆå› ä¸ºç›´æ¥å†™å…¥äº†ç§»ä½å¯„å­˜å™¨ä¸­ï¼ŒDRä»ç„¶æ˜¯ç©ºçš„ï¼‰ã€‚</li>
<li>å½“BTFè¢«ç½®ä½æ—¶å‘DRå†™å…¥æ•°æ®ï¼ˆè¯¥æ ‡å¿—åœ¨TXE=1å¹¶ä¸”ç§»ä½å¯„å­˜å™¨æ²¡æœ‰æ­£åœ¨å‘é€çš„æ•°æ®æ—¶è¢«ç½®ä½ï¼‰ï¼Œæ•°æ®ä¼šè¢«ç›´æ¥é€’äº¤ç»™ç§»ä½å¯„å­˜å™¨ã€‚</li>
</ul>
</blockquote>
<blockquote>
<p>If TxE is set and a data byte was not written in the DR register before the end of the last data transmission, BTF is set and the interface waits until BTF is cleared by a read from I2C_SR1 followed by a write to I2C_DR, stretching SCL low.</p>
</blockquote>
<p>å¦‚æœTXEè¢«ç½®ä½äº†ï¼Œå¹¶ä¸”åœ¨ä¸Šä¸€ä¸ªæ•°æ®å‘é€ç»“æŸä¹‹å‰éƒ½æ²¡æœ‰æ•°æ®å­—èŠ‚è¢«å†™å…¥DRï¼ŒBTFè¢«ç½®ä½ã€‚æ­¤æ—¶ï¼Œå¤–è®¾ä¼šé€šè¿‡å»¶ä¼¸ï¼ˆå»¶å±•ï¼‰SCLä½ç”µå¹³ï¼Œç›´åˆ°BTFè¢«æ¸…é™¤ï¼ˆè¯»SR1åè·Ÿéšä¸€ä¸ªå†™DRï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203185842734.png" alt="image-20241203185842734"></p>
<p>æƒ³ä¸€æƒ³ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸ºäº†æ›´å¥½çš„è¿è´¯æ€§å’Œå‘é€é€Ÿç‡ï¼Œä¸»è®¾å¤‡åº”è¯¥ä¸è®ºè½®è¯¢TXEå¹¶å‘DRå†™å…¥å¾…å‘é€çš„å­—èŠ‚ï¼Œå°½ç®¡ç§»ä½å¯„å­˜å™¨å¯èƒ½è¿˜æ­£åœ¨ä¼ è¾“ä¸Šä¸ªå­—èŠ‚ï¼Œä½†è¿™å¹¶ä¸å½±å“å°†ä¸‹ä¸ªè¦ä¼ è¾“çš„å­—èŠ‚å†™å…¥DRã€‚</p>
<p>å½“TXEè¢«ç½®ä½ï¼ˆå‘é€ç¼“å†²åŒºä¸ºç©ºï¼‰ï¼Œå¹¶ä¸”ç§»ä½å¯„å­˜å™¨ä¸­çš„ä¼ è¾“ä¹Ÿç»“æŸäº†ï¼Œè¿˜æ²¡å†™DRæ“ä½œï¼Œä¼šæœ‰å¦‚ä¸‹å‡ ç§æƒ…å†µï¼š</p>
<ul>
<li>æ­¤æ¬¡é€šä¿¡æ‰€æœ‰æ•°æ®éƒ½ä¸€æ¬¡å†™å…¥DRäº†ï¼Œæ­¤æ—¶å¯èƒ½ç§»ä½å¯„å­˜å™¨æ­£åœ¨ä¼ è¾“å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚ï¼ŒDRè¿˜æš‚å­˜ç€æœ€åä¸€ä¸ªè¦å‘é€çš„å­—èŠ‚ï¼Œå› æ­¤ä¸»è®¾å¤‡åœ¨å‘é€åœæ­¢ä¿¡å·å‰éœ€è¦è½®è¯¢BTFç¡®è®¤DRä¸ºç©ºäº†ï¼ˆTXE=1ï¼‰ï¼Œç§»ä½å¯„å­˜å™¨ä¹Ÿç»“æŸä¼ è¾“çŠ¶æ€äº†å¹¶ä¸”æœ€åä¸€ä¸ªå­—èŠ‚çš„ACKä¹Ÿæ”¶åˆ°äº†ï¼ˆTXE=1ï¼‰ï¼Œè¿™æ—¶å¯ä»¥å‘å‡ºåœæ­¢ä¿¡å·ï¼ŒéšåTXEå’ŒBTFéƒ½ä¼šè¢«æ¸…é™¤ã€‚</li>
<li>ä¸»è®¾å¤‡å¯¹è¯¥ä¼ è¾“ä»»åŠ¡è®¾ç½®çš„ä¼˜å…ˆçº§ä¸é«˜ï¼Œä¸èƒ½åŠæ—¶æ£€æµ‹åˆ°TXEå¹¶å†™DRï¼Œå¯ä»¥ä½¿ç”¨è½®è¯¢BTFçš„æ–¹å¼æ¥ä»£æ›¿è½®è¯¢TXEï¼Œä½†ä¼ è¾“é€Ÿç‡ä¼šä¸‹é™ï¼Œå› ä¸ºBTFè¢«ç½®ä½æœŸé—´ï¼ŒSCLä¼šå¤„äºä½ç”µå¹³æ‹‰ä¼¸çŠ¶æ€ï¼ˆstretchï¼‰</li>
<li><mark>ä¸»è®¾å¤‡æœŸæœ›çŸ¥é“æ¯ä¸ªå­—èŠ‚æ˜¯å¦æ”¶åˆ°äº†ACK</mark>ï¼Œå› æ­¤æ¯æ¬¡å‘DRå†™å…¥å­—èŠ‚åï¼Œéƒ½è½®è¯¢BTFï¼Œç¡®è®¤è¯¥å­—èŠ‚å‘é€å®Œæˆå¹¶æ”¶åˆ°äº†ä»è®¾å¤‡çš„ACKæ—¶æ‰ç»§ç»­å‘DRå†™å…¥ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ ·èƒ½åœ¨æŸä¸ªå­—èŠ‚æ”¶åˆ°ä¸æœŸæœ›çš„NACKæ—¶åšä¸€äº›å¼‚å¸¸å¤„ç†ã€‚</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203192337639.png" alt="image-20241203192337639"></p>
<p>æ‰‹å†Œä¸­å‘é€æ—¶åºå›¾ä¹Ÿæåˆ°äº†è¿™ä¸€ç‚¹ï¼ˆå‚è€ƒEV_8ï¼‰ï¼Œå¦‚æœé‡‡ç”¨è½®è¯¢TXEçš„æ–¹å¼è¿ç»­å‘é€å¤šä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨DRä¸ºç©ºï¼Œç§»ä½å¯„å­˜å™¨ï¼ˆéç©ºï¼‰æ—¶ï¼Œå°†ä¸‹ä¸ªå­—èŠ‚å†™å…¥DRä»¥æ¸…é™¤TXEã€‚å¦‚æœæ— æ³•å®ç°è¯¥æ“ä½œåºåˆ—ï¼Œåˆ™å»ºè®®è½®è¯¢BTFæ¥ä»£æ›¿TXEä»¥é¿å…é™ä½é€šä¿¡æ•ˆç‡ã€‚</p>
<h4 id="shi-li-dai-ma-bu-deng-dai-mei-ge-zi-jie-de-ack-jie-guo">ç¤ºä¾‹ä»£ç -ä¸ç­‰å¾…æ¯ä¸ªå­—èŠ‚çš„ACKç»“æœ</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…å‘é€ç¼“å†²åŒºéç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait TXE timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†æ•°æ®ä¼ è¾“åˆ°å‘é€ç¼“å†²åŒºï¼ŒåŒæ—¶è¯»SR1è·Ÿéšä¸€ä¸ªå†™DRå°†æ¸…é™¤TXEæ ‡å¿—</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="shi-li-dai-ma-deng-dai-mei-ge-zi-jie-de-ack-jie-guo">ç¤ºä¾‹ä»£ç -ç­‰å¾…æ¯ä¸ªå­—èŠ‚çš„ACKç»“æœ</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…å‘é€ç¼“å†²åŒºéç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait TXE timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†æ•°æ®ä¼ è¾“åˆ°å‘é€ç¼“å†²åŒºï¼ŒåŒæ—¶è¯»SR1è·Ÿéšä¸€ä¸ªå†™DRå°†æ¸…é™¤TXEæ ‡å¿—</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> data<span class="token punctuation">;</span>

    <span class="token comment">// ç­‰å¾…å½“å‰å­—èŠ‚ä¼ è¾“å®Œæˆä¸”æ”¶åˆ°ACKï¼ˆå¯é€‰ï¼Œå¯ä»¥åœ¨è¶…æ—¶æ—¶é’ˆå¯¹å½“å‰å­—èŠ‚çš„NACKåšå¼‚å¸¸å¤„ç†ï¼‰</span>
    timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_BTF<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait BTF timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨æ¸…é™¤BTFï¼Œä¸‹ä¸€ä¸ªå­—èŠ‚çš„å†™DRä¼šæ¸…é™¤BTFï¼Œåœæ­¢ä¿¡å·ä¹Ÿä¼šæ¸…é™¤BTF</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-ting-zhi-xin-hao-fa-song-mo-shi-xia">å‘é€åœæ­¢ä¿¡å·ï¼ˆå‘é€æ¨¡å¼ä¸‹ï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203194648097.png" alt="image-20241203194648097"></p>
<p>åœ¨å‘DRå†™å…¥æœ€åä¸€ä¸ªæ•°æ®å­—èŠ‚åï¼Œè½¯ä»¶å¯ä»¥äº§ç”Ÿä¸€ä¸ªåœæ­¢ä¿¡å·ï¼Œå¤–è®¾ä¼šè‡ªåŠ¨è¿”å›ä»è®¾å¤‡æ¨¡å¼ã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p>äº§ç”Ÿåœæ­¢ä¿¡å·çš„æ—¶æœºåº”è¯¥åœ¨æ£€æŸ¥åˆ°TXEæˆ–BTFè¢«ç½®ä½ä¹‹åã€‚</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203194909773.png" alt="image-20241203194909773"></p>
<p>è®¾ç½®è¯¥ä½åï¼Œåœ¨å½“å‰å­—èŠ‚ä¼ è¾“å®Œæˆä¹‹åæˆ–å½“å‰èµ·å§‹ä¿¡å·å‘é€ä¹‹åå°†ä¼šäº§ç”Ÿåœæ­¢ä¿¡å·ã€‚</p>
<h4 id="shi-li-dai-ma-3">ç¤ºä¾‹ä»£ç </h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…æ¡ä»¶: å‘é€ç¼“å†²åŒºä¸ºç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zhu-she-bei-jie-shou-shu-ju">ä¸»è®¾å¤‡æ¥æ”¶æ•°æ®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203195407265.png" alt="image-20241203195407265"></p>
<p>åœ¨ä»¥å†™æ¨¡å¼å‘é€ä»è®¾å¤‡åœ°å€ï¼Œå¹¶æ¸…é™¤ADDRæ ‡å¿—åï¼ŒI2Cå¤–è®¾ä¼šè¿›å…¥ä¸»è®¾å¤‡æ¥æ”¶æ¨¡å¼ã€‚</p>
<p>åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œå¤–è®¾é€šè¿‡å†…éƒ¨ç§»ä½å¯„å­˜å™¨ä»SDAæ€»çº¿æ¥æ”¶å­—èŠ‚åˆ°DRä¸­ã€‚åœ¨æ¥æ”¶åˆ°æ¯ä¸ªå­—èŠ‚åï¼Œå¤–è®¾ä¼šäº§ç”Ÿå¦‚ä¸‹æ“ä½œåºåˆ—ï¼š</p>
<ol>
<li>å¦‚æœè®¾ç½®äº†CR1ä¸­çš„ACK=1ï¼Œå¤–è®¾ä¼šè‡ªåŠ¨å“åº”ACKè„‰å†²</li>
<li>SR1ä¸­çš„RXNEä¼šè¢«ç¡¬ä»¶ç½®ä½ï¼Œå¹¶äº§ç”Ÿä¸­æ–­ï¼ˆå¦‚æœä½¿èƒ½äº†ä¸­æ–­ï¼‰</li>
</ol>
<p>å¦‚æœRXNEè¢«ç½®ä½ï¼Œå¹¶ä¸”DRä¸­çš„æ•°æ®åœ¨æœ€è¿‘ä¸€æ¬¡æ¥æ”¶æ•°æ®å®Œæˆä¹‹å‰è¿˜æ²¡æœ‰è¢«è¯»å–ï¼Œæ­¤æ—¶æ¥æ”¶åˆ°çš„æ•°æ®æ— æ³•å­˜å…¥DRï¼Œé‚£ä¹ˆBTFä¼šè¢«ç¡¬ä»¶ç½®ä½ã€‚å¤–è®¾ä¼šå»¶ä¼¸SCLä½ç”µå¹³ï¼ˆæ€»çº¿æŒ‚èµ·ï¼‰ï¼Œç›´åˆ°BTFè¢«æ¸…é™¤ï¼ˆä¸€ä¸ªè¯»SR1æ“ä½œåè·Ÿéšä¸€ä¸ªè¯»DRæ“ä½œï¼‰</p>
<h4 id="shi-li-dai-ma-4">ç¤ºä¾‹ä»£ç </h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_ReceiveByte timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> I2C2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="xiang-ying-ack-nack">å“åº”ACK/NACK</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203201826539.png" alt="image-20241203201826539"></p>
<p>å°†ACKè®¾ç½®ä¸º1åï¼Œå¤–è®¾ä¼šå¯¹æ¯ä¸ªæ¥æ”¶åˆ°çš„å­—èŠ‚å“åº”ACKã€‚å¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™å¯¹æ¯ä¸ªæ¥æ”¶åˆ°çš„å­—èŠ‚å“åº”NACKã€‚</p>
<h4 id="shi-li-dai-ma-5">ç¤ºä¾‹ä»£ç ï¼š</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="fa-song-ting-zhi-xin-hao-jie-shou-mo-shi-xia">å‘é€åœæ­¢ä¿¡å·ï¼ˆæ¥æ”¶æ¨¡å¼ä¸‹ï¼‰</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="zhu-she-bei-jie-shou-liu-cheng">ä¸»è®¾å¤‡æ¥æ”¶æµç¨‹</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241203202947534.png" alt="image-20241203202947534"></p>
<p>å¦‚æœè¯¥ä»»åŠ¡æœ‰æœ€é«˜ä¼˜å…ˆçº§å¯ä»¥ä½¿ç”¨è¯¥æ–¹å¼ä¸€ã€‚</p>
<p>ä¸»è®¾å¤‡éœ€è¦é’ˆå¯¹ä»è®¾å¤‡æ¥æ”¶çš„æœ€åä¸€ä¸ªå­—èŠ‚å‘é€NACKã€‚ä»è®¾å¤‡åœ¨æ”¶åˆ°è¯¥NACKåï¼Œä¼šé‡Šæ”¾å¯¹SCLå’ŒSDAæ€»çº¿çš„æ§åˆ¶ã€‚æ¥ç€ä¸»è®¾å¤‡å°±å¯ä»¥å‘é€åœæ­¢ä¿¡å·æˆ–é‡æ–°å¼€å§‹ä¿¡å·ã€‚</p>
<ol>
<li>ä¸ºäº†åœ¨æ¥æ”¶åˆ°æœ€åä¸€ä¸ªå­—èŠ‚åäº§ç”ŸNACKè„‰å†²ï¼Œå¿…é¡»æ°å¥½åœ¨è¯»å€’æ•°ç¬¬äºŒä¸ªæ•°æ®å­—èŠ‚æ—¶ï¼ˆåœ¨å€’æ•°ç¬¬äºŒä¸ªRXNEäº‹ä»¶å‘ç”Ÿæ—¶ï¼‰å°†ACKæ¸…é›¶ã€‚å¦åˆ™æœ€åä¸€ä¸ªå­—èŠ‚ä¼ è¾“ç»“æŸæ—¶ï¼ŒACKå¦‚æœæ²¡æœ‰æ¸…é›¶ï¼Œå¤–è®¾å°±ä¼šè‡ªåŠ¨å“åº”ACKã€‚</li>
<li>ä¸ºäº†äº§ç”Ÿåœæ­¢/é‡æ–°å¼€å§‹ä¿¡å·ï¼Œè½¯ä»¶å¿…é¡»æ°å¥½åœ¨è¯»å€’æ•°ç¬¬äºŒä¸ªæ•°æ®å­—èŠ‚æ—¶ï¼ˆåœ¨å€’æ•°ç¬¬äºŒä¸ªRXNEäº‹ä»¶å‘ç”Ÿæ—¶ï¼‰å°†STOP/STARTç½®ä½ã€‚</li>
<li>å¦‚æœåªéœ€è¦æ¥æ”¶ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆåº”è¯¥åœ¨ç´§è·Ÿç€å‘é€è®¾å¤‡åœ°å€å¹¶æ¸…é™¤ADDRä¹‹åå°†ACKæ¸…é›¶å¹¶ç½®ä½STOPã€‚</li>
</ol>
<p>åœ¨åœæ­¢ä¿¡å·äº§ç”Ÿä¹‹åï¼Œå¤–è®¾å°†è‡ªåŠ¨å›åˆ°ä»è®¾å¤‡æ¨¡å¼ï¼ˆSCL/SDAä¸ºé‡Šæ”¾çŠ¶æ€ï¼‰ã€‚</p>
<h3 id="shi-li-dai-ma-6">ç¤ºä¾‹ä»£ç </h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="wan-zheng-dai-ma-1">å®Œæ•´ä»£ç </h2>
<h3 id="i-2-c-hard-h">i2c_hard.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="i-2-c-hard-c">i2c_hard.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_hard.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMEOUT_COUNT</span> <span class="token expression"><span class="token number">0xFFFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OK</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FAIL</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token keyword">void</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. GPIOæ—¶é’Ÿé…ç½®</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPBEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_I2C2EN<span class="token punctuation">;</span>

    <span class="token comment">// 2. é…ç½®GPIOå·¥ä½œæ¨¡å¼ä¸ºå¤ç”¨å¼€æ¼è¾“å‡º mode=11 cnf=11</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE11 <span class="token operator">|</span> GPIO_CRH_CNF11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOB<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_CRH_MODE10 <span class="token operator">|</span> GPIO_CRH_CNF10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç‰¹åˆ«æ³¨æ„ï¼Œå¦‚ä¸‹æ“ä½œæ— æ³•å¾—åˆ°é¢„æœŸç»“æœï¼ŒGPIOå·¥ä½œä¸æ­£å¸¸</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_CNF10 | GPIO_CRH_CNF11);</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE10 | GPIO_CRH_MODE11);</span>
    <span class="token comment">// å¦‚ä¸‹åˆ™æ˜¯å¯ä»¥çš„</span>
    <span class="token comment">// GPIOB-&gt;CRH |= (GPIO_CRH_MODE11 | GPIO_CRH_CNF11 | GPIO_CRH_MODE10 |</span>
    <span class="token comment">// GPIO_CRH_CNF10);</span>

    <span class="token comment">// 3. é…ç½®å¤–è®¾ä¸ºI2Cæ¨¡å¼ï¼ˆé»˜è®¤å°±æ˜¯I2Cæ¨¡å¼ï¼Œ1-SMBUSæ¨¡å¼ï¼‰</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_SMBUS<span class="token punctuation">;</span>

    <span class="token comment">// 4. é…ç½®å¤–è®¾æ—¶é’Ÿ</span>
    I2C2<span class="token operator">-&gt;</span>CR2 <span class="token operator">|=</span> <span class="token number">36</span><span class="token punctuation">;</span> <span class="token comment">// å¿…é¡»å°äºç­‰äºAPB1çš„æœ€å¤§æ—¶é’Ÿé¢‘ç‡36MHz</span>

    <span class="token comment">// 5. é…ç½®å¤–è®¾æ¨¡å¼ï¼šI2Cæ ‡å‡†æ¨¡å¼ï¼ˆ100kHzï¼‰ã€SCLæ—¶é’Ÿé¢‘ç‡ï¼ˆ100kHzï¼‰</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CCR_FS<span class="token punctuation">;</span> <span class="token comment">// æ ‡å‡†æ¨¡å¼</span>
    I2C2<span class="token operator">-&gt;</span>CCR <span class="token operator">|=</span> <span class="token number">180</span><span class="token punctuation">;</span> <span class="token comment">// SCLé«˜ä½ç”µå¹³å‘¨æœŸ5us / å¤–è®¾æ—¶é’Ÿå‘¨æœŸ(1/36us) = 5 * 36</span>

    <span class="token comment">// 6. é…ç½®TRISE-SCLæœ€å¤§ä¸Šå‡æ—¶é—´</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_TRISE_TRISE<span class="token punctuation">;</span> <span class="token comment">// æ¸…é›¶</span>
    I2C2<span class="token operator">-&gt;</span>TRISE <span class="token operator">|=</span>
        <span class="token number">37</span><span class="token punctuation">;</span> <span class="token comment">// I2Cæ ‡å‡†æ¨¡å¼æœ€å¤§ä¸Šå‡æ—¶é—´1us / å¤–è®¾æ—¶é’Ÿå‘¨æœŸ(1/36us) + 1 = 36 + 1</span>

    <span class="token comment">// 7. ä½¿èƒ½å¤–è®¾</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_PE<span class="token punctuation">;</span> <span class="token comment">// Peripheral(I2C) Enable</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº§ç”Ÿèµ·å§‹ä¿¡å·ï¼ˆå½“BUSY=1æ—¶ä¸ä¼šç«‹å³äº§ç”Ÿï¼‰</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_START<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// èµ·å§‹ä¿¡å·äº§ç”Ÿåï¼Œç”±ç¡¬ä»¶ç½®ä½SB</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_SB<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_Start timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç´§æ¥ç€å‘é€è®¾å¤‡åœ°å€ä¼šå†™DRï¼Œè¯»SR1å†™DRåºåˆ—ä¼šæ¸…é™¤SBï¼Œå› æ­¤è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨æ¸…é™¤SB</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// äº§ç”Ÿèµ·å§‹ä¿¡å·åï¼ŒDRè‚¯å®šä¸ºç©ºï¼Œå¯ä»¥å°†ä»è®¾å¤‡åœ°å€ç›´æ¥å†™å…¥DR</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> addr<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…ç¡¬ä»¶ç½®ä½ADDRï¼ˆè¡¨æ˜ä»è®¾å¤‡åœ°å€ä»¥å‘å‡ºå¹¶æ”¶åˆ°äº†ç›¸åº”ä»è®¾å¤‡çš„ACKï¼‰</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_ADDR<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendAddr timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¸…é™¤ADDRæ ‡å¿—ä½æ“ä½œåºåˆ—ï¼šè¯»SR1åè·Ÿéšä¸€ä¸ªè¯»SR2</span>
    I2C2<span class="token operator">-&gt;</span>SR2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…å‘é€ç¼“å†²åŒºéç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait TXE timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†æ•°æ®ä¼ è¾“åˆ°å‘é€ç¼“å†²åŒºï¼ŒåŒæ—¶è¯»SR1è·Ÿéšä¸€ä¸ªå†™DRå°†æ¸…é™¤TXEæ ‡å¿—</span>
    I2C2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> data<span class="token punctuation">;</span>

    <span class="token comment">// ç­‰å¾…å½“å‰å­—èŠ‚ä¼ è¾“å®Œæˆä¸”æ”¶åˆ°ACKï¼ˆå¯é€‰ï¼Œå¯ä»¥åœ¨è¶…æ—¶æ—¶é’ˆå¯¹å½“å‰å­—èŠ‚çš„NACKåšå¼‚å¸¸å¤„ç†ï¼‰</span>
    timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_BTF<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_SendByte wait BTF timeout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨æ¸…é™¤BTFï¼Œä¸‹ä¸€ä¸ªå­—èŠ‚çš„å†™DRä¼šæ¸…é™¤BTFï¼Œåœæ­¢ä¿¡å·ä¹Ÿä¼šæ¸…é™¤BTF</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…æ¡ä»¶: å‘é€ç¼“å†²åŒºä¸ºç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_STOP<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> TIMEOUT_COUNT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>I2C2<span class="token operator">-&gt;</span>SR1 <span class="token operator">&amp;</span> I2C_SR1_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG_ERROR</span><span class="token punctuation">(</span><span class="token string">"I2C_ReceiveByte timeout, timeout = %d"</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> I2C2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> I2C2<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>I2C_CR1_ACK<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span><span class="token number">0xA0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="eeprom">EEPROM</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_hard.h"</span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __M24C02_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_W</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_R</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">I2C_Stop4Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait for write cycle</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span>DEV_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendAddr</span><span class="token punctuation">(</span>DEV_ADDR_R<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EnableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_DisableAutoAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">I2C_EnableStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">I2C_ReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"b1 = %d, b2 = %d, b3 = %d"</span><span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">)</span>

    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"56789"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"12345"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buffer = %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="kuo-zhan-btf-biao-zhi-wei-de-zuo-yong">æ‰©å±•ï¼šBTFæ ‡å¿—ä½çš„ä½œç”¨</h2>
<p><code>BTF</code> (Byte Transfer Finished) æ ‡å¿—ä½çš„ä½œç”¨æ˜¯æŒ‡ç¤ºå½“å‰<strong>å­—èŠ‚ä¼ è¾“å®Œæˆ</strong>ï¼ŒåŒ…æ‹¬å‘é€å’Œæ¥æ”¶åœºæ™¯ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªç¡¬ä»¶çŠ¶æ€ä½ï¼Œåæ˜ äº†æ•°æ®å¯„å­˜å™¨ï¼ˆ<code>DR</code>ï¼‰å’Œç§»ä½å¯„å­˜å™¨ä¹‹é—´çš„æ•°æ®ä¼ è¾“çŠ¶æ€ã€‚</p>
<h3 id="strong-btf-de-ding-yi-yu-zuo-yong-strong"><strong>BTF çš„å®šä¹‰ä¸ä½œç”¨</strong></h3>
<ol>
<li><strong>å®šä¹‰</strong>ï¼š
<ul>
<li>å½“ç§»ä½å¯„å­˜å™¨ä¸­å½“å‰æ•°æ®å­—èŠ‚çš„ä¼ è¾“å®Œæˆï¼ˆæ— è®ºæ˜¯å‘é€è¿˜æ˜¯æ¥æ”¶ï¼‰ï¼Œå¹¶ä¸”æ•°æ®å¯„å­˜å™¨ï¼ˆ<code>DR</code>ï¼‰ä¸ºç©ºæ—¶ï¼Œç¡¬ä»¶ä¼šè®¾ç½® <code>BTF</code> æ ‡å¿—ä½ã€‚</li>
<li>å¦‚æœåœ¨æ¥æ”¶æ¨¡å¼ä¸­ï¼Œ<code>DR</code> ä¸­çš„æ•°æ®æœªè¢«è¯»å–ï¼Œæˆ–è€…åœ¨å‘é€æ¨¡å¼ä¸­æ–°çš„æ•°æ®æœªè¢«å†™å…¥ï¼ŒI2C å¤–è®¾ä¼šæ‹‰ä½æ—¶é’Ÿçº¿ï¼ˆSCLï¼‰ï¼Œå³ <strong>â€œæ€»çº¿æŒ‚èµ·â€</strong>ï¼Œä»¥ç­‰å¾…è½¯ä»¶å¤„ç†ã€‚</li>
</ul>
</li>
<li><strong>ä½œç”¨</strong>ï¼š
<ul>
<li>ç”¨äºåè°ƒä¸»æœºï¼ˆMCUï¼‰å’Œå¤–è®¾ä¹‹é—´çš„æ•°æ®æµï¼Œé¿å…æ•°æ®ä¸¢å¤±æˆ–é”™è¯¯ã€‚</li>
<li>æŒ‡ç¤ºæ˜¯å¦éœ€è¦è¯»å– <code>DR</code>ï¼ˆåœ¨æ¥æ”¶æ¨¡å¼ï¼‰æˆ–å†™å…¥ <code>DR</code>ï¼ˆåœ¨å‘é€æ¨¡å¼ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<h1 id="stm-32-cube-mx-shi-xian-eeprom-du-xie">STM32CubeMXå®ç°EEPROMè¯»å†™</h1>
<h2 id="cube-pei-zhi">Cubeé…ç½®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094331841.png" alt="image-20241204094331841"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094511416.png" alt="image-20241204094511416"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094540825.png" alt="image-20241204094540825"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094637054.png" alt="image-20241204094637054"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094700542.png" alt="image-20241204094700542"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094733818.png" alt="image-20241204094733818"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094745141.png" alt="image-20241204094745141"></p>
<h2 id="mdk-pei-zhi">MDKé…ç½®</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204094958368.png" alt="image-20241204094958368" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204095038798.png" alt="image-20241204095038798"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204095126110.png" alt="image-20241204095126110"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241204095213099.png" alt="image-20241204095213099" style="zoom:50%;">
<h2 id="shi-li-dai-ma-7">ç¤ºä¾‹ä»£ç </h2>
<h3 id="m-24-c-02-h-2">m24c02.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M24C02_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M24C02_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c.h"</span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __M24C02_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="m-24-c-02-c-2">m24c02.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_W</span> <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEV_ADDR_R</span> <span class="token expression"><span class="token number">0xA1</span></span></span>

<span class="token keyword">void</span> <span class="token function">M24C02_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_I2C_Mem_Write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hi2c2<span class="token punctuation">,</span> DEV_ADDR_W<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> I2C_MEMADD_SIZE_8BIT<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span>
                      size<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…EEPROMå†™å‘¨æœŸç»“æŸ</span>
    <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> byte<span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_I2C_Mem_Read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hi2c2<span class="token punctuation">,</span> DEV_ADDR_W<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> I2C_MEMADD_SIZE_8BIT<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span>
                     size<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token char">'a'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token char">'b'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token char">'c'</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b1 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b2 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> b3 <span class="token operator">=</span> <span class="token function">M24C02_ReadByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b1 = %d, b2 = %d, b3 = %d\n"</span><span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"56789"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_WriteBytes</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token string">"12345"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M24C02_ReadBytes</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buffer = %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="printf-zhong-ding-xiang">printfé‡å®šå‘</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c-1">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN Includes */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"m24c02.h"</span></span>
<span class="token comment">/* USER CODE END Includes */</span>  

<span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_I2C2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">M24C02_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>åè®®</category>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>I2C</tag>
        <tag>IÂ²C</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£UARTä¸²å£é€šä¿¡ï¼ˆåŸºäºSTM32F103ï¼‰</title>
    <url>/2024/11/28/38060.html</url>
    <content><![CDATA[<h1 id="can-kao-shou-ce">å‚è€ƒæ‰‹å†Œ</h1>
<ul>
<li><a href="https://www.st.com.cn/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">STM32F101xx, STM32F102xx, STM32F103xx, STM32F105xx and STM32F107xx advanced ArmÂ®-based 32-bit MCUs</a></li>
<li><a href="https://www.zanwen.icu/2024/11/27/59863.html">ä»æŒ‰é”®æ§åˆ¶LEDå¼€å§‹æ·±å…¥ç†è§£å¤–éƒ¨ä¸­æ–­ï¼ˆåŸºäºSTM32F103ZEï¼‰</a></li>
</ul>
<h1 id="usart-kuang-tu-fen-xi">USARTæ¡†å›¾åˆ†æ</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128192635013.png" alt="image-20241128192635013"></p>
<blockquote>
<p><a href="https://www.st.com.cn/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">STM32F101xx, STM32F102xx, STM32F103xx, STM32F105xx and STM32F107xx advanced ArmÂ®-based 32-bit MCUs</a> P789</p>
</blockquote>
<h2 id="fa-song-jie-shou-yin-jiao">å‘é€/æ¥æ”¶å¼•è„š</h2>
<h3 id="fa-song-jie-shou-yin-jiao-shuo-ming">å‘é€/æ¥æ”¶å¼•è„šè¯´æ˜</h3>
<blockquote>
<p>RX: Receive Data Input is the serial data input. Oversampling techniques are used for data recovery by discriminating between valid incoming data and noise.</p>
<p>TX: Transmit Data Output. When the transmitter is disabled, the output pin returns to its IO port configuration. When the transmitter is enabled and nothing is to be transmitted, the TX pin is at high level. In single-wire and smartcard modes, this IO is used to transmit and receive the data (at USART level, data are then received on SW_RX)</p>
</blockquote>
<ul>
<li>RXï¼šä¸²è¡Œæ•°æ®è¾“å…¥å¼•è„šã€‚</li>
<li>TXï¼šå‘é€æ•°æ®è¾“å‡ºå¼•è„šã€‚å½“å‘é€å™¨æ²¡æœ‰å¯ç”¨æ—¶ï¼Œè¿™ä¸ªè¾“å‡ºå¼•è„šå……å½“é€šç”¨çš„GPIOå¼•è„šï¼›å½“å¯ç”¨å‘é€å™¨å¹¶ä¸”æ²¡æœ‰å†…å®¹è¢«å‘é€æ˜¯ä»€æ—¶ï¼Œè¯¥å¼•è„šä¿æŒé«˜ç”µå¹³ã€‚åœ¨å•çº¿æ ¸æ™ºèƒ½å¡æ¨¡å¼ä¸‹ï¼Œè¯¥å¼•è„šè¢«ç”¨æ¥å‘é€å’Œæ¥æ”¶æ•°æ®ï¼ˆè™½ç„¶ç‰©ç†ä¸Šæ˜¯ç”¨çš„ä¸€ä¸ªå¼•è„šï¼Œä½†åœ¨USARTå†…éƒ¨ï¼Œæ•°æ®æ¥æ”¶æ˜¯é€šè¿‡SW_RXé€»è¾‘é€šé“æ¥å®Œæˆçš„ï¼‰ã€‚</li>
</ul>
<h3 id="gpio-fu-yong">GPIOå¤ç”¨</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128195845755.png" alt="image-20241128195845755"></p>
<blockquote>
<p>[!NOTE]</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šRXå¤ç”¨IOå¼•è„šæ—¶ï¼ŒIOå£çš„è¯»é€šé“ä»ç„¶æ˜¯è¿é€šçš„ï¼›ä½†æ˜¯TXå¤ç”¨IOå¼•è„šæ—¶ï¼ŒIOå£çš„å†™é€šé“æ˜¯æ–­å¼€çš„ï¼Œè¿™æ„å‘³ç€è¯¥IOå¼•è„šå®Œå…¨ç”±å¯¹åº”çš„å¤ç”¨å¤–è®¾ï¼ˆä¾‹å¦‚USARTï¼‰æ¥æ“æ§äº†ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆæˆ‘è¦æ€ä¹ˆçŸ¥é“USARTå¤ç”¨å“ªä¸ªå¼•è„šå‘¢ï¼Ÿè¿™ä¸ªåœ¨GPIOå¤ç”¨åŠŸèƒ½ç« èŠ‚ï¼ˆ9.3.8 USART alternate function remappingï¼‰èƒ½å¤Ÿæ‰¾åˆ°ç›¸åº”çš„è¯´æ˜ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128200513629.png" alt="image-20241128200513629"></p>
<p>é»˜è®¤ä½¿ç”¨PA9/10ä½œä¸ºUSART1çš„TX/RXï¼Œå¦‚æœéœ€è¦è¿˜å¯ä»¥é€šè¿‡AFIOé‡æ˜ å°„å°†å…¶é…ç½®ä¸ºPB6/7ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128200656325.png" alt="image-20241128200656325"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128200735197.png" alt="image-20241128200735197"></p>
<h3 id="gpio-mo-shi-pei-zhi">GPIOæ¨¡å¼é…ç½®</h3>
<p>ç°åœ¨USARTä½¿ç”¨å¼•è„šæˆ‘ä»¬çŸ¥é“äº†ï¼Œé‚£ä¹ˆå¼•è„šè¯¥é…ç½®ä»€ä¹ˆå·¥ä½œæ¨¡å¼å‘¢ï¼Œåœ¨GPIOå¤–è®¾é…ç½®ç« èŠ‚ï¼ˆ9.1.11 GPIO configurations for device peripheralsï¼‰ä¹Ÿæœ‰è¯´æ˜ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128200958021.png" alt="image-20241128200958021"></p>
<p>TXéœ€è¦é…ç½®ä¸ºå¤ç”¨æ¨æŒ½ï¼ŒRXéœ€è¦é…ç½®ä¸ºæµ®åŠ¨è¾“å…¥æˆ–ä¸Šæ‹‰è¾“å…¥</p>
<h2 id="rts-cts-yin-jiao">RTS/CTSå¼•è„š</h2>
<blockquote>
<p>The following pins are required in Hardware flow control mode:<br>
ï‚· CTS: Clear To Send blocks the data transmission at the end of the current transfer<br>
when high<br>
ï‚· RTS: Request to send indicates that the USART is ready to receive a data (when low)</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128201344123.png" alt="image-20241128201344123"></p>
<p>è¿™ä¸¤ä¸ªå¼•è„šåœ¨ç¡¬ä»¶æµæ§æ¨¡å¼ä¸­éœ€è¦è¢«ç”¨åˆ°ï¼ˆé€šä¿¡åŒæ–¹é€šè¿‡è¿™ä¸¤ä¸ªå¼•è„šæ¥äº’ç›¸åè°ƒæ•°æ®çš„å‘é€ï¼Œé¿å…ä¸€ä¸ªå‘é€å¤ªå¿«ï¼Œå¦ä¸€ä¸ªæ¥æ”¶ä¸è¿‡æ¥ï¼‰ï¼š</p>
<ul>
<li>RTSï¼ˆè¯·æ±‚å‘é€ï¼‰ï¼šç®­å¤´æ–¹å‘æ˜¯ä»å†…å‘å¤–çš„ï¼Œå’Œæ¥æ”¶æ§åˆ¶å™¨ç›¸è¿ã€‚å½“å‰ä¸²å£å¯ä»¥é€šè¿‡æ‹‰ä½è¯¥å¼•è„šæ¥å‘ŠçŸ¥å¯¹æ–¹å¯ä»¥å‘é€æ•°æ®äº†ï¼ˆå½“å‰MCUå‡†å¤‡å¥½æ¥æ”¶æ•°æ®äº†ï¼‰ã€‚</li>
<li>CTSï¼ˆæ¸…é™¤å‘é€ï¼Œå…è®¸å‘é€çš„æ¡ä»¶å·²ç»æ¸…é™¤ï¼‰ï¼šç®­å¤´æ–¹å‘æ˜¯ç”±å¤–å‘å†…çš„ï¼Œå’Œå‘é€æ§åˆ¶å™¨ç›¸è¿ã€‚å¯¹æ–¹å¯ä»¥é€šè¿‡æ‹‰é«˜è¯¥å¼•è„šæ¥å‘ŠçŸ¥å½“å‰ä¸²å£åœ¨å®Œæˆå½“å‰ä¼ è¾“ååœæ­¢æ•°æ®çš„å‘é€ï¼ˆå¯¹æ–¹æ¥æ”¶ä¸è¿‡æ¥äº†ï¼‰</li>
</ul>
<h3 id="ying-jian-liu-kong-zhi-liu-cheng">ç¡¬ä»¶æµæ§åˆ¶æµç¨‹ï¼š</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128204540542.png" alt="image-20241128204540542"></p>
<p>ä¸‹é¢ä»¥ä¸²å£Aè¦ç»™ä¸²å£Bå‘é€æ•°æ®ä¸ºä¾‹ï¼š</p>
<ul>
<li>ä¸²å£Aè¦ç»™Bå‘é€æ•°æ®æ—¶ï¼Œé¦–å…ˆä¼šé€šè¿‡Açš„CTSè¯»å–Bçš„RTSçŠ¶æ€ï¼Œå¦‚æœBå¯ä»¥æ¥æ”¶æ•°æ®ï¼Œé‚£ä¹ˆBä¼šæ‹‰ä½RTSï¼ˆè¯·æ±‚å‘é€ï¼‰ï¼Œè¯¥ä½ç”µå¹³çŠ¶æ€åœ¨Aéœ€è¦å‘é€æ•°æ®æ—¶å¯ä»¥é€šè¿‡CTSè¯»å–åˆ°ï¼š
<ul>
<li>è¯»åˆ°CTSä¸ºé«˜ï¼Œé‚£ä¹ˆè¯´æ˜Bæ‹‰é«˜äº†RTSï¼ˆå¯¹æ–¹å¿™ç¢Œï¼‰ï¼›å¦‚æœè¯»åˆ°CTSä¸ºä½ï¼Œé‚£ä¹ˆè¯´æ˜Bæ‹‰ä½äº†RTSï¼ˆå¯¹æ–¹ç©ºé—²ï¼‰</li>
</ul>
</li>
<li>Aé€šè¿‡CTSè¯»åˆ°ä½ç”µå¹³åï¼Œå°±å¼€å§‹å‘Bå‘é€æ•°æ®äº†ï¼Œå¦‚æœæŸä¸€æ—¶åˆ»å‘ç°CTSè¢«æ‹‰é«˜äº†ï¼Œè¯´æ˜Bå¤„ç†ä¸è¿‡æ¥äº†ï¼Œå› æ­¤ä¼šåœ¨å½“å‰å¸§ä¼ è¾“å®Œååœæ­¢åç»­æ•°æ®çš„å‘é€ï¼Œå½“Bé‡æ–°å°†RTSç½®ä¸ºä½ç”µå¹³æ—¶ç»§ç»­ä¼ è¾“å‰©ä½™å¸§ï¼Œé‡å¤è¿™ä¸€ä¸ªè¿‡ç¨‹ç›´åˆ°æ‰€æœ‰å¸§ä¼ è¾“å®Œæˆã€‚</li>
</ul>
<h2 id="ck-yin-jiao">CKå¼•è„š</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128204932608.png" alt="image-20241128204932608"></p>
<p>è¯¥å¼•è„šåœ¨åŒæ­¥ä¼ è¾“æ¨¡å¼ä¸‹ç”¨äºæ—¶é’Ÿä¿¡å·çš„ä¼ è¾“ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128205127278.png" alt="image-20241128205127278"></p>
<p>å…¶ä¸­UART4å’ŒUART5æ˜¯ä¸æ”¯æŒåŒæ­¥æ¨¡å¼çš„ã€‚</p>
<h1 id="usart-shu-ju-zheng-fen-xi">USARTæ•°æ®å¸§åˆ†æ</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128205612552.png" alt="image-20241128205612552"></p>
<h2 id="shu-ju-wei-zi-chang">æ•°æ®ä½å­—é•¿</h2>
<blockquote>
<p>Word length may be selected as being either 8 or 9 bits by programming the M bit in the USART_CR1 register (see Figure 280).</p>
</blockquote>
<p>å­—é•¿å¯ä»¥é€‰æ‹©8bitæˆ–9bitï¼Œå¯ä»¥é€šè¿‡USART_CR1å¯„å­˜å™¨ä¸­çš„Mä½æ¥è®¾ç½®ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128205946525.png" alt="image-20241128205946525"></p>
<h2 id="qi-shi-wei-he-ting-zhi-wei">èµ·å§‹ä½å’Œåœæ­¢ä½</h2>
<blockquote>
<p>The TX pin is in low state during the start bit. It is in high state during the stop bit</p>
</blockquote>
<p>å‘é€å¼•è„šåœ¨èµ·å§‹ä½ä¿æŒä½ç”µå¹³ï¼Œåœ¨åœæ­¢ä½ä¿æŒé«˜ç”µå¹³</p>
<h2 id="kong-xian-zheng">ç©ºé—²å¸§</h2>
<blockquote>
<p>An Idle character is interpreted as an entire frame of â€œ1â€s followed by the start bit of the next frame which contains data (The number of â€œ1â€ â€˜s will include the number of stop bits).</p>
</blockquote>
<p>ç©ºé—²å¸§æ˜¯æŒ‡æ¯”ç‰¹ä½å…¨ä¸º1çš„å¸§ï¼Œå¸§çš„é•¿åº¦åŒ…æ‹¬èµ·å§‹æ¯”ç‰¹ä½ã€å­—é•¿ã€åœæ­¢ä½ï¼ˆå¯¹åº”æ¯”ç‰¹ä½æ•°é‡ä¸å›ºå®šï¼‰</p>
<h2 id="bo-te-lu-he-shi-zhong">æ³¢ç‰¹ç‡å’Œæ—¶é’Ÿ</h2>
<blockquote>
<p>Transmission and reception are driven by a common baud rate generator, the clock for each is generated when the enable bit is set respectively for the transmitter and receiver.</p>
</blockquote>
<p>å‘é€å’Œæ¥æ”¶æ˜¯ç”±ä¸€ä¸ªé€šç”¨çš„æ³¢ç‰¹ç‡å‘ç”Ÿå™¨æ¥é©±åŠ¨çš„ï¼Œ</p>
<h1 id="fa-song-qi">å‘é€å™¨</h1>
<h2 id="di-wei-you-xian-amp-di-ceng-fa-song-liu-cheng">ä½ä½ä¼˜å…ˆ&amp;åº•å±‚å‘é€æµç¨‹</h2>
<blockquote>
<p>[!IMPORTANT]</p>
<p>During a USART transmission, data shifts out least significant bit first on the TX pin.</p>
<p>In thismode, the USART_DR register consists of a buffer (TDR) between the internal bus and the transmit shift register (see Figure 279)</p>
</blockquote>
<p>åœ¨ä¸€æ¬¡USARTä¼ è¾“ä¸­ï¼Œæ•°æ®é€šè¿‡TXå¼•è„šä½ä½ä¼˜å…ˆç§»ä½å‘é€å‡ºå»çš„ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼ŒUSART_DRè¡¨ç°ä¸ºä¸€ä¸ªä½äºå†…éƒ¨æ€»çº¿å’Œç§»ä½å¯„å­˜å™¨ä¹‹é—´çš„å‘é€ç¼“å†²åŒºï¼ˆTDRï¼‰ï¼Œå†™å…¥USART_DRçš„æ•°æ®ä¼šå…ˆè¢«å†™å…¥TDRï¼Œç„¶ååœ¨ç¡¬ä»¶çš„æ”¯æŒä¸‹é€šè¿‡ç§»ä½å¯„å­˜å™¨é€ä½å‘é€å‡ºå»ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128212821427.png" alt="image-20241128212821427"></p>
<h2 id="ke-pei-zhi-de-ting-zhi-wei-kuan-du">å¯é…ç½®çš„åœæ­¢ä½å®½åº¦</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128213716372.png" alt="image-20241128213716372"></p>
<p>åœæ­¢ä½é»˜è®¤å ä¸€ä¸ªbitï¼Œå¯ä»¥é€šè¿‡USART_CR2å¯„å­˜å™¨é…ç½®ä¸ºå…¶ä»–çš„æ¯”ç‰¹ä½å®½ï¼Œä»¥æ”¯æŒä¸åŒçš„ä¸²å£é€šä¿¡æ¨¡å¼ï¼ˆä¾‹å¦‚å•çº¿ã€è°ƒåˆ¶è§£è°ƒå™¨ã€æ™ºèƒ½å¡ç­‰ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128213822036.png" alt="image-20241128213822036"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128214412870.png" alt="image-20241128214412870"></p>
<h2 id="txe-biao-zhi-chuan-shu-huan-chong-qu-wei-kong">TXEæ ‡å¿—ï¼ˆä¼ è¾“ç¼“å†²åŒºä¸ºç©ºï¼‰</h2>
<blockquote>
<p>The TXE bit is always cleared by a write to the data register.The TXE bit is set by hardware and it indicates:<br>
ï‚· The data has been moved from TDR to the shift register and the data transmission has<br>
started.<br>
ï‚· The TDR register is empty.<br>
ï‚· The next data can be written in the USART_DR register without overwriting the<br>
previous data.</p>
<p>This flag generates an interrupt if the TXEIE bit is set.</p>
</blockquote>
<p>USART_SRå¯„å­˜å™¨ä¸­TXEæ ‡å¿—ï¼ˆTranmist Buffer Emptyï¼‰æ€»æ˜¯ç”±ä¸€ä¸ªå†™USART_DR å¯„å­˜å™¨çš„æ“ä½œæ¥æ¸…é™¤çš„ã€‚TXEç”±ç¡¬ä»¶ç½®ä½ï¼Œç”¨äºæŒ‡ç¤ºï¼š</p>
<ul>
<li>æ•°æ®å·²ç»ä»TDRä¼ é€åˆ°äº†ç§»ä½å¯„å­˜å™¨å¹¶ä¸”è¯¥æ•°æ®çš„å‘é€å·²ç»å¼€å§‹</li>
<li>TDRå¯„å­˜å™¨ä¸ºç©º</li>
<li>å¯ä»¥å°†å†™ä¸€ä¸ªæ•°æ®å†™å…¥USART_DRå¯„å­˜å™¨ï¼Œå¹¶ä¸”å…ˆå‰å†™å…¥çš„æ•°æ®ä¸ä¼šè¢«è¦†ç›–ï¼ˆå¯èƒ½æ­£åœ¨é€šè¿‡ç§»ä½å¯„å­˜å™¨é€ä½å‘é€ï¼Œä¹Ÿå¯èƒ½å·²ç»å‘é€å®Œæ¯•ï¼‰</li>
</ul>
<p>è¯¥æ ‡å¿—è¢«ç½®ä½æ—¶ä¼šäº§ç”Ÿä¸€ä¸ªTXEIEä¸­æ–­ï¼ˆå¦‚æœä½¿èƒ½äº†è¯¥ä¸­æ–­ï¼‰ã€‚</p>
<blockquote>
<p>When a transmission is taking place, a write instruction to the USART_DR register stores the data in the TDR register and which is copied in the shift register at the end of the current transmission</p>
</blockquote>
<p>å½“æ­£åœ¨è¿›è¡Œä¸€ä¸ªæ•°æ®çš„å‘é€æ—¶ï¼Œå‘USART_DRå†™å…¥æ•°æ®ä¼šå°†æ•°æ®å­˜å‚¨åˆ°TDRå¯„å­˜å™¨ä¸­ï¼Œå¹¶åœ¨å½“å‰ä¼ è¾“ç»“æŸåå°†å…¶æ‹·è´åˆ°ç§»ä½å¯„å­˜å™¨ä¸­ã€‚</p>
<blockquote>
<p>When no transmission is taking place, a write instruction to the USART_DR register places the data directly in the shift register, the data transmission starts, and the TXE bit is immediately set.</p>
</blockquote>
<p>å¦‚æœå½“å‰æ²¡æœ‰å‘é€æ•°æ®ï¼Œå‘USART_DRå†™å…¥æ•°æ®ä¼šç›´æ¥å°†æ•°æ®æ”¾åˆ°ç§»ä½å¯„å­˜å™¨ä¸­ï¼Œå¹¶ä¸”å¼€å§‹è¯¥æ•°æ®çš„ä¼ è¾“ï¼ŒåŒæ—¶TXEä¼šè¢«ç½®ä½ã€‚</p>
<h2 id="tc-biao-zhi-ying-jian-chuan-shu-wan-cheng-amp-chuan-shu-huan-chong-qu-wei-kong">TCæ ‡å¿—ï¼ˆç¡¬ä»¶ä¼ è¾“å®Œæˆ&amp;ä¼ è¾“ç¼“å†²åŒºä¸ºç©ºï¼‰</h2>
<blockquote>
<p>If a frame is transmitted (after the stop bit) and the TXE bit is set, the TC bit goes high. An interrupt is generated if the TCIE bit is set in the USART_CR1 register.</p>
</blockquote>
<p>å¦‚æœä¸€ä¸ªæ•°æ®å¸§ä¼ è¾“å®Œæˆï¼ˆåŒ…æ‹¬åœæ­¢ä½ï¼‰å¹¶ä¸”TXEè¢«ç½®ä½ï¼Œæ­¤æ—¶è¡¨æ˜äº†ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ç¡¬ä»¶æ²¡æœ‰æ­£åœ¨é€šè¿‡ç§»ä½å¯„å­˜å™¨ä¼ è¾“æ•°æ®</li>
<li>TDRç¼“å†²åŒºä¹Ÿæ²¡æœ‰å¸¦å‘é€çš„æ•°æ®</li>
</ul>
<p>æ­¤æ—¶ï¼ŒTCæ ‡å¿—ä¼šè¢«ç½®ä½ï¼ŒåŒæ—¶äº§ç”Ÿä¸€ä¸ªTCIEä¸­æ–­ï¼ˆå¦‚æœä½¿èƒ½äº†è¯¥ä¸­æ–­ï¼‰ã€‚è¿™é€šå¸¸æ ‡å¿—ç€ä¸€è¿ä¸²æ•°æ®å‘é€çš„å®Œæˆã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128221900956.png" alt="image-20241128221900956"></p>
<blockquote>
<p>[!WARNING]</p>
<p>After writing the last data into the USART_DR register, it is mandatory to wait for TC=1 before disabling the USART or causing the microcontroller to enter the low-power mode</p>
</blockquote>
<p>åœ¨å†™å…¥æœ€åä¸€ä¸ªæ•°æ®åˆ°DRå¯„å­˜å™¨åï¼Œå¦‚æœè¦ç¦ç”¨USARTæˆ–ä½¿MCUè¿›å…¥ä½åŠŸè€—æ¨¡å¼ä¹‹å‰ï¼Œåº”è¯¥è¦ç­‰TCè¢«ç½®ä½ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿åº•å±‚çš„ç¡¬ä»¶çœŸçš„å°†æ‰€æœ‰é€’äº¤åˆ°DRçš„æ•°æ®å‘é€å‡ºå»äº†ã€‚</p>
<blockquote>
<p>The TC bit is cleared by the following software sequence:</p>
<ol>
<li>A read from the USART_SR register</li>
<li>A write to the USART_DR register</li>
</ol>
</blockquote>
<p>TCæ ‡å¿—ä¼šè¢«å¦‚ä¸‹çš„è½¯ä»¶æ“ä½œåºåˆ—æ¸…é™¤ï¼š</p>
<ol>
<li>è¯»USART_SRå¯„å­˜å™¨</li>
<li>å†™USART_DR å¯„å­˜å™¨</li>
</ol>
<p>ä¾‹å¦‚æˆ‘ä»¬éœ€è¦ä¸€æ¬¡æ€§å‘é€å¤šä¸ªæ•°æ®å¸§ï¼Œä¼šä½¿ç”¨å¦‚ä¸‹è½®è¯¢çš„æ–¹å¼ï¼š</p>
<ol>
<li>ç­‰å¾…USART_SRä¸­çš„TXEè¢«ç½®ä½ï¼ˆéœ€è¦è½®è¯¢è¯»å–USART_SRä¸­çš„TXEä½å¹¶åˆ¤æ–­ï¼‰</li>
<li>TXEè¢«ç½®ä½åï¼Œå‘DRé€’äº¤ä¸‹ä¸€ä¸ªå¾…å‘é€çš„æ•°æ®</li>
</ol>
<h2 id="kong-xian-zheng-1">ç©ºé—²å¸§</h2>
<blockquote>
<p>Setting the TE bit drives the USART to send an idle frame before the first data frame.</p>
</blockquote>
<p><strong>TE bit</strong> æ˜¯ <strong>USART_CR1</strong>ï¼ˆUSARTæ§åˆ¶å¯„å­˜å™¨1ï¼‰ä¸­çš„ä¸€ä¸ªæ§åˆ¶ä½ï¼Œå…¨ç§°ä¸º <strong>Transmitter Enable</strong>ï¼Œå…¶ä½œç”¨æ˜¯å¯ç”¨ USART çš„å‘é€åŠŸèƒ½ã€‚å…·ä½“æ¥è¯´ï¼Œè®¾ç½® <strong>TE bit</strong> ä¼šä½¿ USART è¿›å…¥å‘é€æ¨¡å¼ï¼Œå¹¶ä¸”åœ¨å¼€å§‹ä¼ è¾“ç¬¬ä¸€ä¸ªæ•°æ®å¸§ä¹‹å‰ï¼Œå®ƒä¼šå…ˆå‘é€ä¸€ä¸ªç©ºé—²å¸§ï¼ˆidle frameï¼‰ã€‚</p>
<h3 id="strong-shi-yao-shi-kong-xian-zheng-idle-frame-strong"><strong>ä»€ä¹ˆæ˜¯ç©ºé—²å¸§ï¼ˆIdle Frameï¼‰ï¼Ÿ</strong></h3>
<p>ç©ºé—²å¸§æŒ‡çš„æ˜¯ä¸€ç§ <strong>æ²¡æœ‰æœ‰æ•ˆæ•°æ®</strong> çš„å¸§ï¼Œé€šå¸¸å®ƒæ˜¯ç”±é€»è¾‘ <strong>â€œ1â€</strong> ç»„æˆçš„ã€‚åœ¨ USART ä¸­ï¼Œè¿™ä¸ªç©ºé—²å¸§èµ·åˆ° <strong>ä¿¡å·ç¨³å®š</strong> å’Œ <strong>ä¼ è¾“å‡†å¤‡</strong> çš„ä½œç”¨ã€‚ç©ºé—²å¸§çš„å­˜åœ¨ç¡®ä¿äº†æ¥æ”¶ç«¯èƒ½å¤Ÿæ­£ç¡®åŒæ­¥åˆ°å³å°†å¼€å§‹çš„æœ‰æ•ˆæ•°æ®ä¼ è¾“ã€‚</p>
<h3 id="strong-ju-ti-gong-zuo-yuan-li-strong"><strong>å…·ä½“å·¥ä½œåŸç†</strong></h3>
<ol>
<li><strong>è®¾ç½® TE ä½</strong>ï¼šå½“ä½ é€šè¿‡è½¯ä»¶è®¾ç½® <strong>TE bit</strong>ï¼ˆå³ <strong>Transmitter Enable</strong> ä½ï¼‰æ—¶ï¼ŒUSART å°†è¢«å¯ç”¨ä¸º <strong>å‘é€æ¨¡å¼</strong>ï¼Œå¹¶å‡†å¤‡å¼€å§‹ä¼ è¾“æ•°æ®ã€‚</li>
<li><strong>å‘é€ç©ºé—²å¸§</strong>ï¼šåœ¨å¼€å§‹ä¼ è¾“æ•°æ®ä¹‹å‰ï¼ŒUSART ä¼šé¦–å…ˆå‘é€ä¸€ä¸ª <strong>ç©ºé—²å¸§</strong>ï¼ˆä¸€ä¸ªå…¨ä¸ºâ€œ1â€çš„é€»è¾‘å¸§ï¼‰ï¼Œè¿™ä¸ªç©ºé—²å¸§å¯ä»¥è¢«è§†ä¸ºâ€œå¼€å§‹â€ä¿¡å·ï¼Œå‘Šè¯‰æ¥æ”¶æ–¹æ¥ä¸‹æ¥ä¼šæœ‰æ•°æ®ä¼ è¾“ã€‚</li>
<li><strong>å‘é€æ•°æ®å¸§</strong>ï¼šä¸€æ—¦ç©ºé—²å¸§å‘é€å®Œæˆï¼ŒUSART å°±å¼€å§‹ä¼ è¾“ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å¸§ã€‚</li>
</ol>
<h3 id="strong-wei-shi-yao-yao-fa-song-kong-xian-zheng-strong"><strong>ä¸ºä»€ä¹ˆè¦å‘é€ç©ºé—²å¸§ï¼Ÿ</strong></h3>
<ul>
<li><strong>åŒæ­¥ä½œç”¨</strong>ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¥æ”¶è®¾å¤‡éœ€è¦ä¸€å®šçš„æ—¶é—´æ¥åŒæ­¥åˆ°å‘é€è®¾å¤‡çš„æ—¶é’Ÿã€‚ç©ºé—²å¸§ä¸ºæ¥æ”¶ç«¯æä¾›äº†åŒæ­¥çš„ä¿¡å·ï¼Œç¡®ä¿æ¥æ”¶è®¾å¤‡èƒ½å¤Ÿå‡†å¤‡å¥½æ¥æ”¶å³å°†ä¼ è¾“çš„æ•°æ®ã€‚</li>
<li><strong>ä¿¡å·ç¨³å®š</strong>ï¼šåœ¨æ•°æ®ä¼ è¾“å¼€å§‹ä¹‹å‰ï¼Œç©ºé—²å¸§æœ‰åŠ©äºç¡®ä¿ä¿¡å·çº¿å¤„äºç¨³å®šçŠ¶æ€ï¼Œä»¥ä¾¿æ¥æ”¶è®¾å¤‡èƒ½å¤Ÿå‡†ç¡®åœ°æ•è·æ•°æ®ã€‚</li>
<li><strong>æ—¶åºå‡†å¤‡</strong>ï¼šé€šè¿‡å‘é€ç©ºé—²å¸§ï¼Œå‘é€å™¨ç»™æ¥æ”¶å™¨ä¸€ä¸ªæ˜ç¡®çš„æŒ‡ç¤ºï¼Œè¡¨æ˜æ¥ä¸‹æ¥çš„æ•°æ®æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œä¸æ˜¯å™ªå£°æˆ–æ— æ•ˆæ•°æ®ã€‚</li>
</ul>
<h1 id="jie-shou-qi">æ¥æ”¶å™¨</h1>
<blockquote>
<p>The USART can receive data words of either 8 or 9 bits depending on the M bit in the USART_CR1 register.</p>
</blockquote>
<p>USRATå¯ä»¥æ¥æ”¶8æˆ–9ä¸ªbitå­—é•¿çš„æ•°æ®ï¼Œè¿™å–å†³äºUSART_CR1ä¸­Mä½çš„é…ç½®ã€‚</p>
<h2 id="qi-shi-wei-jian-ce">èµ·å§‹ä½æ£€æµ‹</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129091530313.png" alt="image-20241129091530313"></p>
<blockquote>
<p>In the USART, the start bit is detected when a specific sequence of samples is recognized. This sequence is: 1 1 1 0 X 0 X 0 X 0 0 0 0.</p>
<p>If the sequence is not complete, the start bit detection aborts and the receiver returns to the<br>
idle state (no flag is set) where it waits for a falling edge.</p>
</blockquote>
<p>åœ¨USARTä¸­ï¼Œå¦‚æœè¯†åˆ«åˆ° <code>1 1 1 0 X 0 X 0 X 0 0 0 0</code>æ¨¡å¼çš„ç‰¹å®šé‡‡æ ·åºåˆ—ï¼ˆXè¡¨ç¤ºä¸å…³å¿ƒæ˜¯0è¿˜æ˜¯1ï¼‰ï¼Œåˆ™è¡¨æ˜æ£€æµ‹åˆ°ä¸€ä¸ªæœ‰æ•ˆèµ·å§‹ä½ã€‚ï¼ˆ<code>1 1 1 0</code>è¡¨æ˜äº§ç”Ÿäº†ä¸€ä¸ªä¸‹é™æ²¿ï¼Œå…¶ä¸­ <code>0</code>å¯èƒ½æ˜¯ä¸€ä¸ªæ•°æ®å¸§çš„èµ·å§‹ä½ï¼‰</p>
<p>å¦‚æœå‘ç”Ÿä¸‹é™æ²¿æ—¶å¾—åˆ°çš„é‡‡æ ·åºåˆ—å’Œä¸Šè¿°æ¨¡å¼ç›¸æ¯”ä¸å®Œæ•´ï¼Œé‚£ä¹ˆè¯¥èµ·å§‹ä½ä¼šè¢«ä¸¢å¼ƒï¼Œå¹¶ä¸”æ¥æ”¶å™¨è¿”å›åˆ°ç©ºé—²çŠ¶æ€ç»§ç»­ç­‰å¾…ä¸‹é™æ²¿ã€‚</p>
<blockquote>
<p>The start bit is confirmed (RXNE flag set, interrupt generated if RXNEIE=1) if the 3 sampled bits are at 0 (first sampling on the 3rd, 5th and 7th bits finds the 3 bits at 0 and second sampling on the 8th, 9th and 10th bits also finds the 3 bits at 0).</p>
</blockquote>
<p>å¦‚å›¾ï¼ŒUSARTé€šè¿‡è¿‡é‡‡æ ·ï¼ˆæ³¢ç‰¹ç‡çš„16å€ï¼‰åœ¨ä¸€ä¸ªbitæ—¶é—´å†…è¿›è¡Œäº†16æ¬¡é‡‡æ ·ï¼Œå¦‚æœå°†ä¸‹é™æ²¿åºåˆ—ï¼ˆ <code>1 1 1 0</code>ï¼‰ä¸­çš„ <code>0</code>ä½œä¸ºä¸€ä¸ªèµ·å§‹ä½ä¸­çš„ç¬¬ä¸€ä¸ªæ ·æœ¬ç‚¹ï¼Œé‚£ä¹ˆå¦‚æœéšåçš„ç¬¬3ã€5ã€7æ ·æœ¬ç‚¹ä¸º0ï¼Œä¸”ç¬¬8ã€9ã€10æ ·æœ¬ç‚¹ä¸º0ï¼Œé‚£ä¹ˆè¯¥èµ·å§‹ä½è¢«ç¡®è®¤ä¸ºæœ‰æ•ˆèµ·å§‹ä½ï¼ŒRXNEæ ‡å¿—ï¼ˆæ¥æ”¶ç¼“å†²åŒºä¸ä¸ºç©ºï¼ŒRDRæœ‰æ•°æ®å¯è¯»ï¼‰ä¼šè¢«ç½®ä½ï¼Œå¹¶ä¸”äº§ç”ŸRXNEIEä¸­æ–­ï¼ˆå¦‚æœä½¿èƒ½äº†è¯¥ä¸­æ–­ï¼‰</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå®é™…ä¸ŠRXNEç½®ä½åº”è¯¥æ˜¯åœ¨ç¡¬ä»¶å®Œæˆæ•°æ®çš„ä¼ è¾“ä¹‹åï¼ˆæ•°æ®é€šè¿‡ç¡¬ä»¶ä¼ å…¥ç§»ä½å¯„å­˜å™¨å¹¶é€’äº¤åˆ°RDRå¯„å­˜å™¨ï¼‰</p>
</blockquote>
<blockquote>
<p>The start bit is validated (RXNE flag set, interrupt generated if RXNEIE=1) but the NE noise flag is set if, for both samplings, at least 2 out of the 3 sampled bits are at 0 (sampling on the 3rd, 5th and 7th bits and sampling on the 8th, 9th and 10th bits). If this condition is not met, the start detection aborts and the receiver returns to the idle state (no flag is set).</p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129093604361.png" alt="image-20241129093604361" style="zoom:50%;">
<h2 id="shu-ju-zheng-de-jie-shou">æ•°æ®å¸§çš„æ¥æ”¶</h2>
<blockquote>
<p>During a USART reception, data shifts in least significant bit first through the RX pin. In this mode, the USART_DR register consists of a buffer (RDR) between the internal bus and the<br>
received shift register.</p>
</blockquote>
<p>åœ¨ä¸€ä¸ªUSARTæ•°æ®å¸§æ¥æ”¶è¿‡ç¨‹ä¸­ï¼Œæ•°æ®ä»¥LSBä½ä½ä¼˜å…ˆæ¨¡å¼ä¼ è¾“åˆ°RXå¼•è„šã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼ŒUSART_DRå¯„å­˜å™¨è¡¨ç°ä¸ºä½äºå†…éƒ¨æ€»çº¿å’Œç§»ä½å¯„å­˜å™¨ä¹‹é—´çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆRDRï¼ŒReceive Data Registerï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129094459395.png" alt="image-20241129094459395"></p>
<blockquote>
<p>Procedure:</p>
<ol>
<li>Enable the USART by writing the UE bit in USART_CR1 register to 1.</li>
<li>Program the M bit in USART_CR1 to define the word length.</li>
<li>Program the number of stop bits in USART_CR2.</li>
<li>Select DMA enable (DMAR) in USART_CR3 if multibuffer communication is to take<br>
place. Configure the DMA register as explained in multibuffer communication. STEP 3</li>
<li>Select the desired baud rate using the baud rate register USART_BRR</li>
<li>Set the RE bit USART_CR1. This enables the receiver which begins searching for a<br>
start bit.</li>
</ol>
</blockquote>
<p>æ¥æ”¶ç¨‹åºå¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯ç”¨USARTï¼šè®¾ç½®USART_CR1ä¸­çš„UEä¸º1</li>
<li>é€šè¿‡USART_CR1ä¸­çš„Mè®¾ç½®å­—é•¿</li>
<li>é€šè¿‡USART_CR2è®¾ç½®åœæ­¢ä½å ç”¨çš„bitæ•°é‡</li>
<li>å¤šç¼“å†²DMAç›¸å…³</li>
<li>é€šè¿‡USART_BRRé€‰æ‹©æœŸæœ›çš„æ³¢ç‰¹ç‡</li>
<li>é€šè¿‡USART_CR1çš„REå¯ç”¨æ¥æ”¶å™¨</li>
</ol>
<blockquote>
<p>When a character is received<br>
ï‚· The RXNE bit is set. It indicates that the content of the shift register is transferred to the<br>
RDR. In other words, data has been received and can be read (as well as its<br>
associated error flags).<br>
ï‚· An interrupt is generated if the RXNEIE bit is set.<br>
ï‚· The error flags can be set if a frame error, noise or an overrun error has been detected<br>
during reception.<br>
ï‚· In multibuffer, RXNE is set after every byte received and is cleared by the DMA read to<br>
the Data register.<br>
ï‚· In single buffer mode, clearing the RXNE bit is performed by a software read to the<br>
USART_DR register. The RXNE flag can also be cleared by writing a zero to it. The<br>
RXNE bit must be cleared before the end of the reception of the next character to avoid<br>
an overrun error.</p>
</blockquote>
<p>å½“æ”¶åˆ°äº†ä¸€ä¸ªæ•°æ®å¸§åï¼š</p>
<ul>
<li>RXNEä¼šè¢«ç½®ä½ï¼šæœ‰æ•°æ®è¢«ä¼ è¾“åˆ°äº†RDRä¸­ï¼Œå¯ä»¥é€šè¿‡DRæ¥è¯»å–å®ƒ</li>
<li>äº§ç”ŸRXNEIEä¸­æ–­ï¼ˆå¦‚æœä½¿èƒ½äº†è¯¥ä¸­æ–­ï¼‰</li>
<li>å¦‚æœæ¥æ”¶è¿‡ç¨‹ä¸­å‘ç”Ÿäº†å¸§é”™è¯¯ã€å™ªå£°é”™è¯¯ã€ç¼“å†²åŒºæº¢å‡ºé”™è¯¯ï¼ŒçŠ¶æ€å¯„å­˜å™¨USART_SRä¸­çš„ç›¸å…³é”™è¯¯æ ‡å¿—ä½ä¼šè¢«è®¾ç½®</li>
<li>åœ¨å¤šç¼“å†²DMAä¸­ï¼ŒRXNEåœ¨æ¯ä¸ªå­—èŠ‚æ¥æ”¶å®Œæˆåç”±DMAçš„è¯»DRæ“ä½œæ¥æ¸…é™¤</li>
<li>å•ç¼“å†²æ¨¡å¼ä¸‹ï¼ŒRXNEçš„æ¸…é™¤å¯ç”±è½¯ä»¶çš„è¯»DRæ“ä½œæ¥æ¸…é™¤ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘RXNEå†™0æ¥æ¸…é™¤ã€‚<mark>RXNEå¿…é¡»è¦åœ¨ä¸‹ä¸€ä¸ªæ•°æ®å¸§æ¥æ”¶å®Œæˆä¹‹å‰è¢«æ¸…é™¤ï¼Œä»¥é¿å…äº§ç”Ÿç¼“å†²åŒºæº¢å‡ºé”™è¯¯</mark></li>
</ul>
<blockquote>
<p>[!IMPORTANT]</p>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå¦‚ä½•ç¡®ä¿åœ¨ä¸‹ä¸€ä¸ªæ•°æ®å¸§ä¹‹å‰æ¸…é™¤RXNEï¼Ÿ</p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129100957026.png" alt="image-20241129100957026" style="zoom:50%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129101031527.png" alt="image-20241129101031527" style="zoom:50%;">
<h2 id="kong-xian-zheng-2">ç©ºé—²å¸§</h2>
<blockquote>
<p>When an idle frame is detected, there is the same procedure as a data received character plus an interrupt if the IDLEIE bit is set.</p>
</blockquote>
<p>å½“æ£€æµ‹åˆ°ç©ºé—²å¸§ï¼ˆ<mark>æ³¨æ„è¿™é‡Œæ˜¯æŒ‡è·Ÿåœ¨æ•°æ®å¸§åçš„ç¬¬ä¸€ä¸ªç©ºé—²å¸§</mark>ï¼‰æ—¶ï¼Œç¡¬ä»¶ä¼šæ‰§è¡Œä¸æ¥æ”¶åˆ°ä¸€ä¸ªæ•°æ®å¸§ç±»ä¼¼çš„æµç¨‹ï¼ˆå‚è€ƒä¸Šä¸€èŠ‚ï¼‰ï¼š</p>
<ol>
<li>è®¾ç½®USART_SR å¯„å­˜å™¨çš„ <strong>IDLEï¼ˆç©ºé—²å¸§æ£€æµ‹ï¼‰</strong> æ ‡å¿—ä½ï¼ˆæ¥æ”¶åˆ°æ•°æ®å¸§åˆ™æ˜¯è®¾ç½®RXNEæ ‡å¿—ä½ï¼‰ã€‚</li>
<li>å¦‚æœ <strong>IDLEIE ä½=1</strong>ï¼ˆç©ºé—²å¸§ä¸­æ–­ä½¿èƒ½ï¼‰ï¼Œä¼šè§¦å‘ä¸­æ–­ã€‚</li>
</ol>
<p>ä½†æ˜¯ï¼Œ<strong>ç©ºé—²å¸§</strong>ä¸ä¼šå½±å“æ¥æ”¶æ•°æ®ç¼“å†²åŒºçš„å†…å®¹ï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿ RXNE æ ‡å¿—ï¼Œä¹Ÿä¸ä¼šä¿®æ”¹æ¥æ”¶æ•°æ®å¯„å­˜å™¨ï¼ˆRDRï¼‰ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129193651750.png" alt="image-20241129193651750"></p>
<blockquote>
<p>It is cleared by a software sequence (an read to the USART_SR register followed by a read to the USART_DR register).</p>
</blockquote>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒIDLEæ ‡å¿—ä½å¯ä»¥é€šè¿‡å¦‚ä¸‹è½¯ä»¶æ“ä½œåºåˆ—æ¥æ¸…é™¤ï¼š</p>
<ol>
<li>è¯»USART_SRå¯„å­˜å™¨ï¼ˆä¾‹å¦‚è½®è¯¢IDLEæ ‡å¿—ä½ï¼‰</li>
<li>è¯»USART_DRï¼ˆä¾‹å¦‚è½®è¯¢åˆ°IDLEè¢«ç½®åï¼Œæ‰§è¡Œä¸€ä¸ªUSART_DRè¯»åˆ°çš„ç©ºæ“ä½œï¼‰</li>
</ol>
<blockquote>
<p>[!NOTE]</p>
<p>Note: The IDLE bit will not be set again until the RXNE bit has been set itself (i.e. a new idle<br>
line occurs).</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨RXNEè¢«ç½®ä½åï¼ˆæ¥æ”¶åˆ°äº†æ•°æ®ï¼‰å¦‚æœæ£€æµ‹åˆ°äº†ç©ºé—²å¸§æ‰ä¼šå°†IDLEç½®ä½ï¼Œå¹¶ä¸”å¦‚æœæœ‰å¤šä¸ªç©ºé—²å¸§ä¸ä¼šå¤šæ¬¡å°†IDLEç½®ä½ï¼Œå³æ¯æ¬¡æ¥æ”¶æ•°æ®åçš„ç¬¬ä¸€ä¸ªç©ºé—²å¸§ï¼ˆæŒ‡ç¤ºä¸€æ¬¡ä¸å®šé•¿æ•°æ®ä¼ è¾“å·²ç»å®Œæˆï¼‰æ‰ä¼šç½®ä½IDLE</p>
</blockquote>
<h1 id="bo-te-lu-she-zhi">æ³¢ç‰¹ç‡è®¾ç½®</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129105108831.png" alt="image-20241129105108831"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129102353746.png" alt="image-20241129102353746"></p>
<p>æ¥æ”¶å™¨å’Œå‘é€å™¨çš„æ³¢ç‰¹ç‡ç”±å¤–è®¾æ—¶é’Ÿf<sub>CK</sub>å’Œå¯ç¼–ç¨‹çš„USARTåˆ†é¢‘å‚æ•°USARTDIVæ¥è®¡ç®—ã€‚</p>
<p>å…¶ä¸­USARTDIVåˆå¯ä»¥é€šè¿‡æ³¢ç‰¹ç‡é…ç½®å¯„å­˜å™¨USART_BRRä¸­çš„DIV_Mantissaï¼ˆé…ç½®USARTDIVçš„æ•´æ•°éƒ¨åˆ†ï¼‰å’ŒDIV_Fraction  ï¼ˆé…ç½®USARTDIVçš„å°æ•°éƒ¨åˆ†ï¼Œé€šè¿‡DIV_Fraction/16æ¥è®¡ç®—å¯¹åº”çš„å°æ•°ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129102223806.png" alt="image-20241129102223806"></p>
<h1 id="xiao-yan-kong-zhi">æ ¡éªŒæ§åˆ¶</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128210319460.png" alt="image-20241128210319460"></p>
<blockquote>
<p>[!NOTE]</p>
<p>æ ¡éªŒä½æ˜¯åŒ…å«åœ¨å­—é•¿é‡Œé¢çš„ï¼Œä½œä¸ºå­—é•¿çš„æœ€åä¸€ä¸ªbit</p>
</blockquote>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å¯„å­˜å™¨é…ç½®æ˜¯å¦å¼€å¯æ ¡éªŒä½ï¼Œä»¥åŠé€‰æ‹©å¥‡å¶æ ¡éªŒæ¨¡å¼</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241128210525491.png" alt="image-20241128210525491"></p>
<h1 id="lun-xun-fang-shi-shou-fa-dan-zi-jie-shi-jian">è½®è¯¢æ–¹å¼æ”¶å‘å•å­—èŠ‚å®è·µ</h1>
<h2 id="yuan-li-tu">åŸç†å›¾</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129103540732.png" alt="image-20241129103540732"></p>
<h2 id="shi-neng-shi-zhong">ä½¿èƒ½æ—¶é’Ÿ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129111334989.png" alt="image-20241129111334989"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129111749460.png" alt="image-20241129111749460"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// enable clock</span>
RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_AFIOEN<span class="token punctuation">;</span>
RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_USART1EN<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="gpio-pei-zhi">GPIOé…ç½®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129104039053.png" alt="image-20241129104039053"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// GPIO CONFIG</span>
    <span class="token comment">// PA9 TX  alternate pp output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE9<span class="token punctuation">;</span>   <span class="token comment">// output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF9_1<span class="token punctuation">;</span>   <span class="token comment">// alternate pp</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF9_0<span class="token punctuation">;</span>
    <span class="token comment">// PA10 RX alternate float input</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_MODE10<span class="token punctuation">;</span>   <span class="token comment">// input mode</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF10_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF10_0<span class="token punctuation">;</span>   <span class="token comment">// float input</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="afio-pei-zhi">AFIOé…ç½®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129104211418.png" alt="image-20241129104211418"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129104116889.png" alt="image-20241129104116889"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129114655724.png" alt="image-20241129114655724"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// AFIO CONFIG</span>
    AFIO<span class="token operator">-&gt;</span>MAPR <span class="token operator">&amp;=</span> <span class="token operator">~</span>AFIO_MAPR_USART1_REMAP<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="usart-pei-zhi">USARTé…ç½®</h2>
<h3 id="bo-te-lu-pei-zhi">æ³¢ç‰¹ç‡é…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129104313401.png" alt="image-20241129104313401"></p>
<p>å¦‚æœæˆ‘ä»¬æƒ³å¾—åˆ°115200çš„æ³¢ç‰¹ç‡ï¼Œä»¥72Må¤–è®¾æ—¶é’Ÿä¸ºä¾‹è®¡ç®—USARTDIVï¼š<code>72000000/(16 * 115200) = 39.0625</code></p>
<p>å› æ­¤æ•´æ•°éƒ¨åˆ†å¯ä»¥é…ç½®ä¸º <code>0x27</code>ï¼ˆ39ï¼‰ï¼Œå°æ•°éƒ¨åˆ†å¯ä»¥é…ç½®ä¸º <code>0x1</code>ï¼ˆ1/16=0.625ï¼‰</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// baud rate</span>
 USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Mantissa<span class="token punctuation">;</span>
 USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Fraction<span class="token punctuation">;</span>
 USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x27</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿›ä¸€æ­¥å¯ä»¥ä¼˜åŒ–ä¸ºï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">=</span> <span class="token number">0x271</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="usart-kong-zhi-qi-pei-zhi">USARTæ§åˆ¶å™¨é…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129105601999.png" alt="image-20241129105601999"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129110700834.png" alt="image-20241129110700834"></p>
<h3 id="shu-ju-zheng-xiang-guan">æ•°æ®å¸§ç›¸å…³</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129110611145.png" alt="image-20241129110611145"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// data frame</span>
   USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_M<span class="token punctuation">;</span>   <span class="token comment">// 8 bit word length</span>
   USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_PCE<span class="token punctuation">;</span> <span class="token comment">// diable parity</span>
   USART1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR2_STOP<span class="token punctuation">;</span> <span class="token comment">// 1 stop bit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="shi-neng-xiang-guan">ä½¿èƒ½ç›¸å…³</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129110403540.png" alt="image-20241129110403540"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// enable</span>
USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> <span class="token punctuation">(</span>USART_CR1_UE <span class="token operator">|</span> USART_CR1_RE <span class="token operator">|</span> USART_CR1_TE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="lun-xun-shou-fa">è½®è¯¢æ”¶å‘</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until transmit buffer is empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">uart_receive_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until receive buffer is not empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="wan-zheng-dai-ma">å®Œæ•´ä»£ç </h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__UART_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__UART_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">uart_receive_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __UART_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// enable clock</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_AFIOEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_USART1EN<span class="token punctuation">;</span>

    <span class="token comment">// GPIO CONFIG</span>
    <span class="token comment">// PA9 TX  alternate pp output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE9<span class="token punctuation">;</span>   <span class="token comment">// output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF9_1<span class="token punctuation">;</span>   <span class="token comment">// alternate pp</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF9_0<span class="token punctuation">;</span>
    <span class="token comment">// PA10 RX alternate float input</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_MODE10<span class="token punctuation">;</span>   <span class="token comment">// input mode</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF10_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF10_0<span class="token punctuation">;</span>   <span class="token comment">// float input</span>

    <span class="token comment">// AFIO CONFIG</span>
    AFIO<span class="token operator">-&gt;</span>MAPR <span class="token operator">&amp;=</span> <span class="token operator">~</span>AFIO_MAPR_USART1_REMAP<span class="token punctuation">;</span>

    <span class="token comment">// USART CONFIG</span>
    <span class="token comment">// baud rate</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Mantissa<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Fraction<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x27</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//USART1-&gt;BRR = 0x271;</span>
    <span class="token comment">// data frame</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_M<span class="token punctuation">;</span>   <span class="token comment">// 8 bit word length</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_PCE<span class="token punctuation">;</span> <span class="token comment">// diable parity</span>
    USART1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR2_STOP<span class="token punctuation">;</span> <span class="token comment">// 1 stop bit</span>
    <span class="token comment">// enable</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> <span class="token punctuation">(</span>USART_CR1_UE <span class="token operator">|</span> USART_CR1_RE <span class="token operator">|</span> USART_CR1_TE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until transmit buffer is empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">uart_receive_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until receive buffer is not empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="lun-xun-fang-shi-shou-fa-duo-zi-jie-shi-jian">è½®è¯¢æ–¹å¼æ”¶å‘å¤šå­—èŠ‚å®è·µ</h1>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes<span class="token punctuation">,</span> u16 size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>u16 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">uart_send_byte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_receive_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes_buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span><span class="token operator">*</span> sizebuf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
                <span class="token operator">*</span>sizebuf <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        bytes_buf<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæ—¢è¦é€šè¿‡è½®è¯¢æ¥æ£€æµ‹RXNEä»è€Œå®ç°å¤šå­—èŠ‚çš„è¯»å–ï¼Œåˆè¦è½®è¯¢IDLEæ¥å®ç°åœ¨æ£€æµ‹åˆ°ç©ºé—²å¸§åï¼ˆå‘é€æ–¹å‘é€å®Œäº†æœ€åä¸€ä¸ªå­—èŠ‚ï¼‰ç»ˆæ­¢è½®è¯¢è¯»å–çš„é€»è¾‘ã€‚</p>
<blockquote>
<p>[!NOTE]</p>
<p>è¿™é‡Œåœ¨æ£€æµ‹åˆ°IDLEæ ‡å¿—ä½ï¼ˆé€šè¿‡è¯»USART1-&gt;SRï¼‰åï¼Œè¿½åŠ äº†ä¸€ä¸ªUSART1-&gt;DRè¯»æ“ä½œï¼Œè¿™æ˜¯ä¸ºäº†éµå¾ªæ‰‹å†Œå¯¹äºIDLEæ ‡å¿—ä½æè¿°ä¸­çš„è§„èŒƒï¼š</p>
<p>It is cleared by a software sequence (an read to theUSART_SR register followed by a read to the USART_DR register).</p>
</blockquote>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<mark>è½®è¯¢RXNEå’ŒIDLEåº”è¯¥é…åˆä½¿ç”¨</mark>ï¼Œå¦‚ä¸‹ä»£ç è¯•å›¾é€šè¿‡åœ¨æ¯æ¬¡ä»DRè¯»å–åˆ°ä¸€ä¸ªå­—èŠ‚åæ£€æµ‹ä¸€æ¬¡IDLEï¼Œå¦‚æœIDLEåˆšå¥½åœ¨è¿™ä¸ª <code>if (USART1-&gt;SR &amp; USART_SR_IDLE) </code>æ‰§è¡Œåè¢«ç½®ä½ï¼Œé‚£ä¹ˆç¨‹åºå°±ä¼šå¡åœ¨ç¬¬4è¡Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uart_receive_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes_buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span><span class="token operator">*</span> sizebuf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        bytes_buf<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
            <span class="token operator">*</span>sizebuf <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!WARNING]</p>
<p>å¯ä»¥å‘ç°ï¼Œå¯¹äºç¡¬ä»¶ç½®ä½çš„æ ‡å¿—ä½ï¼ˆä¾‹å¦‚RXNEã€IDLEï¼‰ï¼Œåº”è¯¥ä¸æ–­è½®è¯¢å»æ£€æµ‹ï¼Œè€Œä¸è¦æœŸæœ›åœ¨æŸä¸ªæ—¶æœºæ£€æµ‹ä»…ä»…ä¸€æ¬¡ã€‚</p>
<p>ä¾‹å¦‚ä¸Šè¿°ç¨‹åºæœŸæœ›åœ¨æ”¶åˆ°æœ€åä¸€ä¸ªå­—èŠ‚åé€šè¿‡ä¸€æ¬¡ <code>if</code>åˆ¤æ–­æ¥æ£€æµ‹IDLEï¼Œè™½ç„¶å¯¹äºæ¥æ”¶æœ€åä¸€ä¸ªå­—èŠ‚è€Œè¨€ï¼ŒIDLEç½®ä½ç¡®å®å‘ç”Ÿåœ¨ <code>bytes_buf[i++] = USART1-&gt;DR</code>ä¹‹åï¼Œä½†æ˜¯ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦æ˜¯å¾ˆå¿«çš„ï¼Œè€Œç©ºé—²å¸§çš„æ£€æµ‹éœ€è¦ç¡¬ä»¶æ£€æµ‹åˆ°ä¸€ä¸ªå¸§é•¿çš„æ‰€æœ‰bitå…¨ä¸º1æ—¶æ‰ä¼šå°†IDLEç½®1ã€‚å› æ­¤ä¸Šè¿°ç¨‹åºä¸­çš„ <code>if (USART1-&gt;SR &amp; USART_SR_IDLE)</code> å¹¶ä¸èƒ½åœ¨æ¥æ”¶å®Œæœ€åä¸€ä¸ªå­—èŠ‚åå¦‚æœŸæ£€æµ‹åˆ°IDLEè¢«ç½®ä½ï¼Œæ¥ç€åˆå›åˆ°äº† <code>while ((USART1-&gt;SR &amp; USART_SR_RXNE) == 0)</code>ç©ºè½¬æ— æ³•è·³å‡ºã€‚</p>
</blockquote>
<p>å› æ­¤å¦‚ä¸‹ä»£ç å°†RXNEå’ŒIDLEçš„è½®è¯¢ç»“åˆåˆ°äº†ä¸€èµ·ï¼Œåœ¨RXNEè¢«ç½®ä½æ—¶æ‰§è¡Œæ•°æ®çš„è¯»å– <code>bytes_buf[i++] = USART1-&gt;DR</code>ï¼Œåœ¨IDLEè¢«ç½®ä½æ—¶æ‰§è¡Œå‡½æ•°çš„è¿”å›</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uart_receive_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes_buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span><span class="token operator">*</span> sizebuf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
                <span class="token operator">*</span>sizebuf <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        bytes_buf<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="you-hua">ä¼˜åŒ–</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> <span class="token function">uart_receive_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until receive buffer is not empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// å¦‚æœæ£€æµ‹åˆ°äº†ç©ºé—²å¸§åˆ™åœæ­¢æ¥æ”¶æ•°æ®</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_receive_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes_buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span><span class="token operator">*</span> sizebuf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*     uint16_t i = 0;
    while (1) {
        while ((USART1-&gt;SR &amp; USART_SR_RXNE) == 0) {
            if (USART1-&gt;SR &amp; USART_SR_IDLE) {
                USART1-&gt;DR;
                *sizebuf = i;
                return;
            }
        }
        bytes_buf[i++] = USART1-&gt;DR;
    } */</span>
    <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ç©ºé—²å¸§ï¼Œåˆ™è½®è¯¢æ¥æ”¶æ•°æ®</span>
        bytes_buf<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">uart_receive_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span> <span class="token comment">// é€šè¿‡USART_SRè¯»æ“ä½œä¹‹åè·Ÿéšä¸€ä¸ªUSART_DRè¯»æ¥æ¸…é™¤IDLEæ ‡å¿—</span>
    <span class="token operator">*</span>sizebuf <span class="token operator">=</span> <span class="token operator">--</span>i<span class="token punctuation">;</span> <span class="token comment">// uart_receive_byteè¿”å›çš„æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯å› ä¸ºç©ºé—²å¸§è¿”å›çš„æ— æ•ˆæ•°æ®</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zai-kan-txe-tc-rxne-idel-qing-chu-luo-ji">å†çœ‹TXE/TCã€RXNEã€IDELæ¸…é™¤é€»è¾‘</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129220628220.png" alt="image-20241129220628220"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129220926870.png" alt="image-20241129220926870"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129221419149.png" alt="image-20241129221419149"></p>
<blockquote>
<p>[!NOTE]</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨RXNEè¢«ç½®ä½åï¼ˆæ¥æ”¶åˆ°äº†æ•°æ®ï¼‰å¦‚æœæ£€æµ‹åˆ°äº†ç©ºé—²å¸§æ‰ä¼šå°†IDLEç½®ä½ï¼Œå¹¶ä¸”å¦‚æœæœ‰å¤šä¸ªç©ºé—²å¸§ä¸ä¼šå¤šæ¬¡å°†IDLEç½®ä½ï¼Œå³æ¯æ¬¡æ¥æ”¶æ•°æ®åçš„ç¬¬ä¸€ä¸ªç©ºé—²å¸§ï¼ˆæŒ‡ç¤ºä¸€æ¬¡ä¸å®šé•¿æ•°æ®ä¼ è¾“å·²ç»å®Œæˆï¼‰æ‰ä¼šç½®ä½IDLE</p>
</blockquote>
<h2 id="wan-zheng-dai-ma-1">å®Œæ•´ä»£ç </h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// enable clock</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_AFIOEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_USART1EN<span class="token punctuation">;</span>

    <span class="token comment">// GPIO CONFIG</span>
    <span class="token comment">// PA9 TX  alternate pp output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE9<span class="token punctuation">;</span>   <span class="token comment">// output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF9_1<span class="token punctuation">;</span>   <span class="token comment">// alternate pp</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF9_0<span class="token punctuation">;</span>
    <span class="token comment">// PA10 RX alternate float input</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_MODE10<span class="token punctuation">;</span>   <span class="token comment">// input mode</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF10_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF10_0<span class="token punctuation">;</span>   <span class="token comment">// float input</span>

    <span class="token comment">// AFIO CONFIG</span>
    AFIO<span class="token operator">-&gt;</span>MAPR <span class="token operator">&amp;=</span> <span class="token operator">~</span>AFIO_MAPR_USART1_REMAP<span class="token punctuation">;</span>

    <span class="token comment">// USART CONFIG</span>
    <span class="token comment">// baud rate</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Mantissa<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Fraction<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x27</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//USART1-&gt;BRR = 0x271;</span>
    <span class="token comment">// data frame</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_M<span class="token punctuation">;</span>   <span class="token comment">// 8 bit word length</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_PCE<span class="token punctuation">;</span>   <span class="token comment">// diable parity</span>
    USART1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR2_STOP<span class="token punctuation">;</span>   <span class="token comment">// 1 stop bit</span>
    <span class="token comment">// enable</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> <span class="token punctuation">(</span>USART_CR1_UE <span class="token operator">|</span> USART_CR1_RE <span class="token operator">|</span> USART_CR1_TE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until transmit buffer is empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">uart_receive_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until receive buffer is not empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// å¦‚æœæ£€æµ‹åˆ°äº†ç©ºé—²å¸§åˆ™åœæ­¢æ¥æ”¶æ•°æ®</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes<span class="token punctuation">,</span> u16 size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>u16 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">uart_send_byte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_receive_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes_buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span><span class="token operator">*</span> sizebuf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*     uint16_t i = 0;
    while (1) {
        while ((USART1-&gt;SR &amp; USART_SR_RXNE) == 0) {
            if (USART1-&gt;SR &amp; USART_SR_IDLE) {
                USART1-&gt;DR;
                *sizebuf = i;
                return;
            }
        }
        bytes_buf[i++] = USART1-&gt;DR;
    } */</span>
    <span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ç©ºé—²å¸§ï¼Œåˆ™è½®è¯¢æ¥æ”¶æ•°æ®</span>
        bytes_buf<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">uart_receive_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span> <span class="token comment">// é€šè¿‡USART_SRè¯»æ“ä½œä¹‹åè·Ÿéšä¸€ä¸ªUSART_DRè¯»æ¥æ¸…é™¤IDLEæ ‡å¿—</span>
    <span class="token operator">*</span>sizebuf <span class="token operator">=</span> <span class="token operator">--</span>i<span class="token punctuation">;</span> <span class="token comment">// uart_receive_byteè¿”å›çš„æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯å› ä¸ºç©ºé—²å¸§è¿”å›çš„æ— æ•ˆæ•°æ®</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="zhong-duan-fang-shi-jie-shou-dan-zi-jie-he-bian-chang-shu-ju">ä¸­æ–­æ–¹å¼æ¥æ”¶å•å­—èŠ‚å’Œå˜é•¿æ•°æ®</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129223248999.png" alt="image-20241129223248999"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129223318399.png" alt="image-20241129223318399"></p>
<h2 id="shi-neng-zhong-duan">ä½¿èƒ½ä¸­æ–­</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241129223405148.png" alt="image-20241129223405148"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// interrupt config</span>
   USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> USART_CR1_RXNEIE<span class="token punctuation">;</span>
   USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> USART_CR1_IDLEIE<span class="token punctuation">;</span>
   <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// only group priority</span>
   <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ding-yi-zhong-duan-chu-li-han-shu">å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

__weak <span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span> <span class="token comment">// dummy read for clearing IDLE flag</span>
        <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="shi-yong-fang-zhong-xie-hui-diao-han-shu">ä½¿ç”¨æ–¹é‡å†™å›è°ƒå‡½æ•°</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//uart_send_byte('a');</span>
    <span class="token class-name">uint8_t</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"hello world!\n"</span><span class="token punctuation">;</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="wan-zheng-dai-ma-2">å®Œæ•´ä»£ç </h2>
<p><code>uart.h</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__UART_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__UART_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>bytes<span class="token punctuation">,</span> u16 size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __UART_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>uart.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// enable clock</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_AFIOEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_USART1EN<span class="token punctuation">;</span>

    <span class="token comment">// GPIO CONFIG</span>
    <span class="token comment">// PA9 TX  alternate pp output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE9<span class="token punctuation">;</span>   <span class="token comment">// output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF9_1<span class="token punctuation">;</span>   <span class="token comment">// alternate pp</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF9_0<span class="token punctuation">;</span>
    <span class="token comment">// PA10 RX alternate float input</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_MODE10<span class="token punctuation">;</span>   <span class="token comment">// input mode</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF10_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF10_0<span class="token punctuation">;</span>   <span class="token comment">// float input</span>

    <span class="token comment">// AFIO CONFIG</span>
    AFIO<span class="token operator">-&gt;</span>MAPR <span class="token operator">&amp;=</span> <span class="token operator">~</span>AFIO_MAPR_USART1_REMAP<span class="token punctuation">;</span>

    <span class="token comment">// USART CONFIG</span>
    <span class="token comment">// baud rate</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Mantissa<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Fraction<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x27</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//USART1-&gt;BRR = 0x271;</span>
    <span class="token comment">// data frame</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_M<span class="token punctuation">;</span>   <span class="token comment">// 8 bit word length</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_PCE<span class="token punctuation">;</span>   <span class="token comment">// diable parity</span>
    USART1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR2_STOP<span class="token punctuation">;</span>   <span class="token comment">// 1 stop bit</span>
    <span class="token comment">// enable</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> <span class="token punctuation">(</span>USART_CR1_UE <span class="token operator">|</span> USART_CR1_RE <span class="token operator">|</span> USART_CR1_TE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// interrupt config</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> USART_CR1_RXNEIE<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> USART_CR1_IDLEIE<span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// only group priority</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span> <span class="token comment">// dummy read for clearing IDLE flag</span>
        <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until transmit buffer is empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes<span class="token punctuation">,</span> u16 size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>u16 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">uart_send_byte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//uart_send_byte('a');</span>
    <span class="token class-name">uint8_t</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"hello world!\n"</span><span class="token punctuation">;</span>
    <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="stm-32-cube-mx-hal-ku-shi-jian">STM32CubeMX/HALåº“å®è·µ</h1>
<h2 id="lun-xun-fang-shi-shou-fa-ding-chang-shu-ju">è½®è¯¢æ–¹å¼æ”¶å‘å®šé•¿æ•°æ®</h2>
<h3 id="cube-pei-zhi-qi-yong-usart-xiang-guan-de-gpio-hui-bei-zi-dong-pei-zhi">Cubeé…ç½®å¯ç”¨USARTï¼Œç›¸å…³çš„GPIOä¼šè¢«è‡ªåŠ¨é…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130085637544.png" alt="image-20241130085637544"></p>
<h3 id="afio-zhong-ying-she-wen-ti">AFIOé‡æ˜ å°„é—®é¢˜</h3>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¸Œæœ›PB6/7ä½œä¸ºTX/RXï¼Œå¯ä»¥ç›´æ¥ç‚¹å‡»å›¾ä¸­çš„å¯è§†åŒ–å¼•è„šè§†å›¾ä¸­çš„PB6é€‰æ‹©USART1_TXï¼Œé‚£ä¹ˆPA9/10å°±ä¼šè¢«åˆ‡æ¢ä¸ºPB6/7ï¼Œå¹¶ä¸”è‡ªåŠ¨åœ¨ç”Ÿæˆçš„ä»£ç ä¸­åšå¥½AFIOçš„remapé…ç½®</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130085714543.png" alt="image-20241130085714543"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130090020406.png" alt="image-20241130090020406"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130090037660.png" alt="image-20241130090037660"></p>
<p>åŒæ ·çš„ï¼Œå†æ¬¡ç‚¹å‡»PA9å¼•è„šé€‰æ‹©USART1_TXåˆ™å¯ä»¥åˆ‡æ¢å›PA9/10</p>
<h3 id="lun-xun-shou-fa-ding-chang-han-shu-diao-yong">è½®è¯¢æ”¶å‘å®šé•¿å‡½æ•°è°ƒç”¨</h3>
<p><code>stm32f1xx_hal_uart.c</code></p>
<pre class="line-numbers language-none"><code class="language-none">*** Polling mode IO operation ***
=================================
[..]
  (+) Send an amount of data in blocking mode using HAL_UART_Transmit()
  (+) Receive an amount of data in blocking mode using HAL_UART_Receive()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>HAL_UART_Transmit</code>ï¼šè½®è¯¢å‘é€æŒ‡å®šæ•°é‡æ•°æ®ï¼Œéœ€è¦æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼ˆmsï¼‰</li>
<li><code>HAL_UART_Receive</code>ï¼šè½®è¯¢æ¥æ”¶æŒ‡å®šæ•°é‡çš„æ•°æ®ï¼Œéœ€è¦æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼ˆmsï¼‰</li>
<li><code>HAL_StatusTypeDef</code>ï¼šä¸Šè¿°ä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å› <code>HAL_OK</code>ï¼Œå¦‚æœè¶…æ—¶åˆ™è¿”å› <code>HAL_TIMEOUT</code></li>
</ul>
<p>å¦‚ä¸‹ç¤ºä¾‹å®ç°äº†ä¸æ–­æ¥æ”¶8ä¸ªæ•°æ®å¹¶åŸæ ·å‘é€8ä¸ªæ•°æ®</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">int main(void) {
    ...

    /* Initialize all configured peripherals */
    MX_GPIO_Init();
    MX_USART1_UART_Init();
    /* USER CODE BEGIN 2 */
    uint8_t* str = "hello world\n";
    HAL_UART_Transmit(&amp;huart1, str, strlen((char*)str), 10);

    uint8_t buffer[100] = { 0 };
    /* USER CODE END 2 */

    /* Infinite loop */
    /* USER CODE BEGIN WHILE */
    while (1) {
        if (HAL_UART_Receive(&amp;huart1, buffer, 8, 10) == HAL_OK) {
            HAL_UART_Transmit(&amp;huart1, buffer, 8, 10);
            /* code */
        }
        /* USER CODE END WHILE */
        
        if (HAL_UART_Receive(&amp;huart1, buffer, 8, 10) == HAL_OK) {
            HAL_UART_Transmit(&amp;huart1, buffer, 8, 10);
            /* code */
        }

        /* USER CODE BEGIN 3 */
    }
    /* USER CODE END 3 */
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="lun-xun-fang-shi-jie-shou-bian-chang-shu-ju">è½®è¯¢æ–¹å¼æ¥æ”¶å˜é•¿æ•°æ®</h2>
<p><code>stm32f1xx_hal_uart.c</code></p>
<pre class="line-numbers language-none"><code class="language-none">(+) Blocking mode: The reception is performed in polling mode, until either expected number of data is received,
   or till IDLE event occurs. Reception is handled only during function execution.
   When function exits, no data reception could occur. HAL status and number of actually received data elements,
   are returned by function after finishing transfer.
   
(#) Blocking mode API:
    (+) HAL_UARTEx_ReceiveToIdle()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>HAL_UARTEx_ReceiveToIdle</code>ï¼šè½®è¯¢æ¥æ”¶æ•°æ®ç›´åˆ°æ£€æµ‹åˆ°ç©ºé—²å¸§</p>
<ul>
<li><code>uint8_t *pData</code>ï¼šæŒ‡å®šç¼“å†²åŒºçš„åœ°å€</li>
<li><code>uint16_t Size</code>ï¼šæŒ‡å®šéœ€è¦æ¥æ”¶å¤šå°‘æ•°é‡æ•°æ®åˆ°ç¼“å†²åŒºï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºç¼“å†²åŒºçš„å¤§å°</li>
<li><code>uint16_t *RxLen</code>ï¼šæ£€æµ‹åˆ°ç©ºé—²å¸§æ—¶å®é™…æ¥æ”¶åˆ°çš„æ•°æ®æ•°é‡ï¼Œè°ƒç”¨æ–¹éœ€è¦å‡†å¤‡ä¸€ä¸ª <code>uint16_t</code>å˜é‡å¹¶å°†å…¶åœ°å€é€šè¿‡è¯¥å‚æ•°ä¼ å…¥ï¼Œå‡½æ•°ä¼šæ ¹æ®å®é™…æƒ…å†µæ¥è®¾ç½®è¯¥å˜é‡çš„å€¼</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> received_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_UARTEx_ReceiveToIdle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>received_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> HAL_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> received_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* code */</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zhong-duan-fang-shi-jie-shou-ding-chang-shu-ju">ä¸­æ–­æ–¹å¼æ¥æ”¶å®šé•¿æ•°æ®</h2>
<p><code>stm32f1xx_hal_uart.c</code></p>
<pre class="line-numbers language-none"><code class="language-none">*** Interrupt mode IO operation ***
    ===================================
    [..]
      (+) Send an amount of data in non blocking mode using HAL_UART_Transmit_IT()
      (+) At transmission end of transfer HAL_UART_TxCpltCallback is executed and user can
           add his own code by customization of function pointer HAL_UART_TxCpltCallback
      (+) Receive an amount of data in non blocking mode using HAL_UART_Receive_IT()
      (+) At reception end of transfer HAL_UART_RxCpltCallback is executed and user can
           add his own code by customization of function pointer HAL_UART_RxCpltCallback
      (+) In case of transfer Error, HAL_UART_ErrorCallback() function is executed and user can
           add his own code by customization of function pointer HAL_UART_ErrorCallback<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>HAL_UART_Receive_IT</code>ï¼šä»¥ä¸­æ–­æ–¹å¼æ¥æ”¶æŒ‡å®šæ•°é‡çš„æ•°æ®åˆ°æ¥æ”¶ç¼“å†²åŒºä¸­ï¼ˆç”±ç”¨æˆ·å®šä¹‰ï¼‰ï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¸ä¼šé˜»å¡å½“å‰ç¨‹åº</p>
</li>
<li>
<p><code>HAL_UART_RxCpltCallback</code>ï¼šæ¥æ”¶å®Œæˆå›è°ƒï¼Œåœ¨æ¥æ”¶äº†æŒ‡å®šæ•°é‡ï¼ˆåº•å±‚é€šè¿‡RXNEä¸­æ–­é€ä¸ªæ¥æ”¶ï¼‰æ•°æ®å¹¶æ”¾åˆ°æ¥æ”¶ç¼“å†²åŒºä¸­ï¼ˆç”±ç”¨æˆ·å®šä¹‰ï¼‰åï¼Œè¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™æ”¹å‡½æ•°æ¥å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®</p>
</li>
</ul>
<blockquote>
<p>[!TIP]</p>
<p><code>stm32f1xx_hal_uart.c</code>æä¾›äº† <code>HAL_UART_RxCpltCallback</code>å‡½æ•°çš„å¼±å®šä¹‰å½¢å¼ï¼ˆç›¸å½“äºæä¾›äº†ä¸€ä¸ªæ¥å£ï¼‰ï¼Œç”¨æˆ·å¯ä»¥é‡å†™è¯¥å‡½æ•°ï¼ˆå»æ‰ <code>__weak</code>å…³é”®å­—ï¼‰ä»¥å®ç°è‡ªå®šä¹‰é€»è¾‘ã€‚</p>
<p>è¯¥è®¾è®¡å’Œé’©å­å‡½æ•°æ˜¯ä¸€è„‰ç›¸æ‰¿çš„ã€‚</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
  * @brief  Rx Transfer completed callbacks.
  * @param  huart  Pointer to a UART_HandleTypeDef structure that contains
  *                the configuration information for the specified UART module.
  * @retval None
  */</span>
__weak <span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* Prevent unused argument(s) compilation warning */</span>
  <span class="token function">UNUSED</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* NOTE: This function should not be modified, when the callback is needed,
           the HAL_UART_RxCpltCallback could be implemented in the user file
   */</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> fixed_data_size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> is_over <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>huart <span class="token operator">==</span> <span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    is_over <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token comment">/**
 * @brief  The application entry point.
 * @retval int
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token comment">/* USER CODE BEGIN 1 */</span>

  <span class="token comment">/* USER CODE END 1 */</span>

  <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

  <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN Init */</span>

  <span class="token comment">/* USER CODE END Init */</span>

  <span class="token comment">/* Configure the system clock */</span>
  <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN SysInit */</span>

  <span class="token comment">/* USER CODE END SysInit */</span>

  <span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>

  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> fixed_data_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_over<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> fixed_data_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      is_over <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>[!NOTE]</p>
<p>ç”±äºæ˜¯æ¥æ”¶å®šé•¿æ•°æ®ï¼Œå¦‚æœå‘é€æ–¹å‘é€çš„æ•°æ®ä¸ç­‰äºæ—¢å®šçš„<code>fixed_data_size</code>ï¼Œé‚£ä¹ˆè¯¥ç¨‹åºçš„echoå›ä¼ é€»è¾‘ä¼šæœ‰é—®é¢˜</p>
</blockquote>
<h2 id="zhong-duan-fang-shi-jie-shou-bian-chang-shu-ju">ä¸­æ–­æ–¹å¼æ¥æ”¶å˜é•¿æ•°æ®</h2>
<p><code>stm32f1xx_hal_uart.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> Non<span class="token operator">-</span>Blocking mode<span class="token operator">:</span> The reception is performed using Interrupts or DMA<span class="token punctuation">.</span>
       These API's <span class="token keyword">return</span> the HAL status<span class="token punctuation">.</span>
       The end of the data processing will be indicated through the
       dedicated UART IRQ when using Interrupt mode or the DMA IRQ when using DMA mode<span class="token punctuation">.</span>
       The <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user callback will be executed during Receive process
       The <span class="token function">HAL_UART_ErrorCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>user callback will be executed when a reception error is detected<span class="token punctuation">.</span>

<span class="token punctuation">(</span>#<span class="token punctuation">)</span> Non<span class="token operator">-</span>Blocking mode API with Interrupt<span class="token operator">:</span>
    <span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>HAL_UARTEx_ReceiveToIdle_IT</code>ï¼šä»¥ä¸­æ–­æ–¹å¼æ¥æ”¶å˜é•¿æ•°æ®ï¼Œæ¥æ”¶æ•°æ®åˆ°ç¼“å†²åŒºï¼ˆç”±ç”¨æˆ·å®šä¹‰ï¼‰ç›´åˆ°æ£€æµ‹åˆ°ç©ºé—²å¸§ï¼Œï¼Œè¯¥å‡½æ•°ä¸ä¼šé˜»å¡å½“å‰ç¨‹åº</p>
<ul>
<li><code>uint8_t *pData</code>ï¼šæ¥æ”¶ç¼“å†²åŒº</li>
<li><code>uint16_t Size</code>ï¼šéœ€è¦æ¥æ”¶çš„å­—ç»“æŸï¼Œé€šå¸¸å¯ä»¥ç»™å®šä¸ºç¼“å†²åŒºçš„å¤§å°</li>
</ul>
<p><code>HAL_UARTEx_RxEventCallback</code>ï¼šæ¥æ”¶å˜é•¿æ•°æ®å®Œæˆå›è°ƒï¼Œå¯ä»¥é€šè¿‡å…¥å‚ <code>Size</code>è·å–å®é™…æ¥æ”¶åˆ°çš„æ•°æ®æ•°é‡</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
  * @brief  Reception Event Callback (Rx event notification called after use of advanced reception service).
  * @param  huart UART handle
  * @param  Size  Number of data available in application reception buffer (indicates a position in
  *               reception buffer until which, data are available)
  * @retval None
  */</span>
__weak <span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* Prevent unused argument(s) compilation warning */</span>
  <span class="token function">UNUSED</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">UNUSED</span><span class="token punctuation">(</span>Size<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* NOTE : This function should not be modified, when the callback is needed,
            the HAL_UARTEx_RxEventCallback can be implemented in the user file.
   */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> is_over <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> received_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>huart <span class="token operator">==</span> <span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    is_over <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    received_size <span class="token operator">=</span> Size<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token comment">/**
 * @brief  The application entry point.
 * @retval int
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token comment">/* USER CODE BEGIN 1 */</span>

  <span class="token comment">/* USER CODE END 1 */</span>

  <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

  <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN Init */</span>

  <span class="token comment">/* USER CODE END Init */</span>

  <span class="token comment">/* Configure the system clock */</span>
  <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN SysInit */</span>

  <span class="token comment">/* USER CODE END SysInit */</span>

  <span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>

  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_over<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> received_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      is_over <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="cube-sheng-cheng-dai-ma-zi-dong-pei-zhi-fen-xi">Cubeç”Ÿæˆä»£ç è‡ªåŠ¨é…ç½®åˆ†æ</h2>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>MX_GPIO_Init</code>å¼€å¯äº†GPIOæ—¶é’Ÿ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token comment">/* GPIO Ports Clock Enable */</span>
  <span class="token function">__HAL_RCC_GPIOC_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>MX_USART1_UART_Init</code>å°†UARTç›¸å…³å‚æ•°ä¿å­˜åˆ°äº† <code>huart1</code>ç»“æ„ä½“ä¸­</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">UART_HandleTypeDef huart1<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token comment">/* USER CODE BEGIN USART1_Init 0 */</span>

  <span class="token comment">/* USER CODE END USART1_Init 0 */</span>

  <span class="token comment">/* USER CODE BEGIN USART1_Init 1 */</span>

  <span class="token comment">/* USER CODE END USART1_Init 1 */</span>
  huart1<span class="token punctuation">.</span>Instance <span class="token operator">=</span> USART1<span class="token punctuation">;</span>
  huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> <span class="token number">115200</span><span class="token punctuation">;</span>
  huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength <span class="token operator">=</span> UART_WORDLENGTH_8B<span class="token punctuation">;</span>
  huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits <span class="token operator">=</span> UART_STOPBITS_1<span class="token punctuation">;</span>
  huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity <span class="token operator">=</span> UART_PARITY_NONE<span class="token punctuation">;</span>
  huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> UART_MODE_TX_RX<span class="token punctuation">;</span>
  huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl <span class="token operator">=</span> UART_HWCONTROL_NONE<span class="token punctuation">;</span>
  huart1<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>OverSampling <span class="token operator">=</span> UART_OVERSAMPLING_16<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE BEGIN USART1_Init 2 */</span>

  <span class="token comment">/* USER CODE END USART1_Init 2 */</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>HAL_UART_Init</code>ä¸»è¦å…³æ³¨ä¸€ä¸‹ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">HAL_StatusTypeDef <span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UART_SetConfig</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>usart.c</code>é‡å†™äº† <code>HAL_UART_MspInit</code>å‡½æ•°</p>
<ul>
<li>å¯¹USART1ä¾èµ–çš„GPIOè¿›è¡Œé…ç½®</li>
<li>ä½¿èƒ½USART1ä¸­æ–­</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef<span class="token operator">*</span> uartHandle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  GPIO_InitTypeDef GPIO_InitStruct <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>uartHandle<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART1<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE BEGIN USART1_MspInit 0 */</span>

  <span class="token comment">/* USER CODE END USART1_MspInit 0 */</span>
    <span class="token comment">/* USART1 clock enable */</span>
    <span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**USART1 GPIO Configuration
    PA9     ------&gt; USART1_TX
    PA10     ------&gt; USART1_RX
    */</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_10<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_INPUT<span class="token punctuation">;</span>
    GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_NOPULL<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* USART1 interrupt Init */</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN USART1_MspInit 1 */</span>

  <span class="token comment">/* USER CODE END USART1_MspInit 1 */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="printf-zhong-ding-xiang">printfé‡å®šå‘</h1>
<h2 id="zhong-xie-fputc">é‡å†™fputc</h2>
<p><code>printf</code>æ˜¯ <code>D:\Keil_v5\ARM\ARMCC\include\stdio.h</code>ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œåº•å±‚ä¼šå¾ªç¯è°ƒç”¨ <code>fputc</code>å°†è¦å‘é€çš„å­—ç¬¦ä¸²é€ä¸ªå­—ç¬¦åœ°å†™å…¥æŒ‡å®šçš„æ–‡ä»¶æµï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> _ARMABI <span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token comment">/*c*/</span><span class="token punctuation">,</span> FILE <span class="token operator">*</span> <span class="token comment">/*stream*/</span><span class="token punctuation">)</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__nonnull__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">/*
    * writes the character specified by c (converted to an unsigned char) to
    * the output stream pointed to by stream, at the position indicated by the
    * asociated file position indicator (if defined), and advances the
    * indicator appropriately. If the file position indicator is not defined,
    * the character is appended to the output stream.
    * Returns: the character written. If a write error occurs, the error
    *          indicator is set and fputc returns EOF.
    */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å¯ä»¥é‡å†™è¯¥å‡½æ•°ä»¥å®ç°å°†å­—ç¬¦é€šè¿‡UARTå‘é€çš„é€»è¾‘ï¼Œè¿™æ ·ä¸²å£è°ƒå¼å·¥å…·å°±èƒ½æ˜¾ç¤º <code>printf</code>è¾“å‡ºçš„è°ƒè¯•ä¿¡æ¯äº†ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token comment">// printf retarget</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="lian-jie-printf">é“¾æ¥printf</h2>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåµŒå…¥å¼è¦æœ‰å¹³å°çš„æ¦‚å¿µï¼ŒåŸºäºLinux/Windowsçš„Cç¨‹åºä¸­çš„ <code>printf</code>éœ€è¦é“¾æ¥GCC/MinGWä¸­çš„<code>glibc</code>åº“ï¼›è€Œåœ¨MDKåµŒå…¥å¼å¼€å‘åœºæ™¯ï¼Œä¸‹æˆ‘ä»¬å¯ä»¥é“¾æ¥MDKæä¾›çš„ <code>Micro LIB</code>ï¼Œè¿™æ ·åœ¨é“¾æ¥é˜¶æ®µæ‰èƒ½æ‰¾åˆ° <code>printf</code>æ‰€åœ¨çš„ç›®æ ‡æ–‡ä»¶ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241130121901654.png" alt="image-20241130121901654"></p>
<h2 id="wan-zheng-dai-ma-3">å®Œæ•´ä»£ç </h2>
<p><code>uart.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// enable clock</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_AFIOEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_USART1EN<span class="token punctuation">;</span>

    <span class="token comment">// GPIO CONFIG</span>
    <span class="token comment">// PA9 TX  alternate pp output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE9<span class="token punctuation">;</span>   <span class="token comment">// output</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF9_1<span class="token punctuation">;</span>   <span class="token comment">// alternate pp</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF9_0<span class="token punctuation">;</span>
    <span class="token comment">// PA10 RX alternate float input</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_MODE10<span class="token punctuation">;</span>   <span class="token comment">// input mode</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF10_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_CNF10_0<span class="token punctuation">;</span>   <span class="token comment">// float input</span>

    <span class="token comment">// AFIO CONFIG</span>
    AFIO<span class="token operator">-&gt;</span>MAPR <span class="token operator">&amp;=</span> <span class="token operator">~</span>AFIO_MAPR_USART1_REMAP<span class="token punctuation">;</span>

    <span class="token comment">// USART CONFIG</span>
    <span class="token comment">// baud rate</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Mantissa<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_BRR_DIV_Fraction<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>BRR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x27</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//USART1-&gt;BRR = 0x271;</span>
    <span class="token comment">// data frame</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_M<span class="token punctuation">;</span>   <span class="token comment">// 8 bit word length</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR1_PCE<span class="token punctuation">;</span>   <span class="token comment">// diable parity</span>
    USART1<span class="token operator">-&gt;</span>CR2 <span class="token operator">&amp;=</span> <span class="token operator">~</span>USART_CR2_STOP<span class="token punctuation">;</span>   <span class="token comment">// 1 stop bit</span>
    <span class="token comment">// enable</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> <span class="token punctuation">(</span>USART_CR1_UE <span class="token operator">|</span> USART_CR1_RE <span class="token operator">|</span> USART_CR1_TE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// interrupt config</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> USART_CR1_RXNEIE<span class="token punctuation">;</span>
    USART1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> USART_CR1_IDLEIE<span class="token punctuation">;</span>
    <span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// only group priority</span>
    <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span> <span class="token comment">// dummy read for clearing IDLE flag</span>
        <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

__weak <span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// waits until transmit buffer is empty</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_SR_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart_send_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> bytes<span class="token punctuation">,</span> u16 size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>u16 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">uart_send_byte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// printf retarget</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_send_byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello world\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"num = %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"this is a debug info. num = %d"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ri-zhi-da-yin-gong-ju-ge-shi-hua-gao-liang-xing-hao">æ—¥å¿—æ‰“å°å·¥å…·ï¼ˆæ ¼å¼åŒ–/é«˜äº®/è¡Œå·ï¼‰</h2>
<h3 id="logger-c">logger.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token keyword">void</span> <span class="token function">log_dump</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> ch<span class="token punctuation">,</span> cl<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ch <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
        cl <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> ch <span class="token operator">+=</span> <span class="token char">'0'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            ch <span class="token operator">+=</span> <span class="token char">'A'</span> <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cl <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> cl <span class="token operator">+=</span> <span class="token char">'0'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            cl <span class="token operator">+=</span> <span class="token char">'A'</span> <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token function">putchar</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putchar</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ch <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ch <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//    printf("\r\n");</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="logger-h">logger.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LOGGER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOGGER_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">USE_LOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_LOG</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">USE_DUMP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_DUMP</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">USE_BLOCK</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_BLOCK</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ONLY_FILENAME</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">strrchr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> </span><span class="token char">'\\'</span><span class="token expression"><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> </span><span class="token char">'\\'</span><span class="token expression"><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> x<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_BLOCK <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BLOCK</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                              </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                             </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                              </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\r\n[BLOCK %s:%d] "</span><span class="token expression"><span class="token punctuation">,</span>               </span><span class="token punctuation">\</span>
			   <span class="token expression"><span class="token function">ONLY_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span>                  </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">",æŒ‰ä»»æ„é”®ç»§ç»­"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>                   </span><span class="token punctuation">\</span>
		<span class="token expression">block_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">while</span> <span class="token punctuation">(</span>block_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                    </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token punctuation">;</span>                                      </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\r\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>                            </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BLOCK</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_LOG <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DEBUG</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                          </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                             </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                              </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\033[1;36m\r\n[DEBUG %s:%d] "</span><span class="token expression"><span class="token punctuation">,</span>     </span><span class="token punctuation">\</span>
			   <span class="token expression"><span class="token function">ONLY_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span>                  </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\33[0m\r\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>                      </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_INFO</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                 </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                   </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                    </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\033[0;32m\r\n[INFO] "</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\33[0m\r\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                          </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                             </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                              </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\033[0;31m\r\n[ERROR %s:%d] "</span><span class="token expression"><span class="token punctuation">,</span>     </span><span class="token punctuation">\</span>
			   <span class="token expression"><span class="token function">ONLY_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span>                  </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\33[0m\r\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>                      </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ASSERT</span><span class="token expression"><span class="token punctuation">(</span>cond<span class="token punctuation">)</span>                                                                                                         </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                                                                                                           </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                                                                                                            </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>cond<span class="token punctuation">)</span><span class="token punctuation">)</span>                                                                                                             </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">{</span>                                                                                                                        </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\r\n[ASSERT] File=[%s],Line=[%ld] Failed to vertify thc condition [\"%s\"]\r\n"</span><span class="token expression"><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> #cond<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">}</span>                                                                                                                        </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DEBUG</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_INFO</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR2</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR3</span><span class="token expression"><span class="token punctuation">(</span>cond<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ERROR4</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_ASSERT</span><span class="token expression"><span class="token punctuation">(</span>cond<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_DUMP <span class="token operator">&gt;</span> <span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DUMP</span><span class="token expression"><span class="token punctuation">(</span>info<span class="token punctuation">,</span> data<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>   </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                   </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                    </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\033[1;36m\r\n[DUMP] "</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span>     </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\r\n\r\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>              </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">log_dump</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>             </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"\33[0m\r\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

	<span class="token keyword">void</span> <span class="token function">log_dump</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG_DUMP</span><span class="token expression"><span class="token punctuation">(</span>info<span class="token punctuation">,</span> data<span class="token punctuation">,</span> len<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LOGGER_H */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">THE END</h1>
]]></content>
      <categories>
        <category>STM32</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>UART</tag>
        <tag>ä¸²å£</tag>
      </tags>
  </entry>
  <entry>
    <title>è®ºæ—¶åºè¦æ±‚çš„é‡è¦æ€§ï¼ˆç§»ä½å¯„å­˜å™¨æ§åˆ¶æ•°ç ç®¡ï¼‰</title>
    <url>/2024/11/15/31801.html</url>
    <content><![CDATA[<h1 id="1-wen-ti-bei-jing">1. é—®é¢˜èƒŒæ™¯</h1>
<h2 id="ying-jian-bei-jing">ç¡¬ä»¶èƒŒæ™¯</h2>
<ul>
<li>ç§»ä½å¯„å­˜å™¨ï¼š<a href="https://item.szlcsc.com/79848.html?fromZone=s_s__%2274HC595N%22">SN74HC595N</a></li>
<li>ä¸¤ä¸ª4ä½å…±é˜³æ•°ç ç®¡</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/20241115163627.png" alt=""></p>
<h2 id="yi-wei-suo-cun-luo-ji-set-reset">ç§»ä½/é”å­˜é€»è¾‘â€”â€”set/reset</h2>
<p>åœ¨å­¦ä¹ GD32F407VETæ—¶ï¼Œå°†å­¦ä¹ STC8å®ç°çš„æ•°ç ç®¡æ¨¡å—ç§»æ¤è¿‡æ¥ï¼Œå‘ç°äº†ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ã€‚å…¶ä¸­ç§»ä½æ“ä½œçš„å®ç°å¦‚ä¸‹ï¼ˆå°è£…äº†å¯¹ä¸¤ä¸ªä¸²è”ç§»ä½å¯„å­˜å™¨çš„ç§»ä½æ“ä½œï¼Œæ§åˆ¶8ä¸ªæ•°ç ç®¡ä¸­æ˜¾ç¤ºå“ªä¸€ä¸ªï¼Œä»¥åŠæ§åˆ¶æ•°ç ç®¡æ˜¾ç¤ºå†…å®¹ï¼‰ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shift</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_DI_PORT<span class="token punctuation">,</span> NIX_DI_PIN<span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> SET <span class="token operator">:</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rck_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘ç°å•ç‹¬æŒ‡å®šæŸä¸ªæ•°ç ç®¡æ˜¾ç¤ºæŸä¸ªæ•°æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// è¦æ˜¾ç¤º1~8å¯¹åº”çš„ç è¡¨</span>
<span class="token class-name">uint8_t</span> code<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0xF9</span><span class="token punctuation">,</span> <span class="token number">0xA4</span><span class="token punctuation">,</span> <span class="token number">0xB0</span><span class="token punctuation">,</span> <span class="token number">0x99</span><span class="token punctuation">,</span> <span class="token number">0x92</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">Int_NixieTube_DisplaySingle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯æƒ³ä½¿ç”¨ <code>for</code>æ§åˆ¶æ•°ç ç®¡è½®æµæ˜¾ç¤º1~8æ—¶ï¼Œå°±å‘ç°æ˜¾ç¤ºçš„å†…å®¹å¹¶ä¸ç¬¦åˆé¢„æœŸï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Int_NixieTube_DisplaySingle</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> code<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="yi-wei-suo-cun-luo-ji-write">ç§»ä½/é”å­˜é€»è¾‘â€”â€”write</h2>
<p>ä½†æ˜¯å°†å…¶ä¸­ <code>gpio_bit</code> çš„ <code>set/reset</code>æ¢æˆ <code>write</code>ä¹‹åï¼Œå‘ç°æ•°ç ç®¡èƒ½å¤ŸæŒ‰ç…§é¢„æœŸæ˜¾ç¤ºäº†ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shift</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_DI_PORT<span class="token punctuation">,</span> NIX_DI_PIN<span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> SET <span class="token operator">:</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">,</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">,</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rck_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">,</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">,</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æŸ¥çœ‹è¿™äº›å‡½æ•°çš„å®ç°ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> gpio_periph<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> pin<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">GPIO_BOP</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> gpio_periph<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> pin<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">GPIO_BC</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> gpio_periph<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> pin<span class="token punctuation">,</span> bit_status bit_value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>RESET <span class="token operator">!=</span> bit_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">GPIO_BOP</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">GPIO_BC</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘ç° <code>write</code>åªä¸è¿‡å°† <code>set/reset</code>åŒ…æˆäº†ä¸€ä¸ªå‡½æ•°ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯å¤šäº†ä¸€ä¸ª <code>if</code>åˆ¤æ–­ã€‚</p>
<p>ä½†æ˜¯ï¼Œä¸€ä¸ª<code>if</code> çš„è€—æ—¶åˆèƒ½å¯¹ç¨‹åºäº§ç”Ÿä»€ä¹ˆå½±å“å‘¢ï¼Ÿæˆ‘ç™¾æ€ä¸å¾—å…¶è§£ã€‚</p>
<h1 id="2-shi-xu-yao-qiu-yin-fa-de-xie-an">2. æ—¶åºè¦æ±‚å¼•å‘çš„è¡€æ¡ˆ</h1>
<h2 id="xiao-xiao-if-an-cang-xuan-ji">å°å°ifæš—è—ç„æœº</h2>
<p>åœ¨å„ç§ <code>Google, GPT</code>ä¹‹åï¼Œç»“åˆä»£ç ä¸Šä¸‹æ–‡ï¼Œå‘ç°ä»£ç ä¸­ä½¿ç”¨äº† <code>nop</code>æ¥å¢åŠ æ—¶å»¶ï¼Œå†ç»“åˆç§»ä½å¯„å­˜å™¨éœ€è¦æ ¹æ®æˆ‘ä»¬é€šè¿‡GPIOå‘é€çš„SRCLKï¼ˆç§»ä½æ—¶é’Ÿï¼‰ã€RCLKï¼ˆé”å­˜æ—¶é’Ÿï¼‰çš„ä¸Šå‡æ²¿æ¥è¿›è¡Œç§»ä½æ“ä½œå’Œé”å­˜æ“ä½œï¼ˆå°†ç§»ä½å¯„å­˜å™¨æ›´æ–°åˆ°é”å­˜å¯„å­˜å™¨ storage registerï¼‰ã€‚</p>
<p>æˆ‘è®¾ç½®çš„GD32F407çš„ä¸»é¢‘æ˜¯168MHzï¼Œè¿™ä¸ªæ¯”STC8æ—¶çš„24MHzè¿˜æ˜¯è¦å¿«å‡ å€çš„ï¼Œè®¡ç®—ä¸€ä¸‹<code>nop</code>å¯¹åº”ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸçš„æ—¶é—´ä¸º <code>1/168MHz</code>çº¦ä¸º <code>5.95ns</code>ã€<code>1/24MHz</code>çº¦ä¸º <code>41.67ns</code>ã€‚</p>
<p>è¿™æ ·çœ‹æ¥ï¼Œä¸€ä¸ª <code>if</code>åˆ¤æ–­è¿˜çœŸæœ‰å¯èƒ½å¼•å‘äº†è¡€æ¡ˆï¼Œå…¶æ‰€æ¶ˆè€—çš„æ—¶é’Ÿå‘¨æœŸï¼ˆå¢åŠ çš„æ—¶å»¶ï¼‰å¯èƒ½æ­£å¥½æ»¡è¶³äº†ç§»ä½å¯„å­˜å™¨çš„<strong>æ—¶åºè¦æ±‚</strong>ï¼Œä»è€Œä½¿å¾—æ•°ç ç®¡èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºã€‚</p>
<h2 id="shu-ju-shou-ce-bu-ke-shao">æ•°æ®æ‰‹å†Œä¸å¯å°‘</h2>
<p>åœ¨æƒ³åˆ°å¯èƒ½æ—¶æ—¶å»¶å¯¼è‡´çš„é—®é¢˜åï¼Œä¸å¦¨çœ‹ä¸€ä¸‹èŠ¯ç‰‡å¯¹åº”çš„å®˜æ–¹æ‰‹å†Œï¼Œçœ‹èƒ½å¦æ‰¾åˆ°ç­”æ¡ˆã€‚</p>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œä¸€å®šè¦æ‰¾ä¸èŠ¯ç‰‡å‹å·ã€å“ç‰Œä¸€è‡´çš„ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241115170556369.png" alt="image-20241115170556369"></p>
<h2 id="timing-requirements">Timing Requirements</h2>
<p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹æ—¶åºè¦æ±‚ï¼ˆTiming Requirements ï¼‰ç›¸å…³çš„ç« èŠ‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241115170729345.png" alt="image-20241115170729345"></p>
<h3 id="set-up-time">Set-up time</h3>
<p>å…¶ä¸­æè¿°äº†ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ä¸²è¡Œä¿¡å·çº¿ <code>SER</code>ã€ç§»ä½å¯„å­˜å™¨æ—¶é’Ÿçº¿ <code>SRCLK</code>ã€é”å­˜å™¨æ—¶é’Ÿçº¿ <code>RCLK</code> æ¥æ“ä½œ <a href="https://item.szlcsc.com/79848.html?fromZone=s_s__%2274HC595N%22">SN74HC595N</a> æ—¶ï¼Œéœ€è¦çš„å‡†å¤‡æ—¶é—´ï¼Œä¾‹å¦‚</p>
<h4 id="ser-before-srclk">SER before SRCLKâ†‘</h4>
<p>åœ¨æ“ä½œSRCLKä¸Šå‡æ²¿å°†SERå­˜å…¥ç§»ä½å¯„å­˜å™¨ä¹‹å‰ï¼ŒSERåº”è¯¥é¢„å¤‡çš„æ—¶é—´ï¼Œä»¥125nsä¸ºä¾‹ï¼Œä¼ªä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">set SER
wait 125ns
SRCLK = 0;
SRCLK = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="srclk-before-rclk">SRCLKâ†‘ before RCLKâ†‘</h4>
<p>åœ¨æ“ä½œå®Œæ‰€æœ‰çš„ç§»ä½åï¼Œå°†ç§»ä½å¯„å­˜å™¨æ›´æ–°åˆ°é”å­˜å¯„å­˜å™¨ï¼ˆå³æ›´æ–°åˆ°ç”µè·¯ï¼Œæ§åˆ¶æ•°ç ç®¡çš„æ®µé€‰å’Œç‰‡é€‰ï¼‰ï¼Œéœ€è¦æ“ä½œRCLKä¸Šå‡æ²¿ã€‚</p>
<p>è¯¥å‚æ•°è§„å®šäº†ï¼ŒRCLKä¸Šå‡æ²¿åº”è¯¥ä¸SRCLKä¸Šå‡æ²¿ä¿æŒçš„æ—¶é—´é—´éš”</p>
<h3 id="pulse-duration">Pulse duration</h3>
<p>å…¶ä¸­æè¿°äº†SRCLKã€RCLKè¢«ç½®ä½ååº”è¯¥æŒç»­ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨ä¸Šè¿°åŸºç¡€ä¸Šå¢åŠ ä¸¤ä¸ªå»¶æ—¶ï¼ˆä»¥100nsä¸ºä¾‹ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">set SER
wait 125ns
SRCLK = 0;
wait 100ns
SRCLK = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†åŠ ä¸Šé”å­˜çš„æ“ä½œï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">set SER
wait 125ns
SRCLK = 0;
wait 100ns
SRCLK = 1;

wait 100ns
RCLK = 0;
wait 100ns
RCLK = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zai-kan-if-he-nop">å†çœ‹ifå’Œnop</h2>
<p>ä¹‹å‰å¯¹äºæ—¶åºæ§åˆ¶çš„ç†è§£å¹¶ä¸æ·±åˆ»ï¼Œç®€å•çš„ä»¥ä¸ºä½¿ç”¨ <code>nop</code>åœé¡¿ä¸€ä¸‹å°±å¥½ã€‚ç°åœ¨çœ‹æ¥ï¼Œæ— è®ºæ˜¯ä¸åŒä¸»é¢‘å¯¹åº”çš„ <code>nop</code>æ—¶å»¶ä¸åŒï¼Œè¿˜æ˜¯ <code>if</code>è€—æ—¶ä¹Ÿèƒ½å½±å“æ•°ç ç®¡çš„ç”Ÿæ­»ï¼Œéƒ½åœ¨æé†’æˆ‘ä»¬æ—¶åºæ§åˆ¶ä¸å¯å°è§‘ã€‚</p>
<p>åœ¨ä½¿ç”¨MCUå¯¹å¤–å›´è®¾å¤‡/èŠ¯ç‰‡äº¤äº’</p>
<p>ã€æ§åˆ¶æ—¶ï¼Œä¸€å®šè¦ä¸¥æ ¼æŒ‰ç…§èŠ¯ç‰‡è¦æ±‚çš„æ—¶åºæ§åˆ¶ï¼Œç»“åˆMCUè‡ªèº«æŒ‡ä»¤è€—æ—¶æ¥ç¼–å†™ç¨‹åºã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shift</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_DI_PORT<span class="token punctuation">,</span> NIX_DI_PIN<span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> SET <span class="token operator">:</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rck_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œå®æ„¿å¤šç­‰ä¸€ç‚¹ï¼Œä¹Ÿä¸è¦è®© SN74HC595N æ— æ³•å‡†ç¡®ç§»ä½ã€é”å­˜æ•°æ®ã€‚</p>
]]></content>
      <categories>
        <category>GD32</category>
        <category>è¸©å‘è®°å½•</category>
      </categories>
      <tags>
        <tag>GD32</tag>
        <tag>SN74HC595NSR</tag>
        <tag>æ—¶åºè¦æ±‚</tag>
        <tag>ç§»ä½å¯„å­˜å™¨</tag>
      </tags>
  </entry>
  <entry>
    <title>é«˜é€Ÿé€šä¿¡åè®®SPIï¼ˆåŸºäºSTM32F103ï¼‰</title>
    <url>/2024/12/08/56962.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<ul>
<li>STM32F103å‚è€ƒæ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx</a></li>
<li>STM32103ZEæ•°æ®æ‰‹å†Œï¼š<a href="https://www.st.com/resource/en/datasheet/stm32f103rc.pdf">STM32F103xC, STM32F103xD, STM32F103xE </a></li>
<li><a href="https://docs.rs-online.com/0d6a/0900766b81622f91.pdf">W25Q32JV Datasheet</a></li>
</ul>
<h1 id="spi-gai-shu">SPIæ¦‚è¿°</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208085758199.png" alt="image-20241208085758199"></p>
<h2 id="wu-li-ceng">ç‰©ç†å±‚</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208085826672.png" alt="image-20241208085826672"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208085922892.png" alt="image-20241208085922892"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208090013844.png" alt="image-20241208090013844"></p>
<h2 id="xie-yi-ceng">åè®®å±‚</h2>
<h3 id="zhu-ji-he-cong-ji-zhi-jian-de-shu-ju-jiao-huan">ä¸»æœºå’Œä»æœºä¹‹é—´çš„æ•°æ®äº¤æ¢</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208090106193.png" alt="image-20241208090106193"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208090214243.png" alt="image-20241208090214243"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208090240645.png" alt="image-20241208090240645"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208090322157.png" alt="image-20241208090322157"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208090347725.png" alt="image-20241208090347725"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208090549989.png" alt="image-20241208090549989"></p>
<h3 id="shi-zhong-de-ji-xing-he-xiang-wei">æ—¶é’Ÿçš„ææ€§å’Œç›¸ä½</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208091011305.png" alt="image-20241208091011305"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208091050562.png" alt="image-20241208091050562"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208091403040.png" alt="STM32å‚è€ƒæ‰‹å†Œ"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208091412303.png" alt="STM32å‚è€ƒæ‰‹å†Œ"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208091524655.png" alt="image-20241208091524655"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208114103130.png" alt="image-20241208114103130"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208114140123.png" alt="image-20241208114140123"></p>
<h1 id="an-li-w-25-q-32">æ¡ˆä¾‹-W25Q32</h1>
<h2 id="w-25-q-32-jie-shao">W25Q32ä»‹ç»</h2>
<p>W25Q32æ˜¯ä¸€ç§ä½¿ç”¨SPIé€šè®¯åè®®çš„<strong>NOR FLASH</strong>å­˜å‚¨å™¨ï¼Œå®ƒçš„CLK/DI/DOå¼•è„šåˆ†åˆ«è¿æ¥åˆ°äº†STM32å¯¹åº”çš„SPIå¼•è„šSCK/MOSI/MISOä¸Šï¼Œå…¶ä¸­STM32çš„NSSå¼•è„šè™½ç„¶æ˜¯å…¶ç‰‡ä¸ŠSPIå¤–è®¾çš„ç¡¬ä»¶å¼•è„šï¼Œä½†å®é™…ä¸Šåé¢çš„ç¨‹åºåªæ˜¯æŠŠå®ƒå½“æˆä¸€ä¸ªæ™®é€šçš„GPIOï¼Œä½¿ç”¨è½¯ä»¶çš„æ–¹å¼æ§åˆ¶NSSä¿¡å·ï¼Œæ‰€ä»¥åœ¨SPIçš„ç¡¬ä»¶è®¾è®¡ä¸­ï¼ŒNSSå¯ä»¥éšä¾¿é€‰æ‹©æ™®é€šçš„GPIOï¼Œä¸å¿…çº ç»“äºé€‰æ‹©ç¡¬ä»¶NSSä¿¡å·ã€‚</p>
<p>FLASH èŠ¯ç‰‡ä¸­è¿˜æœ‰WPå’ŒHOLDå¼•è„šã€‚WPå¼•è„šå¯æ§åˆ¶å†™ä¿æŠ¤åŠŸèƒ½ï¼Œå½“è¯¥å¼•è„šä¸ºä½ç”µå¹³æ—¶ï¼Œç¦æ­¢å†™å…¥æ•°æ®ã€‚æˆ‘ä»¬ç›´æ¥æ¥ç”µæºï¼Œä¸ä½¿ç”¨å†™ä¿æŠ¤åŠŸèƒ½ã€‚HOLDå¼•è„šå¯ç”¨äºæš‚åœé€šè®¯ï¼Œè¯¥å¼•è„šä¸ºä½ç”µå¹³æ—¶ï¼Œé€šè®¯æš‚åœï¼Œæ•°æ®è¾“å‡ºå¼•è„šè¾“å‡ºé«˜é˜»æŠ—çŠ¶æ€ï¼Œæ—¶é’Ÿå’Œæ•°æ®è¾“å…¥å¼•è„šæ— æ•ˆã€‚æˆ‘ä»¬ç›´æ¥æ¥ç”µæºï¼Œä¸ä½¿ç”¨é€šè®¯æš‚åœåŠŸèƒ½ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208132401090.png" alt="image-20241208132401090"></p>
<p>ï¼ˆ1ï¼‰è¿™ä¸ªflashèŠ¯ç‰‡åªæ”¯æŒ<strong>æ¨¡å¼0å’Œæ¨¡å¼3</strong>ã€‚</p>
<p>ï¼ˆ2ï¼‰å†™çš„æ—¶å€™å¿…é¡»æ˜¯å…ˆæ“¦é™¤ï¼Œæ“¦é™¤åå†å†™å…¥ã€‚</p>
<p>ï¼ˆ3ï¼‰ç§»ä½æ˜¯é«˜ä½ä¼˜å…ˆã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208132526999.png" alt="image-20241208132526999"></p>
<h2 id="w-25-q-32-kuang-tu">W25Q32æ¡†å›¾</h2>
<p>4M-byteå­˜å‚¨ç©ºé—´ï¼Œæ‰€éœ€å¯»å€bitä¸º22ï¼Œä¸ºäº†8bitå¯¹é½ï¼Œé‡‡ç”¨24bitç¼–å€</p>
<ul>
<li>[23:16]ï¼šå…¶ä¸­é«˜2ä½æ²¡æœ‰ç”¨ï¼Œä½6ä½ç”¨äºBlockå¯»å€ï¼Œå¯¹åº”64ä¸ªBlock</li>
<li>[15:12]ï¼š4ä¸ªbitç”¨äºSectorå¯»å€ï¼Œå¯¹åº”16ä¸ªSector</li>
<li>[11:8]ï¼š4ä¸ªbitç”¨äºPageå¯»å€ï¼Œå¯¹åº”ä¸€ä¸ªSectorä¸­çš„16ä¸ªPage</li>
<li>[7:0]ï¼š8ä¸ªbitç”¨äºé¡µå†…å­—èŠ‚å¯»å€ï¼Œå¯¹åº”ä¸€ä¸ªPageä¸­çš„256ä¸ªå­—èŠ‚</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208132710140.png" alt="image-20241208132710140"></p>
<h2 id="xie-ru-cao-zuo-zhu-yi-shi-xiang">å†™å…¥æ“ä½œæ³¨æ„äº‹é¡¹</h2>
<p>ï¼ˆ1ï¼‰å†™å…¥æ“ä½œå‰ï¼Œå¿…é¡»å…ˆè¿›è¡Œå†™ä½¿èƒ½ã€‚</p>
<p>ï¼ˆ2ï¼‰æ¯ä¸ªæ•°æ®ä½åªèƒ½ç”±1æ”¹å†™ä¸º0ï¼Œä¸èƒ½ç”±0æ”¹å†™ä¸º1ã€‚</p>
<p>ï¼ˆ3ï¼‰å†™å…¥æ•°æ®å‰å¿…é¡»å…ˆæª«é™¤ï¼Œæª«é™¤åï¼Œæ‰€æœ‰æ•°æ®ä½å˜ä¸º1ã€‚æ“¦é™¤å¿…é¡»æŒ‰æœ€å°æ“¦é™¤å•å…ƒè¿›è¡Œã€‚</p>
<p>ï¼ˆ4ï¼‰è¿ç»­å†™å…¥å¤šå­—èŠ‚æ—¶ï¼Œæœ€å¤šå†™å…¥ä¸€é¡µçš„æ•°æ®ï¼Œè¶…è¿‡é¡µå°¾ä½ç½®çš„æ•°æ®ï¼Œä¼šå›åˆ°é¡µé¦–è¦†ç›–å†™å…¥ã€‚</p>
<p>ï¼ˆ5ï¼‰å†™å…¥æ“ä½œç»“æŸåï¼ŒèŠ¯ç‰‡è¿›å…¥å¿™çŠ¶æ€ï¼Œä¸å“åº”æ–°çš„è¯»å†™æ“ä½œã€‚</p>
<h3 id="xie-shi-neng">å†™ä½¿èƒ½</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208140636281.png" alt="image-20241208140636281"></p>
<h3 id="ye-xie">é¡µå†™</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208142927822.png" alt="image-20241208142927822"></p>
<h3 id="mang-zhuang-tai">å¿™çŠ¶æ€</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208141022091.png" alt="image-20241208141022091"></p>
<h2 id="du-qu-cao-zuo-zhu-yi-shi-xiang">è¯»å–æ“ä½œæ³¨æ„äº‹é¡¹</h2>
<p>ï¼ˆ1ï¼‰ç›´æ¥è°ƒç”¨è¯»å–æ—¶åºï¼Œæ— éœ€è¯»ä½¿èƒ½ï¼Œæ— éœ€é¢å¤–æ“ä½œï¼Œæ²¡æœ‰é¡µçš„é™åˆ¶ã€‚</p>
<p>ï¼ˆ2ï¼‰è¯»å–æ“ä½œç»“æŸåä¸ä¼šè¿›å…¥å¿™çŠ¶æ€ï¼Œä½†ä¸èƒ½åœ¨å¿™çŠ¶æ€æ—¶è¯»å–ã€‚</p>
<h2 id="dian-qi-te-xing-amp-shi-xu-yao-qiu-fen-xi">ç”µæ°”ç‰¹æ€§&amp;æ—¶åºè¦æ±‚åˆ†æ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208144515657.png" alt="W25Q32"></p>
<p>å¦‚å›¾3.3Vå·¥ä½œç”µå‹æ¡ä»¶ä¸‹ï¼ŒSCKæ—¶é’Ÿé¢‘ç‡æœ€é«˜å¯è¾¾133MHzï¼ˆé03hæŒ‡ä»¤ï¼Œ03hæŒ‡ä»¤åˆ™ä¸º50MHzï¼‰ã€‚å¯¹äºSTM32F103è€Œè¨€ï¼ŒGPIOè¾“å‡ºçš„æœ€å¤§é¢‘ç‡ä¸º50MHzï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚</p>
<p>å…¶ä»–æ—¶åºè¦æ±‚å‚æ•°å¤§éƒ½åœ¨10nsä»¥å†…ï¼Œè€ŒSTM32F103çš„ä¸»é¢‘ä¸º72MHzï¼Œæ—¶é’Ÿå‘¨æœŸçº¦ä¸º13.8nsï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¸éœ€è¦åˆ»æ„å»¶æ—¶ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208144853915.png" alt="STM32F103æ•°æ®æ‰‹å†Œ"></p>
<p>å¯¹äºæ“¦é™¤å’Œé¡µå†™ç›¸å…³æ“ä½œï¼Œåˆ™éœ€è¦å¢åŠ ä¸€å®šçš„å»¶æ—¶æ¥ç­‰å¾…èŠ¯ç‰‡å†…éƒ¨å®Œæˆç›¸åº”çš„æ“ä½œã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208145935374.png" alt="image-20241208145935374"></p>
<h2 id="shi-yan-du-qu-han-shang-id-he-she-bei-id">å®éªŒ-è¯»å–å‚å•†IDå’Œè®¾å¤‡ID</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208143740884.png" alt="image-20241208143740884"><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208144153347.png" alt="image-20241208144153347"></p>
<h3 id="spi-h">spi.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SPI_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SPI_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">// CS PC13</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CS_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR13<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CS_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR13<span class="token punctuation">)</span></span></span>

<span class="token comment">// SCK PA5</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCK_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOA<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR5<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCK_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOA<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR5<span class="token punctuation">)</span></span></span>

<span class="token comment">// MOSI PA7</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOSI_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOA<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR7<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOSI_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOA<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR7<span class="token punctuation">)</span></span></span>


<span class="token comment">// MISO PA6</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MISO_READ</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIOA<span class="token operator">-&gt;</span>IDR <span class="token operator">&amp;</span> GPIO_IDR_IDR6<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dataByte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SPI_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="spi-c">spi.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"spi.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPCEN<span class="token punctuation">;</span>

    <span class="token comment">// CS-PC13 å’Œ SCK-PA5ï¼ŒMOSI-PA7 é€šç”¨æ¨æŒ½ MODE=11 CNF=00</span>
    GPIOC<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE13<span class="token punctuation">;</span>
    GPIOC<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF13<span class="token punctuation">;</span>

    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE5<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF5<span class="token punctuation">;</span>

    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE7<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF7<span class="token punctuation">;</span>

    <span class="token comment">// MISO-PA6 æµ®ç©ºè¾“å…¥ MODE=00, CNF=01</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_MODE6<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF6_0<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF6_1<span class="token punctuation">;</span>

    <span class="token comment">// SPIæ¨¡å¼0ï¼ˆææ€§=0ï¼Œç›¸ä½=0ï¼‰ ç©ºé—²çŠ¶æ€ CSæ‹‰é«˜ï¼ˆä½ç”µå¹³ä½¿èƒ½ï¼‰ï¼ŒSCKæ‹‰ä½</span>
    CS_HIGH<span class="token punctuation">;</span>
    SCK_LOW<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> CS_LOW<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> CS_HIGH<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dataByte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> readByte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸»è®¾å¤‡å‡†å¤‡æ•°æ®åˆ°è¾“å‡ºçº¿MOSIä¸Š</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataByte <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MOSI_HIGH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            MOSI_LOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dataByte <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸»è®¾å¤‡æ‹‰é«˜SCKï¼ˆåŒæ–¹å‘é€æ•°æ®é˜¶æ®µï¼‰ï¼Œè®©ä»è®¾å¤‡è¯»å–æ•°æ®</span>
        SCK_HIGH<span class="token punctuation">;</span>
        <span class="token comment">// ä¸»è®¾å¤‡è¯»å–ä»è®¾å¤‡çš„æ•°æ®</span>
        readByte <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MISO_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            readByte <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ä¸»è®¾å¤‡æ‹‰ä½SCKï¼ˆåŒæ–¹å‡†å¤‡æ•°æ®é˜¶æ®µï¼‰ï¼Œè®©ä»è®¾å¤‡å‡†å¤‡ä¸‹ä¸€ä¸ªæ•°æ®</span>
        SCK_LOW<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> readByte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="w-25-q-32-h">w25q32.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__W25Q32_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__W25Q32_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"spi.h"</span></span>

<span class="token keyword">void</span> <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>manufactureID<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>deviceID<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __W25Q32_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="w-25-q-32-c">w25q32.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"w25q32.h"</span></span>

<span class="token keyword">void</span> <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>manufactureId<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>deviceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç‰‡é€‰ä½¿èƒ½</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å‘é€Read JEDEC IDæŒ‡ä»¤9Fhï¼Œè¯»å–ç”Ÿäº§å‚å•†å’Œè®¾å¤‡ID</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x9F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¯»å–ä»è®¾å¤‡å“åº”æ•°æ®</span>
    <span class="token operator">*</span>manufactureId <span class="token operator">=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>deviceId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>deviceId <span class="token operator">|=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">;</span>

    <span class="token comment">// ç‰‡é€‰å¤±èƒ½</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="logger">logger</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208163556410.png" alt="image-20241208163556410"></p>
<h3 id="luo-ji-fen-xi">é€»è¾‘åˆ†æ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208150354261.png" alt="image-20241208150354261"></p>
<h2 id="shi-yan-ca-chu-amp-ye-xie-amp-lian-xu-du">å®éªŒ-æ“¦é™¤&amp;é¡µå†™&amp;è¿ç»­è¯»</h2>
<h3 id="deng-dai-busy-zhuang-tai">ç­‰å¾…BUSYçŠ¶æ€</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208155727798.png" alt="image-20241208155727798"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208155924081.png" alt="image-20241208155924081"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€è¯»å–çŠ¶æ€å¯„å­˜å™¨æŒ‡ä»¤</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è½®è¯¢æ¥æ”¶ä»è®¾å¤‡å“åº”çš„çŠ¶æ€å­—èŠ‚ï¼Œç›´åˆ°å…¶ä¸­çš„æœ€ä½ä½ä¸º0</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ca-chu-shan-qu">æ“¦é™¤æ‰‡åŒº</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208164659395.png" alt="image-20241208164659395"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œæ“¦é™¤å‰å¿…é¡»ç­‰å¾…BUSYçŠ¶æ€å’Œå¼€å¯å†™ä½¿èƒ½</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ye-xie-1">é¡µå†™</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span>
                      <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œé¡µå†™å‰å¿…é¡»ç­‰å¾…BUSYçŠ¶æ€å’Œå¼€å¯å†™ä½¿èƒ½</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> innerAddr<span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€å¾…å†™å…¥æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="lian-xu-du">è¿ç»­è¯»</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208164826767.png" alt="image-20241208164826767"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">W25Q32_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span>
                      <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¯»å–æ•°æ®å‰ç­‰å¾…BUSYçŠ¶æ€</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> innerAddr<span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€å¾…å†™å…¥æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="wan-zheng-dai-ma">å®Œæ•´ä»£ç </h3>
<h4 id="w-25-q-32-h-1">w25q32.h</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__W25Q32_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__W25Q32_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"spi.h"</span></span>

<span class="token keyword">void</span> <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>manufactureID<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>deviceID<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __W25Q32_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="w-25-q-32-h-2">w25q32.h</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"w25q32.h"</span></span>

<span class="token keyword">void</span> <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>manufactureId<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>deviceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç‰‡é€‰ä½¿èƒ½</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å‘é€Read JEDEC IDæŒ‡ä»¤9Fhï¼Œè¯»å–ç”Ÿäº§å‚å•†å’Œè®¾å¤‡ID</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x9F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¯»å–ä»è®¾å¤‡å“åº”æ•°æ®</span>
    <span class="token operator">*</span>manufactureId <span class="token operator">=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>deviceId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>deviceId <span class="token operator">|=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">;</span>

    <span class="token comment">// ç‰‡é€‰å¤±èƒ½</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€è¯»å–çŠ¶æ€å¯„å­˜å™¨æŒ‡ä»¤</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è½®è¯¢æ¥æ”¶ä»è®¾å¤‡å“åº”çš„çŠ¶æ€å­—èŠ‚ï¼Œç›´åˆ°å…¶ä¸­çš„æœ€ä½ä½ä¸º0</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œæ“¦é™¤å‰å¿…é¡»ç­‰å¾…BUSYçŠ¶æ€å’Œå¼€å¯å†™ä½¿èƒ½</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span>
                      <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œé¡µå†™å‰å¿…é¡»ç­‰å¾…BUSYçŠ¶æ€å’Œå¼€å¯å†™ä½¿èƒ½</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> innerAddr<span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€å¾…å†™å…¥æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span>
                      <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¯»å–æ•°æ®å‰ç­‰å¾…BUSYçŠ¶æ€</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> innerAddr<span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€å¾…å†™å…¥æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="main-c">main.c</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"w25q32.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token class-name">uint8_t</span> manufactureId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> deviceId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>manufactureId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// LOG_DEBUG("manufacture = %#x, deviceId = %#x", manufactureId, deviceId)</span>

    <span class="token comment">// æ“¦é™¤æ‰‡åŒºï¼ˆç¬¬63ä¸ªblockï¼Œç¬¬2ä¸ªsectorï¼‰</span>
    <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘ block-63 sector-2 page-10 addr-0å†™å…¥æ•°æ®</span>
    <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"12345678"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_ReadBytes</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buf = %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// uint8_t buf[10] = {0};</span>
    <span class="token comment">// // ä» block-63 sector-2 page-10 addr-2 è¯»å–æ•°æ®</span>
    <span class="token comment">// W25Q32_ReadBytes(63, 2, 10, 2, (uint8_t *)buf, 6);</span>
    <span class="token comment">// LOG_DEBUG("buf = %s", buf);</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="luo-ji-fen-xi-1">é€»è¾‘åˆ†æ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208171056385.png" alt="image-20241208171056385"></p>
<h1 id="stm-32-spi-wai-she">STM32 SPIå¤–è®¾</h1>
<h2 id="jian-jie">ç®€ä»‹</h2>
<p>STM32 çš„ SPI å¤–è®¾å¯ç”¨ä½œé€šè®¯çš„ä¸»æœºåŠä»æœºï¼Œæ”¯æŒæœ€é«˜çš„ SCK æ—¶é’Ÿé¢‘ç‡ä¸º fpclk/2 ï¼ˆSTM32F103 å‹å·çš„èŠ¯ç‰‡é»˜è®¤fpclk1ä¸º36MHzï¼Œfpclk2ä¸º72MHzã€‚ï¼‰ï¼Œå®Œå…¨æ”¯æŒ SPI åè®®çš„ 4 ç§æ¨¡å¼ï¼Œæ•°æ®å¸§é•¿åº¦å¯è®¾ç½®ä¸º 8 ä½æˆ– 16 ä½ï¼Œå¯è®¾ç½®æ•°æ® MSB å…ˆè¡Œæˆ– LSB å…ˆè¡Œã€‚å®ƒè¿˜æ”¯æŒåŒçº¿å…¨åŒå·¥ã€å•çº¿åŒå‘ä»¥åŠå•çº¿æ¨¡å¼ã€‚</p>
<p>STM32F103ç³»åˆ—æä¾›äº†3ä¸ªSPIï¼ŒSPI1æŒ‚åœ¨APB2æ€»çº¿ï¼ŒSPI2/3æŒ‚åœ¨APB1æ€»çº¿ã€‚</p>
<p>ç”¨çš„æ¯”è¾ƒå¤šè¿˜æ˜¯<strong>åŒçº¿å…¨åŒå·¥æ¨¡å¼</strong>ã€‚</p>
<h2 id="kuang-tu">æ¡†å›¾</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208170545574.png" alt="image-20241208170545574"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208170738650.png" alt="image-20241208170738650"></p>
<h3 id="nss-gong-neng-shuo-ming">NSSåŠŸèƒ½è¯´æ˜</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208191830342.png" alt="image-20241208191830342"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208191904550.png" alt="image-20241208191904550"></p>
<h2 id="zhu-she-bei-mo-shi-pei-zhi-liu-cheng-ji-cun-qi-ban-ben">ä¸»è®¾å¤‡æ¨¡å¼é…ç½®æµç¨‹ï¼ˆå¯„å­˜å™¨ç‰ˆæœ¬ï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208180028612.png" alt="image-20241208180028612"></p>
<h3 id="spi-h-1">spi.h</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SPI_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SPI_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">// CS PC13</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CS_HIGH</span> <span class="token expression"><span class="token punctuation">(</span>GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">|=</span> GPIO_ODR_ODR13<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CS_LOW</span> <span class="token expression"><span class="token punctuation">(</span>GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_ODR_ODR13<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dataByte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __SPI_H__ */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="spi-c-1">spi.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"spi.h"</span></span>

<span class="token keyword">void</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPAEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_IOPCEN<span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>APB2ENR <span class="token operator">|=</span> RCC_APB2ENR_SPI1EN<span class="token punctuation">;</span>

    <span class="token comment">// CS-PC13 é€šç”¨æ¨æŒ½ MODE=11 CNF=00</span>
    GPIOC<span class="token operator">-&gt;</span>CRH <span class="token operator">|=</span> GPIO_CRH_MODE13<span class="token punctuation">;</span>
    GPIOC<span class="token operator">-&gt;</span>CRH <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRH_CNF13<span class="token punctuation">;</span>

    <span class="token comment">// SCK-PA5ï¼ŒMOSI-PA7 å¤ç”¨æ¨æŒ½ MODE=11 CNF=10</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE5<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF5_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF5_0<span class="token punctuation">;</span>

    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_MODE7<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF7_1<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF7_0<span class="token punctuation">;</span>

    <span class="token comment">// MISO-PA6 æµ®ç©ºè¾“å…¥ MODE=00, CNF=01</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_MODE6<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">|=</span> GPIO_CRL_CNF6_0<span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>CRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>GPIO_CRL_CNF6_1<span class="token punctuation">;</span>

    <span class="token comment">// æ³¢ç‰¹ç‡é…ç½®ä¸ºPCLK/4 å³ 72M/4=18M =&gt; 001</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>SPI_CR1_BR<span class="token punctuation">;</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> SPI_CR1_BR_0<span class="token punctuation">;</span>
    <span class="token comment">// SPIæ¨¡å¼0ï¼ˆæ—¶é’Ÿææ€§=0ï¼Œç›¸ä½=0ï¼‰</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>SPI_CR1_CPOL<span class="token punctuation">;</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>SPI_CR1_CPHA<span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®å¸§æ ¼å¼ 8bit</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>SPI_CR1_DFF<span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆ</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">&amp;=</span> <span class="token operator">~</span>SPI_CR1_LSBFIRST<span class="token punctuation">;</span>
    <span class="token comment">// NSSä¸ºå½“å‰MCUä½œä¸ºä»è®¾å¤‡æ—¶çš„ç‰‡é€‰ä¿¡å·è¾“å…¥ï¼Œä¸»æ¨¡å¼ä¸‹ï¼Œè¦ä¹ˆç¡¬ä»¶ä¸Šå°†è¯¥å¼•è„šæ‹‰é«˜ï¼Œè¦ä¹ˆé€šè¿‡SSMå’ŒSSIå°†å…¶å¼ºåˆ¶ç½®1</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> SPI_CR1_SSM<span class="token punctuation">;</span> <span class="token comment">// å°†NSSè¾“å…¥é…ç½®ä¸ºè½¯ä»¶æ§åˆ¶</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> SPI_CR1_SSI<span class="token punctuation">;</span> <span class="token comment">// é€šè¿‡SSI=1å°†NSSå¼ºåˆ¶æ‹‰é«˜</span>
    <span class="token comment">// è®¾ç½®ä¸»æ¨¡å¼</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> SPI_CR1_MSTR<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿èƒ½SPIå¤–è®¾</span>
    SPI1<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> SPI_CR1_SPE<span class="token punctuation">;</span>

    <span class="token comment">// SPIæ¨¡å¼0ï¼ˆææ€§=0ï¼Œç›¸ä½=0ï¼‰ ç©ºé—²çŠ¶æ€ CSæ‹‰é«˜ï¼ˆä½ç”µå¹³ä½¿èƒ½ï¼‰ï¼ŒSCKæ‹‰ä½</span>
    CS_HIGH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> CS_LOW<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> CS_HIGH<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dataByte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç­‰å¾…å‘é€ç¼“å†²åŒºä¸ºç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SPI1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> SPI_SR_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å‘é€æ•°æ®</span>
    SPI1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> dataByte<span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…æ¥æ”¶ç¼“å†²åŒºéç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SPI1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> SPI_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ¥æ”¶æ•°æ®</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>SPI1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c-1">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"w25q32.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token class-name">uint8_t</span> manufactureId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> deviceId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>manufactureId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"manufacture = %#x, deviceId = %#x"</span><span class="token punctuation">,</span> manufactureId<span class="token punctuation">,</span> deviceId<span class="token punctuation">)</span>

    <span class="token comment">// æ“¦é™¤æ‰‡åŒºï¼ˆç¬¬63ä¸ªblockï¼Œç¬¬2ä¸ªsectorï¼‰</span>
    <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘ block-63 sector-2 page-10 addr-0å†™å…¥æ•°æ®</span>
    <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"12345678"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_ReadBytes</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buf = %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hal-ku-shi-xian">HALåº“å®ç°</h2>
<h3 id="spi-pei-zhi">SPIé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208201837487.png" alt="image-20241208201837487"></p>
<h3 id="pian-xuan-yin-jiao-pei-zhi">ç‰‡é€‰å¼•è„šé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208201927169.png" alt="image-20241208201927169"></p>
<h3 id="shi-li-dai-ma">ç¤ºä¾‹ä»£ç </h3>
<h4 id="spi-h-2">spi.h</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN Prototypes */</span>
<span class="token keyword">void</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dataByte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END Prototypes */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="spi-c-2">spi.c</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>CS_GPIO_Port<span class="token punctuation">,</span> CS_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>CS_GPIO_Port<span class="token punctuation">,</span> CS_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dataByte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">HAL_SPI_TransmitReceive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hspi1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dataByte<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="main-c-2">main.c</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Initialize all configured peripherals */</span>
<span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_SPI1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN 2 */</span>
  <span class="token class-name">uint8_t</span> manufactureId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">uint16_t</span> deviceId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>manufactureId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"manufacture = %#x, deviceId = %#x\n"</span><span class="token punctuation">,</span> manufactureId<span class="token punctuation">,</span> deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ“¦é™¤æ‰‡åŒºï¼ˆç¬¬63ä¸ªblockï¼Œç¬¬2ä¸ªsectorï¼‰</span>
  <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å‘ block-63 sector-2 page-10 addr-0å†™å…¥æ•°æ®</span>
  <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"12345678"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">W25Q32_ReadBytes</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf = %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 2 */</span>

<span class="token comment">/* Infinite loop */</span>
<span class="token comment">/* USER CODE BEGIN WHILE */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE END WHILE */</span>

  <span class="token comment">/* USER CODE BEGIN 3 */</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="an-li-kua-ye-xie-ru">æ¡ˆä¾‹-è·¨é¡µå†™å…¥</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241208221856087.png" alt="image-20241208221856087"></p>
<h2 id="spi-c-3">spi.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"w25q32.h"</span></span>

<span class="token keyword">void</span> <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>manufactureId<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>deviceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç‰‡é€‰ä½¿èƒ½</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å‘é€Read JEDEC IDæŒ‡ä»¤9Fhï¼Œè¯»å–ç”Ÿäº§å‚å•†å’Œè®¾å¤‡ID</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x9F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¯»å–ä»è®¾å¤‡å“åº”æ•°æ®</span>
    <span class="token operator">*</span>manufactureId <span class="token operator">=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>deviceId <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>deviceId <span class="token operator">|=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">;</span>

    <span class="token comment">// ç‰‡é€‰å¤±èƒ½</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€è¯»å–çŠ¶æ€å¯„å­˜å™¨æŒ‡ä»¤</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è½®è¯¢æ¥æ”¶ä»è®¾å¤‡å“åº”çš„çŠ¶æ€å­—èŠ‚ï¼Œç›´åˆ°å…¶ä¸­çš„æœ€ä½ä½ä¸º0</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œæ“¦é™¤å‰å¿…é¡»ç­‰å¾…BUSYçŠ¶æ€å’Œå¼€å¯å†™ä½¿èƒ½</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span>
                      <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œé¡µå†™å‰å¿…é¡»ç­‰å¾…BUSYçŠ¶æ€å’Œå¼€å¯å†™ä½¿èƒ½</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> innerAddr<span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€å¾…å†™å…¥æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_WriteAddr</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œé¡µå†™å‰å¿…é¡»ç­‰å¾…BUSYçŠ¶æ€å’Œå¼€å¯å†™ä½¿èƒ½</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€å¾…å†™å…¥æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">W25Q32_WriteDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadBytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> block<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> sector<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> page<span class="token punctuation">,</span>
                      <span class="token class-name">uint8_t</span> innerAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¯»å–æ•°æ®å‰ç­‰å¾…BUSYçŠ¶æ€</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€24bitåœ°å€æ•°æ®ï¼Œé«˜8ä½[23:16]ä¸ºblockåœ°å€ï¼Œ[15:12]ä¸ºsectoråœ°å€</span>
    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sector <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> innerAddr<span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¥æ”¶è¯»å–çš„æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">W25Q32_ReadFromAddr</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¯»å–æ•°æ®å‰ç­‰å¾…BUSYçŠ¶æ€</span>
    <span class="token function">W25Q32_WaitNotBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é«˜ä½ä¼˜å…ˆï¼Œé€å­—èŠ‚å‘é€24bit</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¥æ”¶è¯»å–çš„æ•°æ®</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SPI_SwapByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SPI_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="main-c-3">main.c</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"w25q32.h"</span></span>

<span class="token keyword">void</span> <span class="token function">uart1_received_callback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"main start"</span><span class="token punctuation">)</span>

    <span class="token class-name">uint8_t</span> manufactureId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> deviceId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_ReadID</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>manufactureId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"manufacture = %#x, deviceId = %#x"</span><span class="token punctuation">,</span> manufactureId<span class="token punctuation">,</span> deviceId<span class="token punctuation">)</span>

    <span class="token comment">// // æ“¦é™¤æ‰‡åŒºï¼ˆç¬¬63ä¸ªblockï¼Œç¬¬2ä¸ªsectorï¼‰</span>
    <span class="token comment">// W25Q32_SectorErase(63, 2);</span>
    <span class="token comment">// // å‘ block-63 sector-2 page-10 addr-0å†™å…¥æ•°æ®</span>
    <span class="token comment">// W25Q32_WritePage(63, 2, 10, 0, (uint8_t *)"12345678", 8);</span>
    <span class="token comment">// uint8_t buf[10] = {0};</span>
    <span class="token comment">// W25Q32_ReadBytes(63, 2, 10, 1, (uint8_t *)buf, 7);</span>
    <span class="token comment">// LOG_DEBUG("buf = %s", buf);</span>

    <span class="token class-name">uint8_t</span> data<span class="token punctuation">[</span><span class="token number">261</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">260</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'a'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"data = %s"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

    <span class="token class-name">uint32_t</span> addr <span class="token operator">=</span> <span class="token number">0x32f680</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_SectorErase</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint16_t</span> size1 <span class="token operator">=</span> <span class="token number">0xFF</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_WriteAddr</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> data<span class="token punctuation">,</span> size1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">uint16_t</span> size2 <span class="token operator">=</span> <span class="token number">260</span> <span class="token operator">-</span> size1<span class="token punctuation">;</span>
    <span class="token function">W25Q32_WritePage</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data <span class="token operator">+</span> size1<span class="token punctuation">,</span> size2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">W25Q32_ReadFromAddr</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">260</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"buf = %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>STM32</category>
        <category>åè®®</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>SPI</tag>
      </tags>
  </entry>
</search>
