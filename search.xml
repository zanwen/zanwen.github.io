<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆä¸€ï¼‰å·¥ä½œæ¨¡å¼åŠå¯„å­˜å™¨èµ„æº</title>
    <url>/2024/11/23/1780.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/ddi0406/latest/">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
<h1 id="arm-he-ar-mv-7-a-r-gong-zuo-mo-shi">ARMæ ¸ï¼ˆARMv7-A/Rï¼‰å·¥ä½œæ¨¡å¼</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123192806705.png" alt="Table B1-1 ARM processor modes  "></p>
<ul>
<li>
<p>ä»å¼‚å¸¸æ¨¡å¼æ¥çœ‹ï¼Œåªæœ‰ User å’Œ System æ˜¯éå¼‚å¸¸æ¨¡å¼ï¼›</p>
</li>
<li>
<p>ä»ç‰¹æƒçº§åˆ«æ¥çœ‹ï¼Œåªæœ‰ User æ˜¯éç‰¹æƒçº§åˆ«ï¼›</p>
</li>
</ul>
<h2 id="privilege-level">Privilege Level</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123192948933.png" alt="Privilege Level"></p>
<h2 id="arm-processor-modes">ARM Processor Modes</h2>
<h3 id="user-mode">User mode</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123193912894.png" alt="image-20241123193912894"></p>
<ul>
<li>æ“ä½œç³»ç»Ÿé€šè¿‡åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œå¼•ç”¨ç¨‹åºæ¥é™åˆ¶å…¶å¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—®ï¼Œä¾‹å¦‚æ–‡ä»¶ã€è¿›ç¨‹ç­‰ã€‚</li>
<li>ç”¨æˆ·æ¨¡å¼ä¸‹çš„ä»»ä½•åº”ç”¨ç¨‹åºä¸èƒ½åˆ‡æ¢æ¨¡å¼ï¼Œé™¤éé€šè¿‡è½¯ä¸­æ–­æˆ–å¼‚å¸¸ã€‚</li>
</ul>
<h3 id="system-mode">System mode</h3>
<blockquote>
<p>Software executing in System mode executes at PL1. System mode has the same registers available</p>
<p>as User mode, and is not entered by any exception</p>
</blockquote>
<p>åœ¨ç³»ç»Ÿæ¨¡å¼ä¸‹è¿è¡Œçš„è½¯ä»¶æ‹¥æœ‰PL1çš„ç‰¹æƒï¼Œèƒ½å¤Ÿè®¿é—®ä¸€äº›å—æ§èµ„æºã€‚ç³»ç»Ÿæ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼å…±ç”¨åŒä¸€å¥—å¯ç”¨çš„å¯„å­˜å™¨ï¼Œå¹¶ä¸”æ— æ³•é€šè¿‡ä»»ä½•å¼‚å¸¸æ¥è¿›å…¥è¯¥æ¨¡å¼ã€‚</p>
<h3 id="supervisor-mode">Supervisor mode</h3>
<blockquote>
<p>Supervisor mode is the default mode to which a Supervisor Call exception is taken.<br>
Executing a SVC (Supervisor Call) instruction generates an Supervisor Call exception, that is taken<br>
to Supervisor mode.<br>
A processor enters Supervisor mode on Reset.</p>
</blockquote>
<p>ç®¡ç†æ¨¡å¼æ˜¯CPUä¸Šç”µåé»˜è®¤çš„æ¨¡å¼ï¼Œå› æ­¤åœ¨è¯¥æ¨¡å¼ä¸‹ä¸»è¦ç”¨æ¥åšç³»ç»Ÿçš„åˆå§‹åŒ–ï¼Œè½¯ä¸­æ–­å¤„ç†ä¹Ÿåœ¨è¯¥æ¨¡å¼ä¸‹ã€‚</p>
<p>å½“ç”¨æˆ·æ¨¡å¼ä¸‹çš„ç”¨æˆ·ç¨‹åºè¯·æ±‚ä½¿ç”¨ç¡¬ä»¶èµ„æºæ—¶ï¼Œé€šè¿‡è½¯ä»¶ä¸­æ–­è¿›å…¥è¯¥æ¨¡å¼ã€‚</p>
<h3 id="abort-mode">Abort mode</h3>
<blockquote>
<p>Abort mode is the default mode to which a Data Abort exception or Prefetch Abort exception is<br>
taken</p>
</blockquote>
<p>ç»ˆæ­¢æ¨¡å¼æ˜¯æ•°æ®ç»ˆæ­¢å¼‚å¸¸æˆ–æŒ‡ä»¤é¢„å–ç»ˆæ­¢å¼‚å¸¸å‘ç”Ÿæ—¶é»˜è®¤è¿›å…¥çš„æ¨¡å¼ã€‚</p>
<p>æ•°æ®ç»ˆæ­¢å¼‚å¸¸ï¼šå½“ç”¨æˆ·ç¨‹åºè®¿é—®éæ³•åœ°å€ã€æ²¡æœ‰æƒé™è¯»å–çš„åœ°å€æ—¶ä¼šå‘ç”Ÿè¯¥å¼‚å¸¸ã€‚ä¾‹å¦‚linuxä¸‹ç¼–ç¨‹æ—¶ç»å¸¸é‡åˆ°çš„<code>segment fault</code>ï¼š</p>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/%E8%A8%98%E6%86%B6%E9%AB%94%E5%8D%80%E6%AE%B5%E9%8C%AF%E8%AA%A4">ä»¥ä¸‹æ˜¯ä¸€äº›å¯¼è‡´å‚¨å­˜å™¨æ®µé”™è¯¯çš„ä¸€èˆ¬ç¼–ç¨‹é”™è¯¯</a>ï¼š</p>
<ul>
<li>å¼•ç”¨ç©ºæŒ‡é’ˆ</li>
<li>å¼•ç”¨æœªåˆå§‹åŒ–çš„é‡æŒ‡é’ˆ</li>
<li>å¼•ç”¨å·²ç»è¢«è°ƒç”¨free()å‡½æ•°é‡Šæ”¾äº†çš„æ‚¬ç©ºæŒ‡é’ˆ</li>
<li>ç¼“å†²åŒºæº¢å‡º</li>
<li>å †æ ˆæº¢å‡º</li>
<li>è¿è¡Œæœªæ­£ç¡®ç¼–è¯‘çš„ç¨‹åºï¼ˆå°½ç®¡å­˜åœ¨ç¼–è¯‘æ—¶é”™è¯¯ï¼ŒæŸäº›ç¼–è¯‘å™¨ä¾ç„¶ä¼šè¾“å‡ºå¯æ‰§è¡Œæ–‡ä»¶ï¼‰</li>
</ul>
</blockquote>
<p>é¢„å–æŒ‡ä»¤å¼‚å¸¸ï¼šé¢„å–æŒ‡ä»¤æ˜¯æŒ‡ä»¤æµæ°´çº¿ä¸­çš„æ¦‚å¿µã€‚è¯¥å¼‚å¸¸å‘ç”Ÿåœ¨é¢„å–æŒ‡ä»¤æ—¶æ— æ³•è·å–åˆ°æ­£ç¡®çš„å¯æ‰§è¡ŒæŒ‡ä»¤ï¼Œæˆ‘ä»¬æœ‰æ—¶è¿è¡Œé”™è¯¯ä»£ç ä¼šå‡ºç°ç¨‹åºè·‘é£äº†çš„æƒ…å†µå°±æ˜¯å› ä¸ºé¢„å–ä¸åˆ°æ­£ç¡®çš„æŒ‡ä»¤äº†ï¼ŒCPUæ— æ³•ç»§ç»­æ­£å¸¸æ‰§è¡Œã€‚</p>
<h3 id="undefined-mode">Undefined mode</h3>
<blockquote>
<p>Undefined mode is the default mode to which an instruction-related exception, including any<br>
attempt to execute an UNDEFINED instruction, is taken</p>
</blockquote>
<p>å½“CPUé‡åˆ°ä¸€ä¸ªå®ƒæ— æ³•è¯†åˆ«çš„æŒ‡ä»¤æ—¶å‘ç”Ÿè¯¥å¼‚å¸¸ã€‚ä¾‹å¦‚åœ¨ARMæ¶æ„çš„CPUä¸Šæ‰§è¡Œä¸€æ¡IntelæŒ‡ä»¤ã€‚</p>
<h3 id="fiq-mode">FIQ mode</h3>
<blockquote>
<p>FIQ mode is the default mode to which an FIQ interrupt is taken.</p>
</blockquote>
<p>FIQæ˜¯Fast Interrupt reQuetstï¼Œå¿«é€Ÿä¸­æ–­æ¨¡å¼ã€‚å¿«é€Ÿæ˜¯ç›¸å½“äºä¸€èˆ¬ä¸­æ–­æ¨¡å¼ï¼ˆIRQï¼‰è€Œè¨€çš„ï¼Œç”¨æ¥å¤„ç†å¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒç´§æ€¥çš„ä¸­æ–­ï¼Œä¸»è¦ç”¨äºé«˜é€Ÿæ•°æ®ä¼ è¾“åŠé€šé“å¤„ç†ä¸­ã€‚</p>
<h3 id="irq-mode">IRQ mode</h3>
<p>ä¸€èˆ¬ä¸­æ–­æ¨¡å¼ï¼Œä¹Ÿç§°æ™®é€šä¸­æ–­æ¨¡å¼ï¼Œç”¨äºå¤„ç†ä¸€èˆ¬çš„ä¸­æ–­è¯·æ±‚ã€‚é€šå¸¸åœ¨ç¡¬ä»¶ä¸­æ–­å‘ç”Ÿåè‡ªåŠ¨è¿›å…¥è¯¥æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸ºç‰¹æƒæ¨¡å¼ï¼Œèƒ½å¤Ÿè‡ªç”±è®¿é—®ç³»ç»Ÿç¡¬ä»¶èµ„æºã€‚</p>
<h1 id="arm-he-ji-cun-qi-zi-yuan">ARMæ ¸å¯„å­˜å™¨èµ„æº</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123201917744.png" alt="image-20241123201917744"></p>
<h2 id="gai-lan">æ¦‚è§ˆ</h2>
<h3 id="ji-cun-qi-gong-xiang">å¯„å­˜å™¨å…±äº«</h3>
<p>R0~R7è¿™å‡ ä¸ªå¯„å­˜å™¨æ˜¯æ‰€æœ‰æ¨¡å¼å…±äº«çš„ï¼Œè¿™æ„å‘³ç€åœ¨æ¨¡å¼å‘ç”Ÿåˆ‡æ¢æ—¶ï¼Œä¸ºäº†ä¸å½±å“å…ˆå‰æ¨¡å¼çš„å¯„å­˜å™¨æ•°æ®ï¼Œå½“å‰æ¨¡å¼éœ€è¦åœ¨ä½¿ç”¨è¿™äº›å¯„å­˜å™¨ä¹‹å‰å…ˆå°†å®ƒä»¬å‹æ ˆï¼ˆå†…å­˜åŒºåŸŸä¸­çš„æ ˆï¼‰ä¿å­˜ï¼Œå¹¶åœ¨æ¨¡å¼é€€å‡ºæ—¶å‡ºæ ˆä»¥å°†å¯„å­˜å™¨æ¢å¤æˆåŸæ ·ã€‚</p>
<p>åŒæ ·çš„R8~R12æ˜¯é™¤äº†FIQçš„æ‰€æœ‰æ¨¡å¼å…±äº«çš„ã€‚</p>
<h3 id="ji-cun-qi-du-you">å¯„å­˜å™¨ç‹¬æœ‰</h3>
<p>å¯¹äºR8~R12ï¼ŒFIQç”±è‡ªå·±ç‹¬æœ‰çš„å¯„å­˜å™¨ï¼Œè¿™æ˜¯ä¸ºäº†æé«˜è¯¥æ¨¡å¼çš„å¤„ç†æ•ˆç‡ï¼šåœ¨è¿›å…¥è¯¥æ¨¡å¼åï¼Œè®¿é—®è¿™å‡ ä¸ªå¯„å­˜å™¨æ— éœ€å‹æ ˆä¿æŠ¤å’Œå‡ºæ ˆå¤åŸã€‚<mark>è¿™ä¹Ÿæ˜¯FIQæ¯”IRQå¿«çš„åŸå› ä¹‹ä¸€ã€‚</mark></p>
<h3 id="yi-chang-mo-shi-ji-cun-qi">å¼‚å¸¸æ¨¡å¼å¯„å­˜å™¨</h3>
<p>å¯ä»¥å‘ç°ï¼Œå¯¹äºSPå’ŒLRå¯„å­˜å™¨ï¼Œé™¤äº†Userå’ŒSystemä¸¤ä¸ªéå¼‚å¸¸æ¨¡å¼ï¼Œå…¶ä»–æ¨¡å¼éƒ½å¯¹åº”æœ‰è‡ªå·±ç‹¬ç«‹çš„ã€‚å®ƒä»¬ä¸å¼‚å¸¸è·³è½¬æœ‰å…³ã€‚</p>
<h3 id="pc-ji-cun-qi">PCå¯„å­˜å™¨</h3>
<p>PCï¼ˆProgram Counterï¼‰ç¨‹åºè®¡æ•°å™¨ç”¨æ¥æŒ‡å‘æŒ‡ä»¤åœ°å€ï¼Œåœ¨32ä½CPUé¡ºåºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤ç›¸éš”4ä¸ªå­—èŠ‚ï¼Œåœ°å€ç›¸éš”0x4ï¼Œé€šè¿‡å°†PCçš„å€¼ä¾æ¬¡é€’å¢0x4å°±èƒ½å®ç°é¡ºåºæ‰§è¡Œçš„æ•ˆæœã€‚</p>
<p>ä½†æ˜¯å‘ç”Ÿæ¨¡å¼åˆ‡æ¢æ—¶ï¼Œéœ€è¦ä¿®æ”¹PCçš„å€¼ä»¥å‘Šè¯‰CPUä»å“ªé‡Œå¼€å§‹æ¥ç€æ‰§è¡Œç¨‹åºæŒ‡ä»¤ã€‚</p>
<h3 id="cpsr-spsr">CPSR/SPSR</h3>
<p>Current Program Status Registerï¼Œå½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼Œå…¶ä¸­åŒ…å«äº†å½“å‰ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€äº›çŠ¶æ€ä½ï¼Œä¾‹å¦‚</p>
<ul>
<li>Nï¼šnegtiveï¼Œè´Ÿæ•°æ ‡å¿—ï¼Œä¾‹å¦‚æ¯”è¾ƒæŒ‡ä»¤ <code>cmp</code> å°±æ˜¯å°†ä¸€ä¸ªæ•°å‡å»å¦ä¸€ä¸ªæ•°ï¼Œå¦‚æœç»“æœä¸ºè´Ÿï¼Œåˆ™å°†Nä½ç½®1ï¼Œåç»­æŒ‡ä»¤å¯ä»¥é€šè¿‡å¢åŠ æ¡ä»¶åç¼€ <code>lt</code>ã€<code>le</code>ï¼ˆless thanã€less than or equals toï¼‰ç»“åˆNæ ‡å¿—ä½æ¥å®ç°ç±»ä¼¼ <code>if</code>æ¡ä»¶çš„æ•ˆæœ</li>
<li>Cï¼šcarryï¼Œè¿›ä½æ ‡å¿—</li>
</ul>
<p>å¯ä»¥ç†è§£è¿™ä¸ªå¯„å­˜å™¨ä¿å­˜äº†å½“å‰ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<p>Saved Program Status Registerï¼Œæš‚å­˜çš„ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ã€‚å½“å‘ç”Ÿæ¨¡å¼åˆ‡æ¢æ—¶ï¼Œåº”é€šè¿‡SPSRä¿å­˜CPSRï¼ˆä¹‹å‰çš„ç¨‹åºè¿è¡ŒçŠ¶æ€ï¼‰ï¼Œå¹¶åœ¨è¿”å›æ—¶å°†SPSRä¼šå†™åˆ°CPSRã€‚</p>
<h2 id="ji-cun-qi-yong-tu-fen-xi">å¯„å­˜å™¨ç”¨é€”åˆ†æ</h2>
<h3 id="tong-yong-ji-cun-qi-r-0-10">é€šç”¨å¯„å­˜å™¨R0~10</h3>
<p>ç”¨æ¥å­˜æ”¾ç”¨æˆ·çš„æ•°æ®ï¼Œä¾‹å¦‚å‡½æ•°å…¥å‚ã€å‡½æ•°è¿”å›å€¼ç­‰</p>
<h3 id="zhan-xiang-guan-ji-cun-qi">æ ˆç›¸å…³å¯„å­˜å™¨</h3>
<ul>
<li>
<p>R11ï¼ˆfp: frame pointerï¼‰ï¼šç”¨æ¥è®°å½•ä¸€ä¸ªæ ˆç©ºé—´çš„å¼€å§‹åœ°å€</p>
</li>
<li>
<p>R12ï¼ˆipï¼šThe Intra-Procedure-call scratch registerï¼‰ç”¨æ¥ä¸´æ—¶å­˜å‚¨sp</p>
</li>
<li>
<p>R13ï¼ˆspï¼šstack pointerï¼‰ï¼šæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆæŒ‡å‘æ ˆé¡¶ï¼‰ï¼Œå‹æ ˆæ—¶æ ¹æ®è¯¥å¯„å­˜å™¨ä¸­çš„åœ°å€å­˜æ”¾æ•°æ®å¹¶æ›´æ–°æ ˆæŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªä½ç½®</p>
</li>
</ul>
<p><mark>æ ˆç©ºé—´çš„è®¡ç®—ï¼šsp - fp</mark></p>
<h3 id="tiao-zhuan-xiang-guan-branch-ji-cun-qi">è·³è½¬ç›¸å…³ï¼ˆbranchï¼‰å¯„å­˜å™¨</h3>
<ul>
<li>R14ï¼ˆlrï¼Œlink registerï¼‰ï¼šåœ¨å‘ç”Ÿè·³è½¬ï¼ˆå‡½æ•°è°ƒç”¨ï¼Œä¸­æ–­å¤„ç†ï¼‰æ—¶ï¼Œç”¨æ¥ä¿å­˜PCå¯„å­˜å™¨çš„å€¼ã€‚åé¢é€šè¿‡å°†lrä¼šå†™PCå³å¯å®ç°è·³è½¬åçš„è¿”å›ã€‚</li>
</ul>
<h3 id="pc-ji-cun-qi-1">PCå¯„å­˜å™¨</h3>
<p>program counterï¼šç”¨æ¥å­˜æ”¾CPUéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚</p>
<p>ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸ºcounterè®¡æ•°å™¨ï¼Œæ˜¯å› ä¸ºæŒ‡ä»¤å®½åº¦æ˜¯å›ºå®šçš„ï¼ˆä¾‹å¦‚ARMv7ä¸­æ˜¯32ä½å­—å®½ï¼‰ï¼Œé€šè¿‡åœ¨å½“å‰æŒ‡ä»¤çš„åœ°å€ä¸Šåç§»å›ºå®šçš„æŒ‡ä»¤ä½å®½ï¼ˆä¾‹å¦‚4ä¸ªå­—èŠ‚+0x4ï¼‰å°±èƒ½å–åˆ°é¡ºåºçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>
<h2 id="cpsr-cheng-xu-zhuang-tai-ji-cun-qi">CPSRï¼ˆç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124085427517.png" alt="image-20241124085427517"></p>
<h3 id="tiao-jian-biao-zhi-wei-ke-bei-xu-duo-zhi-ling-she-zhi">æ¡ä»¶æ ‡å¿—ä½ï¼ˆå¯è¢«è®¸å¤šæŒ‡ä»¤è®¾ç½®ï¼‰</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123230843319.png" alt="image-20241123230843319"></p>
<h3 id="n-fu-hao-tiao-jian-biao-zhi-wei">N-è´Ÿå·æ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Negative condition flag. Set to bit[31] of the result of the instruction. If the result is<br>
regarded as a twoâ€™s complement signed integer, then the processor sets N to 1 if the result<br>
is negative, and sets N to 0 if it is positive or zero.</p>
</blockquote>
<p>å½“æŒ‡ä»¤çš„ç»“æœä¸ºæœ‰ç¬¦å·æ•´æ•°æ—¶ï¼Œå¤„ç†å™¨ä¼šåœ¨è¯¥ç»“æœä¸ºè´Ÿæ•°æ—¶å°†Nç½®1ã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰æ—¶éœ€è¦æ ¹æ®æ¡ä»¶æ¥è·³è½¬ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">&gt;=</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”æŒ‡ä»¤ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov r0,a // å°†aåŠ è½½åˆ°r0å¯„å­˜å™¨
mov r1,b // å°†båŠ è½½åˆ°r1å¯„å­˜å™¨
cmp r0,r1 // é€šè¿‡r0-r1æ¥æ¯”è¾ƒä¸¤è€…çš„å€¼ï¼Œå¦‚æœç»“æœä¸ºè´Ÿæ•°åˆ™å°†Nç½®1ï¼Œå¦åˆ™ç½®0
bgt foo // bï¼šbranchåˆ†æ”¯è·³è½¬ gtï¼šgreater thanï¼Œå¦‚æœN=0ï¼ˆa&gt;=bï¼‰ï¼Œåˆ™è·³è½¬åˆ°fooå‡½æ•°å…¥å£åœ°å€
ble fun // leï¼šless than or equals toï¼Œå¦‚æœN=1ï¼ˆa&lt;bï¼‰ï¼Œåˆ™è·³è½¬åˆ°funå‡½æ•°å…¥å£åœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="z-ling-tiao-jian-biao-zhi-wei">Z-é›¶æ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Zero condition flag. Set to 1 if the result of the instruction is zero, and to 0 otherwise. A<br>
result of zero often indicates an equal result from a comparison</p>
</blockquote>
<p>å½“æŒ‡ä»¤ç»“æœä¸º0æ—¶ä¼šå°†Zç½®1ã€‚Zä½ä¸º1é€šå¸¸æ ‡ç¤ºäº†ä¸€ä¸ªç»“æœä¸º0çš„æ¯”è¾ƒæŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”æŒ‡ä»¤ ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov r0,a
mov r1,b
cmp r0,r1 // é€šè¿‡r0-r1æ¥æ¯”è¾ƒä¸¤è€…çš„å€¼ï¼Œå¦‚æœç»“æœä¸º0åˆ™å°†Zç½®1ï¼ˆå½“ç„¶ä¹Ÿä¼šå°†Nç½®0ï¼‰
beq foo // bï¼šbranchåˆ†æ”¯è·³è½¬ eqï¼šequals toï¼Œå¦‚æœZ=1ï¼Œåˆ™è·³è½¬fooå‡½æ•°å…¥å£åœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="c-jin-wei-tiao-jian-biao-zhi-wei">C-è¿›ä½æ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Carry condition flag. Set to 1 if the instruction results in a carry condition, for example an<br>
unsigned overflow on an addition.</p>
</blockquote>
<p>å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿäº†è¿›ä½ï¼Œåˆ™Cä½ä¼šè¢«ç½®1ã€‚ä¾‹å¦‚åŠ æ³•è¿‡ç¨‹ä¸­çš„æ— ç¬¦å·æº¢å‡ºã€‚ä»¥ <code>uint32_t</code>ä¸ºä¾‹ï¼Œæœ€å¤§ä¸º <code>0xFFFFFFFF</code>ï¼Œå¦‚æœå¯¹å…¶è¿›è¡ŒåŠ æ³•æ“ä½œåˆ™ä¼šäº§ç”Ÿè¿›ä½ï¼Œä¾‹å¦‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint32_t</span> a <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// äº§ç”Ÿè¿›ä½ï¼ŒCè¢«ç½®1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="v-yi-chu-tiao-jian-biao-zhi-wei">V-æº¢å‡ºæ¡ä»¶æ ‡å¿—ä½</h3>
<blockquote>
<p>Overflow condition flag. Set to 1 if the instruction results in an overflow condition, for<br>
example a signed overflow on an addition</p>
</blockquote>
<p>å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿäº†æº¢å‡ºï¼ˆ<mark>è¶…è¿‡äº†æ•°æ®ç±»å‹çš„è¡¨ç¤ºèŒƒå›´</mark>ï¼‰ï¼Œä¾‹å¦‚åŠ æ³•ä¸­çš„æœ‰ç¬¦å·æº¢å‡ºï¼Œåˆ™ä¼šå°†è¯¥ä½ç½®1ã€‚è¿™é‡Œè¦å’ŒCä½åŒºåˆ†å¼€æ¥ï¼ŒCä½æ˜¯é’ˆå¯¹æ— ç¬¦å·çš„ï¼ˆè¿ç®—ä¸è€ƒè™‘ç¬¦å·ä½ï¼‰ï¼ŒVæ˜¯é’ˆå¯¹æœ‰ç¬¦å·çš„ã€‚ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">signed</span> <span class="token keyword">char</span> ch <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>
<span class="token keyword">signed</span> <span class="token keyword">char</span> tmp <span class="token operator">=</span> ch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// æœ‰ç¬¦å·charæœ€å¤§å€¼ä¸º127ï¼ŒåŠ 1åä¸º128è¶…è¿‡äº†charçš„æ ‡ç¤ºèŒƒå›´ï¼ˆ-128~127ï¼‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="i-f-jin-yong-biao-zhi-wei">I/F-ç¦ç”¨æ ‡å¿—ä½</h3>
<p>Iä½ç½®1æ ‡ç¤ºç¦ç”¨IRQå¼‚å¸¸ï¼ŒFä½ç½®1æ ‡ç¤ºç¦ç”¨FIQå¼‚å¸¸</p>
<blockquote>
<p>In an implementation that does not include the Security Extensions, setting a mask bit masks the<br>
corresponding exception, meaning it cannot be taken</p>
</blockquote>
<h3 id="t-biao-zhi-wei">Tæ ‡å¿—ä½</h3>
<p>æ ‡ç¤ºäº†å¤„ç†å™¨æŒ‡ä»¤é›†çš„çŠ¶æ€ï¼š</p>
<ul>
<li>ARMçŠ¶æ€ï¼š32ä½æŒ‡ä»¤</li>
<li>ThumbçŠ¶æ€ï¼š16ä½æŒ‡ä»¤ï¼ˆå¯ä»¥ç†è§£ä½ARMæŒ‡ä»¤çš„å‹ç¼©ç‰ˆï¼‰</li>
</ul>
<h3 id="m-biao-zhi-wei">Mæ ‡å¿—ä½</h3>
<p>æ ‡ç¤ºå¤„ç†å™¨å½“å‰çš„å·¥ä½œæ¨¡å¼ï¼Œå‚è§æœ¬æ–‡ <mark>ARM&nbsp;Processor&nbsp;Modes</mark>å¯¹åº”çš„ç« èŠ‚ã€‚</p>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆäºŒï¼‰æŒ‡ä»¤é›†</title>
    <url>/2024/11/24/18972.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/ddi0406/cd/?lang=en">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
<h1 id="mdk-huan-jing-da-jian">MDKç¯å¢ƒæ­å»º</h1>
<h2 id="xia-zai-legacy-support-zhi-chi-bao">ä¸‹è½½Legacy Supportæ”¯æŒåŒ…</h2>
<p><a href="https://armkeil.blob.core.windows.net/legacy/MDK79525.EXE">https://armkeil.blob.core.windows.net/legacy/MDK79525.EXE</a></p>
<p>å®‰è£…åˆ°MDKçš„å®‰è£…ç›®å½•ä¸‹</p>
<h2 id="xia-zai-arm-gnu-gong-ju-lian">ä¸‹è½½ARM GNUå·¥å…·é“¾</h2>
<p><a href="https://developer.arm.com/-/media/Files/downloads/gnu/13.3.rel1/binrel/arm-gnu-toolchain-13.3.rel1-mingw-w64-i686-arm-none-eabi.exe">https://developer.arm.com/-/media/Files/downloads/gnu/13.3.rel1/binrel/arm-gnu-toolchain-13.3.rel1-mingw-w64-i686-arm-none-eabi.exe</a></p>
<blockquote>
<p><a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads">ä¸‹è½½é¡µé¢</a></p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124092507291.png" alt="image-20241124092507291" style="zoom:50%;">
<h2 id="chuang-jian-xiang-mu">åˆ›å»ºé¡¹ç›®</h2>
<p>å®‰è£…Legacy Supportä¹‹åï¼Œå¯ä»¥åœ¨Deviceä¸­å¯¹å…¶è¿›è¡Œé€‰æ‹©</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124091834836.png" alt="image-20241124091834836"></p>
<p>ç„¶åé€‰æ‹©ARM9E-Sï¼ˆLittle Endianï¼‰è¿›è¡Œä»¿çœŸ</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124092007126.png" alt="image-20241124092007126" style="zoom:50%;">
<p>é”®å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1
	mov r1,#2
	mov r2,#3
	
stop:
	b stop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093601960.png" alt="image-20241124093601960" style="zoom:50%;">
<h2 id="pei-zhi-arm-gnu-gong-ju-lian">é…ç½®ARM GNUå·¥å…·é“¾</h2>
<p>é…ç½®äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼Œå³æ­¤å‰ä¸‹è½½çš„ARM GNUçš„å®‰è£…è·¯å¾„</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093644442.png" alt="image-20241124093644442" style="zoom: 50%;">
<h2 id="bian-yi-xiang-mu">ç¼–è¯‘é¡¹ç›®</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093742741.png" alt="image-20241124093742741" style="zoom:50%;">
<h2 id="fang-zhen-diao-shi-pei-zhi">ä»¿çœŸ/è°ƒè¯•é…ç½®</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124093931756.png" alt="image-20241124093931756" style="zoom: 50%;">
<p>é…ç½®ä»£ç æ®µå¼€å§‹åœ°å€ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094012862.png" alt="image-20241124094012862" style="zoom:50%;">
<p><mark>æ³¨æ„</mark>ï¼šæ¯æ¬¡ä¿®æ”¹äº†ç¼–è¯‘é…ç½®é€‰é¡¹åï¼Œæœ€å¥½é‡æ–°ç¼–è¯‘ä¸€ä¸‹ä»¥ä½¿å…¶ç”Ÿæ•ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094203216.png" alt="image-20241124094203216"></p>
<h2 id="kai-shi-diao-shi">å¼€å§‹è°ƒè¯•</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094253900.png" alt="image-20241124094253900"></p>
<p>å¦‚æœç‚¹å‡»è°ƒè¯•æŒ‰é’®åå‡ºç°å¦‚ä¸Šç•Œé¢ï¼Œåˆ™ä»¿çœŸç¯å¢ƒé…ç½®æˆåŠŸäº†ã€‚å·¦ä¾§æ˜¯ARMæ ¸çš„å¯„å­˜å™¨ï¼ˆå¯å‚è€ƒå¦ä¸€ç¯‡æ–‡ç« ã€ŠARMæ ¸ï¼ˆARMv7-A/Rï¼‰å­¦ä¹ ã€‹ï¼‰ï¼Œå³ä¸Šæ–¹æ˜¯å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ã€‚</p>
<p>ç‚¹å‡»å·¦ä¸Šæ–¹çš„è°ƒè¯•æŒ‰é’®ï¼Œå¯ä»¥å‘ç°ç«‹å³æ•°1ã€2ã€3è¢«ä¾æ¬¡åŠ è½½åˆ°å¯„å­˜å™¨R0ã€R1ã€R2ä¸­äº†ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124094832406.png" alt="image-20241124094832406" style="zoom:50%;">
<h1 id="zhi-ling-ge-shi">æŒ‡ä»¤æ ¼å¼</h1>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124101014161.png" alt="image-20241124101014161" style="zoom:50%;">
<h2 id="he-fa-li-ji-shu">åˆæ³•ç«‹å³æ•°</h2>
<p>ç«‹å³æ•°ä½¿ç”¨ <code>#æ•°å­—</code>æ¥è¡¨ç¤º</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124102202527.png" alt="image-20241124102202527"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124102256351.png" alt="image-20241124102256351"></p>
<h2 id="ji-cun-qi-yi-wei">å¯„å­˜å™¨ç§»ä½</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124102702102.png" alt="image-20241124102702102"></p>
<h1 id="chang-yong-arm-he-zhi-ling">å¸¸ç”¨ARMæ ¸æŒ‡ä»¤</h1>
<p>å‚è§æ‰‹å†Œä¸­çš„ <mark>A8.8 Alphabetical list of instructions</mark>ç« èŠ‚</p>
<h2 id="shu-ju-chuan-song-zhi-ling">æ•°æ®ä¼ é€æŒ‡ä»¤</h2>
<h3 id="mov">MOV</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124103655266.png" alt="image-20241124103655266" style="zoom:50%;">
<h3 id="mvn">MVN</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124103924679.png" alt="image-20241124103924679" style="zoom:50%;">
<h3 id="ldr">LDR</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124104010947.png" alt="image-20241124104010947" style="zoom:50%;">
<p><mark>æ³¨æ„ï¼šæ•°å­—å¸¸é‡å‰éœ€è¦åŠ ä¸Šâ€œ=â€ï¼Œè¿™æ˜¯å¸¸é‡/å­—é¢é‡è¡¨ç¤ºçš„è¯­æ³•è§„åˆ™</mark></p>
<p>å½“æ•°æ®ä¸æ˜¯åˆæ³•ç«‹å³æ•°æ—¶ï¼Œä½œä¸ºMOVçš„æ›¿ä»£æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€æ¡ä¼ªæŒ‡ä»¤ï¼Œåº•å±‚æ˜¯é€šè¿‡å°†æ•°æ®ï¼ˆ<code>=</code>å·åé¢çš„æ•°å­—ï¼‰å…ˆå­˜æ”¾åˆ°å†…å­˜ï¼Œå†é€šè¿‡LDR(ä»å†…å­˜åŠ è½½åˆ°å¯„å­˜å™¨)æŒ‡ä»¤æ¥å®ç°çš„ã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124104851454.png" alt="image-20241124104851454" style="zoom: 33%;">
<h2 id="shu-ju-ji-suan-zhi-ling">æ•°æ®è®¡ç®—æŒ‡ä»¤</h2>
<h3 id="add-jia-fa">ADDåŠ æ³•</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124105251693.png" alt="image-20241124105251693" style="zoom:50%;">
<h3 id="sub-jian-fa">SUBå‡æ³•</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124105408936.png" alt="image-20241124105408936" style="zoom:50%;">
<p>é»˜è®¤æƒ…å†µä¸‹SUBæ˜¯ä¸ä¼šå½±å“CPSRçš„Næ ‡å¿—ä½çš„ï¼Œå¦‚æœéœ€è¦åˆ™è¦åŠ ä¸ŠSåç¼€ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124105935847.png" alt="image-20241124105935847" style="zoom: 33%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124110015698.png" alt="image-20241124110015698" style="zoom:33%;">
<h3 id="mul-cheng-fa">MULä¹˜æ³•</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124110117129.png" alt="image-20241124110117129"></p>
<h3 id="lian-xi">ç»ƒä¹ </h3>
<blockquote>
<p>ç»ƒä¹ 1ï¼š<br>
(2&lt;&lt;2)-5+0x12345678, è®¡ç®—çš„ç»“æœå­˜æ”¾åœ¨r0</p>
<p>ç»ƒä¹ 2ï¼š<br>
25-3*5+6 æœ€ç»ˆçš„è®¡ç®—ç»“æœå­˜æ”¾åœ¨r0ä¸­</p>
</blockquote>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#2
	mov r1,r0,lsl #2
	sub r1,r1,#5
	ldr r0,=0x12345678
	add r1,r1,r0
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#3
	mov r1,#5
	mul r2,r0,r1 @r0=3*5
	mov r1,#25
	sub r0,r1,r2 @r0=25-15
	add r0,r0,#6 @r0=10+6
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="wei-yun-suan-zhi-ling">ä½è¿ç®—æŒ‡ä»¤</h2>
<h3 id="and">AND</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124112800154.png" alt="image-20241124112800154" style="zoom:50%;">
<h3 id="orr-an-wei-huo">ORR-æŒ‰ä½æˆ–</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124112835561.png" alt="image-20241124112835561" style="zoom:50%;">
<h3 id="eor-an-wei-yi-huo-exclusive-or">EOR-æŒ‰ä½å¼‚æˆ–ï¼ˆExclusive ORï¼‰</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124113112400.png" alt="image-20241124113112400" style="zoom:50%;">
<h3 id="bic-wei-qing-chu-zhi-ling">BIC-ä½æ¸…é™¤æŒ‡ä»¤</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124113149176.png" alt="image-20241124113149176" style="zoom:50%;">
<h3 id="lian-xi-1">ç»ƒä¹ </h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124113304642.png" alt="image-20241124113304642" style="zoom:50%;">
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	ldr r0,=0x12345678
	ldr r1,=0xFFFF0000
	bic r1,r0,r1
	mov r0,r0,lsr #16
	add r0,r0,r1
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	ldr r0,=0xabcd
	
	mov r1,#0x7
	bic r0,r1,lsl #1
	
	mov r1,#0x5
	orr r0,r1,lsl #1
	
	mov r1,#0x1f
	bic r0,r1,lsl #7
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="bi-jiao-zhi-ling-cmp">æ¯”è¾ƒæŒ‡ä»¤CMP</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124114532330.png" alt="image-20241124114532330" style="zoom:50%;">
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#5
	mov r1,#6
	mov r2,#10
	
	cmp r0,r1
	addgt r1,r1,#1
	
	cmp r0,r2
	addle r2,r2,#1
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124114808027.png" alt="image-20241124114808027" style="zoom: 50%;">
<h2 id="tiao-zhuan-zhi-ling">è·³è½¬æŒ‡ä»¤</h2>
<h3 id="b-bl">B/BL</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124125817106.png" alt="image-20241124125817106"></p>
<blockquote>
<p>Branch causes a branch to a target address.</p>
</blockquote>
<p>BæŒ‡ä»¤ç”¨äºè·³è½¬åˆ°ä¸€ä¸ªç›®æ ‡åœ°å€ï¼ˆæŒ‡ä»¤å­˜æ”¾åœ°å€ï¼‰ï¼Œè¯¥æŒ‡ä»¤ä¼šä¿®æ”¹PCçš„å€¼ï¼Œå°±åƒä»å¤„ç†å™¨çš„é¡ºåºæ‰§è¡Œè·¯å¾„å¼€äº†ä¸€ä¸ªåˆ†å²”ä¸€æ ·ï¼Œè®©å¤„ç†å™¨ä»æ—¢å®šçš„é¡ºåºæŒ‡ä»¤åºåˆ—è·³åˆ°äº†å¦ä¸€ä¸ªæŒ‡ä»¤åºåˆ—ã€‚å¸¸ç”¨äºå‡½æ•°è°ƒç”¨ã€ä¸­æ–­å¤„ç†ã€‚</p>
<p>BLæŒ‡ä»¤åœ¨BæŒ‡ä»¤çš„åŸºç¡€ä¹‹ä¸Šå¢åŠ äº†ä¸€ä¸ªæ“ä½œï¼šå°†è·³è½¬å‰PCçš„å€¼ä¿å­˜åˆ°LRå¯„å­˜å™¨ä¸­ã€‚è¿™æ ·å¦‚æœæƒ³ä»åˆ†å²”å›åˆ°åŸæ¥çš„è·¯å¾„ç»§ç»­æ‰§è¡Œï¼Œåªéœ€å°†LRä¼šå†™PCå³å¯ã€‚</p>
<h4 id="si-xun-huan-de-shi-xian">æ­»å¾ªç¯çš„å®ç°</h4>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1
	mov r1,#2
	b _start
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="han-shu-diao-yong">å‡½æ•°è°ƒç”¨</h4>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1
	mov r1,#2
	bl add
	
	mov r3,r2
	
stop:
	b _start
	
add:
	add r2,r0,r1
	mov pc,lr
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡å•æ­¥è°ƒè¯•è§‚å¯ŸPCçš„å˜åŒ–æˆ‘ä»¬å¯ä»¥å‘ç°æ¯æ¡æ±‡ç¼–æŒ‡ä»¤çš„åœ°å€æ˜¯æŒ‰ç…§ç¼–å†™é¡ºåºä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ç¼–å€çš„ï¼Œæ¯æ¡æŒ‡ä»¤åœ°å€ç›¸éš”4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå³åç§»é‡ä¸º0x4</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 @instruction address =&gt; 0x00000000
	mov r1,#2 @instruction address =&gt; 0x00000004
	bl add	  @instruction address =&gt; 0x00000008
	
	mov r3,r2 @instruction address =&gt; 0x0000000C
	
stop:
	b _start  @instruction address =&gt; 0x00000010
	
add:
	add r2,r0,r1 @instruction address =&gt; 0x00000014
	mov pc,lr    @instruction address =&gt; 0x00000018<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="gei-pc-fu-zhi">ç»™PCèµ‹å€¼</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124125452912.png" alt="image-20241124125452912"></p>
<p>B/BLæŒ‡ä»¤æœ‰ä¸ªé™åˆ¶ï¼šè·³è½¬çš„ç›®æ ‡åœ°å€å’Œå½“å‰PCä¸­çš„æŒ‡ä»¤åœ°å€ä¹‹é—´çš„åç§»é‡ä¸èƒ½è¶…è¿‡32Må¤§å°ã€‚å¦‚æœè¶…è¿‡äº†è¿™ä¸ªèŒƒå›´ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥èµ‹å€¼PCæ¥å®ç°è·³è½¬ã€‚</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 			
	mov r1,#2
	ldr pc,=add_label
back_label:
	mov r3,#10
	
stop:
	b stop

add_label:
	add r2,r0,r1
	ldr pc,=back_label
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­æ ‡ç­¾åå­—é¢é‡ï¼ˆ<code>add_label</code>ã€<code>back_label</code>ã€<code>stop</code>ï¼‰æœ¬è´¨ä¸Šå°±æ˜¯ç»™æ ‡ç­¾åå†’å·åçš„æŒ‡ä»¤åœ°å€å–äº†ä¸ªåˆ«åï¼Œå…¶å€¼å°±æ˜¯å†’å·åç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼›ä¸”æ ‡ç­¾å£°æ˜ä¸å±äºæŒ‡ä»¤ï¼Œä¹Ÿå°±ä¸å ç”¨å†…å­˜ç©ºé—´ï¼Œå› æ­¤ <code>ldr pc,=add_label</code>ç­‰ä»·äº <code>ldr pc,=0x00000014</code>ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 			@0x00000000
	mov r1,#2			@0x00000004
	ldr pc,=add_label	@0x00000008
back_label:
	mov r3,#10			@0x0000000C
	
stop:
	b stop				@0x00000010

add_label:
	add r2,r0,r1 		@0x00000014
	ldr pc,=back_label	@0x00000018
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="lian-xi-2">ç»ƒä¹ </h4>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124131659348.png" alt="image-20241124131659348" style="zoom:50%;">
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0		@sum=0
	mov r1,#1		@i=1
loop:
	cmp r1,#100
	bgt stop		@stop loop if r1 &gt; 100
	add r0,r0,r1	@sum+=i
	add r1,r1,#1	@i++
	b loop			@continue loop
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="dan-ge-shu-ju-fang-wen-yi-ci-xing-fang-wen-yi-ge-zi-kuan-shu-ju">å•ä¸ªæ•°æ®è®¿é—®ï¼ˆä¸€æ¬¡æ€§è®¿é—®ä¸€ä¸ªå­—å®½æ•°æ®ï¼‰</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124132933599.png" alt="image-20241124132933599" style="zoom:50%;">
<h3 id="ji-cun-qi-jian-jie-xun-zhi">å¯„å­˜å™¨é—´æ¥å¯»å€</h3>
<p><mark>LDR &lt;ç›®æ ‡å¯„å­˜å™¨&gt; [æºå¯„å­˜å™¨]</mark>ï¼šä»æºå¯„å­˜å™¨æŒ‡å®šçš„åœ°å€ä¸­åŠ è½½æ•°æ®åˆ°ç›®æ ‡å¯„å­˜å™¨</p>
<p><mark>LDR &lt;æºå¯„å­˜å™¨&gt; [ç›®æ ‡å¯„å­˜å™¨]</mark>ï¼šå°†æºå¯„å­˜å™¨ä¸­çš„æ•°æ®å­˜å‚¨åˆ°ç›®æ ‡å¯„å­˜å™¨æŒ‡å®šçš„å†…å­˜åœ°å€ä¸­</p>
<p>å¦‚ä¸‹ä»£ç å°†æ•°æ® <code>0x12345678</code> å†™ï¼ˆå­˜å‚¨ï¼‰åˆ°å†…å­˜åœ°å€ <code>0x40000000</code>ä¸­ï¼Œå¹¶ä»æ”¹åœ°å€è¯»ï¼ˆåŠ è½½ï¼‰æ•°æ®åˆ°R2å¯„å­˜å™¨ä¸­</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0]		@write 0x12345678 to memory address 0x40000000 =&gt; *r0 = r1
	ldr r2,[r0]		@read 0x12345678 from memory address 0x40000000 =&gt; r2 = *r0
	
	b stop
	
stop:
	b stop

	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç‚¹å‡»è°ƒè¯•åï¼Œéœ€è¦æ˜ å°„ä¸€ä¸‹å½“å‰ç¨‹åºå¯è®¿é—®çš„å†…å­˜ç©ºé—´ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124143904811.png" alt="image-20241124143904811" style="zoom: 50%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124143956075.png" alt="image-20241124143956075" style="zoom:50%;">
<blockquote>
<p>0x40000000,0x4000FFFF</p>
</blockquote>
<p>ç„¶åå¯ä»¥æ‰“å¼€å†…å­˜æŸ¥çœ‹çª—å£ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124144137121.png" alt="image-20241124144137121" style="zoom: 50%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124144919193.png" alt="image-20241124144919193" style="zoom: 33%;">
<p>ç„¶åæ­¥è¿›åˆ° <code>str r1,[r0]</code>æ‰§è¡Œä¹‹åï¼Œä¼šå‘ç°æ•°æ®å·²è¢«å†™å…¥å¯¹åº”çš„å†…å­˜ã€‚è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå­˜å‚¨æ–¹å¼æ˜¯å­—èŠ‚å°ç«¯æ³•ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124145026768.png" alt="image-20241124145026768"></p>
<p>å†è¿›ä¸€æ­¥ï¼Œæ•°æ®ä»å†…å­˜åŠ è½½åˆ°äº†R2å¯„å­˜å™¨ä¸­</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124145228766.png" alt="image-20241124145228766" style="zoom:50%;">
<h3 id="ji-di-zhi-bian-zhi-xun-zhi">åŸºåœ°å€å˜å€å¯»å€</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124150404357.png" alt="å‚è€ƒæ‰‹å†Œ A8.5 Memory accesses"></p>
<h4 id="pian-yi-liang-xun-zhi">åç§»é‡å¯»å€</h4>
<blockquote>
<p>Offset addressing<br>
The offset value is applied to an address obtained from the base register. The result is used as the<br>
address for the memory access. The value of the base register is unchanged.<br>
The assembly language syntax for this mode is:<br>
<code>[&lt;Rn&gt;, &lt;offset&gt;]</code></p>
</blockquote>
<p><code>LDR/STR [&lt;Rn&gt;, &lt;offset&gt;]</code>ï¼šRnä¸ºåŸºåœ°å€ï¼Œoffsetä¸ºåç§»å­—èŠ‚æ•°</p>
<p>ç±»æ¯”ç†è§£ï¼šCè¯­è¨€ä¸­é€šè¿‡æŒ‡é’ˆåŠ åç§»é‡æ¥è®¿é—®å†…å­˜ï¼ˆ<code>num = *(p+1)</code>ï¼‰ï¼Œè¯¥æ“ä½œä¸ä¼šæ”¹å˜æŒ‡é’ˆçš„å€¼ã€‚</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0, #4]		@ *(r0+4)=r1
	ldr r2,[r0, #4]		@ r2=*(r0+4)
	
	b stop
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ³¨æ„ï¼šæ¯æ¬¡ç‚¹å‡»debugååšä¸€ä¸‹å†…å­˜æ˜ å°„ï¼š</mark></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124150820281.png" alt="image-20241124150820281" style="zoom: 50%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124150924297.png" alt="image-20241124150924297" style="zoom:33%;">
<h4 id="qian-suo-yin-xun-zhi">å‰ç´¢å¼•å¯»å€</h4>
<blockquote>
<p>Pre-indexed addressing<br>
The offset value is applied to an address obtained from the base register. The result is used as the<br>
address for the memory access, and written back into the base register.<br>
The assembly language syntax for this mode is:<br>
<code>[&lt;Rn&gt;, &lt;offset&gt;]!</code></p>
</blockquote>
<p><code>LDR/STR [&lt;Rn&gt;, &lt;offset&gt;]!</code>ï¼šRnä¸ºåŸºåœ°å€ï¼Œoffsetä¸ºåç§»å­—èŠ‚æ•°ã€‚</p>
<p>è¯¥æŒ‡ä»¤åœ¨åç§»é‡å¯»å€çš„åŸºç¡€ä¸ŠåŠ äº†ä¸ª <mark>!</mark>ï¼Œæ ‡ç¤ºåœ¨å†…å­˜è®¿é—®ä¹‹åå°†è®¿é—®çš„åœ°å€å›å†™åŸºåœ°å€Rnã€‚</p>
<p>ç±»æ¯”ç†è§£ï¼š<code>num = *p++ =&gt; num = *p; p++;</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0, #4]!		@ *(r0+4)=r1 r0+=4
	ldr r2,[r0]		@ r2=*r0
	
	b stop
	
stop:
	b stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124152950125.png" alt="image-20241124152950125"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124153051739.png" alt="image-20241124153051739"></p>
<h4 id="hou-suo-yin-xun-zhi">åç´¢å¼•å¯»å€</h4>
<blockquote>
<p>Post-indexed addressing<br>
The address obtained from the base register is used, unchanged, as the address for the memory<br>
access. The offset value is applied to the address, and written back into the base register<br>
The assembly language syntax for this mode is:<br>
<code>[&lt;Rn&gt;], &lt;offset&gt;</code></p>
</blockquote>
<p><code>LDR/STR [&lt;Rn&gt;], &lt;offset&gt;</code>ï¼šRnä¸ºåŸºåœ°å€ï¼Œoffsetä¸ºåç§»å­—èŠ‚æ•°ã€‚</p>
<p>è¯¥æŒ‡ä»¤å…ˆä»Rnè®¿é—®å†…å­˜ï¼Œç„¶åå†å°†åç§»é‡æ›´æ–°åˆ°Rnä¸­ã€‚</p>
<p>ç±»æ¯”ç†è§£ï¼š<code>num = *p; p += offset</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000
	ldr r1,=0x12345678
	
	str r1,[r0],#4	@ *(r0)=r1 r0+=4
	
	sub r0,r0,#4	@ r0-=4
	ldr r2,[r0]		@ r2=*r0
	
	b stop
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124153832192.png" alt="image-20241124153832192"></p>
<h4 id="zong-jie">ğŸŒŸæ€»ç»“</h4>
<ul>
<li>åç§»é‡å¯»å€ï¼šå°±æ˜¯åœ¨ç»™å®šåœ°å€ä¸ŠåŠ å‡ä¸€ä¸ªåç§»é‡æ¥è®¿é—®å†…å­˜ï¼ˆrelativeï¼‰</li>
<li>å‰ç´¢å¼•ï¼šå…ˆå¯¹ç»™å®šåœ°å€å¢å‡åç§»é‡è¿›è¡Œæ›´æ–°ï¼Œå†è®¿é—®æ›´æ–°åçš„åœ°å€</li>
<li>åç´¢å¼•ï¼šå…ˆè®¿é—®ç»™å®šåœ°å€ï¼Œå†å¯¹ç»™å®šåœ°å€åŠ å‡åç§»é‡å¹¶æ›´æ–°</li>
</ul>
<h4 id="lian-xi-3">ç»ƒä¹ </h4>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124154157004.png" alt="image-20241124154157004"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#1 				@i=1
	mov r1,#0x40000000 		@p
	
	bl write_data
	
	mov r0,#1				@i=1
	mov r1,#0x40000000 		@p=&gt;0x40000000
	ldr r2,=0x40000100		@q=&gt;0x40000100
	mov r3,#0				@num=0

	bl read_data
	
stop:
	b stop
	
write_data:
	str r0,[r1],#4 			@*p++=i
	add r0,r0,#1			@i++
	cmp r0,#10
	ble write_data 			@while(i&lt;=10)
	
	mov pc,lr				@return
	
read_data:
	ldr r3,[r1],#4			@num=*p++
	str r3,[r2],#4			@*q++=num
	add r0,r0,#1			@i++
	cmp r0,#10
	ble read_data			@while(i&lt;=10)
	
	mov pc,lr				@return
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124160123984.png" alt="image-20241124160123984"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124160205062.png" alt="image-20241124160205062"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	ldr r0,=0x1234
	ldr r1,=0x40000000 		@p=0x40000000
	str r0,[r1],#4			@*p++=0x1234
	
	ldr r0,=0xabcd
	str r0,[r1],#-4			@*p=0xabcd, p-=4
	
	ldr r2,[r1],#4			@num1=*p++
	ldr r3,[r1]				@num2=*p
	add r0,r2,r3			@sum=num1+num2
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="duo-ge-shu-ju-fang-wen">å¤šä¸ªæ•°æ®è®¿é—®</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124162052165.png" alt="image-20241124162052165" style="zoom:50%;">
<h3 id="zhi-ling-mo-shi">æŒ‡ä»¤æ¨¡å¼</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124162139880.png" alt="image-20241124162139880" style="zoom:50%;">
<p>ä»¥STMï¼ˆStore Multipleï¼Œå†™å¤šä¸ªæ•°æ®ä¸ºä¾‹ï¼ŒLDMæ˜¯ç±»ä¼¼çš„ï¼‰ï¼š</p>
<ul>
<li>STMIAï¼šIncrease Afterï¼Œå…ˆå‘åŸºåœ°å€å†™å…¥æ•°æ®ï¼Œç„¶åé€’å¢åŸºåœ°å€</li>
<li>STMIBï¼šIncrease Beforeï¼Œå…ˆé€’å¢åŸºåœ°å€ï¼Œå†å‘åŸºåœ°å€å†™å…¥æ•°æ®</li>
<li>STMDAï¼šDecrease Afterï¼Œå…ˆå‘åŸºåœ°å€å†™å…¥æ•°æ®ï¼Œç„¶åé€’å‡åŸºåœ°å€</li>
<li>STMDBï¼šDecrease Beforeï¼Œå…ˆé€’å‡åŸºåœ°å€ï¼Œå†å‘åŸºåœ°å€å†™å…¥æ•°æ®</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000			@p=0x40000000
	mov r1,#0x11				@buf[3] = {0x11,0x22,0x33}
	mov r2,#0x22
	mov r3,#0x33
	
	stmia r0!,{r1-r3} 			@*p++=buf[i]
	
stop:
	b stop
	
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124163643693.png" alt="image-20241124163643693"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x40000000			@p=0x40000000
	mov r1,#0x11				@buf[3] = {0x11,0x22,0x33}
	mov r2,#0x22
	mov r3,#0x33
	
	stmia r0!,{r1-r3} 			@*p++=buf[i++]
	
	ldmdb r0!,{r4-r6}			@buf2[i++]=*--p
	
stop:
	b stop
	
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124163945572.png" alt="image-20241124163945572"></p>
<h2 id="zhan-cao-zuo-zhi-ling">æ ˆæ“ä½œæŒ‡ä»¤</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124164247925.png" alt="image-20241124164247925"></p>
<h3 id="zhan-zeng-chang-mo-shi">æ ˆå¢é•¿æ¨¡å¼</h3>
<p><mark>è‡ªåº•å‘ä¸Šï¼šæ ˆé¡¶æŒ‡é’ˆéšç€å…¥æ ˆè€Œé€’å¢ï¼ˆåœ°å€ï¼‰ï¼›è‡ªé¡¶å‘ä¸‹ï¼šæ ˆé¡¶æŒ‡é’ˆéšç€å…¥æ ˆè€Œé€’å‡</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124164335289.png" alt="image-20241124164335289"></p>
<h3 id="kong-dui-zhan-he-man-dui-zhan">ç©ºå †æ ˆå’Œæ»¡å †æ ˆ</h3>
<p><mark>å…¶å®å°±æ˜¯æ ˆé¡¶æŒ‡é’ˆæŒ‡å‘æ ˆé¡¶å…ƒç´ ï¼ˆæ»¡å †æ ˆï¼‰è¿˜æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå…¥æ ˆå…ƒç´ è¦å­˜æ”¾çš„ä½ç½®ï¼ˆç©ºå †æ ˆï¼‰</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124164412290.png" alt="image-20241124164412290"></p>
<h3 id="shi-li-ya-zhan-bao-cun-chu-zhan-hui-fu">ç¤ºä¾‹ï¼šå‹æ ˆä¿å­˜ï¼Œå‡ºæ ˆæ¢å¤</h3>
<blockquote>
<p>åœ¨ç¨‹åºä¸Šä¸‹æ–‡å‘ç”Ÿåˆ‡æ¢æ—¶ï¼ˆä¾‹å¦‚å‡½æ•°è°ƒç”¨ã€ä¸­æ–­å¤„ç†ï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å…ˆå°†å…ˆå‰ç¨‹åºæ‰§è¡ŒçŠ¶æ€ç›¸å…³çš„ä¿¡æ¯è¿›è¡Œä¿å­˜ï¼Œç„¶ååœ¨è¿”å›æ—¶è¿›è¡Œæ¢å¤ã€‚</p>
</blockquote>
<p>å¦‚ä¸‹ç¨‹åºä»¥é€šç”¨å¯„å­˜å™¨çš„æš‚å­˜å’Œæ¢å¤ä¸ºä¾‹æ¥æ¨¡æ‹Ÿè¿™ä¸€è¿‡ç¨‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#0x11				
	mov r2,#0x22
	mov r3,#0x33
	
	@first: set stack pointer(start address of stack, from high address to low)
	ldr sp,=0x4000fff0		
	@push to save general purpose registers and decrease stack pointer
	stmfd sp!,{r1-r3}		
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124170153676.png" alt="image-20241124170153676"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#0x11				
	mov r2,#0x22
	mov r3,#0x33
	
	@first: set stack pointer(start address of stack, from high address to low)
	ldr sp,=0x4000fff0		
	@push to save general purpose registers and decrease stack pointer
	stmfd sp!,{r1-r3}		
	
	@do something with general purpose registers
	mov r1,#0x00				
	mov r2,#0x00
	mov r3,#0x00
	
	@pop stack to recover general purpose registers
	ldmfd sp!,{r1-r3}
	
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124170518808.png" alt="image-20241124170518808"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124170639885.png" alt="image-20241124170639885"></p>
<h2 id="cpsr-spsr-cao-zuo-zhi-ling">CPSR/SPSRæ“ä½œæŒ‡ä»¤</h2>
<h3 id="mrs-move-to-register-from-special-register">MRSï¼ˆMove to Register from Special registerï¼‰</h3>
<blockquote>
<p>Move to Register from Special register moves the value from the CPSR or SPSR of the current mode into an ARM<br>
core register.<br>
An MRS that accesses the SPSR is UNPREDICTABLE if executed in User or System mode.<br>
An MRS that is executed in User mode and accesses the CPSR returns an UNKNOWN value for the<br>
CPSR.{E, A, I, F, M} fields.</p>
</blockquote>
<p><code>MRS{&lt;c&gt;}{&lt;q&gt;} &lt;Rd&gt;, &lt;spec_reg&gt;  </code></p>
<h3 id="msr-move-register-immediate-to-special-register">MSRï¼ˆMove register/immediate to Special Registerï¼‰</h3>
<blockquote>
<p>Move to Special register from ARM core register moves the value of an ARM core register to the CPSR or the SPSR of the current mode.</p>
</blockquote>
<p><code>MSR&lt;c&gt; &lt;spec_reg&gt;, #&lt;const&gt;  </code></p>
<p><code>MSR{&lt;c&gt;}{&lt;q&gt;} &lt;spec_reg&gt;, &lt;Rn&gt;  </code></p>
<h3 id="zong-jie-1">ğŸŒŸæ€»ç»“</h3>
<p><mark>MRSã€MSRåˆ†è¾¨</mark>ï¼š</p>
<ul>
<li>Råœ¨å‰é¢ï¼Œåˆ™æ“ä½œæ•°1ä¸ºé€šç”¨å¯„å­˜å™¨ï¼ˆè¦å°†CPSRè¯»åˆ°Rdï¼‰ï¼›</li>
<li>Såœ¨å‰é¢ï¼Œæ“ä½œæ•°ä¸ºç‰¹æ®Šå¯„å­˜å™¨ï¼ˆè¦å°†é€šç”¨å¯„å­˜å™¨å†™åˆ°CPSRï¼‰</li>
</ul>
<h3 id="lian-xi-4">ç»ƒä¹ </h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124171837704.png" alt="image-20241124171837704"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mrs r0,cpsr 		@move to r0 from cpsr
	mov r1,#1
	bic r0,r1,lsl #7	@bit clear bit7 of cpsr
	msr cpsr,r0			@write back to cpsr
	
	b stop
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124172405608.png" alt="image-20241124172405608"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mrs r0,cpsr 		@move to r0 from cpsr
	mov r1,#1
	bic r0,r1,lsl #7	@bit clear bit7 of cpsr
	msr cpsr,r0			@write back to cpsr
	
	mrs r0,cpsr
	orr r0,r1, lsl #7	@set bit7 of cpsr
	msr cpsr,r0			@write back to cpsr
	
	b stop
stop:
	b stop
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="the-end">The END</h1>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>æŒ‡ä»¤é›†</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆä¸‰ï¼‰æŒ‡ä»¤æµæ°´çº¿åˆ†æåŠä¼ªæŒ‡ä»¤</title>
    <url>/2024/11/24/14899.html</url>
    <content><![CDATA[<h1 id="zhi-ling-liu-shui-xian-fen-xi">æŒ‡ä»¤æµæ°´çº¿åˆ†æ</h1>
<h2 id="qian-yan">å‰è¨€</h2>
<p>åœ¨ARMæ ¸ä¸­ï¼Œä¸ºå¢åŠ å¤„ç†å™¨æŒ‡ä»¤æµçš„é€Ÿåº¦ï¼ŒARM7ç³»åˆ—ä½¿ç”¨3çº§æµæ°´çº¿ã€‚å…è®¸å¤šä¸ªæ“ä½œåŒæ—¶å¤„ç†ï¼Œè€Œéé¡º<br>
åºæ‰§è¡Œã€‚<mark>ä¸åŒçš„ARMæ ¸ï¼Œæµæ°´çº¿çš„çº§æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼ŒARMæ ¸ç‰ˆæœ¬è¶Šé«˜ï¼Œæµæ°´çº¿çº§æ•°è¶Šå¤šã€‚å¯¹äºè½¯ä»¶å·¥</mark><br>
<mark>ç¨‹å¸ˆç¼–ç¨‹è€Œè¨€ï¼Œç»Ÿä¸€æŒ‰ç…§ä¸‰çº§æµæ°´çº¿æ¥åˆ†æå°±å¯ä»¥äº†ã€‚</mark></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124174742518.png" alt="image-20241124174742518" style="zoom: 33%;">
<blockquote>
<p>åœ¨MDKä¸­æ–­ç‚¹è°ƒè¯•æ—¶ä¼šå‘ç°PCæŒ‡å‘çš„å½“å‰ä»£ç è¡Œï¼Œè¿™æ˜¯å› ä¸ºMDKè°ƒè¯•å±è”½äº†åº•å±‚æµæ°´çº¿ç»†èŠ‚ï¼Œä»¥é¿å…äº§ç”Ÿæ­§ä¹‰ã€‚</p>
</blockquote>
<p>åœ¨ARMçŠ¶æ€ï¼ŒæŒ‡ä»¤ä½å®½ä¸º32ä½4å­—èŠ‚ï¼Œå› æ­¤å½“PCé¢„å–ï¼ˆä¾‹å¦‚ï¼‰0x8åœ°å€çš„æŒ‡ä»¤æ—¶ï¼Œ0x4åœ°å€çš„æŒ‡ä»¤æ­£åœ¨è¢«è§£ç ã€0x0åœ°å€çš„æŒ‡ä»¤æ­£åœ¨è¢«æ‰§è¡Œã€‚ThumbçŠ¶æ€æ˜¯å‹ç¼©æ ¼å¼çš„æŒ‡ä»¤é›†ï¼ŒæŒ‡ä»¤ä½å®½æ˜¯16ä½2å­—èŠ‚ï¼Œå› æ­¤åå·®æ˜¯2ã€‚</p>
<h2 id="zui-jia-liu-shui-xian-fen-xi-jin-cao-zuo-ji-cun-qi">æœ€ä½³æµæ°´çº¿åˆ†æï¼ˆä»…æ“ä½œå¯„å­˜å™¨ï¼‰</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124175951254.png" alt="image-20241124175951254" style="zoom:50%;">
<h2 id="nei-cun-fang-wen-zhi-ling-liu-shui-xian">å†…å­˜è®¿é—®æŒ‡ä»¤æµæ°´çº¿</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124180204732.png" alt="image-20241124180204732"></p>
<p>ç”±äºå†…å­˜è®¿é—®æ•ˆç‡è¾ƒä½ï¼Œå› æ­¤åœ¨æ‰§è¡ŒLDRæŒ‡ä»¤æ—¶ï¼Œæ— æ³•åœ¨ä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸå†…å®Œæˆï¼ˆéœ€è¦Eã€Mã€Wä¸‰ä¸ªå‘¨æœŸï¼‰ã€‚è¿™æ ·ï¼Œå³ä½¿å®ƒå‰é¢çš„Dè·‘å¾—å¿«ï¼Œä½†è§£ç çš„æŒ‡ä»¤æ— æ³•ç§»äº¤ç»™Eï¼ˆå®ƒæ‰‹ä¸Šçš„æ´»è¿˜æ²¡å¹²å®Œï¼‰ï¼Œåªèƒ½å¹²ç­‰ï¼ŒFä¹Ÿæ˜¯ä¸€æ ·ã€‚</p>
<h2 id="fen-zhi-tiao-zhuan-liu-shui-xian-ju-li">åˆ†æ”¯ï¼ˆè·³è½¬ï¼‰æµæ°´çº¿ä¸¾ä¾‹</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124181209542.png" alt="image-20241124181209542"></p>
<p>åœ¨Eæ‰§è¡Œè·³è½¬æŒ‡ä»¤æ—¶ï¼Œè·‘åœ¨å®ƒå‰é¢çš„Fã€Dä¸å¾—ä¸ä¸¢å¼ƒå·²å®Œæˆçš„å·¥ï¼ˆè§£ç  <code>0x3004 SUB</code>ï¼Œé¢„å– <code>0x3008 AND</code>ï¼‰ä½œï¼Œè½¬è€Œä»ç›®æ ‡åœ°å€é‡æ–°å¼€å§‹Fã€Dã€Eæµç¨‹ã€‚</p>
<p>å›¾ä¸­Eæ‰§è¡Œ <code>BL 0X8FEC</code>æ—¶ï¼ŒFæ­£åœ¨é¢„å– <code>0x3008</code>åœ°å€çš„æŒ‡ä»¤ï¼Œåœ¨è¯¥æŒ‡ä»¤å‘¨æœŸç»“æŸæ—¶ï¼ŒPCæŒ‡å‘ <code>0x3008</code>ï¼Œä¸”ç”±äºæ˜¯ <code>BL</code>è·³è½¬ï¼Œå› æ­¤è¯¥å€¼ä¼šè¢«ä¿å­˜åˆ° <code>LR</code>å¯„å­˜å™¨ä¸­ã€‚</p>
<p>å½“æ‰§è¡Œ <code>L</code>æŒ‡ä»¤æ—¶ï¼Œä¼šå°†<code>LR</code>å›å†™åˆ° <code>PC</code>ä¸­ï¼Œä½†æ˜¯ç”±äºæ­¤å‰å¯¹äº <code>0X3004</code>çš„è§£ç å·¥ä½œè¢«ä¸¢å¼ƒäº†ï¼Œå› æ­¤å¤„ç†å™¨ä¼šè‡ªåŠ¨æ‰§è¡Œä¸€ä¸ª <code>A</code>æŒ‡ä»¤ï¼Œå°† <code>PC</code>è°ƒæ•´åˆ° <code>0x3004</code>çš„ä½ç½®æ¥ç€æ‰§è¡Œã€‚</p>
<h2 id="zong-jie">æ€»ç»“</h2>
<ul>
<li>å½“åªæœ‰å¯„å­˜å™¨æ“ä½œï¼ˆæ“ä½œæ•ˆç‡å’ŒCPUå¤„äºåŒä¸€é‡çº§ï¼‰æ—¶ï¼ŒæŒ‡ä»¤æµçº¿æ•ˆç‡æ˜¯æœ€é«˜çš„ï¼šåœ¨æ¯ä¸ªæŒ‡ä»¤å‘¨æœŸï¼Œæµæ°´çº¿ä¸Šçš„ä¸‰ä¸ªå·¥äººFã€Dã€Eéƒ½åœ¨ä¸åœäº’ç›¸é…åˆï¼Œé«˜æ•ˆå®ŒæˆæŒ‡ä»¤æ‰§è¡Œæ‰€éœ€çš„ä¸‰ä¸ªé˜¶æ®µçš„å·¥ä½œã€‚</li>
<li>å½“è®¿é—®å†…å­˜ï¼ˆå¤–è®¾ï¼‰æ—¶ï¼Œç”±äºç‰©ç†ç‰¹æ€§ï¼Œå¤„ç†å™¨çš„å·¥ä½œæ•ˆç‡è¿œé«˜äºå¤–è®¾ï¼Œå› æ­¤å·¥äººEåªèƒ½æ”¾æ…¢èŠ‚å¥å’Œå¤–è®¾ååŒæŠŠæ´»å¹²äº†ï¼Œè¿™æœŸé—´å³ä½¿Fã€Då®Œæˆäº†æ‰‹å¤´ä¸Šçš„æ´»ï¼Œç”±äºä¸èƒ½å‘Dã€Eç§»äº¤ï¼Œå› æ­¤ä¹Ÿåªèƒ½å¹²ç­‰ç€ã€‚å¯¼è‡´äº†çº§è”åœé¡¿ï¼ˆstallï¼‰çš„æ•ˆåº”ã€‚</li>
<li>å½“å‘ç”Ÿè·³è½¬æ—¶ï¼Œå·¥äººFã€Dè¶…å‰å®Œæˆçš„å·¥ä½œåªèƒ½è¢«è¿«ä¸¢å¼ƒï¼Œè½¬è€Œä»æ–°çš„æŒ‡ä»¤åœ°å€é‡æ–°å¼€å§‹å¹²æ´»ï¼Œä¸”å¦‚æœè·³è½¬å›æ¥ï¼Œä¹‹å‰å¹²å®Œçš„æ´»è¿˜å¾—é‡æ–°å†å¹²ä¸€æ¬¡ã€‚</li>
</ul>
<h1 id="chang-yong-wei-zhi-ling-fen-xi">å¸¸ç”¨ä¼ªæŒ‡ä»¤åˆ†æ</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124183925641.png" alt="image-20241124183925641"></p>
<h2 id="ldr-r-0-0-x-12345678-fen-xi">LDR R0,=0x12345678 åˆ†æ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124184043373.png" alt="image-20241124184043373"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124184314696.png" alt="image-20241124184314696"></p>
<p>ç¼–è¯‘å™¨ä¼šå°†å¸¸é‡ <code>0x12345678</code>é¢„å…ˆæ”¾åˆ°æŸä¸ªå†…å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯æ‰€æœ‰ä»£ç æŒ‡ä»¤ä¹‹åï¼‰ï¼Œå¹¶å°†LDRç¿»è¯‘æˆä¸€æ¡è¯»å†…å­˜çš„æŒ‡ä»¤ã€‚</p>
<h2 id="ldr-r-0-label-fen-xi">LDR R0,=label åˆ†æ</h2>
<p>æ ‡ç­¾æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå®ƒçš„å€¼å°±æ˜¯æ ‡ç­¾åç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå¯ä»¥ç†è§£ä¸ºç»™è¿™ä¸ªåœ°å€å–äº†ä¸ªåˆ«åã€‚</p>
<h3 id="dai-ma-duan-qi-shi-di-zhi-wei-0-x-0">ä»£ç æ®µèµ·å§‹åœ°å€ä¸º0x0</h3>
<p>å¯¹äºç»™å®šçš„ä»£ç æ®µèµ·å§‹åœ°å€å’ŒæŒ‡ä»¤ä½å®½ï¼Œæ¯æ¡æŒ‡ä»¤çš„å­˜æ”¾åœ°å€åœ¨ç¼–è¯‘é˜¶æ®µéƒ½å¯ä»¥ç¡®å®šï¼Œå¦‚ä¸‹å°†ä»£ç æ®µçš„èµ·å§‹åœ°å€é…ç½®ä¸º <code>0x0</code>ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124185737443.png" alt="image-20241124185737443" style="zoom:33%;">
<p>å¯¹äºARMçŠ¶æ€ä¸‹ï¼ˆæŒ‡ä»¤ä½å®½ä¸º4å­—èŠ‚ï¼‰ï¼Œå¦‚ä¸‹ä»£ç çš„æ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥é¡ºåºè®¡ç®—å…¶å­˜å‚¨åœ°å€</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#1			@0x00000000
	mov r2,#2			@0x00000004
	ldr r3,=addr		@0x00000008
	ldr r4,[r3]			@0x0000000C
	
stop:
	b stop				@0x00000010
	
addr:					@ç»™0x00000014å–äº†ä¸ªåˆ«åå«addr
	.word 0x12345678	@0x00000014 åœ¨è¿™ä¸ªåœ°å€å­˜æ”¾ä¸€ä¸ªå­—çš„æ•°æ®
		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ ‡ç­¾çš„å£°æ˜å¹¶ä¸å±äºæŒ‡ä»¤ï¼Œå› æ­¤ä¸å ç”¨åœ°å€ç©ºé—´ã€‚å…¶ä¸­ <code>ldr r3,=addr</code>ç­‰ä»·äº <code>ldr r3,=0x00000014</code>ã€‚</p>
<p><code>ldr r3,=addr</code>ï¼ˆå°†addrè¡¨ç¤ºçš„åœ°å€å€¼åŠ è½½åˆ°R3ï¼‰åˆ†æå¦‚ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124190511217.png" alt="image-20241124190511217"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124190550278.png" alt="image-20241124190550278"></p>
<p><code>ldr r4,[r3]</code>ï¼šä»R3å¯¹åº”çš„åœ°å€è¯»å–æ•°æ®ï¼ˆè¯¥æ•°æ® <code>0x12345678</code> åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡ <code>.word</code>ä¼ªæŒ‡ä»¤é¢„å…ˆå­˜å‚¨åœ¨äº†å†…å­˜ç©ºé—´ä¸­ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124190809542.png" alt="image-20241124190809542"></p>
<h3 id="dai-ma-duan-qi-shi-di-zhi-wei-0-x-2000">ä»£ç æ®µèµ·å§‹åœ°å€ä¸º0x2000</h3>
<p>å°†ä»£ç æ®µèµ·å§‹åœ°å€æ”¹ä¸º0x2000ï¼Œè®¡ç®—è§„åˆ™æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±èƒ½ç¡®å®šå„ä¸ªæŒ‡ä»¤ä»¥åŠ <code>.word</code>æ•°æ®å­˜æ”¾çš„åœ°å€ï¼ˆæ³¨æ„ä¿®æ”¹åéœ€è¦é‡æ–°ç¼–è¯‘ä¸‹ï¼‰ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124200510540.png" alt="image-20241124200510540" style="zoom:33%;">
<p>è°ƒè¯•å‰éœ€è¦ä¿®æ”¹ä¸‹å†…å­˜æ˜ å°„ï¼Œé»˜è®¤æ˜¯ä»0x0å¼€å§‹æ‰§è¡Œçš„ï¼Œæˆ‘ä»¬éœ€è¦è®©0x0åˆ°0x2000åŠå…¶åçš„ä¸€æ®µå†…å­˜éƒ½å¯æ‰§è¡Œï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124200751229.png" alt="image-20241124200751229" style="zoom:50%;">
<p>ç„¶ååœ¨ <code>_start</code>çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ‰“ä¸ªæ–­ç‚¹ï¼Œè·³è¿‡ä»0x0åˆ°0x2000ä¹‹é—´çš„æ— æ•ˆæŒ‡ä»¤ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124201005483.png" alt="image-20241124201005483" style="zoom: 33%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124200325028.png" alt="image-20241124200325028" style="zoom:33%;">
<h3 id="zong-jie-1">æ€»ç»“</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124195231017.png" alt="image-20241124195231017" style="zoom: 50%;">
<h2 id="ldr-r-0-label-fen-xi-1">LDR R0,label åˆ†æ</h2>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#1			
	mov r2,#2			
	ldr r3,addr			
	mov r4,r3			
stop:
	b stop				
addr:	
	.word 0x12345678	
		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ldr r3,=addr</code>å¯ä»¥ç†è§£ä¸ºå°†æ ‡ç­¾ <code>addr</code>çš„å€¼å½“åšå¸¸é‡åŠ è½½åˆ°R3ä¸­ï¼Œè€Œ <code>ldr r3,addr</code>åˆ™æ˜¯ä» <code>addr</code>å¯¹åº”çš„åœ°å€åŠ è½½æ•°æ®åˆ°R3ä¸­ï¼Œç›¸å½“äº <code>R3=p</code>å’Œ <code>R3=*p</code>çš„å…³ç³»</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124201244164.png" alt="image-20241124201244164" style="zoom: 33%;">
<h2 id="adr-r-0-label-dong-tai-huo-qu-biao-qian-di-zhi">ADR R0,label åŠ¨æ€è·å–æ ‡ç­¾åœ°å€</h2>
<blockquote>
<p>This instruction adds an immediate value to the PC value to form a PC-relative address, and writes the result to the destination register.</p>
</blockquote>
<p>ADR æ˜¯ â€œAddressâ€ çš„ç¼©å†™ï¼Œå®ƒæ˜¯ä¸€æ¡ç”¨äºç”Ÿæˆåœ°å€çš„ä¼ªæŒ‡ä»¤ã€‚ADR æŒ‡ä»¤ç”¨äºè®¡ç®—ä¸€ä¸ªç›®æ ‡åœ°å€ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ°æŒ‡å®šçš„å¯„å­˜å™¨ä¸­ã€‚ç›®æ ‡åœ°å€æ˜¯åŸºäºå½“å‰ PC åŠ ä¸Šä¸€ä¸ªåç§»é‡è®¡ç®—å¾—å‡ºçš„ï¼Œå› æ­¤å®ƒåªèƒ½è®¿é—®å½“å‰ä»£ç æ®µé™„è¿‘çš„åœ°å€ã€‚</p>
<h3 id="strong-zhi-ling-ge-shi-strong"><strong>æŒ‡ä»¤æ ¼å¼</strong></h3>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">ADR &lt;Rd&gt;, &lt;label&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>&lt;Rd&gt;</code>ï¼šç›®æ ‡å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨è®¡ç®—å‡ºçš„åœ°å€ã€‚</li>
<li><code>&lt;label&gt;</code>ï¼šç›®æ ‡åœ°å€æ ‡ç­¾ï¼Œå¿…é¡»ä½äºå½“å‰æŒ‡ä»¤å‰åä¸€å®šèŒƒå›´å†…ã€‚</li>
</ul>
<h3 id="shi-li">ç¤ºä¾‹</h3>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r1,#1			
	mov r2,#2			
	adr r3,addr			
	ldr r4,[r3]		
stop:
	b stop				
addr:	
	.word 0x12345678	
		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124202620567.png" alt="image-20241124202620567"></p>
<h3 id="dui-bi-ldr-r-0-label">å¯¹æ¯” LDR R0,=label</h3>
<p>å¦‚ä¸‹å›¾ï¼Œ<code>LDR R0,=label</code>ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®ä»£ç æ®µèµ·å§‹åœ°å€å’ŒæŒ‡ä»¤ä½å®½è®¡ç®—å‡ºlabelå¯¹åº”çš„åœ°å€å€¼ï¼ˆ<code>0x00000014</code>ï¼‰ï¼Œå¹¶å•ç‹¬å¼€è¾Ÿä¸€ä¸ªå†…å­˜ï¼ˆ<code>0x00000018</code>ï¼‰å­˜æ”¾è¿™ä¸ª<mark>å†™æ­»</mark>çš„æ•°æ®ï¼Œåœ¨è¿è¡Œæ—¶é€šè¿‡LDRè¯»å–è¿™ä¸ªå†…å­˜ä¸­å†™æ­»çš„labelåœ°å€å€¼åˆ°R3ä¸­ã€‚</p>
<p>å¦‚æœèµ·å§‹åœ°å€ä¸º <code>0x2000</code>ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¼šåœ¨å†…å­˜ä¸­å­˜æ”¾ä¸€ä¸ªå†™æ­»çš„ <code>0x2014</code>ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸€ç§<mark>é™æ€çš„åšæ³•</mark>ï¼ˆå’Œç¼–è¯‘æ—¶è®¾ç½®çš„ä»£ç æ®µèµ·å§‹åœ°å€æ˜¯<mark>å¼ºç»‘å®šçš„</mark>ï¼‰ï¼Œå¦‚æœç¨‹åºæ¢ä¸€ä¸ªåœ°å€ç©ºé—´è¿è¡Œï¼Œè¿™ä¸ªå†™æ­»çš„åœ°å€å€¼å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124203311920.png" alt="image-20241124203311920"></p>
<p>è€Œ <code>ADR R0,label</code>åˆ™æ˜¯è¿è¡Œæ—¶åŠ¨æ€è·å–æ ‡ç­¾å¯¹åº”çš„åœ°å€å€¼ï¼Œä¾‹å¦‚ç¼–è¯‘å™¨çŸ¥é“æ‰§è¡Œå½“å‰æŒ‡ä»¤æ—¶ï¼Œé€šè¿‡åœ¨PCä¸Šåç§»4ä¸ªå­—èŠ‚å°±èƒ½å¯»å€åˆ°labelå¯¹åº”çš„åœ°å€ï¼Œé‚£ä¹ˆé€šè¿‡ <code>ADD</code>æŒ‡ä»¤å°±èƒ½åœ¨<mark>è¿è¡Œæ—¶åŠ¨æ€è·å–</mark>è¯¥labelå¯¹åº”çš„åœ°å€ã€‚è¿™ç§åšæ³•æ˜¯<mark>ä¸ä¾èµ–ç¼–è¯‘æ—¶è®¾å®šçš„ä»£ç æ®µèµ·å§‹åœ°å€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆèµ·å§‹åœ°å€ï¼Œéƒ½èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªæ­£ç¡®çš„æ ‡ç­¾åœ°å€</mark>ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124204230866.png" alt="image-20241124204230866"></p>
<h2 id="ru-he-pan-bie-dai-ma-zai-shi-ji-nei-cun-zhong-yun-xing-de-di-zhi">ğŸŒŸå¦‚ä½•åˆ¤åˆ«ä»£ç åœ¨å®é™…å†…å­˜ä¸­è¿è¡Œçš„åœ°å€ï¼Ÿ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124204803253.png" alt="image-20241124204803253"></p>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>æŒ‡ä»¤æµæ°´çº¿</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆäº”ï¼‰å¼‚å¸¸å¤„ç†</title>
    <url>/2024/11/25/17360.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/ddi0406/cd/?lang=en">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
<ul>
<li>B1.8 Exception handling</li>
</ul>
<p><a href="https://developer.arm.com/documentation/den0013/latest/">ARMÂ® Cortexâ„¢-A Series Programmerâ€™s Guide Version: 4.0</a></p>
<h1 id="yi-chang-jie-shao">å¼‚å¸¸ä»‹ç»</h1>
<h2 id="shi-yao-shi-yi-chang">ä»€ä¹ˆæ˜¯å¼‚å¸¸</h2>
<p>å¼‚å¸¸æ˜¯å¤„ç†å™¨æ ¸åœ¨æ‰§è¡Œç¨‹åºæŒ‡ä»¤çš„è¿‡ç¨‹ä¸­çªç„¶é‡åˆ°äº†å¼‚å¸¸çš„äº‹æƒ…ï¼Œè¿™äº›äº‹ä»¶åŒ…æ‹¬<strong>ç¡¬ä»¶ä¸­æ–­ã€æŒ‡ä»¤æ‰§è¡Œé”™è¯¯ã€ç”¨æˆ·ç¨‹åºè¯·æ±‚æœåŠ¡ã€å†…å­˜è®¿é—®å¼‚å¸¸ã€å–æŒ‡ä»¤å¼‚å¸¸</strong>ç­‰ï¼Œå‡ ä¹æ¯ç§å¤„ç†å™¨éƒ½æ”¯æŒç‰¹å®šçš„å¼‚å¸¸å¤„ç†ï¼Œ<mark>ä¸­æ–­ä¹Ÿæ˜¯å¼‚å¸¸çš„ä¸€ç§</mark>ã€‚</p>
<h2 id="arm-de-yi-chang-yuan">ARMçš„å¼‚å¸¸æº</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125214514494.png" alt="image-20241125214514494"></p>
<h2 id="fiq-jiao-irq-kuai-de-yuan-yin">FIQè¾ƒIRQå¿«çš„åŸå› </h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125214951043.png" alt="image-20241125214951043"></p>
<h1 id="arm-he-yi-chang-chu-li-guo-cheng">ARMæ ¸å¼‚å¸¸å¤„ç†è¿‡ç¨‹</h1>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125215607973.png" alt="image-20241125215607973"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125214441652.png" alt="å¤„ç†å™¨å·¥ä½œæ¨¡å¼åˆ‡æ¢"></p>
<h2 id="yi-chang-xiang-liang-biao">å¼‚å¸¸å‘é‡è¡¨</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125215846276.png" alt="image-20241125215846276"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125215810206.png" alt="image-20241125215810206"></p>
<blockquote>
<p>[!NOTE]</p>
<p>ARMæ ¸æ€ä¹ˆçŸ¥é“å¼‚å¸¸å‘é‡è¡¨æ”¾åœ¨å†…å­˜å“ªä¸ªåœ°æ–¹å‘¢ï¼Ÿ</p>
<ol>
<li>Cortex-Aæ¶æ„ç‰ˆæœ¬ä¹‹å‰ï¼Œæ˜¯ç”±åå¤„ç†å™¨ï¼ˆ<a href="https://developer.arm.com/documentation/den0013/d/ARM-Processor-Modes-and-Registers/Registers/Coprocessor-15?lang=en">Coprocessor 15</a>ï¼‰ <code>CP15</code>çš„<code>C1</code>å¯„å­˜å™¨æ¥å†³å®šçš„ï¼Œä¸”åªèƒ½å­˜æ”¾åœ¨ <code>0xFFFF0000</code>å’Œ<code>0x00000000</code>ä¸¤è€…ä¸­çš„ä¸€ä¸ªã€‚</li>
<li>ä»Cortex-Aæ¶æ„ç‰ˆæœ¬å¼€å§‹ï¼Œç”±åå¤„ç†å™¨ <code>CP15</code>çš„<code>c12</code>å¯„å­˜å™¨æ¥å†³å®šï¼Œä¸”ä¸é™åˆ¶èµ·å§‹åœ°å€</li>
</ol>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125221405786.png" alt="Table B1-3 The vector tables"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125222433967.png" alt="image-20241125222433967"></p>
<blockquote>
<p><a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/Exception-mode-summary?lang=en">https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/Exception-mode-summary?lang=en</a></p>
</blockquote>
<h2 id="cortex-a-chu-li-qi-yi-chang-xiang-liang-biao-ji-di-zhi-zhi-ding">Cortex-Aå¤„ç†å™¨å¼‚å¸¸å‘é‡è¡¨åŸºåœ°å€æŒ‡å®š</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125223320833.png" alt="image-20241125223320833"></p>
<blockquote>
<p><a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities?lang=en">https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities?lang=en</a></p>
</blockquote>
<blockquote>
<p>The first column in <a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities?lang=en#CEGHDCAE">Table 11.1</a> gives the vector offset within the vector table associated with the particular type of exception. This is a table of instructions that the ARM core jumps to when an exception is raised. These instructions are located in a specific place in memory. The default vector base address is <code>0x00000000</code>, but most ARM cores permit the vector base address to be moved to <code>0xFFFF0000</code> (or <code>HIVECS</code>). <strong>All Cortex-A series processors permit this, and it is the default address selected by the Linux kernel. Cores that implement the Security Extensions can additionally set the vector base address, separately for Secure and Non-secure states, using the CP15 Vector Base Address registers.</strong></p>
<p><a href="https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/The-Vector-table?lang=en">https://developer.arm.com/documentation/den0013/d/Exception-Handling/Exception-priorities/The-Vector-table?lang=en</a></p>
</blockquote>
<h3 id="cp-15-c-1">CP15 c1</h3>
<blockquote>
<p><a href="https://documentation-service.arm.com/static/602cf701083323480d479d18?token=">https://documentation-service.arm.com/static/602cf701083323480d479d18?token=</a></p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125225458216.png" alt="image-20241125225458216" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125225614769.png" alt="Table 4-52 SCTLR bit assignments (continued)  "></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125225701958.png" alt="image-20241125225701958"></p>
<h3 id="cp-15-c-12">CP15 c12</h3>
<blockquote>
<p><a href="https://developer.arm.com/documentation/ddi0406/cd/?lang=en">ARM Architecture Reference Manual ARMv7-A and ARMv7-R edition</a></p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125230347930.png" alt="image-20241125230347930"></p>
<blockquote>
<p>[!NOTE]</p>
<p>å…¶ä¸­é«˜ä½[31:5]æ˜¯å‘é‡è¡¨çš„åŸºåœ°å€ï¼Œä½ä½[4:0]æ˜¯å¼‚å¸¸å‘é‡çš„åç§»é‡ï¼ˆoffsetï¼‰</p>
</blockquote>
<h1 id="the-end">The End</h1>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>å¼‚å¸¸</tag>
        <tag>ä¸­æ–­</tag>
      </tags>
  </entry>
  <entry>
    <title>ARMæ ¸å­¦ä¹ ï¼ˆå››ï¼‰ATPSæ ‡å‡†_æ±‡ç¼–ä¸Cæ··åˆç¼–ç¨‹_volatileå…³é”®å­—</title>
    <url>/2024/11/24/59994.html</url>
    <content><![CDATA[<h1 id="can-kao-zi-liao">å‚è€ƒèµ„æ–™</h1>
<p><a href="https://developer.arm.com/documentation/dui0041/latest/Thumb-Procedure-Call-Standard/About-the-Thumb-Procedure-Call-Standard">The ARM-THUMB Procedure Call Standard</a></p>
<h1 id="atpcs-biao-zhun">ATPCSæ ‡å‡†</h1>
<h2 id="atpcs-biao-zhun-jie-shao">ATPCSæ ‡å‡†ä»‹ç»</h2>
<p>ATPCSæ˜¯<mark>ARM-Thumb Procedure Call Standard</mark>çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯<mark>ARM-Thumbçš„ç¨‹åºè°ƒç”¨æ ‡å‡†</mark>ã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124210132131.png" alt="image-20241124210132131"></p>
<h2 id="ji-cun-qi-jiao-se">å¯„å­˜å™¨è§’è‰²</h2>
<blockquote>
<p>The first four registers r0-r3 are used to pass parameter values into a routine and result values out of a routine and to hold intermediate values within a routine (but, in general, only between subroutine calls). In ARM-state, register r12â€” also called IPâ€” can also be used to hold intermediate values between subroutine calls.</p>
</blockquote>
<p><mark>r0-r3</mark>é€šå¸¸ç”¨æ¥ä¼ é€’å‡½æ•°å‚æ•°ã€è¿”å›å‡½æ•°ç»“æœå’Œä¿å­˜å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´å˜é‡ï¼ˆä¾‹å¦‚ <code>sum=a+b</code>éœ€è¦å…ˆå°† <code>a+b</code>çš„è®¡ç®—ç»“æœå­˜åˆ°å¯„å­˜å™¨ä¸­å†å†™åˆ° <code>sum</code>å¯¹åº”çš„å†…å­˜ï¼‰ã€‚</p>
<p>åœ¨ARMçŠ¶æ€ä¸‹ï¼Œ<mark>r12ï¼Œä¹Ÿç§°ä¸ºIP</mark>å¯„å­˜å™¨ä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜ä¸´æ—¶å˜é‡ï¼Œå°¤å…¶æ˜¯å½“å…¶ä»–é€šç”¨å¯„å­˜å™¨ï¼ˆr0-r11ï¼‰å·²è¢«ä½¿ç”¨æ—¶ã€‚</p>
<blockquote>
<p><code>r12</code> (IP) is a <strong>general-purpose register</strong>, not reserved for any specific use in standard ARM programming.</p>
<p>The <strong>ARM Procedure Call Standard (AAPCS)</strong> defines it as a <strong>scratch register</strong>. This means:</p>
<ul>
<li>The <strong>caller</strong> can use it freely to store temporary values.</li>
<li>The <strong>callee</strong> (the function being called) does not preserve its value. If <code>r12</code> is used by the caller before calling another function, its value will be lost unless explicitly saved.</li>
</ul>
</blockquote>
<blockquote>
<p>Typically, the registers from r4 to r11 are used to hold the values of a routineâ€™s local variables. They are also labeled v1-v8. Only v1-v4 can be used uniformly by the whole Thumb instruction set (shown emboldened).</p>
</blockquote>
<p>ä¸€èˆ¬åœ°ï¼Œ<mark>r4-r11</mark>ç”¨æ¥ä¿å­˜å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œä»–ä»¬è¢«æ ‡è®°ä¸ºv1-v8ã€‚ThumbæŒ‡ä»¤é›†åªèƒ½ä½¿ç”¨v1-v4ã€‚</p>
<blockquote>
<p>In all variants of the procedure call standard, registers r12-r15 have special roles. In these roles they are labeled IP, SP, LR and PC (or ip, sp, lr, and pc, but this standard uses the upper case name for the special role)</p>
</blockquote>
<p><mark>r12-r15</mark>æœ‰ç€ç‰¹æ®Šçš„è§’è‰²ï¼Œä¾‹å¦‚IPï¼ˆä¸´æ—¶ä¿å­˜SPï¼‰ï¼ŒSPï¼ˆæŒ‡å‘æ ˆé¡¶ï¼‰ï¼ŒLRï¼ˆè·³è½¬æ—¶ç”¨æ¥ä¿å­˜PCï¼‰ã€PCï¼Œå¹¶ä¸”ä½¿ç”¨å¤§å†™æ¥æ ‡ç¤ºä»–ä»¬çš„ç‰¹æ®Šè§’è‰²ã€‚</p>
<blockquote>
<p>In some variants of the procedure call standard, r9 and r10 also have a special role. In these roles, r9 is labeled SB and r10 is labeled SL (or sb and sl).<br>
Only registers r0-r7, SP, LR and PC are ubiquitously available in Thumb state. Their synonyms and special names are shown emboldened. Few Thumb instructions can access the high registers, v5-v8, SB, SL and IP.<br>
In Thumb-state, r7 is often used as a work register and is also labeled WR</p>
</blockquote>
<h2 id="can-shu-chuan-di">å‚æ•°ä¼ é€’</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124212508273.png" alt="image-20241124212508273"></p>
<p><mark>åœ¨å®šä¹‰å‡½æ•°æ—¶ï¼Œå‚æ•°æ•°é‡å°½é‡ä¸è¦è¶…è¿‡4ä¸ªï¼Œè¿™æ ·æ•ˆç‡è¾ƒå¥½</mark></p>
<h2 id="han-shu-fan-hui-zhi">å‡½æ•°è¿”å›å€¼</h2>
<ul>
<li>è¿”å›å€¼ä¸ºä¸€ä¸ª32ä½çš„æ•´æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡å¯„å­˜å™¨0è¿”å›</li>
<li>è¿”å›å€¼ä¸ºä¸€ä¸ª64ä½æ•´æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡R0å’ŒR1è¿”å›ï¼Œä¾æ­¤ç±»æ¨</li>
</ul>
<h2 id="zhan-zheng-fen-xi">æ ˆå¸§åˆ†æ</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124213834303.png" alt="image-20241124213834303" style="zoom:50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124213931226.png" alt="image-20241124213931226"></p>
<h1 id="fan-hui-bian-fen-xi-atpcs-biao-zhun">åæ±‡ç¼–åˆ†æATPCSæ ‡å‡†</h1>
<h2 id="zhun-bei-hui-bian-he-c-wen-jian">å‡†å¤‡æ±‡ç¼–å’ŒCæ–‡ä»¶</h2>
<p>å‡†å¤‡ä¸€ä¸ªæ±‡ç¼–å¯åŠ¨æ–‡ä»¶å’Œä¸€ä¸ªCæ–‡ä»¶ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125151255393.png" alt="image-20241125151255393"></p>
<p>åœ¨ <code>asm.s</code>ä¸­ï¼Œåœ¨è°ƒç”¨ <code>main_label</code>å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬æ“ä½œäº†ä¸‹R0-R2ï¼Œå¹¶è®¾ç½®äº†SPï¼Œæ¨¡æ‹Ÿåœ¨è°ƒç”¨å‡½æ•°å‰åšäº†ä¸€äº›æ“ä½œ</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x11			
	mov r1,#0x22
    mov r2,#0x33
    mov sp,#0x00002000
	bl main_label	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main_label</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	b <span class="token operator">=</span> i<span class="token operator">++</span> <span class="token operator">+</span> <span class="token operator">++</span>i<span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="jin-yong-bian-yi-you-hua">ç¦ç”¨ç¼–è¯‘ä¼˜åŒ–</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125151330962.png" alt="image-20241125151330962" style="zoom: 50%;">
<h2 id="diao-shi-fen-xi-amp-nei-cun-ying-she">è°ƒè¯•åˆ†æ&amp;å†…å­˜æ˜ å°„</h2>
<p>åœ¨ç‚¹å‡»debugåï¼Œæ­¥è¿›ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ·»åŠ ä¸€ä¸‹å†…å­˜æ˜ å°„ <code>0x00001000,0x00002000</code>ï¼Œå› ä¸ºåœ¨ <code>asm.s</code>ä¸­æˆ‘ä»¬æœ‰è®¾ç½®è¿‡SP <code>mov sp,#0x00002000</code>ï¼ˆ<mark>æ³¨æ„æ¯æ¬¡ç‚¹å‡»debugåéƒ½éœ€è¦æ‰‹åŠ¨æ˜ å°„ä¸‹</mark>ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125102205035.png" alt="image-20241125102205035"></p>
<p>æ¥ç€æˆ‘ä»¬æ­¥è¿›ï¼Œåœ¨è°ƒç”¨ <code>main_label</code>å‡½æ•°ä¹‹å‰ï¼Œå¯¹R0-R2ï¼ŒSP(R13)æœ‰æ‰€ä½¿ç”¨ï¼ˆæ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨å‰æ“ä½œè¿‡ç›¸å…³çš„å¯„å­˜å™¨ï¼‰ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125104048265.png" alt="image-20241125104048265"></p>
<p>å¯„å­˜å™¨çŠ¶æ€ç¤ºä¾‹ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132148176.png" alt="image-20241125132148176" style="zoom:50%;">
<h2 id="han-shu-diao-yong-fen-xi">å‡½æ•°è°ƒç”¨åˆ†æ</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125115716832.png" alt="image-20241125115716832"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241124213834303.png" alt="image-20241124213834303" style="zoom:50%;">
<p>å‚ç…§ATPCSæ ‡å‡†ï¼Œæˆ‘ä»¬æ¥ç€åˆ†æ <code>main_label</code>å‡½æ•°çš„æ‰§è¡Œã€‚</p>
<h3 id="jiang-sp-zan-cun-dao-ip">å°†SPæš‚å­˜åˆ°IP</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125104614719.png" alt="image-20241125104614719"></p>
<p>é¦–å…ˆå°†<code>R13(SP)</code>é€åˆ°äº†<code>R12(IP)</code>è¿›è¡Œä¿å­˜ï¼ˆè¿™é‡Œå¯ä»¥çœ‹å‡º<code>IP</code>çš„ä¸´æ—¶ä¿å­˜ä½œç”¨ï¼Œå°†å‡½æ•°è°ƒç”¨å‰çš„SPæ ˆé¡¶æŒ‡é’ˆæš‚å­˜èµ·æ¥ä»¥ä¾¿åç»­æ¢å¤ï¼‰ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132222836.png" alt="image-20241125132222836"></p>
<p>æ¥ç€æˆ‘ä»¬çœ‹ä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼š</p>
<p>å‹æ ˆPC,LR,IP,FP</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125105604588.png" alt="image-20241125105604588"></p>
<p>å°†<code>R11(FP)ã€R12(IP)ã€R14(LR)ã€PC(R15)</code>é€šè¿‡ <code>STMDB</code>æŒ‡ä»¤è¿›è¡Œå‹æ ˆï¼ˆå‚è€ƒå¦ä¸€ç¯‡æ–‡ç« ã€ŠARMæ ¸å­¦ä¹ ï¼ˆäºŒï¼‰æŒ‡ä»¤é›†ã€‹ï¼‰ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>ATPCSæ ‡å‡†è§„å®šä½¿ç”¨<mark>æ»¡å‡æ ˆæ¨¡å¼</mark>ï¼ˆä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿ï¼Œæ ˆé¡¶æŒ‡é’ˆSPæŒ‡å‘æœ€åä¸€ä¸ªå…¥æ ˆçš„æ•°æ®åœ°å€ï¼‰</li>
<li><code>STM</code>ï¼šå¤šæ•°æ®ä¼ è¾“æŒ‡ä»¤ï¼ŒåŒæ—¶å°†å¤šä¸ªæ•°æ®è¿›è¡Œå‹æ ˆ</li>
<li><code>DB</code>ï¼š <mark>Decrease&nbsp;Before</mark>ï¼ˆå…ˆé€’å‡SPç„¶åå‹æ ˆæ•°æ®ï¼‰ï¼Œè¿™é‡Œå‹æ ˆ4ä¸ªå¯„å­˜å™¨ï¼ˆå­—å®½4å­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥SPä¼šé€’å‡4*4=16</li>
<li>åŒæ—¶å‹æ ˆå¤šä¸ªå¯„å­˜å™¨æ—¶ï¼Œåºå·ï¼ˆRnä¸­çš„nï¼‰å¤§çš„å¯„å­˜å™¨å¯¹åº”æ ˆçš„é«˜åœ°å€ï¼Œåºå·å°çš„åˆ™å¯¹åº”ä½åœ°å€</li>
</ul>
<p>å¯„å­˜å™¨çŠ¶æ€ç¤ºæ„å›¾ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132238290.png" alt="image-20241125132238290" style="zoom:50%;">
<h3 id="she-zhi-zhan-ji-zhi-fp-zhan-di-shu-ju-de-di-zhi">è®¾ç½®æ ˆåŸºå€FPï¼ˆæ ˆåº•æ•°æ®çš„åœ°å€ï¼‰</h3>
<p>å°†R12(IPï¼Œä¹‹å‰ä¿å­˜äº†SPï¼Œå³è°ƒç”¨æ–¹callerçš„SP)ï¼Œé€šè¿‡ <code>SUB</code>æŒ‡ä»¤å‡4ï¼Œèµ‹å€¼ç»™R11ï¼ˆFPï¼Œæ ˆåŸºå€¼ï¼Œè¢«è°ƒæ–¹calleeå³ <code>main_label</code>å‡½æ•°çš„æ ˆçš„èµ·å§‹åœ°å€ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125115123312.png" alt="image-20241125115123312"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125120006973.png" alt="image-20241125120006973"></p>
<p>å¯„å­˜å™¨ç¤ºæ„å›¾:</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132458366.png" alt="image-20241125132458366"></p>
<blockquote>
<p>callerè¡¨ç¤ºè°ƒç”¨æ–¹ï¼Œcalleeè¡¨ç¤ºè¢«è°ƒæ–¹</p>
</blockquote>
<h3 id="zeng-jia-sp-kuo-da-zhan-kong-jian">å¢åŠ SPï¼Œæ‰©å¤§æ ˆç©ºé—´</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125121914111.png" alt="image-20241125121914111"></p>
<p>æ¥ç€é€šè¿‡ <code>SUB</code>æŒ‡ä»¤ï¼Œå°†SP(R13)å‡å» <code>0x00000010</code>ï¼ˆå³16å­—èŠ‚ï¼Œ4ä¸ªå­—ï¼‰ï¼Œç›¸å½“äºå°†SPä¸‹ç§»äº†å››ä¸ªå­˜å‚¨å•å…ƒ</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125132531947.png" alt="image-20241125132531947"></p>
<p>è¿™æ ·å°±ç›¸å½“äºåœ¨æ ˆä¸­ç©ºå‡ºå››ä¸ªå­˜å‚¨å•å…ƒï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹</p>
<h3 id="han-shu-ru-can-ya-zhan">å‡½æ•°å…¥å‚å‹æ ˆ</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125131249986.png" alt="image-20241125131249986"></p>
<p>è¿™é‡Œå°†R0å†™åˆ°R11ï¼ˆFPï¼Œæ ˆåŸºå€ï¼‰å‘ä¸‹åç§» <code>0x0018</code>ï¼ˆå³24å­—èŠ‚ï¼Œå…­ä¸ªå­—ï¼‰å¯¹åº”çš„å­˜å‚¨å•å…ƒä¸­ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125133004294.png" alt="image-20241125133004294"></p>
<p>åŒæ ·çš„ï¼Œå°†R1å†™åˆ°FPå‘ä¸‹åç§» <code>0x001C</code>ï¼ˆ28ä¸ªå­—èŠ‚ï¼Œ7ä¸ªå­—ï¼‰çš„å­˜å‚¨å•å…ƒä¸­ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134213403.png" alt="image-20241125134213403"></p>
<p>æ ¹æ®ATPCSæ ‡å‡†çš„è§„èŒƒï¼Œ<code>r0</code>é€šå¸¸ç”¨æ¥ä¼ é€’ç¬¬ä¸€ä¸ªå‚æ•°<code>a1</code>ï¼Œ<code>r1</code>é€šå¸¸ç”¨æ¥ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°<code>a2</code>ï¼Œå› æ­¤ä¸Šè¿°æ“ä½œèµ·å§‹å°±æ˜¯å°†å‡½æ•°çš„ä¸¤ä¸ªå…¥å‚ <code>main_label(int argc, const char *argv[])</code> å‹æ ˆ</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125131207660.png" alt="image-20241125131207660" style="zoom:33%;">
<h3 id="han-shu-ju-bu-bian-liang-ya-zhan">å‡½æ•°å±€éƒ¨å˜é‡å‹æ ˆ</h3>
<p>å¯¹åº” <code>int i = 0</code></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125133712296.png" alt="image-20241125133712296"></p>
<p>å…ˆå°†å¸¸é‡ <code>0</code>ä¼ è¾“åˆ°å¯„å­˜å™¨R3ä¸­ï¼ˆè¿™é‡ŒR3ä½œä¸ºé€šç”¨å¯„å­˜å™¨å­˜æ”¾ä¸´æ—¶çš„å¸¸é‡ï¼‰ï¼Œå†é€šè¿‡ <code>STR</code>æŒ‡ä»¤å‹æ ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134430454.png" alt="image-20241125134430454"></p>
<p>åŒæ ·çš„ï¼Œå°†å±€éƒ¨å˜é‡ <code>b</code>å‹æ ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134728492.png" alt="image-20241125134728492"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125134805022.png" alt="image-20241125134805022"></p>
<h3 id="ji-yu-zhan-he-ji-cun-qi-zuo-yun-suan">åŸºäºæ ˆå’Œå¯„å­˜å™¨åšè¿ç®—</h3>
<p>æ¥ç€å°±åˆ°äº† <code>b = i++ + ++i;</code>è¿™ä¸€è¡Œä»£ç çš„æ‰§è¡Œï¼Œå®ƒçš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">++</span>i<span class="token punctuation">;</span>
b <span class="token operator">=</span> i <span class="token operator">+</span> i<span class="token punctuation">;</span>
i<span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125135029185.png" alt="image-20241125135029185"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125135429854.png" alt="image-20241125135429854"></p>
<p>æ¥ç€åˆ†æï¼Œæˆ‘ä»¬ä¼šå‘ç°å¤„ç†å™¨çš„è¡Œä¸ºä¸æˆ‘ä»¬åœ¨Cè¯­è¨€çš„é¢„æœŸæ­¥éª¤æ˜¯æœ‰å‡ºå…¥çš„ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºæŒ‡ä»¤é‡æ’åºçš„åŸå› ï¼Œ<mark>ä½†æ— è®ºæ€æ ·é‡æ’åºï¼Œå…¶ç»“æœä¸Cè¯­è¨€çš„é¢„æœŸæ­¥éª¤å¾—å‡ºçš„ç»“æœè¦ä¿æŒä¸€è‡´ã€‚</mark></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125141616740.png" alt="image-20241125141616740"></p>
<h3 id="diao-yong-zi-han-shu-zi-guo-cheng-subroutine">è°ƒç”¨å­å‡½æ•°/å­è¿‡ç¨‹ï¼ˆsubroutineï¼‰</h3>
<p>è¿™ä¸æˆ‘ä»¬ä»æ±‡ç¼–å¼€å§‹è°ƒç”¨ <code>main_label</code>çš„åˆ†ææ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚</p>
<h3 id="han-shu-fan-hui">å‡½æ•°è¿”å›</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€çœ‹ <code>main_label</code>å‡½æ•°çš„æœ€åä¸€è¡Œ <code>return 0;</code>éƒ½åšäº†ä»€ä¹ˆï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125144155014.png" alt="image-20241125144155014"></p>
<p>é¦–å…ˆå°†å¸¸é‡ <code>0</code>ï¼ˆè¿”å›å€¼ï¼‰ä¼ è¾“åˆ°R3è¿›è¡Œä¸´æ—¶ä¿å­˜ï¼›ç„¶åæ ¹æ®ATPCSæ ‡å‡†ï¼Œåº”è¯¥å°†è¿”å›å€¼é€šè¿‡R0æ¥ä¼ é€’ï¼Œå› æ­¤åˆå°†R3ä¼ è¾“åˆ°äº†R0</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125144454192.png" alt="image-20241125144454192" style="zoom:33%;">
<p>æ¥ç€é€šè¿‡ <code>SUB</code>ï¼Œå°†R13(SP)æŒ‡å‘R11(FP)å‘ä¸‹åç§»<code>0xC</code>çš„ä½ç½®ã€‚å¦‚ä¸‹å›¾ï¼ŒSPæŒ‡å‘è¿™ä¸ªä½ç½®åï¼Œç›¸å½“äºå°†å‡½æ•°å‚æ•°å’Œå±€éƒ¨å˜é‡å‡ºæ ˆé‡Šæ”¾äº†ï¼ˆå¯¹åº”å›¾ä¸­ç°è‰²éƒ¨åˆ†ï¼‰</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125144022274.png" alt="image-20241125144022274"></p>
<p>æ¥ç€é€šè¿‡ <code>LDMIA</code>å°†è¿˜ä¿å­˜åœ¨æ ˆä¸­çš„è°ƒç”¨æ–¹çš„<code>LR, SP, FP</code>æ¢å¤åˆ°<code>R14, R13, R11</code>ä¸­</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125145835783.png" alt="image-20241125145835783"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125145806719.png" alt="image-20241125145806719"></p>
<p>æ¥ç€é€šè¿‡ <code>BX</code>æŒ‡ä»¤æ ¹æ®LR(R14)è·³è½¬å›è°ƒç”¨æ–¹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125150802906.png" alt="image-20241125150802906"></p>
<blockquote>
<p>ä¸ºä»€ä¹ˆé€šè¿‡LRå¯ä»¥è·³è½¬å›å»å‘¢ï¼Ÿ</p>
</blockquote>
<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡ <code>bl main_label</code>è·³è½¬çš„ï¼Œ<code>l</code>åç¼€ä¼šå°†å½“å‰PCæš‚å­˜åˆ°LRä¸­ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ <code>BX R14</code>è·³è½¬å›å»ã€‚</p>
<h1 id="hui-bian-yu-c-hun-he-bian-cheng">æ±‡ç¼–ä¸Cæ··åˆç¼–ç¨‹</h1>
<h2 id="hui-bian-yu-yan-diao-yong-c-yu-yan">æ±‡ç¼–è¯­è¨€è°ƒç”¨Cè¯­è¨€</h2>
<h3 id="zai-kan-c-yu-yan-cheng-xu-ru-kou">å†çœ‹Cè¯­è¨€ç¨‹åºå…¥å£</h3>
<blockquote>
<p>Cè¯­è¨€ç¨‹åºçš„å…¥å£æ˜¯mainå‡½æ•°å—ï¼Ÿ</p>
</blockquote>
<p>ç»è¿‡ä¸Šæ–‡çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“Cè¯­è¨€å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¾èµ–æ ˆçš„ï¼Œåœ¨å‡½æ•°ä»£ç çœŸæ­£æ‰§è¡Œå‰éœ€è¦å°†è°ƒç”¨æ–¹ç¨‹åºçŠ¶æ€ç›¸å…³çš„å¯„å­˜å™¨å‹æ ˆä¿æŠ¤ï¼ˆä¾‹å¦‚ <code>LR, SP, FP</code>ï¼‰ã€å‡½æ•°å‚æ•°å‹æ ˆï¼Œå¦‚æœæœ‰å±€éƒ¨å˜é‡åˆ™ä¹Ÿéœ€è¦å‹æ ˆï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¿ç®—æ˜¯åŸºäºæ ˆå’Œå¯„å­˜å™¨çš„é…åˆæ¥å®Œæˆçš„ã€‚</p>
<p>å› æ­¤æ¯ä¸ªå‡½æ•°çš„åœ¨æ‰§è¡Œå‰éƒ½éœ€è¦è®¾ç½®æ ˆçš„èµ·å§‹åœ°å€ï¼ˆSPï¼‰ï¼Œ<code>main</code>å½“ç„¶ä¹Ÿä¸ä¾‹å¤–ï¼Œè€Œè¿™éœ€è¦å€ŸåŠ©æ±‡ç¼–æ¥å®Œæˆã€‚</p>
<h3 id="mei-you-she-zhi-sp-han-shu-wu-fa-zheng-chang-zhi-xing">æ²¡æœ‰è®¾ç½®SPï¼Œå‡½æ•°æ— æ³•æ­£å¸¸æ‰§è¡Œ</h3>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä¸‹ç¨‹åºï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125154604074.png" alt="image-20241125154604074"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x2			
	mov r1,#0x3
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">int add(int a, int b) {
    return a + b;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è°ƒè¯•å‰éœ€è¦å…ˆç¦ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–å¹¶é‡æ–°ç¼–è¯‘ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125154632764.png" alt="image-20241125154632764" style="zoom:33%;">
<p>è°ƒè¯•æ—¶ä¼šå‘ç°ï¼Œå‡½æ•°æ‰§è¡Œå‰çš„å‹æ ˆå¯¼è‡´SPå˜æˆäº†<code>0xFFFFFFF0</code>ï¼Œå¹¶ä¸”æ¥ç€æ­¥è¿›ï¼Œç¨‹åºæ— æ³•æŒ‰ç…§é¢„æœŸç»“æŸã€‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125155225192.png" alt="image-20241125155225192"></p>
<p>è¿™æ˜¯å› ä¸ºè°ƒç”¨å‡½æ•°æ—¶æ²¡æœ‰è®¾ç½®SPï¼ŒSPé»˜è®¤ä¸ºé›¶å€¼ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125155435833.png" alt="image-20241125155435833"></p>
<h3 id="han-shu-diao-yong-qian-xu-yao-zheng-que-she-zhi-sp">å‡½æ•°è°ƒç”¨å‰éœ€è¦æ­£ç¡®è®¾ç½®SP</h3>
<p>äºæ˜¯æˆ‘ä»¬åœ¨å‡½æ•°è°ƒç”¨å‰ï¼Œè®¾ç½®ä¸€ä¸‹æ ˆæŒ‡é’ˆSPï¼Œå¹¶å°†ç›¸åº”çš„å†…å­˜èŒƒå›´æ˜ å°„ä¸€ä¸‹</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x2			
	mov r1,#0x3
    ldr sp,=0x4000FFF0
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ³¨æ„ï¼Œè¿™é‡Œè¦å°†SPè®¾ç½®ä¸º4çš„æ•´æ•°å€</mark></p>
<p><code>0x40000000,0x4000FFFF</code></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125160139087.png" alt="image-20241125160139087" style="zoom: 50%;">
<p>è°ƒæ•´åå‘ç°å¯ä»¥æ­£å¸¸æ‰§è¡Œåˆ° <code>stop</code>ï¼Œå¹¶ä¸”å‡½æ•°è¿”å›å€¼ <code>2+3=5</code>ä¹Ÿé€šè¿‡R0ä¼ é€’äº†è¿‡æ¥</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125164223712.png" alt="image-20241125164223712"></p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥æ‰“å¼€å‡½æ•°è°ƒç”¨æ ˆçª—å£æ¥æ›´ç›´è§‚åœ°è§‚å¯Ÿå…¥å‚å‹æ ˆçš„è¿‡ç¨‹ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125164542704.png" alt="image-20241125164542704" style="zoom: 50%;">
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125165001604.png" alt="image-20241125165001604"></p>
<h2 id="c-yu-yan-nei-qian-hui-bian">Cè¯­è¨€å†…åµŒæ±‡ç¼–</h2>
<h3 id="ge-shi">æ ¼å¼</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125165243027.png" alt="image-20241125165243027" style="zoom: 50%;">
<h3 id="shi-li">ç¤ºä¾‹</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125172126182.png" alt="image-20241125172126182"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
	mov r0,#0x2			
	mov r1,#0x3
    ldr sp,=0x4000FFF0
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    
    <span class="token keyword">asm</span><span class="token punctuation">(</span>
        <span class="token string">"add r0,%1,%2\n"</span>
        <span class="token string">"mov %0,r0\n"</span>
        <span class="token operator">:</span><span class="token string">"=r"</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token operator">:</span><span class="token string">"r"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token operator">:</span><span class="token string">"r0"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>æ³¨æ„ï¼šå¯ä»¥é€šè¿‡%nå¼•ç”¨è¾“å…¥åˆ—è¡¨ã€è¾“å‡ºåˆ—è¡¨ä¸­çš„å¯„å­˜å™¨ï¼Œä»è¾“å‡ºåˆ—è¡¨å¼€å§‹ç¼–å·ï¼Œè¾“å‡ºåˆ—è¡¨çš„ç¼–å·æ¥ç€è¾“å…¥åˆ—è¡¨çš„æœ€åä¸€ä¸ª</p>
</blockquote>
<ul>
<li>
<p>é€šè¿‡ <code>asm</code>å…³é”®å­—å†…åµŒä¸€æ®µæ±‡ç¼–ä»£ç </p>
</li>
<li>
<p><code>:"r"(a), "r"(b)</code>ï¼š<mark>è¾“å…¥åˆ—è¡¨</mark>ï¼Œå£°æ˜å°†Cç¨‹åºä¸­å“ªäº›å˜é‡è¾“å…¥åˆ°å†…åµŒæ±‡ç¼–çš„é€šç”¨å¯„å­˜å™¨ä¸­ï¼ˆå…·ä½“å“ªä¸ªå¯„å­˜å™¨æ˜¯æ— æ³•é¢„çŸ¥çš„ï¼Œå¯ä»¥é€šè¿‡ <code>%</code>è¿›è¡Œå¼•ç”¨ï¼‰ã€‚<mark>å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œåˆ™ç•™ä¸€ä¸ªç©ºçš„å†’å·å³å¯ï¼Œä½†ä¸èƒ½å»æ‰è¯¥è¡Œã€‚</mark></p>
</li>
<li>
<p><code>"add r0,%1,%2\n"</code>ï¼š<mark>æ±‡ç¼–æŒ‡ä»¤</mark>ï¼Œé€šè¿‡ <code>%1</code>ã€<code>%2</code>å¼•ç”¨è¾“å…¥åˆ—è¡¨çš„ä¸­çš„å˜é‡ <code>a</code>ã€<code>b</code>å¯¹åº”çš„å¯„å­˜å™¨ï¼Œå¹¶é€šè¿‡ <code>add</code>æŒ‡ä»¤å°†è¿™ä¸¤ä¸ªå¯„å­˜å™¨ç›¸åŠ ï¼Œç»“æœå­˜å…¥ <code>r0</code>ï¼›<mark>æ³¨æ„ï¼Œæ¢è¡Œæ˜¯ä¸å¯çœç•¥çš„ï¼Œæ ‡ç¤ºè¿™æ¡æŒ‡ä»¤ç»“æŸ</mark></p>
</li>
<li>
<p><code>:"=r"(c)</code>ï¼š<mark>è¾“å‡ºåˆ—è¡¨</mark>ï¼Œå£°æ˜å°†Cç¨‹åºçš„å“ªäº›å˜é‡çš„å€¼ç”±å†…åµŒæ±‡ç¼–è¾“å‡ºã€‚<code>=</code>æ ‡ç¤ºäº†è¯¥æ±‡ç¼–ç»“æŸæ—¶éœ€è¦å°†å¯„å­˜å™¨å†™å…¥å˜é‡ä¸­ã€‚</p>
</li>
<li>
<p><code>"mov %0,r0\n"</code>ï¼š<mark>æ±‡ç¼–æŒ‡ä»¤</mark>ï¼Œå°† <code>r0</code>ä¸­çš„å€¼è¾“å…¥åˆ° <code>%0</code>å¼•ç”¨çš„å¯„å­˜å™¨ä¸­ï¼Œç”±äºå¼•ç”¨ç¼–å·æ˜¯ä»è¾“å‡ºåˆ—è¡¨å¼€å§‹çš„ï¼Œå› æ­¤å¼•ç”¨çš„å°±æ˜¯å˜é‡ <code>c</code>å…³è”çš„å¯„å­˜å™¨</p>
</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125165906124.png" alt="image-20241125165906124"></p>
<p>è°ƒè¯•å‰åˆ«å¿˜äº†æ˜ å°„ä¸‹å†…å­˜ <code>0x40000000,0x4000FFFF</code></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125174751017.png" alt="image-20241125174751017"></p>
<h1 id="volatile-guan-jian-zi">volatileå…³é”®å­—</h1>
<h2 id="gcc-bian-yi-you-hua">gccç¼–è¯‘ä¼˜åŒ–</h2>
<h3 id="shi-li-cheng-xu">ç¤ºä¾‹ç¨‹åº</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125181741845.png" alt="image-20241125181741845"></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global _start

_start:
    ldr sp,=0x4000FFF0
	bl add	
	
stop:
	b stop				
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> global_a <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> global_b <span class="token operator">=</span> <span class="token number">0x4</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> global_a <span class="token operator">+</span> global_b<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>global_a <span class="token operator">&gt;</span> global_b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="kai-qi-bian-yi-qi-you-hua">å¼€å¯ç¼–è¯‘å™¨ä¼˜åŒ–</h3>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125181830904.png" alt="image-20241125181830904" style="zoom: 50%;">
<h3 id="you-hua-hou-de-hui-bian-zhi-ling-fen-xi">ä¼˜åŒ–åçš„æ±‡ç¼–æŒ‡ä»¤åˆ†æ</h3>
<p>å†…å­˜æ˜ å°„ï¼š<code>0x40000000,0x4000FFFF</code></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125181717824.png" alt="image-20241125181717824"></p>
<p>å¯ä»¥å‘ç°åœ¨æ‰§è¡Œ <code>int c = global_a + global_b;</code>æ—¶ä»å†…å­˜è¯»å– <code>global_a</code>å’Œ <code>global_b</code>çš„å€¼åˆ°<code>R2, R3</code>ä¸­ï¼›ä½†æ˜¯æ‰§è¡Œ <code>if(global_a &gt; global_b)</code>ï¼Œå¹¶æ²¡é‡æ–°ä»å†…å­˜è¯»å– <code>global_a</code>å’Œ <code>global_b</code>çš„å€¼ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æ­¤å‰<code>R2, R3</code>çš„å¿«ç…§ã€‚</p>
<h3 id="bian-yi-qi-you-hua-si-xiang-ji-bi-duan">ç¼–è¯‘å™¨ä¼˜åŒ–æ€æƒ³åŠå¼Šç«¯</h3>
<blockquote>
<p>[!NOTE]</p>
<p>æ ¹æ®å¦ä¸€ç¯‡æ–‡ç« ã€ŠARMæ ¸å­¦ä¹ ï¼ˆä¸‰ï¼‰æŒ‡ä»¤æµæ°´çº¿åˆ†æåŠä¼ªæŒ‡ä»¤ã€‹çš„åˆ†æï¼Œè¿™æ˜¯å› ä¸ºå†…å­˜è®¿é—®æ“ä½œè¾ƒä½ï¼Œæ— æ³•å‘æŒ¥æŒ‡ä»¤æµæ°´çº¿çš„æœ€ä½³æ€§èƒ½ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¼˜åŒ–ä¼šä½¿ç”¨å¯„å­˜å™¨å¿«ç…§ä»£æ›¿å†…å­˜è®¿é—®</p>
</blockquote>
<p>é‚£ä¹ˆåœ¨<mark>å¹¶å‘åœºæ™¯</mark>ä¸‹ï¼Œå¦‚æœåœ¨æ‰§è¡Œ <code>if(global_a &gt; global_b)</code>æ—¶å‘ç”Ÿäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¹¶ä¸”å…¨å±€å˜é‡ <code>global_a</code>å’Œ <code>global_b</code>çš„å€¼è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆ <code>R2, R3</code>ä¸­çš„å€¼å°±ä¸æ˜¯æœ€æ–°çš„ï¼Œå› è€Œä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜ã€‚</p>
<h2 id="volatile-guan-jian-zi-de-zuo-yong">volatileå…³é”®å­—çš„ä½œç”¨</h2>
<blockquote>
<p>[!TIP]</p>
<p><code>volatile</code>å…³é”®å­—çš„è¯­æ„æ˜¯æ˜“å˜çš„ï¼Œè¢«è¯¥å…³é”®å­—ä¿®é¥°çš„å˜é‡åœ¨è¯»å†™æ—¶èƒ½å¤Ÿç¦æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä»è€Œä½¿å¾—æ¯æ¬¡è¯» <code>volatile</code>å˜é‡å¼ºåˆ¶ä»å†…å­˜è¯»å–æœ€æ–°å€¼ï¼ˆåœ¨CPU Cacheæ¨¡å‹ä¸­æ¯æ¬¡å†™ <code>volatile</code>å˜é‡ ä¹Ÿä¼šç«‹å³å°†å¯„å­˜å™¨ä¸­çš„å€¼åˆ·æ–°åˆ°å†…å­˜ï¼‰</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬ç»™ <code>global_a</code>å’Œ <code>global_b</code>åŠ ä¸Š <code>volatile</code>ä¿®é¥°åå†æ¥è°ƒè¯•ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241125184042361.png" alt="image-20241125184042361"></p>
<p>å¯ä»¥å‘ç° <code>if(global_a &gt; global_b)</code>æ—¶ï¼Œé€šè¿‡ <code>LDR</code>æŒ‡ä»¤ï¼Œå¼ºåˆ¶ä»å†…å­˜è¯»å€¼äº†ã€‚</p>
<h1 id="the-end">The End</h1>
]]></content>
      <categories>
        <category>ARM</category>
      </categories>
      <tags>
        <tag>ARM</tag>
        <tag>ARMv7</tag>
        <tag>ATPS</tag>
      </tags>
  </entry>
  <entry>
    <title>STM32ç³»ç»Ÿæ—¶é’Ÿåˆå§‹åŒ–æºç è§£æï¼ˆSPLåº“ï¼ŒSTM32F103ZEï¼‰</title>
    <url>/2024/11/23/19447.html</url>
    <content><![CDATA[<h1 id="yi-bei-jing">ä¸€ã€èƒŒæ™¯</h1>
<h2 id="kai-fa-huan-jing">å¼€å‘ç¯å¢ƒ</h2>
<ul>
<li>STM32F103ZET6</li>
</ul>
<h2 id="yuan-li-tu">åŸç†å›¾</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123160212385.png" alt="image-20241123160212385"></p>
<h3 id="hse-gao-su-wai-bu-jing-zhen-high-speed-external-oscillator">HSE-é«˜é€Ÿå¤–éƒ¨æ™¶æŒ¯High Speed External oscillator</h3>
<p>é€šè¿‡23ã€24å·å¼•è„šæ¥å…¥8Mçš„é«˜é€Ÿå¤–éƒ¨æ™¶æŒ¯ã€‚</p>
<h3 id="hsi-di-su-wai-bu-jing-zhen-low-speed-external-oscillator">HSI-ä½é€Ÿå¤–éƒ¨æ™¶æŒ¯Low Speed External oscillator</h3>
<p>é€šè¿‡GPIOå¼•è„šPC14å’ŒPC15çš„å¤ç”¨æ¥å…¥32.768kHzä½é€Ÿå¤–éƒ¨æ™¶æŒ¯ã€‚</p>
<h2 id="yi-cube-de-tu-xing-hua-pei-zhi-wei-li-shuo-ming">ä»¥Cubeçš„å›¾å½¢åŒ–é…ç½®ä¸ºä¾‹è¯´æ˜</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123160112667.png" alt="image-20241123160112667"></p>
<p>MCUå†…ç½®äº†ä¸¤ä¸ªRCéœ‡è¡ç”µè·¯ï¼š</p>
<ul>
<li>HSI RCï¼ŒHigh Speed Internal RCï¼Œ8Mé«˜é€Ÿå†…éƒ¨RCéœ‡è¡ç”µè·¯</li>
<li>LSI RCï¼ŒLow Speed Internal RCï¼Œ40kHzä½é€Ÿå†…éƒ¨RCéœ‡è¡ç”µè·¯</li>
</ul>
<h3 id="wei-shi-yao-mcu-nei-zhi-liao-huan-xu-yao-wai-jie-jing-zhen">ä¸ºä»€ä¹ˆMCUå†…ç½®äº†ï¼Œè¿˜éœ€è¦å¤–æ¥æ™¶æŒ¯</h3>
<ul>
<li>
<p>RCéœ‡è¡ç”µè·¯å®¹æ˜“å—åˆ°å…¶ä»–ç”µè·¯å¹²æ‰°ï¼Œå¯¼è‡´ä¿¡å·ä¸ç¨³å®šï¼Œä¸”ç²¾åº¦è¿œæ¯”æ™¶æŒ¯ä½ã€‚</p>
</li>
<li>
<p>ç”±äºMCUçš„å¾®å°å°è£…ï¼Œæ— æ³•å†…åµŒè¾ƒå¤§çš„æ™¶æŒ¯</p>
</li>
<li>
<p>å°†æ™¶æŒ¯çš„çµæ´»é€‰æ‹©æƒäº¤ç»™å¼€å‘è€…</p>
</li>
</ul>
<h3 id="cube-pei-zhi-jie-xi">Cubeé…ç½®è§£æ</h3>
<p>å¤–æ¥æ™¶æŒ¯é€šè¿‡å¼•è„šæ¥å…¥MCUï¼Œä½†ç”±äºMCUçš„ä¸»é¢‘è¾ƒé«˜ï¼Œä¸€èˆ¬å°†HSEé€šè¿‡PLLï¼ˆé”ç›¸ç¯ï¼Œç”¨æ¥å€é¢‘ï¼‰æé«˜é¢‘ç‡å†ä½œä¸ºç³»ç»Ÿæ—¶é’ŸSYSCLKçš„æ¥æºã€‚</p>
<p>å›¾ä¸­ <mark>Mux</mark>æ˜¯å¤šè·¯é€‰æ‹©å™¨ <mark>Multiplex</mark>çš„ç¼©å†™ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„8M HSEç»è¿‡äº†1åˆ†é¢‘ï¼ˆå³ä¸åˆ†é¢‘ï¼‰ï¼Œè¿æ¥åˆ°äº†PLL Source Muxï¼Œé€šè¿‡è¿™ä¸ªå¤šè·¯é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬ä½¿ç”¨HSEè€Œä¸æ˜¯HSIä½œä¸ºPLLçš„æ—¶é’Ÿæ¥æºï¼ˆHSEåœ¨ç²¾åº¦å’Œç¨³å®šæ€§ä¸Šè¦æ¯”HSIå¥½å¾ˆå¤šï¼‰ã€‚</p>
<p>æ¥ç€ç»è¿‡äº†PLLMulï¼Œå³é”ç›¸ç¯å€é¢‘ï¼ˆPLL Multiplyï¼‰ï¼Œå°†HSEçš„é¢‘ç‡æ”¾å¤§äº†9å€å¾—åˆ°PLLCLKï¼ˆ8M * 9 = 72Mï¼‰ï¼Œå¹¶è¿æ¥åˆ°äº†System Clock Muxï¼ˆå³ç³»ç»Ÿæ—¶é’Ÿå¤šè·¯é€‰æ‹©å™¨ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å½“ç„¶é€‰æ‹©ç¨³å®šã€é«˜ç²¾åº¦ã€é«˜é¢‘çš„PLLCLKä½œä¸ºç³»ç»Ÿæ—¶é’Ÿã€‚</p>
<h1 id="er-shi-zhong-chu-shi-hua-guo-cheng-yuan-ma-fen-xi-spl-ku">äºŒã€æ—¶é’Ÿåˆå§‹åŒ–è¿‡ç¨‹æºç åˆ†æï¼ˆSPLåº“ï¼‰</h1>
<h2 id="shang-dian-fu-wei-hou-hui-fa-sheng-shi-yao">ä¸Šç”µ/å¤ä½åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h2>
<p>MCUå¯åŠ¨çš„æ±‡ç¼–æ–‡ä»¶ <code>startup.s</code>ä¼šè¢«æ‰§è¡Œï¼š</p>
<p><code>startup_stm32f10x_hd.s</code></p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">Reset_Handler   PROC
                EXPORT  Reset_Handler             [WEAK]
                IMPORT  __main
                IMPORT  SystemInit
                LDR     R0, =SystemInit
                BLX     R0               
                LDR     R0, =__main
                BX      R0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ‰§è¡ŒSystemInitå‡½æ•°</mark></p>
<p>å°† <code>SystemInit</code> å‡½æ•°çš„å…¥å£åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨R0ï¼Œé€šè¿‡ <code>BLX</code>è·³è½¬åˆ°å…¶å¯¹åº”çš„ä»£ç æ®µæ‰§è¡Œè¯¥å‡½æ•°ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†ç³»ç»Ÿæ—¶é’Ÿçš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p>
<p><mark>æ‰§è¡Œmainå‡½æ•°</mark></p>
<p>å°† <code>main</code> å‡½æ•°çš„å…¥å£åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨R0ï¼Œé€šè¿‡ <code>BX</code>è·³è½¬åˆ°å…¶å¯¹åº”çš„ä»£ç æ®µæ‰§è¡Œè¯¥å‡½æ•°ï¼Œæ‰§è¡Œç”¨æˆ·ä»£ç ã€‚</p>
<blockquote>
<p>è¯¥åˆå§‹åŒ–é¡ºåºéµå¾ªARMçš„CMSISï¼ˆCortex Microcontroller Software Interface Standardï¼‰æ ‡å‡†</p>
</blockquote>
<h2 id="system-init">SystemInit</h2>
<p><a href="https://www.st.com/resource/en/reference_manual/rm0008-stm32f101xx-stm32f102xx-stm32f103xx-stm32f105xx-and-stm32f107xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">STM32F107å‚è€ƒæ‰‹å†Œ</a></p>
<h3 id="qi-yong-hsi-xian-rang-mcu-you-xin-tiao">å¯ç”¨HSIï¼Œå…ˆè®©MCUæœ‰å¿ƒè·³</h3>
<p>åœ¨<code>system_stm32f10x.c</code>ä¸­æ‰¾åˆ° <code>SystemInit</code>å‡½æ•°ï¼Œæ¡ä»¶ç¼–è¯‘æ˜¾ç¤ºç°è‰²çš„éƒ¨åˆ†å¯ä»¥å¿½ç•¥</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set HSION bit */</span>
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000001</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å…ˆå¼€å¯HSIé«˜é€Ÿå†…éƒ¨æ—¶é’Ÿï¼ˆæ—¶é’Ÿç›¸å½“äºMCUå¿ƒè·³ï¼Œå…ˆè®©MCUæœ‰å¿ƒè·³èƒ½å¤Ÿå·¥ä½œï¼Œåé¢å†å°†æ—¶é’Ÿæºé€šè¿‡å¤šè·¯é€‰æ‹©å™¨åˆ‡æ¢ä¸ºæˆ‘ä»¬é…ç½®çš„HSEï¼‰ï¼Œå°†å¯„å­˜å™¨çš„ç¬¬0ä½è®¾ç½®ä¸º1ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123165840693.png" alt="image-20241123165840693"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123165911410.png" alt="image-20241123165911410"></p>
<h3 id="fu-wei-shi-zhong-xiang-guan-ji-cun-qi-bi-te-wei">å¤ä½æ—¶é’Ÿç›¸å…³å¯„å­˜å™¨æ¯”ç‰¹ä½</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Reset SW, HPRE, PPRE1, PPRE2, ADCPRE and MCO bits */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xF8FF0000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è¯¥æ“ä½œä¼šå°†CFGRï¼ˆæ—¶é’Ÿé…ç½®ï¼‰å¯„å­˜å™¨å¦‚ä¸‹æ¯”ç‰¹ä½æ¸…é›¶ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123170556835.png" alt="image-20241123170556835"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123170704055.png" alt="image-20241123170704055"></p>
<p>é€‰æ‹©HSIï¼ˆä¸Šä¸€æ­¥å·²ç»å¼€å¯äº†ï¼‰ä½œä¸ºç³»ç»Ÿæ—¶é’Ÿï¼Œå…¶ä»–çš„ï¼ˆHPRE, PPRE1, PPRE2, ADCPRE and MCOï¼‰åˆ†æè¿‡ç¨‹ç±»ä¼¼ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Reset HSEON, CSSON and PLLON bits */</span>
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFEF6FFFF</span><span class="token punctuation">;</span>

<span class="token comment">/* Reset HSEBYP bit */</span>
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFFFBFFFF</span><span class="token punctuation">;</span>

<span class="token comment">/* Reset PLLSRC, PLLXTPRE, PLLMUL and USBPRE/OTGFSPRE bits */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFF80FFFF</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åŒæ ·çš„ï¼Œä¹Ÿæ˜¯å°†ä¸€äº›ä½æ¸…é›¶ï¼Œå°†ç³»ç»Ÿæ—¶é’Ÿåˆå§‹åŒ–ä¸ºä»…ç”±HSIä½œä¸ºæ—¶é’Ÿæºçš„åˆå§‹çŠ¶æ€</p>
<h3 id="set-sys-clock-she-zhi-xi-tong-shi-zhong">SetSysClockè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Enable HSE */</span>    
RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CR_HSEON<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">/* Wait till HSE is ready and if Time out is reached exit */</span>
<span class="token keyword">do</span>
<span class="token punctuation">{</span>
  HSEStatus <span class="token operator">=</span> RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_HSERDY<span class="token punctuation">;</span>
  StartUpCounter<span class="token operator">++</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HSEStatus <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>StartUpCounter <span class="token operator">!=</span> HSE_STARTUP_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œå¼€å¯äº†HSEå¤–éƒ¨é«˜é€Ÿæ—¶é’Ÿï¼Œå¹¶ç­‰å¾…HSEçš„çŠ¶æ€è½¬å˜ä¸ºREADYï¼ˆç”±ç¡¬ä»¶ç½®ä½ï¼‰ã€‚</p>
<h3 id="xi-tong-shi-zhong-shu">ç³»ç»Ÿæ—¶é’Ÿæ ‘</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* HCLK = SYSCLK */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_HPRE_DIV1<span class="token punctuation">;</span>
  
<span class="token comment">/* PCLK2 = HCLK */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_PPRE2_DIV1<span class="token punctuation">;</span>

<span class="token comment">/* PCLK1 = HCLK */</span>
RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_PPRE1_DIV2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°†ç³»ç»Ÿæ—¶é’Ÿä½œä¸ºAHBå’ŒAPB2çš„æ—¶é’Ÿæºï¼ˆå¯¹åº”HCLKå’ŒPCLK2ï¼‰ï¼Œå°†ç³»ç»Ÿæ—¶é’Ÿ2åˆ†é¢‘ï¼Œä½œä¸ºAPB1çš„æ—¶é’Ÿæºï¼ˆå¯¹åº”PCLK2ï¼‰ã€‚</p>
<blockquote>
<p>AHBæŒ‚è½½äº†Cortexæ ¸ã€DMAç­‰ä¸»åŠ¨å•å…ƒ</p>
<p>APB2æŒ‚è½½äº†GPIOã€USRAT1ã€ADCç­‰éœ€è¦é«˜é€Ÿç‡æ—¶é’Ÿçš„å•å…ƒ</p>
<p>APB1åˆ™æŒ‚è½½äº†TIMERã€I2Cç­‰ä¸éœ€è¦é‚£ä¹ˆé«˜é¢‘çš„å•å…ƒ</p>
</blockquote>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241123172121666.png" alt="image-20241123172121666" style="zoom: 50%;">
<h3 id="pll-bei-pin">PLLå€é¢‘</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*  PLL configuration: PLLCLK = HSE * 9 = 72 MHz */</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span>RCC_CFGR_PLLSRC <span class="token operator">|</span> RCC_CFGR_PLLXTPRE <span class="token operator">|</span>
                                        RCC_CFGR_PLLMULL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>RCC_CFGR_PLLSRC_HSE <span class="token operator">|</span> RCC_CFGR_PLLMULL9<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å°†PLLæ—¶é’Ÿæ¥æºRCC_CFGR_PLLSRCã€HSEè¿›å…¥PLLåçš„åˆ†é¢‘RCC_CFGR_PLLXTPREã€PLLå€é¢‘ç³»æ•°RCC_CFGR_PLLMULLæ¸…é›¶ï¼›</li>
<li>é€‰æ‹©PLLæ—¶é’Ÿæ¥æºä¸ºHSEï¼ˆRCC_CFGR_PLLSRC_HSEï¼‰ï¼Œå€é¢‘ç³»æ•°ä¸º9ï¼ˆRCC_CFGR_PLLMULL9ï¼‰</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Enable PLL */</span>
    RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> RCC_CR_PLLON<span class="token punctuation">;</span>

    <span class="token comment">/* Wait till PLL is ready */</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯åŠ¨PLLé”ç›¸ç¯ï¼Œå¹¶ç­‰å¾…å®ƒç¨³å®šã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Select PLL as system clock source */</span>
   RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span>RCC_CFGR_SW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_SW_PLL<span class="token punctuation">;</span>    

   <span class="token comment">/* Wait till PLL is used as system clock source */</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_SWS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x08</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡ç³»ç»Ÿæ—¶é’Ÿçš„å¤šè·¯é€‰æ‹©å™¨å°†PLLé€‰æ‹©ä¸ºç³»ç»Ÿæ—¶é’Ÿæºï¼Œå¹¶ç­‰å¾…æ­¤åˆ‡æ¢å®Œæˆã€‚</p>
]]></content>
      <categories>
        <category>STM32</category>
        <category>æºç åˆ†æ</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>SPL</tag>
        <tag>STM32F103ZE</tag>
        <tag>æ—¶é’Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>UARTæ¥æ”¶ç¼“å†²åŒºæº¢å‡ºå¼‚å¸¸ï¼ˆHAL_UART_ERROR_OREï¼‰é—®é¢˜è®°å½•</title>
    <url>/2024/11/12/13750.html</url>
    <content><![CDATA[<h1 id="wen-ti-bei-jing">é—®é¢˜èƒŒæ™¯</h1>
<h2 id="kai-fa-huan-jing">å¼€å‘ç¯å¢ƒ</h2>
<ul>
<li>ç¡¬ä»¶ï¼šGD32F407VET6å¼€å‘ç‰ˆ</li>
<li>IDEï¼šSTM32CubeMX + Clion + ARM GNU</li>
<li>çƒ§å½•ï¼šOpenOCD</li>
</ul>
<h2 id="shi-yan-mu-biao">å®éªŒç›®æ ‡</h2>
<p>ä½¿ç”¨Cubeé…ç½®ä¸²å£USART1åŠå…¶ä¸­æ–­ï¼Œå¼•è„šå¤ç”¨PA9/PA10ï¼Œé€šè¿‡ä½¿èƒ½æ¥æ”¶ä¸­æ–­ <code>Receive_IT</code>ï¼Œå®ç°æ¥æ”¶7å­—èŠ‚æ—¶ï¼Œåœ¨ä¸­æ–­å›è°ƒä¸­å¤„ç†è¯¥7ä¸ªå­—èŠ‚æ•°æ®ï¼ˆç®€å•å›ä¼ ï¼Œå³echoï¼‰ï¼Œå¹¶å†æ¬¡å¼€å¯æ¥æ”¶ä¸­æ–­ï¼Œä»è€Œå®ç°ä¸æ–­æ¥æ”¶7å­—èŠ‚ã€å›ä¼ 7å­—èŠ‚çš„åŠŸèƒ½ã€‚</p>
<h2 id="yu-dao-wen-ti">é‡åˆ°é—®é¢˜</h2>
<p>å‘é€å­—èŠ‚æ•°ä¸º7æ—¶ï¼Œèƒ½å¤Ÿæ­£å¸¸echoï¼›ä½†æ˜¯ä¸ä¸º7æ—¶ï¼Œæœ¬æ¥æœŸæœ›æ˜¯å•æ¬¡å‘é€å­—èŠ‚æ•°ï¼š</p>
<ul>
<li>å¤§äº7å­—èŠ‚æ—¶ï¼Œåº”è¯¥ä¹Ÿèƒ½æ¯æ¬¡è§¦å‘ä¸­æ–­ï¼Œåªæ˜¯å¤šä½™çš„å­—èŠ‚æ•°è¢«ä¸¢å¼ƒäº†è€Œå·²</li>
<li>å°‘äº7å­—èŠ‚æ—¶ï¼ˆä¾‹å¦‚5ï¼‰ï¼Œåˆ™é€šè¿‡å†æ¬¡å‘é€ä¹Ÿèƒ½è§¦å‘ä¸­æ–­</li>
</ul>
<p>ä½†å®éªŒè¿‡ç¨‹ä¸­å‘ç°è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä¼šå‘é€echoäº†ä¸€ä¸¤æ¬¡ä¹‹åï¼Œåé¢æ— è®ºå‘é€å¤šå°‘æ•°æ®éƒ½æ— æ³•å†echoçš„æƒ…å†µ</p>
<h1 id="qing-jing-zai-xian">æƒ…æ™¯å†ç°</h1>
<h2 id="cube-pei-zhi">Cubeé…ç½®</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212649840.png" alt="image-20241112212649840"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212742297.png" alt="image-20241112212742297"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212813159.png" alt="image-20241112212813159"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212840656.png" alt="image-20241112212840656"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212935188.png" alt="image-20241112212935188"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112212959621.png" alt="image-20241112212959621"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213059038.png" alt="image-20241112213059038"></p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213254243.png" alt="image-20241112213254243"></p>
<h2 id="dao-ru-clion">å¯¼å…¥Clion</h2>
<h3 id="bian-yi-pei-zhi-jiao-cha-bian-yi">ç¼–è¯‘é…ç½®-äº¤å‰ç¼–è¯‘</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213601046.png" alt="image-20241112213601046"></p>
<h3 id="cmake-pei-zhi">Cmakeé…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213656961.png" alt="image-20241112213656961"></p>
<h3 id="open-ocd-shao-lu-pei-zhi">OpenOCDçƒ§å½•é…ç½®</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241112213740944.png" alt="image-20241112213740944"></p>
<p><code>daplink.cfg</code>ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none"># choose st-link/j-link/dap-link etc.
adapter driver cmsis-dap
transport select swd

# 0x10000 = 64K Flash Size
# set FLASH_SIZE 0x20000

# 512KB Flash
set FLASH_SIZE 0x80000

source [find target/stm32f4x.cfg]

# download speed = 10MHz
# adapter speed 10000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="dai-ma-liu-cheng">ä»£ç æµç¨‹</h2>
<ul>
<li>ä¸Šç”µåå¯ç”¨æ¥æ”¶ä¸­æ–­</li>
<li>åœ¨æ¥æ”¶å®Œæ¯•å›è°ƒä¸­echoï¼Œå¹¶å†æ¬¡å¯ç”¨æ¥æ”¶ä¸­æ–­</li>
</ul>
<p><code>main.c</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token class-name">uint8_t</span> rxbuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">/* USER CODE BEGIN 1 */</span>
    <span class="token function">__HAL_RCC_HSI_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__HAL_RCC_SYSCLK_CONFIG</span><span class="token punctuation">(</span>RCC_SYSCLKSOURCE_HSI<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END 1 */</span>

    <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

    <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* USER CODE BEGIN Init */</span>

    <span class="token comment">/* USER CODE END Init */</span>

    <span class="token comment">/* Configure the system clock */</span>
    <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* USER CODE BEGIN SysInit */</span>

    <span class="token comment">/* USER CODE END SysInit */</span>

    <span class="token comment">/* Initialize all configured peripherals */</span>
    <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* USER CODE END 2 */</span>

    <span class="token comment">/* Infinite loop */</span>
    <span class="token comment">/* USER CODE BEGIN WHILE */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//        HAL_UART_Transmit_IT(&amp;huart1, (uint8_t *)"Hello, World!\r\n", 14);</span>
        <span class="token comment">//        HAL_Delay(1000);</span>
        <span class="token comment">/* USER CODE END WHILE */</span>

        <span class="token comment">/* USER CODE BEGIN 3 */</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="yuan-ma-fen-xi">æºç åˆ†æ</h1>
<h2 id="qi-yong-jie-shou-zhong-duan-hal-uart-receive-it">å¯ç”¨æ¥æ”¶ä¸­æ–­HAL_UART_Receive_IT</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> rxbuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>HAL_UART_Receive_IT -&gt; UART_Start_Receive_IT</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">huart<span class="token operator">-&gt;</span>pRxBuffPtr <span class="token operator">=</span> pData<span class="token punctuation">;</span>
huart<span class="token operator">-&gt;</span>RxXferSize <span class="token operator">=</span> Size<span class="token punctuation">;</span>
huart<span class="token operator">-&gt;</span>RxXferCount <span class="token operator">=</span> Size<span class="token punctuation">;</span>

huart<span class="token operator">-&gt;</span>ErrorCode <span class="token operator">=</span> HAL_UART_ERROR_NONE<span class="token punctuation">;</span>
huart<span class="token operator">-&gt;</span>RxState <span class="token operator">=</span> HAL_UART_STATE_BUSY_RX<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
<span class="token comment">/* Enable the UART Error Interrupt: (Frame error, noise error, overrun error) */</span>
<span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_ERR<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Enable the UART Data Register not empty Interrupt */</span>
<span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>pRxBuffPtr</code> ï¼š<strong>ä¿å­˜æˆ‘ä»¬ä¼ å…¥çš„bufæŒ‡é’ˆ</strong></li>
<li><code>RxXferSize</code> ï¼š<strong>ä¿å­˜æˆ‘ä»¬ä¼ å…¥çš„bufå¤§å°</strong></li>
<li><code>RxXferCount</code>ï¼š <strong>åˆå§‹åŒ–å¾…æ¥æ”¶æ•°æ®æ•°é‡</strong></li>
<li><code>ErrorCode</code>ï¼šåˆå§‹åŒ–é”™è¯¯ç ä¸º no error</li>
<li><code>RxState</code>ï¼š<strong>æ ‡è¯†UARTå¤„äºæ¥æ”¶çŠ¶æ€ï¼ˆData Reception process is ongoingï¼‰</strong></li>
<li>å¼€å¯UARTå¼‚å¸¸ä¸­æ–­
<ul>
<li>å¸§å¼‚å¸¸ï¼ˆFrame errorï¼‰</li>
<li>å™ªå£°å¼‚å¸¸ï¼ˆnoise errorï¼‰</li>
<li><em><strong>æ¥æ”¶ç¼“å†²åŒºæº¢å‡ºå¼‚å¸¸ï¼ˆoverrun errorï¼‰</strong></em></li>
</ul>
</li>
<li>å¼€å¯æ¥æ”¶å¯„å­˜å™¨éç©ºä¸­æ–­ï¼ˆEnable the UART Data Register not empty Interruptï¼‰</li>
</ul>
<h2 id="uart-zhong-duan-xiang-liang-biao">UARTä¸­æ–­å‘é‡è¡¨</h2>
<p><em><strong>startup_stm32f407vetx.s</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>word     USART1_IRQHandler                 <span class="token comment">/* USART1                       */</span>       <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em><strong>stm32f4xx_it.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 0 */</span>

  <span class="token comment">/* USER CODE END USART1_IRQn 0 */</span>
  <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 1 */</span>

  <span class="token comment">/* USER CODE END USART1_IRQn 1 */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="shu-ju-jie-shou-chu-li">æ•°æ®æ¥æ”¶å¤„ç†</h2>
<p><em><strong>stm32f4xx_it.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* If no error occurs */</span>
    errorflags <span class="token operator">=</span> <span class="token punctuation">(</span>isrflags <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>USART_SR_PE <span class="token operator">|</span> USART_SR_FE <span class="token operator">|</span> USART_SR_ORE <span class="token operator">|</span> USART_SR_NE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorflags <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* UART in mode Receiver -------------------------------------------------*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isrflags <span class="token operator">&amp;</span> USART_SR_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr1its <span class="token operator">&amp;</span> USART_CR1_RXNEIE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">UART_Receive_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰§è¡Œæ¥æ”¶æ•°æ®é€»è¾‘ï¼ˆUART_Receive_ITï¼‰çš„å‰ç½®æ¡ä»¶ï¼š</p>
<ul>
<li>æ²¡æœ‰UARTç›¸å…³çš„å¼‚å¸¸ï¼ˆerrorflagsï¼‰</li>
<li>æ¥æ”¶å¯„å­˜å™¨éç©ºï¼ˆUSART_SR_RXNEï¼‰</li>
<li>æ¥æ”¶å¯„å­˜å™¨éç©ºä¸­æ–­ä½¿èƒ½æ˜¯å¼€å¯çš„ï¼ˆUSART_CR1_RXNEIEï¼‰</li>
</ul>
<h2 id="zhu-zi-jie-shou-shu-ju-data-register">é€å­—æ¥æ”¶æ•°æ®ï¼ˆData Registerï¼‰</h2>
<p><em><strong>stm32f4xx_hal_uart.c/UART_Receive_IT</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check that a Rx process is ongoing */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>RxState <span class="token operator">==</span> HAL_UART_STATE_BUSY_RX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">*</span>pdata8bits <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">-&gt;</span>DR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	huart<span class="token operator">-&gt;</span>pRxBuffPtr <span class="token operator">+=</span> <span class="token number">1U</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>huart<span class="token operator">-&gt;</span>RxXferCount <span class="token operator">==</span> <span class="token number">0U</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*Call legacy weak Rx complete callback*/</span>
		<span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>åˆ¤æ–­UARTæ˜¯ä¸æ˜¯å¤„äºæ¥æ”¶è¿›ç¨‹ä¸­
<ul>
<li>æˆ‘ä»¬ä¹‹å‰è°ƒç”¨è¿‡ <code>HAL_UART_Receive_IT</code>ï¼Œé‡Œé¢ä¼šç½®ä½è¿™ä¸ªçŠ¶æ€ <code>huart-&gt;RxState = HAL_UART_STATE_BUSY_RX</code></li>
</ul>
</li>
<li>ä»DRï¼ˆUARTæ•°æ®å¯„å­˜å™¨ï¼‰ä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚åˆ°ç”¨æˆ·è‡ªå®šä¹‰ç¼“å†²åŒºä¸­ï¼ˆæˆ‘ä»¬è°ƒç”¨ <code>HAL_UART_Receive_IT</code> æ—¶ä¼ å…¥è¿‡ä¸€ä¸ª7å­—èŠ‚çš„<code>buf</code>ï¼‰</li>
<li>é€’å‡å‰©ä½™å¾…æ¥æ”¶æ•°æ®æ•°é‡ <code>huart-&gt;RxXferCount</code>ï¼ˆä¹‹å‰è¢«åˆå§‹åŒ–ä¸º7ï¼‰
<ul>
<li>å¦‚æœé€’å‡ä¸º0ï¼Œåˆ™è¯´æ˜æ¥æ”¶çš„å­—èŠ‚æ•°å¡«æ»¡äº†ç”¨æˆ·æŒ‡å®šç¼“å†²åŒºå¤§å°</li>
<li>ç„¶åè°ƒç”¨ <code>HAL_UART_RxCpltCallback</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>weak</code>å‡½æ•°ï¼ˆé»˜è®¤æ˜¯ä¸€ä¸ªç©ºå®ç°ï¼‰ï¼Œç”¨æˆ·å¯ä»¥å£°æ˜ä¸€ä¸ªå¯¹åº”çš„é <code>weak</code>ç‰ˆä»¥å®ç°å›è°ƒå¤„ç†ã€‚è¿™ä¸ªç†å¿µæ˜¯ç»å…¸çš„<strong>hooké’©å­å‡½æ•°</strong>ã€‚</li>
</ul>
</li>
</ul>
<h2 id="zhong-xie-huan-chong-qu-jie-shou-wan-bi-hui-diao">é‡å†™ç¼“å†²åŒºæ¥æ”¶å®Œæ¯•å›è°ƒ</h2>
<p>åŸå‹ï¼š</p>
<p><em><strong>stm32f4xx_hal_uart.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__weak <span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Prevent unused argument(s) compilation warning */</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* NOTE: This function should not be modified, when the callback is needed,
             the HAL_UART_RxCpltCallback could be implemented in the user file
     */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‡å†™ï¼š</p>
<p><em><strong>main.c</strong></em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token class-name">uint8_t</span> rxbuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> rxbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* USER CODE END 0 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å°†ç¼“å†²åŒº7å­—èŠ‚æ•°æ®é€šè¿‡UART TXå‘é€ï¼Œé‡‡ç”¨è½®è¯¢æ–¹å¼ï¼ˆæ¯å‘ä¸€ä¸ªå­—èŠ‚è½®è¯¢å‘é€çŠ¶æ€ï¼‰ï¼Œè¶…æ—¶æ—¶é—´100ms</li>
<li>é‡æ–°å¼€å¯æ¥æ”¶ä¸­æ–­ï¼Œä»¥å®ç°ä¸‹ä¸€æ¬¡çš„echo</li>
</ul>
<h2 id="ding-chang-7-zi-jie-echo-ce-shi">å®šé•¿7å­—èŠ‚echoæµ‹è¯•</h2>
<p>è‡³æ­¤ï¼Œå®šé•¿7å­—èŠ‚æ•°æ®echoåŠŸèƒ½å°±å®ç°äº†</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241113084959956.png" alt="image-20241113084959956"></p>
<h2 id="chao-7-zi-jie-echo-ce-shi">è¶…7å­—èŠ‚echoæµ‹è¯•</h2>
<p><img src="C:/Users/86157/AppData/Roaming/Typora/typora-user-images/image-20241113085040298.png" alt="image-20241113085040298"></p>
<p>ä¸ºä»€ä¹ˆè¶…è¿‡æˆ‘ä»¬æŒ‡å®šçš„ç¼“å†²åŒºå¤§å°ï¼ˆ<code>HAL_UART_Transmit</code>çš„å…¥å‚ <code>Size</code>ï¼‰åï¼ŒåŠŸèƒ½å°±ä¸æ•´è¡Œäº†å‘¢ï¼Ÿ</p>
<h2 id="uart-zhong-duan-isr-yi-chang-liu-cheng">UARTä¸­æ–­ISR-å¼‚å¸¸æµç¨‹</h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* If no error occurs */</span>
    errorflags <span class="token operator">=</span> <span class="token punctuation">(</span>isrflags <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>USART_SR_PE <span class="token operator">|</span> USART_SR_FE <span class="token operator">|</span> USART_SR_ORE <span class="token operator">|</span> USART_SR_NE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorflags <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">UART_Receive_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token comment">/* If some errors occur */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>errorflags <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cr3its <span class="token operator">&amp;</span> USART_CR3_EIE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
                                  <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cr1its <span class="token operator">&amp;</span> <span class="token punctuation">(</span>USART_CR1_RXNEIE <span class="token operator">|</span> USART_CR1_PEIE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* UART Over-Run interrupt occurred
         huart-&gt;ErrorCode |= HAL_UART_ERROR_ORE;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æ²¡æœ‰å¼‚å¸¸æ—¶ï¼Œä¼šæ‰§è¡Œ <code>UART_Receive_IT</code>é€å­—æ¥æ”¶æ•°æ®å¹¶åœ¨å¡«æ»¡ç¼“å†²åŒºåè§¦å‘æ¥æ”¶å®Œæ¯•å›è°ƒ <code>HAL_UART_RxCpltCallback</code></li>
<li>ä½†æ˜¯å½“æˆ‘ä»¬å‘é€8å­—èŠ‚æ—¶ï¼Œä¼šè§¦å‘UARTçš„æ¥æ”¶æº¢å‡ºé”™è¯¯ï¼Œç»§è€Œè½¬å‘å¼‚å¸¸å¤„ç†æµç¨‹</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* Call UART Error Call back function if need be --------------------------*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>ErrorCode <span class="token operator">!=</span> HAL_UART_ERROR_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">/*Call legacy weak error callback*/</span>
    <span class="token function">HAL_UART_ErrorCallback</span><span class="token punctuation">(</span>huart<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å› ä¸ºå¼‚å¸¸å¤„ç†æµç¨‹ä¸ä¼šæ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>HAL_UART_RxCpltCallback</code>ï¼Œä¹Ÿå°±æ²¡æœ‰é‡æ–°å¼€å¯æ¥æ”¶ä¸­æ–­ <code>HAL_UART_RxCpltCallback</code>ï¼Œæ‰€ä»¥å°±å‡ºç°äº†å‘é€8å­—èŠ‚æ—¶ï¼Œåç»­æ²¡æœ‰å›ä¼ çš„ç°è±¡ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241113085040298.png" alt="image-20241113085040298"></p>
<h1 id="si-kao-yi-liu-wen-ti">æ€è€ƒ/é—ç•™é—®é¢˜</h1>
<h2 id="usart-sr-ore-shi-ru-he-bei-she-zhi-de">USART_SR_OREæ˜¯å¦‚ä½•è¢«è®¾ç½®çš„</h2>
<p>ä¸ºä»€ä¹ˆå‘é€8å­—èŠ‚æ—¶ä¼šè§¦å‘USART_SR_OREé”™è¯¯ï¼Ÿ</p>
]]></content>
      <categories>
        <category>STM32</category>
        <category>è¸©å‘è®°å½•</category>
      </categories>
      <tags>
        <tag>STM32</tag>
        <tag>Clion</tag>
        <tag>GD32</tag>
        <tag>HAL</tag>
        <tag>UART</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£I2Cæ—¶åºï¼ˆä»¥I2Cå®æ—¶æ—¶é’ŸPCF8563ä¸ºæ¡ˆä¾‹ï¼‰</title>
    <url>/2024/11/16/31289.html</url>
    <content><![CDATA[<h1 id="yi-qian-yan">ä¸€ã€å‰è¨€</h1>
<h2 id="ying-jian-bei-jing">ç¡¬ä»¶èƒŒæ™¯</h2>
<ul>
<li>GD32F407VET6</li>
<li>I2Cå®æ—¶æ—¶é’ŸPCF8563</li>
</ul>
<h2 id="yuan-li-tu">åŸç†å›¾</h2>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116194724707.png" alt="image-20241116194724707" style="zoom: 33%;">
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116194750339.png" alt="image-20241116194750339" style="zoom:33%;">
<h2 id="wen-dang-zi-liao">æ–‡æ¡£èµ„æ–™</h2>
<ul>
<li><a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a></li>
<li><a href="https://atta.szlcsc.com/upload/public/pdf/source/20230921/9DB04F89E1E4336DD7CCB7C268B77442.pdf">I 2 C å®æ—¶æ—¶é’Ÿ/æ—¥å†èŠ¯ç‰‡ PCF8563</a></li>
</ul>
<h1 id="er-en-zhi-pu-nxp-i-2-c-zong-xian-xie-yi-shi-xu-jie-xi">äºŒã€æ©æ™ºæµ¦ï¼ˆNXPï¼‰I2Cæ€»çº¿åè®®æ—¶åºè§£æ</h1>
<blockquote>
<p>å‚è§<a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a>ä¸­çš„</p>
<p>**6 Electrical specifications and timing for I/O stages and bus lines  **</p>
<p>**Table 11.â€‡Characteristics of the SDA and SCL bus lines for Standard, Fast, and Fast-mode Plus I2C-bus devices **</p>
</blockquote>
<h2 id="overview">Overview</h2>
<h3 id="sda-scl-zong-xian-te-xing">SDA/SCLæ€»çº¿ç‰¹æ€§</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116195121046.png" alt="image-20241116195121046"></p>
<h3 id="shi-xu-ding-yi">æ—¶åºå®šä¹‰</h3>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116202433638.png" alt="image-20241116202433638"></p>
<h2 id="i-2-c-chuan-shu-kong-zhi">I2Cä¼ è¾“æ§åˆ¶</h2>
<p>I2Cè§„å®šå•æ¬¡é€šä¿¡éœ€è¦éµå¾ªå¦‚ä¸‹ä¸¤ä¸ªæ§åˆ¶</p>
<h3 id="shu-ju-chuan-shu-kong-zhi">æ•°æ®ä¼ è¾“æ§åˆ¶</h3>
<p><mark>åœ¨SCLä¸ºä½æ—¶å¯ä»¥ä¿®æ”¹SDAï¼›SCLä¸ºé«˜æ—¶ï¼ŒSDAåº”è¯¥ä¿æŒä¸å˜ã€‚</mark></p>
<p>åœ¨SCLä¸ºä½ç”µå¹³æ—¶ï¼Œå‡†å¤‡SDAï¼ˆå‘é€æ–¹ï¼‰ï¼›åœ¨SCLä¸ºé«˜æ—¶ï¼Œä¿æŒSDAï¼ˆåœ¨æ­¤æœŸé—´æ¥é€æ–¹ä¼šè¯»å–SDAï¼‰ã€‚</p>
<p>è¿™ä¸€ç‚¹åœ¨<a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a>ä¸­çš„ <strong>3.1.3 Data validity</strong>è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>The data on the SDA line must be stable during the HIGH period of the clock. The HIGH or LOW state of the data line can only change when the clock signal on the SCL line is LOW (see Figure 4). One clock pulse is generated for each data bit transferred.</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116214251742.png" alt="image-20241116214251742"></p>
<h2 id="qi-shi-zhong-zhi-kong-zhi">èµ·å§‹/ç»ˆæ­¢æ§åˆ¶</h2>
<p>åœ¨SCLä¸ºé«˜æ—¶ï¼Œæ‹‰ä½SDAï¼ˆéœ€è¦æå‰å‡†å¤‡å¥½SDAä¸ºé«˜ï¼‰ï¼›åœ¨SCLä¸ºä½æ—¶ï¼Œæ‹‰é«˜SDAï¼ˆéœ€è¦æå‰å‡†å¤‡å¥½SDAä¸ºä½ï¼‰ã€‚</p>
<p><mark>å¯ä»¥å‘ç°ä¸ºäº†åŒºåˆ†æ•°æ®ä¼ è¾“æ§åˆ¶ï¼Œç‰¹æ„åœ¨SCLä¸ºé«˜æ—¶æ“ä½œSDAã€‚</mark></p>
<p>è¿™ä¸€ç‚¹åœ¨<a href="https://www.nxp.com/docs/en/user-guide/UM10204.pdf">NXPï¼ˆæ©æ™ºæµ¦ï¼‰I2Cæ€»çº¿åè®®è¯´æ˜ä¹¦å’Œç”¨æˆ·æ‰‹å†Œ</a>ä¸­çš„ <strong>3.1.4 START and STOP conditions</strong> è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>All transactions begin with a START (S) and are terminated by a STOP (P) (see Figure 5). A HIGH to LOW transition on the SDA line while SCL is HIGH defines a START condition. A LOW to HIGH transition on the SDA line while SCL is HIGH defines a STOP condition.</p>
</blockquote>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116214423843.png" alt="image-20241116214423843"></p>
<h2 id="f-sub-scl-sub-shi-zhong-xian-pin-lu-frequency-for-scl">f<sub>SCL</sub>æ—¶é’Ÿçº¿é¢‘ç‡ï¼ˆfrequency for SCLï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116201656138.png" alt="image-20241116201656138"></p>
<p>è¯¥å‚æ•°è§„å®šäº†I2Cçš„SCLæ—¶é’Ÿçº¿çš„é¢‘ç‡ï¼Œä»¥Fast-modeä¸ºä¾‹ï¼Œæœ€å¤§ä¸º400kHzã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åœ¨æ“ä½œSCLæ—¶ï¼Œå°†SCLç½®0çš„æ—¶é—´+éšåå°†SCLç½®1çš„æ—¶é—´ä¹‹å’Œä¸èƒ½å°äº 1/400kHz = 2.5usï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116201725124.png" alt="image-20241116201725124"></p>
<h2 id="t-sub-hd-sta-sub-qi-shi-xin-hao-bao-chi-shi-jian-hol-d-time-for-start-condition">t<sub>HD;STA</sub>èµ·å§‹ä¿¡å·ä¿æŒæ—¶é—´ï¼ˆHolD time for START conditionï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116202607065.png" alt="image-20241116202607065"></p>
<p>è¯¥å‚æ•°è§„å®šäº†èµ·å§‹ä¿¡å·ï¼ˆSTART conditionï¼‰éœ€è¦ä¿æŒçš„æ—¶é—´ï¼ˆåœ¨SCLä¸ºé«˜ç”µå¹³æ—¶ï¼Œå°†SDAç”±é«˜æ‹‰ä½åéœ€è¦ä¿æŒçš„æ—¶é—´ï¼‰</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116202932000.png" alt="image-20241116202932000" style="zoom: 50%;">
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116204002371.png" alt="image-20241116204002371"></p>
<ol>
<li>hold time (<mark>repeated</mark>) START conditionï¼š<mark>repeated</mark>è¡¨æ˜ç¬¬ä¸€ä¸ªèµ·å§‹ä¿¡å·åçš„é‡å¤èµ·å§‹ä¿¡å·éƒ½éœ€è¦éµå¾ªè¿™ä¸ªè§„åˆ™ï¼Œä¾‹å¦‚åœ¨<a href="https://atta.szlcsc.com/upload/public/pdf/source/20230921/9DB04F89E1E4336DD7CCB7C268B77442.pdf">PCF8563</a>ä¸­æåˆ°çš„ <mark>å†™åœ°å€ï¼Œè¯»æ•°æ®</mark>æ¨¡å¼ä¸­ï¼Œåœ¨ç¬¬ä¸€ä¸ªSï¼ˆèµ·å§‹ä¿¡å·ï¼‰ä¹‹åæœ‰ä¸€ä¸ª <mark>dummy&nbsp;write</mark>ï¼ˆæŒ‡å®šåé¢è¿ç»­è¯»çš„èµ·å§‹å¯„å­˜å™¨åœ°å€ï¼‰ï¼Œç„¶ååˆæœ‰ä¸€ä¸ªSï¼Œç´§æ¥ç€æ‰æ˜¯çœŸæ­£çš„è¿ç»­è¯»æ•°æ®ã€‚è¿™é‡Œç¬¬äºŒä¸ªSå°±å±äº <mark>repeated&nbsp;START&nbsp;condition</mark>ã€‚</li>
</ol>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116203555124.png" alt="image-20241116203555124" style="zoom: 33%;">
<ol start="2">
<li>
<p><mark>After this period, the first clock pulse is generated</mark>ï¼šæš—ç¤ºæˆ‘ä»¬åœ¨è¿™ä¸ªt<sub>HD;STA</sub>å‘¨æœŸï¼ˆç›¸å½“äºI2Cé€šä¿¡çš„å‡†å¤‡é˜¶æ®µï¼‰è¿‡åï¼Œä¸»è®¾å¤‡åº”è¯¥ç”Ÿæˆç¬¬ä¸€ä¸ªæ—¶é’Ÿè„‰å†²å¼€å§‹ä¼ è¾“æ•°æ®ã€‚å› æ­¤æ—¶åºå®šä¹‰é‡Œä¹Ÿç»™å‡ºäº†å¦‚ä¸‹ç¤ºæ„å›¾ï¼Œ<strong>æš—ç¤ºæˆ‘ä»¬åœ¨å»¶æ—¶t<sub>HD;STA</sub>ä¹‹åï¼Œåº”è¯¥å°†SCLæ‹‰ä½</strong>ï¼ˆå›¾ä¸­ <mark>1<sup>st</sup>&nbsp;clock&nbsp;cycle</mark>ä¹Ÿè¿›ä¸€æ­¥å°è¯äº†è¿™ä¸€ç‚¹ï¼‰ã€‚</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116204645958.png" alt="image-20241116204645958" style="zoom:50%;">
</li>
</ol>
<h2 id="t-sub-low-sub-t-sub-high-sub-shi-zhong-xian-gao-di-dian-ping-zhou-qi-kong-zhi-scl-low-high-period">t<sub>LOW</sub>/t<sub>HIGH</sub>æ—¶é’Ÿçº¿é«˜ä½ç”µå¹³å‘¨æœŸæ§åˆ¶ï¼ˆSCL low/high periodï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116204955105.png" alt="image-20241116204955105"></p>
<p>è¯¥å‚æ•°è§„å®šäº†æˆ‘ä»¬ä¼ è¾“æ•°æ®æ‹‰é«˜æ‹‰ä½SCLæ—¶ï¼Œå…¶é«˜ä½ç”µå¹³åº”è¯¥æŒç»­çš„æ—¶é—´ï¼Œä»¥Fast-modeä¸ºä¾‹ï¼ŒSCLä½ç”µå¹³æœ€ä½æŒç»­1.3usï¼Œé«˜ç”µå¹³åˆ™æœ€ä½0.6us</p>
<h2 id="t-sub-su-sta-sub-qi-shi-xin-hao-jian-li-zhun-bei-shi-jian-set-up-time-for-start">t<sub>SU;STA</sub> èµ·å§‹ä¿¡å·å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼ˆSetUp time for STARTï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116205306146.png" alt="image-20241116205306146"></p>
<p>è¯¥å‚æ•°è§„å®šäº†èµ·å§‹ä¿¡å·çš„å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼Œè¿™ä¸ªå‚æ•°æœ‰ç‚¹éš¾ç†è§£ã€‚æˆ‘ä»¬å‚ç…§æ—¶åºå®šä¹‰æ¥çœ‹ä¸‹ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116205502756.png" alt="image-20241116205502756" style="zoom: 50%;">
<p>å’Œt<sub>HD;STA</sub>å¯¹æ¯”æ¥çœ‹ï¼Œt<sub>HD;STA</sub>è§„å®šäº†èµ·å§‹ä¿¡å·çš„ä¿æŒæ—¶é—´ï¼ˆSCLä¸ºé«˜æ—¶ï¼Œæ‹‰ä½SDAå¹¶ä¿æŒï¼‰ã€‚</p>
<p>t<sub>SU;STA</sub> åˆ™æ˜¯ç”¨äºé‡å¤èµ·å§‹ä¿¡å·çš„ï¼ˆæ¯æ¬¡é€šä¿¡è‡³å°‘å¯¹åº”ä¸€ä¸ªSTARTå’ŒSTOPï¼Œè¿ç»­çš„å¤šæ¬¡é€šä¿¡ä¸­ç´§æ¥ç€å‰ä¸€æ¬¡é€šä¿¡STOPä¹‹åçš„STARTå¯ç§°ä¸º <mark>repeated START</mark>ï¼Œå‰é¢ä»‹ç»çš„ <mark>å†™åœ°å€ï¼Œè¿ç»­è¯»æ¨¡å¼</mark>å¯¹åº”çš„START,START,STOPä¸­ç¬¬äºŒä¸ªSTARTä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚</p>
<p>å¯¹äºé‡å¤èµ·å§‹ä¿¡å·è€Œè¨€ï¼ŒSCLå¯èƒ½æ˜¯ä»¥ä½ç”µå¹³å¼€å§‹çš„ï¼ˆä¾‹å¦‚ä¸Šä¸€æ¬¡é€šä¿¡å°†SCLæ‹‰ä½äº†ï¼‰ï¼Œä¸ºäº†æ»¡è¶³å®ç°èµ·å§‹ä¿¡å·ï¼ˆæ‹‰ä½SDAï¼‰çš„<mark>å‰ç½®æ¡ä»¶ï¼ˆSCLä¸ºé«˜ï¼ŒSDAä¸ºé«˜ï¼‰</mark>ï¼Œè¯¥å‚æ•°è§„å®šäº†åœ¨æ‹‰ä½SDAä¹‹å‰ï¼ŒSDAåº”è¯¥åœ¨SCLä¸ºé«˜æœŸé—´ä¿æŒé«˜ç”µå¹³çš„æ—¶é—´ã€‚</p>
<h2 id="qi-shi-zhong-zhi-xin-hao-de-shi-xian">èµ·å§‹/ç»ˆæ­¢ä¿¡å·çš„å®ç°</h2>
<p>è¿™é‡Œæˆ‘ä»¬å·²ç»å¯ä»¥å†™å‡ºèµ·å§‹ä¿¡å·çš„ä¼ªä»£ç äº†ï¼ˆæ‰€æœ‰å»¶æ—¶ä»¥ Fast-mode ä¸ºä¾‹ï¼‰ï¼š</p>
<p><code>I2C_Start()</code></p>
<pre class="line-numbers language-none"><code class="language-none">// å‰ç½®æ¡ä»¶
SDA = HIGH
SCL = HIGH
// å‰ç½®æ¡ä»¶å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´
delay 0.6us

// èµ·å§‹ä¿¡å·(SCL,SDAä¸ºé«˜æ—¶ï¼Œæ‹‰ä½SDA)
SDA = LOW
// èµ·å§‹ä¿¡å·ä¿æŒæ—¶é—´
delay 0.6

// å¼€å§‹ç¬¬ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸä½ç”µå¹³é˜¶æ®µ
SCL = 0;
delay 1.3us<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”çš„Cè¯­è¨€å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SCL_PIN</span>    <span class="token expression">GPIO_PIN_6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SDA_PIN</span>    <span class="token expression">GPIO_PIN_7</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_PORT</span>  <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_RCU</span>   <span class="token expression">RCU_GPIOB</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start setup</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start hold</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æ³¨æ„</mark>ï¼šè¿™é‡Œç¬¬22è¡Œï¼Œå¹¶æ²¡æœ‰å’Œä¼ªä»£ç ä¸­çš„1.3usä¿æŒä¸€è‡´ï¼Œæ˜¯å› ä¸ºåœ¨åç»­çš„æ•°æ®ä¼ è¾“ä¸­ï¼Œç½®ä½SDAåæ˜¯éœ€è¦ä¸€ä¸ªsetupæ—¶å»¶çš„ï¼ˆä¾‹å¦‚1usï¼‰ï¼Œæ— å½¢ä¹‹é—´å»¶é•¿äº†SCLä½ç”µå¹³çš„æ—¶é—´ï¼ˆç›¸å½“äºå˜æˆä¸º2usï¼‰ï¼Œè¯¦è§åæ–‡åˆ†æã€‚</p>
<h2 id="t-sub-hd-dat-sub-shu-ju-bao-chi-shi-jian-hol-d-time-for-data">t<sub>HD;DAT</sub>æ•°æ®ä¿æŒæ—¶é—´ï¼ˆHolD time for DATAï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116212042232.png" alt="image-20241116212042232"></p>
<p>å¯ä»¥å‘ç°è¯¥å‚æ•°å¯¹åº”ä¸¤ç§æ¡ä»¶ï¼š <mark>CBUS compatible controllers</mark>å’Œ <mark>I2C-bus devices</mark>ï¼Œæˆ‘ä»¬è¿™é‡Œåªå…³å¿ƒI2Cï¼Œè¦æ±‚æŒç»­çš„æœ€å°æ—¶é—´ä¸º0ï¼Œç›¸å½“äºä¸éœ€è¦æ§åˆ¶æ—¶å»¶ï¼Œæš‚æ—¶å¯ä»¥å¿½ç•¥è¯¥å‚æ•°ã€‚</p>
<h2 id="t-sub-su-dat-sub-shu-ju-jian-li-zhun-bei-shi-jian-set-up-time-for-data">t<sub>SU;DAT</sub>æ•°æ®å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼ˆSetUp time for DATAï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116212548515.png" alt="image-20241116212548515"></p>
<p>è¯¥å‚æ•°è§„å®šäº†SDAå»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼Œä¹Ÿå³åœ¨SCLä¸ºä½æ—¶ï¼Œç½®ä½SDAä¸ºä¸‹ä¸€ä¸ªè¦å‘é€çš„æ•°æ®åï¼Œåˆ°æ‹‰é«˜SCLï¼ˆä»¥è®©æ¥æ”¶æ–¹è¯»å–æ•°æ®ï¼‰ä¹‹å‰åº”è¯¥ä¿æŒçš„æ—¶é—´ï¼š</p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116214624147.png" alt="image-20241116214624147" style="zoom:50%;">
<p>æˆ‘ä»¬æ¯æ¬¡å‘é€æ•°æ®éƒ½éµå¾ªå¦‚ä¸‹æµç¨‹</p>
<ul>
<li>æ‹‰ä½SCLï¼Œå¹¶å»¶æ—¶t<sub>LOW</sub></li>
<li>å‡†å¤‡SDAï¼ˆä¸‹ä¸€æ¬¡è¦å‘é€çš„æ•°æ®ï¼‰ï¼Œå¹¶å»¶æ—¶t<sub>SU;DAT</sub></li>
<li>æ‹‰é«˜SCLï¼Œå¹¶å»¶æ—¶/t<sub>HIGH</sub></li>
</ul>
<h2 id="fa-song-yi-ge-zi-jie-de-shi-xian">å‘é€ä¸€ä¸ªå­—èŠ‚çš„å®ç°</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºå‘é€ä¸€ä¸ªå­—èŠ‚çš„ä¼ªä»£ç äº†ï¼ˆæ¥ç€ä¹‹å‰çš„ <code>I2C_Start</code>ï¼‰ï¼š</p>
<p><code>I2C_SendByte</code></p>
<pre class="line-numbers language-none"><code class="language-none">uint8_t byte
// éœ€è¦å¾ªç¯8æ¬¡ï¼Œå‘é€ä¸€ä¸ªå­—èŠ‚8ä¸ªbit
for(i = 0 ; i &lt; 8 ; i++) {
    // æ­¤å‰I2C_Startçš„ç»“å°¾ä»¥å°†SCLæ‹‰ä½ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å‡†å¤‡SDA
    SDA = (byte &amp; (0x08 &gt;&gt; i)) ? HIGH : LOW
    delay 1us // SDAå»ºç«‹æ—¶é—´ï¼Œè¿™æœŸé—´SCLä»æœªä½ç”µå¹³ï¼Œå› æ­¤ä¸€å…±æŒç»­äº†2us
    
    SCL = HIGH
    delay 1us // SCLé«˜ç”µå¹³å‘¨æœŸ
    
    SCL = LOW // å¼€å¯ä¸‹ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸ
    delay 1us // SCLä½ç”µå¹³å‘¨æœŸ
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”GD32F4çš„Cè¯­è¨€å®ç°ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start setup</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start hold</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data set-up</span>

        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="t-sub-r-sub-t-sub-f-sub-shang-sheng-yan-xia-jiang-yan-shi-jian-rising-falling-edge">t<sub>r</sub> / t<sub>f</sub>ä¸Šå‡æ²¿/ä¸‹é™æ²¿æ—¶é—´ï¼ˆRising/Falling edgeï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116220318791.png" alt="image-20241116220318791"></p>
<img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116220810270.png" alt="image-20241116220810270" style="zoom:33%;">
<p>è¿™ä¸¤ä¸ªå‚æ•°è§„å®šäº†SCLå’ŒSDAçš„ä¸Šå‡æ²¿ï¼ˆr-rising edgeï¼‰ã€ä¸‹é™æ²¿ï¼ˆf-falling edgeï¼‰çš„æ—¶é—´æ§åˆ¶ã€‚è¿™ä¸ªå‚æ•°å’ŒGPIOå¯¹åº”ç”µæ°”ç‰¹æ€§ä¸­çš„å‹æ‘†ç‡ï¼ˆ<mark>Slew&nbsp;Rate</mark>ï¼‰ã€‚</p>
<p>ä»¥GD32F4ä¸ºä¾‹ï¼Œå¯¹åº”æ ‡å‡†åº“å‡½æ•° <code>gpio_output_options_set</code>ä¸­çš„ <code>speed</code>å‚æ•°ï¼Œå³æ§åˆ¶GPIOå¼•è„šè·³å˜æ—¶ï¼Œç‰©ç†ç”µè·¯ç”µå¹³è½¬æ¢æ‰€éœ€çš„æ—¶å»¶ï¼ˆä¾‹å¦‚ç”µå®¹å……æ”¾ç”µè¿‡ç¨‹éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼‰ã€‚</p>
<h2 id="t-sub-su-sto-sub-zhong-zhi-xin-hao-jian-li-zhun-bei-shi-jian-set-up-time-for-stop">t<sub>SU;STO</sub>ç»ˆæ­¢ä¿¡å·å»ºç«‹ï¼ˆå‡†å¤‡ï¼‰æ—¶é—´ï¼ˆSetUp time for STOPï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116221510344.png" alt="image-20241116221510344"></p>
<p>ç”±äºç»ˆæ­¢ä¿¡å·ï¼ˆæ‹‰é«˜SDAï¼‰æ˜¯æœ‰å‰ç½®æ¡ä»¶çš„ï¼ˆSCLä¸ºé«˜ï¼ŒSDAä¸ºä½ï¼‰ï¼Œè¯¥å‚æ•°è§„å®šäº†åœ¨æ‹‰é«˜SDAä¹‹å‰ï¼ŒSDAåœ¨SCLä¸ºé«˜æœŸé—´ä¿æŒä½ç”µå¹³çš„æ—¶é—´ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116222328620.png" alt="image-20241116222328620"></p>
<h2 id="t-sub-buf-sub-zong-xian-shi-fang-shi-jian-b-us-free-time">t<sub>BUF</sub>æ€»çº¿é‡Šæ”¾æ—¶é—´ï¼ˆBUs Free timeï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116222447598.png" alt="image-20241116222447598"></p>
<p>è¯¥å‚æ•°è§„å®šäº†åœ¨ä¸€ä¸ªç»ˆæ­¢ä¿¡å·ï¼ˆPï¼‰å’Œä¸‹ä¸€ä¸ªèµ·å§‹ä¿¡å·ï¼ˆSï¼‰ä¹‹é—´ï¼Œæ€»çº¿åº”è¯¥è¢«é‡Šæ”¾ï¼ˆSCL/SDAä¿æŒé«˜ç”µå¹³ï¼‰çš„æ—¶é—´ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116222631166.png" alt="image-20241116222631166"></p>
<h2 id="zhong-zhi-xin-hao-de-shi-xian">ç»ˆæ­¢ä¿¡å·çš„å®ç°</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç»ˆæ­¢ä¿¡å·çš„ä¼ªä»£ç äº†ï¼š</p>
<p><code>I2C_Stop</code></p>
<pre class="line-numbers language-none"><code class="language-none">// å‰ç½®æ¡ä»¶ï¼šSDAä¸ºä½ï¼ŒSCLä¸ºé«˜
// æ­¤å‰I2C_SendByteçš„ç»“å°¾å·²å°†SCLæ‹‰ä½ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥å‡†å¤‡SDA
SDA = 0
delay 1us // ä¸ºäº†ç¡®ä¿SCLä½ç”µå¹³å‘¨æœŸå¤§äº1.3usï¼Œè¿™é‡Œè¡¥å……ä¸€ä¸ª1us
SCL = HIGH
delay 1us // SCLé«˜ç”µå¹³å‘¨æœŸ
delay 1us // è¡¥å……1usï¼Œç¡®ä¿&gt;æ€»çº¿é‡Šæ”¾æ—¶é—´1.3us<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹åº”Cè¯­è¨€å®ç°ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//stop setup</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//bus free time between a STOP and START condition</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="t-sub-vd-dat-sub-t-sub-vd-ack-sub-shu-ju-ack-you-xiao-shi-jian-valid-time-for-data-ack">t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>æ•°æ®/ACKæœ‰æ•ˆæ—¶é—´ï¼ˆValid time for DATA/ACKï¼‰</h2>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241116223438554.png" alt="image-20241116223438554"></p>
<p>ä¸ªäººç†è§£è¿™ä¸¤ä¸ªå‚æ•°æ˜¯åœ¨æ¥æ”¶çš„åœºæ™¯ä¸‹ä½¿ç”¨çš„ï¼Œåœ¨ä½œä¸ºæ¥æ”¶æ–¹é‡Šæ”¾SDAï¼ˆæ‹‰é«˜SDAï¼‰ä¹‹åï¼Œå‘é€æ–¹ä¼šé€šè¿‡æ‹‰é«˜/æ‹‰ä½SDAæ¥å‡†å¤‡ACK/æ•°æ®æ¯”ç‰¹ï¼Œç„¶åæˆ‘ä»¬éœ€è¦ç­‰å¾…t<sub>VD;DAT</sub>/t<sub>VD;ACK</sub>è¿™æ ·ä¸€ä¸ªæ—¶é—´ç¡®ä¿å‘é€æ–¹å‡†å¤‡å¥½SDAäº†ï¼Œç„¶åæˆ‘ä»¬å†æ‹‰é«˜SCLï¼ˆè®©å‘é€æ–¹ä¿æŒSDAï¼‰ï¼Œå¹¶è¯»å–SDAã€‚</p>
<h2 id="jie-shou-ack-shu-ju-zi-jie-dai-ma-shi-xian">æ¥æ”¶ACK/æ•°æ®å­—èŠ‚ä»£ç å®ç°</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ¥æ”¶ackå’Œæ•°æ®å­—èŠ‚çš„ä»£ç äº†ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_IN</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_INPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_OUT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_OUTPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_READ</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_input_bit_get</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

bool <span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bool success <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    success <span class="token operator">=</span> <span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">;</span> <span class="token comment">// read ack</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl low</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">receive_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// slave keep data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// read data</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// let slave prepare next data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="san-i-2-c-wan-zheng-dai-ma">ä¸‰ã€I2Cå®Œæ•´ä»£ç </h1>
<h2 id="code-hal-i-2-c-soft-h-code"><code>hal_i2c_soft.h</code></h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/16.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HAL_I2C_SOFT_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HAL_I2C_SOFT_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"gd32f4xx.h"</span></span>

<span class="token keyword">void</span> <span class="token function">hal_i2c_soft_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">hal_i2c_soft_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">hal_i2c_soft_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">hal_i2c_soft_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//HAL_I2C_SOFT_H</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="code-hal-i-2-c-soft-c-code"><code>hal_i2c_soft.c</code></h2>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by 86157 on 2024/11/16.</span>
<span class="token comment">//</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hal_i2c_soft.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"systick.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SCL_PIN</span>    <span class="token expression">GPIO_PIN_6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SDA_PIN</span>    <span class="token expression">GPIO_PIN_7</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_PORT</span>  <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_GPIO_RCU</span>   <span class="token expression">RCU_GPIOB</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_IN</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_INPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_OUT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_OUTPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_READ</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">gpio_input_bit_get</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SDA_PIN<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">hal_i2c_soft_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä½¿èƒ½GPIOBæ—¶é’Ÿ</span>
    <span class="token function">rcu_periph_clock_enable</span><span class="token punctuation">(</span>I2C_GPIO_RCU<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// é…ç½®PB6ï¼ˆSCLï¼‰å’ŒPB7ï¼ˆSDAï¼‰ä¸ºå¼€æ¼è¾“å‡ºæ¨¡å¼</span>
    <span class="token function">gpio_mode_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_MODE_OUTPUT<span class="token punctuation">,</span> GPIO_PUPD_PULLUP<span class="token punctuation">,</span> I2C_SCL_PIN <span class="token operator">|</span> I2C_SDA_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_output_options_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> GPIO_OTYPE_OD<span class="token punctuation">,</span> GPIO_OSPEED_50MHZ<span class="token punctuation">,</span> I2C_SCL_PIN <span class="token operator">|</span> I2C_SDA_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å°†SCLå’ŒSDAçº¿æ‹‰é«˜</span>
    <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>I2C_GPIO_PORT<span class="token punctuation">,</span> I2C_SCL_PIN <span class="token operator">|</span> I2C_SDA_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start setup</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//start hold</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//stop setup</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//bus free time between a STOP and START condition</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> bool <span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bool success <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// release bus</span>
    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    success <span class="token operator">=</span> <span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">;</span> <span class="token comment">// read ack</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl low</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">send_ack</span><span class="token punctuation">(</span>bool ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// set sda to reponse ack/nack</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sda setup</span>

    <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// let slave read ack</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reset scl for next operation</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">SDA_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data set-up</span>

        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scl high</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">receive_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SCL_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// slave keep data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// read data</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDA_READ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">SCL_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// let slave prepare next data</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> bool <span class="token function">start_for_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">send_byte</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write dev_addr failed"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">send_byte</span><span class="token punctuation">(</span>reg_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write reg_addr failed"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> bool <span class="token function">start_for_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">send_byte</span><span class="token punctuation">(</span>dev_addr <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// read from slave</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write dev_addr for read failed"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">hal_i2c_soft_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">start_for_write</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">,</span> reg_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">send_byte</span><span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG_DEBUG</span><span class="token punctuation">(</span><span class="token string">"write data[%d] failed"</span><span class="token punctuation">,</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">hal_i2c_soft_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> dev_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> reg_addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// dummy write for register address</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">start_for_write</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">,</span> reg_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// continuous read</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">start_for_read</span><span class="token punctuation">(</span>dev_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">receive_byte</span><span class="token punctuation">(</span>buf<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">send_ack</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">receive_byte</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">send_ack</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>åè®®</category>
      </categories>
      <tags>
        <tag>I2C</tag>
        <tag>æ—¶åºè¦æ±‚</tag>
        <tag>PCF8563</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2024/11/12/16107.html</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="create-a-new-post">Create a new post</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="run-server">Run server</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="generate-static-files">Generate static files</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="deploy-to-remote-sites">Deploy to remote sites</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>è®ºæ—¶åºè¦æ±‚çš„é‡è¦æ€§ï¼ˆç§»ä½å¯„å­˜å™¨æ§åˆ¶æ•°ç ç®¡ï¼‰</title>
    <url>/2024/11/15/31801.html</url>
    <content><![CDATA[<h1 id="1-wen-ti-bei-jing">1. é—®é¢˜èƒŒæ™¯</h1>
<h2 id="ying-jian-bei-jing">ç¡¬ä»¶èƒŒæ™¯</h2>
<ul>
<li>ç§»ä½å¯„å­˜å™¨ï¼š<a href="https://item.szlcsc.com/79848.html?fromZone=s_s__%2274HC595N%22">SN74HC595N</a></li>
<li>ä¸¤ä¸ª4ä½å…±é˜³æ•°ç ç®¡</li>
</ul>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/20241115163627.png" alt=""></p>
<h2 id="yi-wei-suo-cun-luo-ji-set-reset">ç§»ä½/é”å­˜é€»è¾‘â€”â€”set/reset</h2>
<p>åœ¨å­¦ä¹ GD32F407VETæ—¶ï¼Œå°†å­¦ä¹ STC8å®ç°çš„æ•°ç ç®¡æ¨¡å—ç§»æ¤è¿‡æ¥ï¼Œå‘ç°äº†ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ã€‚å…¶ä¸­ç§»ä½æ“ä½œçš„å®ç°å¦‚ä¸‹ï¼ˆå°è£…äº†å¯¹ä¸¤ä¸ªä¸²è”ç§»ä½å¯„å­˜å™¨çš„ç§»ä½æ“ä½œï¼Œæ§åˆ¶8ä¸ªæ•°ç ç®¡ä¸­æ˜¾ç¤ºå“ªä¸€ä¸ªï¼Œä»¥åŠæ§åˆ¶æ•°ç ç®¡æ˜¾ç¤ºå†…å®¹ï¼‰ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shift</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_DI_PORT<span class="token punctuation">,</span> NIX_DI_PIN<span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> SET <span class="token operator">:</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rck_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘ç°å•ç‹¬æŒ‡å®šæŸä¸ªæ•°ç ç®¡æ˜¾ç¤ºæŸä¸ªæ•°æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// è¦æ˜¾ç¤º1~8å¯¹åº”çš„ç è¡¨</span>
<span class="token class-name">uint8_t</span> code<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0xF9</span><span class="token punctuation">,</span> <span class="token number">0xA4</span><span class="token punctuation">,</span> <span class="token number">0xB0</span><span class="token punctuation">,</span> <span class="token number">0x99</span><span class="token punctuation">,</span> <span class="token number">0x92</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">Int_NixieTube_DisplaySingle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯æƒ³ä½¿ç”¨ <code>for</code>æ§åˆ¶æ•°ç ç®¡è½®æµæ˜¾ç¤º1~8æ—¶ï¼Œå°±å‘ç°æ˜¾ç¤ºçš„å†…å®¹å¹¶ä¸ç¬¦åˆé¢„æœŸï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Int_NixieTube_DisplaySingle</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> code<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="yi-wei-suo-cun-luo-ji-write">ç§»ä½/é”å­˜é€»è¾‘â€”â€”write</h2>
<p>ä½†æ˜¯å°†å…¶ä¸­ <code>gpio_bit</code> çš„ <code>set/reset</code>æ¢æˆ <code>write</code>ä¹‹åï¼Œå‘ç°æ•°ç ç®¡èƒ½å¤ŸæŒ‰ç…§é¢„æœŸæ˜¾ç¤ºäº†ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shift</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_DI_PORT<span class="token punctuation">,</span> NIX_DI_PIN<span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> SET <span class="token operator">:</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">,</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">,</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rck_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">,</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">,</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æŸ¥çœ‹è¿™äº›å‡½æ•°çš„å®ç°ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> gpio_periph<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> pin<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">GPIO_BOP</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> gpio_periph<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> pin<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">GPIO_BC</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> gpio_periph<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> pin<span class="token punctuation">,</span> bit_status bit_value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>RESET <span class="token operator">!=</span> bit_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">GPIO_BOP</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">GPIO_BC</span><span class="token punctuation">(</span>gpio_periph<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>pin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘ç° <code>write</code>åªä¸è¿‡å°† <code>set/reset</code>åŒ…æˆäº†ä¸€ä¸ªå‡½æ•°ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯å¤šäº†ä¸€ä¸ª <code>if</code>åˆ¤æ–­ã€‚</p>
<p>ä½†æ˜¯ï¼Œä¸€ä¸ª<code>if</code> çš„è€—æ—¶åˆèƒ½å¯¹ç¨‹åºäº§ç”Ÿä»€ä¹ˆå½±å“å‘¢ï¼Ÿæˆ‘ç™¾æ€ä¸å¾—å…¶è§£ã€‚</p>
<h1 id="2-shi-xu-yao-qiu-yin-fa-de-xie-an">2. æ—¶åºè¦æ±‚å¼•å‘çš„è¡€æ¡ˆ</h1>
<h2 id="xiao-xiao-if-an-cang-xuan-ji">å°å°ifæš—è—ç„æœº</h2>
<p>åœ¨å„ç§ <code>Google, GPT</code>ä¹‹åï¼Œç»“åˆä»£ç ä¸Šä¸‹æ–‡ï¼Œå‘ç°ä»£ç ä¸­ä½¿ç”¨äº† <code>nop</code>æ¥å¢åŠ æ—¶å»¶ï¼Œå†ç»“åˆç§»ä½å¯„å­˜å™¨éœ€è¦æ ¹æ®æˆ‘ä»¬é€šè¿‡GPIOå‘é€çš„SRCLKï¼ˆç§»ä½æ—¶é’Ÿï¼‰ã€RCLKï¼ˆé”å­˜æ—¶é’Ÿï¼‰çš„ä¸Šå‡æ²¿æ¥è¿›è¡Œç§»ä½æ“ä½œå’Œé”å­˜æ“ä½œï¼ˆå°†ç§»ä½å¯„å­˜å™¨æ›´æ–°åˆ°é”å­˜å¯„å­˜å™¨ storage registerï¼‰ã€‚</p>
<p>æˆ‘è®¾ç½®çš„GD32F407çš„ä¸»é¢‘æ˜¯168MHzï¼Œè¿™ä¸ªæ¯”STC8æ—¶çš„24MHzè¿˜æ˜¯è¦å¿«å‡ å€çš„ï¼Œè®¡ç®—ä¸€ä¸‹<code>nop</code>å¯¹åº”ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸçš„æ—¶é—´ä¸º <code>1/168MHz</code>çº¦ä¸º <code>5.95ns</code>ã€<code>1/24MHz</code>çº¦ä¸º <code>41.67ns</code>ã€‚</p>
<p>è¿™æ ·çœ‹æ¥ï¼Œä¸€ä¸ª <code>if</code>åˆ¤æ–­è¿˜çœŸæœ‰å¯èƒ½å¼•å‘äº†è¡€æ¡ˆï¼Œå…¶æ‰€æ¶ˆè€—çš„æ—¶é’Ÿå‘¨æœŸï¼ˆå¢åŠ çš„æ—¶å»¶ï¼‰å¯èƒ½æ­£å¥½æ»¡è¶³äº†ç§»ä½å¯„å­˜å™¨çš„<strong>æ—¶åºè¦æ±‚</strong>ï¼Œä»è€Œä½¿å¾—æ•°ç ç®¡èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºã€‚</p>
<h2 id="shu-ju-shou-ce-bu-ke-shao">æ•°æ®æ‰‹å†Œä¸å¯å°‘</h2>
<p>åœ¨æƒ³åˆ°å¯èƒ½æ—¶æ—¶å»¶å¯¼è‡´çš„é—®é¢˜åï¼Œä¸å¦¨çœ‹ä¸€ä¸‹èŠ¯ç‰‡å¯¹åº”çš„å®˜æ–¹æ‰‹å†Œï¼Œçœ‹èƒ½å¦æ‰¾åˆ°ç­”æ¡ˆã€‚</p>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œä¸€å®šè¦æ‰¾ä¸èŠ¯ç‰‡å‹å·ã€å“ç‰Œä¸€è‡´çš„ï¼š</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241115170556369.png" alt="image-20241115170556369"></p>
<h2 id="timing-requirements">Timing Requirements</h2>
<p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹æ—¶åºè¦æ±‚ï¼ˆTiming Requirements ï¼‰ç›¸å…³çš„ç« èŠ‚</p>
<p><img src="https://hexo-blog-anwen.oss-cn-beijing.aliyuncs.com/image/image-20241115170729345.png" alt="image-20241115170729345"></p>
<h3 id="set-up-time">Set-up time</h3>
<p>å…¶ä¸­æè¿°äº†ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ä¸²è¡Œä¿¡å·çº¿ <code>SER</code>ã€ç§»ä½å¯„å­˜å™¨æ—¶é’Ÿçº¿ <code>SRCLK</code>ã€é”å­˜å™¨æ—¶é’Ÿçº¿ <code>RCLK</code> æ¥æ“ä½œ <a href="https://item.szlcsc.com/79848.html?fromZone=s_s__%2274HC595N%22">SN74HC595N</a> æ—¶ï¼Œéœ€è¦çš„å‡†å¤‡æ—¶é—´ï¼Œä¾‹å¦‚</p>
<h4 id="ser-before-srclk">SER before SRCLKâ†‘</h4>
<p>åœ¨æ“ä½œSRCLKä¸Šå‡æ²¿å°†SERå­˜å…¥ç§»ä½å¯„å­˜å™¨ä¹‹å‰ï¼ŒSERåº”è¯¥é¢„å¤‡çš„æ—¶é—´ï¼Œä»¥125nsä¸ºä¾‹ï¼Œä¼ªä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">set SER
wait 125ns
SRCLK = 0;
SRCLK = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="srclk-before-rclk">SRCLKâ†‘ before RCLKâ†‘</h4>
<p>åœ¨æ“ä½œå®Œæ‰€æœ‰çš„ç§»ä½åï¼Œå°†ç§»ä½å¯„å­˜å™¨æ›´æ–°åˆ°é”å­˜å¯„å­˜å™¨ï¼ˆå³æ›´æ–°åˆ°ç”µè·¯ï¼Œæ§åˆ¶æ•°ç ç®¡çš„æ®µé€‰å’Œç‰‡é€‰ï¼‰ï¼Œéœ€è¦æ“ä½œRCLKä¸Šå‡æ²¿ã€‚</p>
<p>è¯¥å‚æ•°è§„å®šäº†ï¼ŒRCLKä¸Šå‡æ²¿åº”è¯¥ä¸SRCLKä¸Šå‡æ²¿ä¿æŒçš„æ—¶é—´é—´éš”</p>
<h3 id="pulse-duration">Pulse duration</h3>
<p>å…¶ä¸­æè¿°äº†SRCLKã€RCLKè¢«ç½®ä½ååº”è¯¥æŒç»­ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨ä¸Šè¿°åŸºç¡€ä¸Šå¢åŠ ä¸¤ä¸ªå»¶æ—¶ï¼ˆä»¥100nsä¸ºä¾‹ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">set SER
wait 125ns
SRCLK = 0;
wait 100ns
SRCLK = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†åŠ ä¸Šé”å­˜çš„æ“ä½œï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">set SER
wait 125ns
SRCLK = 0;
wait 100ns
SRCLK = 1;

wait 100ns
RCLK = 0;
wait 100ns
RCLK = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zai-kan-if-he-nop">å†çœ‹ifå’Œnop</h2>
<p>ä¹‹å‰å¯¹äºæ—¶åºæ§åˆ¶çš„ç†è§£å¹¶ä¸æ·±åˆ»ï¼Œç®€å•çš„ä»¥ä¸ºä½¿ç”¨ <code>nop</code>åœé¡¿ä¸€ä¸‹å°±å¥½ã€‚ç°åœ¨çœ‹æ¥ï¼Œæ— è®ºæ˜¯ä¸åŒä¸»é¢‘å¯¹åº”çš„ <code>nop</code>æ—¶å»¶ä¸åŒï¼Œè¿˜æ˜¯ <code>if</code>è€—æ—¶ä¹Ÿèƒ½å½±å“æ•°ç ç®¡çš„ç”Ÿæ­»ï¼Œéƒ½åœ¨æé†’æˆ‘ä»¬æ—¶åºæ§åˆ¶ä¸å¯å°è§‘ã€‚</p>
<p>åœ¨ä½¿ç”¨MCUå¯¹å¤–å›´è®¾å¤‡/èŠ¯ç‰‡äº¤äº’</p>
<p>ã€æ§åˆ¶æ—¶ï¼Œä¸€å®šè¦ä¸¥æ ¼æŒ‰ç…§èŠ¯ç‰‡è¦æ±‚çš„æ—¶åºæ§åˆ¶ï¼Œç»“åˆMCUè‡ªèº«æŒ‡ä»¤è€—æ—¶æ¥ç¼–å†™ç¨‹åºã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shift</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">gpio_bit_write</span><span class="token punctuation">(</span>NIX_DI_PORT<span class="token punctuation">,</span> NIX_DI_PIN<span class="token punctuation">,</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> SET <span class="token operator">:</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_SCK_PORT<span class="token punctuation">,</span> NIX_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rck_action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gpio_bit_reset</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_bit_set</span><span class="token punctuation">(</span>NIX_RCK_PORT<span class="token punctuation">,</span> NIX_RCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_1us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œå®æ„¿å¤šç­‰ä¸€ç‚¹ï¼Œä¹Ÿä¸è¦è®© SN74HC595N æ— æ³•å‡†ç¡®ç§»ä½ã€é”å­˜æ•°æ®ã€‚</p>
]]></content>
      <categories>
        <category>GD32</category>
        <category>è¸©å‘è®°å½•</category>
      </categories>
      <tags>
        <tag>GD32</tag>
        <tag>æ—¶åºè¦æ±‚</tag>
        <tag>SN74HC595NSR</tag>
        <tag>ç§»ä½å¯„å­˜å™¨</tag>
      </tags>
  </entry>
</search>
